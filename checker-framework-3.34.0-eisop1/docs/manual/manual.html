<!DOCTYPE html>
<html lang="en">
<head><link rel="icon" href="favicon-checkerframework.png" type="image/png"/>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta name="generator" content="hevea 2.35">
<style type="text/css">
img { max-width: 100%; max-height: 100%; }
.equationcontainer{position:relative;}
.equationnumber{float:right;left:auto;position:absolute;right:0}
.equationnumber-valign{float:right;left:auto;position:absolute;right:0;margin-top:-0.5em;}
.floatrule{background-color: black; border: none; height: 1px; width: 80%}
.phantom{display: inline-block; visibility: hidden}
.hphantom{display: inline-block; height: 0; visibility: hidden}
.vphantom{display: inline-block; visibility: hidden; width: 0}
.smash{display: inline-block; height: 0; line-height: 0}
.li-itemize{margin:1ex 0ex;}
.li-enumerate{margin:1ex 0ex;}
.dd-description{margin:0ex 0ex 1ex 4ex;}
.dt-description{margin:0ex;}
.toc{list-style:none;}
.footnotetext{margin:0ex; padding:0ex;}
div.footnotetext P{margin:0px; text-indent:1em;}
.thefootnotes{text-align:left;margin:0ex;}
.dt-thefootnotes{margin:0em;}
.dd-thefootnotes{margin:0em 0em 0em 2em;}
.footnoterule{background-color: black; border: none; height: 1px; margin: 1em auto 1em 0px; width: 40%}
.caption{padding-left:2ex; padding-right:2ex; margin-left:auto; margin-right:auto}
.title{margin:2ex auto;text-align:center}
.titlemain{margin:1ex 2ex 2ex 1ex;}
.titlerest{margin:0ex 2ex;}
.center{text-align:center;margin-left:auto;margin-right:auto;}
.flushleft{text-align:left;margin-left:0ex;margin-right:auto;}
.flushright{text-align:right;margin-left:auto;margin-right:0ex;}
div table{margin-left:inherit;margin-right:inherit;margin-bottom:2px;margin-top:2px}
td table{margin:auto;}
table{border-collapse:collapse;}
td{padding:0;}
.cellpadding0 tr td{padding:0;}
.cellpadding1 tr td{padding:1px;}
pre{text-align:left;margin-left:0ex;margin-right:auto;}
blockquote{margin-left:4ex;margin-right:4ex;text-align:left;}
td p{margin:0px;}
.quote{margin-left:3em;margin-right:3em;text-align:inherit;text-indent:0pt}
.quotation{margin-left:3em;margin-right:3em;text-align:inherit;text-indent:1.5em}
.verse{margin-left:3em;margin-right:3em;text-indent:1.5em hanging each-line}
.parbox{box-sizing: border-box;
display: inline-block;
text-indent: 0;
}
.rule-rect{fill: black;}
.lrbox{box-sizing:border-box;display:inline-block;overflow:visible;white-space:nowrap;}
.center-lrbox{display:inline-block;margin-left:50%;transform:translateX(-50%);}
.makebox{}
.framebox{border:1px solid black;padding:0.25em;}
.vertical-rule{border:none;width:2px;background-color:black;}
.horizontal-rule{border:none;background-color:black;}
.hrule{border:none;height:2px;width:100%;background-color:black;}
.hfill{border:none;height:1px;width:200%;background-color:black;}
.vdisplay{border-collapse:separate;border-spacing:2px;line-height:1.1;width:auto; empty-cells:show; border:2px solid red;}
.vdcell{white-space:nowrap;padding:0px; border:2px solid green;}
.display{border-collapse:separate;border-spacing:2px;line-height:1.1;width:auto; border:none;}
.dcell{white-space:nowrap;padding:0px; border:none;}
.dcenter{margin:0ex auto;}
.vdcenter{border:solid #FF8000 2px; margin:0ex auto;}
.minipage{text-align:left; margin-left:0em; margin-right:auto;}
.marginpar{border:solid thin black; margin-bottom:1ex; width:20%; text-align:left;}
.marginparleft{float:left; clear:left; margin-left:0ex; margin-right:1ex;}
.marginparright{float:right; clear:right; margin-left:1ex; margin-right:0ex;}
.theorem{text-align:left;margin:1ex auto 1ex 0ex;}
.part{margin:2ex auto;text-align:center}
.lstlisting{font-family:monospace;white-space:pre;margin-right:auto;margin-left:0pt;text-align:left}
.lstframe{margin:auto;margin-bottom:2em}
</style>
<title>The Checker Framework Manual:  
Custom pluggable types for Java
</title>
</head>
<body >
<!--HEVEA command line is: hevea -fix svg.hva -exec xxdate.exe manual.tex -->
<!--CUT STYLE book--><!--CUT DEF chapter 1 --><div class="center">
<img src="CFLogo.png">
</div><table class="title"><tr><td style="padding:1ex"><h1 class="titlemain">The Checker Framework Manual: <br>
Custom pluggable types for Java</h1><h3 class="titlerest"><a href="https://eisop.github.io/"><span style="font-family:monospace">https://eisop.github.io/</span></a></h3><h3 class="titlerest">Version 3.34.0-eisop1 (9 May 2023)</h3></td></tr>
</table><p><span style="font-weight:bold">For the impatient:</span>
Section ‍<a href="#installation">1.3</a>
describes how to <span style="font-weight:bold">install and use</span> pluggable type-checkers.</p><p>This manual is also available in <a href="https://eisop.github.io/cf/manual/checker-framework-manual.pdf">PDF</a>.</p><!--TOC chapter id="sec1" Contents-->
<h1 id="sec1" class="chapter">Contents</h1><!--SEC END --><ul class="toc"><li class="li-toc">
<a href="#introduction">Chapter ‍1 Introduction</a>
<ul class="toc"><li class="li-toc">
<a href="#how-to-read-this-manual">1.1 How to read this manual</a>
</li><li class="li-toc"><a href="#pluggable-types">1.2 How it works: Pluggable types</a>
</li><li class="li-toc"><a href="#installation">1.3 Installation</a>
</li><li class="li-toc"><a href="#example-use">1.4 Example use: detecting a null pointer bug</a>
</li></ul>
</li><li class="li-toc"><a href="#using-a-checker">Chapter ‍2 Using a checker</a>
<ul class="toc"><li class="li-toc">
<a href="#writing-annotations">2.1 Where to write type annotations</a>
</li><li class="li-toc"><a href="#running">2.2 Running a checker</a>
</li><li class="li-toc"><a href="#checker-guarantees">2.3 What the checker guarantees</a>
</li><li class="li-toc"><a href="#tips-about-writing-annotations">2.4 Tips about writing annotations</a>
</li></ul>
</li><li class="li-toc"><a href="#nullness-checker">Chapter ‍3 Nullness Checker</a>
<ul class="toc"><li class="li-toc">
<a href="#nullness-checks">3.1 What the Nullness Checker guarantees</a>
</li><li class="li-toc"><a href="#nullness-annotations">3.2 Nullness annotations</a>
</li><li class="li-toc"><a href="#writing-nullness-annotations">3.3 Writing nullness annotations</a>
</li><li class="li-toc"><a href="#suppressing-warnings-nullness">3.4 Suppressing nullness warnings</a>
</li><li class="li-toc"><a href="#nullness-example">3.5 Examples</a>
</li><li class="li-toc"><a href="#nullness-getting-started">3.6 Tips for getting started</a>
</li><li class="li-toc"><a href="#nullness-related-work">3.7 Other tools for nullness checking</a>
</li><li class="li-toc"><a href="#initialization-checker">3.8 Initialization Checker</a>
</li></ul>
</li><li class="li-toc"><a href="#map-key-checker">Chapter ‍4 Map Key Checker</a>
<ul class="toc"><li class="li-toc">
<a href="#map-key-invoking">4.1 Invoking the Map Key Checker</a>
</li><li class="li-toc"><a href="#map-key-annotations">4.2 Map key annotations</a>
</li><li class="li-toc"><a href="#map-key-defaults">4.3 Default annotations</a>
</li><li class="li-toc"><a href="#map-key-examples">4.4 Examples</a>
</li><li class="li-toc"><a href="#map-key-annotations-inference">4.5 Local inference of @KeyFor annotations</a>
</li></ul>
</li><li class="li-toc"><a href="#optional-checker">Chapter ‍5 Optional Checker for possibly-present data</a>
<ul class="toc"><li class="li-toc">
<a href="#optional-run-checker">5.1 How to run the Optional Checker</a>
</li><li class="li-toc"><a href="#optional-annotations">5.2 Optional annotations</a>
</li><li class="li-toc"><a href="#optional-guarantees">5.3 What the Optional Checker guarantees</a>
</li></ul>
</li><li class="li-toc"><a href="#interning-checker">Chapter ‍6 Interning Checker</a>
<ul class="toc"><li class="li-toc">
<a href="#interning-annotations">6.1 Interning annotations</a>
</li><li class="li-toc"><a href="#interning-annotating">6.2 Annotating your code with <span style="font-family:monospace">@Interned</span></a>
</li><li class="li-toc"><a href="#interning-interned-classes">6.3 Interned classes</a>
</li><li class="li-toc"><a href="#interning-checks">6.4 What the Interning Checker checks</a>
</li><li class="li-toc"><a href="#interning-example">6.5 Examples</a>
</li><li class="li-toc"><a href="#other-interning-annotations">6.6 Other interning annotations</a>
</li></ul>
</li><li class="li-toc"><a href="#called-methods-checker">Chapter ‍7 Called Methods Checker for the builder pattern and more</a>
<ul class="toc"><li class="li-toc">
<a href="#called-methods-run-checker">7.1 How to run the Called Methods Checker</a>
</li><li class="li-toc"><a href="#called-methods-lombok">7.2 For Lombok users</a>
</li><li class="li-toc"><a href="#called-methods-spec">7.3 Specifying your code</a>
</li><li class="li-toc"><a href="#called-methods-framework-details">7.4 Default handling for Lombok and AutoValue</a>
</li><li class="li-toc"><a href="#called-methods-other">7.5 Using the Called Methods Checker for properties unrelated to builders</a>
</li><li class="li-toc"><a href="#called-methods-more-information">7.6 More information</a>
</li></ul>
</li><li class="li-toc"><a href="#resource-leak-checker">Chapter ‍8 Resource Leak Checker for must-call obligations</a>
<ul class="toc"><li class="li-toc">
<a href="#resource-leak-run-checker">8.1 How to run the Resource Leak Checker</a>
</li><li class="li-toc"><a href="#resource-leak-annotations">8.2 Resource Leak Checker annotations</a>
</li><li class="li-toc"><a href="#resource-leak-example">8.3 Example of how safe resource usage is verified</a>
</li><li class="li-toc"><a href="#resource-leak-ownership">8.4 Aliased references and ownership transfer</a>
</li><li class="li-toc"><a href="#resource-leak-resource-alias">8.5 Resource aliasing</a>
</li><li class="li-toc"><a href="#resource-leak-createsmustcallfor">8.6 Creating obligations (how to re-assign a non-final owning field)</a>
</li><li class="li-toc"><a href="#resource-leak-ignored-exceptions">8.7 Ignored exception types</a>
</li><li class="li-toc"><a href="#resource-leak-field-initialization">8.8 Errors about field initialization</a>
</li></ul>
</li><li class="li-toc"><a href="#fenum-checker">Chapter ‍9 Fake Enum Checker for fake enumerations</a>
<ul class="toc"><li class="li-toc">
<a href="#fenum-annotations">9.1 Fake enum annotations</a>
</li><li class="li-toc"><a href="#fenum-checks">9.2 What the Fenum Checker checks</a>
</li><li class="li-toc"><a href="#fenum-running">9.3 Running the Fenum Checker</a>
</li><li class="li-toc"><a href="#fenum-suppressing">9.4 Suppressing warnings</a>
</li><li class="li-toc"><a href="#fenum-example">9.5 Example</a>
</li><li class="li-toc"><a href="#fenum-pattern">9.6 The fake enumeration pattern</a>
</li><li class="li-toc"><a href="#fenum-references">9.7 References</a>
</li></ul>
</li><li class="li-toc"><a href="#tainting-checker">Chapter ‍10 Tainting Checker</a>
<ul class="toc"><li class="li-toc">
<a href="#tainting-annotations">10.1 Tainting annotations</a>
</li><li class="li-toc"><a href="#writing-untainted">10.2 Tips on writing <span style="font-family:monospace">@Untainted</span> annotations</a>
</li><li class="li-toc"><a href="#tainting-many-uses">10.3 <span style="font-family:monospace">@Tainted</span> and <span style="font-family:monospace">@Untainted</span> can be used for many purposes</a>
</li><li class="li-toc"><a href="#tainting-polymorphism-caution">10.4 A caution about polymorphism and side effects</a>
</li></ul>
</li><li class="li-toc"><a href="#lock-checker">Chapter ‍11 Lock Checker</a>
<ul class="toc"><li class="li-toc">
<a href="#lock-guarantees">11.1 What the Lock Checker guarantees</a>
</li><li class="li-toc"><a href="#lock-annotations">11.2 Lock annotations</a>
</li><li class="li-toc"><a href="#lock-type-checking-rules">11.3 Type-checking rules</a>
</li><li class="li-toc"><a href="#lock-examples">11.4 Examples</a>
</li><li class="li-toc"><a href="#lock-details">11.5 More locking details</a>
</li><li class="li-toc"><a href="#lock-other-annotations">11.6 Other lock annotations</a>
</li><li class="li-toc"><a href="#lock-extensions">11.7 Possible extensions</a>
</li></ul>
</li><li class="li-toc"><a href="#index-checker">Chapter ‍12 Index Checker for sequence bounds (arrays and strings)</a>
<ul class="toc"><li class="li-toc">
<a href="#index-annotations">12.1 Index Checker structure and annotations</a>
</li><li class="li-toc"><a href="#index-lowerbound">12.2 Lower bounds</a>
</li><li class="li-toc"><a href="#index-upperbound">12.3 Upper bounds</a>
</li><li class="li-toc"><a href="#index-minlen">12.4 Sequence minimum lengths</a>
</li><li class="li-toc"><a href="#index-samelen">12.5 Sequences of the same length</a>
</li><li class="li-toc"><a href="#index-searchindex">12.6 Binary search indices</a>
</li><li class="li-toc"><a href="#index-substringindex">12.7 Substring indices</a>
</li><li class="li-toc"><a href="#index-inequalities">12.8 Inequalities</a>
</li><li class="li-toc"><a href="#index-annotating-fixed-size">12.9 Annotating fixed-size data structures</a>
</li></ul>
</li><li class="li-toc"><a href="#regex-checker">Chapter ‍13 Regex Checker for regular expression syntax</a>
<ul class="toc"><li class="li-toc">
<a href="#regex-annotations">13.1 Regex annotations</a>
</li><li class="li-toc"><a href="#annotating-with-regex">13.2 Annotating your code with <span style="font-family:monospace">@Regex</span></a>
</li></ul>
</li><li class="li-toc"><a href="#formatter-checker">Chapter ‍14 Format String Checker</a>
<ul class="toc"><li class="li-toc">
<a href="#formatter-terminology">14.1 Formatting terminology</a>
</li><li class="li-toc"><a href="#formatter-annotations">14.2 Format String Checker annotations</a>
</li><li class="li-toc"><a href="#formatter-guarantees">14.3 What the Format String Checker checks</a>
</li><li class="li-toc"><a href="#formatter-implicit">14.4 Implicit qualifiers</a>
</li><li class="li-toc"><a href="#formatter-FormatMethod">14.5 @FormatMethod</a>
</li><li class="li-toc"><a href="#formatter-run-time-tests">14.6 Testing whether a format string is valid</a>
</li></ul>
</li><li class="li-toc"><a href="#i18n-formatter-checker">Chapter ‍15 Internationalization Format String Checker (I18n Format String Checker)</a>
<ul class="toc"><li class="li-toc">
<a href="#i18n-format-annotation">15.1 Internationalization Format String Checker annotations</a>
</li><li class="li-toc"><a href="#i18n-format-conversion-categories">15.2 Conversion categories</a>
</li><li class="li-toc"><a href="#i18n-formatter-format-subtyping">15.3 Subtyping rules for <span style="font-family:monospace">@I18nFormat</span></a>
</li><li class="li-toc"><a href="#i18n-format-checks">15.4 What the Internationalization Format String Checker checks</a>
</li><li class="li-toc"><a href="#i18n-format-resource-files">15.5 Resource files</a>
</li><li class="li-toc"><a href="#i18n-format-running">15.6 Running the Internationalization Format Checker</a>
</li><li class="li-toc"><a href="#i18n-format-testing">15.7 Testing whether a string has an i18n format type</a>
</li><li class="li-toc"><a href="#i18n-format-examples">15.8 Examples of using the Internationalization Format Checker</a>
</li></ul>
</li><li class="li-toc"><a href="#propkey-checker">Chapter ‍16 Property File Checker</a>
<ul class="toc"><li class="li-toc">
<a href="#genpropkey-checker">16.1 General Property File Checker</a>
</li><li class="li-toc"><a href="#i18n-checker">16.2 Internationalization Checker (I18n Checker)</a>
</li><li class="li-toc"><a href="#compilermsgs-checker">16.3 Compiler Message Key Checker</a>
</li></ul>
</li><li class="li-toc"><a href="#signature-checker">Chapter ‍17 Signature String Checker for string representations of types</a>
<ul class="toc"><li class="li-toc">
<a href="#signature-annotations">17.1 Signature annotations</a>
</li><li class="li-toc"><a href="#signature-checks">17.2 What the Signature Checker checks</a>
</li></ul>
</li><li class="li-toc"><a href="#guieffect-checker">Chapter ‍18 GUI Effect Checker</a>
<ul class="toc"><li class="li-toc">
<a href="#guieffect-annotations">18.1 GUI effect annotations</a>
</li><li class="li-toc"><a href="#guieffect-checks">18.2 What the GUI Effect Checker checks</a>
</li><li class="li-toc"><a href="#guieffect-running">18.3 Running the GUI Effect Checker</a>
</li><li class="li-toc"><a href="#guieffect-defaults">18.4 Annotation defaults</a>
</li><li class="li-toc"><a href="#guieffect-polymorphism">18.5 Polymorphic effects</a>
</li><li class="li-toc"><a href="#guieffect-references">18.6 References</a>
</li></ul>
</li><li class="li-toc"><a href="#units-checker">Chapter ‍19 Units Checker</a>
<ul class="toc"><li class="li-toc">
<a href="#units-annotations">19.1 Units annotations</a>
</li><li class="li-toc"><a href="#extending-units">19.2 Extending the Units Checker</a>
</li><li class="li-toc"><a href="#units-checks">19.3 What the Units Checker checks</a>
</li><li class="li-toc"><a href="#units-running">19.4 Running the Units Checker</a>
</li><li class="li-toc"><a href="#units-suppressing">19.5 Suppressing warnings</a>
</li><li class="li-toc"><a href="#units-references">19.6 References</a>
</li></ul>
</li><li class="li-toc"><a href="#signedness-checker">Chapter ‍20 Signedness Checker</a>
<ul class="toc"><li class="li-toc">
<a href="#signedness-checker-annotations">20.1 Annotations</a>
</li><li class="li-toc"><a href="#signedness-checker-prohibited-operations">20.2 Prohibited operations</a>
</li><li class="li-toc"><a href="#signedness-utilities">20.3 Utility routines for manipulating unsigned values</a>
</li><li class="li-toc"><a href="#signedness-refinement">20.4 Local type refinement</a>
</li><li class="li-toc"><a href="#signedness-instantiating-polymorphism">20.5 Instantiating polymorphism</a>
</li><li class="li-toc"><a href="#signedness-other-annotations">20.6 Other signedness annotations</a>
</li></ul>
</li><li class="li-toc"><a href="#purity-checker">Chapter ‍21 Purity Checker</a>
<ul class="toc"><li class="li-toc">
<a href="#purity-annotations">21.1 Purity annotations</a>
</li><li class="li-toc"><a href="#purity-trusted">21.2 Purity annotations are trusted</a>
</li><li class="li-toc"><a href="#purity-override">21.3 Overriding methods must respect specifications in superclasses</a>
</li><li class="li-toc"><a href="#purity-suppress-warnings">21.4 Suppressing warnings</a>
</li></ul>
</li><li class="li-toc"><a href="#constant-value-checker">Chapter ‍22 Constant Value Checker</a>
<ul class="toc"><li class="li-toc">
<a href="#constant-value-checker-annotations">22.1 Annotations</a>
</li><li class="li-toc"><a href="#other-constant-value-annotations">22.2 Other constant value annotations</a>
</li><li class="li-toc"><a href="#value-checker-warnings">22.3 Warnings</a>
</li><li class="li-toc"><a href="#value-checker-overflow">22.4 Unsoundly ignoring overflow</a>
</li><li class="li-toc"><a href="#non-null-strings-concats">22.5 Strings can be null in concatenations</a>
</li></ul>
</li><li class="li-toc"><a href="#returns-receiver-checker">Chapter ‍23 Returns Receiver Checker</a>
<ul class="toc"><li class="li-toc">
<a href="#returns-receiver-checker-annotations">23.1 Annotations</a>
</li><li class="li-toc"><a href="#returns-receiver-checker-autovalue-lombok-support">23.2 AutoValue and Lombok Support</a>
</li></ul>
</li><li class="li-toc"><a href="#reflection-resolution">Chapter ‍24 Reflection resolution</a>
<ul class="toc"><li class="li-toc">
<a href="#reflection-examples">24.1 Reflection resolution example</a>
</li><li class="li-toc"><a href="#methodval-and-classval-checkers">24.2 MethodVal and ClassVal Checkers</a>
</li></ul>
</li><li class="li-toc"><a href="#initialized-fields-checker">Chapter ‍25 Initialized Fields Checker</a>
<ul class="toc"><li class="li-toc">
<a href="#initialized-fields-checker-running">25.1 Running the Initialized Fields Checker</a>
</li><li class="li-toc"><a href="#initialized-fields-motivation">25.2 Motivation: uninitialized fields</a>
</li><li class="li-toc"><a href="#initialized-fields-example">25.3 Example</a>
</li><li class="li-toc"><a href="#initialized-fields-annotations">25.4 Annotations</a>
</li><li class="li-toc"><a href="#initialized-fields-vs-initialization">25.5 Comparison to the Initialization Checker</a>
</li></ul>
</li><li class="li-toc"><a href="#aliasing-checker">Chapter ‍26 Aliasing Checker</a>
<ul class="toc"><li class="li-toc">
<a href="#aliasing-annotations">26.1 Aliasing annotations</a>
</li><li class="li-toc"><a href="#aliasing-leaking-contexts">26.2 Leaking contexts</a>
</li><li class="li-toc"><a href="#aliasing-unique-restrictions">26.3 Restrictions on where <span style="font-family:monospace">@Unique</span> may be written</a>
</li><li class="li-toc"><a href="#aliasing-refinement">26.4 Aliasing type refinement</a>
</li></ul>
</li><li class="li-toc"><a href="#must-call-checker">Chapter ‍27 Must Call Checker</a>
<ul class="toc"><li class="li-toc">
<a href="#must-call-annotations">27.1 Must Call annotations</a>
</li><li class="li-toc"><a href="#must-call-on-class">27.2 Writing <span style="font-family:monospace">@MustCall</span>/<span style="font-family:monospace">@InheritableMustCall</span> on a class</a>
</li><li class="li-toc"><a href="#must-call-non-owning-parameter">27.3 Relationship to lightweight ownership</a>
</li><li class="li-toc"><a href="#must-call-reflection">27.4 Assumptions about reflection</a>
</li><li class="li-toc"><a href="#must-call-type-params">27.5 Type parameter bounds often need to be annotated</a>
</li></ul>
</li><li class="li-toc"><a href="#subtyping-checker">Chapter ‍28 Subtyping Checker</a>
<ul class="toc"><li class="li-toc">
<a href="#subtyping-using">28.1 Using the Subtyping Checker</a>
</li><li class="li-toc"><a href="#encrypted-example">28.2 Subtyping Checker example</a>
</li><li class="li-toc"><a href="#subtyping-type-alias">28.3 Type aliases and typedefs</a>
</li></ul>
</li><li class="li-toc"><a href="#external-checkers">Chapter ‍29 Third-party checkers</a>
<ul class="toc"><li class="li-toc">
<a href="#deteriminism-checker">29.1 Determinism checker</a>
</li><li class="li-toc"><a href="#interval-inference-checker">29.2 Constant Value Inference (Interval Inference)</a>
</li><li class="li-toc"><a href="#crypto-checker">29.3 Crypto Checker</a>
</li><li class="li-toc"><a href="#crypto-policy-compliance-checker">29.4 AWS crypto policy compliance checker</a>
</li><li class="li-toc"><a href="#kms-compliance-checker">29.5 AWS KMS compliance checker</a>
</li><li class="li-toc"><a href="#punits-checker">29.6 PUnits units of measurement</a>
</li><li class="li-toc"><a href="#jatyc-checker">29.7 JaTyC typestate checker</a>
</li><li class="li-toc"><a href="#nullaway-checker">29.8 NullAway</a>
</li><li class="li-toc"><a href="#initialization-rawness-checker">29.9 Nullness Rawness Checker</a>
</li><li class="li-toc"><a href="#rx-thread-checker">29.10 UI Thread Checker for ReactiveX</a>
</li><li class="li-toc"><a href="#pico-checker">29.11 Practical Immutability For Classes And Objects (PICO)</a>
</li><li class="li-toc"><a href="#read-checker">29.12 Read Checker and Cast Checker for ensuring that EOF is recognized</a>
</li><li class="li-toc"><a href="#ontology-checker">29.13 Ontology type system</a>
</li><li class="li-toc"><a href="#glacier-immutability-checker">29.14 Glacier: Class immutability</a>
</li><li class="li-toc"><a href="#sql-schecker">29.15 SQL checker that supports multiple dialects</a>
</li><li class="li-toc"><a href="#javari-checker">29.16 Immutability checkers: IGJ, OIGJ, and Javari</a>
</li><li class="li-toc"><a href="#jcrypt-checker">29.17 JCrypt: computation over encrypted data</a>
</li><li class="li-toc"><a href="#droidinfer-checker">29.18 DroidInfer: information flow</a>
</li><li class="li-toc"><a href="#error-prone-checker">29.19 Error Prone linter</a>
</li><li class="li-toc"><a href="#sparta-checker">29.20 SPARTA information flow type-checker for Android</a>
</li><li class="li-toc"><a href="#sflow-checker">29.21 SFlow type system for information flow</a>
</li><li class="li-toc"><a href="#checklt-checker">29.22 CheckLT taint checker</a>
</li><li class="li-toc"><a href="#enerj-checker">29.23 EnerJ checker</a>
</li><li class="li-toc"><a href="#reim-checker">29.24 ReIm immutability</a>
</li><li class="li-toc"><a href="#sflow-reim-checker">29.25 SFlow x ReIm for information flow and reference immutability</a>
</li><li class="li-toc"><a href="#gut-checker">29.26 Generic Universe Types checker</a>
</li><li class="li-toc"><a href="#safety-critical-java-checker">29.27 Safety-Critical Java checker</a>
</li><li class="li-toc"><a href="#loci-thread-locality-checker">29.28 Thread locality checker</a>
</li><li class="li-toc"><a href="#units-and-dimensions-checker">29.29 Units and dimensions checker</a>
</li><li class="li-toc"><a href="#typestate-checker">29.30 Typestate checkers</a>
</li></ul>
</li><li class="li-toc"><a href="#polymorphism">Chapter ‍30 Generics and polymorphism</a>
<ul class="toc"><li class="li-toc">
<a href="#generics">30.1 Generics (parametric polymorphism or type polymorphism)</a>
</li><li class="li-toc"><a href="#qualifier-polymorphism">30.2 Qualifier polymorphism for methods</a>
</li><li class="li-toc"><a href="#class-qualifier-polymorphism">30.3 Class qualifier parameters</a>
</li></ul>
</li><li class="li-toc"><a href="#advanced-type-system-features">Chapter ‍31 Advanced type system features</a>
<ul class="toc"><li class="li-toc">
<a href="#invariant-arrays">31.1 Invariant array types</a>
</li><li class="li-toc"><a href="#array-context-sensitive">31.2 Context-sensitive type inference for array constructors</a>
</li><li class="li-toc"><a href="#upper-bound-for-use">31.3 Upper bound of qualifiers on uses of a given type (annotations on a class declaration)</a>
</li><li class="li-toc"><a href="#effective-qualifier">31.4 The effective qualifier on a type (defaults and inference)</a>
</li><li class="li-toc"><a href="#defaults">31.5 Default qualifier for unannotated types</a>
</li><li class="li-toc"><a href="#annotations-on-constructors">31.6 Annotations on constructors</a>
</li><li class="li-toc"><a href="#type-refinement">31.7 Type refinement (flow-sensitive type qualifier inference)</a>
</li><li class="li-toc"><a href="#java-expressions-as-arguments">31.8 Writing Java expressions as annotation arguments</a>
</li><li class="li-toc"><a href="#field-invariants">31.9 Field invariants</a>
</li><li class="li-toc"><a href="#unused-fields">31.10 Unused fields</a>
</li></ul>
</li><li class="li-toc"><a href="#suppressing-warnings">Chapter ‍32 Suppressing warnings</a>
<ul class="toc"><li class="li-toc">
<a href="#suppresswarnings-annotation">32.1 <span style="font-family:monospace">@SuppressWarnings</span> annotation</a>
</li><li class="li-toc"><a href="#assumeassertion">32.2 <span style="font-family:monospace">@AssumeAssertion</span> string in an <span style="font-family:monospace">assert</span> message</a>
</li><li class="li-toc"><a href="#suppresswarnings-command-line">32.3 <span style="font-family:monospace">-AsuppressWarnings</span> command-line option</a>
</li><li class="li-toc"><a href="#askipuses">32.4 <span style="font-family:monospace">-AskipUses</span> and <span style="font-family:monospace">-AonlyUses</span> command-line options</a>
</li><li class="li-toc"><a href="#askipdefs">32.5 <span style="font-family:monospace">-AskipDefs</span> and <span style="font-family:monospace">-AonlyDefs</span> command-line options</a>
</li><li class="li-toc"><a href="#lint-options">32.6 <span style="font-family:monospace">-Alint</span> command-line option</a>
</li><li class="li-toc"><a href="#suppressing-warnings-stub">32.7 Change the specification of a method</a>
</li><li class="li-toc"><a href="#no-processor">32.8 Don’t run the processor</a>
</li><li class="li-toc"><a href="#checker-specific-suppression">32.9 Checker-specific mechanisms</a>
</li></ul>
</li><li class="li-toc"><a href="#type-inference">Chapter ‍33 Type inference</a>
<ul class="toc"><li class="li-toc">
<a href="#type-inference-tools">33.1 Type inference tools</a>
</li><li class="li-toc"><a href="#whole-program-inference">33.2 Whole-program inference</a>
</li><li class="li-toc"><a href="#wpi-one">33.3 Running whole-program inference on a single project</a>
</li><li class="li-toc"><a href="#wpi-many">33.4 Running whole-program inference on many projects</a>
</li><li class="li-toc"><a href="#wpi-insert">33.5 Whole-program inference that inserts annotations into source code</a>
</li><li class="li-toc"><a href="#whole-program-inference-non-representative-uses">33.6 Inference results depend on uses in your program or test suite</a>
</li><li class="li-toc"><a href="#how-whole-program-inference-works">33.7 How whole-program inference works</a>
</li><li class="li-toc"><a href="#type-inference-vs-whole-program-analysis">33.8 Type inference compared to other whole-program analyses</a>
</li></ul>
</li><li class="li-toc"><a href="#annotating-libraries">Chapter ‍34 Annotating libraries</a>
<ul class="toc"><li class="li-toc">
<a href="#library-tips">34.1 Tips for annotating a library</a>
</li><li class="li-toc"><a href="#annotating-libraries-create">34.2 Creating an annotated library</a>
</li><li class="li-toc"><a href="#annotating-jdk">34.3 Creating an annotated JDK</a>
</li><li class="li-toc"><a href="#compiling-libraries">34.4 Compiling partially-annotated libraries</a>
</li><li class="li-toc"><a href="#stub">34.5 Using stub classes</a>
</li><li class="li-toc"><a href="#ajava-files">34.6 Ajava files</a>
</li><li class="li-toc"><a href="#libraries-troubleshooting">34.7 Troubleshooting/debugging annotated libraries</a>
</li></ul>
</li><li class="li-toc"><a href="#creating-a-checker">Chapter ‍35 How to create a new checker</a>
<ul class="toc"><li class="li-toc">
<a href="#creating-tool-relationships">35.1 How checkers build on the Checker Framework</a>
</li><li class="li-toc"><a href="#creating-parts-of-a-checker">35.2 The parts of a checker</a>
</li><li class="li-toc"><a href="#creating-compiling">35.3 Compiling and using a custom checker</a>
</li><li class="li-toc"><a href="#creating-tips">35.4 Tips for creating a checker</a>
</li><li class="li-toc"><a href="#creating-typequals">35.5 Annotations: Type qualifiers and hierarchy</a>
</li><li class="li-toc"><a href="#creating-compiler-interface">35.6 The checker class: Compiler interface</a>
</li><li class="li-toc"><a href="#creating-extending-visitor">35.7 Visitor: Type rules</a>
</li><li class="li-toc"><a href="#creating-type-introduction">35.8 Type factory: Type introduction rules</a>
</li><li class="li-toc"><a href="#creating-dataflow">35.9 Dataflow: enhancing flow-sensitive type refinement</a>
</li><li class="li-toc"><a href="#creating-a-checker-annotated-jdk">35.10 Annotated JDK and other annotated libraries</a>
</li><li class="li-toc"><a href="#creating-testing-framework">35.11 Testing framework</a>
</li><li class="li-toc"><a href="#creating-debugging-options">35.12 Debugging options</a>
</li><li class="li-toc"><a href="#creating-documenting-a-checker">35.13 Documenting the checker</a>
</li><li class="li-toc"><a href="#creating-javac-tips">35.14 javac implementation survival guide</a>
</li><li class="li-toc"><a href="#creating-integrating-a-checker">35.15 Integrating a checker with the Checker Framework</a>
</li></ul>
</li><li class="li-toc"><a href="#accumulation-checker">Chapter ‍36 Building an accumulation checker</a>
<ul class="toc"><li class="li-toc">
<a href="#accumulation-publications">36.1 Publications</a>
</li></ul>
</li><li class="li-toc"><a href="#external-tools">Chapter ‍37 Integration with external tools</a>
<ul class="toc"><li class="li-toc">
<a href="#android">37.1 Android</a>
</li><li class="li-toc"><a href="#android-gradle">37.2 Android Studio and the Android Gradle Plugin</a>
</li><li class="li-toc"><a href="#ant-task">37.3 Ant task</a>
</li><li class="li-toc"><a href="#buck">37.4 Buck</a>
</li><li class="li-toc"><a href="#javac-wrapper">37.5 Command line, via Checker Framework javac wrapper</a>
</li><li class="li-toc"><a href="#javac">37.6 Command line, via JDK javac</a>
</li><li class="li-toc"><a href="#eclipse">37.7 Eclipse</a>
</li><li class="li-toc"><a href="#gradle">37.8 Gradle</a>
</li><li class="li-toc"><a href="#intellij">37.9 IntelliJ IDEA</a>
</li><li class="li-toc"><a href="#javac-diagnostics-wrapper">37.10 javac diagnostics wrapper</a>
</li><li class="li-toc"><a href="#lombok">37.11 Lombok</a>
</li><li class="li-toc"><a href="#maven">37.12 Maven</a>
</li><li class="li-toc"><a href="#netbeans">37.13 NetBeans</a>
</li><li class="li-toc"><a href="#sbt">37.14 sbt</a>
</li><li class="li-toc"><a href="#tide">37.15 tIDE</a>
</li><li class="li-toc"><a href="#type-inference-varieties">37.16 Type inference tools</a>
</li></ul>
</li><li class="li-toc"><a href="#faq">Chapter ‍38 Frequently Asked Questions (FAQs)</a>
<ul class="toc"><li class="li-toc">
<a href="#faq-motivation-section">38.1 Motivation for pluggable type-checking</a>
</li><li class="li-toc"><a href="#faq-getting-started-section">38.2 Getting started</a>
</li><li class="li-toc"><a href="#faq-usability-section">38.3 Usability of pluggable type-checking</a>
</li><li class="li-toc"><a href="#faq-warnings-section">38.4 How to handle warnings and errors</a>
</li><li class="li-toc"><a href="#faq-false-positives-section">38.5 False positive warnings</a>
</li><li class="li-toc"><a href="#faq-syntax-section">38.6 Syntax of type annotations</a>
</li><li class="li-toc"><a href="#faq-semantics-section">38.7 Semantics of type annotations</a>
</li><li class="li-toc"><a href="#faq-create-a-checker-section">38.8 Creating a new checker</a>
</li><li class="li-toc"><a href="#faq-tool-section">38.9 Tool questions</a>
</li><li class="li-toc"><a href="#faq-other-tools-section">38.10 Relationship to other tools</a>
</li></ul>
</li><li class="li-toc"><a href="#troubleshooting">Chapter ‍39 Troubleshooting, getting help, and contributing</a>
<ul class="toc"><li class="li-toc">
<a href="#common-problems">39.1 Common problems and solutions</a>
</li><li class="li-toc"><a href="#reporting-bugs">39.2 How to report problems (bug reporting)</a>
</li><li class="li-toc"><a href="#build-source">39.3 Building from source</a>
</li><li class="li-toc"><a href="#contributing">39.4 Contributing</a>
</li><li class="li-toc"><a href="#credits">39.5 Credits and changelog</a>
</li><li class="li-toc"><a href="#license">39.6 License</a>
</li><li class="li-toc"><a href="#publications">39.7 Publications</a>
</li></ul>
</li></ul><hr>
<!--TOC chapter id="introduction" Introduction-->
<h1 id="introduction" class="chapter">Chapter ‍1 Introduction <a href="#introduction"><img src="chainlink.svg" width="10" height="10"></a></h1><!--SEC END --><p>The Checker Framework enhances Java’s type system to make it more powerful
and useful.
This lets software developers detect and
prevent errors in their Java programs.</p><p>A “checker” is a compile-time tool that warns you about certain errors or gives you a
guarantee that those errors do not occur.
The Checker Framework comes with checkers for specific types of errors:</p><ol class="enumerate" type=1><li class="li-enumerate">
<a href="#nullness-checker">Nullness Checker</a> for null pointer errors
(see Chapter ‍<a href="#nullness-checker">3</a>)
</li><li class="li-enumerate"><a href="#initialization-checker">Initialization Checker</a> to ensure all
<span style="font-family:monospace">@NonNull</span> fields are set in the constructor (see
Chapter ‍<a href="#initialization-checker">3.8</a>)
</li><li class="li-enumerate"><a href="#map-key-checker">Map Key Checker</a> to track which values are
keys in a map (see Chapter ‍<a href="#map-key-checker">4</a>)
</li><li class="li-enumerate"><a href="#optional-checker">Optional Checker</a> for errors in using the
<a href="https://docs.oracle.com/en/java/javase/17/docs/api/java.base/java/util/Optional.html"><span style="font-family:monospace">Optional</span></a> type (see
Chapter ‍<a href="#optional-checker">5</a>)
</li><li class="li-enumerate"><a href="#interning-checker">Interning Checker</a> for errors in equality
testing and interning (see Chapter ‍<a href="#interning-checker">6</a>)
</li><li class="li-enumerate"><a href="#called-methods-checker">Called Methods Checker</a> for
the builder pattern (see Chapter ‍<a href="#called-methods-checker">7</a>)
</li><li class="li-enumerate"><a href="#resource-leak-checker">Resource Leak Checker</a> for ensuring that resources are disposed of properly
(see Chapter ‍<a href="#resource-leak-checker">8</a>)
</li><li class="li-enumerate"><a href="#fenum-checker">Fake Enum Checker</a> to allow type-safe fake enum
patterns and type aliases or typedefs (see Chapter ‍<a href="#fenum-checker">9</a>)
</li><li class="li-enumerate"><a href="#tainting-checker">Tainting Checker</a> for trust and security errors
(see Chapter ‍<a href="#tainting-checker">10</a>)
</li><li class="li-enumerate"><a href="#lock-checker">Lock Checker</a> for concurrency and lock errors
(see Chapter ‍<a href="#lock-checker">11</a>)
</li><li class="li-enumerate"><a href="#index-checker">Index Checker</a> for array accesses
(see Chapter ‍<a href="#index-checker">12</a>)
</li><li class="li-enumerate"><a href="#regex-checker">Regex Checker</a> to prevent use of syntactically
invalid regular expressions (see Chapter ‍<a href="#regex-checker">13</a>)
</li><li class="li-enumerate"><a href="#formatter-checker">Format String Checker</a> to ensure that format
strings have the right number and type of <span style="font-family:monospace">%</span> directives (see
Chapter ‍<a href="#formatter-checker">14</a>)
</li><li class="li-enumerate"><a href="#i18n-formatter-checker">Internationalization Format String Checker</a>
to ensure that i18n format strings have the right number and type of
<span style="font-family:monospace">{}</span> directives (see Chapter ‍<a href="#i18n-formatter-checker">15</a>)
</li><li class="li-enumerate"><a href="#propkey-checker">Property File Checker</a> to ensure that valid
keys are used for property files and resource bundles (see
Chapter ‍<a href="#propkey-checker">16</a>)
</li><li class="li-enumerate"><a href="#i18n-checker">Internationalization Checker</a> to
ensure that code is properly internationalized (see
Chapter ‍<a href="#i18n-checker">16.2</a>)
</li><li class="li-enumerate"><a href="#signature-checker">Signature String Checker</a> to ensure that the
string representation of a type is properly used, for example in
<span style="font-family:monospace">Class.forName</span> (see Chapter ‍<a href="#signature-checker">17</a>)
</li><li class="li-enumerate"><a href="#guieffect-checker">GUI Effect Checker</a> to ensure that non-GUI
threads do not access the UI, which would crash the application
(see Chapter ‍<a href="#guieffect-checker">18</a>)
</li><li class="li-enumerate"><a href="#units-checker">Units Checker</a> to ensure operations are
performed on correct units of measurement
(see Chapter ‍<a href="#units-checker">19</a>)
</li><li class="li-enumerate"><a href="#signedness-checker">Signedness Checker</a> to
ensure unsigned and signed values are not mixed
(see Chapter ‍<a href="#signedness-checker">20</a>)
</li><li class="li-enumerate"><a href="#purity-checker">Purity Checker</a> to identify whether
methods have side effects (see Chapter ‍<a href="#purity-checker">21</a>)
</li><li class="li-enumerate"><a href="#constant-value-checker">Constant Value Checker</a> to determine
whether an expression’s value can be known at compile time
(see Chapter ‍<a href="#constant-value-checker">22</a>)
</li><li class="li-enumerate"><a href="#reflection-resolution">Reflection Checker</a> to determine
whether an expression’s value (of type <span style="font-family:monospace">Method</span> or <span style="font-family:monospace">Class</span>) can be known at compile time
(see Chapter ‍<a href="#reflection-resolution">24</a>)
</li><li class="li-enumerate"><a href="#initialized-fields-checker">Initialized Fields Checker</a> to ensure all
fields are set in the constructor (see
Chapter ‍<a href="#initialization-checker">3.8</a>)
</li><li class="li-enumerate"><a href="#aliasing-checker">Aliasing Checker</a> to identify whether
expressions have aliases (see Chapter ‍<a href="#aliasing-checker">26</a>)
</li><li class="li-enumerate"><a href="#must-call-checker">Must Call Checker</a> to over-approximate the
methods that should be called on an object before it is de-allocated (see Chapter ‍<a href="#must-call-checker">27</a>)
</li><li class="li-enumerate"><a href="#subtyping-checker">Subtyping Checker</a> for customized checking without
writing any code (see Chapter ‍<a href="#subtyping-checker">28</a>)
</li><li class="li-enumerate"><a href="#third-party-checkers">Third-party checkers</a> that are distributed
separately from the Checker Framework
(see Chapter ‍<a href="#third-party-checkers">29</a>)</li></ol><p>These checkers are easy to use and are invoked as arguments to <span style="font-family:monospace">javac</span>.</p><p>The Checker Framework also enables you to write new checkers of your
own; see Chapters ‍<a href="#subtyping-checker">28</a> and ‍<a href="#creating-a-checker">35</a>.</p>
<!--TOC section id="how-to-read-this-manual" How to read this manual-->
<h2 id="how-to-read-this-manual" class="section">1.1 How to read this manual <a href="#how-to-read-this-manual"><img src="chainlink.svg" width="10" height="10"></a></h2><!--SEC END --><p>If you wish to get started using some particular type system from the list
above, then the most effective way to read this manual is:</p><ul class="itemize"><li class="li-itemize">
Read all of the introductory material
(Chapters ‍<a href="#introduction">1</a>–<a href="#using-a-checker">2</a>).
</li><li class="li-itemize">Read just one of the descriptions of a particular type system and its
checker (Chapters ‍<a href="#nullness-checker">3</a>–<a href="#third-party-checkers">29</a>).
</li><li class="li-itemize">Skim the advanced material that will enable you to make more effective
use of a type system
(Chapters ‍<a href="#polymorphism">30</a>–<a href="#troubleshooting">39</a>), so that you will
know what is available and can find it later. Skip
Chapter ‍<a href="#creating-a-checker">35</a> on creating a new checker.
</li></ul>
<!--TOC section id="pluggable-types" How it works: Pluggable types-->
<h2 id="pluggable-types" class="section">1.2 How it works: Pluggable types <a href="#pluggable-types"><img src="chainlink.svg" width="10" height="10"></a></h2><!--SEC END --><p>Java’s built-in type-checker finds and prevents many errors — but it
doesn’t find and prevent <em>enough</em> errors. The Checker Framework lets you
define new type systems and run them as a plug-in to the javac compiler. Your
code stays completely backward-compatible: your code compiles with any
Java compiler, it runs on any JVM, and your coworkers don’t have to use the
enhanced type system if they don’t want to. You can check part of
your program, or the whole thing. Type inference tools exist to help you annotate your
code; see Section ‍<a href="#type-inference">33</a>.</p><p>Most programmers will use type systems created by other people, such as
those listed at the start of the introduction (Chapter ‍<a href="#introduction">1</a>).
Some people, called “type system designers”, create new type systems
(Chapter ‍<a href="#creating-a-checker">35</a>).
The Checker Framework is useful both to programmers who
wish to write error-free code, and to type system designers who wish to
evaluate and deploy their type systems.</p><p>This document uses the terms “checker” and “type-checking compiler
plugin” as synonyms.</p>
<!--TOC section id="installation" Installation-->
<h2 id="installation" class="section">1.3 Installation <a href="#installation"><img src="chainlink.svg" width="10" height="10"></a></h2><!--SEC END --><p>This section describes how to install the Checker Framework.
</p><ul class="itemize"><li class="li-itemize">
If you use a build system that automatically downloads dependencies,
such as Gradle or Maven, <span style="font-weight:bold">no installation is necessary</span>; just see
Chapter ‍<a href="#external-tools">37</a>.
</li><li class="li-itemize">If you wish to try the Checker Framework without installing it, use the
<a href="http://eisop.uwaterloo.ca/live/">Checker Framework Live Demo</a> webpage.
</li><li class="li-itemize">This section describes how to install the Checker Framework from its
distribution. The Checker Framework release contains everything that you
need, both to run checkers and to write your own checkers.
</li><li class="li-itemize">Alternately, you can build the latest development version from source
(Section ‍<a href="#build-source">39.3</a>).
</li></ul><p><span style="font-weight:bold">Requirement:</span>
You must have a JDK (version 8 or later) installed.</p><p>The installation process has two required steps and one
optional step.
</p><ol class="enumerate" type=1><li class="li-enumerate">
Download the Checker Framework distribution:
<a href="https://eisop.github.io/cf/checker-framework-3.34.0-eisop1.zip"><span style="font-family:monospace">https://eisop.github.io/cf/checker-framework-3.34.0-eisop1.zip</span></a></li><li class="li-enumerate">Unzip it to create a <span style="font-family:monospace">checker-framework-3.34.0-eisop1</span> directory.</li><li class="li-enumerate"><a id="installation-configure-step"></a>Configure your IDE, build system, or command shell to include the Checker
Framework on the classpath. Choose the appropriate section of
Chapter ‍<a href="#external-tools">37</a>.</li></ol><p>Now you are ready to start using the checkers.</p><p>We recommend that you work through the
<a href="https://eisop.github.io/cf/tutorial/">Checker
Framework tutorial</a>, which demonstrates the Nullness, Regex, and Tainting Checkers.</p><p>Section ‍<a href="#example-use">1.4</a> walks you through a simple example. More detailed
instructions for using a checker appear in Chapter ‍<a href="#using-a-checker">2</a>.</p><p><a id="version-number"></a>
The Checker Framework is released on a monthly schedule. The minor version
(the middle number in the version number) is incremented if there are any
incompatibilities
with the previous version, including in user-visible
behavior or in methods that a checker implementation might call.</p>
<!--TOC section id="example-use" Example use: detecting a null pointer bug-->
<h2 id="example-use" class="section">1.4 Example use: detecting a null pointer bug <a href="#example-use"><img src="chainlink.svg" width="10" height="10"></a></h2><!--SEC END --><p>This section gives a very simple example of running the Checker Framework.
There is also a <a href="https://eisop.github.io/cf/tutorial/">tutorial</a>
that you can work along with.</p><p>Let’s consider this very simple Java class. The local variable <span style="font-family:monospace">ref</span>’s type is
annotated as <a href="../api/org/checkerframework/checker/nullness/qual/NonNull.html"><span style="font-family:monospace">@NonNull</span></a>, indicating that <span style="font-family:monospace">ref</span> must be a reference to a
non-null object. Save the file as <span style="font-family:monospace">GetStarted.java</span>.</p><pre class="verbatim">import org.checkerframework.checker.nullness.qual.*;

public class GetStarted {
    void sample() {
        @NonNull Object ref = new Object();
    }
}
</pre><p>If you run the Nullness Checker (Chapter ‍<a href="#nullness-checker">3</a>), the
compilation completes without any errors.</p><p>Now, introduce an error. Modify <span style="font-family:monospace">ref</span>’s assignment to:
</p><pre>
  @NonNull Object ref = <span style="font-weight:bold">null</span>;
</pre><p>If you run the Nullness Checker again, it emits
the following error:
</p><pre class="verbatim">GetStarted.java:5: incompatible types.
found   : @Nullable &lt;nulltype&gt;
required: @NonNull Object
        @NonNull Object ref = null;
                              ^
1 error
</pre><p>This is a trivially simple example. Even an unsound bug-finding tool like
SpotBugs or Error Prone could have detected this bug. The
Checker Framework’s analysis is more powerful than those tools and detects
more code defects than they do.</p><p>Type qualifiers such as <span style="font-family:monospace">@NonNull</span> are permitted anywhere
that you can write a type, including generics and casts; see
Section ‍<a href="#writing-annotations">2.1</a>. Here are some examples:</p><pre>
  <U>@Interned</U> String intern() <span style="font-family:monospace">{</span> ... <span style="font-family:monospace">}</span>             // return value
  int compareTo(<U>@NonNull</U> String other) <span style="font-family:monospace">{</span> ... <span style="font-family:monospace">}</span>  // parameter
  <U>@NonNull</U> List&lt;<U>@Interned</U> String&gt; messages;     // non-null list of interned Strings
</pre><hr>
<!--TOC chapter id="using-a-checker" Using a checker-->
<h1 id="using-a-checker" class="chapter">Chapter ‍2 Using a checker <a href="#using-a-checker"><img src="chainlink.svg" width="10" height="10"></a></h1><!--SEC END --><p>A pluggable type-checker enables you to detect certain bugs in your code,
or to prove that they are not present. The verification happens at compile
time.</p><p>Finding bugs, or verifying their absence, with a checker is a two-step process, whose steps are
described in Sections ‍<a href="#writing-annotations">2.1</a> and ‍<a href="#running">2.2</a>.</p><ol class="enumerate" type=1><li class="li-enumerate">The programmer writes annotations, such as <a href="../api/org/checkerframework/checker/nullness/qual/NonNull.html"><span style="font-family:monospace">@NonNull</span></a> and
<a href="../api/org/checkerframework/checker/interning/qual/Interned.html"><span style="font-family:monospace">@Interned</span></a>, that specify additional information about Java types.
(Or, the programmer uses an inference tool to automatically infer
annotations that are consistent with their code: see Section ‍<a href="#type-inference">33</a>.)
It is possible to annotate only part of your code: see
Section ‍<a href="#unannotated-code">2.4.6</a>.</li><li class="li-enumerate">The checker reports whether the program contains any erroneous code
— that is, code that is inconsistent with the annotations.</li></ol><p>This chapter is structured as follows:
</p><ul class="itemize"><li class="li-itemize">
Section ‍<a href="#writing-annotations">2.1</a>: How to write annotations
</li><li class="li-itemize">Section ‍<a href="#running">2.2</a>: How to run a checker
</li><li class="li-itemize">Section ‍<a href="#checker-guarantees">2.3</a>: What the checker guarantees
</li><li class="li-itemize">Section ‍<a href="#tips-about-writing-annotations">2.4</a>: Tips about writing annotations
</li></ul><p>Additional topics that apply to all checkers are covered later in the manual:
</p><ul class="itemize"><li class="li-itemize">
Chapter ‍<a href="#advanced-type-system-features">31</a>: Advanced type system features
</li><li class="li-itemize">Chapter ‍<a href="#suppressing-warnings">32</a>: Suppressing warnings
</li><li class="li-itemize">Chapter ‍<a href="#annotating-libraries">34</a>: Annotating libraries
</li><li class="li-itemize">Chapter ‍<a href="#creating-a-checker">35</a>: How to create a new checker
</li><li class="li-itemize">Chapter ‍<a href="#external-tools">37</a>: Integration with external tools
</li></ul><p>There is a
<a href="https://eisop.github.io/cf/tutorial/">tutorial</a>
that walks you through using the Checker Framework on the
command line.</p>
<!--TOC section id="writing-annotations" Where to write type annotations-->
<h2 id="writing-annotations" class="section">2.1 Where to write type annotations <a href="#writing-annotations"><img src="chainlink.svg" width="10" height="10"></a></h2><!--SEC END --><p>You may write a type annotation immediately before any
use of a type, including in generics and casts. Because array levels are
types and receivers have types, you can also write type annotations on
them. Here are a few examples of type annotations:</p><pre>
  <U>@Interned</U> String intern() <span style="font-family:monospace">{</span> ... <span style="font-family:monospace">}</span>               // return value
  int compareTo(<U>@NonNull</U> String other) <span style="font-family:monospace">{</span> ... <span style="font-family:monospace">}</span>    // parameter
  String toString(<U>@Tainted</U> MyClass this) <span style="font-family:monospace">{</span> ... <span style="font-family:monospace">}</span>  // receiver ("this" parameter)
  <U>@NonNull</U> List&lt;<U>@Interned</U> String&gt; messages;       // generics:  non-null list of interned Strings
  <U>@Interned</U> String <U>@NonNull</U> [] messages;          // arrays:  non-null array of interned Strings
  myDate = (<U>@Initialized</U> Date) beingConstructed;  // cast
</pre><p>You only need to write type annotations on method signatures, fields, and some type arguments.
Most annotations within method bodies are inferred for you; for more details,
see Section ‍<a href="#type-refinement">31.7</a>.</p><p>The Java Language Specification also defines
declaration annotations, such as <span style="font-family:monospace">@Deprecated</span> and <span style="font-family:monospace">@Override</span>, which apply
to a class, method, or field but do not apply to the method’s return type
or the field’s type. They should be written on their own line in the
source code, before the method’s signature.</p>
<!--TOC section id="running" Running a checker-->
<h2 id="running" class="section">2.2 Running a checker <a href="#running"><img src="chainlink.svg" width="10" height="10"></a></h2><!--SEC END --><p>To run a checker, run the compiler <span style="font-family:monospace">javac</span> as usual,
but either pass the <span style="font-family:monospace">-processor </span><span style="font-family:monospace"><em>plugin_class</em></span> command-line
option, or use auto-discovery as described in
Section ‍<a href="#checker-auto-discovery">2.2.3</a>.
(If your project already uses auto-discovery for some annotation processor,
such as AutoValue, then you should use auto-discovery.)
Two concretes example of using <span style="font-family:monospace">-processor</span> to run the Nullness Checker are</p><pre class="verbatim">  javac -processor nullness MyFile.java
  javac -processor org.checkerframework.checker.nullness.NullnessChecker MyFile.java
</pre><p>where <span style="font-family:monospace">javac</span> is as specified in Section ‍<a href="#javac-wrapper">37.5</a>.</p><p>You can also run a checker from within your favorite IDE or build system. See
Chapter ‍<a href="#external-tools">37</a> for details about build tools such as
Ant (Section ‍<a href="#ant-task">37.3</a>),
Buck (Section ‍<a href="#buck">37.4</a>),
Gradle (Section ‍<a href="#gradle">37.8</a>),
Maven (Section ‍<a href="#maven">37.12</a>), and
sbt (Section ‍<a href="#sbt">37.14</a>);
IDEs such as
Eclipse (Section ‍<a href="#eclipse">37.7</a>),
IntelliJ IDEA (Section ‍<a href="#intellij">37.9</a>),
NetBeans (Section ‍<a href="#netbeans">37.13</a>),
and
tIDE (Section ‍<a href="#tide">37.15</a>);
and about customizing other IDEs and build tools.</p><p>The checker is run on only the Java files that javac compiles.
This includes all Java files specified on the command line and those
created by another annotation processor. It may also include other of
your Java files, if they are more recent than the corresponding <span style="font-family:monospace">.class</span> file.
Even when the checker does not analyze a class (say, the class was
already compiled, or source code is not available), it does check
the <em>uses</em> of those classes in the source code being compiled.
Type-checking works modularly and intraprocedurally: when verifying a
method, it examines only the signature (including annotations) of other
methods, not their implementations. When analyzing a variable use, it
relies on the type of the variable, not any dataflow outside the current
method that produced the value.</p><p>After you compile your code while running a checker, the resulting
<span style="font-family:monospace">.class</span> and <span style="font-family:monospace">.jar</span> files can be used for pluggable type-checking of client code.</p><p>If you compile code without the <span style="font-family:monospace">-processor</span>
command-line option, no checking of the type
annotations is performed. Furthermore, only explicitly-written annotations
are written to the <span style="font-family:monospace">.class</span> file; defaulted annotations are not, and this
will interfere with type-checking of clients that use your code.
Therefore, to create
<span style="font-family:monospace">.class</span> files that will be distributed or compiled against, you should run the
type-checkers for all the annotations that you have written.</p>
<!--TOC subsection id="annotated-libraries-using" Using annotated libraries-->
<h3 id="annotated-libraries-using" class="subsection">2.2.1 Using annotated libraries <a href="#annotated-libraries-using"><img src="chainlink.svg" width="10" height="10"></a></h3><!--SEC END --><p>When your code uses a library that is not currently being compiled, the
Checker Framework looks up the library’s annotations in its class files or
in a stub file.</p><p>Some projects are already distributed with type annotations by their
maintainers, so you do not need to do anything special.
An example is all the libraries in <a href="https://github.com/plume-lib/"><span style="font-family:monospace">https://github.com/plume-lib/</span></a>.
Over time, this should become more common.</p><p>For some other libraries, the Checker Framework developers have provided an
annotated version of the library, either as a stub file or as compiled class files.
(If some library is not available in either of these forms,
you can contribute by annotating it, which will
help you and all other Checker Framework users; see
Chapter ‍<a href="#annotating-libraries">34</a>.)</p><p>Some stub files are used automatically by a checker, without any action on
your part. For others, you must pass the <span style="font-family:monospace">-Astubs=...</span> command-line argument.
As a special case, if an <span style="font-family:monospace">.astub</span> file appears in
<span style="font-family:monospace">checker/resources/</span>, then pass the command-line option
use <span style="font-family:monospace">-Astubs=checker.jar/</span><span style="font-family:monospace"><em>stubfilename.astub</em></span>.
The “<span style="font-family:monospace">checker.jar</span>” should be literal — don’t provide a path.
This special syntax only works for “<span style="font-family:monospace">checker.jar</span>”.
</p><p>The annotated libraries that are provided as class files appear in
<a href="https://search.maven.org/search?q=org.checkerframework.annotatedlib">the
<span style="font-family:monospace">org.checkerframework.annotatedlib</span> group in the Maven Central Repository</a>.
The annotated library has <em>identical</em> behavior to the upstream,
unannotated version; the source code is identical other than added
annotations.
(Some of the annotated libraries are
bcel,
commons-csv,
commons-io,
guava,
and
java-getopt.)</p><p>To use an annotated library:</p><ul class="itemize"><li class="li-itemize">
If your project stores <span style="font-family:monospace">.jar</span> files locally, then
<a href="https://search.maven.org/search?q=org.checkerframework.annotatedlib">download
the <span style="font-family:monospace">.jar</span> file from the Maven Central Repository</a>.</li><li class="li-itemize">If your project manages dependencies using a tool such as Gradle or Maven,
then update your buildfile to use the <span style="font-family:monospace">org.checkerframework.annotatedlib</span>
group. For example, in <span style="font-family:monospace">build.gradle</span>, change<pre class="verbatim">  api group: 'org.apache.bcel', name: 'bcel', version: '6.3.1'
  api group: 'commons-io', name: 'commans-io', version: '2.8'
</pre><p>to</p><pre class="verbatim">  api group: 'org.checkerframework.annotatedlib', name: 'bcel', version: '6.3.1'
  api group: 'org.checkerframework.annotatedlib', name: 'commons-io', version: '2.8.0.1'
</pre><p>Usually use the same version number. (Sometimes you will use a slightly larger
number, if the Checker Framework developers have improved the type
annotations since the last release by the upstream maintainers.) If a
newer version of the upstream library is available but that version is not
available in <span style="font-family:monospace">org.checkerframework.annotatedlib</span>, then
<a href="#reporting-bugs">open an issue</a> requesting that the
<span style="font-family:monospace">org.checkerframework.annotatedlib</span> version be updated.
</p></li></ul><p>There is one special case. If an <span style="font-family:monospace">.astub</span> file is shipped with the
Checker Framework in <span style="font-family:monospace">checker/resources/</span>, then you can
use <span style="font-family:monospace">-Astubs=checker.jar/</span><span style="font-family:monospace"><em>stubfilename.astub</em></span>.
The “<span style="font-family:monospace">checker.jar</span>” should be literal — don’t provide a path.
(This special syntax only works for “<span style="font-family:monospace">checker.jar</span>”.)</p>
<!--TOC subsection id="checker-options" Summary of command-line options-->
<h3 id="checker-options" class="subsection">2.2.2 Summary of command-line options <a href="#checker-options"><img src="chainlink.svg" width="10" height="10"></a></h3><!--SEC END --><p>You can pass command-line arguments to a checker via <span style="font-family:monospace">javac</span>’s standard <span style="font-family:monospace">-A</span>
option (“<span style="font-family:monospace">A</span>” stands for “annotation”). All of the distributed
checkers support the following command-line options.
Each checker may support additional command-line options; see the checker’s
documentation.</p><p>To pass an option to only a particular checker,
prefix the option with the canonical or simple name
of a checker, followed by an underscore “<span style="font-family:monospace">_</span>”.
Such an option will apply only to a checker with that name or any subclass of that checker.
For example, you can use
</p><pre class="verbatim">    -ANullnessChecker_lint=redundantNullComparison
    -Aorg.checkerframework.checker.guieffect.GuiEffectChecker_lint=debugSpew
</pre><p>to pass different lint options to the Nullness and GUI Effect Checkers. A
downside is that, in this example, the Nullness Checker will issue a
“The following options were not recognized by any processor” warning
about the second option and the GUI Effect Checker will issue a
“The following options were not recognized by any processor” warning
about the first option.</p><p>Unsound checking: ignore some errors
</p><ul class="itemize"><li class="li-itemize">
<span style="font-family:monospace">-AsuppressWarnings</span>
Suppress all errors and warnings matching the given key; see
Section ‍<a href="#suppresswarnings-command-line">32.3</a>.
</li><li class="li-itemize"><span style="font-family:monospace">-AskipUses</span>, <span style="font-family:monospace">-AonlyUses</span>
Suppress all errors and warnings at all uses of a given class — or at all
uses except those of a given class. See Section ‍<a href="#askipuses">32.4</a>.
</li><li class="li-itemize"><span style="font-family:monospace">-AskipDefs</span>, <span style="font-family:monospace">-AonlyDefs</span>
Suppress all errors and warnings within the definition of a given class
— or everywhere except within the definition of a given class. See
Section ‍<a href="#askipdefs">32.5</a>.
</li><li class="li-itemize"><span style="font-family:monospace">-AassumeSideEffectFree</span>, <span style="font-family:monospace">-AassumeDeterministic</span>, <span style="font-family:monospace">-AassumePure</span>
Unsoundly assume that every method is side-effect-free, deterministic, or
both; see
Section ‍<a href="#type-refinement-purity">31.7.5</a>.
</li><li class="li-itemize"><span style="font-family:monospace">-AassumeAssertionsAreEnabled</span>, <span style="font-family:monospace">-AassumeAssertionsAreDisabled</span>
Whether to assume that assertions are enabled or disabled; see Section ‍<a href="#type-refinement-assertions">31.7.6</a>.
</li><li class="li-itemize"><span style="font-family:monospace">-AignoreRangeOverflow</span>
Ignore the possibility of overflow for range annotations such as
<span style="font-family:monospace">@IntRange</span>; see Section ‍<a href="#value-checker-overflow">22.4</a>.
</li><li class="li-itemize"><span style="font-family:monospace">-Awarns</span>
Treat checker errors as warnings. If you use this, you may wish to also
supply <span style="font-family:monospace">-Xmaxwarns 10000</span>, because by default <span style="font-family:monospace">javac</span> prints at
most 100 warnings. If you use this, don’t supply <span style="font-family:monospace">-Werror</span>,
which is a javac argument to halt compilation if a warning is issued.
</li><li class="li-itemize"><span style="font-family:monospace">-AignoreInvalidAnnotationLocations</span>
Ignore annotations in bytecode that have invalid annotation locations.
</li></ul><p><a id="unsound-by-default"></a>
More sound (strict) checking: enable errors that are disabled by default
</p><ul class="itemize"><li class="li-itemize">
<span style="font-family:monospace">-AcheckPurityAnnotations</span>
Check the bodies of methods marked
<a href="../api/org/checkerframework/dataflow/qual/SideEffectFree.html"><span style="font-family:monospace">@SideEffectFree</span></a>,
<a href="../api/org/checkerframework/dataflow/qual/Deterministic.html"><span style="font-family:monospace">@Deterministic</span></a>,
and <a href="../api/org/checkerframework/dataflow/qual/Pure.html"><span style="font-family:monospace">@Pure</span></a>
to ensure the method satisfies the annotation. By default,
the Checker Framework unsoundly trusts the method annotation. See
Section ‍<a href="#type-refinement-purity">31.7.5</a>.
</li><li class="li-itemize"><span style="font-family:monospace">-AinvariantArrays</span>
Make array subtyping invariant; that is, two arrays are subtypes of one
another only if they have exactly the same element type. By default,
the Checker Framework unsoundly permits covariant array subtyping, just
as Java does. See Section ‍<a href="#invariant-arrays">31.1</a>.
</li><li class="li-itemize"><span style="font-family:monospace">-AcheckCastElementType</span>
In a cast, require that parameterized type arguments and array elements
are the same. By default, the Checker Framework unsoundly permits them
to differ, just as Java does. See Section ‍<a href="#covariant-type-parameters">30.1.6</a>
and Section ‍<a href="#invariant-arrays">31.1</a>.
</li><li class="li-itemize"><span style="font-family:monospace">-AcheckEnclosingExpr</span>
Enables type checking for enclosing expression types of inner class instantiations.
</li><li class="li-itemize"><span style="font-family:monospace">-AuseConservativeDefaultsForUncheckedCode</span>
Enables conservative defaults, and suppresses all type-checking warnings,
in unchecked code. Takes arguments “source,bytecode”.
“-source,-bytecode” is the (unsound) default setting.
<ul class="itemize"><li class="li-itemize">
“bytecode” specifies
whether the checker should apply conservative defaults to
bytecode (that is, to already-compiled libraries); see
Section ‍<a href="#defaults-classfile">31.5.6</a>.
</li><li class="li-itemize">Outside the scope of any relevant
<a href="../api/org/checkerframework/framework/qual/AnnotatedFor.html"><span style="font-family:monospace">@AnnotatedFor</span></a> annotation, “source” specifies whether conservative
default annotations are applied to source code and suppress all type-checking warnings; see
Section ‍<a href="#compiling-libraries">34.4</a>.
</li></ul>
</li><li class="li-itemize"><span style="font-family:monospace">-AconcurrentSemantics</span>
Whether to assume concurrent semantics (field values may change at any
time) or sequential semantics; see Section ‍<a href="#faq-concurrency">38.4.6</a>.
</li><li class="li-itemize"><span style="font-family:monospace">-AconservativeUninferredTypeArguments</span>
Whether an error should be issued if type arguments could not be inferred and
whether method type arguments that could not be inferred should use
conservative defaults.
By default, such type arguments are (largely) ignored in later
checks.
Passing this option uses a conservative value instead.
See <a href="https://github.com/typetools/checker-framework/issues/979">Issue
979</a>.
</li><li class="li-itemize"><span style="font-family:monospace">-AignoreRawTypeArguments=false</span>
Do not ignore subtype tests for type arguments that were inferred for a
raw type. Must also use <span style="font-family:monospace">-AconservativeUninferredTypeArguments</span>. See
Section ‍<a href="#generics-raw-types">30.1.1</a>.
</li><li class="li-itemize"><span style="font-family:monospace">-processor org.checkerframework.common.initializedfields.InitializedFieldsChecker,...</span>
Ensure that all fields are initialized by the constructor. See
Chapter ‍<a href="#initialized-fields-checker">25</a>.
</li></ul><p>Type-checking modes: enable/disable functionality
</p><ul class="itemize"><li class="li-itemize">
<span style="font-family:monospace">-Alint</span>
Enable or disable optional checks; see Section ‍<a href="#lint-options">32.6</a>.
</li><li class="li-itemize"><span style="font-family:monospace">-AwarnRedundantAnnotations</span>
Warn about redundant annotations.
A warning is issued if an explicitly written annotation
is the same as the default annotation for that location.
This feature does not warn about all redundant annotations, only some.
</li><li class="li-itemize"><span style="font-family:monospace">-AsuggestPureMethods</span>
Suggest methods that could be marked
<a href="../api/org/checkerframework/dataflow/qual/SideEffectFree.html"><span style="font-family:monospace">@SideEffectFree</span></a>,
<a href="../api/org/checkerframework/dataflow/qual/Deterministic.html"><span style="font-family:monospace">@Deterministic</span></a>,
or <a href="../api/org/checkerframework/dataflow/qual/Pure.html"><span style="font-family:monospace">@Pure</span></a>; see
Section ‍<a href="#type-refinement-purity">31.7.5</a>.
</li><li class="li-itemize"><span style="font-family:monospace">-AresolveReflection</span>
Determine the target of reflective calls, and perform more precise
type-checking based on that information; see
Chapter ‍<a href="#reflection-resolution">24</a>. <span style="font-family:monospace">-AresolveReflection=debug</span> causes
debugging information to be output.
</li><li class="li-itemize"><span style="font-family:monospace">-Ainfer=</span><span style="font-family:monospace"><em>outputformat</em></span>
Output suggested annotations for method signatures and fields.
These annotations may reduce the number of type-checking
errors when running type-checking in the future; see
Section ‍<a href="#whole-program-inference">33.2</a>.
Using <span style="font-family:monospace">-Ainfer=jaifs</span> produces <span style="font-family:monospace">.jaif</span> files.
Using <span style="font-family:monospace">-Ainfer=stubs</span> produces <span style="font-family:monospace">.astub</span> files.
Using <span style="font-family:monospace">-Ainfer=ajava</span> produces <span style="font-family:monospace">.ajava</span> files.
You must also supply <span style="font-family:monospace">-Awarns</span>, or the inference output may be incomplete.
</li><li class="li-itemize"><span style="font-family:monospace">-AinferOutputOriginal</span>
When outputting <span style="font-family:monospace">.ajava</span> files when running with <span style="font-family:monospace">-Ainfer=ajava</span>,
also output a copy of the original file with no inferred annotations,
but with the formatting of a <span style="font-family:monospace">.ajava</span> file, to permit use of <span style="font-family:monospace">diff</span>
to view the inferred annotations. Must be combined with <span style="font-family:monospace">-Ainfer=ajava</span>.
</li><li class="li-itemize"><span style="font-family:monospace">-AshowSuppressWarningsStrings</span>
With each warning, show all possible strings to suppress that warning.
</li><li class="li-itemize"><span style="font-family:monospace">-AwarnUnneededSuppressions</span>
Issue a warning if a <span style="font-family:monospace">@SuppressWarnings</span> did not suppress a warning
issued by the checker. This only warns about
<span style="font-family:monospace">@SuppressWarnings</span> strings that contain a checker name
(for syntax, Section ‍<a href="#suppresswarnings-annotation-syntax">32.1.1</a>). The
<span style="font-family:monospace">-ArequirePrefixInWarningSuppressions</span> command-line argument ensures
that all <span style="font-family:monospace">@SuppressWarnings</span> strings contain a checker name.
An <span style="font-family:monospace">unneeded.suppression</span> warning can be suppressed only by
<span style="font-family:monospace">@SuppressWarnings("unneeded.suppression")</span>
or <span style="font-family:monospace">@SuppressWarnings("</span><span style="font-family:monospace"><em>checkername</em></span><span style="font-family:monospace">:unneeded.suppression")</span>,
not by <span style="font-family:monospace">@SuppressWarnings("</span><span style="font-family:monospace"><em>checkername</em></span><span style="font-family:monospace">")</span>.
</li><li class="li-itemize"><span style="font-family:monospace">-AwarnUnneededSuppressionsExceptions=</span><span style="font-family:monospace"><em>regex</em></span> disables
<span style="font-family:monospace">-AwarnUnneededSuppressions</span> for <span style="font-family:monospace">@SuppressWarnings</span> strings that
contain a match for the regular expression. Most users don’t need this.
</li><li class="li-itemize"><span style="font-family:monospace">-ArequirePrefixInWarningSuppressions</span>
Require that the string in a warning suppression annotation begin with a checker
name. Otherwise, the suppress warning annotation does not
suppress any warnings. For example, if this command-line option is
supplied, then <span style="font-family:monospace">@SuppressWarnings("assignment.type.incompatible")</span> has no effect, but
<span style="font-family:monospace">@SuppressWarnings("nullness:assignment.type.incompatible")</span> does.
</li><li class="li-itemize"><span style="font-family:monospace">-AshowPrefixInWarningMessages</span>
When issuing an error or warning, prefix the warning suppression key by
the checker name. For instance, output
“error: [nullness:assignment.type.incompatible] ...” instead of
“error: [assignment.type.incompatible]”. This makes it easy to tell,
from the suppression key only, which checker issued the error or warning.
</li><li class="li-itemize"><span style="font-family:monospace">-AnoJreVersionCheck</span>
By default the Checker Framework issues a note when running on a JDK
version that the Checker Framework maintainers do not support.
This flag disables the JDK version check and issues neither a warning nor
a note. This is useful to allow Checker Framework tests to run on any
JDK, but could also be useful when the note is redundant for a
user.
The Checker Framework seems to work on all versions of the JDK, from JDK
8 onward. However, in the past, Oracle has introduced JDK
incompatibilities that caused mysterious (to users) failures. If you
have a problem while using this command-line argument, please do not
report it to the Checker Framework maintainers unless you can reproduce
the problem without this command-line argument.</li></ul><p>Partially-annotated libraries
</p><ul class="itemize"><li class="li-itemize"><span style="font-family:monospace">-Astubs</span>
List of stub files or directories; see Section ‍<a href="#stub-using">34.5.1</a>.</li><li class="li-itemize"><span style="font-family:monospace">-AstubWarnIfNotFound</span>,
<span style="font-family:monospace">-AstubNoWarnIfNotFound</span>,
<span style="font-family:monospace">-AstubWarnIfNotFoundIgnoresClasses</span>,
<span style="font-family:monospace">-AstubWarnIfRedundantWithBytecode</span>,
<span style="font-family:monospace">-AstubWarnNote</span>
Warn about problems with stub files; see Section ‍<a href="#stub-troubleshooting">34.5.7</a>.</li><li class="li-itemize"><span style="font-family:monospace">-AmergeStubsWithSource</span>
If both a stub file and a source file for a class are available, trust
both and use the greatest lower bound of their annotations. The default
behavior (without this flag) is to ignore types from the stub file if
source is available. See Section ‍<a href="#stub-multiple-specifications">34.5.2</a>.
</li><li class="li-itemize"><span style="font-family:monospace">-AuseConservativeDefaultsForUncheckedCode=source</span>
Outside the scope of any relevant
<a href="../api/org/checkerframework/framework/qual/AnnotatedFor.html"><span style="font-family:monospace">@AnnotatedFor</span></a> annotation, use conservative
default annotations and suppress all type-checking warnings; see
Section ‍<a href="#compiling-libraries">34.4</a>.</li></ul><p>Debugging
</p><ul class="itemize"><li class="li-itemize">
<span style="font-family:monospace">-AprintAllQualifiers</span>,
<span style="font-family:monospace">-AprintVerboseGenerics</span>,
<span style="font-family:monospace">-Anomsgtext</span>,
<span style="font-family:monospace">-AdumpOnErrors</span>
Amount of detail in messages; see Section ‍<a href="#creating-debugging-options-detail">35.12.1</a>.</li><li class="li-itemize"><span style="font-family:monospace">-Adetailedmsgtext</span>
Format of diagnostic messages; see Section ‍<a href="#creating-debugging-options-format">35.12.2</a>.</li><li class="li-itemize"><span style="font-family:monospace">-Aignorejdkastub</span>,
<span style="font-family:monospace">-ApermitMissingJdk</span>,
<span style="font-family:monospace">-AparseAllJdk</span>,
<span style="font-family:monospace">-AstubDebug</span>
Stub and JDK libraries; see Section ‍<a href="#creating-debugging-options-libraries">35.12.3</a>.</li><li class="li-itemize"><span style="font-family:monospace">-Afilenames</span>,
<span style="font-family:monospace">-Ashowchecks</span>,
<span style="font-family:monospace">-AshowInferenceSteps</span>,
<span style="font-family:monospace">-AshowWpiFailedInferences</span>
Progress tracing; see Section ‍<a href="#creating-debugging-options-progress">35.12.4</a>.</li><li class="li-itemize"><span style="font-family:monospace">-AoutputArgsToFile</span>
Output the compiler command-line arguments to a file. Useful when the
command line is generated and executed by a tool, such as a build system.
This produces a standalone command line that can be executed independently
of the tool that generated it (such as a build system).
That command line makes it easier to reproduce, report, and debug issues.
For example, the command line can be modified to enable attaching a debugger.
See Section ‍<a href="#creating-debugging-options-output-args">35.12.5</a>.</li><li class="li-itemize"><span style="font-family:monospace">-Aflowdotdir</span>,
<span style="font-family:monospace">-Averbosecfg</span>,
<span style="font-family:monospace">-Acfgviz</span>
Draw a visualization of the CFG (control flow graph); see
Section ‍<a href="#creating-debugging-dataflow-graph">35.12.6</a>.</li><li class="li-itemize"><span style="font-family:monospace">-AresourceStats</span>,
<span style="font-family:monospace">-AatfDoNotCache</span>,
<span style="font-family:monospace">-AatfCacheSize</span>
Miscellaneous debugging options; see Section ‍<a href="#creating-debugging-options-misc">35.12.7</a>.</li><li class="li-itemize"><span style="font-family:monospace">-Aversion</span>
Print the Checker Framework version.</li><li class="li-itemize"><span style="font-family:monospace">-AprintGitProperties</span>
Print information about the git repository from which the Checker Framework
was compiled.</li><li class="li-itemize"><span style="font-family:monospace">-AnoJreVersionCheck</span>
Do not check the JRE version the Checker Framework is running on.
</li></ul><p>Compatibility options
</p><ul class="itemize"><li class="li-itemize"><span style="font-family:monospace">-AaliasedTypeAnnos=</span><span style="font-family:monospace"><em>aliases</em></span>
Defines custom type annotation aliases for the canonical annotations of a checker.
‘aliases‘ is in the format<p>‘FQN.canonical.Qualifier1:FQN.alias1.Qual1,FQN.alias2.Qual1;FQN.canonical.Qualifier2:FQN.alias1.Qual2‘.</p><p>This can only be used for annotations whose attributes have the same names as in the canonical
annotation, e.g. this will not be usable to declare an alias ‘@Regex(index = 5)‘ for ‘@Regex(value = 5)‘.
When in a Unix system, ‘;‘ needs to be escaped.</p></li><li class="li-itemize"><span style="font-family:monospace">-AaliasedDeclAnnos=</span><span style="font-family:monospace"><em>aliases</em></span>
Defines custom declaration annotation aliases for the canonical annotations of a checker.
‘aliases‘ is in the format<p>‘FQN.canonical.Qualifier1:FQN.alias1.Qual1,FQN.alias2.Qual1;FQN.canonical.Qualifier2:FQN.alias1.Qual2‘.</p><p>This can only be used for annotations without attributes, e.g. this will not be usable to declare an alias for ‘@EnsuresNonNull(...)‘.
When in a Unix system, ‘;‘ needs to be escaped.</p></li></ul><p>Some checkers support additional options, which are described in that
checker’s manual section.
For example, <span style="font-family:monospace">-Aquals</span> tells
the Subtyping Checker (see Chapter ‍<a href="#subtyping-checker">28</a>) and the Fenum Checker
(see Chapter ‍<a href="#fenum-checker">9</a>) which annotations to check.</p><p>Here are some standard javac command-line options that you may find useful.
Many of them contain “processor” or “proc”, because in javac jargon, a
checker is an “annotation processor”.</p><ul class="itemize"><li class="li-itemize">
<span style="font-family:monospace">-processor</span> Names the checker to be
run; see Sections ‍<a href="#running">2.2</a> and ‍<a href="#shorthand-for-checkers">2.2.4</a>.
May be a comma-separated list of multiple checkers. Note that javac
stops processing an indeterminate time after detecting an error. When
providing multiple checkers, if one checker detects any error, subsequent
checkers may not run.
</li><li class="li-itemize"><span style="font-family:monospace">-processorpath</span> Indicates where to search for the
checker. This should also contain any classes used by type-checkers,
such as qualifiers used by the Subtyping Checker (see
Section ‍<a href="#subtyping-example">28.2</a>) and classes that define
statically-executable methods used by the Constant Value Checker (see
Section ‍<a href="#constant-value-staticallyexecutable-annotation">22.2.2</a>).
</li><li class="li-itemize"><span style="font-family:monospace">-proc:</span>{<span style="font-family:monospace">none</span>,<span style="font-family:monospace">only</span>} Controls whether checking
happens; <span style="font-family:monospace">-proc:none</span>
means to skip checking; <span style="font-family:monospace">-proc:only</span> means to do only
checking, without any subsequent compilation; see
Section ‍<a href="#checker-auto-discovery">2.2.3</a>.
</li><li class="li-itemize"><span style="font-family:monospace">-implicit:class</span> Suppresses warnings about implicitly compiled files
(not named on the command line); see Section ‍<a href="#ant-task">37.3</a>
</li><li class="li-itemize"><span style="font-family:monospace">-J</span> Supply an argument to the JVM that is running javac;
for example, <span style="font-family:monospace">-J-Xmx2500m</span> to increase its maximum heap size
</li><li class="li-itemize"><span style="font-family:monospace">-doe</span> To “dump on error”, that is, output a stack trace
whenever a compiler warning/error is produced. Useful when debugging
the compiler or a checker.
</li></ul>
<!--TOC subsection id="checker-auto-discovery" Checker auto-discovery-->
<h3 id="checker-auto-discovery" class="subsection">2.2.3 Checker auto-discovery <a href="#checker-auto-discovery"><img src="chainlink.svg" width="10" height="10"></a></h3><!--SEC END --><p>“Auto-discovery” makes the <span style="font-family:monospace">javac</span> compiler always run an
annotation processor, such as a checker
plugin, without explicitly passing the <span style="font-family:monospace">-processor</span>
command-line option. This can make your command line shorter, and it ensures
that your code is checked even if you forget the command-line option.</p><p>If the <span style="font-family:monospace">javac</span> command line specifies any <span style="font-family:monospace">-processor</span> command-line
option, then auto-discovery is disabled. This means that if your project
currently uses auto-discovery, you should use auto-discovery for the
Checker Framework too. (Alternately, if you prefer to use a <span style="font-family:monospace">-processor</span>
command-line argument, you will need to specify all annotation processors,
including ones that used to be auto-discovered.)</p><p>
To enable auto-discovery, place a configuration file named
<span style="font-family:monospace">META-INF/services/javax.annotation.processing.Processor</span>
in your classpath. The file contains the names of the checkers to
be used, listed one per line. For instance, to run the Nullness Checker and the
Interning Checker automatically, the configuration file should contain:
</p><pre class="verbatim">  org.checkerframework.checker.nullness.NullnessChecker
  org.checkerframework.checker.interning.InterningChecker
</pre><p>You can disable this auto-discovery mechanism by passing the
<span style="font-family:monospace">-proc:none</span> command-line option to <span style="font-family:monospace">javac</span>, which disables all
annotation processing including all pluggable type-checking.</p>
<!--TOC subsection id="shorthand-for-checkers" Shorthand for built-in checkers-->
<h3 id="shorthand-for-checkers" class="subsection">2.2.4 Shorthand for built-in checkers <a href="#shorthand-for-checkers"><img src="chainlink.svg" width="10" height="10"></a></h3><!--SEC END --><p>Ordinarily, javac’s <span style="font-family:monospace">-processor</span> flag requires fully-qualified class names.
When using the Checker Framework javac wrapper (Section ‍<a href="#javac-wrapper">37.5</a>), you may
omit the package name and the <span style="font-family:monospace">Checker</span> suffix.
The following three commands are equivalent:</p><pre>
  javac -processor <span style="font-weight:bold">org.checkerframework.checker.nullness.NullnessChecker</span> MyFile.java
  javac -processor <span style="font-weight:bold">NullnessChecker</span> MyFile.java
  javac -processor <span style="font-weight:bold">nullness</span> MyFile.java
</pre><p>This feature also works when multiple checkers are specified.
Their names are separated by commas, with no surrounding space.
For example:</p><pre>
  javac -processor NullnessChecker,RegexChecker MyFile.java
  javac -processor nullness,regex MyFile.java
</pre><p>This feature does not apply to javac <a href="https://docs.oracle.com/javase/7/docs/technotes/tools/windows/javac.html#commandlineargfile">@argfiles</a>.</p>
<!--TOC section id="checker-guarantees" What the checker guarantees-->
<h2 id="checker-guarantees" class="section">2.3 What the checker guarantees <a href="#checker-guarantees"><img src="chainlink.svg" width="10" height="10"></a></h2><!--SEC END --><p>A checker guarantees two things: type annotations reflect facts about
run-time values, and illegal operations are not performed.</p><p>For example, the Nullness Checker (Chapter ‍<a href="#nullness-checker">3</a>)
guarantees lack of null pointer exceptions (Java <span style="font-family:monospace">NullPointerException</span>).
More precisely, it guarantees
that expressions whose type is annotated with
<a href="../api/org/checkerframework/checker/nullness/qual/NonNull.html"><span style="font-family:monospace">@NonNull</span></a> never evaluate to null,
and it forbids other expressions from being dereferenced.</p><p>As another example, the Interning Checker (Chapter ‍<a href="#interning-checker">6</a>)
guarantees that correct equality tests are performed.
More precisely, it guarantees that
every expression whose type is an <a href="../api/org/checkerframework/checker/interning/qual/Interned.html"><span style="font-family:monospace">@Interned</span></a> type
evaluates to an interned value, and it forbids
<span style="font-family:monospace">==</span> on other expressions.</p><p>The guarantee holds only if you run the checker on every part of your
program and the checker issues no warnings anywhere in the code.
You can also verify just part of your program.</p><p>There are some limitations to the guarantee.</p><ul class="itemize"><li class="li-itemize">A compiler plugin can check only those parts of your program that you run
it on. If you compile some parts of your program without running the
checker, then there is no guarantee that the entire program satisfies the
property being checked. Some examples of un-checked code are:<ul class="itemize"><li class="li-itemize">
Code compiled without the <span style="font-family:monospace">-processor</span> switch. This includes
external libraries supplied as a <span style="font-family:monospace">.class</span> file and native methods
(because the implementation is not Java code, it cannot be checked).
</li><li class="li-itemize">Code compiled with the <span style="font-family:monospace">-AskipUses</span>, <span style="font-family:monospace">-AonlyUses</span>, <span style="font-family:monospace">-AskipDefs</span> or <span style="font-family:monospace">-AonlyDefs</span>
command-line arguments (see Chapter ‍<a href="#suppressing-warnings">32</a>).
</li><li class="li-itemize">Dynamically generated code, such as generated by Spring or MyBatis.
Its bytecode is directly generated and run, not compiled by javac and
not visible to the Checker Framework.
</li></ul><p>In each of these cases, any <em>use</em> of the code is checked — for
example, a call to a native method must be compatible with any
annotations on the native method’s signature.
However, the annotations on the un-checked code are trusted; there is no
verification that the implementation of the native method satisfies the
annotations.</p></li><li class="li-itemize">You can suppress warnings, such as via the <span style="font-family:monospace">@SuppressWarnings</span>
annotation (Chapter ‍<a href="#suppressing-warnings">32</a>). If you do so
incorrectly, the checker’s guarantee no longer holds.</li><li class="li-itemize">The Checker Framework is, by default, unsound in a few places where a
conservative analysis would issue too many false positive warnings.
These are listed in Section ‍<a href="#unsound-by-default">2.2.2</a>.
You can supply a command-line argument to make the Checker Framework
sound for each of these cases.</li><li class="li-itemize">Specific checkers may have other limitations; see their documentation for
details.</li></ul><p>In order to avoid a flood of unhelpful warnings, many of the checkers avoid
issuing the same warning multiple times. For example, consider this code:</p><pre class="verbatim">  @Nullable Object x = ...;
  x.toString();                 // warning
  x.toString();                 // no warning
</pre><p>The second call to <span style="font-family:monospace">toString</span> cannot possibly throw a null
pointer warning — <span style="font-family:monospace">x</span> is non-null if control flows to the second
statement.
In other cases, a checker avoids issuing later warnings with the same cause
even when later code in a method might also fail.
This does not
affect the soundness guarantee, but a user may need to examine more
warnings after fixing the first ones identified. (Often,
a single fix corrects all the warnings.)</p><p>If you find that a checker fails to issue a warning that it
should, then please report a bug (see Section ‍<a href="#reporting-bugs">39.2</a>).</p>
<!--TOC section id="tips-about-writing-annotations" Tips about writing annotations-->
<h2 id="tips-about-writing-annotations" class="section">2.4 Tips about writing annotations <a href="#tips-about-writing-annotations"><img src="chainlink.svg" width="10" height="10"></a></h2><!--SEC END --><p>Section ‍<a href="#library-tips">34.1</a> gives additional tips that are
specific to annotating a third-party library.</p>
<!--TOC subsection id="annotate-before-checking" Write annotations before you run a checker-->
<h3 id="annotate-before-checking" class="subsection">2.4.1 Write annotations before you run a checker <a href="#annotate-before-checking"><img src="chainlink.svg" width="10" height="10"></a></h3><!--SEC END --><p>Before you run a checker, annotate the code, based on its documentation.
Then, run the checker to uncover bugs in the code or the documentation.</p><p>Don’t do the opposite, which is to run the checker and then add annotations
according to the warnings issued. This approach is less systematic, so you
may overlook some annotations. It often leads to confusion and poor
results. It leads users to make changes not for any principled reason, but
to “make the type-checker happy”, even when the changes are in conflict
with the documentation or the code. Also see
<a href="#get-started-annotations-are-a-specification">“Annotations are a
specification”</a>, below.</p>
<!--TOC subsection id="get-started-with-legacy-code" How to get started annotating legacy code-->
<h3 id="get-started-with-legacy-code" class="subsection">2.4.2 How to get started annotating legacy code <a href="#get-started-with-legacy-code"><img src="chainlink.svg" width="10" height="10"></a></h3><!--SEC END --><p>Annotating an entire existing program may seem like a daunting task. But,
if you approach it systematically and do a little bit at a time, you will
find that it is manageable.</p>
<!--TOC subsubsection id="get-started-start-small" Start small-->
<h4 id="get-started-start-small" class="subsubsection">Start small <a href="#get-started-start-small"><img src="chainlink.svg" width="10" height="10"></a></h4><!--SEC END --><p>Start small. Focus on one specific property that matters to you; in
other words, run just one checker rather than multiple ones. You may
choose a different checker for different programs.
Focus on
the most mission-critical or error-prone part of your code; don’t try to
annotate your whole program at first.</p><p>It is easiest to add annotations if you know the code or the
code contains documentation. While adding annotations, you will spend most of your time
understanding the code, and less time actually writing annotations
or running the checker.</p><p>Don’t annotate the whole program, but work module by module.
Start annotating classes at the leaves of the call tree —
that is,
start with classes/packages that have few dependencies on other
code.
Annotate supertypes before you
annotate classes that extend or implement them.
The reason for this rule is that it is
easiest to annotate a class if the code it depends on has already been
annotated.
Sections ‍<a href="#askipuses">32.4</a> and ‍<a href="#askipdefs">32.5</a> give ways to skip
checking of some files, directories, or packages.
Section ‍<a href="#unannotated-code">2.4.6</a> gives advice about handling calls from
annotated code into unannotated code.</p><p>When annotating, be systematic; we recommend
annotating an entire class or module at a time (not just some of the methods)
so that you don’t lose track of your work or redo work. For example,
working class-by-class avoids confusion about whether an unannotated type use
means you determined that the default is desirable, or it means you didn’t
yet examine that type use.</p><p>Don’t overuse pluggable type-checking. If the regular Java type system can
verify a property using Java subclasses, then that is a better choice than
pluggable type-checking (see Section ‍<a href="#faq-typequals-vs-subtypes">38.1.2</a>).</p>
<!--TOC subsubsection id="get-started-annotations-are-a-specification" Annotations are a specification-->
<h4 id="get-started-annotations-are-a-specification" class="subsubsection">Annotations are a specification <a href="#get-started-annotations-are-a-specification"><img src="chainlink.svg" width="10" height="10"></a></h4><!--SEC END --><p>When you write annotations, you are writing a specification, and you should
think about them that way. Start out by understanding the program so that
you can write an accurate specification.
Sections ‍<a href="#annotate-normal-behavior">2.4.3</a>
and ‍<a href="#annotations-are-a-contract">2.4.4</a> give more tips about writing
specifications.</p><p>For each class, read its Javadoc. For instance, if you are adding
annotations for the Nullness Checker (Section ‍<a href="#nullness-checker">3</a>), then
you can search the documentation for “null” and then add <span style="font-family:monospace">@Nullable</span>
anywhere appropriate. Start by annotating signatures and fields, but not
method bodies. The only reason to even
<em>read</em> the method bodies yet is to determine signature annotations for
undocumented methods —
for example, if the method returns null, you know its return type should be
annotated <span style="font-family:monospace">@Nullable</span>, and a parameter that is compared against <span style="font-family:monospace">null</span>
may need to be annotated <span style="font-family:monospace">@Nullable</span>.</p><p>The specification should state all facts that are relevant to callees.
When checking a method, the checker uses only the specification, not the
implementation, of other methods. (Equivalently, type-checking is
“modular” or “intraprocedural”.) When analyzing a variable use, the
checker relies on the type of the variable, not any dataflow outside the
current method that produced the value.</p><p>After you have annotated all the signatures, run the checker.
Then, fix bugs in code and add/modify annotations as necessary.
Don’t get discouraged if you see many type-checker warnings at first.
Often, adding just a few missing annotations will eliminate many warnings,
and you’ll be surprised how fast the process goes overall (assuming that
you understand the code, of course).</p><p>It is usually not a good idea to experiment with adding and removing
annotations in order to understand their effect. It is better to reason
about the desired design. However, to avoid having to manually examine all
callees, a more automated approach is to save the checker output before
changing an annotation, then compare it to the checker output after
changing the annotation.</p><p>Chapter ‍<a href="#annotating-libraries">34</a> tells you how to annotate libraries that
your code uses. Section ‍<a href="#handling-warnings">2.4.5</a> and
Chapter ‍<a href="#suppressing-warnings">32</a> tell you what to do when you are unable
to eliminate checker warnings by adding annotations.</p>
<!--TOC subsubsection id="get-started-write-good-code" Write good code-->
<h4 id="get-started-write-good-code" class="subsubsection">Write good code <a href="#get-started-write-good-code"><img src="chainlink.svg" width="10" height="10"></a></h4><!--SEC END --><p>Avoid complex code, which is more error-prone. If you write your code to
be simple and clear enough for the type-checker to verify, then it will
also be easier for programmers to understand. When you verify your code, a
side benefit is improving your code’s structure.</p><p>Your code should compile cleanly under the regular Java compiler. As a
specific example, your code should not use raw types like <span style="font-family:monospace">List</span>; use
parameterized types like <span style="font-family:monospace">List&lt;String&gt;</span> instead
(Section ‍<a href="#generics-raw-types">30.1.1</a>). If you suppress Java compiler
warnings, then the Checker Framework will issue more warnings, and its
messages will be more confusing. (Also, if you are not willing to write
code that type-checks in Java, then you might not be willing to use an even
more powerful type system.)</p><p>Do not write unnecessary annotations.
</p><ul class="itemize"><li class="li-itemize">
Do not annotate local variables unless necessary. The checker infers
annotations for local variables (see Section ‍<a href="#type-refinement">31.7</a>).
Usually, you only need to annotate fields and method signatures. You
should add annotations inside method bodies only if the checker is unable
to infer the correct annotation (usually on type arguments or array
element types, rather than
on top-level types).
</li><li class="li-itemize">Do not write annotations that are redundant with defaults. For example,
when checking nullness (Chapter ‍<a href="#nullness-checker">3</a>), the default
annotation is <span style="font-family:monospace">@NonNull</span>, in most locations other than some type bounds
(Section ‍<a href="#climb-to-top">31.5.3</a>). When you are starting out, it might seem
helpful to write redundant annotations as a reminder, but that’s like
when beginning programmers write a comment about every simple piece of
code:<pre class="verbatim">// The below code increments variable i by adding 1 to it.
i++;
</pre><p>As you become comfortable with pluggable type-checking, you will find
redundant annotations to be distracting clutter, so avoid putting them in
your code in the first place.</p></li><li class="li-itemize">Avoid writing <span style="font-family:monospace">@SuppressWarnings</span> annotations unless there is no
alternative. It is tempting to think that your code is right and the
checker’s warnings are false positives. Sometimes they are, but slow
down and convince yourself of that before you dismiss them.
Section ‍<a href="#handling-warnings">2.4.5</a> discusses what to do when a checker
issues a warning about your code.</li></ul>
<!--TOC subsection id="annotate-normal-behavior" Annotations indicate non-exceptional behavior-->
<h3 id="annotate-normal-behavior" class="subsection">2.4.3 Annotations indicate non-exceptional behavior <a href="#annotate-normal-behavior"><img src="chainlink.svg" width="10" height="10"></a></h3><!--SEC END --><p>You should use annotations to specify <em>normal</em> behavior. The
annotations indicate all the values that you <em>want</em> to flow to a
reference — not every value that might possibly flow there if your
program has a bug.</p>
<!--TOC subsubsection id="annotate-normal-behavior-always-crash" Methods that crash when passed certain values-->
<h4 id="annotate-normal-behavior-always-crash" class="subsubsection">Methods that crash when passed certain values <a href="#annotate-normal-behavior-always-crash"><img src="chainlink.svg" width="10" height="10"></a></h4><!--SEC END -->
<!--TOC paragraph id="annotate-normal-behavior-nullness-example" Nullness example-->
<h5 id="annotate-normal-behavior-nullness-example" class="paragraph">Nullness example <a href="#annotate-normal-behavior-nullness-example"><img src="chainlink.svg" width="10" height="10"></a></h5><!--SEC END --><p>
As an example, consider the Nullness Checker. Its goal is to guarantee that your
program does not crash due to a null value.</p><p>This method crashes if <span style="font-family:monospace">null</span> is passed to it:</p><pre class="verbatim">  /** @throws NullPointerException if arg is null */
  void m1(Object arg) {
    arg.toString();
    ...
  }
</pre><p>Therefore, the type of <span style="font-family:monospace">arg</span>
should be <span style="font-family:monospace">@NonNull Object</span> — you can write this as just <span style="font-family:monospace">Object</span>, because
<span style="font-family:monospace">@NonNull</span> is the default. The Nullness Checker (Chapter ‍<a href="#nullness-checker">3</a>)
prevents null pointer exceptions by warning you whenever a client passes a
value that might cause <span style="font-family:monospace">m1</span> to crash.</p><p>Here is another method:</p><pre class="verbatim">  /** @throws NullPointerException if arg is null */
  void m2(Object arg) {
    Objects.requireNonNull(arg);
    ...
  }
</pre><p>Method <span style="font-family:monospace">m2</span> behaves just like <span style="font-family:monospace">m1</span> in that it throws
<span style="font-family:monospace">NullPointerException</span> if a client passes <span style="font-family:monospace">null</span>. Therefore, their
specifications should be identical (the formal parameter type is annotated
with <span style="font-family:monospace">@NonNull</span>), so the
checker will issue the same warning if a client might pass <span style="font-family:monospace">null</span>.</p><p>The same argument applies to any method that is guaranteed to throw an exception
if it receives <span style="font-family:monospace">null</span> as an argument. Examples include:</p><pre class="verbatim">  com.google.common.base.Preconditions.checkNotNull(Object)
  java.lang.Double.valueOf(String)
  java.lang.Objects.requireNonNull(Object)
  java.lang.String.contains(CharSequence)
  org.junit.Assert.assertNotNull(Object)
  org.junit.jupiter.api.Assert.assertNotNull(Object)
</pre><p>Their formal parameter type is annotated as <span style="font-family:monospace">@NonNull</span>, because otherwise the
program might crash. Adding a call to a method like <span style="font-family:monospace">requireNonNull</span>
never prevents a crash: your code still crashes, but with a slightly
different stack trace. In order to prevent all exceptions in your program
caused by null pointers, you need to prevent those thrown by methods including
<span style="font-family:monospace">requireNonNull</span>.</p><p>(One might argue that the formal parameter should be annotated as
<a href="../api/org/checkerframework/checker/nullness/qual/Nullable.html"><span style="font-family:monospace">@Nullable</span></a> because passing <span style="font-family:monospace">null</span> has a
well-defined semantics (throw an exception) and such an execution may be
possible if your program has a bug. However, it is never the programmer’s
intent for <span style="font-family:monospace">null</span> to flow there. Preventing such bugs is the purpose of
the Nullness Checker.)</p><p>A method like <span style="font-family:monospace">requireNonNull</span> is useless for making your code correct,
but it does have a benefit: its stack trace may help developers to track
down the bug. (For users, the stack trace is scary, confusing, and usually
non-actionable.) But if you are using the Checker Framework, you can
prevent errors rather than needing extra help in debugging the ones that
occur at run time.</p>
<!--TOC paragraph id="annotate-normal-behavior-optional-example" Optional example-->
<h5 id="annotate-normal-behavior-optional-example" class="paragraph">Optional example <a href="#annotate-normal-behavior-optional-example"><img src="chainlink.svg" width="10" height="10"></a></h5><!--SEC END --><p>
Another example is the Optional Checker (Chapter ‍<a href="#optional-checker">5</a>)
and the <a href="https://docs.oracle.com/en/java/javase/17/docs/api/java.base/java/util/Optional.html#orElseThrow()"><span style="font-family:monospace">orElseThrow</span></a> method.
The goal of the Optional Checker is to ensure that the program does not
crash due to use of a non-present Optional value. Therefore, the receiver
of
<span style="font-family:monospace">orElseThrow</span> is annotated as
<a href="../api/org/checkerframework/checker/optional/qual/Present.html"><span style="font-family:monospace">@Present</span></a>,
and the Optional Checker issues a warning if the client calls
<span style="font-family:monospace">orElseThrow</span> on a <a href="../api/org/checkerframework/checker/optional/qual/MaybePresent.html"><span style="font-family:monospace">@MaybePresent</span></a> value.</p>
<!--TOC paragraph id="annotate-normal-behavior-skip-libraries" Permitting crashes in some called methods-->
<h5 id="annotate-normal-behavior-skip-libraries" class="paragraph">Permitting crashes in some called methods <a href="#annotate-normal-behavior-skip-libraries"><img src="chainlink.svg" width="10" height="10"></a></h5><!--SEC END --><p>
You can make a checker ignore crashes in library code, such as
<span style="font-family:monospace">assertNotNull()</span>, that occur as a result of misuse by your code.
This invalidates the checker’s guarantee that your program will not crash.
(Programmers and users typically care about all crashes, no matter which
method is at the top of the call stack when the exception is thrown.)
The checker will still warn you about crashes in your own code.</p><ul class="itemize"><li class="li-itemize">
The <span style="font-family:monospace">-AskipUses</span> command-line argument (Section ‍<a href="#askipuses">32.4</a>) skips
checking all method calls to one or more classes.
</li><li class="li-itemize">A stub file (Section ‍<a href="#stub">34.5</a>) can override the library’s annotations,
for one or more methods.<p>As a special case, if you want the Nullness Checker to prevent most null
pointer exceptions in your code, but to <em>permit</em> null pointer
exceptions at nullness assertion methods, you can pass
<span style="font-family:monospace">-Astubs=permit-nullness-assertion-exception.astub</span>.
</p></li><li class="li-itemize">Don’t type-check clients of the method. For example, JUnit’s
<span style="font-family:monospace">assertNotNull()</span> is typically called only in test code; its clients are
the tests. If you type-check only your main program, then the annotation
on <span style="font-family:monospace">assertNotNull()</span> is irrelevant.
</li></ul>
<!--TOC subsubsection id="annotate-normal-behavior-sometimes-crash" Methods that sometimes crash when passed certain values-->
<h4 id="annotate-normal-behavior-sometimes-crash" class="subsubsection">Methods that sometimes crash when passed certain values <a href="#annotate-normal-behavior-sometimes-crash"><img src="chainlink.svg" width="10" height="10"></a></h4><!--SEC END --><p>If a method can <em>possibly</em> throw an exception because its parameter
is <span style="font-family:monospace">null</span>, then that parameter’s type should be <span style="font-family:monospace">@NonNull</span>, which
guarantees that the type-checker will issue a warning for every client
use that has the potential to cause an exception. Don’t write
<span style="font-family:monospace">@Nullable</span> on the parameter just because there exist some executions that
don’t necessarily throw an exception.</p>
<!--TOC subsection id="annotations-are-a-contract" Subclasses must respect superclass annotations-->
<h3 id="annotations-are-a-contract" class="subsection">2.4.4 Subclasses must respect superclass annotations <a href="#annotations-are-a-contract"><img src="chainlink.svg" width="10" height="10"></a></h3><!--SEC END --><p>An annotation indicates a guarantee that a client can depend upon. A subclass
is not permitted to <em>weaken</em> the contract; for example,
if a method accepts <span style="font-family:monospace">null</span> as an argument, then every overriding
definition must also accept <span style="font-family:monospace">null</span>.
A subclass is permitted to <em>strengthen</em> the contract; for example,
if a method does <em>not</em> accept <span style="font-family:monospace">null</span> as an argument, then an
overriding definition is permitted to accept <span style="font-family:monospace">null</span>.</p><p>
As a bad example, consider an erroneous <span style="font-family:monospace">@Nullable</span> annotation in
<a href="https://github.com/google/guava/blob/master/guava/src/com/google/common/collect/Multiset.java#L129"><span style="font-family:monospace">com/google/common/collect/Multiset.java</span></a>:
</p><pre class="verbatim">101  public interface Multiset&lt;E&gt; extends Collection&lt;E&gt; {
...
122    /**
123     * Adds a number of occurrences of an element to this multiset.
...
129     * @param element the element to add occurrences of; may be {@code null} only
130     *     if explicitly allowed by the implementation
...
137     * @throws NullPointerException if {@code element} is null and this
138     *     implementation does not permit null elements. Note that if {@code
139     *     occurrences} is zero, the implementation may opt to return normally.
140     */
141    int add(@Nullable E element, int occurrences);
</pre><p>There exist implementations of Multiset that permit <span style="font-family:monospace">null</span> elements,
and implementations of Multiset that do not permit <span style="font-family:monospace">null</span> elements. A
client with a variable <span style="font-family:monospace">Multiset ms</span> does not know which variety of
Multiset <span style="font-family:monospace">ms</span> refers to. However, the <span style="font-family:monospace">@Nullable</span> annotation
promises that <span style="font-family:monospace">ms.add(null, 1)</span> is permissible. (Recall from
Section ‍<a href="#annotate-normal-behavior">2.4.3</a> that annotations should indicate
normal behavior.)</p><p>If parameter <span style="font-family:monospace">element</span> on line 141 were to be annotated, the correct
annotation would be <span style="font-family:monospace">@NonNull</span>. Suppose a client has a reference to
same Multiset <span style="font-family:monospace">ms</span>. The only way the client can be sure not to throw an exception is to pass
only non-<span style="font-family:monospace">null</span> elements to <span style="font-family:monospace">ms.add()</span>. A particular class
that implements Multiset could declare <span style="font-family:monospace">add</span> to take a
<span style="font-family:monospace">@Nullable</span> parameter. That still satisfies the original contract.
It strengthens the contract by promising even more: a client with such a
reference can pass any non-<span style="font-family:monospace">null</span> value to <span style="font-family:monospace">add()</span>, and may also
pass <span style="font-family:monospace">null</span>.</p><p><span style="font-weight:bold">However</span>, the best annotation for line 141 is no annotation at all.
The reason is that each implementation of the Multiset interface should
specify its own nullness properties when it specifies the type parameter
for Multiset. For example, two clients could be written as</p><pre class="verbatim">  class MyNullPermittingMultiset implements Multiset&lt;@Nullable Object&gt; { ... }
  class MyNullProhibitingMultiset implements Multiset&lt;@NonNull Object&gt; { ... }
</pre><p>or, more generally, as</p><pre class="verbatim">  class MyNullPermittingMultiset&lt;E extends @Nullable Object&gt; implements Multiset&lt;E&gt; { ... }
  class MyNullProhibitingMultiset&lt;E extends @NonNull Object&gt; implements Multiset&lt;E&gt; { ... }
</pre><p>Then, the specification is more informative, and the Checker Framework is
able to do more precise checking, than if line 141 has an annotation.</p><p>It is a pleasant feature of the Checker Framework that in many cases, no
annotations at all are needed on type parameters such as <span style="font-family:monospace">E</span> in <span style="font-family:monospace">MultiSet</span>.</p>
<!--TOC subsection id="handling-warnings" What to do if a checker issues a warning about your code-->
<h3 id="handling-warnings" class="subsection">2.4.5 What to do if a checker issues a warning about your code <a href="#handling-warnings"><img src="chainlink.svg" width="10" height="10"></a></h3><!--SEC END --><p>When you run a type-checker on your code, it is likely to issue warnings or
errors. Don’t panic!
If you have trouble understanding a Checker Framework warning message, you
can search for its text in this manual.
There are three general causes for the warnings:</p><dl class="description"><dt class="dt-description">
<span style="font-weight:bold">You found a bug</span></dt><dd class="dd-description">
There is a bug in your code, such as a possible null dereference. Fix
your code to prevent that crash.</dd><dt class="dt-description"><span style="font-weight:bold">Wrong annotations</span></dt><dd class="dd-description">
The annotations are too strong (they are incorrect) or too weak (they
are imprecise). Improve the
annotations, usually by writing more annotations in order to better
express the specification.
Only write annotations that accurately describe the intended behavior of
the software — don’t write inaccurate annotations just for the purpose
of eliminating type-checker warnings.<p>Usually you need to improve the annotations in your source code.
Sometimes you need to improve annotations in a library that your program
uses (see Chapter ‍<a href="#annotating-libraries">34</a>).</p></dd><dt class="dt-description"><span style="font-weight:bold">Type-checker weakness</span></dt><dd class="dd-description">
There is a weakness in the type-checker. Your code is safe — it never
suffers the error at run time — but the checker cannot prove this fact.
(Recall that The checker works modularly: when type-checking a
method <span style="font-family:monospace">m</span>, it relies on the types and signatures of variables and
methods used by <span style="font-family:monospace">m</span>, but not the initialization expressions or the
method bodies.)<p>If possible, rewrite your code to be simpler for the checker to analyze;
this is likely to make it easier for people to understand, too.
If that is not possible, suppress the warning (see
Chapter ‍<a href="#suppressing-warnings">32</a>); be sure to include a code
comment explaining how you know the code is correct even though the
type-checker cannot deduce that fact.</p><p>Do not add an <span style="font-family:monospace">if</span> test that can never fail, just to suppress a
warning. Adding a gratuitous <span style="font-family:monospace">if</span> clutters the code and confuses
readers. A reader should assume that every <span style="font-family:monospace">if</span> condition can evaluate to true
or false. There is one exception to this rule: an <span style="font-family:monospace">if</span> test may have a
condition that you think will never evaluate to true, if its body just throws a
descriptive error message.
</p></dd></dl><p>For each warning issued by the checker, you need to determine which of the
above categories it falls into. Here is an effective methodology to do so.
It relies mostly on manual code examination, but you may also find it
useful to write test cases for your code or do other kinds of analysis, to
verify your reasoning.
(Also see
Section ‍<a href="#common-problems-typechecking">39.1.4</a> and
Chapter ‍<a href="#troubleshooting">39</a>, Troubleshooting.
In particular, Section ‍<a href="#common-problems-typechecking">39.1.4</a> explains this
same methodology in different words.)</p>
<!--TOC paragraph id="handling-warnings-step1" Step 1: Explain correctness: write a proof-->
<h5 id="handling-warnings-step1" class="paragraph">Step 1: Explain correctness: write a proof <a href="#handling-warnings-step1"><img src="chainlink.svg" width="10" height="10"></a></h5><!--SEC END --><p>
Write an explanation of why your code is correct and it
never suffers the error at run time. In other words, this is an informal proof
that the type-checker’s warning is incorrect. Write it in natural language,
such as English.</p><p>Don’t skip any steps in your proof.
(For example, don’t write an unsubstantiated claim such as “<span style="font-family:monospace">x</span> is
non-null here”; instead, give a justification.)
Don’t let your reasoning rely on
facts that you do not write down explicitly. For example, remember that
calling a method might change the values of object fields; your proof
might need to state that certain methods have no side effects.</p><p>If you cannot write a proof, then there is a bug
in your code (you should fix the bug) or your code is too complex for you
to understand (you should improve its documentation and/or design).</p>
<!--TOC paragraph id="handling-warnings-step2" Step 2: Translate the proof into annotations.-->
<h5 id="handling-warnings-step2" class="paragraph">Step 2: Translate the proof into annotations. <a href="#handling-warnings-step2"><img src="chainlink.svg" width="10" height="10"></a></h5><!--SEC END --><p>
Here are some examples of the translation.</p><ul class="itemize"><li class="li-itemize">
If your proof includes “variable <span style="font-family:monospace">x</span> is never <span style="font-family:monospace">null</span>
at run time”, then annotate <span style="font-family:monospace">x</span>’s type with
<a href="../api/org/checkerframework/checker/nullness/qual/NonNull.html"><span style="font-family:monospace">@NonNull</span></a>.
</li><li class="li-itemize">If your proof
includes “method <span style="font-family:monospace">foo</span> always returns a legal regular expression”,
then annotate <span style="font-family:monospace">foo</span>’s return type with
<a href="../api/org/checkerframework/checker/regex/qual/Regex.html"><span style="font-family:monospace">@Regex</span></a>.
</li><li class="li-itemize">If your proof includes “if method <span style="font-family:monospace">join</span>’s first argument is
non-null, then <span style="font-family:monospace">join</span> returns a non-null result”, then annotate
<span style="font-family:monospace">join</span>’s first parameter and return type with
<a href="../api/org/checkerframework/checker/nullness/qual/PolyNull.html"><span style="font-family:monospace">@PolyNull</span></a>.
</li><li class="li-itemize">If your proof includes “method <span style="font-family:monospace">processOptions</span> has already been called and it
set field <span style="font-family:monospace">tz1</span>”, then annotate <span style="font-family:monospace">processOptions</span>’s declaration with
<a href="../api/org/checkerframework/checker/nullness/qual/EnsuresNonNull.html"><span style="font-family:monospace">@EnsuresNonNull</span></a><span style="font-family:monospace">("tz1")</span>.
</li><li class="li-itemize">If your proof includes “method <span style="font-family:monospace">isEmpty</span> returned false, so its
argument must have been non-null”, then annotate <span style="font-family:monospace">isEmpty</span>’s
declaration with
<a href="../api/org/checkerframework/checker/nullness/qual/EnsuresNonNullIf.html"><span style="font-family:monospace">@EnsuresNonNullIf</span></a><span style="font-family:monospace">(expression="#1",result=false)</span>.
</li><li class="li-itemize">If your proof includes “method <span style="font-family:monospace">m</span> has no side effects”,
then annotate <span style="font-family:monospace">m</span>’s declaration with
<a href="../api/org/checkerframework/dataflow/qual/SideEffectFree.html"><span style="font-family:monospace">@SideEffectFree</span></a>.
</li><li class="li-itemize">If your proof includes “each call to method <span style="font-family:monospace">m</span> returns the same value”,
then annotate <span style="font-family:monospace">m</span>’s declaration with
<a href="../api/org/checkerframework/dataflow/qual/Deterministic.html"><span style="font-family:monospace">@Deterministic</span></a>.
</li></ul><p>All of these are examples of correcting weaknesses in the annotations you wrote.
The Checker Framework provides many other powerful annotations; you may
be surprised how many proofs you can express in annotations.
If you need to annotate a method that is defined in a
library that your code uses, see Chapter ‍<a href="#annotating-libraries">34</a>.</p><p>Don’t omit any parts of your proof. When the Checker Framework analyzes
a method, it examines only the signature/specification (not the implementation)
of other methods.</p><p>If there are complex facts in your proof that cannot be expressed as
annotations, then that is a weakness in the type-checker. For example,
the Nullness Checker cannot express “in list <span style="font-family:monospace">lst</span>, elements stored at
even indices are always non-<span style="font-family:monospace">null</span>, but elements stored at odd elements
might be <span style="font-family:monospace">null</span>.” In this case, you have two choices.
First, you can suppress the warning
(Chapter ‍<a href="#suppressing-warnings">32</a>); be sure to write a comment
explaining your reasoning for suppressing the warning. You may wish to
submit a feature request (Section ‍<a href="#reporting-bugs">39.2</a>) asking for
annotations that handle your use case.
Second, you can rewrite the code to make the proof simpler;
in the above example, it might be better to use a list of pairs
rather than a heterogeneous list.</p>
<!--TOC paragraph id="handling-warnings-step3" Step 3: Re-run the checker-->
<h5 id="handling-warnings-step3" class="paragraph">Step 3: Re-run the checker <a href="#handling-warnings-step3"><img src="chainlink.svg" width="10" height="10"></a></h5><!--SEC END --><p>
At this point, all the steps in your proof have been formalized as
annotations. Re-run the checker and repeat the process for any new or
remaining warnings.</p><p>If every step of your proof can be expressed in annotations, but the
checker cannot make one of the deductions (it cannot follow one of the
steps), then that is a weakness in the type-checker. First, double-check
your reasoning. Then, suppress the warning, along with a comment
explaining your reasoning (Chapter ‍<a href="#suppressing-warnings">32</a>).
The comment is an excerpt from your informal proof, and the proof guides
you to the best place to suppress the warning.
Please submit a bug report so that the checker can be improved
in the future (Section ‍<a href="#reporting-bugs">39.2</a>).</p>
<!--TOC subsection id="unannotated-code" Calls to unannotated code (legacy libraries)-->
<h3 id="unannotated-code" class="subsection">2.4.6 Calls to unannotated code (legacy libraries) <a href="#unannotated-code"><img src="chainlink.svg" width="10" height="10"></a></h3><!--SEC END --><p>Sometimes, you wish to type-check only part of your program.
You might focus on the most mission-critical or error-prone part of your
code. When you start to use a checker, you may not wish to annotate
your entire program right away.
You may not have
enough knowledge to annotate poorly-documented libraries that your program uses.
Or, the code you are annotating may call into unannotated libraries.</p><p>If annotated code uses unannotated code, then the checker may issue
warnings. For example, the Nullness Checker (Chapter ‍<a href="#nullness-checker">3</a>) will
warn whenever an unannotated method result is used in a non-null context:</p><pre class="verbatim">  @NonNull myvar = unannotated_method();   // WARNING: unannotated_method may return null
</pre><p>If the call <em>can</em> return null, you should fix the bug in your program by
removing the <a href="../api/org/checkerframework/checker/nullness/qual/NonNull.html"><span style="font-family:monospace">@NonNull</span></a> annotation in your own program.</p><p>If the call <em>never</em> returns null, you have two choices: annotate the library
or suppress warnings.
</p><ol class="enumerate" type=1><li class="li-enumerate">
To annotate the library:
<ul class="itemize"><li class="li-itemize">
If the unannotated code is in your program, you can write annotations
but not type-check them yet. Two ways to prevent the type-checking are
via a <span style="font-family:monospace">@SuppressWarnings</span> annotation
(Section ‍<a href="#suppresswarnings-annotation">32.1</a>) or by not running the
checker on that file, for example via the <span style="font-family:monospace">-AskipDefs</span> command-line
option (Section ‍<a href="#askipdefs">32.5</a>).
</li><li class="li-itemize">To annotate a library whose source code you do not have or cannot
change, see Chapter ‍<a href="#annotating-libraries">34</a>.
</li></ul>
</li><li class="li-enumerate">To suppress all warnings related to uses of
<span style="font-family:monospace">unannotated_method</span>, use the <span style="font-family:monospace">-AskipUses</span> command-line option
(Section ‍<a href="#askipuses">32.4</a>). Beware: a carelessly-written regular
expression may suppress more warnings than you intend.
</li></ol><hr>
<!--TOC chapter id="nullness-checker" Nullness Checker-->
<h1 id="nullness-checker" class="chapter">Chapter ‍3 Nullness Checker <a href="#nullness-checker"><img src="chainlink.svg" width="10" height="10"></a></h1><!--SEC END --><p>If the Nullness Checker issues no warnings for a given program, then
running that program will never throw a null pointer exception. In
other words, the Nullness Checker prevents all <span style="font-family:monospace">NullPointerException</span>s.
See Section ‍<a href="#nullness-checks">3.1</a> for more details about
the guarantee and what is checked.</p><p>The most important annotations supported by the Nullness Checker are
<a href="../api/org/checkerframework/checker/nullness/qual/NonNull.html"><span style="font-family:monospace">@NonNull</span></a> and
<a href="../api/org/checkerframework/checker/nullness/qual/Nullable.html"><span style="font-family:monospace">@Nullable</span></a>.
<a href="../api/org/checkerframework/checker/nullness/qual/NonNull.html"><span style="font-family:monospace">@NonNull</span></a> is rarely written, because it is
the default. All of the annotations are explained in
Section ‍<a href="#nullness-annotations">3.2</a>.</p><p>To run the Nullness Checker, supply the
<span style="font-family:monospace">-processor org.checkerframework.checker.nullness.NullnessChecker</span>
command-line option to javac. For
examples, see Section ‍<a href="#nullness-example">3.5</a>.</p><p>The NullnessChecker is actually an ensemble of three pluggable
type-checkers that work together: the Nullness Checker proper (which is the
main focus of this chapter), the Initialization Checker
(Section ‍<a href="#initialization-checker">3.8</a>), and the Map Key Checker
(Chapter ‍<a href="#map-key-checker">4</a>).
Their type hierarchies are completely independent, but they work together
to provide precise nullness checking.</p>
<!--TOC section id="nullness-checks" What the Nullness Checker guarantees-->
<h2 id="nullness-checks" class="section">3.1 What the Nullness Checker guarantees <a href="#nullness-checks"><img src="chainlink.svg" width="10" height="10"></a></h2><!--SEC END --><p>If the Nullness Checker type-checks your program without errors, then your
program will not crash with a <span style="font-family:monospace">NullPointerException</span> that is caused by
misuse of <span style="font-family:monospace">null</span> in checked code.
Section ‍<a href="#checker-guarantees">2.3</a> notes some limitations to guarantees made
by the Checker Framework.</p><p>The checker issues a warning in these cases:</p><ol class="enumerate" type=1><li class="li-enumerate">When an expression of non-<a href="../api/org/checkerframework/checker/nullness/qual/NonNull.html"><span style="font-family:monospace">@NonNull</span></a> type
is dereferenced, because it might cause a null pointer exception.
Dereferences occur not only when a field is accessed, but when an array
is indexed, an exception is thrown, a lock is taken in a synchronized
block, and more. For a complete description of all checks performed by
the Nullness Checker, see the Javadoc for
<a href="../api/org/checkerframework/checker/nullness/NullnessVisitor.html"><span style="font-family:monospace">NullnessVisitor</span></a>.</li><li class="li-enumerate">When an expression of <a href="../api/org/checkerframework/checker/nullness/qual/NonNull.html"><span style="font-family:monospace">@NonNull</span></a> type
might become null, because it
is a misuse of the type: the null value could flow to a dereference that
the checker does not warn about.<p>As a special case of an of <a href="../api/org/checkerframework/checker/nullness/qual/NonNull.html"><span style="font-family:monospace">@NonNull</span></a>
type becoming null, the checker also warns whenever a field of
<a href="../api/org/checkerframework/checker/nullness/qual/NonNull.html"><span style="font-family:monospace">@NonNull</span></a> type is not initialized in a
constructor.</p></li></ol><p>This example illustrates the programming errors that the checker detects:</p><pre class="verbatim">  @Nullable Object   obj;  // might be null
  @NonNull  Object nnobj;  // never null
  ...
  obj.toString()         // checker warning:  dereference might cause null pointer exception
  nnobj = obj;           // checker warning:  nnobj may become null
  if (nnobj == null)     // checker warning:  redundant test
</pre><p>Parameter passing and return values are checked analogously to assignments.</p><p>The Nullness Checker also checks the correctness, and correct use, of
initialization (see
Section ‍<a href="#initialization-checker">3.8</a>) and of map key annotations (see
Chapter ‍<a href="#map-key-checker">4</a>).</p><p>The checker performs additional checks if certain <span style="font-family:monospace">-Alint</span>
command-line options are provided. (See
Section ‍<a href="#alint">32.6</a> for more details about the <span style="font-family:monospace">-Alint</span>
command-line option.)</p>
<!--TOC subsection id="nullness-lint" Nullness Checker optional warnings-->
<h3 id="nullness-lint" class="subsection">3.1.1 Nullness Checker optional warnings <a href="#nullness-lint"><img src="chainlink.svg" width="10" height="10"></a></h3><!--SEC END --><ol class="enumerate" type=1><li class="li-enumerate">
Options that control soundness:<ul class="itemize"><li class="li-itemize">
<a id="nullness-lint-soundArrayCreationNullness"></a><a id="nullness-lint-nonnullarraycomponents"></a>If you supply the <span style="font-family:monospace">-Alint=soundArrayCreationNullness</span> command-line
option, then the checker warns if it encounters an array creation
with a non-null component type.
See Section ‍<a href="#nullness-arrays">3.3.4</a> for a discussion.
</li><li class="li-itemize"><a id="collection-object-parameters-may-be-null"></a>
If you supply the
<span style="font-family:monospace">-Astubs=collection-object-parameters-may-be-null.astub</span>
command-line option, then in JDK collection classes, the checker
unsoundly permits null as an argument for any key or value formal
parameter whose type is <span style="font-family:monospace">Object</span> (instead of the element type).
See Section ‍<a href="#nullness-collection-arguments">3.4.2</a>.</li><li class="li-itemize"><a id="nullness-lint-trustarraylenzero"></a>If you supply the <span style="font-family:monospace">-Alint=trustArrayLenZero</span> command-line option, then
the checker will trust <a href="../api/org/checkerframework/common/value/qual/ArrayLen.html"><span style="font-family:monospace">@ArrayLen</span></a><span style="font-family:monospace">(0)</span>
annotations. See Section ‍<a href="#nullness-collection-toarray">3.3.5</a> for a discussion.</li><li class="li-itemize"><a id="nullness-assumeKeyFor"></a>If you supply the <span style="font-family:monospace">-AassumeKeyFor</span> command-line option, then the
checker will unsoundly assume that the argument to <span style="font-family:monospace">Map.get</span> is a key
for the receiver map. It will not do any checking of
<a href="../api/org/checkerframework/checker/nullness/qual/KeyFor.html"><span style="font-family:monospace">@KeyFor</span></a> and related qualifiers.</li><li class="li-itemize"><a id="nullness-conservativeArgumentNullnessAfterInvocation"></a><a id="nullness-invocationPreservesArgumentNullness"></a>If you supply the <span style="font-family:monospace">-AconservativeArgumentNullnessAfterInvocation</span> command-line option, the soundness of
the Nullness Checker is improved. In previous versions and without supplying the new flag, the receiver and
arguments that are passed to non-null parameters in a method call or constructor invocation are assumed to
be non-null after the invocation.
This assumption is unsound in general, but holds for most code.
Use this flag to soundly handle the nullness of the receiver and arguments in an invocation.</li><li class="li-itemize"><a id="nullness-AcheckEnclosingExpr"></a>If you supply the <span style="font-family:monospace">-AcheckEnclosingExpr</span> command-line option, the soundness of
the Nullness Initialization Checker is improved. In previous versions and without supplying the new flag,
the uninitialized enclosing expression of an inner class instantiation cannot be detected, which is unsound.
However, this option is by default disabled since it is strict and will result in many false positives.
Use this flag to soundly handle the nullness of the enclosing expression for the inner class instantiation.
</li></ul></li><li class="li-enumerate">Options that warn about poor code style:<ul class="itemize"><li class="li-itemize">
<a id="nullness-lint-nulltest"></a>If you supply the <span style="font-family:monospace">-Alint=redundantNullComparison</span> command-line option, then the
checker warns when a null check is performed against a value that is
guaranteed to be non-null, as in <span style="font-family:monospace">("m" == null)</span>. Such a check is
unnecessary and might indicate a programmer error or misunderstanding.
The lint option is disabled by default because sometimes such checks are
part of ordinary defensive programming.
</li></ul></li><li class="li-enumerate">Options that enable checking modes:<ul class="itemize"><li class="li-itemize">
If you supply the <span style="font-family:monospace">-Alint=permitClearProperty</span> command-line option,
then the checker permits calls to
<a href="https://docs.oracle.com/en/java/javase/17/docs/api/java.base/java/lang/System.html#getProperties()"><span style="font-family:monospace">System.setProperties()</span></a>
and calls to
<a href="https://docs.oracle.com/en/java/javase/17/docs/api/java.base/java/lang/System.html#clearProperty(java.lang.String)"><span style="font-family:monospace">System.clearProperty</span></a>
that might clear one of the built-in properties.<p>By default, the checker forbids calls to those methods, and also
special-cases type-checking of calls to
<a href="https://docs.oracle.com/en/java/javase/17/docs/api/java.base/java/lang/System.html#getProperty(java.lang.String,java.lang.String)"><span style="font-family:monospace">System.getProperty()</span></a>
and
<a href="https://docs.oracle.com/en/java/javase/17/docs/api/java.base/java/lang/System.html#setProperties(java.util.Properties)"><span style="font-family:monospace">System.setProperties()</span></a>.
A call to one of these methods
can return null in general, but by default the Nullness Checker treats it
as returning non-null if the argument is one of the literal strings
listed in the documentation of
<a href="https://docs.oracle.com/en/java/javase/17/docs/api/java.base/java/lang/System.html#getProperties()"><span style="font-family:monospace">System.getProperties()</span></a>.
To make this behavior sound, the Nullness Checker forbids calls that
might clear any built-in property, as described above.</p></li><li class="li-itemize"><a id="nullness-jspecifyNullMarkedAlias"></a>If you supply the <span style="font-family:monospace">-AjspecifyNullMarkedAlias=false</span> command-line option, then the
checker will not treat <span style="font-family:monospace">org.jspecify.nullness.NullMarked</span> as a defaulting
annotation. By default the <span style="font-family:monospace">NullMarked</span> annotation is recognized.
</li></ul></li></ol>
<!--TOC section id="nullness-annotations" Nullness annotations-->
<h2 id="nullness-annotations" class="section">3.2 Nullness annotations <a href="#nullness-annotations"><img src="chainlink.svg" width="10" height="10"></a></h2><!--SEC END --><p>The Nullness Checker uses three separate type hierarchies: one for nullness,
one for initialization (Section ‍<a href="#initialization-checker">3.8</a>),
and one for map keys (Chapter ‍<a href="#map-key-checker">4</a>)
The Nullness Checker has four varieties of annotations: nullness
type qualifiers, nullness method annotations, initialization type qualifiers, and
map key type
qualifiers.</p>
<!--TOC subsection id="nullness-qualifiers" Nullness qualifiers-->
<h3 id="nullness-qualifiers" class="subsection">3.2.1 Nullness qualifiers <a href="#nullness-qualifiers"><img src="chainlink.svg" width="10" height="10"></a></h3><!--SEC END --><p>The nullness hierarchy contains these qualifiers:</p><dl class="description"><dt class="dt-description"><a href="../api/org/checkerframework/checker/nullness/qual/Nullable.html"><span style="font-weight:bold"><span style="font-family:monospace">@Nullable</span></span></a></dt><dd class="dd-description">
indicates a type that includes the null value. For example, the Java
type <span style="font-family:monospace">Boolean</span>
is nullable: a variable of type <span style="font-family:monospace">Boolean</span> always has one of the
values <span style="font-family:monospace">TRUE</span>, <span style="font-family:monospace">FALSE</span>, or <span style="font-family:monospace">null</span>.
(Since <span style="font-family:monospace">@NonNull</span> is the default type annotation, you would actually
write this type as <span style="font-family:monospace">@Nullable Boolean</span>.)</dd><dt class="dt-description"><a href="../api/org/checkerframework/checker/nullness/qual/NonNull.html"><span style="font-weight:bold"><span style="font-family:monospace">@NonNull</span></span></a></dt><dd class="dd-description">
indicates a type that does not include the null value. The type
<span style="font-family:monospace">boolean</span> is non-null; a variable of type <span style="font-family:monospace">boolean</span> always has
one of the values <span style="font-family:monospace">true</span> or <span style="font-family:monospace">false</span>. The type <span style="font-family:monospace">@NonNull
Boolean</span> is also non-null: a variable of type <span style="font-family:monospace">@NonNull Boolean</span>
always has one of the values <span style="font-family:monospace">TRUE</span> or <span style="font-family:monospace">FALSE</span> — never
<span style="font-family:monospace">null</span>. Dereferencing an expression of non-null type can never cause
a null pointer exception.<p>The <span style="font-family:monospace">@NonNull</span> annotation is rarely written in a program, because it is
the default (see Section ‍<a href="#null-defaults">3.3.2</a>).</p></dd><dt class="dt-description"><a href="../api/org/checkerframework/checker/nullness/qual/PolyNull.html"><span style="font-weight:bold"><span style="font-family:monospace">@PolyNull</span></span></a></dt><dd class="dd-description">
indicates qualifier polymorphism.
For a description of qualifier polymorphism, see
Section ‍<a href="#method-qualifier-polymorphism">30.2</a>.</dd><dt class="dt-description"><a href="../api/org/checkerframework/checker/nullness/qual/MonotonicNonNull.html"><span style="font-weight:bold"><span style="font-family:monospace">@MonotonicNonNull</span></span></a></dt><dd class="dd-description">
indicates a reference that may be <span style="font-family:monospace">null</span>, but if it ever becomes
non-<span style="font-family:monospace">null</span>, then it never becomes <span style="font-family:monospace">null</span> again. This is
appropriate for lazily-initialized fields, for field initialization that
occurs in a lifecycle method other than the constructor (e.g., an
override of <span style="font-family:monospace">android.app.Activity.onCreate</span>), and other uses.
<span style="font-family:monospace">@MonotonicNonNull</span> is typically written on field types, but not elsewhere.<p>
The benefit of <span style="font-family:monospace">@MonotonicNonNull</span> over <span style="font-family:monospace">@Nullable</span> is that after a
check of a <span style="font-family:monospace">@MonotonicNonNull</span> field, all subsequent accesses
<em>within that method</em> can be assumed to be <span style="font-family:monospace">@NonNull</span>, even after
arbitrary external method calls that have access to the given field.
By contrast, for a <span style="font-family:monospace">@Nullable</span> field, the Nullness Checker assumes that
most method calls might set it to <span style="font-family:monospace">null</span>. (Exceptions are calls to
methods that are <a href="../api/org/checkerframework/dataflow/qual/SideEffectFree.html"><span style="font-family:monospace">@SideEffectFree</span></a> or that
have an <a href="../api/org/checkerframework/checker/nullness/qual/EnsuresNonNull.html"><span style="font-family:monospace">@EnsuresNonNull</span></a> or
<a href="../api/org/checkerframework/checker/nullness/qual/EnsuresNonNullIf.html"><span style="font-family:monospace">@EnsuresNonNullIf</span></a> annotation.)
</p><p>A <span style="font-family:monospace">@MonotonicNonNull</span> field may be initialized to null, but the
field may not be assigned to null anywhere else in the program. If you
supply the <span style="font-family:monospace">noInitForMonotonicNonNull</span> lint flag (for example, supply
<span style="font-family:monospace">-Alint=noInitForMonotonicNonNull</span> on the command line), then
<span style="font-family:monospace">@MonotonicNonNull</span> fields are not allowed to have initializers at their
declarations.</p><p>Use of <span style="font-family:monospace">@MonotonicNonNull</span> on a <em>static</em> field is a code smell: it may
indicate poor design. You should consider whether it is possible to make
the field a member field that is set in the constructor.</p><p>In the type system, <span style="font-family:monospace">@MonotonicNonNull</span> is a supertype of <span style="font-family:monospace">@NonNull</span>
and a subtype of <span style="font-family:monospace">@Nullable</span>.</p></dd></dl><p>Figure ‍<a href="#fig-nullness-hierarchy">3.1</a> shows part of the type hierarchy for the
Nullness type system.
(The annotations exist only at compile time; at run time, Java has no
multiple inheritance.)</p><blockquote class="figure"><div class="center"><hr class="floatrule"></div>
<div class="center">
<img src="nullness.svg">
</div>
<div class="caption"><table style="border-spacing:6px;border-collapse:separate;" class="cellpading0"><tr><td style="vertical-align:top;text-align:left;" >Figure 3.1: Partial type hierarchy for the Nullness type system.
Java’s <span style="font-family:monospace">Object</span> is expressed as <span style="font-family:monospace">@Nullable Object</span>. Programmers can omit
most type qualifiers, because the default annotation
(Section ‍<a href="#null-defaults">3.3.2</a>) is usually correct.
The Nullness Checker verifies three type hierarchies: this one for
nullness, one for initialization (Section ‍<a href="#initialization-checker">3.8</a>),
and one for map keys (Chapter ‍<a href="#map-key-checker">4</a>).</td></tr>
</table></div>
<a id="fig-nullness-hierarchy"></a>
<div class="center"><hr class="floatrule"></div></blockquote>
<!--TOC subsection id="nullness-method-annotations" Nullness method annotations-->
<h3 id="nullness-method-annotations" class="subsection">3.2.2 Nullness method annotations <a href="#nullness-method-annotations"><img src="chainlink.svg" width="10" height="10"></a></h3><!--SEC END --><p>The Nullness Checker supports several annotations that specify method
behavior. These are declaration annotations, not type annotations: they
apply to the method itself rather than to some particular type.</p><dl class="description"><dt class="dt-description"><a href="../api/org/checkerframework/checker/nullness/qual/RequiresNonNull.html"><span style="font-weight:bold"><span style="font-family:monospace">@RequiresNonNull</span></span></a></dt><dd class="dd-description">
indicates a method precondition: The annotated method expects the
specified variables to be non-null when the
method is invoked. Don’t use this for formal parameters (just annotate
their type as <span style="font-family:monospace">@NonNull</span>). <span style="font-family:monospace">@RequiresNonNull</span> is appropriate for
a field that is <span style="font-family:monospace">@Nullable</span> in general, but some method requires the
field to be non-null.</dd><dt class="dt-description"><a href="../api/org/checkerframework/checker/nullness/qual/EnsuresNonNull.html"><span style="font-weight:bold"><span style="font-family:monospace">@EnsuresNonNull</span></span></a></dt><dd class="dd-description">
</dd><dt class="dt-description"><a href="../api/org/checkerframework/checker/nullness/qual/EnsuresNonNullIf.html"><span style="font-weight:bold"><span style="font-family:monospace">@EnsuresNonNullIf</span></span></a></dt><dd class="dd-description">
indicates a method postcondition. With <span style="font-family:monospace">@EnsuresNonNull</span>, the given
expressions are non-null after the method returns; this is useful for a
method that initializes a field, for example. With
<span style="font-family:monospace">@EnsuresNonNullIf</span>, if the annotated
method returns the given boolean value (true or false), then the given
expressions are non-null. See Section ‍<a href="#conditional-nullness">3.3.3</a> and the
Javadoc for examples of their use.</dd></dl>
<!--TOC subsection id="initialization-qualifiers-overview" Initialization qualifiers-->
<h3 id="initialization-qualifiers-overview" class="subsection">3.2.3 Initialization qualifiers <a href="#initialization-qualifiers-overview"><img src="chainlink.svg" width="10" height="10"></a></h3><!--SEC END --><p>The Nullness Checker invokes an Initialization Checker, whose annotations indicate whether
an object is fully initialized — that is, whether all of its fields have
been assigned.</p><dl class="description"><dt class="dt-description">
<a href="../api/org/checkerframework/checker/initialization/qual/Initialized.html"><span style="font-weight:bold"><span style="font-family:monospace">@Initialized</span></span></a></dt><dd class="dd-description">
</dd><dt class="dt-description"><a href="../api/org/checkerframework/checker/initialization/qual/UnknownInitialization.html"><span style="font-weight:bold"><span style="font-family:monospace">@UnknownInitialization</span></span></a></dt><dd class="dd-description">
</dd><dt class="dt-description"><a href="../api/org/checkerframework/checker/initialization/qual/UnderInitialization.html"><span style="font-weight:bold"><span style="font-family:monospace">@UnderInitialization</span></span></a></dt><dd class="dd-description">
</dd></dl><p>Use of these annotations can help you to type-check more
code. Figure ‍<a href="#fig-initialization-hierarchy">3.5</a> shows its type hierarchy. For
details, see Section ‍<a href="#initialization-checker">3.8</a>.</p>
<!--TOC subsection id="map-key-qualifiers" Map key qualifiers-->
<h3 id="map-key-qualifiers" class="subsection">3.2.4 Map key qualifiers <a href="#map-key-qualifiers"><img src="chainlink.svg" width="10" height="10"></a></h3><!--SEC END --><dl class="description"><dt class="dt-description">
<a href="../api/org/checkerframework/checker/nullness/qual/KeyFor.html"><span style="font-weight:bold"><span style="font-family:monospace">@KeyFor</span></span></a></dt><dd class="dd-description">
</dd></dl><p>
indicates that a value is a key for a given map — that is, indicates
whether <span style="font-family:monospace">map.containsKey(value)</span> would evaluate to <span style="font-family:monospace">true</span>.</p><p>This annotation is checked by a Map Key Checker
(Chapter ‍<a href="#map-key-checker">4</a>) that the Nullness Checker
invokes. The <a href="../api/org/checkerframework/checker/nullness/qual/KeyFor.html"><span style="font-family:monospace">@KeyFor</span></a> annotation enables
the Nullness Checker to treat calls to
<a href="https://docs.oracle.com/en/java/javase/17/docs/api/java.base/java/util/Map.html#get(java.lang.Object)"><span style="font-family:monospace">Map.get</span></a>
precisely rather than assuming it may always return null. In particular,
a call <span style="font-family:monospace">mymap.get(mykey)</span> returns a non-<span style="font-family:monospace">null</span> value if two conditions
are satisfied:
</p><ol class="enumerate" type=1><li class="li-enumerate">
<span style="font-family:monospace">mymap</span>’s values are all non-<span style="font-family:monospace">null</span>; that is, <span style="font-family:monospace">mymap</span> was
declared as <span style="font-family:monospace">Map&lt;</span><span style="font-family:monospace"><em>KeyType</em></span><span style="font-family:monospace">, @NonNull </span><span style="font-family:monospace"><em>ValueType</em></span><span style="font-family:monospace">&gt;</span>. Note
that <span style="font-family:monospace">@NonNull</span> is the default type, so it need not be written explicitly.
</li><li class="li-enumerate"><span style="font-family:monospace">mykey</span> is a key in <span style="font-family:monospace">mymap</span>; that is, <span style="font-family:monospace">mymap.containsKey(mykey)</span>
returns <span style="font-family:monospace">true</span>. You express this fact to the Nullness Checker by
declaring <span style="font-family:monospace">mykey</span> as <span style="font-family:monospace">@KeyFor("mymap") </span><span style="font-family:monospace"><em>KeyType</em></span><span style="font-family:monospace"> mykey</span>. For a
local variable, you generally do not need to write the
<span style="font-family:monospace">@KeyFor("mymap")</span> type qualifier, because it can be inferred.
</li></ol><p>
If either of these two conditions is violated, then <span style="font-family:monospace">mymap.get(mykey)</span> has
the possibility of returning <span style="font-family:monospace">null</span>.</p><p>The command-line argument <span style="font-family:monospace">-AassumeKeyFor</span> makes the Nullness Checker not
run the Map Key Checker. The Nullness Checker will unsoundly assume that
the argument to <span style="font-family:monospace">Map.get</span> is a key for the receiver map. That is, the
second condition above is always considered to be <span style="font-family:monospace">true</span>.</p>
<!--TOC section id="writing-nullness-annotations" Writing nullness annotations-->
<h2 id="writing-nullness-annotations" class="section">3.3 Writing nullness annotations <a href="#writing-nullness-annotations"><img src="chainlink.svg" width="10" height="10"></a></h2><!--SEC END -->
<!--TOC subsection id="nullness-implicit-qualifiers" Implicit qualifiers-->
<h3 id="nullness-implicit-qualifiers" class="subsection">3.3.1 Implicit qualifiers <a href="#nullness-implicit-qualifiers"><img src="chainlink.svg" width="10" height="10"></a></h3><!--SEC END --><p>The Nullness Checker
adds implicit qualifiers, reducing the number of annotations that must
appear in your code (see Section ‍<a href="#effective-qualifier">31.4</a>).
For example, enum types are implicitly non-null, so you never need to write
<span style="font-family:monospace">@NonNull MyEnumType</span>.</p><p>If you want details about implicitly-added nullness qualifiers, see the
implementation of <a href="../api/org/checkerframework/checker/nullness/NullnessAnnotatedTypeFactory.html"><span style="font-family:monospace">NullnessAnnotatedTypeFactory</span></a>.</p>
<!--TOC subsection id="null-defaults" Default annotation-->
<h3 id="null-defaults" class="subsection">3.3.2 Default annotation <a href="#null-defaults"><img src="chainlink.svg" width="10" height="10"></a></h3><!--SEC END --><p>Unannotated references are treated as if they had a default annotation.
All types default to
<span style="font-family:monospace">@NonNull</span>, except that <span style="font-family:monospace">@Nullable</span> is used for casts, locals,
instanceof, and implicit bounds (see Section ‍<a href="#climb-to-top">31.5.3</a>).
A user can choose a different defaulting
rule by writing a <a href="../api/org/checkerframework/framework/qual/DefaultQualifier.html"><span style="font-family:monospace">@DefaultQualifier</span></a> annotation on a
package, class, or method. In the example below, fields are defaulted to
<span style="font-family:monospace">@Nullable</span> instead of <span style="font-family:monospace">@NonNull</span>.</p><pre class="verbatim">@DefaultQualifier(value = Nullable.class, locations = TypeUseLocation.FIELD)
class MyClass {
    Object nullableField = null;
    @NonNull Object nonNullField = new Object();
}
</pre>
<!--TOC subsection id="conditional-nullness" Conditional nullness-->
<h3 id="conditional-nullness" class="subsection">3.3.3 Conditional nullness <a href="#conditional-nullness"><img src="chainlink.svg" width="10" height="10"></a></h3><!--SEC END --><p>The Nullness Checker supports a form of conditional nullness types, via the
<a href="../api/org/checkerframework/checker/nullness/qual/EnsuresNonNullIf.html"><span style="font-family:monospace">@EnsuresNonNullIf</span></a> method annotations.
The annotation on a method declares that some expressions are non-null, if
the method returns true (false, respectively).</p><p>Consider <a href="https://docs.oracle.com/en/java/javase/17/docs/api/java.base/java/lang/Class.html"><span style="font-family:monospace">java.lang.Class</span></a>.
Method
<a href="https://docs.oracle.com/en/java/javase/17/docs/api/java.base/java/lang/Class.html#getComponentType()"><span style="font-family:monospace">Class.getComponentType()</span></a>
may return null, but it is specified to return a non-null value if
<a href="https://docs.oracle.com/en/java/javase/17/docs/api/java.base/java/lang/Class.html#isArray()"><span style="font-family:monospace">Class.isArray()</span></a> is
true.
You could declare this relationship in the following way (this particular
example is already
done for you in the annotated JDK that comes with the Checker Framework):</p><pre class="verbatim">  class Class&lt;T&gt; {
    @EnsuresNonNullIf(expression="getComponentType()", result=true)
    public native boolean isArray();

    public native @Nullable Class&lt;?&gt; getComponentType();
  }
</pre><p>A client that checks that a <span style="font-family:monospace">Class</span> reference is indeed that of an array,
can then de-reference the result of <span style="font-family:monospace">Class.getComponentType</span> safely
without any nullness check. The Checker Framework source code itself
uses such a pattern:</p><pre class="verbatim">    if (clazz.isArray()) {
      // no possible null dereference on the following line
      TypeMirror componentType = typeFromClass(clazz.getComponentType());
      ...
    }
</pre><p>Another example is <a href="https://docs.oracle.com/en/java/javase/17/docs/api/java.base/java/util/Queue.html#peek()"><span style="font-family:monospace">Queue.peek</span></a>
and <a href="https://docs.oracle.com/en/java/javase/17/docs/api/java.base/java/util/Queue.html#poll()"><span style="font-family:monospace">Queue.poll</span></a>, which return
non-null if <a href="https://docs.oracle.com/en/java/javase/17/docs/api/java.base/java/util/Collection.html#isEmpty()"><span style="font-family:monospace">isEmpty</span></a>
returns false.</p><p>The argument to <span style="font-family:monospace">@EnsuresNonNullIf</span> is a Java expression, including method calls
(as shown above), method formal parameters, fields, etc.; for details, see
Section ‍<a href="#java-expressions-as-arguments">31.8</a>.
More examples of the use of these annotations appear in the Javadoc for
<a href="../api/org/checkerframework/checker/nullness/qual/EnsuresNonNullIf.html"><span style="font-family:monospace">@EnsuresNonNullIf</span></a>.</p><p>Java programs sometimes contain more complex nullness invariants. When
these invariants are more complex than handled by the Nullness Checker, you
will need to suppress a warning (see
Section ‍<a href="#suppressing-warnings-nullness">3.4</a>).</p>
<!--TOC subsection id="nullness-arrays" Nullness and array initialization-->
<h3 id="nullness-arrays" class="subsection">3.3.4 Nullness and array initialization <a href="#nullness-arrays"><img src="chainlink.svg" width="10" height="10"></a></h3><!--SEC END --><p>Suppose that you declare an array to contain non-null elements:</p><pre class="verbatim">  Object [] oa = new Object[10];
</pre><p>(recall that <span style="font-family:monospace">Object</span> means the same thing as <span style="font-family:monospace">@NonNull Object</span>).
By default, the Nullness Checker unsoundly permits this code.</p><p>To make the Nullness Checker conservatively reject code that may leave a
non-null value in an array, use the command-line option
<span style="font-family:monospace">-Alint=soundArrayCreationNullness</span>. The option is currently disabled
because it makes the checker issue many false positive errors.
</p><p>With the option enabled, you can write your code to create a nullable or
lazy-nonnull array, initialize
each component, and then assign the result to a non-null array:</p><pre class="verbatim">  @MonotonicNonNull Object [] temp = new @MonotonicNonNull Object[10];
  for (int i = 0; i &lt; temp.length; ++i) {
    temp[i] = new Object();
  }
  @SuppressWarnings("nullness") // temp array is now fully initialized
  @NonNull Object [] oa = temp;
</pre><p>Note that the checker is currently not powerful enough to ensure that
each array component was initialized. Therefore, the last assignment
needs to be trusted: that is, a programmer must verify that it is safe,
then write a <span style="font-family:monospace">@SuppressWarnings</span> annotation.</p>
<!--TOC subsection id="nullness-collection-toarray" Nullness and conversions from collections to arrays-->
<h3 id="nullness-collection-toarray" class="subsection">3.3.5 Nullness and conversions from collections to arrays <a href="#nullness-collection-toarray"><img src="chainlink.svg" width="10" height="10"></a></h3><!--SEC END --><p>The nullness semantics of
<a href="https://docs.oracle.com/en/java/javase/17/docs/api/java.base/java/util/Collection.html#toArray(T[])"><span style="font-family:monospace">Collection.toArray(T[])</span></a>
cannot be captured by just the nullness type system, though the Nullness
Checker contains special-case code to type-check calls to <span style="font-family:monospace">toArray</span>.
Therefore, you will probably have to write <span style="font-family:monospace">@SuppressWarnings("nullness")</span>
on any overriding definitions of <span style="font-family:monospace">toArray</span>.</p><p>The nullness type of the
returned array depends on the <em>size</em> of the passed parameter. In particular, the
returned array component is of type <span style="font-family:monospace">@NonNull</span> if the following conditions
hold:</p><ul class="itemize"><li class="li-itemize">
The receiver collection’s type argument (that is, the element type) is <span style="font-family:monospace">@NonNull</span>, and
</li><li class="li-itemize">The passed array size is less than or equal to the collection size. The
Nullness Checker uses these heuristics to handle the most common cases:<ul class="itemize"><li class="li-itemize">
the argument has length 0:<ul class="itemize"><li class="li-itemize">
an empty array initializer, e.g. <span style="font-family:monospace">c.toArray(new String[] {})</span>, or</li><li class="li-itemize">array creation tree of size 0, e.g. <span style="font-family:monospace">c.toArray(new String[0])</span>.
</li></ul></li><li class="li-itemize">array creation tree with a collection <span style="font-family:monospace">size()</span> method invocation as argument
<span style="font-family:monospace">c.toArray(new String[c.size()])</span>.
</li></ul></li></ul><p>Additionally, when you supply the <span style="font-family:monospace">-Alint=trustArrayLenZero</span> command-line
option, a call to <span style="font-family:monospace">Collection.toArray</span> will be estimated to return an array
with a non-null component type if the argument is a field access where the field
declaration has a <a href="../api/org/checkerframework/common/value/qual/ArrayLen.html"><span style="font-family:monospace">@ArrayLen</span></a><span style="font-family:monospace">(0)</span>
annotation.
This trusts the <span style="font-family:monospace">@ArrayLen(0)</span> annotation, but does not verify it. Run the
Constant Value Checker (see Chapter ‍<a href="#constant-value-checker">22</a>) to verify
that annotation.</p><p>Note: The nullness of the returned array doesn’t depend on the passed array nullness.
This is a fact about
<a href="https://docs.oracle.com/en/java/javase/17/docs/api/java.base/java/util/Collection.html#toArray(T[])"><span style="font-family:monospace">Collection.toArray(T[])</span></a>,
not a limitation of this heuristic.</p>
<!--TOC subsection id="nullness-runtime-checks" Run-time checks for nullness-->
<h3 id="nullness-runtime-checks" class="subsection">3.3.6 Run-time checks for nullness <a href="#nullness-runtime-checks"><img src="chainlink.svg" width="10" height="10"></a></h3><!--SEC END --><p>When you perform a run-time check for nullness, such as <span style="font-family:monospace">if (x != null)
...</span>, then the Nullness Checker refines the type of <span style="font-family:monospace">x</span> to
<span style="font-family:monospace">@NonNull</span>. The refinement lasts until the end of the scope of the test
or until <span style="font-family:monospace">x</span> may be side-effected. For more details, see
Section ‍<a href="#type-refinement">31.7</a>.</p>
<!--TOC subsection id="nullness-inference" Inference of <span style="font-family:monospace">@NonNull</span> and <span style="font-family:monospace">@Nullable</span> annotations-->
<h3 id="nullness-inference" class="subsection">3.3.7 Inference of <span style="font-family:monospace">@NonNull</span> and <span style="font-family:monospace">@Nullable</span> annotations <a href="#nullness-inference"><img src="chainlink.svg" width="10" height="10"></a></h3><!--SEC END --><p>It can be tedious to write annotations in your code. Tools exist that
can automatically infer annotations and insert them in your source code.
(This is different than type qualifier refinement for local variables
(Section ‍<a href="#type-refinement">31.7</a>), which infers a more specific type for
local variables and uses them during type-checking but does not insert them
in your source code. Type qualifier refinement is always enabled, no
matter how annotations on signatures got inserted in your source code.)</p><p>Your choice of tool depends on what default annotation (see
Section ‍<a href="#null-defaults">3.3.2</a>) your code uses. You only need one of these tools.</p><ul class="itemize"><li class="li-itemize">Inference of <a href="../api/org/checkerframework/checker/nullness/qual/Nullable.html"><span style="font-family:monospace">@Nullable</span></a>:
If your code uses the standard CLIMB-to-top default (Section ‍<a href="#climb-to-top">31.5.3</a>) or
the NonNull default, then use the
<a href="http://plse.cs.washington.edu/daikon/download/doc/daikon.html#AnnotateNullable">AnnotateNullable</a>
tool of the <a href="http://plse.cs.washington.edu/daikon/">Daikon invariant
detector</a>.</li><li class="li-itemize">Inference of <a href="../api/org/checkerframework/checker/nullness/qual/NonNull.html"><span style="font-family:monospace">@NonNull</span></a>:
If your code uses the Nullable default (this is unusual), use one of these tools:
<ul class="itemize"><li class="li-itemize">
<a href="https://jastadd.cs.lth.se/jastadd-tutorial-examples/non-null-types-for-java/">Non-null
checker and inferencer</a> of the <a href="https://jastadd.cs.lth.se/">JastAdd
Extensible Compiler</a>.
</li></ul></li></ul>
<!--TOC section id="suppressing-warnings-nullness" Suppressing nullness warnings-->
<h2 id="suppressing-warnings-nullness" class="section">3.4 Suppressing nullness warnings <a href="#suppressing-warnings-nullness"><img src="chainlink.svg" width="10" height="10"></a></h2><!--SEC END --><p>When the Nullness Checker reports a warning, it’s best to change the code
or its annotations, to eliminate the warning. Alternately, you can
suppress the warning, which does not change the code but prevents the
Nullness Checker from reporting this particular warning to you.</p><p>
The Checker Framework supplies several ways to suppress warnings, most
notably the <span style="font-family:monospace">@SuppressWarnings("nullness")</span> annotation (see
Chapter ‍<a href="#suppressing-warnings">32</a>). An example use is
</p><pre class="verbatim">    // might return null
    @Nullable Object getObject(...) { ... }

    void myMethod() {
      @SuppressWarnings("nullness") // with argument x, getObject always returns a non-null value
      @NonNull Object o2 = getObject(x);
</pre><p>The Nullness Checker supports an additional warning suppression string,
<span style="font-family:monospace">nullness:generic.argument</span>.
Use of <span style="font-family:monospace">@SuppressWarnings("nullness:generic.argument")</span> causes the Nullness
Checker to suppress warnings related to misuse of generic type
arguments. One use for this key is when a class is declared to take only
<span style="font-family:monospace">@NonNull</span> type arguments, but you want to instantiate the class with a
<span style="font-family:monospace">@Nullable</span> type argument, as in <span style="font-family:monospace">List&lt;@Nullable Object&gt;</span>.</p><p>The Nullness Checker also permits you to use assertions or method calls to
suppress warnings; see below.</p>
<!--TOC subsection id="suppressing-warnings-with-assertions" Suppressing warnings with assertions and method calls-->
<h3 id="suppressing-warnings-with-assertions" class="subsection">3.4.1 Suppressing warnings with assertions and method calls <a href="#suppressing-warnings-with-assertions"><img src="chainlink.svg" width="10" height="10"></a></h3><!--SEC END --><p>Occasionally, it is inconvenient or
verbose to use the <span style="font-family:monospace">@SuppressWarnings</span> annotation. For example, Java does
not permit annotations such as <span style="font-family:monospace">@SuppressWarnings</span> to appear on
statements, expressions, static initializers, etc.
Here are three ways to suppress a warning in such cases:
</p><ul class="itemize"><li class="li-itemize">
Create a local variable to hold a subexpression, and
suppress a warning on the local variable declaration.
</li><li class="li-itemize">Use the <span style="font-family:monospace">@AssumeAssertion</span> string in
an <span style="font-family:monospace">assert</span> message (see Section ‍<a href="#assumeassertion">32.2</a>).
</li><li class="li-itemize">Write a call to the
<a href="../api/org/checkerframework/checker/nullness/util/NullnessUtil.html#castNonNull(T)"><span style="font-family:monospace">NullnessUtil.castNonNull</span></a> method.
</li></ul><p>The rest of this section discusses the <span style="font-family:monospace">castNonNull</span> method.
It is useful if you wish to suppress a warning within an expression.</p><p>The Nullness Checker considers both the return value, and also the
argument, to be non-null after the <span style="font-family:monospace">castNonNull</span> method call.
The Nullness Checker issues no warnings in any of the following
code:</p><pre class="verbatim">  // One way to use castNonNull as a cast:
  @NonNull String s = castNonNull(possiblyNull1);

  // Another way to use castNonNull as a cast:
  castNonNull(possiblyNull2).toString();

  // It is possible, but not recommmended, to use castNonNull as a statement:
  // (It would be better to write an assert statement with @AssumeAssertion
  // in its message, instead.)
  castNonNull(possiblyNull3);
  possiblyNull3.toString();
</pre><p>The <span style="font-family:monospace">castNonNull</span> method throws <span style="font-family:monospace">AssertionError</span> if Java assertions are enabled and
the argument is <span style="font-family:monospace">null</span>. However, it is not intended for general defensive
programming; see Section ‍<a href="#defensive-programming">32.2.1</a>.</p><p>To use the <span style="font-family:monospace">castNonNull</span> method, the <span style="font-family:monospace">checker-util.jar</span> file
must be on the classpath at run time.</p><p>
The Nullness Checker introduces a new method, rather than re-using an
existing method such as <span style="font-family:monospace">org.junit.Assert.assertNotNull(Object)</span> or
<span style="font-family:monospace">com.google.common.base.Preconditions.checkNotNull(Object)</span>. Those
methods are commonly used for defensive programming, so it is impossible to
know the programmer’s intent when writing them. Therefore, it is important to
have a method call that is used only for warning suppression. See
Section ‍<a href="#defensive-programming">32.2.1</a> for a discussion of
the distinction between warning suppression and defensive programming.
</p>
<!--TOC subsection id="nullness-collection-arguments" Null arguments to collection classes-->
<h3 id="nullness-collection-arguments" class="subsection">3.4.2 Null arguments to collection classes <a href="#nullness-collection-arguments"><img src="chainlink.svg" width="10" height="10"></a></h3><!--SEC END --><p>For collection methods with <span style="font-family:monospace">Object</span> formal parameter type, such as
<a href="https://docs.oracle.com/en/java/javase/17/docs/api/java.base/java/util/Collection.html#contains(java.lang.Object)"><span style="font-family:monospace">contains</span></a>,
<a href="https://docs.oracle.com/en/java/javase/17/docs/api/java.base/java/util/AbstractList.html#indexOf(java.lang.Object)"><span style="font-family:monospace">indexOf</span></a>, and
<a href="https://docs.oracle.com/en/java/javase/17/docs/api/java.base/java/util/Collection.html#remove(java.lang.Object)"><span style="font-family:monospace">remove</span></a>,
the annotated JDK forbids null as an argument.</p><p>The reason is that some implementations (like <span style="font-family:monospace">ConcurrentHashMap</span>) throw
<span style="font-family:monospace">NullPointerException</span> if <span style="font-family:monospace">null</span> is passed. It would be unsound to
permit <span style="font-family:monospace">null</span>, because it could lead to a false negative: the Checker
Framework issuing no warning even though a NullPointerException can occur
at run time.</p><p>However, many other common implementations permit such calls, so some users
may wish to sacrifice soundness for a reduced number of false positive
warnings. To permit <span style="font-family:monospace">null</span> as an argument to these methods, pass the
command-line argument
<span style="font-family:monospace">-Astubs=collection-object-parameters-may-be-null.astub</span>.</p>
<!--TOC subsection id="nullness-jdk-conservative" Conservative nullness annotations on the JDK-->
<h3 id="nullness-jdk-conservative" class="subsection">3.4.3 Conservative nullness annotations on the JDK <a href="#nullness-jdk-conservative"><img src="chainlink.svg" width="10" height="10"></a></h3><!--SEC END --><p>The JDK contains nullness annotations that preserve the Nullness Checker’s
guarantee (see Section ‍<a href="#nullness-checks">3.1</a>) that your program will not
crash with a <span style="font-family:monospace">NullPointerException</span>. In some cases, a formal parameter
may be null in some circumstances, but must be non-null in other
circumstances, and those circumstances are not expressible using the
Nullness Checker’s annotations.</p><p>An example is restrictions on collection arguments (see
Section ‍<a href="#nullness-collection-arguments">3.4.2</a>).</p><p>Another example is this <span style="font-family:monospace">WeakReference</span> constructor:</p><pre class="verbatim">     ...
     * @param q the queue with which the reference is to be registered,
     *          or {@code null} if registration is not required
     */
    public WeakReference(@Nullable T referent, ReferenceQueue&lt;? super T&gt; q) {
      ...
</pre><p>For some calls, <span style="font-family:monospace">q</span> must be non-null. Therefore, <span style="font-family:monospace">q</span> is annotated as
<span style="font-family:monospace">@NonNull</span> (which is the default and need not be explicitly written).</p><p>These JDK annotations reflect a verification philosophy: a verification
tool finds all possible errors, but it sometimes issues a false positive warning.
An alternate philosophy is a bug-finding philosophy: permit all calls that
<em>might</em> be correct at run time, but sometimes miss a real error. If
you wish to use the Checker Framework with the bug-finding philosophy
(though the Checker Framework is still much more thorough than other
bug-finders), you can do so by passing the command-line argument
<span style="font-family:monospace">-Astubs=sometimes-nullable.astub</span>.</p>
<!--TOC section id="nullness-example" Examples-->
<h2 id="nullness-example" class="section">3.5 Examples <a href="#nullness-example"><img src="chainlink.svg" width="10" height="10"></a></h2><!--SEC END -->
<!--TOC subsection id="nullness-tiny-examples" Tiny examples-->
<h3 id="nullness-tiny-examples" class="subsection">3.5.1 Tiny examples <a href="#nullness-tiny-examples"><img src="chainlink.svg" width="10" height="10"></a></h3><!--SEC END --><p>To try the Nullness Checker on a source file that uses the <a href="../api/org/checkerframework/checker/nullness/qual/NonNull.html"><span style="font-family:monospace">@NonNull</span></a> qualifier,
use the following command (where <span style="font-family:monospace">javac</span> is the Checker Framework compiler that
is distributed with the Checker Framework, see Section ‍<a href="#javac-wrapper">37.5</a>
for details):</p><pre class="verbatim">  javac -processor org.checkerframework.checker.nullness.NullnessChecker docs/examples/NullnessExample.java
</pre><p>Compilation will complete without warnings.</p><p>To see the checker warn about incorrect usage of annotations (and therefore the
possibility of a null pointer exception at run time), use the following command:</p><div style="font-size:small;">
<pre class="verbatim">  javac -processor org.checkerframework.checker.nullness.NullnessChecker docs/examples/NullnessExampleWithWarnings.java
</pre>
</div><p>The compiler will issue two warnings regarding violation of the semantics of
<a href="../api/org/checkerframework/checker/nullness/qual/NonNull.html"><span style="font-family:monospace">@NonNull</span></a>.
</p>
<!--TOC subsection id="nullness-annotated-library" Example annotated source code-->
<h3 id="nullness-annotated-library" class="subsection">3.5.2 Example annotated source code <a href="#nullness-annotated-library"><img src="chainlink.svg" width="10" height="10"></a></h3><!--SEC END --><p>Some libraries that are annotated with nullness qualifiers are:</p><ul class="itemize"><li class="li-itemize">
The Nullness Checker itself.</li><li class="li-itemize">The Java projects in the <a href="https://github.com/plume-lib/">plume-lib GitHub organization</a>.
Type-checking occurs on each build.</li><li class="li-itemize">The
<a href="http://plse.cs.washington.edu/daikon/">Daikon invariant detector</a>.
Run the command <span style="font-family:monospace">make check-nullness</span>.</li></ul>
<!--TOC subsection id="nullness-publications" Publications-->
<h3 id="nullness-publications" class="subsection">3.5.3 Publications <a href="#nullness-publications"><img src="chainlink.svg" width="10" height="10"></a></h3><!--SEC END --><p>The papers “Practical pluggable types for Java” ‍[<a href="#PapiACPE2008">PAC+08</a>]
(ISSTA 2008,
<a href="https://homes.cs.washington.edu/~mernst/pubs/pluggable-checkers-issta2008.pdf"><span style="font-family:monospace">https://homes.cs.washington.edu/~mernst/pubs/pluggable-checkers-issta2008.pdf</span></a>)
and “Building and using pluggable type-checkers” ‍[<a href="#DietlDEMS2011">DDE+11</a>]
(ICSE 2011,
<a href="https://homes.cs.washington.edu/~mernst/pubs/pluggable-checkers-icse2011.pdf"><span style="font-family:monospace">https://homes.cs.washington.edu/~mernst/pubs/pluggable-checkers-icse2011.pdf</span></a>)
describe case studies in which the Nullness Checker found
previously-unknown errors in real software.</p>
<!--TOC section id="nullness-getting-started" Tips for getting started-->
<h2 id="nullness-getting-started" class="section">3.6 Tips for getting started <a href="#nullness-getting-started"><img src="chainlink.svg" width="10" height="10"></a></h2><!--SEC END --><p>Here are some tips about getting started using the Nullness Checker on a
legacy codebase. For more generic advice (not specific to the Nullness
Checker), see Section ‍<a href="#get-started-with-legacy-code">2.4.2</a>. Also see the
<a href="https://eisop.github.io/cf/tutorial/">Checker
Framework tutorial</a>, which includes an example of using the Nullness Checker.</p><p>Your goal is to add <a href="../api/org/checkerframework/checker/nullness/qual/Nullable.html"><span style="font-family:monospace">@Nullable</span></a> annotations
to the types of any variables that can be null. (The default is to assume
that a variable is non-null unless it has a <span style="font-family:monospace">@Nullable</span> annotation.)
Then, you will run the Nullness Checker. Each of its errors indicates
either a possible null pointer exception, or a wrong/missing annotation.
When there are no more warnings from the checker, you are done!</p><p>We recommend that you start by searching the code for occurrences of
<span style="font-family:monospace">null</span> in the following locations; when you find one, write the
corresponding annotation:</p><ul class="itemize"><li class="li-itemize">
in Javadoc: add <span style="font-family:monospace">@Nullable</span> annotations to method signatures (parameters and return types).
</li><li class="li-itemize"><span style="font-family:monospace">return null</span>: add a <span style="font-family:monospace">@Nullable</span> annotation to the return type
of the given method.
</li><li class="li-itemize"><span style="font-family:monospace"><em>param</em></span><span style="font-family:monospace"> == null</span>: when a formal parameter is compared to
<span style="font-family:monospace">null</span>, then in most cases you can add a <span style="font-family:monospace">@Nullable</span> annotation
to the formal parameter’s type
</li><li class="li-itemize"><span style="font-family:monospace"><em>TypeName</em></span><span style="font-family:monospace"> </span><span style="font-family:monospace"><em>field</em></span><span style="font-family:monospace"> = null;</span>: when a field is initialized to
<span style="font-family:monospace">null</span> in its declaration, then it needs either a
<a href="../api/org/checkerframework/checker/nullness/qual/Nullable.html"><span style="font-family:monospace">@Nullable</span></a> or a
<a href="../api/org/checkerframework/checker/nullness/qual/MonotonicNonNull.html"><span style="font-family:monospace">@MonotonicNonNull</span></a> annotation. If the field
is always set to a non-null value in the constructor, then you can just
change the declaration to <span style="font-family:monospace"><em>Type</em></span><span style="font-family:monospace"> </span><span style="font-family:monospace"><em>field</em></span><span style="font-family:monospace">;</span>, without an
initializer, and write no type annotation (because the default is
<span style="font-family:monospace">@NonNull</span>).
</li><li class="li-itemize">declarations of <span style="font-family:monospace">contains</span>, <span style="font-family:monospace">containsKey</span>, <span style="font-family:monospace">containsValue</span>, <span style="font-family:monospace">equals</span>,
<span style="font-family:monospace">get</span>, <span style="font-family:monospace">indexOf</span>, <span style="font-family:monospace">lastIndexOf</span>, and <span style="font-family:monospace">remove</span> (with <span style="font-family:monospace">Object</span> as the
argument type):
change the argument type to <span style="font-family:monospace">@Nullable Object</span>; for <span style="font-family:monospace">remove</span>, also change
the return type to <span style="font-family:monospace">@Nullable Object</span>.
</li></ul><p>You should ignore all other occurrences of <span style="font-family:monospace">null</span> within a method
body. In particular, you rarely need to annotate local variables
(except their type arguments or array element types).</p><p>Only after this step should you run
the Nullness Checker. The reason is that it is quicker to search for
places to change than to repeatedly run the checker and fix the errors it
tells you about, one at a time.</p><p>Here are some other tips:
</p><ul class="itemize"><li class="li-itemize">

In any file where you write an annotation such as <span style="font-family:monospace">@Nullable</span>,
don’t forget to add <span style="font-family:monospace">import org.checkerframework.checker.nullness.qual.*;</span>.

</li><li class="li-itemize">To indicate an array that can be null, write, for example: <span style="font-family:monospace">int
@Nullable []</span>. <br>
 By contrast, <span style="font-family:monospace">@Nullable Object []</span> means a non-null array that
contains possibly-null objects.
</li><li class="li-itemize">If you know that a particular variable is definitely not null, but the
Nullness Checker estimates that the variable might be null, then you can
make the Nullness Checker trust your judgment by writing
an assertion (see Section ‍<a href="#assumeassertion">32.2</a>):
<pre class="verbatim">assert var != null : "@AssumeAssertion(nullness)";
</pre>
</li><li class="li-itemize">To indicate that a routine returns the same value every time it is
called, use <a href="../api/org/checkerframework/dataflow/qual/Pure.html"><span style="font-family:monospace">@Pure</span></a> (see Section ‍<a href="#type-refinement-purity">31.7.5</a>).
</li><li class="li-itemize">To indicate a method precondition (a contract stating the conditions
under which a client is allowed to call it), you can use annotations
such as <a href="../api/org/checkerframework/checker/nullness/qual/RequiresNonNull.html"><span style="font-family:monospace">@RequiresNonNull</span></a> (see Section ‍<a href="#nullness-method-annotations">3.2.2</a>).
</li></ul>
<!--TOC section id="nullness-related-work" Other tools for nullness checking-->
<h2 id="nullness-related-work" class="section">3.7 Other tools for nullness checking <a href="#nullness-related-work"><img src="chainlink.svg" width="10" height="10"></a></h2><!--SEC END --><p>The Checker Framework’s nullness annotations are similar to annotations used
in other
tools.
You might prefer to use the Checker Framework because it has a more
powerful analysis that can warn you about more null pointer errors in your
code.
Most of the other tools are bug-finding tools rather than verification tools, since they
give up precision, soundness, or both in favor of being fast and
easy to use. Also
see Section ‍<a href="#faq-type-checking-vs-bug-detectors">38.10.1</a> for a comparison to other tools.</p><p>If your code is already annotated with a different nullness
annotation, the Checker Framework can type-check your code.
It treats annotations from other tools
as if you had written the corresponding annotation from the
Nullness Checker, as described in Figures ‍<a href="#fig-nullness-refactoring-nonnull">3.2</a>,
<a href="#fig-nullness-refactoring-nullable">3.3</a>, and
<a href="#fig-nullness-refactoring-polynull">3.4</a>.
If the other annotation is a declaration annotation, it may be moved; see
Section ‍<a href="#declaration-annotations-moved">38.6.8</a>.</p><blockquote class="figure"><div class="center"><hr class="floatrule"></div>
<div class="center">
<table style="border-spacing:6px;border-collapse:separate;" class="cellpading0"><tr><td style="text-align:left;white-space:nowrap" ><table border=1  style="border-spacing:0;" class="cellpadding1"><tr><td style="text-align:left;border:solid 1px;white-space:nowrap" >  ‍android.annotation.NonNull ‍ </td></tr>
<tr><td style="text-align:left;border:solid 1px;white-space:nowrap" >  ‍android.support.annotation.NonNull ‍ </td></tr>
<tr><td style="text-align:left;border:solid 1px;white-space:nowrap" >  ‍android.support.annotation.RecentlyNonNull ‍ </td></tr>
<tr><td style="text-align:left;border:solid 1px;white-space:nowrap" >  ‍androidx.annotation.NonNull ‍ </td></tr>
<tr><td style="text-align:left;border:solid 1px;white-space:nowrap" >  ‍androidx.annotation.RecentlyNonNull ‍ </td></tr>
<tr><td style="text-align:left;border:solid 1px;white-space:nowrap" >  ‍com.android.annotations.NonNull ‍ </td></tr>
<tr><td style="text-align:left;border:solid 1px;white-space:nowrap" >  ‍com.google.firebase.database.annotations.NotNull ‍ </td></tr>
<tr><td style="text-align:left;border:solid 1px;white-space:nowrap" >  ‍com.google.firebase.internal.NonNull ‍ </td></tr>
<tr><td style="text-align:left;border:solid 1px;white-space:nowrap" >  ‍com.mongodb.lang.NonNull ‍ </td></tr>
<tr><td style="text-align:left;border:solid 1px;white-space:nowrap" >  ‍com.sun.istack.NotNull ‍ </td></tr>
<tr><td style="text-align:left;border:solid 1px;white-space:nowrap" >  ‍com.sun.istack.internal.NotNull ‍ </td></tr>
<tr><td style="text-align:left;border:solid 1px;white-space:nowrap" >  ‍com.unboundid.util.NotNull ‍ </td></tr>
<tr><td style="text-align:left;border:solid 1px;white-space:nowrap" >  ‍edu.umd.cs.findbugs.annotations.NonNull ‍ </td></tr>
<tr><td style="text-align:left;border:solid 1px;white-space:nowrap" >  ‍io.micrometer.core.lang.NonNull ‍ </td></tr>
<tr><td style="text-align:left;border:solid 1px;white-space:nowrap" >  ‍io.micronaut.core.annotation.NonNull ‍ </td></tr>
<tr><td style="text-align:left;border:solid 1px;white-space:nowrap" >  ‍io.reactivex.annotations.NonNull ‍ </td></tr>
<tr><td style="text-align:left;border:solid 1px;white-space:nowrap" >  ‍io.reactivex.rxjava3.annotations.NonNull ‍ </td></tr>
<tr><td style="text-align:left;border:solid 1px;white-space:nowrap" >  ‍jakarta.annotation.Nonnull ‍ </td></tr>
<tr><td style="text-align:left;border:solid 1px;white-space:nowrap" >  ‍javax.annotation.Nonnull ‍ </td></tr>
<tr><td style="text-align:left;border:solid 1px;white-space:nowrap" >  ‍// The field might contain a null value until it is persisted. </td></tr>
<tr><td style="text-align:left;border:solid 1px;white-space:nowrap" > ‍javax.validation.constraints.NotNull ‍ </td></tr>
<tr><td style="text-align:left;border:solid 1px;white-space:nowrap" >  ‍libcore.util.NonNull ‍ </td></tr>
<tr><td style="text-align:left;border:solid 1px;white-space:nowrap" >  ‍lombok.NonNull ‍ </td></tr>
<tr><td style="text-align:left;border:solid 1px;white-space:nowrap" >  ‍net.bytebuddy.agent.utility.nullability.NeverNull ‍ </td></tr>
<tr><td style="text-align:left;border:solid 1px;white-space:nowrap" >  ‍net.bytebuddy.utility.nullability.NeverNull ‍ </td></tr>
<tr><td style="text-align:left;border:solid 1px;white-space:nowrap" >  ‍org.antlr.v4.runtime.misc.NotNull ‍ </td></tr>
<tr><td style="text-align:left;border:solid 1px;white-space:nowrap" >  ‍org.checkerframework.checker.nullness.compatqual.NonNullDecl ‍ </td></tr>
<tr><td style="text-align:left;border:solid 1px;white-space:nowrap" >  ‍org.checkerframework.checker.nullness.compatqual.NonNullType ‍ </td></tr>
<tr><td style="text-align:left;border:solid 1px;white-space:nowrap" >  ‍org.codehaus.commons.nullanalysis.NotNull ‍ </td></tr>
<tr><td style="text-align:left;border:solid 1px;white-space:nowrap" >  ‍org.eclipse.jdt.annotation.NonNull ‍ </td></tr>
<tr><td style="text-align:left;border:solid 1px;white-space:nowrap" >  ‍org.eclipse.jgit.annotations.NonNull ‍ </td></tr>
<tr><td style="text-align:left;border:solid 1px;white-space:nowrap" >  ‍org.eclipse.lsp4j.jsonrpc.validation.NonNull ‍ </td></tr>
<tr><td style="text-align:left;border:solid 1px;white-space:nowrap" >  ‍org.jetbrains.annotations.NotNull ‍ </td></tr>
<tr><td style="text-align:left;border:solid 1px;white-space:nowrap" >  ‍org.jmlspecs.annotation.NonNull ‍ </td></tr>
<tr><td style="text-align:left;border:solid 1px;white-space:nowrap" >  ‍org.jspecify.annotations.NonNull ‍ </td></tr>
<tr><td style="text-align:left;border:solid 1px;white-space:nowrap" >  ‍org.jspecify.nullness.NonNull ‍ </td></tr>
<tr><td style="text-align:left;border:solid 1px;white-space:nowrap" >  ‍org.netbeans.api.annotations.common.NonNull ‍ </td></tr>
<tr><td style="text-align:left;border:solid 1px;white-space:nowrap" >  ‍org.springframework.lang.NonNull ‍ </td></tr>
<tr><td style="text-align:left;border:solid 1px;white-space:nowrap" >  ‍reactor.util.annotation.NonNull ‍ </td></tr>
</table></td><td style="text-align:left;white-space:nowrap" >⇒
 ‍org.checkerframework.checker.nullness.qual.NonNull ‍
</td></tr>
</table>
</div>
<div class="caption"><table style="border-spacing:6px;border-collapse:separate;" class="cellpading0"><tr><td style="vertical-align:top;text-align:left;" >Figure 3.2: Correspondence between other nullness annotations and the
Checker Framework’s <span style="font-family:monospace">NonNull</span> annotation.</td></tr>
</table></div>
<a id="fig-nullness-refactoring-nonnull"></a>
<div class="center"><hr class="floatrule"></div></blockquote><blockquote class="figure"><div class="center"><hr class="floatrule"></div>
<div class="center">
<table style="border-spacing:6px;border-collapse:separate;" class="cellpading0"><tr><td style="text-align:left;white-space:nowrap" ><table border=1  style="border-spacing:0;" class="cellpadding1"><tr><td style="text-align:left;border:solid 1px;white-space:nowrap" >  ‍android.annotation.Nullable ‍ </td></tr>
<tr><td style="text-align:left;border:solid 1px;white-space:nowrap" >  ‍android.support.annotation.Nullable ‍ </td></tr>
<tr><td style="text-align:left;border:solid 1px;white-space:nowrap" >  ‍android.support.annotation.RecentlyNullable ‍ </td></tr>
<tr><td style="text-align:left;border:solid 1px;white-space:nowrap" >  ‍androidx.annotation.Nullable ‍ </td></tr>
<tr><td style="text-align:left;border:solid 1px;white-space:nowrap" >  ‍androidx.annotation.RecentlyNullable ‍ </td></tr>
<tr><td style="text-align:left;border:solid 1px;white-space:nowrap" >  ‍com.android.annotations.Nullable ‍ </td></tr>
<tr><td style="text-align:left;border:solid 1px;white-space:nowrap" >  ‍com.beust.jcommander.internal.Nullable ‍ </td></tr>
<tr><td style="text-align:left;border:solid 1px;white-space:nowrap" >  ‍com.google.api.server.spi.config.Nullable ‍ </td></tr>
<tr><td style="text-align:left;border:solid 1px;white-space:nowrap" >  ‍com.google.firebase.database.annotations.Nullable ‍ </td></tr>
<tr><td style="text-align:left;border:solid 1px;white-space:nowrap" >  ‍com.google.firebase.internal.Nullable ‍ </td></tr>
<tr><td style="text-align:left;border:solid 1px;white-space:nowrap" >  ‍com.google.gerrit.common.Nullable ‍ </td></tr>
<tr><td style="text-align:left;border:solid 1px;white-space:nowrap" >  ‍com.google.protobuf.Internal.ProtoMethodAcceptsNullParameter ‍ </td></tr>
<tr><td style="text-align:left;border:solid 1px;white-space:nowrap" >  ‍com.google.protobuf.Internal.ProtoMethodMayReturnNull ‍ </td></tr>
<tr><td style="text-align:left;border:solid 1px;white-space:nowrap" >  ‍com.mongodb.lang.Nullable ‍ </td></tr>
<tr><td style="text-align:left;border:solid 1px;white-space:nowrap" >  ‍com.sun.istack.Nullable ‍ </td></tr>
<tr><td style="text-align:left;border:solid 1px;white-space:nowrap" >  ‍com.sun.istack.internal.Nullable ‍ </td></tr>
<tr><td style="text-align:left;border:solid 1px;white-space:nowrap" >  ‍com.unboundid.util.Nullable ‍ </td></tr>
<tr><td style="text-align:left;border:solid 1px;white-space:nowrap" >  ‍edu.umd.cs.findbugs.annotations.CheckForNull ‍ </td></tr>
<tr><td style="text-align:left;border:solid 1px;white-space:nowrap" >  ‍edu.umd.cs.findbugs.annotations.Nullable ‍ </td></tr>
<tr><td style="text-align:left;border:solid 1px;white-space:nowrap" >  ‍edu.umd.cs.findbugs.annotations.PossiblyNull ‍ </td></tr>
<tr><td style="text-align:left;border:solid 1px;white-space:nowrap" >  ‍edu.umd.cs.findbugs.annotations.UnknownNullness ‍ </td></tr>
<tr><td style="text-align:left;border:solid 1px;white-space:nowrap" >  ‍io.micrometer.core.lang.Nullable ‍ </td></tr>
<tr><td style="text-align:left;border:solid 1px;white-space:nowrap" >  ‍io.micronaut.core.annotation.Nullable ‍ </td></tr>
<tr><td style="text-align:left;border:solid 1px;white-space:nowrap" >  ‍io.reactivex.annotations.Nullable ‍ </td></tr>
<tr><td style="text-align:left;border:solid 1px;white-space:nowrap" >  ‍io.reactivex.rxjava3.annotations.Nullable ‍ </td></tr>
<tr><td style="text-align:left;border:solid 1px;white-space:nowrap" >  ‍io.vertx.codegen.annotations.Nullable ‍ </td></tr>
<tr><td style="text-align:left;border:solid 1px;white-space:nowrap" >  ‍jakarta.annotation.Nullable ‍ </td></tr>
<tr><td style="text-align:left;border:solid 1px;white-space:nowrap" >  ‍javax.annotation.CheckForNull ‍ </td></tr>
<tr><td style="text-align:left;border:solid 1px;white-space:nowrap" >  ‍javax.annotation.Nullable ‍ </td></tr>
<tr><td style="text-align:left;border:solid 1px;white-space:nowrap" >  ‍junitparams.converters.Nullable ‍ </td></tr>
<tr><td style="text-align:left;border:solid 1px;white-space:nowrap" >  ‍libcore.util.Nullable ‍ </td></tr>
<tr><td style="text-align:left;border:solid 1px;white-space:nowrap" >  ‍net.bytebuddy.agent.utility.nullability.AlwaysNull ‍ </td></tr>
<tr><td style="text-align:left;border:solid 1px;white-space:nowrap" >  ‍net.bytebuddy.agent.utility.nullability.MaybeNull ‍ </td></tr>
<tr><td style="text-align:left;border:solid 1px;white-space:nowrap" >  ‍net.bytebuddy.agent.utility.nullability.UnknownNull ‍ </td></tr>
<tr><td style="text-align:left;border:solid 1px;white-space:nowrap" >  ‍net.bytebuddy.utility.nullability.AlwaysNull ‍ </td></tr>
<tr><td style="text-align:left;border:solid 1px;white-space:nowrap" >  ‍net.bytebuddy.utility.nullability.MaybeNull ‍ </td></tr>
<tr><td style="text-align:left;border:solid 1px;white-space:nowrap" >  ‍net.bytebuddy.utility.nullability.UnknownNull ‍ </td></tr>
<tr><td style="text-align:left;border:solid 1px;white-space:nowrap" >  ‍org.apache.avro.reflect.Nullable ‍ </td></tr>
<tr><td style="text-align:left;border:solid 1px;white-space:nowrap" >  ‍org.apache.cxf.jaxrs.ext.Nullable ‍ </td></tr>
<tr><td style="text-align:left;border:solid 1px;white-space:nowrap" >  ‍org.apache.shindig.common.Nullable ‍ </td></tr>
<tr><td style="text-align:left;border:solid 1px;white-space:nowrap" >  ‍org.checkerframework.checker.nullness.compatqual.NullableDecl ‍ </td></tr>
<tr><td style="text-align:left;border:solid 1px;white-space:nowrap" >  ‍org.checkerframework.checker.nullness.compatqual.NullableType ‍ </td></tr>
<tr><td style="text-align:left;border:solid 1px;white-space:nowrap" >  ‍org.codehaus.commons.nullanalysis.Nullable ‍ </td></tr>
<tr><td style="text-align:left;border:solid 1px;white-space:nowrap" >  ‍org.eclipse.jdt.annotation.Nullable ‍ </td></tr>
<tr><td style="text-align:left;border:solid 1px;white-space:nowrap" >  ‍org.eclipse.jgit.annotations.Nullable ‍ </td></tr>
<tr><td style="text-align:left;border:solid 1px;white-space:nowrap" >  ‍org.jetbrains.annotations.Nullable ‍ </td></tr>
<tr><td style="text-align:left;border:solid 1px;white-space:nowrap" >  ‍org.jetbrains.annotations.UnknownNullability ‍ </td></tr>
<tr><td style="text-align:left;border:solid 1px;white-space:nowrap" >  ‍org.jmlspecs.annotation.Nullable ‍ </td></tr>
<tr><td style="text-align:left;border:solid 1px;white-space:nowrap" >  ‍org.jspecify.annotations.Nullable ‍ </td></tr>
<tr><td style="text-align:left;border:solid 1px;white-space:nowrap" >  ‍org.jspecify.nullness.Nullable ‍ </td></tr>
<tr><td style="text-align:left;border:solid 1px;white-space:nowrap" >  ‍org.jspecify.nullness.NullnessUnspecified ‍ </td></tr>
<tr><td style="text-align:left;border:solid 1px;white-space:nowrap" >  ‍org.netbeans.api.annotations.common.CheckForNull ‍ </td></tr>
<tr><td style="text-align:left;border:solid 1px;white-space:nowrap" >  ‍org.netbeans.api.annotations.common.NullAllowed ‍ </td></tr>
<tr><td style="text-align:left;border:solid 1px;white-space:nowrap" >  ‍org.netbeans.api.annotations.common.NullUnknown ‍ </td></tr>
<tr><td style="text-align:left;border:solid 1px;white-space:nowrap" >  ‍org.springframework.lang.Nullable ‍ </td></tr>
<tr><td style="text-align:left;border:solid 1px;white-space:nowrap" >  ‍reactor.util.annotation.Nullable ‍ </td></tr>
</table></td><td style="text-align:left;white-space:nowrap" >⇒
 ‍org.checkerframework.checker.nullness.qual.Nullable ‍
</td></tr>
</table>
</div>
<div class="caption"><table style="border-spacing:6px;border-collapse:separate;" class="cellpading0"><tr><td style="vertical-align:top;text-align:left;" >Figure 3.3: Correspondence between other nullness annotations and the
Checker Framework’s <span style="font-family:monospace">Nullable</span> annotation.</td></tr>
</table></div>
<a id="fig-nullness-refactoring-nullable"></a>
<div class="center"><hr class="floatrule"></div></blockquote><blockquote class="figure"><div class="center"><hr class="floatrule"></div>
<div class="center">
<table style="border-spacing:6px;border-collapse:separate;" class="cellpading0"><tr><td style="text-align:left;white-space:nowrap" ><table border=1  style="border-spacing:0;" class="cellpadding1"><tr><td style="text-align:left;border:solid 1px;white-space:nowrap" >  ‍com.google.protobuf.Internal.ProtoPassThroughNullness ‍ </td></tr>
</table></td><td style="text-align:left;white-space:nowrap" >⇒
 ‍org.checkerframework.checker.nullness.qual.PolyNull ‍
</td></tr>
</table>
</div>
<div class="caption"><table style="border-spacing:6px;border-collapse:separate;" class="cellpading0"><tr><td style="vertical-align:top;text-align:left;" >Figure 3.4: Correspondence between other nullness annotations and the
Checker Framework’s <span style="font-family:monospace">PolyNull</span> annotation.</td></tr>
</table></div>
<a id="fig-nullness-refactoring-polynull"></a>
<div class="center"><hr class="floatrule"></div></blockquote><p>The Checker Framework may issue more or fewer errors than another tool.
This is expected, since each tool uses a different analysis. Remember that
the Checker Framework aims at soundness: it aims to never miss a possible
null dereference, while at the same time limiting false reports. Also,
note SpotBugs’s non-standard meaning for <span style="font-family:monospace">@Nullable</span>
(Section ‍<a href="#findbugs-nullable">3.7.2</a>).</p><p>Java permits you to import at most one annotation of a given name. For
example, if you use both <span style="font-family:monospace">android.annotation.NonNull</span> and
<span style="font-family:monospace">lombok.NonNull</span> in your source code, then you must write at least one of
them in fully-qualified form, as <span style="font-family:monospace">@android.annotation.NonNull</span> rather than
as <span style="font-family:monospace">@NonNull</span>.</p>
<!--TOC subsection id="choosing-nullness-tool" Which tool is right for you?-->
<h3 id="choosing-nullness-tool" class="subsection">3.7.1 Which tool is right for you? <a href="#choosing-nullness-tool"><img src="chainlink.svg" width="10" height="10"></a></h3><!--SEC END --><p>Different tools are appropriate in different circumstances.
Section ‍<a href="#faq-type-checking-vs-bug-detectors">38.10.1</a> compares verification
tools like the Checker Framework with bug detectors like SpotBugs and Error
Prone. In brief, a bug detector is easier to use because it requires fewer
annotations, but it misses lots of real bugs that a verifier finds. You
should use whichever tool is appropriate for the importance of your code.</p><p>You may also choose to use multiple tools, especially since each tool
focuses on different types of errors. If you know that you will eventually
want to do verification for some particular task (say, nullness checking),
there is little point using the nullness analysis of bug detector such as
SpotBugs first. It is easier to go straight to using the
Checker Framework.</p><p>If some other tool discovers a nullness error that the Checker
Framework does not, please report it to us (see
Section ‍<a href="#reporting-bugs">39.2</a>) so that we can enhance the Checker Framework.
For example, SpotBugs might detect an error that the Nullness Checker does
not, if you are using an unnannotated library (including an unannotated
part of the JDK) and running the Checker Framework in an unsound mode (see
Section ‍<a href="#checker-options">2.2.2</a>).</p>
<!--TOC subsection id="findbugs-nullable" Incompatibility note about FindBugs and SpotBugs <span style="font-family:monospace">@Nullable</span>-->
<h3 id="findbugs-nullable" class="subsection">3.7.2 Incompatibility note about FindBugs and SpotBugs <span style="font-family:monospace">@Nullable</span><span style="font-family:monospace"> </span><a href="#findbugs-nullable"><span style="font-family:monospace"><img src="chainlink.svg" width="10" height="10"></span></a></h3><!--SEC END --><p>FindBugs and SpotBugs have a non-standard definition of
<span style="font-family:monospace">@Nullable</span>. This treatment is not documented in its own
<a href="https://www.javadoc.io/doc/com.github.spotbugs/spotbugs-annotations/latest/edu/umd/cs/findbugs/annotations/Nullable.html">Javadoc</a>;
it is different from the definition of <span style="font-family:monospace">@Nullable</span> in every other tool for
nullness analysis; it means the same thing as <span style="font-family:monospace">@NonNull</span> when applied to a
formal parameter; and it invariably surprises programmers. Thus, SpotBugs’s
<span style="font-family:monospace">@Nullable</span> is detrimental rather than useful as documentation.
In practice, your best bet is to not rely on SpotBugs for nullness analysis,
even if you find SpotBugs useful for other purposes.</p><p>You can skip the rest of this section unless you wish to learn more details.</p><p>SpotBugs suppresses all warnings at uses of a <span style="font-family:monospace">@Nullable</span> variable.
(You have to use <span style="font-family:monospace">@CheckForNull</span> to
indicate a nullable variable that SpotBugs should check.) For example:</p><pre class="verbatim">     // declare getObject() to possibly return null
     @Nullable Object getObject() { ... }

     void myMethod() {
       @Nullable Object o = getObject();
       // SpotBugs issues no warning about calling toString on a possibly-null reference!
       o.toString();
     }
</pre><p>The Checker Framework does not emulate this non-standard behavior of
SpotBugs, even if the code uses FindBugs/SpotBugs annotations.</p><p>With SpotBugs, you annotate a declaration, which suppresses checking at
<em>all</em> client uses, even the places that you want to check.
It is better to suppress warnings at only the specific client uses
where the value is known to be non-null; the Checker Framework supports
this, if you write <span style="font-family:monospace">@SuppressWarnings</span> at the client uses.
The Checker Framework also supports suppressing checking at all client uses,
by writing a <span style="font-family:monospace">@SuppressWarnings</span> annotation at the declaration site.
Thus, the Checker Framework supports both use cases, whereas SpotBugs
supports only one and gives the programmer less flexibility.</p><p>In general, the Checker Framework will issue more warnings than SpotBugs,
and some of them may be about real bugs in your program.
See Section ‍<a href="#suppressing-warnings-nullness">3.4</a> for information about
suppressing nullness warnings.</p><p>FindBugs and SpotBugs made a poor choice of names. The choice of names should make a
clear distinction between annotations that specify whether a reference is
null, and annotations that suppress false warnings. The choice of names
should also have been consistent for other tools, and intuitively clear to
programmers. The FindBugs/SpotBugs choices make the SpotBugs annotations less
helpful to people, and much less useful for other tools.</p><p>Another problem is that the SpotBugs <span style="font-family:monospace">@Nullable</span> annotation is a
declaration annotation rather than a type annotation. This means that it
cannot be written in important locations such as type arguments, and it is
misleading when written on a field of array type or a method that returns
an array.</p><p>Overall, it is best to stay away from the SpotBugs nullness annotations and
analysis, and use a tool with a more principled design.</p>
<!--TOC subsection id="nullness-vs-optional" Relationship to <span style="font-family:monospace">Optional&lt;T&gt;</span>-->
<h3 id="nullness-vs-optional" class="subsection">3.7.3 Relationship to <span style="font-family:monospace">Optional&lt;T&gt;</span><span style="font-family:monospace"> </span><a href="#nullness-vs-optional"><span style="font-family:monospace"><img src="chainlink.svg" width="10" height="10"></span></a></h3><!--SEC END --><p>Many null pointer exceptions occur because the programmer forgets to check
whether a reference is null before dereferencing it. Java 8’s
<a href="https://docs.oracle.com/en/java/javase/17/docs/api/java.base/java/util/Optional.html"><span style="font-family:monospace">Optional&lt;T&gt;</span></a>
class provides a partial solution: a programmer must call the <span style="font-family:monospace">get</span> method to
access the value, and the designers of <span style="font-family:monospace">Optional</span> hope that the syntactic
occurrence of the <span style="font-family:monospace">get</span> method will remind programmers to first check that
the value is present. This is still easy to forget, however.</p><p>The Checker Framework contains an Optional Checker (see
Chapter ‍<a href="#optional-checker">5</a>) that guarantees that programmers use
<span style="font-family:monospace">Optional</span> correctly, such as calling <span style="font-family:monospace">isPresent</span> before calling <span style="font-family:monospace">get</span>.</p><p>There are some limitations to the utility of <span style="font-family:monospace">Optional</span>, which might
lead to you choose to use regular Java references rather than <span style="font-family:monospace">Optional</span>.
(For more details, see the article
<a href="https://homes.cs.washington.edu/~mernst/advice/nothing-is-better-than-optional.html">“Nothing
is better than the <span style="font-family:monospace">Optional</span> type”</a>.)</p><ul class="itemize"><li class="li-itemize">
It is still possible to call <span style="font-family:monospace">get</span> on a non-present <span style="font-family:monospace">Optional</span>, leading
to a <span style="font-family:monospace">NoSuchElementException</span>. In other words, <span style="font-family:monospace">Optional</span>
doesn’t solve the underlying problem — it merely converts a
<span style="font-family:monospace">NullPointerException</span> into a <span style="font-family:monospace">NoSuchElementException</span>
exception, and in either case your code crashes.
</li><li class="li-itemize"><span style="font-family:monospace">NullPointerException</span> is still possible in code that uses <span style="font-family:monospace">Optional</span>.
</li><li class="li-itemize"><span style="font-family:monospace">Optional</span> adds syntactic complexity, making your code longer and harder to
read.
</li><li class="li-itemize"><span style="font-family:monospace">Optional</span> adds time and space overhead.
</li><li class="li-itemize"><span style="font-family:monospace">Optional</span> does not address important sources of null pointer
exceptions, such as partially-initialized objects and calls to <span style="font-family:monospace">Map.get</span>.
</li></ul><p>The Nullness Checker does not suffer these limitations. Furthermore, it
works with existing code and types, it ensures that you check for null
wherever necessary, and it infers when the check for null is not necessary
based on previous statements in the method.</p><p>Java’s <span style="font-family:monospace">Optional</span> class provides utility routines to reduce clutter when
using <span style="font-family:monospace">Optional</span>. The Nullness Checker provides an
<a href="../api/org/checkerframework/checker/nullness/util/Opt.html"><span style="font-family:monospace">Opt</span></a> class that provides all the same methods,
but written for regular possibly-null Java references.
To use the <a href="../api/org/checkerframework/checker/nullness/util/Opt.html"><span style="font-family:monospace">Opt</span></a> class, the
<span style="font-family:monospace">checker-util.jar</span> file must be on the classpath at run time.</p>
<!--TOC section id="initialization-checker" Initialization Checker-->
<h2 id="initialization-checker" class="section">3.8 Initialization Checker <a href="#initialization-checker"><img src="chainlink.svg" width="10" height="10"></a></h2><!--SEC END --><p>The Initialization Checker determines whether an object is initialized or
not. For any object that is not fully initialized, the Nullness Checker
treats its fields as possibly-null — even fields annotated as
<span style="font-family:monospace">@NonNull</span>.
(The Initialization Checker focuses on <span style="font-family:monospace">@NonNull</span> fields, to detect null
pointer exceptions when using them. It does not
currently ensure that primitives or <span style="font-family:monospace">@Nullable</span> fields are initialized.
Use the Initialized Fields Checker
(Chapter ‍<a href="#initialized-fields-checker">25</a>) to check initialization with
respect to properties other than nullness.)</p><p>Every object’s fields start out as null. By the time the constructor
finishes executing, the <span style="font-family:monospace">@NonNull</span> fields have been set to a different
value. Your code can suffer a NullPointerException when using a
<span style="font-family:monospace">@NonNull</span> field, if your code uses the field during initialization.
The Nullness Checker prevents this problem by warning you anytime that you
may be accessing an uninitialized field. This check is useful because it
prevents errors in your code. However, the analysis can be confusing to
understand. If you wish to disable the initialization checks, see
Section ‍<a href="#initialization-checking-suppressing-warnings">3.8.8</a>.</p><p>An object is partially initialized from the time that its constructor starts until its constructor
finishes. This is relevant to the Nullness Checker because while the
constructor is executing — that is, before initialization completes —
a <span style="font-family:monospace">@NonNull</span>
field may be observed to be null, until that field is set. In
particular, the Nullness Checker issues a warning for code like this:</p><pre class="verbatim">  public class MyClass {
    private @NonNull Object f;
    public MyClass(int x) {
      // Error because constructor contains no assignment to this.f.
      // By the time the constructor exits, f must be initialized to a non-null value.
    }
    public MyClass(int x, int y) {
      // Error because this.f is accessed before f is initialized.
      // At the beginning of the constructor's execution, accessing this.f
      // yields null, even though field f has a non-null type.
      this.f.toString();
      f = new Object();
    }
    public MyClass(int x, int y, int z) {
      m();
      f = new Object();
    }
    public void m() {
      // Error because this.f is accessed before f is initialized,
      // even though the access is not in a constructor.
      // When m is called from the constructor, accessing f yields null,
      // even though field f has a non-null type.
      this.f.toString();
    }
</pre><p>When a field <span style="font-family:monospace">f</span> is declared with a <a href="../api/org/checkerframework/checker/nullness/qual/NonNull.html"><span style="font-family:monospace">@NonNull</span></a>
type, then code can depend on the fact that the field is not <span style="font-family:monospace">null</span>.
However, this guarantee does not hold for a partially-initialized object.</p><p>The Initialization Checker uses three annotations to indicate whether an object
is initialized (all its <span style="font-family:monospace">@NonNull</span> fields have been assigned), under
initialization (its constructor is currently executing), or its
initialization state is unknown.</p><p>These distinctions are mostly relevant within the constructor, or for
references to <span style="font-family:monospace">this</span> that escape the constructor (say, by being stored
in a field or passed to a method before initialization is complete).
Use of initialization annotations is rare in most code.</p>
<!--TOC subsection id="initialization-qualifiers" Initialization qualifiers-->
<h3 id="initialization-qualifiers" class="subsection">3.8.1 Initialization qualifiers <a href="#initialization-qualifiers"><img src="chainlink.svg" width="10" height="10"></a></h3><!--SEC END --><blockquote class="figure"><div class="center"><hr class="floatrule"></div>
<div class="center">
<img src="initialization.svg">
</div>
<div class="caption"><table style="border-spacing:6px;border-collapse:separate;" class="cellpading0"><tr><td style="vertical-align:top;text-align:left;" >Figure 3.5: Partial type hierarchy for the Initialization type system.
<span style="font-family:monospace">@UnknownInitialization</span> and <span style="font-family:monospace">@UnderInitialization</span> each take an
optional parameter indicating how far initialization has proceeded, and
the right side of the figure illustrates its type hierarchy in more detail.</td></tr>
</table></div>
<a id="fig-initialization-hierarchy"></a>
<div class="center"><hr class="floatrule"></div></blockquote><p>The initialization hierarchy is shown in Figure ‍<a href="#fig-initialization-hierarchy">3.5</a>.
The initialization hierarchy contains these qualifiers:</p><dl class="description"><dt class="dt-description"><a href="../api/org/checkerframework/checker/initialization/qual/Initialized.html"><span style="font-weight:bold"><span style="font-family:monospace">@Initialized</span></span></a></dt><dd class="dd-description">
indicates a type that contains a fully-initialized object. <span style="font-family:monospace">Initialized</span>
is the default, so there is little need for a programmer to write this
explicitly.</dd><dt class="dt-description"><a href="../api/org/checkerframework/checker/initialization/qual/UnknownInitialization.html"><span style="font-weight:bold"><span style="font-family:monospace">@UnknownInitialization</span></span></a></dt><dd class="dd-description">
indicates a type that may contain a partially-initialized object. In a
partially-initialized object, fields that are annotated as
<a href="../api/org/checkerframework/checker/nullness/qual/NonNull.html"><span style="font-family:monospace">@NonNull</span></a> may be null because the field
has not yet been assigned.<p><span style="font-family:monospace">@UnknownInitialization</span> takes a parameter that is the class the object
is definitely initialized up to. For instance, the type
<span style="font-family:monospace">@UnknownInitialization(Foo.class)</span> denotes an object in which every
fields declared in <span style="font-family:monospace">Foo</span> or its superclasses is initialized, but other
fields might not be.
Just <span style="font-family:monospace">@UnknownInitialization</span> is equivalent to
<span style="font-family:monospace">@UnknownInitialization(Object.class)</span>.</p></dd><dt class="dt-description"><a href="../api/org/checkerframework/checker/initialization/qual/UnderInitialization.html"><span style="font-weight:bold"><span style="font-family:monospace">@UnderInitialization</span></span></a></dt><dd class="dd-description">
indicates a type that contains a partially-initialized object that is
under initialization — that is, its constructor is currently executing.
It is otherwise the same as <span style="font-family:monospace">@UnknownInitialization</span>. Within the
constructor, <span style="font-family:monospace">this</span> has
<a href="../api/org/checkerframework/checker/initialization/qual/UnderInitialization.html"><span style="font-family:monospace">@UnderInitialization</span></a> type until
all the <span style="font-family:monospace">@NonNull</span> fields have been assigned.</dd></dl><p>A partially-initialized object (<span style="font-family:monospace">this</span> in a constructor) may be
passed to a helper method or stored in a variable; if so, the method
receiver, or the field, would have to be annotated as
<span style="font-family:monospace">@UnknownInitialization</span> or as <span style="font-family:monospace">@UnderInitialization</span>.</p><p>If a reference has
<span style="font-family:monospace">@UnknownInitialization</span> or <span style="font-family:monospace">@UnderInitialization</span> type, then all of its <span style="font-family:monospace">@NonNull</span> fields are treated as
<a href="../api/org/checkerframework/checker/nullness/qual/MonotonicNonNull.html"><span style="font-family:monospace">@MonotonicNonNull</span></a>: when read, they are
treated as being <a href="../api/org/checkerframework/checker/nullness/qual/Nullable.html"><span style="font-family:monospace">@Nullable</span></a>, but when
written, they are treated as being
<a href="../api/org/checkerframework/checker/nullness/qual/NonNull.html"><span style="font-family:monospace">@NonNull</span></a>.</p><p>
The initialization hierarchy is orthogonal to the nullness hierarchy. It
is legal for a reference to be <span style="font-family:monospace">@NonNull @UnderInitialization</span>, <span style="font-family:monospace">@Nullable @UnderInitialization</span>,
<span style="font-family:monospace">@NonNull @Initialized</span>, or <span style="font-family:monospace">@Nullable @Initialized</span>. The nullness hierarchy tells
you about the reference itself: might the reference be null? The initialization
hierarchy tells you about the <span style="font-family:monospace">@NonNull</span> fields in the referred-to object:
might those fields be temporarily null in contravention of their
type annotation?
Figure ‍<a href="#fig-initialization-examples">3.6</a> contains some examples.
</p><blockquote class="figure"><div class="center"><hr class="floatrule"></div>
<table border=1  style="border-spacing:0;" class="cellpadding1"><tr><td style="text-align:left;border:solid 1px;white-space:nowrap" >Declarations</td><td style="text-align:left;border:solid 1px;white-space:nowrap" >Expression</td><td style="text-align:left;border:solid 1px;white-space:nowrap" >Expression’s nullness type, or checker error </td></tr>
<tr><td style="text-align:left;border:solid 1px;white-space:nowrap" ><div class="minipage">
<pre class="verbatim">class C {
  @NonNull Object f;
  @Nullable Object g;
  ...
}
</pre>
</div></td><td style="text-align:left;border:solid 1px;white-space:nowrap" >&nbsp;</td><td style="text-align:left;border:solid 1px;white-space:nowrap" >&nbsp;</td></tr>
<tr><td style="text-align:left;border:solid 1px;white-space:nowrap" ><span style="font-family:monospace">@NonNull @Initialized C a;</span></td><td style="text-align:left;border:solid 1px;white-space:nowrap" ><span style="font-family:monospace">a</span></td><td style="text-align:left;border:solid 1px;white-space:nowrap" ><span style="font-family:monospace">@NonNull</span> </td></tr>
<tr><td style="text-align:left;border:solid 1px;white-space:nowrap" >&nbsp;</td><td style="text-align:left;border:solid 1px;white-space:nowrap" ><span style="font-family:monospace">a.f</span></td><td style="text-align:left;border:solid 1px;white-space:nowrap" ><span style="font-family:monospace">@NonNull</span> </td></tr>
<tr><td style="text-align:left;border:solid 1px;white-space:nowrap" >&nbsp;</td><td style="text-align:left;border:solid 1px;white-space:nowrap" ><span style="font-family:monospace">a.g</span></td><td style="text-align:left;border:solid 1px;white-space:nowrap" ><span style="font-family:monospace">@Nullable</span> </td></tr>
<tr><td style="text-align:left;border:solid 1px;white-space:nowrap" ><span style="font-family:monospace">@NonNull @UnderInitialization C b;</span></td><td style="text-align:left;border:solid 1px;white-space:nowrap" ><span style="font-family:monospace">b</span></td><td style="text-align:left;border:solid 1px;white-space:nowrap" ><span style="font-family:monospace">@NonNull</span> </td></tr>
<tr><td style="text-align:left;border:solid 1px;white-space:nowrap" >&nbsp;</td><td style="text-align:left;border:solid 1px;white-space:nowrap" ><span style="font-family:monospace">b.f</span></td><td style="text-align:left;border:solid 1px;white-space:nowrap" ><span style="font-family:monospace">@MonotonicNonNull</span> </td></tr>
<tr><td style="text-align:left;border:solid 1px;white-space:nowrap" >&nbsp;</td><td style="text-align:left;border:solid 1px;white-space:nowrap" ><span style="font-family:monospace">b.g</span></td><td style="text-align:left;border:solid 1px;white-space:nowrap" ><span style="font-family:monospace">@Nullable</span> </td></tr>
<tr><td style="text-align:left;border:solid 1px;white-space:nowrap" ><span style="font-family:monospace">@Nullable @Initialized C c;</span></td><td style="text-align:left;border:solid 1px;white-space:nowrap" ><span style="font-family:monospace">c</span></td><td style="text-align:left;border:solid 1px;white-space:nowrap" ><span style="font-family:monospace">@Nullable</span> </td></tr>
<tr><td style="text-align:left;border:solid 1px;white-space:nowrap" >&nbsp;</td><td style="text-align:left;border:solid 1px;white-space:nowrap" ><span style="font-family:monospace">c.f</span></td><td style="text-align:left;border:solid 1px;white-space:nowrap" >error: deref of nullable </td></tr>
<tr><td style="text-align:left;border:solid 1px;white-space:nowrap" >&nbsp;</td><td style="text-align:left;border:solid 1px;white-space:nowrap" ><span style="font-family:monospace">c.g</span></td><td style="text-align:left;border:solid 1px;white-space:nowrap" >error: deref of nullable </td></tr>
<tr><td style="text-align:left;border:solid 1px;white-space:nowrap" ><span style="font-family:monospace">@Nullable @UnderInitialization C d;</span></td><td style="text-align:left;border:solid 1px;white-space:nowrap" ><span style="font-family:monospace">d</span></td><td style="text-align:left;border:solid 1px;white-space:nowrap" ><span style="font-family:monospace">@Nullable</span> </td></tr>
<tr><td style="text-align:left;border:solid 1px;white-space:nowrap" >&nbsp;</td><td style="text-align:left;border:solid 1px;white-space:nowrap" ><span style="font-family:monospace">d.f</span></td><td style="text-align:left;border:solid 1px;white-space:nowrap" >error: deref of nullable </td></tr>
<tr><td style="text-align:left;border:solid 1px;white-space:nowrap" >&nbsp;</td><td style="text-align:left;border:solid 1px;white-space:nowrap" ><span style="font-family:monospace">d.g</span></td><td style="text-align:left;border:solid 1px;white-space:nowrap" >error: deref of nullable </td></tr>
</table>
<div class="caption"><table style="border-spacing:6px;border-collapse:separate;" class="cellpading0"><tr><td style="vertical-align:top;text-align:left;" >Figure 3.6: Examples of the interaction between nullness and initialization.
Declarations are shown at the left for reference, but the focus of the
table is the expressions and their nullness type or error.</td></tr>
</table></div>
<a id="fig-initialization-examples"></a>
<div class="center"><hr class="floatrule"></div></blockquote>
<!--TOC subsection id="becoming-initialized" How an object becomes initialized-->
<h3 id="becoming-initialized" class="subsection">3.8.2 How an object becomes initialized <a href="#becoming-initialized"><img src="chainlink.svg" width="10" height="10"></a></h3><!--SEC END --><p>Within the constructor,
<span style="font-family:monospace">this</span> starts out with <a href="../api/org/checkerframework/checker/initialization/qual/UnderInitialization.html"><span style="font-family:monospace">@UnderInitialization</span></a> type.
As soon as all of the <a href="../api/org/checkerframework/checker/nullness/qual/NonNull.html"><span style="font-family:monospace">@NonNull</span></a> fields
in class <span style="font-style:italic">C</span> have been initialized, then <span style="font-family:monospace">this</span> is treated as
<a href="../api/org/checkerframework/checker/initialization/qual/UnderInitialization.html"><span style="font-family:monospace">@UnderInitialization</span></a><span style="font-family:monospace">(</span><span style="font-family:monospace"><em>C</em></span><span style="font-family:monospace">)</span>.
This means that <span style="font-family:monospace">this</span> is still being initialized, but all
initialization of <span style="font-style:italic">C</span>’s fields is complete, including all fields of supertypes.
Eventually, when all constructors complete, the type is
<a href="../api/org/checkerframework/checker/initialization/qual/Initialized.html"><span style="font-family:monospace">@Initialized</span></a>.</p><p>The Initialization Checker issues an error if the constructor fails to initialize
any <span style="font-family:monospace">@NonNull</span> field. This ensures that the object is in a legal (initialized)
state by the time that the constructor exits.
This is different than Java’s test for definite assignment (see
<a href="https://docs.oracle.com/javase/specs/jls/se17/html/jls-16.html">JLS ch.16</a>),
which does not apply to fields (except blank final ones, defined in
<a href="https://docs.oracle.com/javase/specs/jls/se17/html/jls-4.html#jls-4.12.4">JLS §4.12.4</a>) because fields
have a default value of null.</p><p>All <span style="font-family:monospace">@NonNull</span> fields must either have a
default in the field declaration, or be assigned in the constructor or in a
helper method that the constructor calls. If
your code initializes (some) fields in a helper method, you will need to
annotate the helper method with an annotation such as
<a href="../api/org/checkerframework/checker/nullness/qual/EnsuresNonNull.html"><span style="font-family:monospace">@EnsuresNonNull</span></a><span style="font-family:monospace">({"field1", "field2"})</span>
for all the fields that the helper method assigns.</p>
<!--TOC subsection id="underinitialization-examples" <span style="font-family:monospace">@UnderInitialization</span> examples-->
<h3 id="underinitialization-examples" class="subsection">3.8.3 <span style="font-family:monospace">@UnderInitialization</span> examples <a href="#underinitialization-examples"><img src="chainlink.svg" width="10" height="10"></a></h3><!--SEC END --><p>The most common use for the <span style="font-family:monospace">@UnderInitialization</span> annotation is for a
helper routine that is called by constructor. For example:</p><pre class="verbatim">  class MyClass {
    Object field1;
    Object field2;
    Object field3;

    public MyClass(String arg1) {
      this.field1 = arg1;
      init_other_fields();
    }

    // A helper routine that initializes all the fields other than field1.
    @EnsuresNonNull({"field2", "field3"})
    private void init_other_fields(@UnderInitialization(Object.class) MyClass this) {
      field2 = new Object();
      field3 = new Object();
    }

    public MyClass(String arg1, String arg2, String arg3) {
      this.field1 = arg1;
      this.field2 = arg2;
      this.field3 = arg3;
      checkRep();
    }

    // Verify that the representation invariants are satisfied.
    // Works as long as the MyClass fields are initialized, even if the receiver's
    // class is a subclass of MyClass and not all of the subclass fields are initialized.
    private void checkRep(@UnderInitialization(MyClass.class) MyClass this) {
      ...
    }


  }
</pre><p>At the end of the constructor, <span style="font-family:monospace">this</span> is not fully initialized. Rather,
it is <span style="font-family:monospace">@UnderInitialization(</span><span style="font-family:monospace"><em>CurrentClass.class</em></span><span style="font-family:monospace">)</span>.
The reason is that there might be subclasses with uninitialized fields.
The following example illustrates this:</p><pre class="verbatim">class A {
   @NonNull String a;
   public A() {
       a = "";
       // Now, all fields of A are initialized.
       // However, if this constructor is invoked as part of 'new B()', then
       // the fields of B are not yet initialized.
       // If we would type 'this' as @Initialized, then the following call is valid:
       doSomething();
   }
   void doSomething() {}
}

class B extends A {
   @NonNull String b;
   @Override
   void doSomething() {
       // Dereferencing 'b' is ok, because 'this' is @Initialized and 'b' @NonNull.
       // However, when executing 'new B()', this line throws a null-pointer exception.
       b.toString();
   }
}
</pre>
<!--TOC subsection id="partial-initialization" Partial initialization-->
<h3 id="partial-initialization" class="subsection">3.8.4 Partial initialization <a href="#partial-initialization"><img src="chainlink.svg" width="10" height="10"></a></h3><!--SEC END --><p>So far, we have discussed initialization as if it is an all-or-nothing property:
an object is non-initialized until initialization completes, and then it is initialized. The full truth is a bit more complex: during the
initialization process an object can be partially initialized, and as the
object’s superclass constructors complete, its initialization status is updated. The
Initialization Checker lets you express such properties when necessary.</p><p>Consider a simple example:</p><pre class="verbatim">class A {
  Object aField;
  A() {
    aField = new Object();
  }
}
class B extends A {
  Object bField;
  B() {
    super();
    bField = new Object();
  }
}
</pre><p>Consider what happens during execution of <span style="font-family:monospace">new B()</span>.</p><ol class="enumerate" type=1><li class="li-enumerate">
<span style="font-family:monospace">B</span>’s constructor begins to execute. At this point, neither the
fields of <span style="font-family:monospace">A</span> nor those of <span style="font-family:monospace">B</span> have been initialized yet.
</li><li class="li-enumerate"><span style="font-family:monospace">B</span>’s constructor calls <span style="font-family:monospace">A</span>’s constructor, which begins to execute.
No fields of <span style="font-family:monospace">A</span> nor of <span style="font-family:monospace">B</span> have been initialized yet.
</li><li class="li-enumerate"><span style="font-family:monospace">A</span>’s constructor completes. Now, all the fields of <span style="font-family:monospace">A</span> have been
initialized, and their invariants (such as that field <span style="font-family:monospace">a</span> is non-null) can be
depended on. However, because <span style="font-family:monospace">B</span>’s constructor has not yet completed
executing, the object being constructed is not yet fully initialized.
</li><li class="li-enumerate"><span style="font-family:monospace">B</span>’s constructor completes. The fields declared in <span style="font-family:monospace">A</span> and <span style="font-family:monospace">B</span>
are initialized. However, the type system cannot assume that the object
is fully initialized — there might be a <span style="font-family:monospace">class C extends B {...}</span>,
and <span style="font-family:monospace">B</span>’s constructor might have been invoked from that.
</li></ol><p>At any moment during initialization, the superclasses of a given class
can be divided into those that have completed initialization and those that
have not yet completed initialization. More precisely, at any moment there
is a point in the class hierarchy such that all the classes above that
point are fully initialized, and all those below it are not yet
initialized. As initialization proceeds, this dividing line between the
initialized and uninitialized classes moves down the type hierarchy.</p><p>The Nullness Checker lets you indicate where the dividing line is between
the initialized and non-initialized classes.
The <span style="font-family:monospace">@UnderInitialization(</span><span style="font-family:monospace"><em>classliteral</em></span><span style="font-family:monospace">)</span>
indicates the first class that is known to be fully initialized.
When you write <a href="../api/org/checkerframework/checker/initialization/qual/UnderInitialization.html"><span style="font-family:monospace">@UnderInitialization</span></a><span style="font-family:monospace">(OtherClass.class) MyClass x;</span>, that
means that variable <span style="font-family:monospace">x</span> is initialized for <span style="font-family:monospace">OtherClass</span> and its
superclasses, and <span style="font-family:monospace">x</span> is (possibly) uninitialized for subclasses of <span style="font-family:monospace">OtherClass</span>.</p><p>The example above lists 4 moments during construction. At those moments,
the type of the object being constructed is:</p><ol class="enumerate" type=1><li class="li-enumerate">
<span style="font-family:monospace">@UnderInitialization B</span>
</li><li class="li-enumerate"><span style="font-family:monospace">@UnderInitialization A</span>
</li><li class="li-enumerate"><span style="font-family:monospace">@UnderInitialization(A.class) A</span>
</li><li class="li-enumerate"><span style="font-family:monospace">@UnderInitialization(B.class) B</span>
</li></ol><p>Note that neither <span style="font-family:monospace">@UnderInitialization(A.class) A</span> nor
<span style="font-family:monospace">@UnderInitialization(A.class) B</span> may be used where &lt;@Initialized A&gt; is
required. Permitting that would be unsound. For example, consider this
code, where all types are <span style="font-family:monospace">@NonNull</span> because <span style="font-family:monospace">@NonNull</span> is the default annotation:</p><pre class="verbatim">class A {
  Object aField;
  A() {
    aField = new Object();
  }
  Object get() {
    return aField;
  }
}
class B extends A {
  Object bField;
  B() {
    super();
    bField = new Object();
  }
  @Override
  Object get() {
    return bField;
  }
}
</pre><p>Given these declarations:</p><pre class="verbatim">@Initialized A w;
@Initialized B x;
@UnderInitialization(A.class) A y;
@UnderInitialization(A.class) B z;
</pre><p>the expressions <span style="font-family:monospace">w.get()</span> and <span style="font-family:monospace">x.get()</span> evaluate to a non-null value, but
<span style="font-family:monospace">y.get()</span> and <span style="font-family:monospace">z.get()</span> might evaluate to <span style="font-family:monospace">null</span>.
(<span style="font-family:monospace">y.get()</span> might evaluate to <span style="font-family:monospace">null</span> because the run-time type of <span style="font-family:monospace">y</span>
might be <span style="font-family:monospace">B</span>. That is, <span style="font-family:monospace">y</span> and <span style="font-family:monospace">z</span> might refer to the same value, just
as <span style="font-family:monospace">w</span> and <span style="font-family:monospace">x</span> might refer to the same value.)</p>
<!--TOC subsection id="initialization-constructor" Method calls from the constructor-->
<h3 id="initialization-constructor" class="subsection">3.8.5 Method calls from the constructor <a href="#initialization-constructor"><img src="chainlink.svg" width="10" height="10"></a></h3><!--SEC END --><p>Consider the following incorrect program.</p><pre class="verbatim">class A {
  Object aField;
  A() {
    aField = new Object();
    process(5);  // illegal call
  }
  public void process(int arg) { ... }
}
</pre><p>The call to <span style="font-family:monospace">process()</span> is not legal.
<span style="font-family:monospace">process()</span> is declared to be called on a fully-initialized receiver, which is
the default if you do not write a different initialization annotation.
At the call to <span style="font-family:monospace">process()</span>, all the fields of <span style="font-family:monospace">A</span> have been set,
but <span style="font-family:monospace">this</span> is not fully initialized because fields in subclasses of <span style="font-family:monospace">A</span> have
not yet been set. The type of <span style="font-family:monospace">this</span> is <span style="font-family:monospace">@UnderInitialization(A.class)</span>,
meaning that <span style="font-family:monospace">this</span> is partially-initialized, with the <span style="font-family:monospace">A</span> part of
initialization done but the initialization of subclasses not yet complete.</p><p>The Initialization Checker output indicates this problem:</p><pre class="verbatim">Client.java:7: error: [method.invocation.invalid] call to process(int) not allowed on the given receiver.
    process(5);  // illegal call
           ^
  found   : @UnderInitialization(A.class) A
  required: @Initialized A
</pre><p>Here is a subclass and client code that crashes with a <span style="font-family:monospace">NullPointerException</span>.</p><pre class="verbatim">class B extends A {
  List&lt;Integer&gt; processed;
  B() {
    super();
    processed = new ArrayList&lt;Integer&gt;();
  }
  @Override
  public void process(int arg) {
    super();
    processed.add(arg);
  }
}
class Client {
  public static void main(String[] args) {
    new B();
  }
}
</pre><p>You can correct the problem in multiple ways.</p><p>One solution is to not call methods that can be overridden from the
constructor: move the call to <span style="font-family:monospace">process()</span> to after the constructor has
completed.</p><p>Another solution is to change the declaration of <span style="font-family:monospace">process()</span>:</p><pre class="verbatim">  public void process(@UnderInitialization(A.class) A this, int arg) { ... }
</pre><p>If you choose this solution, you will need to rewrite the definition of
<span style="font-family:monospace">B.process()</span> so that it is consistent with the declared receiver type.</p><p>A non-solution is to prevent subclasses from overriding <span style="font-family:monospace">process()</span> by
using <span style="font-family:monospace">final</span> on the method. This doesn’t work because even if
<span style="font-family:monospace">process()</span> is not overridden, it might call other methods that are
overridden.</p><p>As final classes cannot have subclasses, they can be handled more
flexibly: once all fields of the final class have been
initialized, <span style="font-family:monospace">this</span> is fully initialized.</p>
<!--TOC subsection id="circular-initialization" Initialization of circular data structures-->
<h3 id="circular-initialization" class="subsection">3.8.6 Initialization of circular data structures <a href="#circular-initialization"><img src="chainlink.svg" width="10" height="10"></a></h3><!--SEC END --><p>There is one final aspect of the initialization type system to be
considered: the rules governing reading and writing to objects that are
currently under initialization (both reading from fields of objects under
initialization, as well as writing objects under initialization to fields).
By default, only fully-initialized objects can be stored in a field of
another object. If this was the only option, then it would not be possible
to create circular data structures (such as a doubly-linked list) where
fields have a <a href="../api/org/checkerframework/checker/nullness/qual/NonNull.html"><span style="font-family:monospace">@NonNull</span></a> type. However,
the annotation
<a href="../api/org/checkerframework/checker/initialization/qual/NotOnlyInitialized.html"><span style="font-family:monospace">@NotOnlyInitialized</span></a> can be used to
indicate that a field can store objects that are currently under initialization.
In this case, the rules for reading and writing to that field become a little
bit more interesting, to soundly support circular structures.</p><p>The rules for reading from a
<a href="../api/org/checkerframework/checker/initialization/qual/NotOnlyInitialized.html"><span style="font-family:monospace">@NotOnlyInitialized</span></a> field
are summarized in Figure ‍<a href="#fig-init-read-field">3.7</a>. Essentially, nothing is
known about the initialization status of the value returned unless the receiver
was <a href="../api/org/checkerframework/checker/initialization/qual/Initialized.html"><span style="font-family:monospace">@Initialized</span></a>.</p><blockquote class="figure"><div class="center"><div class="center"><hr class="floatrule"></div>
<table border=1  style="border-spacing:0;" class="cellpadding1"><tr><td style="text-align:left;border:solid 1px;white-space:nowrap" > <span style="font-family:monospace">x.f</span></td><td style="text-align:left;border:solid 1px;white-space:nowrap" ><span style="font-family:monospace">f</span> is <span style="font-family:monospace">@NonNull</span></td><td style="text-align:left;border:solid 1px;white-space:nowrap" ><span style="font-family:monospace">f</span> is <span style="font-family:monospace">@Nullable</span></td></tr>
<tr><td style="text-align:left;border:solid 1px;white-space:nowrap" > <span style="font-family:monospace">x</span> is <span style="font-family:monospace">@Initialized</span></td><td style="text-align:left;border:solid 1px;white-space:nowrap" ><span style="font-family:monospace">@Initialized @NonNull</span></td><td style="text-align:left;border:solid 1px;white-space:nowrap" ><span style="font-family:monospace">@Initialized @Nullable</span> </td></tr>
<tr><td style="text-align:left;border:solid 1px;white-space:nowrap" > <span style="font-family:monospace">x</span> is <span style="font-family:monospace">@UnderInitialization</span></td><td style="text-align:left;border:solid 1px;white-space:nowrap" ><span style="font-family:monospace">@UnknownInitialization @Nullable</span></td><td style="text-align:left;border:solid 1px;white-space:nowrap" ><span style="font-family:monospace">@UnknownInitialization @Nullable</span> </td></tr>
<tr><td style="text-align:left;border:solid 1px;white-space:nowrap" > <span style="font-family:monospace">x</span> is <span style="font-family:monospace">@UnknownInitialization</span></td><td style="text-align:left;border:solid 1px;white-space:nowrap" ><span style="font-family:monospace">@UnknownInitialization @Nullable</span></td><td style="text-align:left;border:solid 1px;white-space:nowrap" ><span style="font-family:monospace">@UnknownInitialization @Nullable</span> </td></tr>
</table>
<div class="caption"><table style="border-spacing:6px;border-collapse:separate;" class="cellpading0"><tr><td style="vertical-align:top;text-align:left;" >Figure 3.7: Initialization rules for reading a <a href="../api/org/checkerframework/checker/initialization/qual/NotOnlyInitialized.html"><span style="font-family:monospace">@NotOnlyInitialized</span></a> field <span style="font-family:monospace">f</span>.</td></tr>
</table></div>
<a id="fig-init-read-field"></a>
<div class="center"><hr class="floatrule"></div></div></blockquote><p>Similarly, Figure ‍<a href="#fig-init-write-field">3.8</a> shows under which conditions
an assignment <span style="font-family:monospace">x.f = y</span> is allowed for a
<a href="../api/org/checkerframework/checker/initialization/qual/NotOnlyInitialized.html"><span style="font-family:monospace">@NotOnlyInitialized</span></a> field <span style="font-family:monospace">f</span>.
If the receiver <span style="font-family:monospace">x</span> is
<a href="../api/org/checkerframework/checker/initialization/qual/UnderInitialization.html"><span style="font-family:monospace">@UnderInitialization</span></a>, then any
<span style="font-family:monospace">y</span> can be of any initialization state. If <span style="font-family:monospace">y</span> is known to be
fully initialized, then any receiver is allowed. All other assignments
are disallowed.</p><blockquote class="figure"><div class="center"><div class="center"><hr class="floatrule"></div>
<table border=1  style="border-spacing:0;" class="cellpadding1"><tr><td style="text-align:left;border:solid 1px;white-space:nowrap" > <span style="font-family:monospace">x.f = y</span></td><td style="text-align:center;border:solid 1px;white-space:nowrap" ><span style="font-family:monospace">y</span> is <span style="font-family:monospace">@Initialized</span></td><td style="text-align:center;border:solid 1px;white-space:nowrap" ><span style="font-family:monospace">y</span> is <span style="font-family:monospace">@UnderInitialization</span></td><td style="text-align:center;border:solid 1px;white-space:nowrap" ><span style="font-family:monospace">y</span> is <span style="font-family:monospace">@UnknownInitialization</span></td></tr>
<tr><td style="text-align:left;border:solid 1px;white-space:nowrap" > <span style="font-family:monospace">x</span> is <span style="font-family:monospace">@Initialized</span></td><td style="text-align:center;border:solid 1px;white-space:nowrap" >yes</td><td style="text-align:center;border:solid 1px;white-space:nowrap" >no</td><td style="text-align:center;border:solid 1px;white-space:nowrap" >no </td></tr>
<tr><td style="text-align:left;border:solid 1px;white-space:nowrap" > <span style="font-family:monospace">x</span> is <span style="font-family:monospace">@UnderInitialization</span></td><td style="text-align:center;border:solid 1px;white-space:nowrap" >yes</td><td style="text-align:center;border:solid 1px;white-space:nowrap" >yes</td><td style="text-align:center;border:solid 1px;white-space:nowrap" >yes </td></tr>
<tr><td style="text-align:left;border:solid 1px;white-space:nowrap" > <span style="font-family:monospace">x</span> is <span style="font-family:monospace">@UnknownInitialization</span></td><td style="text-align:center;border:solid 1px;white-space:nowrap" >yes</td><td style="text-align:center;border:solid 1px;white-space:nowrap" >no</td><td style="text-align:center;border:solid 1px;white-space:nowrap" >no </td></tr>
</table>
<div class="caption"><table style="border-spacing:6px;border-collapse:separate;" class="cellpading0"><tr><td style="vertical-align:top;text-align:left;" >Figure 3.8: Rules for deciding when an assignment <span style="font-family:monospace">x.f = y</span> is allowed for a
<a href="../api/org/checkerframework/checker/initialization/qual/NotOnlyInitialized.html"><span style="font-family:monospace">@NotOnlyInitialized</span></a> field <span style="font-family:monospace">f</span>.</td></tr>
</table></div>
<a id="fig-init-write-field"></a>
<div class="center"><hr class="floatrule"></div></div></blockquote><p>These rules allow for the safe initialization of circular structures. For instance,
consider a doubly linked list:</p><pre class="verbatim">  class List&lt;T&gt; {
    @NotOnlyInitialized
    Node&lt;T&gt; sentinel;

    public List() {
      this.sentinel = new Node&lt;&gt;(this);
    }

    void insert(@Nullable T data) {
      this.sentinel.insertAfter(data);
    }

    public static void main() {
      List&lt;Integer&gt; l = new List&lt;&gt;();
      l.insert(1);
      l.insert(2);
    }
  }

  class Node&lt;T&gt; {
    @NotOnlyInitialized
    Node&lt;T&gt; prev;

    @NotOnlyInitialized
    Node&lt;T&gt; next;

    @NotOnlyInitialized
    List parent;

    @Nullable
    T data;

    // for sentinel construction
    Node(@UnderInitialization List parent) {
      this.parent = parent;
      this.prev = this;
      this.next = this;
    }

    // for data node construction
    Node(Node&lt;T&gt; prev, Node&lt;T&gt; next, @Nullable T data) {
      this.parent = prev.parent;
      this.prev = prev;
      this.next = next;
      this.data = data;
    }

    void insertAfter(@Nullable T data) {
      Node&lt;T&gt; n = new Node&lt;&gt;(this, this.next, data);
      this.next.prev = n;
      this.next = n;
    }
  }
</pre>
<!--TOC subsection id="initialization-warnings" How to handle warnings-->
<h3 id="initialization-warnings" class="subsection">3.8.7 How to handle warnings <a href="#initialization-warnings"><img src="chainlink.svg" width="10" height="10"></a></h3><!--SEC END -->
<!--TOC subsubsection id="initialization-warnings-constructor" “error: the constructor does not initialize fields: …”-->
<h4 id="initialization-warnings-constructor" class="subsubsection">“error: the constructor does not initialize fields: …” <a href="#initialization-warnings-constructor"><img src="chainlink.svg" width="10" height="10"></a></h4><!--SEC END --><p>Like any warning, “error: the constructor does not initialize fields:
…” indicates that either your annotations are incorrect or your code
is buggy. You can fix either the annotations or the code.</p><ul class="itemize"><li class="li-itemize">
Declare the field as <a href="../api/org/checkerframework/checker/nullness/qual/Nullable.html"><span style="font-family:monospace">@Nullable</span></a>. Recall
that if you did not write an annotation, the field defaults to
<a href="../api/org/checkerframework/checker/nullness/qual/NonNull.html"><span style="font-family:monospace">@NonNull</span></a>.
</li><li class="li-itemize">Declare the field as <a href="../api/org/checkerframework/checker/nullness/qual/MonotonicNonNull.html"><span style="font-family:monospace">@MonotonicNonNull</span></a>.
This is appropriate if the field starts out as <span style="font-family:monospace">null</span> but is later set
to a non-null value. You may then wish to use the
<a href="../api/org/checkerframework/checker/nullness/qual/EnsuresNonNull.html"><span style="font-family:monospace">@EnsuresNonNull</span></a> annotation to indicate
which methods set the field, and the
<a href="../api/org/checkerframework/checker/nullness/qual/RequiresNonNull.html"><span style="font-family:monospace">@RequiresNonNull</span></a> annotation to indicate
which methods require the field to be non-null.
</li><li class="li-itemize">Initialize the field in the constructor or in the field’s initializer, if
the field should be initialized. (In this case, the Initialization
Checker has found a bug!)<p>Do <em>not</em> initialize the field to an arbitrary non-null value just to
eliminate the warning. Doing so degrades your code: it introduces a
value that will confuse other programmers, and it converts a clear
NullPointerException into a more obscure error.
</p></li></ul>
<!--TOC subsubsection id="initialization-warnings-receiver" “call to … is not allowed on the given receiver”-->
<h4 id="initialization-warnings-receiver" class="subsubsection">“call to … is not allowed on the given receiver” <a href="#initialization-warnings-receiver"><img src="chainlink.svg" width="10" height="10"></a></h4><!--SEC END --><p>If your code calls an instance method from a constructor, you may see a
message such as the following:</p><pre class="verbatim">MyFile.java:123: error: call to initHelper() not allowed on the given receiver.
    initHelper();
              ^
  found   : @UnderInitialization(com.google.Bar.class) @NonNull MyClass
  required: @Initialized @NonNull MyClass
</pre><p>The problem is that the current object (<span style="font-family:monospace">this</span>) is under initialization,
but the receiver formal parameter (Section ‍<a href="#faq-receiver">38.6.1</a>) of method
<span style="font-family:monospace">initHelper()</span> is implicitly annotated as
<a href="../api/org/checkerframework/checker/initialization/qual/Initialized.html"><span style="font-family:monospace">@Initialized</span></a>. If
<span style="font-family:monospace">initHelper()</span> doesn’t depend on its receiver being initialized — that
is, it’s OK to call <span style="font-family:monospace">x.initHelper</span> even if <span style="font-family:monospace">x</span> is not initialized —
then you can indicate that by using
<a href="../api/org/checkerframework/checker/initialization/qual/UnderInitialization.html"><span style="font-family:monospace">@UnderInitialization</span></a> or
<a href="../api/org/checkerframework/checker/initialization/qual/UnknownInitialization.html"><span style="font-family:monospace">@UnknownInitialization</span></a>.</p><pre class="verbatim">class MyClass {
  void initHelper(@UnknownInitialization MyClass this, String param1) { ... }
}
</pre><p>You are likely to want to annotate <span style="font-family:monospace">initHelper()</span> with
<a href="../api/org/checkerframework/checker/nullness/qual/EnsuresNonNull.html"><span style="font-family:monospace">@EnsuresNonNull</span></a> as well; see
Section ‍<a href="#nullness-method-annotations">3.2.2</a>.</p><p>You may get the “call to … is not allowed on the given receiver”
error even if your constructor has already initialized all the fields.
For this code:</p><pre class="verbatim">public class MyClass {
  @NonNull Object field;
  public MyClass() {
    field = new Object();
    helperMethod();
  }
  private void helperMethod() {
  }
}
</pre><p>the Nullness Checker issues the following warning:</p><pre class="verbatim">MyClass.java:7: error: call to helperMethod() not allowed on the given receiver.
    helperMethod();
                ^
  found   : @UnderInitialization(MyClass.class) @NonNull MyClass
  required: @Initialized @NonNull MyClass
1 error
</pre><p>
The reason is that even though the object under construction has had all
the fields declared in <span style="font-family:monospace">MyClass</span> initialized, there might be a subclass of
<span style="font-family:monospace">MyClass</span>. Thus, the receiver of <span style="font-family:monospace">helperMethod</span> should be declared as
<span style="font-family:monospace">@UnderInitialization(MyClass.class)</span>, which says that initialization has
completed for all the <span style="font-family:monospace">MyClass</span> fields but may not have been completed
overall. If <span style="font-family:monospace">helperMethod</span> had been a public method that could also be called after
initialization was actually complete, then the receiver should have type
<span style="font-family:monospace">@UnknownInitialization</span>, which is the supertype of
<span style="font-family:monospace">@UnknownInitialization</span> and <span style="font-family:monospace">@UnderInitialization</span>.
</p>
<!--TOC subsection id="initialization-checking-suppressing-warnings" Suppressing warnings-->
<h3 id="initialization-checking-suppressing-warnings" class="subsection">3.8.8 Suppressing warnings <a href="#initialization-checking-suppressing-warnings"><img src="chainlink.svg" width="10" height="10"></a></h3><!--SEC END --><p>To suppress most warnings related to partially-initialized values, use the
warning suppression string “initialization”.
You can write <span style="font-family:monospace">@SuppressWarnings("initialization")</span>
on a field, constructor, or
class, or pass the command-line argument
<span style="font-family:monospace">-AsuppressWarnings=initialization</span> when
running the Nullness Checker.
(For more about suppressing warnings, see
Chapter ‍<a href="#suppressing-warnings">32</a>.) You will no longer get a guarantee
of no null pointer exceptions, but you can still use the Nullness Checker
to find most of the null pointer problems in your code.</p><p>This suppresses warnings that are specific to the Initialization Checker,
but does not suppress warnings issued by the Checker Framework itself, such
as about assignments or method overriding.</p><p>It is not possible to completely disable initialization checking while
retaining nullness checking. That is because
of an implementation detail of the Nullness and Initialization Checkers:
they are actually the same checker, rather than being two separate checkers
that are aggregated together.</p>
<!--TOC subsection id="initialization-checking" More details about initialization checking-->
<h3 id="initialization-checking" class="subsection">3.8.9 More details about initialization checking <a href="#initialization-checking"><img src="chainlink.svg" width="10" height="10"></a></h3><!--SEC END -->
<!--TOC paragraph id="initialization-checking-method-annotations" Use of method annotations-->
<h5 id="initialization-checking-method-annotations" class="paragraph">Use of method annotations <a href="#initialization-checking-method-annotations"><img src="chainlink.svg" width="10" height="10"></a></h5><!--SEC END --><p>A method with a non-initialized receiver may assume that a few fields (but not all
of them) are non-null, and it sometimes sets some more fields to non-null
values. To express these concepts, use the
<a href="../api/org/checkerframework/checker/nullness/qual/RequiresNonNull.html"><span style="font-family:monospace">@RequiresNonNull</span></a>,
<a href="../api/org/checkerframework/checker/nullness/qual/EnsuresNonNull.html"><span style="font-family:monospace">@EnsuresNonNull</span></a>, and
<a href="../api/org/checkerframework/checker/nullness/qual/EnsuresNonNullIf.html"><span style="font-family:monospace">@EnsuresNonNullIf</span></a> method annotations;
see Section ‍<a href="#nullness-method-annotations">3.2.2</a>.</p>
<!--TOC paragraph id="initialization-checking-type-system" Source of the type system-->
<h5 id="initialization-checking-type-system" class="paragraph">Source of the type system <a href="#initialization-checking-type-system"><img src="chainlink.svg" width="10" height="10"></a></h5><!--SEC END --><p>The type system enforced by the Initialization Checker is based on
“Freedom Before Commitment” ‍[<a href="#SummersM2011">SM11</a>]. Our implementation
changes its initialization modifiers (“committed”, “free”, and
“unclassified”) to “initialized”, “unknown initialization”, and
“under initialization”. Our implementation also has several
enhancements. For example, it supports partial initialization (the
argument to the <span style="font-family:monospace">@UnknownInitialization</span> and <span style="font-family:monospace">@UnderInitialization</span>
annotations). The benefit (in terms of reduced false positive
initialization warnings) from supporting partial initialization is
greater than the benefit from adopting the Freedom Before Commitment system.</p><hr>
<!--TOC chapter id="map-key-checker" Map Key Checker-->
<h1 id="map-key-checker" class="chapter">Chapter ‍4 Map Key Checker <a href="#map-key-checker"><img src="chainlink.svg" width="10" height="10"></a></h1><!--SEC END --><p>The Map Key Checker tracks which values are keys for which maps. If variable
<span style="font-family:monospace">v</span> has type <span style="font-family:monospace">@KeyFor("m")...</span>, then the value of <span style="font-family:monospace">v</span> is a key
in Map <span style="font-family:monospace">m</span>. That is, the expression <span style="font-family:monospace">m.containsKey(v)</span> evaluates to
<span style="font-family:monospace">true</span>.</p><p>Section ‍<a href="#map-key-qualifiers">3.2.4</a> describes how <span style="font-family:monospace">@KeyFor</span> annotations
enable the
Nullness Checker (Chapter ‍<a href="#nullness-checker">3</a>) to treat calls to
<a href="https://docs.oracle.com/en/java/javase/17/docs/api/java.base/java/util/Map.html#get(java.lang.Object)"><span style="font-family:monospace">Map.get</span></a>
more precisely by refining its result to <span style="font-family:monospace">@NonNull</span> in some cases.</p>
<!--TOC section id="map-key-invoking" Invoking the Map Key Checker-->
<h2 id="map-key-invoking" class="section">4.1 Invoking the Map Key Checker <a href="#map-key-invoking"><img src="chainlink.svg" width="10" height="10"></a></h2><!--SEC END --><p>You will not typically run the Map Key Checker. It is automatically run by
other checkers, in particular the Nullness Checker.</p><p>You can unsoundly suppress warnings related to map keys with
<span style="font-family:monospace">@SuppressWarnings("keyfor")</span>, or everywhere by using command-line option
<span style="font-family:monospace">-AsuppressWarnings=keyfor</span>; see Chapter ‍<a href="#suppressing-warnings">32</a>.</p><p>The command-line argument <span style="font-family:monospace">-AassumeKeyFor</span> makes the Map Key Checker
unsoundly assume that the argument to <span style="font-family:monospace">Map.get</span> is a key for the receiver
map. This is like declaring the <span style="font-family:monospace">Map.get</span> method as <span style="font-family:monospace">V get(Object key)</span>
rather than <span style="font-family:monospace">@Nullable V get(Object key)</span>. (Just changing the JDK
declaration would not work, however, because the Map Key Checker has
special-case logic for <span style="font-family:monospace">Map.get</span>. This is different than suppressing
warnings, because it changes a method’s return type. This is not the same
as assuming that the return value is <span style="font-family:monospace">@NonNull</span>, because the map’s value
type might be <span style="font-family:monospace">@Nullable</span>, as in <span style="font-family:monospace">Map&lt;String, @Nullable Integer&gt;</span>.</p>
<!--TOC section id="map-key-annotations" Map key annotations-->
<h2 id="map-key-annotations" class="section">4.2 Map key annotations <a href="#map-key-annotations"><img src="chainlink.svg" width="10" height="10"></a></h2><!--SEC END --><p>These qualifiers are part of the Map Key type system:</p><dl class="description"><dt class="dt-description"><a href="../api/org/checkerframework/checker/nullness/qual/KeyFor.html"><span style="font-weight:bold"><span style="font-family:monospace">@KeyFor</span></span></a><span style="font-weight:bold"><span style="font-family:monospace">(String[] maps)</span></span></dt><dd class="dd-description">
indicates that the value assigned to the annotated variable is a key for at
least the given maps.</dd><dt class="dt-description"><a href="../api/org/checkerframework/checker/nullness/qual/UnknownKeyFor.html"><span style="font-weight:bold"><span style="font-family:monospace">@UnknownKeyFor</span></span></a></dt><dd class="dd-description">
is used internally by the type system but should never be written by a
programmer. It indicates that the value assigned to the annotated
variable is not known to be a key for any map. It is the default type
qualifier.</dd><dt class="dt-description"><a href="../api/org/checkerframework/checker/nullness/qual/KeyForBottom.html"><span style="font-weight:bold"><span style="font-family:monospace">@KeyForBottom</span></span></a></dt><dd class="dd-description">
is used internally by the type system but should never be written by a
programmer. There are no values of this type (not even <span style="font-family:monospace">null</span>).</dd></dl><p>The following method annotations can be used to establish a method postcondition
that ensures that a certain expression is a key for a map:</p><dl class="description"><dt class="dt-description">
<a href="../api/org/checkerframework/checker/nullness/qual/EnsuresKeyFor.html"><span style="font-weight:bold"><span style="font-family:monospace">@EnsuresKeyFor</span></span></a><span style="font-weight:bold"><span style="font-family:monospace">(String[] value, String[] map)</span></span></dt><dd class="dd-description">
When the method with this annotation returns, the expression (or all the
expressions) given in the <span style="font-family:monospace">value</span> element is a key for the given
maps. More precisely, the expression has the <span style="font-family:monospace">@KeyFor</span> qualifier
with the <span style="font-family:monospace">value</span> arguments taken from the <span style="font-family:monospace">targetValue</span> element
of this annotation.
</dd><dt class="dt-description"><a href="../api/org/checkerframework/checker/nullness/qual/EnsuresKeyForIf.html"><span style="font-weight:bold"><span style="font-family:monospace">@EnsuresKeyForIf</span></span></a><span style="font-weight:bold"><span style="font-family:monospace">(String[] expression, boolean result, String[] map)</span></span></dt><dd class="dd-description">
If the method with this annotation returns the given boolean value,
then the given expression (or all the given expressions)
is a key for the given maps.
</dd></dl><blockquote class="figure"><div class="center"><hr class="floatrule"></div>
<div class="center">
<img src="map-key-keyfor.svg">
</div>
<div class="caption"><table style="border-spacing:6px;border-collapse:separate;" class="cellpading0"><tr><td style="vertical-align:top;text-align:left;" >Figure 4.1: The subtyping relationship of the Map Key Checker’s qualifiers.
<span style="font-family:monospace">@KeyFor(A)</span> is a supertype of <span style="font-family:monospace">@KeyFor(B)</span> if and only if <span style="font-family:monospace">A</span> is a subset of
<span style="font-family:monospace">B</span>. Qualifiers in gray are used internally by the type system but should
never be written by a programmer.</td></tr>
</table></div>
<a id="fig-map-key-keyfor-hierarchy"></a>
<div class="center"><hr class="floatrule"></div></blockquote>
<!--TOC section id="map-key-defaults" Default annotations-->
<h2 id="map-key-defaults" class="section">4.3 Default annotations <a href="#map-key-defaults"><img src="chainlink.svg" width="10" height="10"></a></h2><!--SEC END --><p>The qualifier for the type of the <span style="font-family:monospace">null</span> literal is <span style="font-family:monospace">@UnknownKeyFor</span>.
If <span style="font-family:monospace">null</span> were <span style="font-family:monospace">@KeyForBottom</span>, that would mean that
<span style="font-family:monospace">null</span> is guaranteed to be a key for every map (which is not
necessarily true).</p>
<!--TOC subsection id="map-key-defaults-lowerbound" Default for lower bounds-->
<h3 id="map-key-defaults-lowerbound" class="subsection">4.3.1 Default for lower bounds <a href="#map-key-defaults-lowerbound"><img src="chainlink.svg" width="10" height="10"></a></h3><!--SEC END --><p>Lower bounds are defaulted to <span style="font-family:monospace">@UnknownKeyFor</span>.
However, in <span style="font-family:monospace">java.*</span> packages, the default for lower bounds is
<span style="font-family:monospace">@KeyForBottom</span>.</p><p>It is challenging to choose a default for lower bounds of type variables
and wildcards.</p><p>Here is a comparison of two choices for lower bounds:</p><table style="border-spacing:6px;border-collapse:separate;" class="cellpading0"><tr><td style="text-align:left;white-space:nowrap" ><span style="font-family:monospace">@KeyForBottom</span> default</td><td style="text-align:left;white-space:nowrap" ><span style="font-family:monospace">@UnknownKeyFor</span> default (current choice) </td></tr>
<tr><td class="hrule" colspan=2></td></tr>
<tr><td style="text-align:left;white-space:nowrap" ><span style="font-family:monospace">class MyClass1&lt;@UnknownKeyFor T&gt; {</span></td><td style="text-align:left;white-space:nowrap" ><span style="font-family:monospace">class MyClass1&lt;T&gt; {</span> </td></tr>
<tr><td style="text-align:left;white-space:nowrap" ><span style="font-family:monospace"> ‍ ‍T var = null; // OK</span></td><td style="text-align:left;white-space:nowrap" ><span style="font-family:monospace"> ‍ ‍T var = null; // OK</span> </td></tr>
<tr><td class="hrule" colspan=2></td></tr>
<tr><td style="text-align:left;white-space:nowrap" ><span style="font-family:monospace">class MyClass2&lt;T&gt; {</span></td><td style="text-align:left;white-space:nowrap" >&nbsp;</td></tr>
<tr><td style="text-align:left;white-space:nowrap" ><span style="font-family:monospace"> ‍ ‍@UnknownKeyFor T var = null; // OK</span></td><td style="text-align:left;white-space:nowrap" >&nbsp;</td></tr>
<tr><td class="hrule" colspan=2></td></tr>
<tr><td style="text-align:left;white-space:nowrap" ><span style="font-family:monospace">class MyClass3&lt;T&gt; {</span></td><td style="text-align:left;white-space:nowrap" >&nbsp;</td></tr>
<tr><td style="text-align:left;white-space:nowrap" ><span style="font-family:monospace"> ‍ ‍T var = null; // ERROR</span></td><td style="text-align:left;white-space:nowrap" >&nbsp;</td></tr>
<tr><td class="hrule" colspan=2></td></tr>
<tr><td style="text-align:left;white-space:nowrap" >&nbsp;</td><td style="text-align:left;white-space:nowrap" ><span style="font-family:monospace">class MySet1&lt;T&gt; implements Set&lt;T&gt; { }</span> </td></tr>
<tr><td style="text-align:left;white-space:nowrap" >&nbsp;</td><td style="text-align:left;white-space:nowrap" ><span style="font-family:monospace">MySet1&lt;@KeyFor("m") String&gt; s1; // ERROR</span> </td></tr>
<tr><td class="hrule" colspan=2></td></tr>
<tr><td style="text-align:left;white-space:nowrap" ><span style="font-family:monospace">class Set&lt;E&gt; { }</span></td><td style="text-align:left;white-space:nowrap" > <span style="font-family:monospace">class Set&lt;@KeyForBottom E&gt; { }</span> </td></tr>
<tr><td style="text-align:left;white-space:nowrap" ><span style="font-family:monospace">class MySet2&lt;T&gt; implements Set&lt;T&gt; { }</span></td><td style="text-align:left;white-space:nowrap" > <span style="font-family:monospace">class MySet2&lt;@KeyForBottom T&gt; implements Set&lt;T&gt; { }</span> </td></tr>
<tr><td style="text-align:left;white-space:nowrap" ><span style="font-family:monospace">MySet2&lt;@KeyFor("m") String&gt; s2; // OK</span>
 ‍ ‍ ‍</td><td style="text-align:left;white-space:nowrap" > <span style="font-family:monospace">MySet2&lt;@KeyFor("m") String&gt; s2; // OK</span> </td></tr>
</table><p>If lower bounds are defaulted to <span style="font-family:monospace">@KeyForBottom</span> (which is not
currently the case), then whenever <span style="font-family:monospace">null</span> is assigned to a variable whose
type is a type variable, programmers must write an <span style="font-family:monospace">@UnknownKeyFor</span>
annotation on either the type variable declaration or on variable
declarations, as shown in <span style="font-family:monospace">MyClass1</span> and
<span style="font-family:monospace">MyClass2</span>.
A disadvantage of this default is that the Map Key checker may issue
warnings in code that has nothing to do with map keys, and in which no map
key annotations are used.</p><p>If lower bounds are defaulted to <span style="font-family:monospace">@UnknownKeyFor</span> (which is currently
the case), then whenever a client might use a <span style="font-family:monospace">@KeyFor</span> type argument,
programmers must write a <span style="font-family:monospace">@KeyForBottom</span> annotation on the type parameter,
as in <span style="font-family:monospace">MySet2</span> (and <span style="font-family:monospace">Set</span>).</p>
<!--TOC subsection id="map-key-lowerbound-explicit" Diagnosing the need for explicit @KeyFor on lower bounds-->
<h3 id="map-key-lowerbound-explicit" class="subsection">4.3.2 Diagnosing the need for explicit @KeyFor on lower bounds <a href="#map-key-lowerbound-explicit"><img src="chainlink.svg" width="10" height="10"></a></h3><!--SEC END --><p>Under the current defaulting (lower bounds default to
<span style="font-family:monospace">@UnknownKeyFor</span>), suppose you write this code:</p><pre class="verbatim">public class Graph&lt;N&gt; {
  Map&lt;N, Integer&gt; nodes = new HashMap&lt;&gt;();
}

class Client {
  @Nullable Graph&lt;@KeyFor("g.nodes") String&gt; g;
}
</pre><p>The Nullness Checker issues this error message:</p><pre class="verbatim">Graph.java:14: error: [type.argument.type.incompatible] incompatible types in type argument.
  @Nullable Graph&lt;@KeyFor("g.nodes") String&gt; g;
                  ^
  found   : @KeyFor("this.g.nodes") String
  required: [extends @UnknownKeyFor Object super @UnknownKeyFor null]
</pre><p>Note that the upper and lower bounds are both <span style="font-family:monospace">@UnknownKeyFor</span>. You can
make the code type-check by writing a lower bound, which is written before
the type variable name (Section ‍<a href="#generics-instantiation">30.1.2</a>):</p><pre class="verbatim">public class Graph&lt;@KeyForBottom N&gt; {
...
</pre>
<!--TOC section id="map-key-examples" Examples-->
<h2 id="map-key-examples" class="section">4.4 Examples <a href="#map-key-examples"><img src="chainlink.svg" width="10" height="10"></a></h2><!--SEC END --><p>The Map Key Checker keeps track of which variables reference keys to
which maps. A variable annotated with <span style="font-family:monospace">@KeyFor(</span><span style="font-family:monospace"><em>mapSet</em></span><span style="font-family:monospace">)</span> can only
contain a value that is a key for all the maps in <em>mapSet</em>. For example:</p><pre class="verbatim">Map&lt;String,Date&gt; m, n;
@KeyFor("m") String km;
@KeyFor("n") String kn;
@KeyFor({"m", "n"}) String kmn;
km = kmn;   // OK - a key for maps m and n is also a key for map m
km = kn;    // error: a key for map n is not necessarily a key for map m
</pre><p>As with any annotation, use of the <span style="font-family:monospace">@KeyFor</span> annotation may force you to
slightly refactor your code. For example, this would be illegal:</p><pre class="verbatim">Map&lt;String,Object&gt; m;
Collection&lt;@KeyFor("m") String&gt; coll;
coll.add(x);   // error: element type is @KeyFor("m") String, but x does not have that type
m.put(x, ...);
</pre><p>The example type-checks if you reorder the two calls:</p><pre class="verbatim">Map&lt;String,Object&gt; m;
Collection&lt;@KeyFor("m") String&gt; coll;
m.put(x, ...);    // after this statement, x has type @KeyFor("m") String
coll.add(x);      // OK
</pre>
<!--TOC section id="map-key-annotations-inference" Local inference of @KeyFor annotations-->
<h2 id="map-key-annotations-inference" class="section">4.5 Local inference of @KeyFor annotations <a href="#map-key-annotations-inference"><img src="chainlink.svg" width="10" height="10"></a></h2><!--SEC END --><p>Within a method body, you usually do not have to write <span style="font-family:monospace">@KeyFor</span>
explicitly (except sometimes on type arguments),
because the checker infers it based on usage patterns. When the Map Key
Checker encounters a run-time check for map keys, such as
“<span style="font-family:monospace">if (m.containsKey(k)) ...</span>”, then the Map Key Checker refines the type of
<span style="font-family:monospace">k</span> to <span style="font-family:monospace">@KeyFor("m")</span> within the scope of the test (or until <span style="font-family:monospace">k</span> is
side-effected within that scope). The Map Key Checker also infers <span style="font-family:monospace">@KeyFor</span>
annotations based on iteration over a map’s
<a href="https://docs.oracle.com/en/java/javase/17/docs/api/java.base/java/util/Map.html#keySet()">key set</a> or calls to
<a href="https://docs.oracle.com/en/java/javase/17/docs/api/java.base/java/util/Map.html#put(K,V)"><span style="font-family:monospace">put</span></a>
or
<a href="https://docs.oracle.com/en/java/javase/17/docs/api/java.base/java/util/Map.html#containsKey(java.lang.Object)"><span style="font-family:monospace">containsKey</span></a>.
For more details about type refinement, see Section ‍<a href="#type-refinement">31.7</a>.</p><p>Suppose we have these declarations:</p><pre class="verbatim">Map&lt;String,Date&gt; m = new Map&lt;&gt;();
String k = "key";
@KeyFor("m") String km;
</pre><p>Ordinarily, the following assignment does not type-check:</p><pre class="verbatim">km = k;   // Error since k is not known to be a key for map m.
</pre><p>The following examples show cases where the Map Key Checker
infers a <span style="font-family:monospace">@KeyFor</span> annotation for variable <span style="font-family:monospace">k</span> based on usage patterns,
enabling the <span style="font-family:monospace">km = k</span> assignment to type-check.</p><pre class="verbatim">m.put(k, ...);
// At this point, the type of k is refined to @KeyFor("m") String.
km = k;   // OK


if (m.containsKey(k)) {
    // At this point, the type of k is refined to @KeyFor("m") String.
    km = k;   // OK
    ...
} else {
    km = k;   // Error since k is not known to be a key for map m.
    ...
}
</pre><p>The following example shows a case where the Map Key Checker resets its
assumption about the type of a field used as a key because that field may have
been side-effected.</p><pre class="verbatim">class MyClass {
    private Map&lt;String,Object&gt; m;
    private String k;   // The type of k defaults to @UnknownKeyFor String
    private @KeyFor("m") String km;

    public void myMethod() {
        if (m.containsKey(k)) {
            km = k;   // OK: the type of k is refined to @KeyFor("m") String

            sideEffectFreeMethod();
            km = k;   // OK: the type of k is not affected by the method call
                      // and remains @KeyFor("m") String

            otherMethod();
            km = k;   // error: At this point, the type of k is once again
                      // @UnknownKeyFor String, because otherMethod might have
                      // side-effected k such that it is no longer a key for map m.
        }
    }

    @SideEffectFree
    private void sideEffectFreeMethod() { ... }

    private void otherMethod() { ... }
}
</pre><hr>
<!--TOC chapter id="optional-checker" Optional Checker for possibly-present data-->
<h1 id="optional-checker" class="chapter">Chapter ‍5 Optional Checker for possibly-present data <a href="#optional-checker"><img src="chainlink.svg" width="10" height="10"></a></h1><!--SEC END --><p>Java 8 introduced the <a href="https://docs.oracle.com/en/java/javase/17/docs/api/java.base/java/util/Optional.html"><span style="font-family:monospace">Optional</span></a>
class, a container that is either empty or contains a non-null value.</p><p>Using <span style="font-family:monospace">Optional</span> is intended to help programmers remember to check whether
data is present or not. However, <span style="font-family:monospace">Optional</span> itself is prone to misuse.
The article
<a href="https://homes.cs.washington.edu/~mernst/advice/nothing-is-better-than-optional.html">Nothing
is better than the <span style="font-family:monospace">Optional</span> type</a> gives reasons to use
regular nullable references rather than <span style="font-family:monospace">Optional</span>. However, if you do use
<span style="font-family:monospace">Optional</span>, then the Optional Checker will help you avoid
<span style="font-family:monospace">Optional</span>’s pitfalls.</p><p>Stuart Marks gave
<a href="https://stuartmarks.wordpress.com/2016/09/27/vjug24-session-on-optional/">7
rules</a> to avoid problems with Optional:
</p><ol class="enumerate" type=1><li class="li-enumerate">
Never, ever, use <span style="font-family:monospace">null</span> for an <span style="font-family:monospace">Optional</span> variable or return value.
</li><li class="li-enumerate">Never use <a href="https://docs.oracle.com/en/java/javase/17/docs/api/java.base/java/util/Optional.html#get()"><span style="font-family:monospace">Optional.get()</span></a> unless you can prove that the Optional is present.
</li><li class="li-enumerate">Prefer alternative APIs over
<a href="https://docs.oracle.com/en/java/javase/17/docs/api/java.base/java/util/Optional.html#isPresent()"><span style="font-family:monospace">Optional.isPresent()</span></a>
and <a href="https://docs.oracle.com/en/java/javase/17/docs/api/java.base/java/util/Optional.html#get()"><span style="font-family:monospace">Optional.get()</span></a>.
</li><li class="li-enumerate">It’s generally a bad idea to create an <span style="font-family:monospace">Optional</span> for the specific
purpose of chaining methods from it to get a value.
</li><li class="li-enumerate">If an Optional chain has a nested <span style="font-family:monospace">Optional</span> chain, or has an
intermediate result of <span style="font-family:monospace">Optional</span>, it’s probably too complex.
</li><li class="li-enumerate">Avoid using <span style="font-family:monospace">Optional</span> in fields, method parameters, and collections.
</li><li class="li-enumerate">Don’t use an <span style="font-family:monospace">Optional</span> to wrap any collection type (<span style="font-family:monospace">List</span>, <span style="font-family:monospace">Set</span>,
<span style="font-family:monospace">Map</span>). Instead, use an empty collection to represent the absence of
values.
</li></ol><p>Rule #1 is guaranteed by the Nullness Checker
(Chapter ‍<a href="#nullness-checker">3</a>).
Rules #2–#7 are guaranteed by the Optional Checker, described in this chapter.
(Exception: Rule #5 is not yet implemented and will be checked by the
Optional Checker in the future.)
</p><p>Use of the Optional Checker guarantees that your program will not suffer a
<span style="font-family:monospace">NullPointerException</span> nor a <span style="font-family:monospace">NoSuchElementException</span> when calling
methods on an expression of <span style="font-family:monospace">Optional</span> type.</p>
<!--TOC section id="optional-run-checker" How to run the Optional Checker-->
<h2 id="optional-run-checker" class="section">5.1 How to run the Optional Checker <a href="#optional-run-checker"><img src="chainlink.svg" width="10" height="10"></a></h2><!--SEC END --><pre class="verbatim">javac -processor optional MyFile.java ...
javac -processor org.checkerframework.checker.optional.OptionalChecker MyFile.java ...
</pre>
<!--TOC section id="optional-annotations" Optional annotations-->
<h2 id="optional-annotations" class="section">5.2 Optional annotations <a href="#optional-annotations"><img src="chainlink.svg" width="10" height="10"></a></h2><!--SEC END --><p>These qualifiers make up the Optional type system:</p><dl class="description"><dt class="dt-description"><a href="../api/org/checkerframework/checker/optional/qual/MaybePresent.html"><span style="font-weight:bold"><span style="font-family:monospace">@MaybePresent</span></span></a></dt><dd class="dd-description">
The annotated <span style="font-family:monospace">Optional</span> container may or may not contain a value.
This is the default type, so programmers do not have to write it.</dd><dt class="dt-description"><a href="../api/org/checkerframework/checker/optional/qual/Present.html"><span style="font-weight:bold"><span style="font-family:monospace">@Present</span></span></a></dt><dd class="dd-description">
The annotated <span style="font-family:monospace">Optional</span> container definitely contains a (non-null) value.</dd><dt class="dt-description"><a href="../api/org/checkerframework/checker/optional/qual/OptionalBottom.html"><span style="font-weight:bold"><span style="font-family:monospace">@OptionalBottom</span></span></a></dt><dd class="dd-description">
The annotated expression evaluates to <span style="font-family:monospace">null</span> rather than to an <span style="font-family:monospace">Optional</span> container.
Programmers rarely write this annotation.</dd><dt class="dt-description"><a href="../api/org/checkerframework/checker/optional/qual/PolyPresent.html"><span style="font-weight:bold"><span style="font-family:monospace">@PolyPresent</span></span></a></dt><dd class="dd-description">
indicates qualifier polymorphism.
For a description of qualifier polymorphism, see
Section ‍<a href="#method-qualifier-polymorphism">30.2</a>.</dd></dl><p>The subtyping hierarchy of the Optional Checker’s qualifiers is shown in
Figure ‍<a href="#fig-optional-hierarchy">5.1</a>.</p><blockquote class="figure"><div class="center"><hr class="floatrule"></div>
<div class="center">
<img src="optional-subtyping.svg">
</div>
<div class="caption"><table style="border-spacing:6px;border-collapse:separate;" class="cellpading0"><tr><td style="vertical-align:top;text-align:left;" >Figure 5.1: The subtyping relationship of the Optional Checker’s qualifiers.</td></tr>
</table></div>
<a id="fig-optional-hierarchy"></a>
<div class="center"><hr class="floatrule"></div></blockquote>
<!--TOC section id="optional-guarantees" What the Optional Checker guarantees-->
<h2 id="optional-guarantees" class="section">5.3 What the Optional Checker guarantees <a href="#optional-guarantees"><img src="chainlink.svg" width="10" height="10"></a></h2><!--SEC END --><p>The Optional Checker guarantees that your code will not throw an exception
due to use of an absent <span style="font-family:monospace">Optional</span> where a present <span style="font-family:monospace">Optional</span> is needed.
More specifically, the Optional Checker will issue a warning if you call
<a href="https://docs.oracle.com/en/java/javase/17/docs/api/java.base/java/util/Optional.html#get()
"><span style="font-family:monospace">get</span></a>
or
<a href="https://docs.oracle.com/en/java/javase/17/docs/api/java.base/java/util/Optional.html#orElseThrow(java.util.function.Supplier)"><span style="font-family:monospace">orElseThrow</span></a>
on a <span style="font-family:monospace">@MaybePresent Optional</span> receiver, because each of these methods
throws an exception if the receiver is an absent
<span style="font-family:monospace">Optional</span>.</p><p>The Optional Checker does not check nullness properties, such as requiring
that the argument to
<a href="https://docs.oracle.com/en/java/javase/17/docs/api/java.base/java/util/Optional.html#of(T)"><span style="font-family:monospace">of</span></a>
is non-null or guaranteeing that the result of
<a href="https://docs.oracle.com/en/java/javase/17/docs/api/java.base/java/util/Optional.html#get()"><span style="font-family:monospace">get</span></a>
is non-null. To obtain such a guarantee, run both the Optional Checker and
the Nullness Checker (Chapter ‍<a href="#nullness-checker">3</a>).</p><p>As with any checker, the guarantee is subject to certain limitations (see
Section ‍<a href="#checker-guarantees">2.3</a>).</p><hr>
<!--TOC chapter id="interning-checker" Interning Checker-->
<h1 id="interning-checker" class="chapter">Chapter ‍6 Interning Checker <a href="#interning-checker"><img src="chainlink.svg" width="10" height="10"></a></h1><!--SEC END --><p>If the Interning Checker issues no errors for a given program, then all
reference equality tests (i.e., all uses of “<span style="font-family:monospace">==</span>”) are proper;
that is,
<span style="font-family:monospace">==</span> is not misused where <span style="font-family:monospace">equals()</span> should have been used instead.</p><p>Interning is a design pattern in which the same object is used whenever two
different objects would be considered equal. Interning is also known as
canonicalization or hash-consing, and it is related to the flyweight design
pattern.
Interning has two benefits: it can save memory, and it can speed up testing for
equality by permitting use of <span style="font-family:monospace">==</span>.</p><p>The Interning Checker prevents two types of problems in your code.
First, it prevents using <span style="font-family:monospace">==</span> on
non-interned values, which can result in subtle bugs. For example:</p><pre class="verbatim">  Integer x = new Integer(22);
  Integer y = new Integer(22);
  System.out.println(x == y);  // prints false!
</pre><p>Second,
the Interning Checker helps to prevent performance problems that result
from failure to use interning.
(See Section ‍<a href="#checker-guarantees">2.3</a> for caveats to the checker’s guarantees.)</p><p>Interning is such an important design pattern that Java builds it in for
these types: <span style="font-family:monospace">String</span>, <span style="font-family:monospace">Boolean</span>, <span style="font-family:monospace">Byte</span>, <span style="font-family:monospace">Character</span>, <span style="font-family:monospace">Integer</span>,
<span style="font-family:monospace">Short</span>. Every string literal in the program is guaranteed to be interned
(<a href="https://docs.oracle.com/javase/specs/jls/se17/html/jls-3.html#jls-3.10.5">JLS
§3.10.5</a>), and the
<a href="https://docs.oracle.com/en/java/javase/17/docs/api/java.base/java/lang/String.html#intern()"><span style="font-family:monospace">String.intern()</span></a> method
performs interning for strings that are computed at run time.
The <span style="font-family:monospace">valueOf</span> methods in wrapper classes always (<span style="font-family:monospace">Boolean</span>, <span style="font-family:monospace">Byte</span>) or
sometimes (<span style="font-family:monospace">Character</span>, <span style="font-family:monospace">Integer</span>, <span style="font-family:monospace">Short</span>) return an interned result
(<a href="https://docs.oracle.com/javase/specs/jls/se17/html/jls-5.html#jls-5.1.7">JLS §5.1.7</a>).
Users can also write their own interning methods for other types.</p><p>It is a proper optimization to use <span style="font-family:monospace">==</span>, rather than <span style="font-family:monospace">equals()</span>,
whenever the comparison is guaranteed to produce the same result — that
is, whenever the comparison is never provided with two different objects
for which <span style="font-family:monospace">equals()</span> would return true. Here are three reasons that
this property could hold:</p><ol class="enumerate" type=1><li class="li-enumerate">
Interning. A factory method ensures that, globally, no two different
interned objects are <span style="font-family:monospace">equals()</span> to one another.
(For some classes, every instance is interned; however, in other cases it is
possible for two objects of the class to be
<span style="font-family:monospace">equals()</span> to one another, even if one of them is interned.)
Interned objects should always be immutable.
</li><li class="li-enumerate">Global control flow. The program’s control flow is such that the
constructor for class <span style="font-style:italic">C</span> is called a limited number of times, and with
specific values that ensure the results are not <span style="font-family:monospace">equals()</span> to one
another. Objects of class <span style="font-style:italic">C</span> can always be compared with <span style="font-family:monospace">==</span>.
Such objects may be mutable or immutable.
</li><li class="li-enumerate">Local control flow. Even though not all objects of the given type may be
compared with <span style="font-family:monospace">==</span>, the specific objects that can reach a given
comparison may be.
<ul class="itemize"><li class="li-itemize">
When searching for an element (say, in a collection), <span style="font-family:monospace">==</span> may be
appropriate.
</li><li class="li-itemize">Some routines return either their argument, or a modified version of
it. Your code might compare <span style="font-family:monospace">s == s.toLowerCase()</span> to see whether
a string contained any upper-case characters.
</li></ul>
</li></ol><p>To eliminate Interning Checker errors, you will need to annotate the
declarations of any expression used as an argument to <span style="font-family:monospace">==</span>.
Thus, the Interning Checker
could also have been called the Reference Equality Checker.
</p><p>
To run the Interning Checker, supply the
<span style="font-family:monospace">-processor org.checkerframework.checker.interning.InterningChecker</span>
command-line option to javac. For examples, see Section ‍<a href="#interning-example">6.5</a>.
</p>
<!--TOC section id="interning-annotations" Interning annotations-->
<h2 id="interning-annotations" class="section">6.1 Interning annotations <a href="#interning-annotations"><img src="chainlink.svg" width="10" height="10"></a></h2><!--SEC END -->
<!--TOC subsection id="interning-qualifiers" Interning qualifiers-->
<h3 id="interning-qualifiers" class="subsection">6.1.1 Interning qualifiers <a href="#interning-qualifiers"><img src="chainlink.svg" width="10" height="10"></a></h3><!--SEC END --><p>These qualifiers are part of the Interning type system:</p><dl class="description"><dt class="dt-description"><a href="../api/org/checkerframework/checker/interning/qual/Interned.html"><span style="font-weight:bold"><span style="font-family:monospace">@Interned</span></span></a></dt><dd class="dd-description">
indicates a type that includes only interned values (no non-interned
values).</dd><dt class="dt-description"><a href="../api/org/checkerframework/checker/interning/qual/InternedDistinct.html"><span style="font-weight:bold"><span style="font-family:monospace">@InternedDistinct</span></span></a></dt><dd class="dd-description">
indicates a type such that each value is not <span style="font-family:monospace">equals()</span> to any other
Java value. This is a stronger (more restrictive) property than
<span style="font-family:monospace">@Interned</span>, but is a weaker property than writing <span style="font-family:monospace">@Interned</span> on a
class declaration. For
details, see Section ‍<a href="#interning-distinct">6.3.3</a>.</dd><dt class="dt-description"><a href="../api/org/checkerframework/checker/interning/qual/UnknownInterned.html"><span style="font-weight:bold"><span style="font-family:monospace">@UnknownInterned</span></span></a></dt><dd class="dd-description">
indicates a type whose values might or might not be interned.
It is used internally by the type system and is not written by programmers.</dd><dt class="dt-description"><a href="../api/org/checkerframework/checker/interning/qual/PolyInterned.html"><span style="font-weight:bold"><span style="font-family:monospace">@PolyInterned</span></span></a></dt><dd class="dd-description">
indicates qualifier polymorphism.
For a description of qualifier polymorphism, see
Section ‍<a href="#method-qualifier-polymorphism">30.2</a>.</dd></dl>
<!--TOC subsection id="interning-declaration-annotations" Interning method and class annotations-->
<h3 id="interning-declaration-annotations" class="subsection">6.1.2 Interning method and class annotations <a href="#interning-declaration-annotations"><img src="chainlink.svg" width="10" height="10"></a></h3><!--SEC END --><dl class="description"><dt class="dt-description"><a href="../api/org/checkerframework/checker/interning/qual/UsesObjectEquals.html"><span style="font-weight:bold"><span style="font-family:monospace">@UsesObjectEquals</span></span></a></dt><dd class="dd-description">
is a class annotation (not a type annotation) that indicates that this class’s
<span style="font-family:monospace">equals</span> method is the same as that of <span style="font-family:monospace">Object</span>. Since
<span style="font-family:monospace">Object.equals</span> uses reference equality, this means that for such a
class, <span style="font-family:monospace">==</span> and <span style="font-family:monospace">equals</span> are equivalent, and so the Interning Checker
does not issue errors or warnings for either one.<p>Two ways to satisfy this annotation are: (1) neither this class nor any
of its superclasses overrides the <span style="font-family:monospace">equals</span> method, or (2) this class
defines <span style="font-family:monospace">equals</span> with body <span style="font-family:monospace">return this == o;</span>.</p></dd><dt class="dt-description"><a href="../api/org/checkerframework/checker/interning/qual/InternMethod.html"><span style="font-weight:bold"><span style="font-family:monospace">@InternMethod</span></span></a></dt><dd class="dd-description">
is a method declaration annotation that indicates that this method
returns an interned object and may be invoked
on an uninterned object. See Section ‍<a href="#interning-intern-methods">6.3.1</a> for more details.</dd><dt class="dt-description"><a href="../api/org/checkerframework/checker/interning/qual/EqualsMethod.html"><span style="font-weight:bold"><span style="font-family:monospace">@EqualsMethod</span></span></a></dt><dd class="dd-description">
is a method declaration annotation that indicates that this method
has a specification like <span style="font-family:monospace">equals()</span>. The Interning Checker permits use
of <span style="font-family:monospace">this == arg</span> within the body.</dd><dt class="dt-description"><a href="../api/org/checkerframework/checker/interning/qual/CompareToMethod.html"><span style="font-weight:bold"><span style="font-family:monospace">@CompareToMethod</span></span></a></dt><dd class="dd-description">
is a method declaration annotation that indicates that this method
has a specification like <span style="font-family:monospace">compareTo()</span>. The Interning Checker permits use
of <span style="font-family:monospace">if (arg1 == arg2) </span><span style="font-family:monospace">{</span><span style="font-family:monospace"> return 0; </span><span style="font-family:monospace">}</span> within the body.</dd><dt class="dt-description"><a href="../api/org/checkerframework/checker/interning/qual/FindDistinct.html"><span style="font-weight:bold"><span style="font-family:monospace">@FindDistinct</span></span></a></dt><dd class="dd-description">
is a formal parameter declaration annotation that indicates that this
method uses <span style="font-family:monospace">==</span> to perform comparisons against the annotated formal
parameter. A common reason is that the method searches for the formal
parameter in some data structure, using <span style="font-family:monospace">==</span>. Any value
may be passed to the method.
</dd></dl>
<!--TOC section id="interning-annotating" Annotating your code with <span style="font-family:monospace">@Interned</span>-->
<h2 id="interning-annotating" class="section">6.2 Annotating your code with <span style="font-family:monospace">@Interned</span> <a href="#interning-annotating"><img src="chainlink.svg" width="10" height="10"></a></h2><!--SEC END --><blockquote class="figure"><div class="center"><hr class="floatrule"></div>
<div class="center">
<img src="interning.svg">
</div>
<div class="caption"><table style="border-spacing:6px;border-collapse:separate;" class="cellpading0"><tr><td style="vertical-align:top;text-align:left;" >Figure 6.1: Type hierarchy for the Interning type system.</td></tr>
</table></div>
<a id="fig-interning-hierarchy"></a>
<div class="center"><hr class="floatrule"></div></blockquote><p>In order to perform checking, you must annotate your code with the <a href="../api/org/checkerframework/checker/interning/qual/Interned.html"><span style="font-family:monospace">@Interned</span></a>
type annotation. A type annotated with <span style="font-family:monospace">@Interned</span> contains the canonical
representation of an
object:</p><pre class="verbatim">            String s1 = ...;  // type is (uninterned) "String"
  @Interned String s2 = ...;  // type is "@Interned String"
</pre><p>The Interning Checker ensures that only interned
values can be assigned to <span style="font-family:monospace">s2</span>.</p>
<!--TOC section id="interning-interned-classes" Interned classes-->
<h2 id="interning-interned-classes" class="section">6.3 Interned classes <a href="#interning-interned-classes"><img src="chainlink.svg" width="10" height="10"></a></h2><!--SEC END --><p>An interned annotation on a class declaration indicates that all objects of a
type are interned <span style="font-style:italic">except for newly created objects</span>. That means that
all uses of such types are <span style="font-family:monospace">@Interned</span> by default and the type <span style="font-family:monospace">@UnknownInterned
MyClass</span> is an invalid type.</p><p>An exception is <span style="font-style:italic">constructor results</span>. Constructor results and <span style="font-family:monospace">this</span> within the
body of the constructor are <span style="font-family:monospace">@UnknownInterned</span> by default. Although <span style="font-family:monospace">@UnknownInterned InternClass</span>
is not a legal type, no “type.invalid” error is issued at constructor declarations.
Instead, an “interned.object.creation”
error is issued at the invocation of the constructor. The user should inspect
this location and suppress the warning if the newly created object is interned.</p><p>For example:</p><pre class="verbatim">@Interned class InternedClass {
  @UnknownInterned InternedClass() {
    // error, "this" is @UnknownInterned.
    @Interned InternedClass that = this;
  }

  @SuppressWarnings("intern") // Only creation of an InternedClass object.
  static final InternedClass ONE = new InternedClass();
}
</pre>
<!--TOC subsection id="interning-intern-methods" The intern() methods-->
<h3 id="interning-intern-methods" class="subsection">6.3.1 The intern() methods <a href="#interning-intern-methods"><img src="chainlink.svg" width="10" height="10"></a></h3><!--SEC END --><p>
Some interned classes use an <span style="font-family:monospace">intern()</span> method to look up the interned version of
the object. These methods must be annotated with the declaration annotation
<span style="font-family:monospace">@InternMethod</span>. This allows the checker to verify that a newly created object
is immediately interned and therefore not issue an interned object creation
error.</p><pre class="verbatim">new InternedClass().intern() // no error
</pre><p>Because an <span style="font-family:monospace">intern</span> method is expected to be called on uninterned objects, the
type of <span style="font-family:monospace">this</span> in <span style="font-family:monospace">intern</span> is implicitly <span style="font-family:monospace">@UnknownInterned</span>. This will cause an
error if <span style="font-family:monospace">this</span> is used someplace where an interned object is expected. Some
of these warnings will be false positives that should be suppressed by the
user.</p><pre class="verbatim">@InternMethod
public InternedClass intern() {
  // Type of "this" inside an @InternMethod is @UnknownInterned
  @Interned InternedClass that = this; // error

  if (!pool.contains(this)) {
    @SuppressWarnings("interning:assignment.type.incompatible")
    @Interned InternedClass internedThis = this;
    pool.add(internedThis);
  }
  return pool.get(this);
}
</pre><p>Some interned classes do not use an intern method to ensure that every object
of that class is interned. For these classes, the user will have to manually
inspect every constructor invocation and suppress the “interned.object.creation”
error.</p><p>If every invocation of a constructor is guaranteed to be interned, then the
user should annotate the constructor result with <span style="font-family:monospace">@Interned</span> and suppress a
warning at the constructor.</p><pre class="verbatim">@Interned class AnotherInternedClass {
  // manually verified that all constructor invocations used such that all
  // new objects are interned
  @SuppressWarnings("super.invocation.invalid")
  @Interned AnotherInternedClass() {}
}
</pre>
<!--TOC subsection id="interning-implicit-qualifiers" Default qualifiers and qualifiers for literals-->
<h3 id="interning-implicit-qualifiers" class="subsection">6.3.2 Default qualifiers and qualifiers for literals <a href="#interning-implicit-qualifiers"><img src="chainlink.svg" width="10" height="10"></a></h3><!--SEC END --><p>The Interning Checker
adds qualifiers to unannotated types, reducing the number of annotations that must
appear in your code (see Section ‍<a href="#effective-qualifier">31.4</a>).</p><p>For a complete description of all defaulting rules for interning qualifiers, see the
Javadoc for <a href="../api/org/checkerframework/checker/interning/InterningAnnotatedTypeFactory.html"><span style="font-family:monospace">InterningAnnotatedTypeFactory</span></a>.</p>
<!--TOC subsection id="interning-distinct" InternedDistinct: values not equals() to any other value-->
<h3 id="interning-distinct" class="subsection">6.3.3 InternedDistinct: values not equals() to any other value <a href="#interning-distinct"><img src="chainlink.svg" width="10" height="10"></a></h3><!--SEC END --><p>The <a href="../api/org/checkerframework/checker/interning/qual/InternedDistinct.html"><span style="font-family:monospace">@InternedDistinct</span></a> annotation
represents values that are not <span style="font-family:monospace">equals()</span> to any other value. Suppose
expression <span style="font-family:monospace">e</span> has type <span style="font-family:monospace">@InternedDistinct</span>. Then <span style="font-family:monospace">e.equals(x) == (e ==
x)</span>. Therefore, it is legal to use <span style="font-family:monospace">==</span> whenever at least one of the
operands has type <span style="font-family:monospace">@InternedDistinct</span>.</p><p><span style="font-family:monospace">@InternedDistinct</span> is stronger (more restrictive) than <span style="font-family:monospace">@Interned</span>.
For example, consider these variables:</p><pre class="verbatim">@Interned String i = "22";
          String s = new Integer(22).toString();
</pre><p>The variable <span style="font-family:monospace">i</span> is not <span style="font-family:monospace">@InternedDistinct</span> because <span style="font-family:monospace">i.equals(s)</span> is true.</p><p><span style="font-family:monospace">@InternedDistinct</span> is not as restrictive as stating that all objects of a
given Java type are interned.</p><p>The <span style="font-family:monospace">@InternedDistinct</span> annotation is rarely used, because it arises from
coding paradigms that are tricky to reason about.
One use is on static fields
that hold canonical values of a type.
Given this declaration:</p><pre class="verbatim">class MyType {
  final static @InternedDistinct MyType SPECIAL = new MyType(...);
  ...
}
</pre><p>it would be legal to write <span style="font-family:monospace">myValue == MyType.SPECIAL</span> rather than
<span style="font-family:monospace">myValue.equals(MyType.SPECIAL)</span>.</p><p>The <span style="font-family:monospace">@InternedDistinct</span> is trusted (not verified), because it would be too
complex to analyze the <span style="font-family:monospace">equals()</span> method to ensure that no other value is
<span style="font-family:monospace">equals()</span> to a <span style="font-family:monospace">@InternedDistinct</span> value. You will need to manually
verify that it is only written in locations where its contract is satisfied.
For example, here is one set of guidelines that you could check manually:
</p><ul class="itemize"><li class="li-itemize">
The constructor is private.
</li><li class="li-itemize">The factory method (whose return type is annotated with
<span style="font-family:monospace">@InternedDistinct</span> returns the canonical version for certain values.
</li><li class="li-itemize">The class is final, so that subclasses cannot violate these properties.
</li></ul>
<!--TOC section id="interning-checks" What the Interning Checker checks-->
<h2 id="interning-checks" class="section">6.4 What the Interning Checker checks <a href="#interning-checks"><img src="chainlink.svg" width="10" height="10"></a></h2><!--SEC END --><p>Objects of an <a href="../api/org/checkerframework/checker/interning/qual/Interned.html"><span style="font-family:monospace">@Interned</span></a> type may be safely compared using the “<span style="font-family:monospace">==</span>”
operator.</p><p>The checker issues an error in two cases:</p><ol class="enumerate" type=1><li class="li-enumerate">When a reference (in)equality operator (“<span style="font-family:monospace">==</span>” or “<span style="font-family:monospace">!=</span>”)
has an operand of non-<a href="../api/org/checkerframework/checker/interning/qual/Interned.html"><span style="font-family:monospace">@Interned</span></a> type.
As a special case, the operation is permitted if either argument is of
<a href="../api/org/checkerframework/checker/interning/qual/InternedDistinct.html"><span style="font-family:monospace">@InternedDistinct</span></a> type</li><li class="li-enumerate">When a non-<a href="../api/org/checkerframework/checker/interning/qual/Interned.html"><span style="font-family:monospace">@Interned</span></a> type is used
where an <a href="../api/org/checkerframework/checker/interning/qual/Interned.html"><span style="font-family:monospace">@Interned</span></a> type
is expected.</li></ol><p>This example shows both sorts of problems:</p><pre class="verbatim">                    Date  date;
          @Interned Date idate;
  @InternedDistinct Date ddate;
  ...
  if (date == idate) ...  // error: reference equality test is unsafe
  idate = date;           // error: idate's referent might no longer be interned
  ddate = idate;          // error: idate's referent might be equals() to some other value
</pre><p><a id="lint-dotequals"></a></p><p>The Interning Checker’s warnings look like</p><pre class="verbatim">MyFile.java:716: error: [interning:not.interned] attempting to use a non-@Interned comparison operand
        if (date == idate)
            ^
</pre><p>To resolve a <span style="font-family:monospace">not.interned</span> error, you should change the argument that is
passed to <span style="font-family:monospace">==</span>, or use <span style="font-family:monospace">.equals()</span> instead of <span style="font-family:monospace">==</span>, or suppress the
warning.</p><p>The checker also issues a warning when <span style="font-family:monospace">.equals</span> is used where
<span style="font-family:monospace">==</span> could be safely used. You can disable this behavior via the
javac <span style="font-family:monospace">-Alint=-dotequals</span> command-line option.</p><p>For a complete description of all checks performed by
the checker, see the Javadoc for
<a href="../api/org/checkerframework/checker/interning/InterningVisitor.html"><span style="font-family:monospace">InterningVisitor</span></a>.</p><p><a id="checking-class"></a>
To restrict which types the checker should type-check, pass a canonical
name (fully-qualified name) using the <span style="font-family:monospace">-Acheckclass</span> option.
For example, to find only the
interning errors related to uses of <span style="font-family:monospace">String</span>, you can pass
<span style="font-family:monospace">-Acheckclass=java.lang.String</span>. The Interning Checker always checks all
subclasses and superclasses of the given class.</p>
<!--TOC subsection id="interning-limitations" Imprecision (false positive warnings) of the Interning Checker-->
<h3 id="interning-limitations" class="subsection">6.4.1 Imprecision (false positive warnings) of the Interning Checker <a href="#interning-limitations"><img src="chainlink.svg" width="10" height="10"></a></h3><!--SEC END --><p>The Interning Checker conservatively assumes that the <span style="font-family:monospace">Character</span>, <span style="font-family:monospace">Integer</span>,
and <span style="font-family:monospace">Short</span> <span style="font-family:monospace">valueOf</span> methods return a non-interned value. In fact, these
methods sometimes return an interned value and sometimes a non-interned
value, depending on the run-time argument (<a href="https://docs.oracle.com/javase/specs/jls/se17/html/jls-5.html#jls-5.1.7">JLS
§5.1.7</a>). If you know that the run-time argument to <span style="font-family:monospace">valueOf</span> implies that
the result is interned, then you will need to suppress an error.
(The Interning Checker should make use of the Value Checker to estimate the upper
and lower bounds on char, int, and short values so that it can more
precisely determine whether the result of a given <span style="font-family:monospace">valueOf</span> call is
interned.)</p>
<!--TOC section id="interning-example" Examples-->
<h2 id="interning-example" class="section">6.5 Examples <a href="#interning-example"><img src="chainlink.svg" width="10" height="10"></a></h2><!--SEC END --><p>To try the Interning Checker on a source file that uses the <a href="../api/org/checkerframework/checker/interning/qual/Interned.html"><span style="font-family:monospace">@Interned</span></a> qualifier,
use the following command:</p><div style="font-size:small;">
<pre class="verbatim">  javac -processor org.checkerframework.checker.interning.InterningChecker docs/examples/InterningExample.java
</pre>
</div><p>Compilation will complete without errors or warnings.</p><p>To see the checker warn about incorrect usage of annotations, use the following
command:</p><div style="font-size:small;">
<pre class="verbatim">  javac -processor org.checkerframework.checker.interning.InterningChecker docs/examples/InterningExampleWithWarnings.java
</pre>
</div><p>The compiler will issue an error regarding violation of the semantics of
<a href="../api/org/checkerframework/checker/interning/qual/Interned.html"><span style="font-family:monospace">@Interned</span></a>.
</p><p>The Daikon invariant detector
(<a href="http://plse.cs.washington.edu/daikon/"><span style="font-family:monospace">http://plse.cs.washington.edu/daikon/</span></a>) is also annotated with
<a href="../api/org/checkerframework/checker/interning/qual/Interned.html"><span style="font-family:monospace">@Interned</span></a>. From directory <span style="font-family:monospace">java/</span>,
run <span style="font-family:monospace">make check-interning</span>.</p><p>The paper “Building and using pluggable
type-checkers” ‍[<a href="#DietlDEMS2011">DDE+11</a>] (ICSE 2011,
<a href="https://homes.cs.washington.edu/~mernst/pubs/pluggable-checkers-icse2011.pdf"><span style="font-family:monospace">https://homes.cs.washington.edu/~mernst/pubs/pluggable-checkers-icse2011.pdf</span></a>)
describes case studies in which the Interning Checker found
previously-unknown errors in real software.</p>
<!--TOC section id="other-interning-annotations" Other interning annotations-->
<h2 id="other-interning-annotations" class="section">6.6 Other interning annotations <a href="#other-interning-annotations"><img src="chainlink.svg" width="10" height="10"></a></h2><!--SEC END --><p>The Checker Framework’s interning annotations are similar to annotations used
elsewhere.</p><p>If your code is already annotated with a different interning
annotation, the Checker Framework can type-check your code.
It treats annotations from other tools
as if you had written the corresponding annotation from the
Interning Checker, as described in Figure ‍<a href="#fig-interning-refactoring">6.2</a>.
If the other annotation is a declaration annotation, it may be moved; see
Section ‍<a href="#declaration-annotations-moved">38.6.8</a>.</p><blockquote class="figure"><div class="center"><hr class="floatrule"></div>
<div class="center">
<table style="border-spacing:6px;border-collapse:separate;" class="cellpading0"><tr><td style="text-align:left;white-space:nowrap" ><table border=1  style="border-spacing:0;" class="cellpadding1"><tr><td style="text-align:left;border:solid 1px;white-space:nowrap" >  ‍com.sun.istack.internal.Interned ‍ </td></tr>
</table></td><td style="text-align:left;white-space:nowrap" >⇒
 ‍org.checkerframework.checker.interning.qual.Interned ‍
</td></tr>
</table>
</div>
<div class="caption"><table style="border-spacing:6px;border-collapse:separate;" class="cellpading0"><tr><td style="vertical-align:top;text-align:left;" >Figure 6.2: Correspondence between other interning annotations and the
Checker Framework’s annotations.</td></tr>
</table></div>
<a id="fig-interning-refactoring"></a>
<div class="center"><hr class="floatrule"></div></blockquote><hr>
<!--TOC chapter id="called-methods-checker" Called Methods Checker for the builder pattern and more-->
<h1 id="called-methods-checker" class="chapter">Chapter ‍7 Called Methods Checker for the builder pattern and more <a href="#called-methods-checker"><img src="chainlink.svg" width="10" height="10"></a></h1><!--SEC END --><p>The Called Methods Checker tracks the names of methods that have definitely
been called on an object. This checker is useful for checking any property
of the form “call method A before method B”. For the purpose of this
checker, a method has “definitely been called” if it is <em>invoked</em>:
a method that might never return or that might throw an exception has
definitely been called on every path after the call, including exceptional paths.
The checker also assumes that the program is free of null-pointer dereferences.
You can verify that all pointer dereferences are safe
by running the Nullness Checker (Section ‍<a href="#nullness-checker">3</a>).</p><p>The Called Methods Checker provides built-in support for one such property:
that clients of the builder pattern for object
construction always provide all required arguments before calling
<span style="font-family:monospace">build()</span>. The builder pattern is a flexible and readable way to
construct objects, but it is error-prone. Failing to provide
a required argument causes a run-time error that manifests during testing
or in the field, instead of at compile time as for regular Java
constructors. The Called Methods Checker verifies at compile time that
your code correctly uses the builder pattern, never omitting a required
argument. The Called Methods Checker has built-in support for
<a href="https://projectlombok.org/">Lombok</a> (see the caveats about Lombok in
Section ‍<a href="#called-methods-lombok">7.2</a>) and
<a href="https://github.com/google/auto/blob/master/value/userguide/index.md">AutoValue</a>.</p><p>You can verify other builders, or verify other properties of the form
“<span style="font-family:monospace">foo()</span> must be called before <span style="font-family:monospace">bar()</span>”, by writing method specifications.
Section ‍<a href="#called-methods-other">7.5</a> describes another example related to a
security property.</p><p>If the checker issues no warnings, then you have a guarantee that your code
supplies all the required information to the builder. The checker might
yield a false positive warning when your code is too tricky for it to
verify. Please submit an
<a href="https://github.com/typetools/checker-framework/issues">issue</a> if you
discover this.</p>
<!--TOC section id="called-methods-run-checker" How to run the Called Methods Checker-->
<h2 id="called-methods-run-checker" class="section">7.1 How to run the Called Methods Checker <a href="#called-methods-run-checker"><img src="chainlink.svg" width="10" height="10"></a></h2><!--SEC END --><pre class="verbatim">javac -processor calledmethods MyFile.java ...
javac -processor org.checkerframework.checker.calledmethods.CalledMethodsChecker MyFile.java ...
</pre><p>The Called Methods Checker supports the following optional command-line arguments:
</p><ul class="itemize"><li class="li-itemize">
The <span style="font-family:monospace">-ACalledMethodsChecker_disableBuilderFrameworkSupports</span> option disables automatic
annotation inference for builder frameworks.
Section ‍<a href="#called-methods-framework-details">7.4</a> describes its syntax.
Supply this if you are uninterested in errors in the use of builders, but
are using the Called Methods Checker to detect errors in other types of
code.
</li><li class="li-itemize">The <span style="font-family:monospace">-ACalledMethodsChecker_disableReturnsReceiver</span> option disables
the Returns Receiver Checker (Chapter ‍<a href="#returns-receiver-checker">23</a>),
which ordinarily runs as a subchecker of the Called Methods Checker. If
the code being checked does not use fluent APIs, then you can supply this
option and the Called Methods Checker will run much faster.
</li><li class="li-itemize">The <span style="font-family:monospace">-ACalledMethodsChecker_useValueChecker</span> option improves precision when analyzing
code that uses the AWS SDK’s <span style="font-family:monospace">DescribeImageRequest</span> API. See
Section ‍<a href="#called-methods-other">7.5</a>.
</li></ul>
<!--TOC section id="called-methods-lombok" For Lombok users-->
<h2 id="called-methods-lombok" class="section">7.2 For Lombok users <a href="#called-methods-lombok"><img src="chainlink.svg" width="10" height="10"></a></h2><!--SEC END --><p>The Called Methods Checker supports projects that use Lombok via
the <a href="https://plugins.gradle.org/plugin/io.freefair.lombok">io.freefair.lombok</a> Gradle plugin automatically.
However, note that the checker’s error messages refer to Lombok’s output, which is a variant of your source code
that appears in a <span style="font-family:monospace">delombok</span> directory.
To fix issues, you should edit your original source code, <span style="font-weight:bold">not</span> the files in the checker’s error messages.</p><p>If you use Lombok with a build system other than Gradle, you must configure it to do two tasks.
If either of these is not done, the checker will not issue any errors on Lombok code.
</p><ul class="itemize"><li class="li-itemize">
set Lombok configuration option <span style="font-family:monospace">lombok.addLombokGeneratedAnnotation = true</span>
</li><li class="li-itemize">delombok the code before passing it to the checker
</li></ul>
<!--TOC section id="called-methods-spec" Specifying your code-->
<h2 id="called-methods-spec" class="section">7.3 Specifying your code <a href="#called-methods-spec"><img src="chainlink.svg" width="10" height="10"></a></h2><!--SEC END --><p>The Called Methods Checker reads method specifications (contracts) that
state what a method requires when it is called. It warns if method
arguments do not satisfy the method’s specification.</p><p>If you use AutoValue or Lombok, most specifications are automatically
inferred by the Called Methods Checker, from field annotations such as
<span style="font-family:monospace">@Nullable</span> and field types such as
<span style="font-family:monospace">Optional</span>. Section ‍<a href="#called-methods-framework-details">7.4</a> gives
defaulting rules for Lombok and AutoValue.</p><blockquote class="figure"><div class="center"><hr class="floatrule"></div>
<div class="center">
<div class="center">
<img src="calledmethods.svg">
</div>
</div>
<div class="caption"><table style="border-spacing:6px;border-collapse:separate;" class="cellpading0"><tr><td style="vertical-align:top;text-align:left;" >Figure 7.1: The type hierarchy for the Called Methods type system, for an object with two methods: <span style="font-family:monospace">a()</span> and <span style="font-family:monospace">b()</span>.
Types displayed in gray should rarely be written by the programmer.</td></tr>
</table></div>
<a id="fig-called-methods-types"></a>
<div class="center"><hr class="floatrule"></div></blockquote><p>In some cases, you may need to specify your code. You do so by writing one of the following type
annotations (Figure ‍<a href="#fig-called-methods-types">7.1</a>):
</p><dl class="description"><dt class="dt-description">
<a href="../api/org/checkerframework/checker/calledmethods/qual/CalledMethods.html"><span style="font-weight:bold"><span style="font-family:monospace">@CalledMethods</span></span></a><span style="font-weight:bold"><span style="font-family:monospace">(String[] methodNames)</span></span></dt><dd class="dd-description">
The annotated type represents values on which all the given method were definitely called.
(Other methods might also have been called.) <span style="font-family:monospace">@CalledMethods()</span>, with no
arguments, is the default annotation.<p>Suppose that the method <span style="font-family:monospace">build</span> is annotated as</p><pre class="verbatim">  class MyObjectBuilder {
    MyObject build(@CalledMethods({"setX", "setY"}) MyObjectBuilder this) { ... }
  }
  </pre><p>Then the receiver for any call to <span style="font-family:monospace">build()</span> must have had <span style="font-family:monospace">setX()</span> and <span style="font-family:monospace">setY()</span> called on it.</p><p>A typical case for Lombok users for manually writing this annotation is when performing extra
builder input validation. Performing validation can be done through subclassing generated builders
and overriding the generated <span style="font-family:monospace">build()</span> method as follows.</p><pre class="verbatim">    class MyObjectSubBuilder extends MyObjectBuilder {
      @Override
      MyObject build(@CalledMethods({"setX", "setY"}) MyObjectSubBuilder this) {
        MyObject o = super.build();
        if ((o.getX() == null) != (o.getY() == null)) {
          throw new IllegalArgumentException("Nullness for x and y should be equal");
        }
        return o;
      }
    }
  </pre></dd><dt class="dt-description"><a href="../api/org/checkerframework/checker/calledmethods/qual/CalledMethodsPredicate.html"><span style="font-weight:bold"><span style="font-family:monospace">@CalledMethodsPredicate</span></span></a><span style="font-weight:bold"><span style="font-family:monospace">(String expression)</span></span></dt><dd class="dd-description">
The boolean expression specifies the required method calls. The string
is a boolean expression composed of method names, disjunction (<span style="font-family:monospace">||</span>),
conjunction (<span style="font-family:monospace">&amp;&amp;</span>), not (<span style="font-family:monospace">!</span>), and parentheses.<p>For example, the annotation <span style="font-family:monospace">@CalledMethodsPredicate("x &amp;&amp; y || z")</span> on a type represents
objects such that either both the <span style="font-family:monospace">x()</span> and <span style="font-family:monospace">y()</span> methods have been called on the object, <span style="font-weight:bold">or</span>
the <span style="font-family:monospace">z()</span> method has been called on the object.</p><p>A note on the not operator (<span style="font-family:monospace">!</span>): the annotation
<span style="font-family:monospace">@CalledMethodsPredicate("!m")</span> means “it is not true <span style="font-family:monospace">m</span> was
definitely called”; equivalently “there is some path on which <span style="font-family:monospace">m</span> was
not called”. The annotation <span style="font-family:monospace">@CalledMethodsPredicate("!m")</span> does
<em>not</em> mean “<span style="font-family:monospace">m</span> was not called”.</p><p>The Called Methods Checker does not have a way of expressing that a
method must never be called. You can do unsound bug-finding for such a
property by using the <span style="font-family:monospace">!</span> operator. The Called Methods Checker will
detect if the method was always called, but will silently approve the code
if the method is called on some but not all paths.</p></dd><dt class="dt-description"><a href="../api/org/checkerframework/common/returnsreceiver/qual/This.html"><span style="font-weight:bold"><span style="font-family:monospace">@This</span></span></a></dt><dd class="dd-description">
<span style="font-family:monospace">@This</span> may only be written on a method return type, and means that the method returns its receiver.
This is helpful when type-checking fluent APIs. This annotation is defined by the
Returns Receiver Checker (Chapter ‍<a href="#returns-receiver-checker">23</a>), but is particularly useful
for the Called Methods Checker because many builders are fluent APIs.<p>For Lombok users it is important to (manually) add <span style="font-family:monospace">@This</span> to any custom method that calls any other
generated builder method. For instance, in the following example, it is important to annotate
<span style="font-family:monospace">setXMod42()</span> with <span style="font-family:monospace">@This</span>, since the added method calls <span style="font-family:monospace">setX()</span> (which returns the current builder
instance).</p><pre class="verbatim">      class MyObjectBuilder {

        @This
        MyObjectBuilder setXMod42(int x) {
          return setX(x % 42);
        }
      }
  </pre></dd><dt class="dt-description"><a href="../api/org/checkerframework/checker/calledmethods/qual/CalledMethodsBottom.html"><span style="font-weight:bold"><span style="font-family:monospace">@CalledMethodsBottom</span></span></a></dt><dd class="dd-description">
The bottom type for the Called Methods hierarchy. Conceptually, this annotation
means that all possible methods have been called on the object. Programmers should rarely,
if ever, need to write this annotation—write an appropriate <span style="font-family:monospace">@CalledMethods</span> annotation
instead. The type of <span style="font-family:monospace">null</span> is <span style="font-family:monospace">@CalledMethodsBottom</span>.</dd></dl><p>There are also method annotations:</p><dl class="description"><dt class="dt-description">
<a id="called-methods-ensurescalledmethods"></a>
<a href="../api/org/checkerframework/checker/calledmethods/qual/EnsuresCalledMethods.html"><span style="font-weight:bold"><span style="font-family:monospace">@EnsuresCalledMethods</span></span></a></dt><dd class="dd-description">
This declaration annotation specifies a post-condition on a method, indicating the methods it
guarantees to be called.<p>For example, this specification:</p><pre class="verbatim">    @EnsuresCalledMethods(value = "#1", methods = {"x", "y"})
    void m(Param p) { ... }
  </pre><p>guarantees that <span style="font-family:monospace">p.x()</span> and <span style="font-family:monospace">p.y()</span> will always be called before <span style="font-family:monospace">m</span> returns.
The body of <span style="font-family:monospace">m</span> must satisfy that property, and clients of <span style="font-family:monospace">m</span> can depend on the property.</p><p>Sometimes, you need to provide information to enable the Called Methods
Checker to verify the property.
Consider this example:
</p><pre class="verbatim">  @EnsuresCalledMethods(value="#1", methods="close")
  public void closeSocket(Socket sock) throws IOException {
      sock.close();
      m();
  }
  </pre><p>If <span style="font-family:monospace">m()</span> might have side-effects (i.e., it is not annotated as
<a href="../api/org/checkerframework/dataflow/qual/SideEffectFree.html"><span style="font-family:monospace">@SideEffectFree</span></a> or <a href="../api/org/checkerframework/dataflow/qual/Pure.html"><span style="font-family:monospace">@Pure</span></a>),
then the Called Methods Checker issues an error because
it cannot make any assumptions about the call to <span style="font-family:monospace">m()</span>, and therefore assumes
the worst: that all information it knows about in-scope variables (including
that <span style="font-family:monospace">close()</span> was called on <span style="font-family:monospace">sock</span>) is stale and must be discarded.
There are two possible fixes:</p><ul class="itemize"><li class="li-itemize">
add a <span style="font-family:monospace">@SideEffectFree</span> or <span style="font-family:monospace">@Pure</span> annotation to <span style="font-family:monospace">m()</span>, if <span style="font-family:monospace">m()</span> is
in fact side-effect free or pure; or
</li><li class="li-itemize">re-order the calls to <span style="font-family:monospace">sock.close()</span> and <span style="font-family:monospace">m()</span> so that the call
to <span style="font-family:monospace">sock.close()</span> appears last in <span style="font-family:monospace">closeSocket()</span>.
</li></ul></dd><dt class="dt-description"><a href="../api/org/checkerframework/checker/calledmethods/qual/EnsuresCalledMethodsIf.html"><span style="font-weight:bold"><span style="font-family:monospace">@EnsuresCalledMethodsIf</span></span></a></dt><dd class="dd-description">
This declaration annotation specifies a post-condition on a method, indicating the methods it
guarantees to be called if it returns a given result.<p>For example, this specification:</p><pre class="verbatim">    @EnsuresCalledMethodsIf(expression = "#1", methods = {"x", "y"}, result=true)
    boolean m(Param p) { ... }
  </pre><p>guarantees that <span style="font-family:monospace">p.x()</span> and <span style="font-family:monospace">p.y()</span> will always be called if <span style="font-family:monospace">m</span> returns <span style="font-family:monospace">true</span>.
The body of <span style="font-family:monospace">m</span> must satisfy that property, and clients of <span style="font-family:monospace">m</span> can depend on the property.</p></dd><dt class="dt-description"><a href="../api/org/checkerframework/checker/calledmethods/qual/EnsuresCalledMethodsVarArgs.html"><span style="font-weight:bold"><span style="font-family:monospace">@EnsuresCalledMethodsVarArgs</span></span></a></dt><dd class="dd-description">
This version of <span style="font-family:monospace">@EnsuresCalledMethods</span> always applies to the varargs parameter of the
annotated method. It has only one argument, which is the list of methods that are guaranteed
to be called on the varargs parameter’s elements before the method returns. This annotation
currently cannot be verified, and a <span style="font-family:monospace">ensuresvarargs.unverified</span> error is always issued
when it is used. When annotating a method as <span style="font-family:monospace">@EnsuresCalledMethodsVarArgs</span>, you should verify
that the named methods are actually called on every element of the varargs parameter via some
other method (such as manual inspection) and then suppress the warning.</dd><dt class="dt-description"><a href="../api/org/checkerframework/checker/calledmethods/qual/RequiresCalledMethods.html"><span style="font-weight:bold"><span style="font-family:monospace">@RequiresCalledMethods</span></span></a></dt><dd class="dd-description">
This declaration annotation specifies a pre-condition on a method, indicating that the expressions
in its <span style="font-family:monospace">value</span> argument must have called-methods types that include all the methods named
in its <span style="font-family:monospace">methods</span> argument. If the expression is a parameter of the annotated method, you should
use an <span style="font-family:monospace">@CalledMethods</span> annotation on the parameter instead.</dd></dl>
<!--TOC section id="called-methods-framework-details" Default handling for Lombok and AutoValue-->
<h2 id="called-methods-framework-details" class="section">7.4 Default handling for Lombok and AutoValue <a href="#called-methods-framework-details"><img src="chainlink.svg" width="10" height="10"></a></h2><!--SEC END --><p>This section explains how the Called Methods Checker infers types for code
that uses the Lombok and AutoValue frameworks. Most readers can skip these
details.</p><p>You can disable the builder framework support by specifying them in a
comma-separated lowercase list to the command-line flag
<span style="font-family:monospace">disableBuilderFrameworkSupports</span>. For example, to disable both Lombok
and AutoValue support, use: <br>
<span style="font-family:monospace">-ACalledMethodsChecker_disableBuilderFrameworkSupports=autovalue,lombok</span></p><p>The Called Methods Checker automatically assumes default annotations for code that uses builders generated
by Lombok and AutoValue. There are three places annotations are usually assumed:
</p><ul class="itemize"><li class="li-itemize">
A <span style="font-family:monospace">@CalledMethods</span> annotation is placed on the receiver of the
<span style="font-family:monospace">build()</span> method, indicating the setter methods that must be invoked on
the builder before calling <span style="font-family:monospace">build()</span>. For Lombok, this annotation’s
argument is the set of <span style="font-family:monospace">@lombok.NonNull</span> fields that do not have default
values. For AutoValue, it is the set of fields that are not
<span style="font-family:monospace">@Nullable</span>, <span style="font-family:monospace">Optional</span>, or a Guava Immutable Collection.
</li><li class="li-itemize">The return type of a <span style="font-family:monospace">toBuilder()</span> method (for example, if the
<span style="font-family:monospace">toBuilder = true</span> option is passed to Lombok’s <span style="font-family:monospace">@Builder</span> annotation)
is annotated with the same <span style="font-family:monospace">@CalledMethods</span> annotation as the receiver
of <span style="font-family:monospace">build()</span>, using the same rules as above.
</li><li class="li-itemize">A <span style="font-family:monospace">@This</span> annotation is placed on the return type of each setter in
the builder’s implementation.
</li></ul><p>If your program directly defines any of these methods (for example, by adding your own setters to
a Lombok builder), you may need to write the annotations manually.</p><p>Minor notes/caveats on these rules:
</p><ul class="itemize"><li class="li-itemize">
Lombok fields annotated with <span style="font-family:monospace">@Singular</span> will be treated as defaulted (i.e., not required), because
Lombok will set them to empty collections if the corresponding setter is not called.
</li><li class="li-itemize">If you manually provide defaults to a Lombok builder (for example, by defining the builder yourself
and assigning a default value to the builder’s field), the checker will treat that field as defaulted
<em>most</em> of the time. In particular, it will not treat it as defaulted if it is defined in bytecode rather
than in source code.
</li></ul>
<!--TOC section id="called-methods-other" Using the Called Methods Checker for properties unrelated to builders-->
<h2 id="called-methods-other" class="section">7.5 Using the Called Methods Checker for properties unrelated to builders <a href="#called-methods-other"><img src="chainlink.svg" width="10" height="10"></a></h2><!--SEC END --><p>The Called Methods Checker can be used to verify any property of the form
“always call A before B”, even if the property is unrelated to builders.</p><p>For example, consider the AWS EC2 <span style="font-family:monospace">describeImages</span> API, which
clients use during the process of initializing a new cloud instance.
<a href="https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2018-15869">CVE-2018-15869</a>
describes how an improperly-configured request to this API can make the
requesting client vulnerable to a “machine-image sniping” attack that
would allow a malicious third-party to control the operating system image
used to initialize the machine. To prevent this attack, clients must
specify some trusted source for the image by calling the <span style="font-family:monospace">withOwners</span> or
<span style="font-family:monospace">withImageIds</span> methods on the request prior to sending it to AWS. Using
a stub file for the <span style="font-family:monospace">describeImages</span> API
(<a href="https://github.com/typetools/checker-framework/blob/master/checker/src/main/java/org/checkerframework/checker/calledmethods/DescribeImages.astub">DescribeImages.astub</a>),
the Called Methods Checker can prove that a client is not vulnerable to
such an attack.</p><p>To improve precision, you can specify the
<span style="font-family:monospace">-ACalledMethodsChecker_useValueChecker</span> command-line option, which
instructs the checker to treat provably-safe calls to the <span style="font-family:monospace">withFilters</span>
method of a <span style="font-family:monospace">DescribeImagesRequest</span> as equivalent to the <span style="font-family:monospace">withOwners</span> or
<span style="font-family:monospace">withImageIds</span> methods.</p>
<!--TOC section id="called-methods-more-information" More information-->
<h2 id="called-methods-more-information" class="section">7.6 More information <a href="#called-methods-more-information"><img src="chainlink.svg" width="10" height="10"></a></h2><!--SEC END --><p>The paper “Verifying Object Construction” ‍[<a href="#KelloggRSSE2020">KRS+20</a>] (ICSE 2020,
<a href="https://homes.cs.washington.edu/~mernst/pubs/object-construction-icse2020-abstract.html"><span style="font-family:monospace">https://homes.cs.washington.edu/~mernst/pubs/object-construction-icse2020-abstract.html</span></a>)
gives more information about the Called Methods Checker, such as
theoretical underpinnings and results of experiments. (The paper uses an
earlier name, “Object Construction Checker”.)

</p><hr>
<!--TOC chapter id="resource-leak-checker" Resource Leak Checker for must-call obligations-->
<h1 id="resource-leak-checker" class="chapter">Chapter ‍8 Resource Leak Checker for must-call obligations <a href="#resource-leak-checker"><img src="chainlink.svg" width="10" height="10"></a></h1><!--SEC END --><p>The Resource Leak Checker guarantees that the program fulfills every object’s
must-call obligations before the object is de-allocated.</p><p>A resource leak occurs when a program does not explicitly dispose of some finite
underlying resource, such as a socket, file descriptor, or database connection. To dispose
of the resource, the program should call some method on an object.
(De-allocating or garbage-collecting the object is not sufficient.) For
example, the program must call <span style="font-family:monospace">close()</span> on every object that implements the
interface <span style="font-family:monospace">java.io.Closeable</span>.</p><p>The Resource Leak Checker can check any property of the form “the programmer
must call each method in a set of methods <em>M</em> at least once
on object <em>O</em> before <em>O</em> is de-allocated”. For resource leaks,
by default <em>M</em> is the set containing
<span style="font-family:monospace">close()</span> and <em>O</em> is any object that implements the interface
<span style="font-family:monospace">java.io.Closeable</span>. You can extend this guarantee to other types and methods
by writing <span style="font-family:monospace">@MustCall</span> or <span style="font-family:monospace">@InheritableMustCall</span> annotations, as described in
Section ‍<a href="#must-call-annotations">27.1</a>.</p><p>The Resource Leak Checker works in three stages:
</p><ol class="enumerate" type=1><li class="li-enumerate">
The Must Call Checker (Chapter ‍<a href="#must-call-checker">27</a>)
over-approximates each expression’s must-call methods as a
<a href="../api/org/checkerframework/checker/mustcall/qual/MustCall.html"><span style="font-family:monospace">@MustCall</span></a> type.
</li><li class="li-enumerate">The Called Methods Checker (Chapter ‍<a href="#called-methods-checker">7</a>)
under-approximates each expression’s definitely-called methods as a
<a href="../api/org/checkerframework/checker/calledmethods/qual/CalledMethods.html"><span style="font-family:monospace">@CalledMethods</span></a> type.
</li><li class="li-enumerate">When any program element goes out of scope (i.e., it is ready to be
de-allocated), the Resource Leak Checker compares the types
<span style="font-family:monospace">@MustCall(</span><span style="font-family:monospace"><em>MC</em></span><span style="font-family:monospace">)</span> and <span style="font-family:monospace">@CalledMethods(</span><span style="font-family:monospace"><em>CM</em></span><span style="font-family:monospace">)</span>. It reports an error
if there exists some method in <em>MC</em> that is not in <em>CM</em>.
</li></ol><p>The paper
“Lightweight and Modular Resource Leak Verification” ‍[<a href="#KelloggSSE2021">KSSE21</a>] (ESEC/FSE 2021,
<a href="https://homes.cs.washington.edu/~mernst/pubs/resource-leak-esecfse2021-abstract.html"><span style="font-family:monospace">https://homes.cs.washington.edu/~mernst/pubs/resource-leak-esecfse2021-abstract.html</span></a>)
gives more details about the Resource Leak Checker.</p>
<!--TOC section id="resource-leak-run-checker" How to run the Resource Leak Checker-->
<h2 id="resource-leak-run-checker" class="section">8.1 How to run the Resource Leak Checker <a href="#resource-leak-run-checker"><img src="chainlink.svg" width="10" height="10"></a></h2><!--SEC END --><p>Run one of these lines:</p><pre class="verbatim">javac -processor resourceleak MyFile.java ...
javac -processor org.checkerframework.checker.resourceleak.ResourceLeakChecker MyFile.java ...
</pre><p>The Resource Leak Checker supports all the command-line arguments
listed in Section ‍<a href="#called-methods-run-checker">7.1</a> for
the Called Methods Checker, plus two others:</p><dl class="description"><dt class="dt-description">
<span style="font-weight:bold"><span style="font-family:monospace">-ApermitStaticOwning</span></span></dt><dd class="dd-description">
See Section ‍<a href="#resource-leak-owning-fields">8.4.1</a>.
</dd><dt class="dt-description"><span style="font-weight:bold"><span style="font-family:monospace">-ApermitInitializationLeak</span></span></dt><dd class="dd-description">
See Section ‍<a href="#resource-leak-field-initialization">8.8</a>.
</dd></dl><p>If you are running the Resource Leak Checker, then there is no need to run
the Must Call Checker (Chapter ‍<a href="#must-call-checker">27</a>), because the
Resource Leak Checker does so automatically.</p>
<!--TOC section id="resource-leak-annotations" Resource Leak Checker annotations-->
<h2 id="resource-leak-annotations" class="section">8.2 Resource Leak Checker annotations <a href="#resource-leak-annotations"><img src="chainlink.svg" width="10" height="10"></a></h2><!--SEC END --><p>The Resource Leak Checker relies on the type qualifiers of two other checkers:
the Must Call Checker (Section ‍<a href="#must-call-annotations">27.1</a>) and
the Called Methods Checker (Section ‍<a href="#called-methods-spec">7.3</a>). You might need
to write qualifiers from either type hierarchy. The most common annotations from
these checkers that you might need to write are:</p><dl class="description"><dt class="dt-description"><a href="../api/org/checkerframework/checker/mustcall/qual/MustCall.html"><span style="font-weight:bold"><span style="font-family:monospace">@MustCall</span></span></a><span style="font-weight:bold"><span style="font-family:monospace">(String[] value)</span></span></dt><dd class="dd-description">
for example on an element with compile-time type <span style="font-family:monospace">Object</span> that might contain a <span style="font-family:monospace">Socket</span>.
See Section ‍<a href="#must-call-annotations">27.1</a>.</dd><dt class="dt-description"><a href="../api/org/checkerframework/checker/mustcall/qual/InheritableMustCall.html"><span style="font-weight:bold"><span style="font-family:monospace">@InheritableMustCall</span></span></a><span style="font-weight:bold"><span style="font-family:monospace">(String[] value)</span></span></dt><dd class="dd-description">
on any classes defined in your program that have must-call obligations. See Section ‍<a href="#must-call-on-class">27.2</a>.</dd><dt class="dt-description"><a href="../api/org/checkerframework/checker/calledmethods/qual/EnsuresCalledMethods.html"><span style="font-weight:bold"><span style="font-family:monospace">@EnsuresCalledMethods</span></span></a></dt><dd class="dd-description"> on a method in
your code that fulfills a must-call obligation of one of its parameters or of a field.
See Section ‍<a href="#called-methods-ensurescalledmethods">7.3</a>.</dd></dl><p>The Resource Leak Checker supports annotations that express
aliasing patterns related to resource leaks:</p><dl class="description"><dt class="dt-description"><a href="../api/org/checkerframework/checker/mustcall/qual/Owning.html"><span style="font-weight:bold"><span style="font-family:monospace">@Owning</span></span></a></dt><dd class="dd-description">
</dd><dt class="dt-description"><a href="../api/org/checkerframework/checker/mustcall/qual/NotOwning.html"><span style="font-weight:bold"><span style="font-family:monospace">@NotOwning</span></span></a></dt><dd class="dd-description">
expresses ownership. When two aliases exist to the same Java object,
<span style="font-family:monospace">@Owning</span> and <span style="font-family:monospace">@NotOwning</span> indicate which of the two is responsible for
fulfilling must-call obligations.
Constructor results are always <span style="font-family:monospace">@Owning</span>. Method returns default to
<span style="font-family:monospace">@Owning</span>. Formal parameters and fields default to <span style="font-family:monospace">@NotOwning</span>.
For more details, see Section ‍<a href="#resource-leak-ownership">8.4</a>.</dd><dt class="dt-description"><a href="../api/org/checkerframework/checker/mustcall/qual/MustCallAlias.html"><span style="font-weight:bold"><span style="font-family:monospace">@MustCallAlias</span></span></a></dt><dd class="dd-description">
represents a “resource-aliasing” relationship. Resource aliases are
distinct Java objects that control the same resource(s):
fulfilling the must-call obligations of one object also
fulfills the obligations of the other object. For details,
see Section ‍<a href="#resource-leak-resource-alias">8.5</a>.</dd></dl><p>The Resource Leak Checker also supports an annotation to permit re-assigning
fields or re-opening resources:</p><dl class="description"><dt class="dt-description"><a href="../api/org/checkerframework/checker/mustcall/qual/CreatesMustCallFor.html"><span style="font-weight:bold"><span style="font-family:monospace">@CreatesMustCallFor</span></span></a><span style="font-weight:bold"><span style="font-family:monospace">(String value)</span></span></dt><dd class="dd-description">
is a declaration annotation that indicates that after a call to a method
with this annotation none of the must-call obligations of the in-scope, owning expression
listed in <span style="font-family:monospace">value</span> have been met.
In other words, the annotated method “resets” the must-call obligations of the expression.
Multiple <span style="font-family:monospace">@CreatesMustCallFor</span>
annotations can be written on the same method. Section ‍<a href="#resource-leak-createsmustcallfor">8.6</a>
explains how this annotation permits re-assignment of owning
fields or the re-opening of resources.</dd></dl>
<!--TOC section id="resource-leak-example" Example of how safe resource usage is verified-->
<h2 id="resource-leak-example" class="section">8.3 Example of how safe resource usage is verified <a href="#resource-leak-example"><img src="chainlink.svg" width="10" height="10"></a></h2><!--SEC END --><p>Consider the following example of safe use of a <span style="font-family:monospace">Socket</span>, in which the comments indicate the
inferred Must Call and Called Methods type qualifiers for <span style="font-family:monospace">s</span>:
</p><pre class="verbatim">{
  Socket s = null;
  // 1. @MustCall({}) @CalledMethodsBottom
  try {
    s = new Socket(myHost, myPort);
    // 2. @MustCall("close") @CalledMethods({})
  } catch (Exception e) {
    // do nothing
  } finally {
    if (s != null) {
      s.close();
      // 3. @MustCall("close") @CalledMethods("close")
    } else {
      // do nothing
      // 4. @MustCall("close") @CalledMethodsBottom
    }
    // 5. @MustCall("close") @CalledMethods("close")
  }
  // 6. @MustCall("close") @CalledMethods("close")
}
</pre><p>At point 1, <span style="font-family:monospace">s</span>’s type qualifiers are the type qualifiers of <span style="font-family:monospace">null</span>:
<span style="font-family:monospace">null</span> has no must-call obligations (<span style="font-family:monospace">@MustCall({})</span>),
and methods cannot be called on it (<span style="font-family:monospace">@CalledMethodsBottom</span>).</p><p>At point 2, <span style="font-family:monospace">s</span> is a new <span style="font-family:monospace">Socket</span> object, which
has a must-call obligation (<span style="font-family:monospace">@MustCall("close")</span>)
and has had no methods called on it (<span style="font-family:monospace">@CalledMethods({})</span>).</p><p>At point 3, <span style="font-family:monospace">close()</span> has definitely been called on <span style="font-family:monospace">s</span>, so
<span style="font-family:monospace">s</span>’s Called Methods type is updated. Note that the Must Call type
does not change.</p><p>At point 4, <span style="font-family:monospace">s</span> is definitely <span style="font-family:monospace">null</span> and its type is adjusted accordingly.</p><p>At point 5, <span style="font-family:monospace">s</span>’s type is the least upper bound of the types at points 3
and 4.</p><p>At point 6, <span style="font-family:monospace">s</span> goes out of scope. The Resource Leak Checker reports a
<span style="font-family:monospace">required.method.not.called</span> error if the Must Call set contains any
element that the Called Methods set does not.</p>
<!--TOC section id="resource-leak-ownership" Aliased references and ownership transfer-->
<h2 id="resource-leak-ownership" class="section">8.4 Aliased references and ownership transfer <a href="#resource-leak-ownership"><img src="chainlink.svg" width="10" height="10"></a></h2><!--SEC END --><p>Resource leak checking is complicated by aliasing. Multiple expressions
may evaluate to the same Java object, but each object only needs to be
closed once. (Section ‍<a href="#resource-leak-resource-alias">8.5</a> describes a
related situation called “resource aliasing”, when multiple Java objects
refer to the same underlying resource.)</p><p>For example, consider the following code that safely closes a <span style="font-family:monospace">Socket</span>:</p><pre class="verbatim">  void example(String myHost, int myPort) {
    Socket s = new Socket(myHost, myPort);
    closeSocket(s);
  }
  void closeSocket(@Owning @MustCall("close") Socket t) {
    t.close();
  }
</pre><p>There are two aliases for a socket object: <span style="font-family:monospace">s</span> in <span style="font-family:monospace">example()</span> and <span style="font-family:monospace">t</span> in
<span style="font-family:monospace">closeSocket()</span>. Ordinarily, the Resource Leak Checker requires that
<span style="font-family:monospace">close()</span> is called on every expression of type <span style="font-family:monospace">Socket</span>, but that is not
necessary here. The Resource Leak Checker should not warn when
<span style="font-family:monospace">s</span> goes out of scope in <span style="font-family:monospace">example()</span>, because <span style="font-family:monospace">closeSocket()</span> takes ownership
of the socket — that is, <span style="font-family:monospace">closeSocket()</span> takes responsibility for closing
it. The <span style="font-family:monospace">@Owning</span> annotation on <span style="font-family:monospace">t</span>’s declaration expresses this fact; it
tells the Resource Leak Checker that <span style="font-family:monospace">t</span> is the reference that must be
closed, and its alias <span style="font-family:monospace">s</span> need not be closed.</p><p>Constructor returns are always <span style="font-family:monospace">@Owning</span>.
Method returns default to <span style="font-family:monospace">@Owning</span>,
and parameters and fields default to <span style="font-family:monospace">@NotOwning</span>. This treatment of parameter and
return types ensures sound handling of unannotated third-party libraries: any
object returned from such a library will be tracked by default, and the checker
never assumes that passing an object to an unannotated library will satisfy its obligations.</p><p><span style="font-family:monospace">@Owning</span> and <span style="font-family:monospace">@NotOwning</span> always <em>transfer</em> must-call obligations: must-call
obligations are conserved (i.e., neither created nor destroyed) by ownership annotations.
Writing <span style="font-family:monospace">@Owning</span> or <span style="font-family:monospace">@NotOwning</span> can never make the checker
unsound: a real warning can never be hidden by them.
As with any annotation, incorrect or missing annotations can lead to false positive warnings.</p>
<!--TOC subsection id="resource-leak-owning-fields" Owning fields-->
<h3 id="resource-leak-owning-fields" class="subsection">8.4.1 Owning fields <a href="#resource-leak-owning-fields"><img src="chainlink.svg" width="10" height="10"></a></h3><!--SEC END --><p>Unannotated fields are treated as non-owning.</p><p>For <span style="font-weight:bold">final, non-static owning fields</span>,
the Resource Leak Checker enforces the “resource acquisition is
initialization (RAII)” programming idiom. Some
destructor-like method <span style="font-family:monospace">d()</span> must satisfy the field’s must-call obligation
(and this fact must be expressed via a <span style="font-family:monospace">@EnsuresCalledMethods</span> annotation on <span style="font-family:monospace">d()</span>),
and the enclosing class must have a <span style="font-family:monospace">@MustCall("d")</span> obligation to
ensure the destructor is called. In addition to the <span style="font-family:monospace">@EnsuresCalledMethods</span> annotation,
which guarantees that the field(s) it references have their must-call obligations satisfied
on non-exceptional paths, the Resource Leak Checker requires those fields to have their must-call
obligations satisfied on all paths in (only) the destructor, and will issue a <span style="font-family:monospace">destructor.exceptional.postcondition</span>
error if they are not satisfied. Resolve this error by ensuring that the required methods are called
on all exceptional paths.</p><p><span style="font-weight:bold">Non-final, non-static owning fields</span> usually require one or more <span style="font-family:monospace">@CreatesMustCallFor</span> annotations
when they might be re-assigned. See Section ‍<a href="#resource-leak-createsmustcallfor">8.6</a> for
more details on how to annotate a non-final, non-static owning field.</p><p>An assignment to a <span style="font-weight:bold">static owning field</span> does not satisfy a
must-call obligation; for example,</p><pre class="verbatim">  static @Owning PrintWriter debugLog = new PrintWriter("debug.log");
</pre><p>The Resource Leak Checker issues a warning about every assignment of an
object with a must-call annotation into a static owning field,
indicating that the obligation of the field’s content might not be
satisfied. When those fields are used throughout execution, until the
program exits, there is no good place to dispose of them, so these warnings
might not be useful. The <span style="font-family:monospace">-ApermitStaticOwning</span> command-line argument
suppresses warnings related to static owning fields. This can help in
checking legacy code. It permits only a small number of resource retained
throughout execution, related to the number of such fields and assignments
to them.</p>
<!--TOC section id="resource-leak-resource-alias" Resource aliasing-->
<h2 id="resource-leak-resource-alias" class="section">8.5 Resource aliasing <a href="#resource-leak-resource-alias"><img src="chainlink.svg" width="10" height="10"></a></h2><!--SEC END --><p>A <em>resource alias</em> set is a set of Java objects that
correspond to the same underlying system resource.
Calling a must-call method on any member of a resource-alias set
fulfills that obligation for all members of the set.
Members of the set may have different Java types.</p><p>Programmers most often encounter resource aliasing when using <em>wrapper types</em>.
For example, the Java <span style="font-family:monospace">Buffered&#173;Output&#173;Stream</span> wrapper adds buffering to a
delegate stream.
The wrapper’s <span style="font-family:monospace">close()</span> method invokes <span style="font-family:monospace">close()</span> on the delegate. Calling
<span style="font-family:monospace">close()</span> on either object has the same effect: it closes the underlying resource.</p><p>A resource aliasing relationship is expressed in source code via a pair of <span style="font-family:monospace">@MustCallAlias</span> annotations:
one on a parameter of a method or constructor, and another on its return type.
For example, the annotated JDK contains this constructor of <span style="font-family:monospace">BufferedOutputStream</span>:
</p><pre class="verbatim">@MustCallAlias BufferedOutputStream(@MustCallAlias OutputStream out);
</pre><p>When a pair of <span style="font-family:monospace">@MustCallAlias</span> annotations is written on a method or constructor <span style="font-family:monospace">m</span>’s return type
and its parameter <span style="font-family:monospace">p</span>, the Resource Leak Checker requires one of the following:
</p><ol class="enumerate" type=1><li class="li-enumerate">
<span style="font-family:monospace">p</span> is passed to another method or constructor (including <span style="font-family:monospace">super</span>) in a
<span style="font-family:monospace">@MustCallAlias</span> position, and <span style="font-family:monospace">m</span> returns that method’s result, or
</li><li class="li-enumerate"><span style="font-family:monospace">p</span> is stored in the only <span style="font-family:monospace">@Owning</span> field of the enclosing class (a class with more than one
<span style="font-family:monospace">@Owning</span> field cannot have a resource alias relationship).
</li></ol>
<!--TOC section id="resource-leak-createsmustcallfor" Creating obligations (how to re-assign a non-final owning field)-->
<h2 id="resource-leak-createsmustcallfor" class="section">8.6 Creating obligations (how to re-assign a non-final owning field) <a href="#resource-leak-createsmustcallfor"><img src="chainlink.svg" width="10" height="10"></a></h2><!--SEC END --><p>Consider a class that has must-call obligations; that is, the class
declaration is annotated with <span style="font-family:monospace">@MustCall(...)</span>.
Every constructor implicitly creates obligations for the newly-created object.
Non-constructor methods may also create obligations
when re-assigning non-final owning fields or allocating
new system-level resources.</p><p>A post-condition annotation,
<span style="font-family:monospace">@CreatesMustCallFor</span>,
indicates for which expression an obligation is created.
If you write <span style="font-family:monospace">@CreatesMustCallFor(</span><em>T</em><span style="font-family:monospace">)</span> on a method <em>N</em> that
overrides a method <em>M</em>, then <em>M</em> must also be annotated as
<span style="font-family:monospace">@CreatesMustCallFor(</span><em>T</em><span style="font-family:monospace">)</span>. (<em>M</em> may also have other
<span style="font-family:monospace">@CreatesMustCallFor</span> annotations that <em>N</em> does not.)</p><p><span style="font-family:monospace">@CreatesMustCallFor</span> allows the Resource Leak Checker to verify uses of non-final fields
that contain a resource, even if they are re-assigned. Consider
the following example:</p><pre class="verbatim">  @MustCall("close") // default qualifier for uses of SocketContainer
  class SocketContainer {
    private @Owning Socket sock;

    public SocketContainer() { sock = ...; }

    void close() { sock.close() };

    @CreatesMustCallFor("this")
    void reconnect() {
      if (!sock.isClosed()) {
        sock.close();
      }
      sock = ...;
    }
  }
</pre><p>In the lifetime of a <span style="font-family:monospace">SocketContainer</span> object, <span style="font-family:monospace">sock</span>
might be re-assigned arbitrarily many times: once at each
call to <span style="font-family:monospace">reconnect()</span>. This code is safe, however: <span style="font-family:monospace">reconnect()</span>
ensures that <span style="font-family:monospace">sock</span> is closed before re-assigning it.</p><p>Sections ‍<a href="#resource-leak-createsmustcallfor-callsite">8.6.1</a>
and ‍<a href="#resource-leak-createsmustcallfor-declaration">8.6.2</a>
explain how the Resource Leak Checker verifies uses and declarations of
methods annotated with <span style="font-family:monospace">@CreatesMustCallFor</span>.</p>
<!--TOC subsection id="resource-leak-createsmustcallfor-callsite" Requirements at a call site of a <span style="font-family:monospace">@CreatesMustCallFor</span> method-->
<h3 id="resource-leak-createsmustcallfor-callsite" class="subsection">8.6.1 Requirements at a call site of a <span style="font-family:monospace">@CreatesMustCallFor</span> method <a href="#resource-leak-createsmustcallfor-callsite"><img src="chainlink.svg" width="10" height="10"></a></h3><!--SEC END --><p>At a call site to a method annotated as
<span style="font-family:monospace">@CreatesMustCallFor(</span><em>expr</em><span style="font-family:monospace">)</span>, the Resource Leak Checker:
</p><ol class="enumerate" type=1><li class="li-enumerate">
Treats any existing <span style="font-family:monospace">@MustCall</span> obligations of <em>expr</em> as <em>satisfied</em>,
</li><li class="li-enumerate">Creates a fresh obligation to check, as if <em>expr</em> was assigned to a newly-allocated
object (i.e. as if <em>expr</em> were a constructor result).
</li><li class="li-enumerate">Un-refines the type in the Called Methods Checker’s type hierarchy for <em>expr</em> to
<span style="font-family:monospace">@CalledMethods({})</span>, if it had any other Called Methods type.
</li><li class="li-enumerate">Requires that the expression corresponding to <em>expr</em> (that is, <em>expr</em>
viewpoint-adapted to the method call site) is owned; that is, it is
annotated or defaulted as <span style="font-family:monospace">@Owning</span>. Otherwise, the checker
will issue a <span style="font-family:monospace">reset.not.owning</span> error at the call-site. You can avoid this
error by extracting <em>expr</em> into a new local variable (because
locals are <span style="font-family:monospace">@Owning</span> by default) and replacing all instances of <em>expr</em>
in the call with references to the new local variable.
</li></ol><p>Treating the obligation before the call as satisfied is sound: the
checker creates a new obligation for calls to <span style="font-family:monospace">@CreatesMustCallFor</span> methods,
and the Must Call Checker (Chapter ‍<a href="#must-call-checker">27</a>) ensures the
<span style="font-family:monospace">@MustCall</span> type for the target expression will have a <em>superset</em> of any methods
present before the call. Intuitively, calling an <span style="font-family:monospace">@CreatesMustCallFor</span> method
“resets” the obligations of the target expression, so whether they were satisfied before
the call or not is irrelevant.</p><p>If an <span style="font-family:monospace">@CreatesMustCallFor</span>
method <em>n</em> is invoked within a method <em>m</em> that has an <span style="font-family:monospace">@CreatesMustCallFor</span> annotation,
and the <span style="font-family:monospace">@CreatesMustCallFor</span> annotations on <em>n</em> and <em>m</em> have
the same target expression—imposing the obligation produced by calling <em>n</em> on the caller of <em>m</em>—then
the newly-created obligation is treated as satisfied immediately
at the call-site of <em>n</em> in the body of <em>m</em> (because it is imposed at call-sites of <em>m</em>
instead).</p>
<!--TOC subsection id="resource-leak-createsmustcallfor-declaration" Requirements at a declaration of a <span style="font-family:monospace">@CreatesMustCallFor</span> method-->
<h3 id="resource-leak-createsmustcallfor-declaration" class="subsection">8.6.2 Requirements at a declaration of a <span style="font-family:monospace">@CreatesMustCallFor</span> method <a href="#resource-leak-createsmustcallfor-declaration"><img src="chainlink.svg" width="10" height="10"></a></h3><!--SEC END --><p>Any method that re-assigns a non-final, owning field of some object <span style="font-family:monospace">obj</span>
must be annotated <span style="font-family:monospace">@CreatesMustCallFor("obj")</span>.
Other methods may also be annotated with <span style="font-family:monospace">@CreatesMustCallFor</span>.</p><p>The Resource Leak Checker enforces two rules to ensure that re-assignments
to non-final, owning fields (like <span style="font-family:monospace">sock</span> in method <span style="font-family:monospace">reconnect</span> above) are
sound:
</p><ul class="itemize"><li class="li-itemize">
any method that re-assigns a non-final, owning field of an object
must be annotated with a <span style="font-family:monospace">@CreatesMustCallFor</span> annotation
whose expression is a reference to that object.
</li><li class="li-itemize">when a non-final, owning field <span style="font-style:italic">f</span> is re-assigned at statement <span style="font-style:italic">s</span>,
at the program point before <span style="font-style:italic">s</span>, <span style="font-style:italic">f</span>’s must-call obligations must have been satisfied.
</li></ul><p>
The first rule ensures that <span style="font-family:monospace">close()</span> is called after the last call
to <span style="font-family:monospace">reconnect()</span>, and the second rule ensures that <span style="font-family:monospace">reconnect()</span>
safely closes <span style="font-family:monospace">sock</span> before re-assigning it. Because the Called Methods Checker
treats calls to an <span style="font-family:monospace">@CreatesMustCallFor</span> method like <span style="font-family:monospace">reconnect()</span> as if the call might
cause arbitrary side-effects, after such a call the only method known to have been
definitely called is the <span style="font-family:monospace">@CreatesMustCallFor</span> method: previous called
methods (including <span style="font-family:monospace">close()</span>) do not appear in the <span style="font-family:monospace">@CalledMethods</span> type qualifier.</p>
<!--TOC section id="resource-leak-ignored-exceptions" Ignored exception types-->
<h2 id="resource-leak-ignored-exceptions" class="section">8.7 Ignored exception types <a href="#resource-leak-ignored-exceptions"><img src="chainlink.svg" width="10" height="10"></a></h2><!--SEC END --><p>The Resource Leak Checker checks that an element’s must-call obligations
are fulfilled when that element may go out of scope: at the end of its
lexical scope or when control may be transferred to the end of its lexical
scope, such as via a <span style="font-family:monospace">break</span> or <span style="font-family:monospace">continue</span> statement or via throwing an
exception. As an example of an exception, consider the following method:</p><pre class="verbatim">  void foo() {
    Socket s = ...;
    bar();
    s.close();
  }
</pre><p>If <span style="font-family:monospace">bar</span> is declared to throw an exception, the Resource Leak Checker
warns that a <span style="font-family:monospace">Socket</span> may be leaked. If <span style="font-family:monospace">bar</span> throws an exception, the
only reference to <span style="font-family:monospace">s</span> is lost, which could lead to a resource leak.</p><p>The Resource Leak Checker ignores control flow due to some exceptions.</p><ul class="itemize"><li class="li-itemize">
The Resource Leak Checker ignores run-time errors that can occur
unpredictably at most points in the program. For example, the JVM can throw
an <span style="font-family:monospace">OutOfMemoryError</span> on any allocation. Similarly,
<span style="font-family:monospace">ClassCircularityError</span>, <span style="font-family:monospace">ClassFormatError</span>, and <span style="font-family:monospace">NoClassDefFoundError</span>
may occur at any reference to a class. Such exceptions usually terminate
the program, and in that case unclosed resources do not matter.
Accounting for such exceptions would lead to vast numbers of
false positive warnings, so the Resource Leak Checker assumes they are
never thrown. Strictly speaking, this is an unsoundness: it can lead to
false negatives (missed resource leaks) if the programmer catches these
exceptions, which is a discouraged practice.</li><li class="li-itemize">The Resource Leak Checker also ignores exception types that can be verified
to never occur. In particular, the Resource Leak Checker ignores <span style="font-family:monospace">NullPointerException</span>s
(use the Nullness Checker, Chapter ‍<a href="#nullness-checker">3</a>) and
<span style="font-family:monospace">ArrayIndexOutOfBoundsException</span>s and <span style="font-family:monospace">NegativeArraySizeException</span>s (use the Index
Checker, Chapter ‍<a href="#index-checker">12</a>). Other exception types may be added to this
list in the future. Please let us know if there is a type that you think should
be ignored by filing an issue listing both the exception type and the
verification tool.
</li></ul>
<!--TOC section id="resource-leak-field-initialization" Errors about field initialization-->
<h2 id="resource-leak-field-initialization" class="section">8.8 Errors about field initialization <a href="#resource-leak-field-initialization"><img src="chainlink.svg" width="10" height="10"></a></h2><!--SEC END --><p>The Resource Leak Checker warns about re-assignments to owning fields,
because the value that was overwritten might not have had its obligations
satisfied. Such a warning is not necessary on the first assignment to a
field, since the field had no content before the assignment. Sometimes,
the Resource Leak Checker is unable to determine that an assignment is the
first one, so it conservatively assumes the assignment is a re-assignment
and issues an error.</p><p>One way to prevent this false positive warning is to declare the field as <span style="font-family:monospace">final</span>.</p><p>Alternately, to suppress all warnings related to field assignments in the
constructor and in initializer blocks, pass the
<span style="font-family:monospace">-ApermitInitializationLeak</span> command-line argument. This makes the
checker unsound: the Resource Leak Checker will not warn if the constructor
and initializers set a field more than once. The amount of leakage is
limited to how many times the field is set.</p><hr>
<!--TOC chapter id="fenum-checker" Fake Enum Checker for fake enumerations-->
<h1 id="fenum-checker" class="chapter">Chapter ‍9 Fake Enum Checker for fake enumerations <a href="#fenum-checker"><img src="chainlink.svg" width="10" height="10"></a></h1><!--SEC END --><p>The Fake Enum Checker, or Fenum Checker, enables you to define a type alias
or typedef, in which two different sets of values have the same
representation (the same Java type) but are not allowed to be used
interchangeably. It is also possible to create a typedef using the
Subtyping Checker (Chapter ‍<a href="#subtyping-checker">28</a>), and that approach
is sometimes more appropriate.</p><p>One common use for the Fake Enum Checker is the
<em>fake enumeration pattern</em> (Section ‍<a href="#fenum-pattern">9.6</a>). For
example, consider this code adapted from Android’s
<a href="https://developer.android.com/reference/android/support/annotation/IntDef"><span style="font-family:monospace">IntDef</span></a>
documentation:</p><pre class="verbatim">@NavigationMode int NAVIGATION_MODE_STANDARD = 0;
@NavigationMode int NAVIGATION_MODE_LIST = 1;
@NavigationMode int NAVIGATION_MODE_TABS = 2;

@NavigationMode int getNavigationMode();

void setNavigationMode(@NavigationMode int mode);
</pre><p>The Fake Enum Checker can issue a compile-time warning if the programmer
ever tries to call <span style="font-family:monospace">setNavigationMode</span> with an <span style="font-family:monospace">int</span> that is not a
<span style="font-family:monospace">@NavigationMode int</span>.</p><p>The Fake Enum Checker gives the same safety guarantees as a true enumeration
type or typedef, but retaining backward-compatibility with interfaces that
use existing Java types. You can apply fenum annotations to any Java type,
including all primitive types and also reference types. Thus, you could
use it (for example) to represent floating-point values between 0 and 1, or
<span style="font-family:monospace">String</span>s with some particular characteristic.
(Note that the Fake Enum Checker does not let you create a shorter alias
for a long type name, as a real typedef would if Java supported it.)</p><p>As explained in Section ‍<a href="#fenum-annotations">9.1</a>, you can either define your
own fenum annotations, such as <span style="font-family:monospace">@NavigationMode</span> above, or you can use the
<a href="../api/org/checkerframework/checker/fenum/qual/Fenum.html"><span style="font-family:monospace">@Fenum</span></a> type qualifier with a string argument.
Figure ‍<a href="#fig-fenum-hierarchy">9.1</a> shows part of the type hierarchy for the
Fenum type system.</p><blockquote class="figure"><div class="center"><hr class="floatrule"></div>
<div class="center">
<img src="fenum.svg">
</div>
<div class="caption"><table style="border-spacing:6px;border-collapse:separate;" class="cellpading0"><tr><td style="vertical-align:top;text-align:left;" >Figure 9.1: Partial type hierarchy for the Fenum type system.
There are two forms of fake enumeration annotations — above, illustrated
by <span style="font-family:monospace">@Fenum("A")</span> and <span style="font-family:monospace">@FenumC</span>.
See Section ‍<a href="#fenum-annotations">9.1</a> for descriptions of how to
introduce both types of fenums. The type qualifiers in gray
(<a href="../api/org/checkerframework/checker/fenum/qual/FenumTop.html"><span style="font-family:monospace">@FenumTop</span></a>,
<a href="../api/org/checkerframework/checker/fenum/qual/FenumUnqualified.html"><span style="font-family:monospace">@FenumUnqualified</span></a>, and
<a href="../api/org/checkerframework/checker/fenum/qual/FenumBottom.html"><span style="font-family:monospace">@FenumBottom</span></a>)
should never be written in
source code; they are used internally by the type system.
<span style="font-family:monospace">@FenumUnqualified</span> is the default qualifier for unannotated types, except
for upper bounds which default to <span style="font-family:monospace">@FenumTop</span>.
</td></tr>
</table></div>
<a id="fig-fenum-hierarchy"></a>
<div class="center"><hr class="floatrule"></div></blockquote>
<!--TOC section id="fenum-annotations" Fake enum annotations-->
<h2 id="fenum-annotations" class="section">9.1 Fake enum annotations <a href="#fenum-annotations"><img src="chainlink.svg" width="10" height="10"></a></h2><!--SEC END --><p>The Fake Enum Checker supports two ways to introduce a new fake enum (fenum):</p><ol class="enumerate" type=1><li class="li-enumerate">
Introduce your own specialized fenum annotation with code like this in
file <span style="font-family:monospace"><em>MyFenum</em></span><span style="font-family:monospace">.java</span>:<pre>
package <span style="font-style:italic">myPackage</span>.qual;

import java.lang.annotation.Documented;
import java.lang.annotation.ElementType;
import java.lang.annotation.Retention;
import java.lang.annotation.RetentionPolicy;
import java.lang.annotation.Target;
import org.checkerframework.checker.fenum.qual.FenumTop;
import org.checkerframework.framework.qual.SubtypeOf;

@Documented
@Retention(RetentionPolicy.RUNTIME)
@Target(<span style="font-family:monospace">{</span>ElementType.TYPE_USE, ElementType.TYPE_PARAMETER<span style="font-family:monospace">}</span>)
@SubtypeOf(FenumTop.class)
public @interface <span style="font-style:italic">MyFenum</span> <span style="font-family:monospace">{</span><span style="font-family:monospace">}</span>
</pre><p>You only need to adapt the italicized package, annotation, and file names in the example.</p><p>Note that all custom annotations must have the
<span style="font-family:monospace">@Target(</span><span style="font-family:monospace">{</span><span style="font-family:monospace">ElementType.TYPE_USE</span><span style="font-family:monospace">}</span><span style="font-family:monospace">)</span> meta-annotation. See section
<a href="#creating-define-type-qualifiers">35.5.1</a>.</p></li><li class="li-enumerate">Use the provided <a href="../api/org/checkerframework/checker/fenum/qual/Fenum.html"><span style="font-family:monospace">@Fenum</span></a> annotation, which takes a
<span style="font-family:monospace">String</span> argument to distinguish different fenums or type aliases.
For example, <span style="font-family:monospace">@Fenum("A")</span> and <span style="font-family:monospace">@Fenum("B")</span> are two distinct
type qualifiers.
</li></ol><p>The first approach allows you to define a short, meaningful name suitable for
your project, whereas the second approach allows quick prototyping.</p>
<!--TOC section id="fenum-checks" What the Fenum Checker checks-->
<h2 id="fenum-checks" class="section">9.2 What the Fenum Checker checks <a href="#fenum-checks"><img src="chainlink.svg" width="10" height="10"></a></h2><!--SEC END --><p>The Fenum Checker ensures that unrelated types are not mixed.
All types with a particular fenum annotation, or <span style="font-family:monospace">@Fenum(...)</span> with a
particular <span style="font-family:monospace">String</span> argument, are
disjoint from all unannotated types and from all types with a different fenum
annotation or <span style="font-family:monospace">String</span> argument.</p><p>The checker ensures that
only compatible fenum types are used in comparisons and arithmetic operations
(if applicable to the annotated type).</p><p>It is the programmer’s responsibility to ensure that fields with a fenum type
are properly initialized before use. Otherwise, one might observe a <span style="font-family:monospace">null</span>
reference or zero value in the field of a fenum type. (The Nullness Checker
(Chapter ‍<a href="#nullness-checker">3</a>) can prevent failure to initialize a
reference variable.)</p>
<!--TOC section id="fenum-running" Running the Fenum Checker-->
<h2 id="fenum-running" class="section">9.3 Running the Fenum Checker <a href="#fenum-running"><img src="chainlink.svg" width="10" height="10"></a></h2><!--SEC END --><p>The Fenum Checker can be invoked by running the following commands.</p><ul class="itemize"><li class="li-itemize">
If you define your own annotation(s), provide the name(s) of the annotation(s)
through the <span style="font-family:monospace">-Aquals</span> option, using a comma-no-space-separated notation:<pre>
  javac -classpath <span style="font-style:italic">/full/path/to/myProject/bin</span>:<span style="font-style:italic">/full/path/to/myLibrary/bin</span> <span style="font-family:monospace">\</span>
        -processor org.checkerframework.checker.fenum.FenumChecker <span style="font-family:monospace">\</span>
        -Aquals=<span style="font-style:italic">myPackage.qual.MyFenum</span> MyFile.java ...
</pre><p>The annotations listed in <span style="font-family:monospace">-Aquals</span> must be accessible to
the compiler during compilation. Before you run the Fenum Checker with
<span style="font-family:monospace">javac</span>, they must be compiled and on the same path (the classpath or
processorpath) as the Checker Framework. It
is not sufficient to supply their source files on the command line.</p><p>You can also provide the fully-qualified paths to a set of directories
that contain the annotations through the <span style="font-family:monospace">-AqualDirs</span> option,
using a colon-no-space-separated notation. For example,
if the Checker Framework is on the classpath rather than the processorpath:</p><pre>
  javac -classpath <span style="font-style:italic">/full/path/to/myProject/bin</span>:<span style="font-style:italic">/full/path/to/myLibrary/bin</span> <span style="font-family:monospace">\</span>
        -processor org.checkerframework.checker.fenum.FenumChecker <span style="font-family:monospace">\</span>
        -AqualDirs=<span style="font-style:italic">/full/path/to/myProject/bin</span>:<span style="font-style:italic">/full/path/to/myLibrary/bin</span> MyFile.java ...
</pre><p>Note that in these two examples, the compiled class file of the
<span style="font-family:monospace">myPackage.qual.MyFenum</span> annotation must exist in either the <span style="font-family:monospace">myProject/bin</span>
directory or the <span style="font-family:monospace">myLibrary/bin</span> directory. The following placement of
the class file will work with the above commands:</p><pre>
  .../myProject/bin/myPackage/qual/MyFenum.class
</pre><p>The two options can be used at the same time to provide groups of annotations
from directories, and individually named annotations.</p></li><li class="li-itemize">If your code uses the <a href="../api/org/checkerframework/checker/fenum/qual/Fenum.html"><span style="font-family:monospace">@Fenum</span></a> annotation, you do
not need the <span style="font-family:monospace">-Aquals</span> or <span style="font-family:monospace">-AqualDirs</span> option:<pre class="verbatim">  javac -processor org.checkerframework.checker.fenum.FenumChecker MyFile.java ...
</pre></li></ul><p>For an example of running the Fake Enum Checker on Android code, see
<a href="https://github.com/karlicoss/checker-fenum-android-demo"><span style="font-family:monospace">https://github.com/karlicoss/checker-fenum-android-demo</span></a>.</p>
<!--TOC section id="fenum-suppressing" Suppressing warnings-->
<h2 id="fenum-suppressing" class="section">9.4 Suppressing warnings <a href="#fenum-suppressing"><img src="chainlink.svg" width="10" height="10"></a></h2><!--SEC END --><p>One example of when you need to suppress warnings is when you initialize the
fenum constants to literal values.
To remove this warning message, add a <span style="font-family:monospace">@SuppressWarnings</span> annotation to either
the field or class declaration, for example:</p><pre class="verbatim">@SuppressWarnings("fenum:assignment.type.incompatible") // initialization of fake enums
class MyConsts {
  public static final @Fenum("A") int ACONST1 = 1;
  public static final @Fenum("A") int ACONST2 = 2;
}
</pre>
<!--TOC section id="fenum-example" Example-->
<h2 id="fenum-example" class="section">9.5 Example <a href="#fenum-example"><img src="chainlink.svg" width="10" height="10"></a></h2><!--SEC END --><p>The following example introduces two fenums in class <span style="font-family:monospace">TestStatic</span>
and then performs a few typical operations.</p><pre class="verbatim">@SuppressWarnings("fenum:assignment.type.incompatible")   // initialization of fake enums
public class TestStatic {
  public static final @Fenum("A") int ACONST1 = 1;
  public static final @Fenum("A") int ACONST2 = 2;

  public static final @Fenum("B") int BCONST1 = 4;
  public static final @Fenum("B") int BCONST2 = 5;
}

class FenumUser {
  @Fenum("A") int state1 = TestStatic.ACONST1;     // ok
  @Fenum("B") int state2 = TestStatic.ACONST1;     // Incompatible fenums forbidden!

  void fenumArg(@Fenum("A") int p) {}

  void fenumTest() {
    state1 = 4;                     // Direct use of value forbidden!
    state1 = TestStatic.BCONST1;    // Incompatible fenums forbidden!
    state1 = TestStatic.ACONST2;    // ok

    fenumArg(5);                    // Direct use of value forbidden!
    fenumArg(TestStatic.BCONST1);   // Incompatible fenums forbidden!
    fenumArg(TestStatic.ACONST1);   // ok
  }
 }
</pre><p>Also, see the example project in the <span style="font-family:monospace">docs/examples/fenum-extension</span> directory.</p><p>The paper “Building and using pluggable
type-checkers” ‍[<a href="#DietlDEMS2011">DDE+11</a>] (ICSE 2011,
<a href="https://homes.cs.washington.edu/~mernst/pubs/pluggable-checkers-icse2011.pdf"><span style="font-family:monospace">https://homes.cs.washington.edu/~mernst/pubs/pluggable-checkers-icse2011.pdf</span></a>)
describes case studies of the Fake Enum Checker.</p>
<!--TOC section id="fenum-pattern" The fake enumeration pattern-->
<h2 id="fenum-pattern" class="section">9.6 The fake enumeration pattern <a href="#fenum-pattern"><img src="chainlink.svg" width="10" height="10"></a></h2><!--SEC END --><p>Java’s
<a href="https://docs.oracle.com/javase/specs/jls/se17/html/jls-8.html#jls-8.9"><span style="font-family:monospace">enum</span></a>
keyword lets you define an enumeration type: a finite set of distinct values
that are related to one another but are disjoint from all other
types, including other enumerations.
Before enums were added to Java, there were two ways to encode an
enumeration, both of which are error-prone:</p><dl class="description"><dt class="dt-description">
<span style="font-weight:bold">the fake enum pattern</span></dt><dd class="dd-description"> a set of <span style="font-family:monospace">int</span> or <span style="font-family:monospace">String</span>
constants (as often found in older C code).</dd><dt class="dt-description"><span style="font-weight:bold">the typesafe enum pattern</span></dt><dd class="dd-description"> a class with private constructor.
</dd></dl><p>Sometimes you need to use the fake enum pattern,
rather than a real enum or the typesafe enum pattern.
One reason is backward-compatibility. A public API that predates Java’s
enum keyword may use <span style="font-family:monospace">int</span> constants; it cannot be changed, because
doing so would break existing clients. For example, Java’s JDK still uses
<span style="font-family:monospace">int</span> constants in the AWT and Swing frameworks, and Android also uses
<span style="font-family:monospace">int</span> constants rather than Java enums.
Another reason is performance, especially in environments with limited
resources. Use of an int instead of an object can
reduce code size, memory requirements, and run time.
</p><p>In cases when code has to use the fake enum pattern, the Fake Enum Checker,
or Fenum Checker, gives the same safety guarantees as a true enumeration type.
The developer can introduce new types that are distinct from all values of the
base type and from all other fake enums. Fenums can be introduced for
primitive types as well as for reference types.</p>
<!--TOC section id="fenum-references" References-->
<h2 id="fenum-references" class="section">9.7 References <a href="#fenum-references"><img src="chainlink.svg" width="10" height="10"></a></h2><!--SEC END --><ul class="itemize"><li class="li-itemize">
Case studies of the Fake Enum Checker:<br>
 “Building and using pluggable type-checkers” ‍[<a href="#DietlDEMS2011">DDE+11</a>]
(ICSE 2011, <a href="https://homes.cs.washington.edu/~mernst/pubs/pluggable-checkers-icse2011.pdf#page=3"><span style="font-family:monospace">https://homes.cs.washington.edu/~mernst/pubs/pluggable-checkers-icse2011.pdf#page=3</span></a>)</li><li class="li-itemize">Java Language Specification on enums:<br>
 <a href="https://docs.oracle.com/javase/specs/jls/se17/html/jls-8.html#jls-8.9"><span style="font-family:monospace">https://docs.oracle.com/javase/specs/jls/se17/html/jls-8.html#jls-8.9</span></a></li><li class="li-itemize">Tutorial trail on enums:<br>
 <a href="https://docs.oracle.com/javase/tutorial/java/javaOO/enum.html"><span style="font-family:monospace">https://docs.oracle.com/javase/tutorial/java/javaOO/enum.html</span></a></li><li class="li-itemize">Java Tip 122: Beware of Java typesafe enumerations:<br>
 <a href="https://www.infoworld.com/article/2077487/java-tip-122--beware-of-java-typesafe-enumerations.html"><span style="font-family:monospace">https://www.infoworld.com/article/2077487/java-tip-122--beware-of-java-typesafe-enumerations.html</span></a></li></ul><hr>
<!--TOC chapter id="tainting-checker" Tainting Checker-->
<h1 id="tainting-checker" class="chapter">Chapter ‍10 Tainting Checker <a href="#tainting-checker"><img src="chainlink.svg" width="10" height="10"></a></h1><!--SEC END --><p>The Tainting Checker prevents certain kinds of trust errors.
A <em>tainted</em>, or untrusted, value is one that comes from an arbitrary,
possibly malicious source, such as user input or unvalidated data.
In certain parts of your application, using a tainted value can compromise
the application’s integrity, causing it to crash, corrupt data, leak
private data, etc.</p><p>For example, a user-supplied pointer, handle, or map key should be
validated before being dereferenced.
As another example, a user-supplied string should not be concatenated into a
SQL query, lest the program be subject to a
<a href="https://en.wikipedia.org/wiki/Sql_injection">SQL injection</a> attack.
A location in your program where malicious data could do damage is
called a <em>sensitive sink</em>.</p><p>A program must “sanitize” or “untaint” an untrusted value before using
it at a sensitive sink. There are two general ways to untaint a value:
by checking
that it is innocuous/legal (e.g., it contains no characters that can be
interpreted as SQL commands when pasted into a string context), or by
transforming the value to be legal (e.g., quoting all the characters that
can be interpreted as SQL commands). A correct program must use one of
these two techniques so that tainted values never flow to a sensitive sink.
The Tainting Checker ensures that your program does so.</p><p>If the Tainting Checker issues no warning for a given program, then no
tainted value ever flows to a sensitive sink. However, your program is not
necessarily free from all trust errors. As a simple example, you might
have forgotten to annotate a sensitive sink as requiring an untainted type,
or you might have forgotten to annotate untrusted data as having a tainted
type.</p><p>To run the Tainting Checker, supply the
<span style="font-family:monospace">-processor TaintingChecker</span>
or
<span style="font-family:monospace">-processor org.checkerframework.checker.tainting.TaintingChecker</span>
command-line option to javac.
</p>
<!--TOC section id="tainting-annotations" Tainting annotations-->
<h2 id="tainting-annotations" class="section">10.1 Tainting annotations <a href="#tainting-annotations"><img src="chainlink.svg" width="10" height="10"></a></h2><!--SEC END --><p>The Tainting type system uses the following annotations:
</p><dl class="description"><dt class="dt-description">
<a href="../api/org/checkerframework/checker/tainting/qual/Untainted.html"><span style="font-weight:bold"><span style="font-family:monospace">@Untainted</span></span></a></dt><dd class="dd-description">
indicates
a type that includes only untainted (trusted) values.
</dd><dt class="dt-description"><a href="../api/org/checkerframework/checker/tainting/qual/Tainted.html"><span style="font-weight:bold"><span style="font-family:monospace">@Tainted</span></span></a></dt><dd class="dd-description">
indicates
a type that may include tainted (untrusted) or untainted (trusted) values.
<span style="font-family:monospace">@Tainted</span> is a supertype of <span style="font-family:monospace">@Untainted</span>.
It is the default qualifier.
</dd><dt class="dt-description"><a href="../api/org/checkerframework/checker/tainting/qual/PolyTainted.html"><span style="font-weight:bold"><span style="font-family:monospace">@PolyTainted</span></span></a></dt><dd class="dd-description">
indicates qualifier polymorphism.
For a description of qualifier polymorphism, see
Section ‍<a href="#method-qualifier-polymorphism">30.2</a>.
</dd></dl>
<!--TOC section id="writing-untainted" Tips on writing <span style="font-family:monospace">@Untainted</span> annotations-->
<h2 id="writing-untainted" class="section">10.2 Tips on writing <span style="font-family:monospace">@Untainted</span> annotations <a href="#writing-untainted"><img src="chainlink.svg" width="10" height="10"></a></h2><!--SEC END --><p>Most programs are designed with a boundary that surrounds sensitive
computations, separating them from untrusted values. Outside this
boundary, the program may manipulate malicious values, but no malicious
values ever pass the boundary to be operated upon by sensitive
computations.</p><p>In some programs, the area outside the boundary is very small: values are
sanitized as soon as they are received from an external source. In other
programs, the area inside the boundary is very small: values are sanitized
only immediately before being used at a sensitive sink. Either approach
can work, so long as every possibly-tainted value is sanitized before it
reaches a sensitive sink.</p><p>Once you determine the boundary, annotating your program is easy: put
<span style="font-family:monospace">@Tainted</span> outside the boundary, <span style="font-family:monospace">@Untainted</span> inside, and
<span style="font-family:monospace">@SuppressWarnings("tainting")</span> at the validation or
sanitization routines that are used at the boundary.
</p><p>The Tainting Checker’s standard default qualifier is <span style="font-family:monospace">@Tainted</span> (see
Section ‍<a href="#defaults">31.5</a> for overriding this default). This is the safest
default, and the one that should be used for all code outside the boundary
(for example, code that reads user input). You can set the default
qualifier to <span style="font-family:monospace">@Untainted</span> in code that may contain sensitive sinks.</p><p>The Tainting Checker does not know the intended semantics of your program,
so it cannot warn you if you mis-annotate a sensitive sink as taking
<span style="font-family:monospace">@Tainted</span> data, or if you mis-annotate external data as
<span style="font-family:monospace">@Untainted</span>. So long as you correctly annotate the sensitive sinks
and the places that untrusted data is read, the Tainting Checker will
ensure that all your other annotations are correct and that no undesired
information flows exist.</p><p>As an example, suppose that you wish to prevent SQL injection attacks. You
would start by annotating the
<a href="https://docs.oracle.com/en/java/javase/17/docs/api/java.sql/java/sql/Statement.html"><span style="font-family:monospace">Statement</span></a> class to indicate that the
<span style="font-family:monospace">execute</span> operations may only operate on untainted queries
(Chapter ‍<a href="#annotating-libraries">34</a> describes how to annotate external
libraries):</p><pre class="verbatim">  public boolean execute(@Untainted String sql) throws SQLException;
  public boolean executeUpdate(@Untainted String sql) throws SQLException;
</pre>
<!--TOC section id="tainting-many-uses" <span style="font-family:monospace">@Tainted</span> and <span style="font-family:monospace">@Untainted</span> can be used for many purposes-->
<h2 id="tainting-many-uses" class="section">10.3 <span style="font-family:monospace">@Tainted</span> and <span style="font-family:monospace">@Untainted</span> can be used for many purposes <a href="#tainting-many-uses"><img src="chainlink.svg" width="10" height="10"></a></h2><!--SEC END --><p>The <span style="font-family:monospace">@Tainted</span> and <span style="font-family:monospace">@Untainted</span> annotations have only minimal
built-in semantics. In fact, the Tainting Checker provides only a small
amount of functionality beyond the Subtyping Checker
(Chapter ‍<a href="#subtyping-checker">28</a>). This lack of hard-coded behavior has
two consequences. The first consequence is that
the annotations can serve many different purposes, such as:</p><ul class="itemize"><li class="li-itemize">
Prevent SQL injection attacks: <span style="font-family:monospace">@Tainted</span> is external input,
<span style="font-family:monospace">@Untainted</span> has been checked for SQL syntax.
</li><li class="li-itemize">Prevent cross-site scripting attacks: <span style="font-family:monospace">@Tainted</span> is external input,
<span style="font-family:monospace">@Untainted</span> has been checked for JavaScript syntax.
</li><li class="li-itemize">Prevent information leakage: <span style="font-family:monospace">@Tainted</span> is secret data,
<span style="font-family:monospace">@Untainted</span> may be displayed to a user.
</li></ul><p>The second consequence is that the Tainting Checker is not useful unless
you annotate the appropriate sources, sinks, and untainting/sanitization
routines.
</p><p>If you want more specialized semantics, or you want to annotate multiple
types of tainting (for example, HTML and SQL) in a single program,
then you can copy the definition of
the Tainting Checker to create a new annotation and checker with a more
specific name and semantics. You will change the copy to rename the
annotations, and you will annotate libraries and/or your code to identify
sources, sinks, and validation/sanitization routines.
See Chapter ‍<a href="#creating-a-checker">35</a> for more
details.</p>
<!--TOC section id="tainting-polymorphism-caution" A caution about polymorphism and side effects-->
<h2 id="tainting-polymorphism-caution" class="section">10.4 A caution about polymorphism and side effects <a href="#tainting-polymorphism-caution"><img src="chainlink.svg" width="10" height="10"></a></h2><!--SEC END --><p>Misuse of polymorphism can lead to unsoundness with the Tainting Checker
and other similar information flow checkers. To understand the potential
problem, consider the <span style="font-family:monospace">append</span> function in
<span style="font-family:monospace">java.lang.StringBuffer</span>:</p><pre class="verbatim">  public StringBuffer append(StringBuffer this, String toAppend);
</pre><p>Given these declarations:</p><pre class="verbatim">  @Tainted StringBuffer tsb;
  @Tainted String ts;
  @Untainted StringBuffer usb;
  @Untainted String us;
</pre><p>both of these invocations should be legal:</p><pre class="verbatim">  tsb.append(ts);
  usb.append(us);
</pre><p>That suggests that perhaps the function should be annotated as polymorphic:</p><pre class="verbatim">  // UNSOUND annotation -- do not do this!
  public @PolyTainted StringBuffer append(@PolyTainted StringBuffer this, @PolyTainted String toAppend);
</pre><p>The problem with the above annotation is that it permits the undesirable
invocation:</p><pre class="verbatim">  usb.append(ts); // illegal invocation
</pre><p>This invocation is permitted because, in the expression, all
<span style="font-family:monospace">@PolyTainted</span> annotations on formal parameters are instantiated to
<span style="font-family:monospace">@Tainted</span>, the top annotation, and each argument is a subtype of the
corresponding formal parameter.</p><p>Beware this problem both in code you write, and also in annotated libraries
(such as stub files). The correct way to annotate this class is to
add a class qualifier parameter; see Section ‍<a href="#class-qualifier-polymorphism">30.3</a>.</p><p>(Side note: if <span style="font-family:monospace">append</span> were purely functional (had no side effects
and returned a new <span style="font-family:monospace">StringBuffer</span>) the method call would be acceptable,
because the return type is instantiated to <span style="font-family:monospace">@Tainted StringBuffer</span> for the
expression <span style="font-family:monospace">usb.append(ts)</span>. However, the <span style="font-family:monospace">append</span> method works via
side-effect, and only returns a reference to the buffer as a convenience
for writing “fluent” client code.)</p><hr>
<!--TOC chapter id="lock-checker" Lock Checker-->
<h1 id="lock-checker" class="chapter">Chapter ‍11 Lock Checker <a href="#lock-checker"><img src="chainlink.svg" width="10" height="10"></a></h1><!--SEC END --><p>The Lock Checker prevents certain concurrency errors by enforcing a
locking discipline. A locking discipline indicates which locks must be held
when a given operation occurs. You express the locking discipline by
declaring a variable’s type to have the qualifier
<a href="../api/org/checkerframework/checker/lock/qual/GuardedBy.html"><span style="font-family:monospace">@GuardedBy</span></a><span style="font-family:monospace"><span style="font-size:small">("</span></span><span style="font-family:monospace"><span style="font-size:small"><em>lockexpr</em></span></span><span style="font-family:monospace"><span style="font-size:small">")</span></span>.
This indicates that the variable’s value may
be dereferenced only if the given lock is held.</p><p>To run the Lock Checker, supply the
<span style="font-family:monospace">-processor org.checkerframework.checker.lock.LockChecker</span>
command-line option to javac. The <span style="font-family:monospace">-AconcurrentSemantics</span>
command-line option is always enabled for the Lock Checker (see Section ‍<a href="#faq-concurrency">38.4.6</a>).</p>
<!--TOC section id="lock-guarantees" What the Lock Checker guarantees-->
<h2 id="lock-guarantees" class="section">11.1 What the Lock Checker guarantees <a href="#lock-guarantees"><img src="chainlink.svg" width="10" height="10"></a></h2><!--SEC END --><p>The Lock Checker gives the following guarantee.
Suppose that expression <span style="font-style:italic">e</span> has type
<a href="../api/org/checkerframework/checker/lock/qual/GuardedBy.html"><span style="font-family:monospace">@GuardedBy</span></a><span style="font-family:monospace">(</span><span style="font-family:monospace">{</span><span style="font-family:monospace">"x", "y.z"</span><span style="font-family:monospace">}</span><span style="font-family:monospace">)</span>.
Then the value computed for <span style="font-style:italic">e</span> is only dereferenced by a thread when the
thread holds locks <span style="font-family:monospace">x</span> and <span style="font-family:monospace">y.z</span>.
Dereferencing a value is reading or writing one of its fields.
The guarantee about <span style="font-style:italic">e</span>’s value
holds not only if the expression <span style="font-style:italic">e</span> is dereferenced
directly, but also if the value was first copied into a variable,
returned as the
result of a method call, etc.
Copying a reference is always
permitted by the Lock Checker, regardless of which locks are held.</p><p>A lock is held if it has been acquired but not yet released.
Java has two types of locks.
A monitor lock is acquired upon entry to a <span style="font-family:monospace">synchronized</span> method or block,
and is released on exit from that method or block.
An explicit lock is acquired by a method call such as
<a href="https://docs.oracle.com/en/java/javase/17/docs/api/java.base/java/util/concurrent/locks/Lock.html#lock()"><span style="font-family:monospace">Lock.lock()</span></a>,
and is released by another method call such as
<a href="https://docs.oracle.com/en/java/javase/17/docs/api/java.base/java/util/concurrent/locks/Lock.html#unlock()"><span style="font-family:monospace">Lock.unlock()</span></a>.
The Lock Checker enforces that any expression whose type implements
<a href="https://docs.oracle.com/en/java/javase/17/docs/api/java.base/java/util/concurrent/locks/Lock.html"><span style="font-family:monospace">Lock</span></a> is used as an
explicit lock, and all other expressions are used as monitor locks.
</p><p>Ensuring that your program obeys its locking discipline is an easy and
effective way to eliminate a common and important class of errors.
If the Lock Checker issues no warnings, then your program obeys its locking discipline.
However, your program might still have other types of concurrency errors.
For example, you might have specified an inadequate locking discipline
because you forgot some <a href="../api/org/checkerframework/checker/lock/qual/GuardedBy.html"><span style="font-family:monospace">@GuardedBy</span></a>
annotations.
Your program might release and
re-acquire the lock, when correctness requires it to hold it throughout a
computation.
And, there are other concurrency errors that cannot, or
should not, be solved with locks.</p>
<!--TOC section id="lock-annotations" Lock annotations-->
<h2 id="lock-annotations" class="section">11.2 Lock annotations <a href="#lock-annotations"><img src="chainlink.svg" width="10" height="10"></a></h2><!--SEC END --><p>This section describes the lock annotations you can write on types and methods.</p>
<!--TOC subsection id="lock-type-qualifiers" Type qualifiers-->
<h3 id="lock-type-qualifiers" class="subsection">11.2.1 Type qualifiers <a href="#lock-type-qualifiers"><img src="chainlink.svg" width="10" height="10"></a></h3><!--SEC END --><dl class="description"><dt class="dt-description"><a href="../api/org/checkerframework/checker/lock/qual/GuardedBy.html"><span style="font-weight:bold"><span style="font-family:monospace">@GuardedBy</span></span></a><span style="font-weight:bold"><span style="font-size:small">(</span></span><span style="font-weight:bold"><span style="font-size:small"><em>exprSet</em></span></span><span style="font-weight:bold"><span style="font-size:small">)</span></span></dt><dd class="dd-description">
If a variable <span style="font-family:monospace">x</span> has type <span style="font-family:monospace">@GuardedBy("</span><span style="font-family:monospace"><em>expr</em></span><span style="font-family:monospace">")</span>, then a thread may
dereference the value referred to by <span style="font-family:monospace">x</span> only when the thread holds the
lock that <em>expr</em> currently evaluates to.<p>The <span style="font-family:monospace">@GuardedBy</span> annotation can list multiple expressions, as in
<span style="font-family:monospace">@GuardedBy(</span><span style="font-family:monospace">{</span><span style="font-family:monospace">"</span><span style="font-family:monospace"><em>expr1</em></span><span style="font-family:monospace">", "</span><span style="font-family:monospace"><em>expr2</em></span><span style="font-family:monospace">"</span><span style="font-family:monospace">}</span><span style="font-family:monospace">)</span>, in which case
the dereference is
permitted only if the thread holds all the locks.</p><p>Section ‍<a href="#java-expressions-as-arguments">31.8</a> explains which
expressions the Lock Checker is able to analyze as lock expressions.
These include <span style="font-family:monospace">&lt;self&gt;</span>, the value of the annotated reference
(non-primitive) variable. For example, <span style="font-family:monospace">@GuardedBy("&lt;self&gt;") Object o</span>
indicates that the value referenced by <span style="font-family:monospace">o</span> is guarded by the intrinsic
(monitor) lock of the value referenced by <span style="font-family:monospace">o</span>.</p><p><span style="font-family:monospace">@GuardedBy({})</span>, which means the value is always allowed to be
dereferenced, is the default type qualifier that is used for all locations
where the programmer does not
write an explicit locking type qualifier (except all CLIMB-to-top locations
other than upper bounds and exception parameters — see Section ‍<a href="#climb-to-top">31.5.3</a>).
(Section ‍<a href="#lock-checker-default-qualifier">11.5.4</a> discusses this choice.)
It is also the conservative
default type qualifier for method parameters in unannotated libraries
(see Chapter ‍<a href="#annotating-libraries">34</a>).</p></dd><dt class="dt-description"><a href="../api/org/checkerframework/checker/lock/qual/GuardedByUnknown.html"><span style="font-weight:bold"><span style="font-family:monospace">@GuardedByUnknown</span></span></a></dt><dd class="dd-description">
If a variable <span style="font-family:monospace">x</span> has type <span style="font-family:monospace">@GuardedByUnknown</span>, then
it is not known which locks protect <span style="font-family:monospace">x</span>’s value. Those locks might
even be out of scope (inaccessible) and therefore unable to be written
in the annotation.
The practical consequence is that
the value referred to by <span style="font-family:monospace">x</span> can never be dereferenced.<p>Any value can be assigned to a variable of type
<span style="font-family:monospace">@GuardedByUnknown</span>. In particular, if it is written on a
formal parameter, then any value,
including one whose locks are not currently held,
may be passed as an argument.</p><p><span style="font-family:monospace">@GuardedByUnknown</span> is the conservative
default type qualifier for method receivers in unannotated libraries
(see Chapter ‍<a href="#annotating-libraries">34</a>).</p></dd><dt class="dt-description"><a href="../api/org/checkerframework/checker/lock/qual/NewObject.html"><span style="font-weight:bold"><span style="font-family:monospace">@NewObject</span></span></a></dt><dd class="dd-description">
This type represents a newly-consructed value; such as the result of
calling a constructor or factory method. The client can use the value as
any <a href="../api/org/checkerframework/checker/lock/qual/GuardedBy.html"><span style="font-family:monospace">@GuardedBy</span></a> type.</dd><dt class="dt-description"><a href="../api/org/checkerframework/checker/lock/qual/GuardedByBottom.html"><span style="font-weight:bold"><span style="font-family:monospace">@GuardedByBottom</span></span></a></dt><dd class="dd-description">
If a variable <span style="font-family:monospace">x</span> has type <span style="font-family:monospace">@GuardedByBottom</span>, then
the value referred to by <span style="font-family:monospace">x</span> is <span style="font-family:monospace">null</span> and can never
be dereferenced.</dd></dl><blockquote class="figure"><div class="center"><hr class="floatrule"></div>
<div class="center">
<img src="lock-guardedby.svg">
</div>
<div class="caption"><table style="border-spacing:6px;border-collapse:separate;" class="cellpading0"><tr><td style="vertical-align:top;text-align:left;" >Figure 11.1: The subtyping relationship of the Lock Checker’s qualifiers.
<span style="font-family:monospace">@GuardedBy({})</span> is the default type qualifier for unannotated
types (except all CLIMB-to-top locations other than upper bounds and exception
parameters — see Section ‍<a href="#climb-to-top">31.5.3</a>).
</td></tr>
</table></div>
<a id="fig-lock-guardedby-hierarchy"></a>
<div class="center"><hr class="floatrule"></div></blockquote><p>Figure ‍<a href="#fig-lock-guardedby-hierarchy">11.1</a> shows the type hierarchy of these
qualifiers.
All <span style="font-family:monospace">@GuardedBy</span> annotations are incomparable:
if <em>exprSet1</em> ≠ <em>exprSet2</em>, then <span style="font-family:monospace">@GuardedBy(</span><span style="font-family:monospace"><em>exprSet1</em></span><span style="font-family:monospace">)</span> and
<span style="font-family:monospace">@GuardedBy(</span><span style="font-family:monospace"><em>exprSet2</em></span><span style="font-family:monospace">)</span> are siblings in the type hierarchy.
You might expect that
<span style="font-family:monospace">@GuardedBy({"x", "y"}) T</span> is a subtype of <span style="font-family:monospace">@GuardedBy({"x"}) T</span>. The
first type requires two locks to be held, and the second requires only one
lock to be held and so could be used in any situation where both locks are
held. The type system conservatively prohibits this in order to prevent
type-checking loopholes that would result from aliasing and side effects
— that is, from having two mutable references, of different types, to the
same data. See
Section ‍<a href="#lock-guardedby-invariant-subtyping">11.4.2</a> for an example
of a problem that would occur if this rule were relaxed.</p>
<!--TOC paragraph id="lock-polymorphic-type-qualifiers" Polymorphic type qualifiers-->
<h5 id="lock-polymorphic-type-qualifiers" class="paragraph">Polymorphic type qualifiers <a href="#lock-polymorphic-type-qualifiers"><img src="chainlink.svg" width="10" height="10"></a></h5><!--SEC END --><dl class="description"><dt class="dt-description"><a href="../api/org/checkerframework/checker/lock/qual/GuardSatisfied.html"><span style="font-weight:bold"><span style="font-family:monospace">@GuardSatisfied</span></span></a><span style="font-weight:bold"><span style="font-size:small">(</span></span><span style="font-weight:bold"><span style="font-size:small"><em>index</em></span></span><span style="font-weight:bold"><span style="font-size:small">)</span></span></dt><dd class="dd-description">
If a variable <span style="font-family:monospace">x</span> has type <span style="font-family:monospace">@GuardSatisfied</span>, then all
lock expressions for <span style="font-family:monospace">x</span>’s value are held.<p>As with other qualifier-polymorphism annotations
(Section ‍<a href="#method-qualifier-polymorphism">30.2</a>), the <em>index</em> argument
indicates when two values are guarded by the same (unknown) set of locks.</p><p><span style="font-family:monospace">@GuardSatisfied</span> is only allowed in method signatures: on
formal parameters (including the receiver) and return types.
It may not be written on fields. Also, it is a limitation of the
current design that <span style="font-family:monospace">@GuardSatisfied</span> may not be written on
array elements or on local variables.</p><p>A return type can only be annotated with <span style="font-family:monospace">@GuardSatisfied(index)</span>,
not <span style="font-family:monospace">@GuardSatisfied</span>.</p><p>See Section ‍<a href="#lock-checker-polymorphism-example">11.4.6</a>
for an example of a use of <span style="font-family:monospace">@GuardSatisfied</span>.</p></dd></dl>
<!--TOC subsection id="lock-declaration-annotations" Declaration annotations-->
<h3 id="lock-declaration-annotations" class="subsection">11.2.2 Declaration annotations <a href="#lock-declaration-annotations"><img src="chainlink.svg" width="10" height="10"></a></h3><!--SEC END --><p>The Lock Checker supports several annotations that specify method behavior.
These are declaration annotations, not type annotations: they apply to the
method itself rather than to some particular type.</p>
<!--TOC paragraph id="lock-method-pre-post-conditions" Method pre-conditions and post-conditions-->
<h5 id="lock-method-pre-post-conditions" class="paragraph">Method pre-conditions and post-conditions <a href="#lock-method-pre-post-conditions"><img src="chainlink.svg" width="10" height="10"></a></h5><!--SEC END --><dl class="description"><dt class="dt-description">
<a href="../api/org/checkerframework/checker/lock/qual/Holding.html"><span style="font-weight:bold"><span style="font-family:monospace">@Holding</span></span></a><span style="font-weight:bold"><span style="font-size:small">(String[] locks)</span></span></dt><dd class="dd-description">
All the given lock expressions
are held at the method call site.</dd><dt class="dt-description"><a href="../api/org/checkerframework/checker/lock/qual/EnsuresLockHeld.html"><span style="font-weight:bold"><span style="font-family:monospace">@EnsuresLockHeld</span></span></a><span style="font-weight:bold"><span style="font-size:small">(String[] locks)</span></span></dt><dd class="dd-description">
The given lock
expressions are
locked upon method return if the method
terminates successfully. This is useful for annotating a
method that acquires a lock such as
<a href="https://docs.oracle.com/en/java/javase/17/docs/api/java.base/java/util/concurrent/locks/ReentrantLock.html#lock()"><span style="font-family:monospace">ReentrantLock.lock()</span></a>.</dd><dt class="dt-description"><a href="../api/org/checkerframework/checker/lock/qual/EnsuresLockHeldIf.html"><span style="font-weight:bold"><span style="font-family:monospace">@EnsuresLockHeldIf</span></span></a><span style="font-weight:bold"><span style="font-size:small">(String[] locks, boolean result)</span></span></dt><dd class="dd-description">
If the annotated method returns the given
boolean value (true or false), the given lock
expressions are locked upon method return if the method
terminates successfully.
This is useful for annotating a
method that conditionally acquires a lock.
See Section ‍<a href="#ensureslockheld-examples">11.4.4</a> for examples.</dd></dl>
<!--TOC paragraph id="lock-side-effect-specifications" Side effect specifications-->
<h5 id="lock-side-effect-specifications" class="paragraph">Side effect specifications <a href="#lock-side-effect-specifications"><img src="chainlink.svg" width="10" height="10"></a></h5><!--SEC END --><dl class="description"><dt class="dt-description"><a href="../api/org/checkerframework/checker/lock/qual/LockingFree.html"><span style="font-weight:bold"><span style="font-family:monospace">@LockingFree</span></span></a></dt><dd class="dd-description">
The method does not acquire or release locks,
directly or indirectly. The method is not <span style="font-family:monospace">synchronized</span>, it contains
no <span style="font-family:monospace">synchronized</span> blocks, it contains no calls to <span style="font-family:monospace">lock</span> or <span style="font-family:monospace">unlock</span>
methods, and it contains no calls to methods that are not themselves <span style="font-family:monospace">@LockingFree</span>.<p>Since
<span style="font-family:monospace">@SideEffectFree</span> implies <span style="font-family:monospace">@LockingFree</span>, if both are applicable
then you only need to write <span style="font-family:monospace">@SideEffectFree</span>.</p></dd><dt class="dt-description"><a href="../api/org/checkerframework/checker/lock/qual/ReleasesNoLocks.html"><span style="font-weight:bold"><span style="font-family:monospace">@ReleasesNoLocks</span></span></a></dt><dd class="dd-description">
The method maintains a strictly nondecreasing lock hold count on the
current thread for any locks that were held prior
to the method call. The method might acquire locks but then release
them, or might acquire locks but not release them (in which case it should
also be annotated with
<a href="../api/org/checkerframework/checker/lock/qual/EnsuresLockHeld.html"><span style="font-family:monospace">@EnsuresLockHeld</span></a> or
<a href="../api/org/checkerframework/checker/lock/qual/EnsuresLockHeldIf.html"><span style="font-family:monospace">@EnsuresLockHeldIf</span></a>).<p>This is the default for methods being type-checked that have no <span style="font-family:monospace">@LockingFree</span>,
<span style="font-family:monospace">@MayReleaseLocks</span>, <span style="font-family:monospace">@SideEffectFree</span>, or <span style="font-family:monospace">@Pure</span>
annotation.</p></dd><dt class="dt-description"><a href="../api/org/checkerframework/checker/lock/qual/MayReleaseLocks.html"><span style="font-weight:bold"><span style="font-family:monospace">@MayReleaseLocks</span></span></a></dt><dd class="dd-description">
The method may release locks that were held prior to the method being called.
You can write this when you are certain the method releases locks, or
when you don’t know whether the method releases locks.
This is the conservative default for methods in unannotated libraries (see Chapter ‍<a href="#annotating-libraries">34</a>).</dd></dl>
<!--TOC section id="lock-type-checking-rules" Type-checking rules-->
<h2 id="lock-type-checking-rules" class="section">11.3 Type-checking rules <a href="#lock-type-checking-rules"><img src="chainlink.svg" width="10" height="10"></a></h2><!--SEC END --><p>In addition to the standard subtyping rules enforcing the subtyping relationship
described in Figure ‍<a href="#fig-lock-guardedby-hierarchy">11.1</a>, the Lock Checker enforces
the following additional rules.</p>
<!--TOC subsection id="lock-type-checking-rules-polymorphic-qualifiers" Polymorphic qualifiers-->
<h3 id="lock-type-checking-rules-polymorphic-qualifiers" class="subsection">11.3.1 Polymorphic qualifiers <a href="#lock-type-checking-rules-polymorphic-qualifiers"><img src="chainlink.svg" width="10" height="10"></a></h3><!--SEC END --><dl class="description"><dt class="dt-description"><span style="font-weight:bold"><span style="font-family:monospace">@GuardSatisfied</span></span></dt><dd class="dd-description"><p>The overall rules for polymorphic qualifiers are given in
Section ‍<a href="#method-qualifier-polymorphism">30.2</a>.</p><p>Here are additional constraints for (pseudo-)assignments:</p><ul class="itemize"><li class="li-itemize">
If the left-hand side has type <span style="font-family:monospace">@GuardSatisfied</span> (with or without an index),
then all locks mentioned in the right-hand side’s <span style="font-family:monospace">@GuardedBy</span> type
must be currently held.
</li><li class="li-itemize">A formal parameter with type qualifier <span style="font-family:monospace">@GuardSatisfied</span> without an
index cannot be assigned to.
</li><li class="li-itemize">If the left-hand side is a formal parameter with type
<span style="font-family:monospace">@GuardSatisfied(</span><span style="font-family:monospace"><em>index</em></span><span style="font-family:monospace">)</span>, the right-hand-side must have
identical <span style="font-family:monospace">@GuardSatisfied(</span><span style="font-family:monospace"><em>index</em></span><span style="font-family:monospace">)</span> type.
</li></ul><p>If a formal parameter type is
annotated with <span style="font-family:monospace">@GuardSatisfied</span> without an index, then that formal parameter
type is unrelated to every other type in the <span style="font-family:monospace">@GuardedBy</span> hierarchy,
including other occurrences of <span style="font-family:monospace">@GuardSatisfied</span> without an index.</p><p><span style="font-family:monospace">@GuardSatisfied</span> may not be used on formal parameters, receivers, or
return types of a method annotated with <span style="font-family:monospace">@MayReleaseLocks</span>.
</p></dd></dl>
<!--TOC subsection id="lock-type-checking-rules-dereferences" Dereferences-->
<h3 id="lock-type-checking-rules-dereferences" class="subsection">11.3.2 Dereferences <a href="#lock-type-checking-rules-dereferences"><img src="chainlink.svg" width="10" height="10"></a></h3><!--SEC END --><dl class="description"><dt class="dt-description"><span style="font-weight:bold"><span style="font-family:monospace">@GuardedBy</span></span></dt><dd class="dd-description">
An expression of type <span style="font-family:monospace">@GuardedBy(</span><span style="font-family:monospace"><em>eset</em></span><span style="font-family:monospace">)</span> may be dereferenced only
if all locks in <em>eset</em> are held.</dd><dt class="dt-description"><span style="font-weight:bold"><span style="font-family:monospace">@GuardSatisfied</span></span></dt><dd class="dd-description">
An expression of type <span style="font-family:monospace">@GuardSatisfied</span> may be dereferenced.</dd><dt class="dt-description"><span style="font-weight:bold">Not </span><span style="font-weight:bold"><span style="font-family:monospace">@GuardedBy</span></span><span style="font-weight:bold"> or </span><span style="font-weight:bold"><span style="font-family:monospace">@GuardSatisfied</span></span></dt><dd class="dd-description">
An expression whose type is not annotated with <span style="font-family:monospace">@GuardedBy</span> or
<span style="font-family:monospace">@GuardSatisfied</span> may not be dereferenced.
</dd></dl>
<!--TOC subsection id="lock-type-checking-rules-primitives" Primitive types, boxed primitive types, and Strings-->
<h3 id="lock-type-checking-rules-primitives" class="subsection">11.3.3 Primitive types, boxed primitive types, and Strings <a href="#lock-type-checking-rules-primitives"><img src="chainlink.svg" width="10" height="10"></a></h3><!--SEC END --><p>Primitive types, boxed primitive types (such as <span style="font-family:monospace">java.lang.Integer</span>), and type <span style="font-family:monospace">java.lang.String</span>
are annotated with <span style="font-family:monospace">@GuardedBy({})</span>.
It is an error for the programmer to annotate any of these types with an annotation from
the <span style="font-family:monospace">@GuardedBy</span> type hierarchy, including <span style="font-family:monospace">@GuardedBy({})</span>.</p>
<!--TOC subsection id="lock-type-checking-rules-overriding" Overriding-->
<h3 id="lock-type-checking-rules-overriding" class="subsection">11.3.4 Overriding <a href="#lock-type-checking-rules-overriding"><img src="chainlink.svg" width="10" height="10"></a></h3><!--SEC END --><dl class="description"><dt class="dt-description"><span style="font-weight:bold">Overriding methods annotated with </span><span style="font-weight:bold"><span style="font-family:monospace">@Holding</span></span></dt><dd class="dd-description">
If class <span style="font-style:italic">B</span> overrides method <span style="font-style:italic">m</span> from class <span style="font-style:italic">A</span>, then the expressions in
<span style="font-style:italic">B</span>’s <span style="font-family:monospace">@Holding</span>
annotation must be a subset of or equal to that of <span style="font-style:italic">A</span>’s <span style="font-family:monospace">@Holding</span>
annotation.</dd><dt class="dt-description"><span style="font-weight:bold">Overriding methods annotated with side effect annotations</span></dt><dd class="dd-description">
If class <span style="font-style:italic">B</span> overrides method <span style="font-style:italic">m</span> from class <span style="font-style:italic">A</span>, then
the side effect annotation on <span style="font-style:italic">B</span>’s declaration of <span style="font-style:italic">m</span>
must be at least as strong as that in <span style="font-style:italic">A</span>’s declaration of <span style="font-style:italic">m</span>.
From weakest to strongest, the side effect annotations
processed by the Lock Checker are:
<pre class="verbatim">  @MayReleaseLocks
  @ReleasesNoLocks
  @LockingFree
  @SideEffectFree
  @Pure
</pre></dd></dl>
<!--TOC subsection id="lock-type-checking-rules-polymorphic-side-effects" Side effects-->
<h3 id="lock-type-checking-rules-polymorphic-side-effects" class="subsection">11.3.5 Side effects <a href="#lock-type-checking-rules-polymorphic-side-effects"><img src="chainlink.svg" width="10" height="10"></a></h3><!--SEC END --><dl class="description"><dt class="dt-description"><span style="font-weight:bold">Releasing explicit locks</span></dt><dd class="dd-description">
Any method that releases an explicit lock must be annotated
with <span style="font-family:monospace">@MayReleaseLocks</span>.
The Lock Checker issues a warning if it encounters a method declaration
annotated with <span style="font-family:monospace">@MayReleaseLocks</span> and having a formal parameter
or receiver annotated with <span style="font-family:monospace">@GuardSatisfied</span>. This is because
the Lock Checker cannot guarantee that the guard will be satisfied
throughout the body of a method if that method may release a lock.</dd><dt class="dt-description"><span style="font-weight:bold">No side effects on lock expressions</span></dt><dd class="dd-description">
If expression <em>expr</em> is used to acquire a lock, then
<em>expr</em> must evaluate to the same value, starting from when
<em>expr</em> is used to acquire a lock until <em>expr</em> is used to
release the lock.
An expression is used to acquire a lock if it is the receiver at a
call site of a <span style="font-family:monospace">synchronized</span> method, is the expression in a
<span style="font-family:monospace">synchronized</span> block, or is the argument to a <span style="font-family:monospace">lock</span> method.</dd><dt class="dt-description"><span style="font-weight:bold">Locks are released after possible side effects</span></dt><dd class="dd-description">
After a call to a method annotated with <span style="font-family:monospace">@LockingFree</span>,
<span style="font-family:monospace">@ReleasesNoLocks</span>, <span style="font-family:monospace">@SideEffectFree</span>, or <span style="font-family:monospace">@Pure</span>,
the Lock Checker’s estimate of held locks
after a method call is the same as that prior to the method call.
After a call to a method annotated with <span style="font-family:monospace">@MayReleaseLocks</span>,
the estimate of held locks is conservatively reset to the empty set,
except for those locks specified to be held after the call
by an <span style="font-family:monospace">@EnsuresLockHeld</span> or <span style="font-family:monospace">@EnsuresLockHeldIf</span>
annotation on the method. Assignments to variables also
cause the estimate of held locks to be conservatively reduced
to a smaller set if the Checker Framework determines that the
assignment might have side-effected a lock expression.
For more information on side effects, please refer to
Section ‍<a href="#type-refinement-purity">31.7.5</a>.</dd></dl>
<!--TOC section id="lock-examples" Examples-->
<h2 id="lock-examples" class="section">11.4 Examples <a href="#lock-examples"><img src="chainlink.svg" width="10" height="10"></a></h2><!--SEC END --><p>The Lock Checker guarantees that a value that was computed from an expression of <span style="font-family:monospace">@GuardedBy</span> type is
dereferenced only when the current thread holds all the expressions in the
<span style="font-family:monospace">@GuardedBy</span> annotation.</p>
<!--TOC subsection id="lock-examples-guardedby" Examples of @GuardedBy-->
<h3 id="lock-examples-guardedby" class="subsection">11.4.1 Examples of @GuardedBy <a href="#lock-examples-guardedby"><img src="chainlink.svg" width="10" height="10"></a></h3><!--SEC END --><p>The following example demonstrates the basic
type-checking rules.</p><pre class="verbatim">class MyClass {
  final ReentrantLock lock; // Initialized in the constructor

  @GuardedBy("lock") Object x = new Object();
  @GuardedBy("lock") Object y = x; // OK, since dereferences of y will require "lock" to be held.
  @GuardedBy({}) Object z = x; // ILLEGAL since dereferences of z don't require "lock" to be held.
  @GuardedBy("lock") Object myMethod() { // myMethod is implicitly annotated with @ReleasesNoLocks.
     return x; // OK because the return type is annotated with @GuardedBy("lock")
  }

  [...]

  void exampleMethod() {
     x.toString(); // ILLEGAL because the lock is not known to be held
     y.toString(); // ILLEGAL because the lock is not known to be held
     myMethod().toString(); // ILLEGAL because the lock is not known to be held
     lock.lock();
     x.toString();  // OK: the lock is known to be held
     y.toString();  // OK: the lock is known to be held, and toString() is annotated with @SideEffectFree.
     myMethod().toString(); // OK: the lock is known to be held, since myMethod
                            // is implicitly annotated with @ReleasesNoLocks.
  }
}
</pre><p>Note that the expression <span style="font-family:monospace">new Object()</span> is inferred to have type <span style="font-family:monospace">@GuardedBy("lock")</span>
because it is immediately assigned to a newly-declared
variable having type annotation <span style="font-family:monospace">@GuardedBy("lock")</span>. You could
explicitly write <span style="font-family:monospace">new @GuardedBy("lock") Object()</span> but it is not
required.</p><p>The following example demonstrates that using <span style="font-family:monospace">&lt;self&gt;</span> as a lock expression
allows a guarded value to be dereferenced even when the original
variable name the value was originally assigned to falls out of scope.</p><pre class="verbatim">class MyClass {
  private final @GuardedBy("&lt;self&gt;") Object x = new Object();
  void method() {
    x.toString(); // ILLEGAL because x is not known to be held.
    synchronized(x) {
      x.toString(); // OK: x is known to be held.
    }
  }

  public @GuardedBy("&lt;self&gt;") Object get_x() {
    return x; // OK, since the return type is @GuardedBy("&lt;self&gt;").
  }
}

class MyOtherClass {
  void method() {
    MyClass m = new MyClass();
    final @GuardedBy("&lt;self&gt;") Object o = m.get_x();
    o.toString(); // ILLEGAL because o is not known to be held.
    synchronized(o) {
      o.toString(); // OK: o is known to be held.
    }
  }
}
</pre>
<!--TOC subsection id="lock-guardedby-invariant-subtyping" @GuardedBy({“a”, “b”}) is not a subtype of @GuardedBy({“a”})-->
<h3 id="lock-guardedby-invariant-subtyping" class="subsection">11.4.2 @GuardedBy({“a”, “b”}) is not a subtype of @GuardedBy({“a”}) <a href="#lock-guardedby-invariant-subtyping"><img src="chainlink.svg" width="10" height="10"></a></h3><!--SEC END --><p><span style="font-weight:bold">@GuardedBy(exprSet)</span></p><p>The following example demonstrates the reason the Lock Checker enforces the
following rule: if <em>exprSet1</em> ≠ <em>exprSet2</em>, then
<span style="font-family:monospace">@GuardedBy(</span><span style="font-family:monospace"><em>exprSet1</em></span><span style="font-family:monospace">)</span> and <span style="font-family:monospace">@GuardedBy(</span><span style="font-family:monospace"><em>exprSet2</em></span><span style="font-family:monospace">)</span> are siblings in the type
hierarchy.</p><pre class="verbatim">class MyClass {
    final Object lockA = new Object();
    final Object lockB = new Object();
    @GuardedBy("lockA") Object x = new Object();
    @GuardedBy({"lockA", "lockB"}) Object y = new Object();
    void myMethod() {
        y = x;      // ILLEGAL; if legal, later statement x.toString() would cause trouble
        synchronized(lockA) {
          x.toString();  // dereferences y's value without holding lock lockB
        }
    }
}
</pre><p>If the Lock Checker permitted the assignment
<span style="font-family:monospace">y = x;</span>, then the undesired dereference would be possible.</p>
<!--TOC subsection id="lock-examples-holding" Examples of @Holding-->
<h3 id="lock-examples-holding" class="subsection">11.4.3 Examples of @Holding <a href="#lock-examples-holding"><img src="chainlink.svg" width="10" height="10"></a></h3><!--SEC END --><p>The following example shows the interaction between <span style="font-family:monospace">@GuardedBy</span> and
<span style="font-family:monospace">@Holding</span>:</p><pre class="verbatim">  void helper1(@GuardedBy("myLock") Object a) {
    a.toString(); // ILLEGAL: the lock is not held
    synchronized(myLock) {
      a.toString();  // OK: the lock is held
    }
  }
  @Holding("myLock")
  void helper2(@GuardedBy("myLock") Object b) {
    b.toString(); // OK: the lock is held
  }
  void helper3(@GuardedBy("myLock") Object d) {
    d.toString(); // ILLEGAL: the lock is not held
  }
  void myMethod2(@GuardedBy("myLock") Object e) {
    helper1(e);  // OK to pass to another routine without holding the lock
                 // (but helper1's body has an error)
    e.toString(); // ILLEGAL: the lock is not held
    synchronized (myLock) {
      helper2(e); // OK: the lock is held
      helper3(e); // OK, but helper3's body has an error
    }
  }
</pre>
<!--TOC subsection id="ensureslockheld-examples" Examples of @EnsuresLockHeld and @EnsuresLockHeldIf-->
<h3 id="ensureslockheld-examples" class="subsection">11.4.4 Examples of @EnsuresLockHeld and @EnsuresLockHeldIf <a href="#ensureslockheld-examples"><img src="chainlink.svg" width="10" height="10"></a></h3><!--SEC END --><p><span style="font-family:monospace">@EnsuresLockHeld</span> and <span style="font-family:monospace">@EnsuresLockHeldIf</span> are primarily intended
for annotating JDK locking methods, as in:</p><pre class="verbatim">package java.util.concurrent.locks;

class ReentrantLock {

    @EnsuresLockHeld("this")
    public void lock();

    @EnsuresLockHeldIf(expression="this", result=true)
    public boolean tryLock();

    ...
}
</pre><p>They can also be used to annotate user methods, particularly for
higher-level lock constructs such as a Monitor, as in this simplified example:</p><pre class="verbatim">public class Monitor {

    private final ReentrantLock lock; // Initialized in the constructor

    ...

    @EnsuresLockHeld("lock")
    public void enter() {
       lock.lock();
    }

    ...
}
</pre>
<!--TOC subsection id="lock-lockingfree-example" Example of @LockingFree, @ReleasesNoLocks, and @MayReleaseLocks-->
<h3 id="lock-lockingfree-example" class="subsection">11.4.5 Example of @LockingFree, @ReleasesNoLocks, and @MayReleaseLocks <a href="#lock-lockingfree-example"><img src="chainlink.svg" width="10" height="10"></a></h3><!--SEC END --><p><span style="font-family:monospace">@LockingFree</span> is useful when a method does not make any use of synchronization
or locks but causes other side effects (hence <span style="font-family:monospace">@SideEffectFree</span> is not appropriate).
<span style="font-family:monospace">@SideEffectFree</span> implies <span style="font-family:monospace">@LockingFree</span>, therefore if both are applicable,
you should only write <span style="font-family:monospace">@SideEffectFree</span>. <span style="font-family:monospace">@ReleasesNoLocks</span> has a weaker guarantee
than <span style="font-family:monospace">@LockingFree</span>, and <span style="font-family:monospace">@MayReleaseLocks</span> provides no guarantees.</p><pre class="verbatim">private Object myField;
private final ReentrantLock lock; // Initialized in the constructor
private @GuardedBy("lock") Object x; // Initialized in the constructor

[...]

// This method does not use locks or synchronization, but it cannot
// be annotated as @SideEffectFree since it alters myField.
@LockingFree
void myMethod() {
  myField = new Object();
}

@SideEffectFree
int mySideEffectFreeMethod() {
  return 0;
}

@MayReleaseLocks
void myUnlockingMethod() {
  lock.unlock();
}

@ReleasesNoLocks
void myLockingMethod() {
  lock.lock();
}

@MayReleaseLocks
void clientMethod() {
  if (lock.tryLock()) {
    x.toString(); // OK: the lock is held
    myMethod();
    x.toString(); // OK: the lock is still held since myMethod is locking-free
    mySideEffectFreeMethod();
    x.toString(); // OK: the lock is still held since mySideEffectFreeMethod is side-effect-free
    myUnlockingMethod();
    x.toString(); // ILLEGAL: myUnlockingMethod may have released a lock
  }
  if (lock.tryLock()) {
    x.toString(); // OK: the lock is held
    myLockingMethod();
    x.toString(); // OK: the lock is held
  }
  if (lock.isHeldByCurrentThread()) {
    x.toString(); // OK: the lock is known to be held
  }
}
</pre>
<!--TOC subsection id="lock-checker-polymorphism-example" Polymorphism and method formal parameters with unknown guards-->
<h3 id="lock-checker-polymorphism-example" class="subsection">11.4.6 Polymorphism and method formal parameters with unknown guards <a href="#lock-checker-polymorphism-example"><img src="chainlink.svg" width="10" height="10"></a></h3><!--SEC END --><p>The polymorphic <span style="font-family:monospace">@GuardSatisfied</span> type annotation allows a method body
to dereference the method’s formal parameters even if the
<span style="font-family:monospace">@GuardedBy</span> annotations on the actual parameters are unknown at
the method declaration site.</p><p>The declaration of
<a href="https://docs.oracle.com/en/java/javase/17/docs/api/java.base/java/lang/StringBuffer.html#append(java.lang.String)"><span style="font-family:monospace">StringBuffer.append(String str)</span></a>
is annotated as:</p><pre class="verbatim">@LockingFree
public @GuardSatisfied(1) StringBuffer append(@GuardSatisfied(1) StringBuffer this,
                                              @GuardSatisfied(2) String str)
</pre><p>The method manipulates the values of its arguments, so all their locks must
be held. However, the declaration does not know what those are and they
might not even be in scope at the declaration. Therefore, the declaration
cannot use <span style="font-family:monospace">@GuardedBy</span> and must use <span style="font-family:monospace">@GuardSatisfied</span>. The arguments to
<span style="font-family:monospace">@GuardSatisfied</span> indicate that the receiver and result (which are the
same value) are guarded by the same (unknown, possibly empty) set of locks,
and the <span style="font-family:monospace">str</span> parameter may be guarded by a different set of locks.</p><p>The <span style="font-family:monospace">@LockingFree</span> annotation indicates that
this method makes no use of
locks or synchronization.</p><p>Given these annotations on <span style="font-family:monospace">append</span>, the following code type-checks:</p><pre class="verbatim">final ReentrantLock lock1, lock2; // Initialized in the constructor
@GuardedBy("lock1") StringBuffer filename;
@GuardedBy("lock2") StringBuffer extension;
...
lock1.lock();
lock2.lock();
filename = filename.append(extension);
</pre>
<!--TOC section id="lock-details" More locking details-->
<h2 id="lock-details" class="section">11.5 More locking details <a href="#lock-details"><img src="chainlink.svg" width="10" height="10"></a></h2><!--SEC END --><p>This section gives some details that are helpful for understanding how Java
locking and the Lock Checker works.</p><p>The paper “Locking discipline inference and checking” ‍[<a href="#ErnstLMST2016">ELM+16</a>] (ICSE 2016,
<a href="https://homes.cs.washington.edu/~mernst/pubs/locking-inference-checking-icse2016-abstract.html"><span style="font-family:monospace">https://homes.cs.washington.edu/~mernst/pubs/locking-inference-checking-icse2016-abstract.html</span></a>)
gives additional details.</p>
<!--TOC subsection id="lock-two-types" Two types of locking: monitor locks and explicit locks-->
<h3 id="lock-two-types" class="subsection">11.5.1 Two types of locking: monitor locks and explicit locks <a href="#lock-two-types"><img src="chainlink.svg" width="10" height="10"></a></h3><!--SEC END --><p>Java provides two types of locking: monitor locks and explicit locks.</p><ul class="itemize"><li class="li-itemize">
A <span style="font-family:monospace">synchronized(</span><span style="font-family:monospace"><em>E</em></span><span style="font-family:monospace">)</span> block acquires the lock on the value of
<em>E</em>; similarly, a method declared using the <span style="font-family:monospace">synchronized</span> method
modifier acquires the lock on the method receiver when called.
(More precisely,
the current thread locks the monitor associated with the value of
<em>E</em>; see <a href="https://docs.oracle.com/javase/specs/jls/se17/html/jls-17.html#jls-17.1">JLS §17.1</a>.)
The lock is automatically released when execution exits the block or the
method body, respectively.
We use the term “monitor lock” for a lock acquired using a
<span style="font-family:monospace">synchronized</span> block or <span style="font-family:monospace">synchronized</span> method modifier.
</li><li class="li-itemize">A method call, such as
<a href="https://docs.oracle.com/en/java/javase/17/docs/api/java.base/java/util/concurrent/locks/Lock.html#lock()"><span style="font-family:monospace">Lock.lock()</span></a>,
acquires a lock that implements the
<a href="https://docs.oracle.com/en/java/javase/17/docs/api/java.base/java/util/concurrent/locks/Lock.html"><span style="font-family:monospace">Lock</span></a>
interface.
The lock is released by another method call, such as
<a href="https://docs.oracle.com/en/java/javase/17/docs/api/java.base/java/util/concurrent/locks/Lock.html#unlock()"><span style="font-family:monospace">Lock.unlock()</span></a>.
We use the term “explicit lock” for a lock expression acquired in this
way.
</li></ul><p>You should not mix the two varieties of locking, and the Lock Checker
enforces this. To prevent an object from being used both as a monitor and
an explicit lock, the Lock Checker issues a warning if a
<span style="font-family:monospace">synchronized(</span><span style="font-family:monospace"><em>E</em></span><span style="font-family:monospace">)</span> block’s expression <span style="font-family:monospace"><em>E</em></span> has a type that
implements <a href="https://docs.oracle.com/en/java/javase/17/docs/api/java.base/java/util/concurrent/locks/Lock.html"><span style="font-family:monospace">Lock</span></a>.
</p>
<!--TOC subsection id="lock-aliasing" Held locks and held expressions; aliasing-->
<h3 id="lock-aliasing" class="subsection">11.5.2 Held locks and held expressions; aliasing <a href="#lock-aliasing"><img src="chainlink.svg" width="10" height="10"></a></h3><!--SEC END --><p>Whereas Java locking is defined in terms of values, Java programs are
written in terms of expressions.
We say that a lock expression is held if the value to which the expression
currently evaluates is held.</p><p>The Lock Checker conservatively estimates the expressions that are held at
each point in a program.
The Lock Checker does not track aliasing
(different expressions that evaluate to the same value); it only considers
the exact expression used to acquire a lock to be held. After any statement
that might side-effect a held expression or a lock expression, the Lock
Checker conservatively considers the expression to be no longer held.</p><p>Section ‍<a href="#java-expressions-as-arguments">31.8</a> explains which Java
expressions the Lock Checker is able to analyze as lock expressions.</p><p>The <span style="font-family:monospace">@LockHeld</span> and <span style="font-family:monospace">@LockPossiblyHeld</span> type qualifiers are used internally by the Lock Checker
and should never be written by the programmer.
If you
see a warning mentioning <span style="font-family:monospace">@LockHeld</span> or <span style="font-family:monospace">@LockPossiblyHeld</span>,
please contact the Checker Framework developers as it is likely to
indicate a bug in the Checker Framework.</p>
<!--TOC subsection id="lock-runtime-checks" Run-time checks for locking-->
<h3 id="lock-runtime-checks" class="subsection">11.5.3 Run-time checks for locking <a href="#lock-runtime-checks"><img src="chainlink.svg" width="10" height="10"></a></h3><!--SEC END --><p>When you perform a run-time check for locking, such as
<span style="font-family:monospace">if (explicitLock.isHeldByCurrentThread()){...}</span> or
<span style="font-family:monospace">if (Thread.holdsLock(monitorLock)){...}</span>,
then the Lock Checker considers the lock expression to be held
within the scope of the test. For more details, see
Section ‍<a href="#type-refinement">31.7</a>.
</p>
<!--TOC subsection id="lock-checker-default-qualifier" Discussion of default qualifier-->
<h3 id="lock-checker-default-qualifier" class="subsection">11.5.4 Discussion of default qualifier <a href="#lock-checker-default-qualifier"><img src="chainlink.svg" width="10" height="10"></a></h3><!--SEC END --><p>The default qualifier for unannotated types is <span style="font-family:monospace">@GuardedBy({})</span>.
This default forces you to write explicit <span style="font-family:monospace">@GuardSatisfied</span> in method
signatures in the common case that clients ensure that all locks are held.</p><p>It might seem that <span style="font-family:monospace">@GuardSatisfied</span> would be a better default for
method signatures, but such a default would require even more annotations.
The reason is that <span style="font-family:monospace">@GuardSatisfied</span> cannot be used on fields. If
<span style="font-family:monospace">@GuardedBy({})</span> is the default for fields but <span style="font-family:monospace">@GuardSatisfied</span> is the
default for parameters and return types, then getters, setters, and many
other types of methods do not type-check without explicit lock qualifiers.</p>
<!--TOC subsection id="lock-checker-holding" Discussion of <span style="font-family:monospace">@Holding</span>-->
<h3 id="lock-checker-holding" class="subsection">11.5.5 Discussion of <span style="font-family:monospace">@Holding</span> <a href="#lock-checker-holding"><img src="chainlink.svg" width="10" height="10"></a></h3><!--SEC END --><p>A programmer might choose to use the <span style="font-family:monospace">@Holding</span> method annotation in
two different ways: to specify correctness constraints for a
synchronization protocol, or to summarize intended usage. Both of these
approaches are useful, and the Lock Checker supports both.</p>
<!--TOC paragraph id="lock-checker-holding-synchronization-protocol" Synchronization protocol-->
<h5 id="lock-checker-holding-synchronization-protocol" class="paragraph">Synchronization protocol <a href="#lock-checker-holding-synchronization-protocol"><img src="chainlink.svg" width="10" height="10"></a></h5><!--SEC END --><p><span style="font-family:monospace">@Holding</span> can specify a synchronization protocol that
is not expressible as locks over the parameters to a method. For example, a global lock
or a lock on a different object might need to be held. By requiring locks to be
held, you can create protocol primitives without giving up
the benefits of the annotations and checking of them.</p>
<!--TOC paragraph id="lock-checker-holding-method-summary" Method summary that simplifies reasoning-->
<h5 id="lock-checker-holding-method-summary" class="paragraph">Method summary that simplifies reasoning <a href="#lock-checker-holding-method-summary"><img src="chainlink.svg" width="10" height="10"></a></h5><!--SEC END --><p><span style="font-family:monospace">@Holding</span> can be a method summary that simplifies reasoning. In
this case, the <span style="font-family:monospace">@Holding</span> doesn’t necessarily introduce a new
correctness constraint; the program might be correct even if the lock
were not already acquired.</p><p>Rather, here <span style="font-family:monospace">@Holding</span> expresses a fact about execution: when
execution reaches this point, the following locks are known to be already held. This
fact enables people and tools to reason intra- rather than
inter-procedurally.</p><p>In Java, it is always legal to re-acquire a lock that is already held,
and the re-acquisition always works. Thus, whenever you write</p><pre class="verbatim">  @Holding("myLock")
  void myMethod() {
    ...
  }
</pre><p>it would be equivalent, from the point of view of which locks are held
during the body, to write</p><pre class="verbatim">  void myMethod() {
    synchronized (myLock) {   // no-op:  re-acquire a lock that is already held
      ...
    }
  }
</pre><p>It is better to write a <span style="font-family:monospace">@Holding</span> annotation rather than writing the
extra synchronized block. Here are reasons:</p><ul class="itemize"><li class="li-itemize">
The annotation documents the fact that the lock is intended to already be
held; that is, the method’s contract requires that the lock be held when
the method is called.
</li><li class="li-itemize">The Lock Checker enforces that the lock is held when the method is
called, rather than masking a programmer error by silently re-acquiring
the lock.
</li><li class="li-itemize">The version with a synchronized statement can deadlock if, due to a programmer error,
the lock is not already held. The Lock Checker prevents this type of
error.
</li><li class="li-itemize">The annotation has no run-time overhead. The lock re-acquisition
consumes time, even if it succeeds.
</li></ul>
<!--TOC section id="lock-other-annotations" Other lock annotations-->
<h2 id="lock-other-annotations" class="section">11.6 Other lock annotations <a href="#lock-other-annotations"><img src="chainlink.svg" width="10" height="10"></a></h2><!--SEC END --><p>The Checker Framework’s lock annotations are similar to annotations used
elsewhere.</p><p>If your code is already annotated with a different lock
annotation, the Checker Framework can type-check your code.
It treats annotations from other tools
as if you had written the corresponding annotation from the
Lock Checker, as described in Figure ‍<a href="#fig-lock-refactoring">11.2</a>.
If the other annotation is a declaration annotation, it may be moved; see
Section ‍<a href="#declaration-annotations-moved">38.6.8</a>.</p><blockquote class="figure"><div class="center"><hr class="floatrule"></div>
<div class="center">
<table style="border-spacing:6px;border-collapse:separate;" class="cellpading0"><tr><td style="text-align:left;white-space:nowrap" ><table border=1  style="border-spacing:0;" class="cellpadding1"><tr><td style="text-align:left;border:solid 1px;white-space:nowrap" >  ‍net.jcip.annotations.GuardedBy ‍ </td></tr>
<tr><td style="text-align:left;border:solid 1px;white-space:nowrap" >  ‍javax.annotation.concurrent.GuardedBy ‍ </td></tr>
</table></td><td style="text-align:left;white-space:nowrap" >⇒
 ‍org.checkerframework.checker.lock.qual.GuardedBy (for fields) or …Holding (for methods) ‍
</td></tr>
</table></div>
<div class="caption"><table style="border-spacing:6px;border-collapse:separate;" class="cellpading0"><tr><td style="vertical-align:top;text-align:left;" >Figure 11.2: Correspondence between other lock annotations and the
Checker Framework’s annotations.</td></tr>
</table></div>
<a id="fig-lock-refactoring"></a>
<div class="center"><hr class="floatrule"></div></blockquote>
<!--TOC subsection id="lock-jcip-annotations" Relationship to annotations in <em>Java Concurrency in Practice</em>-->
<h3 id="lock-jcip-annotations" class="subsection">11.6.1 Relationship to annotations in <em>Java Concurrency in Practice</em> <a href="#lock-jcip-annotations"><img src="chainlink.svg" width="10" height="10"></a></h3><!--SEC END --><p>The book <a href="https://jcip.net/"><em>Java Concurrency in Practice</em></a> ‍[<a href="#Goetz2006">GPB+06</a>] defines a
<a href="https://jcip.net/annotations/doc/net/jcip/annotations/GuardedBy.html"><span style="font-family:monospace">@GuardedBy</span></a> annotation that is the inspiration for ours. The book’s
<span style="font-family:monospace">@GuardedBy</span> serves two related but distinct purposes:</p><ul class="itemize"><li class="li-itemize">
When applied to a field, it means that the given lock must be held when
accessing the field. The lock acquisition and the field access may occur
arbitrarily far in the future.
</li><li class="li-itemize">When applied to a method, it means that the given lock must be held by
the caller at the time that the method is called — in other words, at
the time that execution passes the <span style="font-family:monospace">@GuardedBy</span> annotation.
</li></ul><p>The Lock Checker renames the method annotation to
<a href="../api/org/checkerframework/checker/lock/qual/Holding.html"><span style="font-family:monospace">@Holding</span></a>, and it generalizes the
<a href="../api/org/checkerframework/checker/lock/qual/GuardedBy.html"><span style="font-family:monospace">@GuardedBy</span></a> annotation into a type annotation
that can apply not just to a field but to an arbitrary type (including the
type of a parameter, return value, local variable, generic type parameter,
etc.). Another important distinction is that the Lock Checker’s
annotations express and enforce a locking discipline over values, just like
the JLS expresses Java’s locking semantics; by contrast, JCIP’s annotations
express a locking discipline that protects variable names and does not
prevent race conditions.
This makes the annotations more expressive and also more amenable
to automated checking. It also accommodates the distinct
meanings of the two annotations, and resolves ambiguity when <span style="font-family:monospace">@GuardedBy</span>
is written in a location that might apply to either the method or the
return type.</p><p>(The JCIP book gives some rationales for reusing the annotation name for
two purposes. One rationale is
that there are fewer annotations to learn. Another rationale is
that both variables and methods are “members” that can be “accessed”
and <span style="font-family:monospace">@GuardedBy</span> creates preconditions for doing so.
Variables can be accessed by reading or writing them (putfield, getfield),
and methods can be accessed by calling them (invokevirtual,
invokeinterface). This informal intuition is
inappropriate for a tool that requires precise semantics.)</p>
<!--TOC section id="lock-extensions" Possible extensions-->
<h2 id="lock-extensions" class="section">11.7 Possible extensions <a href="#lock-extensions"><img src="chainlink.svg" width="10" height="10"></a></h2><!--SEC END --><p>The Lock Checker validates some uses of locks, but not all. It would be
possible to enrich it with additional annotations. This would increase the
programmer annotation burden, but would provide additional guarantees.</p><p>Lock ordering: Specify that one lock must be acquired before or after
another, or specify a global ordering for all locks. This would prevent
deadlock.</p><p>Not-holding: Specify that a method must not be called if any of the listed
locks are held.</p><p>These features are supported by
<a href="http://clang.llvm.org/docs/ThreadSafetyAnalysis.html">Clang’s
thread-safety analysis</a>.</p><hr>
<!--TOC chapter id="index-checker" Index Checker for sequence bounds (arrays and strings)-->
<h1 id="index-checker" class="chapter">Chapter ‍12 Index Checker for sequence bounds (arrays and strings) <a href="#index-checker"><img src="chainlink.svg" width="10" height="10"></a></h1><!--SEC END --><p>The Index Checker warns about potentially out-of-bounds accesses to sequence
data structures, such as arrays
and strings.</p><p>The Index Checker prevents <span style="font-family:monospace">IndexOutOfBoundsException</span>s that result from
an index expression that might be negative or might be equal to or larger
than the sequence’s length.
It also prevents <span style="font-family:monospace">NegativeArraySizeException</span>s that result from a negative
array dimension in an array creation expression.
(A caveat: the Index Checker does not check for arithmetic overflow. If
an expression overflows, the Index Checker might fail to warn about a
possible exception. This is unlikely to be a problem in practice unless
you have an array whose length is <span style="font-family:monospace">Integer.MAX_VALUE</span>.)</p><p>The programmer can write annotations that indicate which expressions are
indices for which sequences. The Index Checker prohibits any operation that
may violate these properties, and the Index Checker takes advantage of
these properties when verifying indexing operations.
Typically, a programmer writes few annotations, because the Index Checker
infers properties of indexes from
the code around them. For example, it will infer that <span style="font-family:monospace">x</span> is positive
within the <span style="font-family:monospace">then</span> block of an <span style="font-family:monospace">if (x &gt; 0)</span> statement.
The programmer does need to write field types and method pre-conditions or post-conditions. For instance,
if a method’s formal parameter is used as an index for
<span style="font-family:monospace">myArray</span>, the programmer might need to
write an <a href="../api/org/checkerframework/checker/index/qual/IndexFor.html"><span style="font-family:monospace">@IndexFor</span></a><span style="font-family:monospace">("myArray")</span>
annotation on the formal parameter’s types.</p><p>The Index Checker checks fixed-size data structures, whose size is never
changed after creation. A fixed-size data structure has no <span style="font-family:monospace">add</span> or
<span style="font-family:monospace">remove</span> operation. Examples are strings and arrays, and you can add
support for other fixed-size data structures (see
Section ‍<a href="#index-annotating-fixed-size">12.9</a>).</p><p>To run the Index Checker, run either of these commands:</p><pre>
  javac -processor index <em>MyJavaFile</em>.java
  javac -processor org.checkerframework.checker.index.IndexChecker <em>MyJavaFile</em>.java
</pre><p>Recall that in Java, type annotations are written before the type;
in particular,
array annotations appear immediately before “<span style="font-family:monospace">[]</span>”.
Here is how to declare a length-9 array of positive integers:</p><pre class="verbatim">  @Positive int @ArrayLen(9) []
</pre><p>Multi-dimensional arrays are similar.
Here is how to declare a length-2 array of length-4 arrays:</p><pre class="verbatim">  String @ArrayLen(2) [] @ArrayLen(4) []
</pre><p>The paper “Lightweight Verification of Array Indexing” (ISSTA 2018,
<a href="https://homes.cs.washington.edu/~mernst/pubs/array-indexing-issta2018-abstract.html"><span style="font-family:monospace">https://homes.cs.washington.edu/~mernst/pubs/array-indexing-issta2018-abstract.html</span></a>)
gives more details about the Index Checker.
“Enforcing correct array indexes with a type system” ‍[<a href="#Santino2016">San16</a>] (FSE 2016) describes
an earlier version.</p>
<!--TOC section id="index-annotations" Index Checker structure and annotations-->
<h2 id="index-annotations" class="section">12.1 Index Checker structure and annotations <a href="#index-annotations"><img src="chainlink.svg" width="10" height="10"></a></h2><!--SEC END --><p>Internally, the Index Checker computes information about integers that
might be indices:
</p><ul class="itemize"><li class="li-itemize">
the lower bound on an integer, such as whether it is known to be positive
(Section ‍<a href="#index-lowerbound">12.2</a>)
</li><li class="li-itemize">the upper bound on an integer, such as whether it is less than the length
of a given sequence (Section ‍<a href="#index-upperbound">12.3</a>)
</li><li class="li-itemize">whether an integer came from calling the JDK’s binary search routine on
an array (Section ‍<a href="#index-searchindex">12.6</a>)
</li><li class="li-itemize">whether an integer came from calling a string search routine
(Section ‍<a href="#index-substringindex">12.7</a>)
</li></ul><p>and about sequence lengths:
</p><ul class="itemize"><li class="li-itemize">
the minimum length of a sequence, such “<span style="font-family:monospace">myArray</span> contains at least 3
elements” (Section ‍<a href="#index-minlen">12.4</a>)
</li><li class="li-itemize">whether two sequences have the same length (Section ‍<a href="#index-samelen">12.5</a>)
</li></ul><p>The Index Checker checks of all these properties at once, but
this manual discusses each type system in a different section.
There are some annotations that are shorthand for writing multiple
annotations, each from a different type system:</p><dl class="description"><dt class="dt-description">
<a href="../api/org/checkerframework/checker/index/qual/IndexFor.html"><span style="font-weight:bold"><span style="font-family:monospace">@IndexFor</span></span></a><span style="font-weight:bold"><span style="font-family:monospace">(String[] names)</span></span></dt><dd class="dd-description">
The value is a valid index for the named sequences. For example, the
<a href="https://docs.oracle.com/en/java/javase/17/docs/api/java.base/java/lang/String.html#charAt(int)"><span style="font-family:monospace">String.charAt(int)</span></a>
method is declared as<pre class="verbatim">  class String {
    char charAt(@IndexFor("this") index) { ... }
  }
  </pre><p>More generally, a variable
declared as <span style="font-family:monospace">@IndexFor("someArray") int i</span> has type
<span style="font-family:monospace">@IndexFor("someArray") int</span> and its run-time value is guaranteed to be
non-negative and less than the length of <span style="font-family:monospace">someArray</span>. You could also
express this as
<a href="../api/org/checkerframework/checker/index/qual/NonNegative.html"><span style="font-family:monospace">@NonNegative</span></a><span style="font-family:monospace">
</span><a href="../api/org/checkerframework/checker/index/qual/LTLengthOf.html"><span style="font-family:monospace">@LTLengthOf</span></a><span style="font-family:monospace">("someArray")</span><span style="font-family:monospace">
int i</span>,
but <span style="font-family:monospace">@IndexFor("someArray") int i</span> is more concise.</p></dd><dt class="dt-description"><a href="../api/org/checkerframework/checker/index/qual/IndexOrHigh.html"><span style="font-weight:bold"><span style="font-family:monospace">@IndexOrHigh</span></span></a><span style="font-weight:bold"><span style="font-family:monospace">(String[] names)</span></span></dt><dd class="dd-description">
The value is non-negative and is less than or equal to the length of
each named sequence. This type combines
<a href="../api/org/checkerframework/checker/index/qual/NonNegative.html"><span style="font-family:monospace">@NonNegative</span></a> and
<a href="../api/org/checkerframework/checker/index/qual/LTEqLengthOf.html"><span style="font-family:monospace">@LTEqLengthOf</span></a>.<p>For example, the
<a href="https://docs.oracle.com/en/java/javase/17/docs/api/java.base/java/util/Arrays.html#fill(java.lang.Object%5B%5D,int,int,java.lang.Object)"><span style="font-family:monospace">Arrays.fill</span></a>
method is declared as</p><div style="font-size:small;">
<pre class="verbatim">  class Arrays {
    void fill(Object[] a, @IndexFor("#1") int fromIndex, @IndexOrHigh("#1") int toIndex, Object val)
  }
  </pre>
</div></dd><dt class="dt-description"><a href="../api/org/checkerframework/checker/index/qual/LengthOf.html"><span style="font-weight:bold"><span style="font-family:monospace">@LengthOf</span></span></a><span style="font-weight:bold"><span style="font-family:monospace">(String[] names)</span></span></dt><dd class="dd-description">
The value is exactly equal to the length of the named
sequences. In the implementation, this type aliases
<a href="../api/org/checkerframework/checker/index/qual/IndexOrHigh.html"><span style="font-family:monospace">@IndexOrHigh</span></a>, so writing it
only adds documentation (although future versions of the Index Checker
may use it to improve precision).</dd><dt class="dt-description"><a href="../api/org/checkerframework/checker/index/qual/IndexOrLow.html"><span style="font-weight:bold"><span style="font-family:monospace">@IndexOrLow</span></span></a><span style="font-weight:bold"><span style="font-family:monospace">(String[] names)</span></span></dt><dd class="dd-description">
The value is -1 or is a valid index for
each named sequence. This type combines
<a href="../api/org/checkerframework/checker/index/qual/GTENegativeOne.html"><span style="font-family:monospace">@GTENegativeOne</span></a> and
<a href="../api/org/checkerframework/checker/index/qual/LTLengthOf.html"><span style="font-family:monospace">@LTLengthOf</span></a>.</dd><dt class="dt-description"><a href="../api/org/checkerframework/checker/index/qual/PolyIndex.html"><span style="font-weight:bold"><span style="font-family:monospace">@PolyIndex</span></span></a></dt><dd class="dd-description">
indicates qualifier polymorphism. This type combines
<a href="../api/org/checkerframework/checker/index/qual/PolyLowerBound.html"><span style="font-family:monospace">@PolyLowerBound</span></a> and
<a href="../api/org/checkerframework/checker/index/qual/PolyUpperBound.html"><span style="font-family:monospace">@PolyUpperBound</span></a>.
For a description of qualifier polymorphism, see
Section ‍<a href="#method-qualifier-polymorphism">30.2</a>.</dd><dt class="dt-description"><a href="../api/org/checkerframework/checker/index/qual/PolyLength.html"><span style="font-weight:bold"><span style="font-family:monospace">@PolyLength</span></span></a></dt><dd class="dd-description">
is a special polymorphic qualifier that combines
<a href="../api/org/checkerframework/checker/index/qual/PolySameLen.html"><span style="font-family:monospace">@PolySameLen</span></a> and
<a href="../api/org/checkerframework/common/value/qual/PolyValue.html"><span style="font-family:monospace">@PolyValue</span></a> from the
Constant Value Checker (see Chapter ‍<a href="#constant-value-checker">22</a>).
<a href="../api/org/checkerframework/checker/index/qual/PolyLength.html"><span style="font-family:monospace">@PolyLength</span></a> exists
as a shorthand for these two annotations, since
they often appear together.</dd></dl>
<!--TOC section id="index-lowerbound" Lower bounds-->
<h2 id="index-lowerbound" class="section">12.2 Lower bounds <a href="#index-lowerbound"><img src="chainlink.svg" width="10" height="10"></a></h2><!--SEC END --><p>The Index Checker issues an error when
a sequence is indexed by an integer that might be negative.
The Lower Bound Checker uses a type system (Figure ‍<a href="#fig-index-int-types">12.1</a>) with the following
qualifiers:</p><dl class="description"><dt class="dt-description">
<a href="../api/org/checkerframework/checker/index/qual/Positive.html"><span style="font-weight:bold"><span style="font-family:monospace">@Positive</span></span></a></dt><dd class="dd-description">
The value is 1 or greater, so it is not too low to be used as an index.
Note that this annotation is trusted by the Constant Value Checker,
so if the Constant Value Checker is run on code containing this annotation,
the Lower Bound Checker must be run on the same code in order to
guarantee soundness.
</dd><dt class="dt-description"><a href="../api/org/checkerframework/checker/index/qual/NonNegative.html"><span style="font-weight:bold"><span style="font-family:monospace">@NonNegative</span></span></a></dt><dd class="dd-description">
The value is 0 or greater, so it is not too low to be used as an index.
</dd><dt class="dt-description"><a href="../api/org/checkerframework/checker/index/qual/GTENegativeOne.html"><span style="font-weight:bold"><span style="font-family:monospace">@GTENegativeOne</span></span></a></dt><dd class="dd-description">
The value is -1 or greater.
It may not be used as an index for a sequence, because it might be too low.
(“<span style="font-family:monospace">GTE</span>” stands for “Greater Than or Equal to”.)
</dd><dt class="dt-description"><a href="../api/org/checkerframework/checker/index/qual/PolyLowerBound.html"><span style="font-weight:bold"><span style="font-family:monospace">@PolyLowerBound</span></span></a></dt><dd class="dd-description">
indicates qualifier polymorphism.
For a description of qualifier polymorphism, see
Section ‍<a href="#method-qualifier-polymorphism">30.2</a>.
</dd><dt class="dt-description"><a href="../api/org/checkerframework/checker/index/qual/LowerBoundUnknown.html"><span style="font-weight:bold"><span style="font-family:monospace">@LowerBoundUnknown</span></span></a></dt><dd class="dd-description">
There is no information about the value.
It may not be used as an index for a sequence, because it might be too low.
</dd><dt class="dt-description"><a href="../api/org/checkerframework/checker/index/qual/LowerBoundBottom.html"><span style="font-weight:bold"><span style="font-family:monospace">@LowerBoundBottom</span></span></a></dt><dd class="dd-description">
The value cannot take on any integral types. The bottom type, which
should not need to be written by the programmer.
</dd></dl><blockquote class="figure"><div class="center"><hr class="floatrule"></div>
<div class="center">
<img src="lowerbound.svg">
 ‍ ‍ ‍ ‍ ‍ ‍ ‍ ‍
<img src="upperbound.svg">
</div>
<div class="caption"><table style="border-spacing:6px;border-collapse:separate;" class="cellpading0"><tr><td style="vertical-align:top;text-align:left;" >Figure 12.1: The two type hierarchies for integer types used by the Index
Checker. On the left is a type system for lower bounds. On the right
is a type system for upper bounds. Qualifiers written in gray should
never be written in source code; they are used internally by the type
system.
<br>
In the Upper Bound type system, subtyping rules depend on both the
array name (<span style="font-family:monospace">"myArray"</span>, in the figure) and on the offset (which is 0,
the default, in the figure). Another qualifier is
<a href="../api/org/checkerframework/checker/index/qual/UpperBoundLiteral.html"><span style="font-family:monospace">@UpperBoundLiteral</span></a>, whose subtyping
relationships depend on its argument and on offsets for other qualifiers.
</td></tr>
</table></div>
<a id="fig-index-int-types"></a>
<div class="center"><hr class="floatrule"></div></blockquote>
<!--TOC section id="index-upperbound" Upper bounds-->
<h2 id="index-upperbound" class="section">12.3 Upper bounds <a href="#index-upperbound"><img src="chainlink.svg" width="10" height="10"></a></h2><!--SEC END --><p>The Index Checker issues an error when a sequence index might be
too high. To do this, it maintains information about which expressions are
safe indices for which sequences.
The length of a sequence is <span style="font-family:monospace">arr.length</span> for arrays and
<span style="font-family:monospace">str.length()</span> for strings.
It uses a type system (Figure ‍<a href="#fig-index-int-types">12.1</a>) with the following
qualifiers:</p><p>It issues an error when a sequence <span style="font-family:monospace">arr</span>
is indexed by an integer that is not of type <span style="font-family:monospace">@LTLengthOf("arr")</span>
or <span style="font-family:monospace">@LTOMLengthOf("arr")</span>.</p><dl class="description"><dt class="dt-description"><a href="../api/org/checkerframework/checker/index/qual/LTLengthOf.html"><span style="font-weight:bold"><span style="font-family:monospace">@LTLengthOf</span></span></a><span style="font-weight:bold"><span style="font-family:monospace">(String[] names, String[] offset)</span></span></dt><dd class="dd-description">
An expression with this type
has value less than the length of each sequence listed in <span style="font-family:monospace">names</span>.
The expression may be used as an index into any of those sequences,
if it is non-negative.
For example, an expression of type <span style="font-family:monospace">@LTLengthOf("a") int</span> might be
used as an index to <span style="font-family:monospace">a</span>.
The type <span style="font-family:monospace">@LTLengthOf({"a", "b"})</span> is a subtype of both
<span style="font-family:monospace">@LTLengthOf("a")</span> and <span style="font-family:monospace">@LTLengthOf("b")</span>.
(“<span style="font-family:monospace">LT</span>” stands for “Less Than”.)<p><span style="font-family:monospace">@LTLengthOf</span> takes an optional <span style="font-family:monospace">offset</span> element, meaning that the
annotated expression plus the offset is less than the length of the given
sequence. For example, suppose expression <span style="font-family:monospace">e</span> has type <span style="font-family:monospace">@LTLengthOf(value
= {"a", "b"}, offset = {"-1", "x"})</span>. Then <span style="font-family:monospace">e - 1</span> is less than
<span style="font-family:monospace">a.length</span>, and <span style="font-family:monospace">e + x</span> is less than <span style="font-family:monospace">b.length</span>. This helps to make
the checker more precise. Programmers rarely need to write the <span style="font-family:monospace">offset</span>
element.</p></dd><dt class="dt-description"><a href="../api/org/checkerframework/checker/index/qual/LTEqLengthOf.html"><span style="font-weight:bold"><span style="font-family:monospace">@LTEqLengthOf</span></span></a><span style="font-weight:bold"><span style="font-family:monospace">(String[] names)</span></span></dt><dd class="dd-description">
An expression with this type
has value less than or equal to the length of each sequence listed in <span style="font-family:monospace">names</span>.
It may not be used as an index for these sequences, because it might be too high.
<span style="font-family:monospace">@LTEqLengthOf({"a", "b"})</span> is a subtype of both
<span style="font-family:monospace">@LTEqLengthOf("a")</span> and <span style="font-family:monospace">@LTEqLengthOf("b")</span>.
(“<span style="font-family:monospace">LTEq</span>” stands for “Less Than or Equal to”.)<p><span style="font-family:monospace">@LTEqLengthOf({"a"})</span> = <span style="font-family:monospace">@LTLengthOf(value={"a"}, offset=-1)</span>, and <br>
 <span style="font-family:monospace">@LTEqLengthOf(value={"a"}, offset=x)</span> = <span style="font-family:monospace">@LTLengthOf(value={"a"},
offset=x-1)</span> for any x.</p></dd><dt class="dt-description"><a href="../api/org/checkerframework/checker/index/qual/LTOMLengthOf.html"><span style="font-weight:bold"><span style="font-family:monospace">@LTOMLengthOf</span></span></a><span style="font-weight:bold"><span style="font-family:monospace">(String[] names)</span></span></dt><dd class="dd-description">
An expression with this type
has value at least 2 less than the length of each sequence listed in <span style="font-family:monospace">names</span>.
It may always used as an index for a sequence listed in <span style="font-family:monospace">names</span>, if it is
non-negative.<p>This type exists to allow the checker to infer the safety of loops of
the form:
</p><pre class="verbatim">  for (int i = 0; i &lt; array.length - 1; ++i) {
    arr[i] = arr[i+1];
  }
</pre><p>
This annotation should rarely (if ever) be written by the programmer; usually
<a href="../api/org/checkerframework/checker/index/qual/LTLengthOf.html"><span style="font-family:monospace">@LTLengthOf</span></a><span style="font-family:monospace">(String[] names)</span>
should be written instead.
<span style="font-family:monospace">@LTOMLengthOf({"a", "b"})</span> is a subtype of both
<span style="font-family:monospace">@LTOMLengthOf("a")</span> and <span style="font-family:monospace">@LTOMLengthOf("b")</span>.
(“<span style="font-family:monospace">LTOM</span>” stands for “Less Than One Minus”, because another way of
saying “at least 2 less than <span style="font-family:monospace">a.length</span>” is “less than <span style="font-family:monospace">a.length-1</span>”.)</p><p><span style="font-family:monospace">@LTOMLengthOf({"a"})</span> = <span style="font-family:monospace">@LTLengthOf(value={"a"}, offset=1)</span>, and <br>
 <span style="font-family:monospace">@LTOMLengthOf(value={"a"}, offset=x)</span> = <span style="font-family:monospace">@LTLengthOf(value={"a"},
offset=x+1)</span> for any x.</p></dd><dt class="dt-description"><a href="../api/org/checkerframework/checker/index/qual/UpperBoundLiteral.html"><span style="font-weight:bold"><span style="font-family:monospace">@UpperBoundLiteral</span></span></a></dt><dd class="dd-description">
repesents a constant value, typically a literal written in source code.
Its subtyping relationship is:
<span style="font-family:monospace">@UpperBoundLiteral(lit)</span> &lt;: <span style="font-family:monospace">LTLengthOf(value="myArray", offset=off)</span>
if <span style="font-family:monospace">lit</span>+<span style="font-family:monospace">offset</span> ≤ -1.</dd><dt class="dt-description"><a href="../api/org/checkerframework/checker/index/qual/PolyUpperBound.html"><span style="font-weight:bold"><span style="font-family:monospace">@PolyUpperBound</span></span></a></dt><dd class="dd-description">
indicates qualifier polymorphism.
For a description of qualifier polymorphism, see
Section ‍<a href="#method-qualifier-polymorphism">30.2</a>.</dd><dt class="dt-description"><a href="../api/org/checkerframework/checker/index/qual/UpperBoundUnknown.html"><span style="font-weight:bold"><span style="font-family:monospace">@UpperBoundUnknown</span></span></a></dt><dd class="dd-description">
There is no information about the upper bound on the value of an expression with this type.
It may not be used as an index for a sequence, because it might be too high.
This type is the top type, and should never need to be written by the
programmer.</dd><dt class="dt-description"><a href="../api/org/checkerframework/checker/index/qual/UpperBoundBottom.html"><span style="font-weight:bold"><span style="font-family:monospace">@UpperBoundBottom</span></span></a></dt><dd class="dd-description">
This is the bottom type for the upper bound type system. It should
never need to be written by the programmer.</dd></dl><p>The following method annotations can be used to establish a method postcondition
that ensures that a certain expression is a valid index for a sequence:</p><dl class="description"><dt class="dt-description">
<a href="../api/org/checkerframework/checker/index/qual/EnsuresLTLengthOf.html"><span style="font-weight:bold"><span style="font-family:monospace">@EnsuresLTLengthOf</span></span></a><span style="font-weight:bold"><span style="font-family:monospace">(String[] value, String[] targetValue, String[] offset)</span></span></dt><dd class="dd-description">
When the method with this annotation returns, the expression (or all the expressions) given in the <span style="font-family:monospace">value</span> element
is less than the length of the given sequences with the given offsets. More precisely, the expression
has the <span style="font-family:monospace">@LTLengthOf</span> qualifier with the <span style="font-family:monospace">value</span> and <span style="font-family:monospace">offset</span> arguments
taken from the <span style="font-family:monospace">targetValue</span> and <span style="font-family:monospace">offset</span> elements of this annotation.
</dd><dt class="dt-description"><a href="../api/org/checkerframework/checker/index/qual/EnsuresLTLengthOfIf.html"><span style="font-weight:bold"><span style="font-family:monospace">@EnsuresLTLengthOfIf</span></span></a><span style="font-weight:bold"><span style="font-family:monospace">(String[] expression, boolean result, String[] targetValue, String[] offset)</span></span></dt><dd class="dd-description">
If the method with this annotation returns the given boolean value,
then the given expression (or all the given expressions)
is less than the length of the given sequences with the given offsets.
</dd></dl><p>There is one declaration annotation that indicates the relationship between
two sequences:</p><dl class="description"><dt class="dt-description">
<a href="../api/org/checkerframework/checker/index/qual/HasSubsequence.html"><span style="font-weight:bold"><span style="font-family:monospace">@HasSubsequence</span></span></a><span style="font-weight:bold"><span style="font-family:monospace">(String[]
value, String[] from, String[] to)</span></span></dt><dd class="dd-description">
indicates that a subsequence (from <span style="font-family:monospace">from</span> to <span style="font-family:monospace">to</span>) of the
annotated sequence is equal to some other sequence, named by
<span style="font-family:monospace">value</span>).<p>For example, to indicate that <span style="font-family:monospace">shorter</span> is a subsequence of <span style="font-family:monospace">longer</span>:</p><pre class="verbatim">  int start;
  int end;
  int[] shorter;
  @HasSubsequence(value="shorter", from="this.start", to="this.end")
  int[] longer;
</pre><p>Thus, a valid index into <span style="font-family:monospace">shorter</span> is also a valid index (between
<span style="font-family:monospace">start</span> and <span style="font-family:monospace">end-1</span> inclusive) into <span style="font-family:monospace">longer</span>. More generally,
if <span style="font-family:monospace">x</span> is <span style="font-family:monospace">@IndexFor("shorter")</span> in the example above, then
<span style="font-family:monospace">start + x</span> is <span style="font-family:monospace">@IndexFor("longer")</span>. If <span style="font-family:monospace">y</span> is
<span style="font-family:monospace">@IndexFor("longer")</span> and <span style="font-family:monospace">@LessThan("end")</span>, then <span style="font-family:monospace">y -
start</span> is <span style="font-family:monospace">@IndexFor("shorter")</span>. Finally, <span style="font-family:monospace">end - start</span> is
<span style="font-family:monospace">@IndexOrHigh("shorter")</span>.</p><p>This annotation is in part checked and in part trusted. When an array is
assigned to <span style="font-family:monospace">longer</span>, three facts are checked: that <span style="font-family:monospace">start</span> is
non-negative, that <span style="font-family:monospace">start</span> is less than or equal to <span style="font-family:monospace">end</span>, and
that <span style="font-family:monospace">end</span> is less than or equal to the length of <span style="font-family:monospace">longer</span>. This
ensures that the indices are valid. The programmer must manually verify
that the value of <span style="font-family:monospace">shorter</span> equals the subsequence that they describe.
</p></dd></dl>
<!--TOC section id="index-minlen" Sequence minimum lengths-->
<h2 id="index-minlen" class="section">12.4 Sequence minimum lengths <a href="#index-minlen"><img src="chainlink.svg" width="10" height="10"></a></h2><!--SEC END --><p>The Index Checker estimates, for each sequence expression, how long its value
might be at run time by computing a minimum length that
the sequence is guaranteed to have. This enables the Index Checker to
verify indices that are compile-time constants. For example, this code:</p><pre class="verbatim">  String getThirdElement(String[] arr) {
    return arr[2];
  }
</pre><p>is legal if <span style="font-family:monospace">arr</span> has at least three elements, which can be indicated
in this way:</p><pre class="verbatim">  String getThirdElement(String @MinLen(3) [] arr) {
    return arr[2];
  }
</pre><p>When the index is not a compile-time constant, as in <span style="font-family:monospace">arr[i]</span>, then the
Index Checker depends not on a <span style="font-family:monospace">@MinLen</span> annotation but on <span style="font-family:monospace">i</span> being
annotated as
<a href="../api/org/checkerframework/checker/index/qual/LTLengthOf.html"><span style="font-family:monospace">@LTLengthOf</span></a><span style="font-family:monospace">("arr")</span>.</p><p>The MinLen type qualifier is implemented in practice by the Constant Value Checker,
using <span style="font-family:monospace">@ArrayLenRange</span> annotations (see Chapter ‍<a href="#constant-value-checker">22</a>).
This means that errors related to the minimum lengths of arrays must be suppressed using
the "value" argument to <span style="font-family:monospace">@SuppressWarnings</span>.
<a href="../api/org/checkerframework/common/value/qual/ArrayLenRange.html"><span style="font-family:monospace">@ArrayLenRange</span></a> and <a href="../api/org/checkerframework/common/value/qual/ArrayLen.html"><span style="font-family:monospace">@ArrayLen</span></a>
annotations can also be used to establish the minimum length of a sequence, if a
more precise estimate of length is known. For example,
if <span style="font-family:monospace">arr</span> is known to have exactly three elements:</p><pre class="verbatim">  String getThirdElement(String @ArrayLen(3) [] arr) {
    return arr[2];
  }
</pre><p>The following type qualifiers (from Chapter ‍<a href="#constant-value-checker">22</a>)
can establish the minimum length of a sequence:</p><dl class="description"><dt class="dt-description">
<a href="../api/org/checkerframework/common/value/qual/MinLen.html"><span style="font-weight:bold"><span style="font-family:monospace">@MinLen</span></span></a><span style="font-weight:bold"><span style="font-family:monospace">(int value)</span></span></dt><dd class="dd-description">
The value of an expression of this type is a sequence with at least
<span style="font-family:monospace">value</span> elements. The default annotation is
<span style="font-family:monospace">@MinLen(0)</span>, and it may be applied to non-sequences.
<span style="font-family:monospace">@MinLen(</span><span style="font-style:italic">x</span><span style="font-family:monospace">)</span> is a subtype of <span style="font-family:monospace">@MinLen(</span><span style="font-style:italic">x</span>−1<span style="font-family:monospace">)</span>.
An <span style="font-family:monospace">@MinLen</span> annotation is treated internally as an
<a href="../api/org/checkerframework/common/value/qual/ArrayLenRange.html"><span style="font-family:monospace">@ArrayLenRange</span></a> with only its
<span style="font-family:monospace">from</span> field filled.
</dd><dt class="dt-description"><a href="../api/org/checkerframework/common/value/qual/ArrayLen.html"><span style="font-weight:bold"><span style="font-family:monospace">@ArrayLen</span></span></a><span style="font-weight:bold"><span style="font-family:monospace">(int[] value)</span></span></dt><dd class="dd-description">
The value of an expression of this type is a sequence whose
length is exactly one of the integers listed in its argument.
The argument can contain at most ten integers; larger collections of
integers are converted to <a href="../api/org/checkerframework/common/value/qual/ArrayLenRange.html"><span style="font-family:monospace">@ArrayLenRange</span></a>
annotations. The minimum length of a sequence with this annotation
is the smallest element of the argument.
</dd><dt class="dt-description"><a href="../api/org/checkerframework/common/value/qual/ArrayLenRange.html"><span style="font-weight:bold"><span style="font-family:monospace">@ArrayLenRange</span></span></a><span style="font-weight:bold"><span style="font-family:monospace">(int from, int to)</span></span></dt><dd class="dd-description">
The value of an expression of this type is a sequence whose
length is bounded by its arguments, inclusive.
The minimum length of a sequence with this annotation is its <span style="font-family:monospace">from</span> argument.
</dd></dl><blockquote class="figure"><div class="center"><hr class="floatrule"></div>
<div class="center">
<div class="center">
<img src="samelen.svg">
</div>
</div>
<div class="caption"><table style="border-spacing:6px;border-collapse:separate;" class="cellpading0"><tr><td style="vertical-align:top;text-align:left;" >Figure 12.2: The type hierarchy for arrays of equal length ("a" and "b" are
assumed to be in-scope sequences). Qualifiers
written in gray should never be written in source code; they are used
internally by the type system.</td></tr>
</table></div>
<a id="fig-index-array-types"></a>
<div class="center"><hr class="floatrule"></div></blockquote><p>The following method annotation can be used to establish a method postcondition
that ensures that a certain sequence has a minimum length:</p><dl class="description"><dt class="dt-description">
<a href="../api/org/checkerframework/common/value/qual/EnsuresMinLenIf.html"><span style="font-weight:bold"><span style="font-family:monospace">@EnsuresMinLenIf</span></span></a><span style="font-weight:bold"><span style="font-family:monospace">(String[] expression, boolean result, int targetValue)</span></span></dt><dd class="dd-description">
If the method with this annotation returns the given boolean value,
then the given expression (or all the given expressions) is a sequence
with at least <span style="font-family:monospace">targetValue</span> elements.
</dd></dl>
<!--TOC section id="index-samelen" Sequences of the same length-->
<h2 id="index-samelen" class="section">12.5 Sequences of the same length <a href="#index-samelen"><img src="chainlink.svg" width="10" height="10"></a></h2><!--SEC END --><p>The Index Checker determines whether two or more sequences have the same length.
This enables it to verify that all the indexing operations are safe in code
like the following:</p><pre class="verbatim">  boolean lessThan(double[] arr1, double @SameLen("#1") [] arr2) {
    for (int i = 0; i &lt; arr1.length; i++) {
      if (arr1[i] &lt; arr2[i]) {
        return true;
      } else if (arr1[i] &gt; arr2[i]) {
        return false;
      }
    }
    return false;
  }
</pre><p>When needed, you can specify which sequences have the same length using the following type qualifiers (Figure ‍<a href="#fig-index-array-types">12.2</a>):</p><dl class="description"><dt class="dt-description">
<a href="../api/org/checkerframework/checker/index/qual/SameLen.html"><span style="font-weight:bold"><span style="font-family:monospace">@SameLen</span></span></a><span style="font-weight:bold"><span style="font-family:monospace">(String[] names)</span></span></dt><dd class="dd-description">
An expression with this type represents a sequence that has the
same length as the other sequences named in <span style="font-family:monospace">names</span>. In general,
<span style="font-family:monospace">@SameLen</span> types that have non-intersecting sets of names
are <span style="font-style:italic">not</span> subtypes of each other. However, if at least one
sequence is named by both types, the types are actually the same,
because all the named sequences must have the same length.
</dd><dt class="dt-description"><a href="../api/org/checkerframework/checker/index/qual/PolySameLen.html"><span style="font-weight:bold"><span style="font-family:monospace">@PolySameLen</span></span></a></dt><dd class="dd-description">
indicates qualifier polymorphism.
For a description of qualifier polymorphism, see
Section ‍<a href="#method-qualifier-polymorphism">30.2</a>.
</dd><dt class="dt-description"><a href="../api/org/checkerframework/checker/index/qual/SameLenUnknown.html"><span style="font-weight:bold"><span style="font-family:monospace">@SameLenUnknown</span></span></a></dt><dd class="dd-description">
No information is known about which other sequences have the same length
as this one.
This is the top type, and programmers should never need to write it.
</dd><dt class="dt-description"><a href="../api/org/checkerframework/checker/index/qual/SameLenBottom.html"><span style="font-weight:bold"><span style="font-family:monospace">@SameLenBottom</span></span></a></dt><dd class="dd-description">
This is the bottom type, and programmers should rarely need to write it.
<span style="font-family:monospace">null</span> has this type.
</dd></dl>
<!--TOC section id="index-searchindex" Binary search indices-->
<h2 id="index-searchindex" class="section">12.6 Binary search indices <a href="#index-searchindex"><img src="chainlink.svg" width="10" height="10"></a></h2><!--SEC END --><p>The JDK’s
<a href="https://docs.oracle.com/en/java/javase/17/docs/api/java.base/java/util/Arrays.html#binarySearch(java.lang.Object%5B%5D,java.lang.Object)"><span style="font-family:monospace">Arrays.binarySearch</span></a>
method returns either where the value was found, or a negative value
indicating where the value could be inserted. The Search Index Checker
represents this concept.</p><blockquote class="figure"><div class="center"><hr class="floatrule"></div>
<div class="center">
<div class="center">
<img src="searchindex.svg">
</div>
</div>
<div class="caption"><table style="border-spacing:6px;border-collapse:separate;" class="cellpading0"><tr><td style="vertical-align:top;text-align:left;" >Figure 12.3: The type hierarchy for the Index Checker’s internal type system
that captures information about the results of calls to
<a href="https://docs.oracle.com/en/java/javase/17/docs/api/java.base/java/util/Arrays.html#binarySearch(java.lang.Object%5B%5D,java.lang.Object)"><span style="font-family:monospace">Arrays.binarySearch</span></a>.</td></tr>
</table></div>
<a id="fig-index-searchindex"></a>
<div class="center"><hr class="floatrule"></div></blockquote><p>The Search Index Checker’s type hierarchy (Figure ‍<a href="#fig-index-searchindex">12.3</a>) has four type qualifiers:
</p><dl class="description"><dt class="dt-description">
<a href="../api/org/checkerframework/checker/index/qual/SearchIndexFor.html"><span style="font-weight:bold"><span style="font-family:monospace">@SearchIndexFor</span></span></a><span style="font-weight:bold"><span style="font-family:monospace">(String[] names)</span></span></dt><dd class="dd-description">
An expression with this type represents an integer that could have been
produced by calling
<a href="https://docs.oracle.com/en/java/javase/17/docs/api/java.base/java/util/Arrays.html#binarySearch(java.lang.Object%5B%5D,java.lang.Object)"><span style="font-family:monospace">Arrays.binarySearch</span></a>:
for each array <span style="font-family:monospace">a</span> specified in the annotation, the annotated integer is
between <span style="font-family:monospace">-a.length-1</span> and <span style="font-family:monospace">a.length-1</span>, inclusive
</dd><dt class="dt-description"><a href="../api/org/checkerframework/checker/index/qual/NegativeIndexFor.html"><span style="font-weight:bold"><span style="font-family:monospace">@NegativeIndexFor</span></span></a><span style="font-weight:bold"><span style="font-family:monospace">(String[] names)</span></span></dt><dd class="dd-description">
An expression with this type represents a “negative index” that is
between <span style="font-family:monospace">a.length-1</span> and <span style="font-family:monospace">-1</span>, inclusive; that is, a value that is both
a <span style="font-family:monospace">@SearchIndex</span> and is negative. Applying the bitwise complement
operator (<code class="verb">~</code>) to an expression of this type produces an expression
of type <a href="../api/org/checkerframework/checker/index/qual/IndexOrHigh.html"><span style="font-family:monospace">@IndexOrHigh</span></a>.
</dd><dt class="dt-description"><a href="../api/org/checkerframework/checker/index/qual/SearchIndexBottom.html"><span style="font-weight:bold"><span style="font-family:monospace">@SearchIndexBottom</span></span></a></dt><dd class="dd-description">
This is the bottom type, and programmers should rarely need to write it.
</dd><dt class="dt-description"><a href="../api/org/checkerframework/checker/index/qual/SearchIndexUnknown.html"><span style="font-weight:bold"><span style="font-family:monospace">@SearchIndexUnknown</span></span></a></dt><dd class="dd-description">
No information is known about whether this integer is a search index.
This is the top type, and programmers should rarely need to write it.
</dd></dl>
<!--TOC section id="index-substringindex" Substring indices-->
<h2 id="index-substringindex" class="section">12.7 Substring indices <a href="#index-substringindex"><img src="chainlink.svg" width="10" height="10"></a></h2><!--SEC END --><p>The methods
<a href="https://docs.oracle.com/en/java/javase/17/docs/api/java.base/java/lang/String.html#indexOf(java.lang.String)"><span style="font-family:monospace">String.indexOf</span></a>
and
<a href="https://docs.oracle.com/en/java/javase/17/docs/api/java.base/java/lang/String.html#lastIndexOf(java.lang.String)"><span style="font-family:monospace">String.lastIndexOf</span></a>
return an index of a given substring within a given string, or -1 if no
such substring exists. The index <span style="font-family:monospace">i</span> returned from
<span style="font-family:monospace">receiver.indexOf(substring)</span> satisfies the following property, which is
stated here in three equivalent ways:
</p><pre class="verbatim"> i == -1 || ( i &gt;= 0       &amp;&amp; i &lt;= receiver.length() - substring.length()                  )
 i == -1 || ( @NonNegative &amp;&amp; @LTLengthOf(value="receiver", offset="substring.length()-1") )
 @SubstringIndexFor(value="receiver", offset="substring.length()-1")
</pre><p>The return type of methods <a href="https://docs.oracle.com/en/java/javase/17/docs/api/java.base/java/lang/String.html#indexOf(java.lang.String)"><span style="font-family:monospace">String.indexOf</span></a>
and <a href="https://docs.oracle.com/en/java/javase/17/docs/api/java.base/java/lang/String.html#lastIndexOf(java.lang.String)"><span style="font-family:monospace">String.lastIndexOf</span></a> has the annotation
<a href="../api/org/checkerframework/checker/index/qual/SubstringIndexFor.html"><span style="font-family:monospace">@SubstringIndexFor</span></a><span style="font-family:monospace">(value="this", offset="#1.length()-1"))</span>.
This allows writing code such as the following with no warnings from the
Index Checker:</p><pre class="verbatim">  public static String removeSubstring(String original, String removed) {
    int i = original.indexOf(removed);
    if (i != -1) {
      return original.substring(0, i) + original.substring(i + removed.length());
    }
    return original;
  }
</pre><blockquote class="figure"><div class="center"><hr class="floatrule"></div>
<div class="center">
<div class="center">
<img src="substringindex.svg">
</div>
</div>
<div class="caption"><table style="border-spacing:6px;border-collapse:separate;" class="cellpading0"><tr><td style="vertical-align:top;text-align:left;" >Figure 12.4: The type hierarchy for the Substring Index Checker, which
captures information about the results of calls to
<a href="https://docs.oracle.com/en/java/javase/17/docs/api/java.base/java/lang/String.html#indexOf(java.lang.String)"><span style="font-family:monospace">String.indexOf</span></a>
and
<a href="https://docs.oracle.com/en/java/javase/17/docs/api/java.base/java/lang/String.html#lastIndexOf(java.lang.String)"><span style="font-family:monospace">String.lastIndexOf</span></a>.</td></tr>
</table></div>
<a id="fig-index-substringindex"></a>
<div class="center"><hr class="floatrule"></div></blockquote><p>The <span style="font-family:monospace">@SubstringIndexFor</span> annotation is implemented in a Substring Index
Checker that runs together with the Index Checker and has its own type
hierarchy (Figure ‍<a href="#fig-index-substringindex">12.4</a>) with three type
qualifiers:
</p><dl class="description"><dt class="dt-description">
<a href="../api/org/checkerframework/checker/index/qual/SubstringIndexFor.html"><span style="font-weight:bold"><span style="font-family:monospace">@SubstringIndexFor</span></span></a><span style="font-weight:bold"><span style="font-family:monospace">(String[] value, String[] offset)</span></span></dt><dd class="dd-description">
An expression with this type represents an integer that could have been
produced by calling
<a href="https://docs.oracle.com/en/java/javase/17/docs/api/java.base/java/lang/String.html#indexOf(java.lang.String)"><span style="font-family:monospace">String.indexOf</span></a>:
the annotated integer is either -1, or it is non-negative and is less
than or equal to <span style="font-family:monospace">receiver.length - offset</span> (where the sequence
<span style="font-family:monospace">receiver</span> and the offset <span style="font-family:monospace">offset</span> are corresponding elements of the
annotation’s arguments).
</dd><dt class="dt-description"><a href="../api/org/checkerframework/checker/index/qual/SubstringIndexBottom.html"><span style="font-weight:bold"><span style="font-family:monospace">@SubstringIndexBottom</span></span></a></dt><dd class="dd-description">
This is the bottom type, and programmers should rarely need to write it.
</dd><dt class="dt-description"><a href="../api/org/checkerframework/checker/index/qual/SubstringIndexUnknown.html"><span style="font-weight:bold"><span style="font-family:monospace">@SubstringIndexUnknown</span></span></a></dt><dd class="dd-description">
No information is known about whether this integer is a substring index.
This is the top type, and programmers should rarely need to write it.
</dd></dl>
<!--TOC subsection id="index-substringindex-justification" The need for the <span style="font-family:monospace">@SubstringIndexFor</span> annotation-->
<h3 id="index-substringindex-justification" class="subsection">12.7.1 The need for the <span style="font-family:monospace">@SubstringIndexFor</span> annotation <a href="#index-substringindex-justification"><img src="chainlink.svg" width="10" height="10"></a></h3><!--SEC END --><p>No other annotation supported by the Index Checker precisely represents the
possible return values of methods
<a href="https://docs.oracle.com/en/java/javase/17/docs/api/java.base/java/lang/String.html#indexOf(java.lang.String)"><span style="font-family:monospace">String.indexOf</span></a>
and
<a href="https://docs.oracle.com/en/java/javase/17/docs/api/java.base/java/lang/String.html#lastIndexOf(java.lang.String)"><span style="font-family:monospace">String.lastIndexOf</span></a>.
The reason is the methods’ special cases for empty strings and for failed matches.</p><p>Consider the result <span style="font-family:monospace">i</span> of <span style="font-family:monospace">receiver.indexOf(substring)</span>:</p><ul class="itemize"><li class="li-itemize">
<span style="font-family:monospace">i</span> is <span style="font-family:monospace">@GTENegativeOne</span>, because <span style="font-family:monospace">i &gt;= -1</span>.
</li><li class="li-itemize"><span style="font-family:monospace">i</span> is <span style="font-family:monospace">@LTEqLengthOf("receiver")</span>, because <span style="font-family:monospace">i &lt;= receiver.length()</span>.
</li><li class="li-itemize"><span style="font-family:monospace">i</span> is not <span style="font-family:monospace">@IndexOrLow("receiver")</span>, because for
<span style="font-family:monospace">receiver = "", substring = "", i = 0</span>, the property
<span style="font-family:monospace">i &gt;= -1 &amp;&amp; i &lt; receiver.length()</span> does not hold.
</li><li class="li-itemize"><span style="font-family:monospace">i</span> is not <span style="font-family:monospace">@IndexOrHigh("receiver")</span>, because for
<span style="font-family:monospace">receiver = "", substring = "b", i = -1</span>, the property
<span style="font-family:monospace">i &gt;= 0 &amp;&amp; i &lt;= receiver.length()</span> does not hold.
</li><li class="li-itemize"><span style="font-family:monospace">i</span> is not
<span style="font-family:monospace">@LTLengthOf(value = "receiver", offset = "substring.length()-1")</span>,
because for <span style="font-family:monospace">receiver = "", substring = "abc", i = -1</span>, the property
<span style="font-family:monospace">i + substring.length() - 1 &lt; receiver.length()</span> does not hold.
</li></ul><p>The last annotation in the list above,
<span style="font-family:monospace">@LTLengthOf(value = "receiver", offset = "substring.length()-1")</span>,
is the correct and precise upper bound for all values of <span style="font-family:monospace">i</span> except -1.
The offset expresses the fact that we can add <span style="font-family:monospace">substring.length()</span> to this
index and still get a valid index for <span style="font-family:monospace">receiver</span>. That is useful for
type-checking code that adds the length of the substring to the found
index, in order to obtain the rest of the string. However, the upper bound
applies only after the index is explicitly checked not to be -1:</p><pre class="verbatim">  int i = receiver.indexOf(substring);
  // i is @GTENegativeOne and @LTEqLengthOf("receiver")
  // i is not @LTLengthOf(value = "receiver", offset = "substring.length()-1")
  if (i != -1) {
    // i is @NonNegative and @LTLengthOf(value = "receiver", offset = "substring.length()-1")
    int j = i + substring.length();
    // j is @IndexOrHigh("receiver")
    return receiver.substring(j); // this call is safe
  }
</pre><p>The property of the result of <span style="font-family:monospace">indexOf</span> cannot be expressed by any
combination of lower-bound (Section ‍<a href="#index-lowerbound">12.2</a>) and upper-bound
(Section ‍<a href="#index-upperbound">12.3</a>) annotations, because the upper-bound
annotations apply independently of the lower-bound annotations, but in this
case, the upper bound <span style="font-family:monospace">i &lt;= receiver.length() - substring.length()</span>
holds only if <span style="font-family:monospace">i &gt;= 0</span>. Therefore, to express this property and make
the example type-check without false positives, a new annotation such as
<span style="font-family:monospace">@SubstringIndexFor(value = "receiver", offset = "substring.length()-1")</span>
is necessary.</p>
<!--TOC section id="index-inequalities" Inequalities-->
<h2 id="index-inequalities" class="section">12.8 Inequalities <a href="#index-inequalities"><img src="chainlink.svg" width="10" height="10"></a></h2><!--SEC END --><p>The Index Checker estimates which expression’s values are less than other expressions’ values.</p><dl class="description"><dt class="dt-description"><a href="../api/org/checkerframework/checker/index/qual/LessThan.html"><span style="font-weight:bold"><span style="font-family:monospace">@LessThan</span></span></a><span style="font-weight:bold"><span style="font-family:monospace">(String[] values)</span></span></dt><dd class="dd-description">
An expression with this type has a value that is less than the value of each
expression listed in <span style="font-family:monospace">values</span>. The expressions in values must be composed of
final or effectively final variables and constants.</dd><dt class="dt-description"><a href="../api/org/checkerframework/checker/index/qual/LessThanUnknown.html"><span style="font-weight:bold"><span style="font-family:monospace">@LessThanUnknown</span></span></a></dt><dd class="dd-description">
There is no information about the value of an expression this type relative to other expressions.
This is the top type, and should not be written by the programmer.</dd><dt class="dt-description"><a href="../api/org/checkerframework/checker/index/qual/LessThanBottom.html"><span style="font-weight:bold"><span style="font-family:monospace">@LessThanBottom</span></span></a></dt><dd class="dd-description">
This is the bottom type for the less than type system. It should
never need to be written by the programmer.</dd></dl>
<!--TOC section id="index-annotating-fixed-size" Annotating fixed-size data structures-->
<h2 id="index-annotating-fixed-size" class="section">12.9 Annotating fixed-size data structures <a href="#index-annotating-fixed-size"><img src="chainlink.svg" width="10" height="10"></a></h2><!--SEC END --><p>The Index Checker has built-in support for Strings and arrays.
You can add support for additional fixed-size data structures by writing
annotations.
This allows the Index Checker to typecheck the data structure’s
implementation and to typecheck uses of the class.</p><p>This section gives an example: a fixed-length collection.</p><pre class="verbatim">/** ArrayWrapper is a fixed-size generic collection. */
public class ArrayWrapper&lt;T&gt; {
    private final Object @SameLen("this") [] delegate;

    @SuppressWarnings("index") // constructor creates object of size @SameLen(this) by definition
    ArrayWrapper(@NonNegative int size) {
        delegate = new Object[size];
    }

    public @LengthOf("this") int size() {
        return delegate.length;
    }

    public void set(@IndexFor("this") int index, T obj) {
        delegate[index] = obj;
    }

    @SuppressWarnings("unchecked") // required for normal Java compilation due to unchecked cast
    public T get(@IndexFor("this") int index) {
        return (T) delegate[index];
    }
}
</pre><p>The Index Checker treats methods annotated with <span style="font-family:monospace">@LengthOf("this")</span> as
the length of a sequence like <span style="font-family:monospace">arr.length</span> for arrays and
<span style="font-family:monospace">str.length()</span> for strings.</p><p>With these annotations, client code like the following typechecks with no
warnings:
</p><pre class="verbatim">    public static void clearIndex1(ArrayWrapper&lt;? extends Object&gt; a, @IndexFor("#1") int i) {
        a.set(i, null);
    }

    public static void clearIndex2(ArrayWrapper&lt;? extends Object&gt; a, int i) {
        if (0 &lt;= i &amp;&amp; i &lt; a.size()) {
            a.set(i, null);
        }
    }
</pre><hr>
<!--TOC chapter id="regex-checker" Regex Checker for regular expression syntax-->
<h1 id="regex-checker" class="chapter">Chapter ‍13 Regex Checker for regular expression syntax <a href="#regex-checker"><img src="chainlink.svg" width="10" height="10"></a></h1><!--SEC END --><p>The Regex Checker prevents, at compile-time, use of syntactically invalid
regular expressions and access of invalid capturing groups.</p><p>A regular expression, or regex, is a pattern for matching certain strings
of text. In Java, a programmer writes a regular expression as a string.
The syntax of regular expressions is complex, so it is easy to make a
mistake. It is also easy to accidentally use a regex feature from another
language that is not supported by Java (see section “Comparison to Perl
5” in the <a href="https://docs.oracle.com/en/java/javase/17/docs/api/java.base/java/util/regex/Pattern.html"><span style="font-family:monospace">Pattern</span></a> Javadoc).
These problems cause run-time errors.</p><p>Regular expressions in Java also have capturing groups, which
are delimited by parentheses and allow for extraction from text.
If a programmer uses an incorrect index (larger than the number of
capturing groups), an <span style="font-family:monospace">IndexOutOfBoundsException</span> is thrown.</p><p>The Regex Checker warns about these problems at compile time, guaranteeing
that your program does not crash due to incorrect use of regular expressions.</p><p>For further details, including case studies, see the paper “A type system
for regular expressions” ‍[<a href="#SpishakDE2012">SDE12</a>] (FTfJP 2012,
<a href="https://homes.cs.washington.edu/~mernst/pubs/regex-types-ftfjp2012-abstract.html"><span style="font-family:monospace">https://homes.cs.washington.edu/~mernst/pubs/regex-types-ftfjp2012-abstract.html</span></a>).</p><p>To run the Regex Checker, supply the
<span style="font-family:monospace">-processor org.checkerframework.checker.regex.RegexChecker</span>
command-line option to javac.</p>
<!--TOC section id="regex-annotations" Regex annotations-->
<h2 id="regex-annotations" class="section">13.1 Regex annotations <a href="#regex-annotations"><img src="chainlink.svg" width="10" height="10"></a></h2><!--SEC END --><p>These qualifiers make up the Regex type system:</p><dl class="description"><dt class="dt-description"><a href="../api/org/checkerframework/checker/regex/qual/Regex.html"><span style="font-weight:bold"><span style="font-family:monospace">@Regex</span></span></a></dt><dd class="dd-description">
indicates that the run-time value is a valid regular expression
<span style="font-family:monospace">String</span>. If the optional parameter is supplied to the qualifier,
then the number of capturing groups in the regular expression is at least
that many. If not provided, the parameter defaults to 0.
For example, if an expression’s type is <span style="font-family:monospace">@Regex(1) String</span>, then its
run-time value could be <span style="font-family:monospace">"colo(u?)r"</span> or <span style="font-family:monospace">"(brown|beige)"</span> but not
<span style="font-family:monospace">"colou?r"</span> nor a non-regex string such as <span style="font-family:monospace">"1) first point"</span>.</dd><dt class="dt-description"><a href="../api/org/checkerframework/checker/regex/qual/PolyRegex.html"><span style="font-weight:bold"><span style="font-family:monospace">@PolyRegex</span></span></a></dt><dd class="dd-description">
indicates qualifier polymorphism.
For a description of qualifier polymorphism, see
Section ‍<a href="#method-qualifier-polymorphism">30.2</a>.</dd></dl><p>The subtyping hierarchy of the Regex Checker’s qualifiers is shown in
Figure ‍<a href="#fig-regex-hierarchy">13.1</a>.</p><blockquote class="figure"><div class="center"><hr class="floatrule"></div>
<div class="center">
<img src="regex.svg">
</div>
<div class="caption"><table style="border-spacing:6px;border-collapse:separate;" class="cellpading0"><tr><td style="vertical-align:top;text-align:left;" >Figure 13.1: The subtyping relationship of the Regex Checker’s qualifiers.
The type qualifiers are applicable to <span style="font-family:monospace">CharSequence</span> and its subtypes.
Because the parameter to a <span style="font-family:monospace">@Regex</span> qualifier is at least the number of
capturing groups in a regular expression, a <span style="font-family:monospace">@Regex</span> qualifier with more
capturing groups is a subtype of a <span style="font-family:monospace">@Regex</span> qualifier with fewer capturing
groups. Qualifiers in gray are used internally by the type
system but should never be written by a programmer.</td></tr>
</table></div>
<a id="fig-regex-hierarchy"></a>
<div class="center"><hr class="floatrule"></div></blockquote>
<!--TOC section id="annotating-with-regex" Annotating your code with <span style="font-family:monospace">@Regex</span>-->
<h2 id="annotating-with-regex" class="section">13.2 Annotating your code with <span style="font-family:monospace">@Regex</span> <a href="#annotating-with-regex"><img src="chainlink.svg" width="10" height="10"></a></h2><!--SEC END -->
<!--TOC subsection id="regex-implicit-qualifiers" Implicit qualifiers-->
<h3 id="regex-implicit-qualifiers" class="subsection">13.2.1 Implicit qualifiers <a href="#regex-implicit-qualifiers"><img src="chainlink.svg" width="10" height="10"></a></h3><!--SEC END --><p>The Regex Checker adds
implicit qualifiers, reducing the number of annotations that must appear
in your code (see Section ‍<a href="#effective-qualifier">31.4</a>).
If a <span style="font-family:monospace">String</span> literal is a valid regex,
the checker implicitly adds the <span style="font-family:monospace">@Regex</span> qualifier with
the argument set to the correct number of capturing groups.
The Regex Checker allows
the <span style="font-family:monospace">null</span> literal to be assigned to any type qualified with the
<span style="font-family:monospace">Regex</span> qualifier.</p>
<!--TOC subsection id="regex-capturing-groups" Capturing groups-->
<h3 id="regex-capturing-groups" class="subsection">13.2.2 Capturing groups <a href="#regex-capturing-groups"><img src="chainlink.svg" width="10" height="10"></a></h3><!--SEC END --><p>The Regex Checker validates that a legal capturing group number is passed
to <a href="https://docs.oracle.com/en/java/javase/17/docs/api/java.base/java/util/regex/Matcher.html"><span style="font-family:monospace">Matcher</span></a>’s
<a href="https://docs.oracle.com/en/java/javase/17/docs/api/java.base/java/util/regex/Matcher.html#group(int)"><span style="font-family:monospace">group</span></a>,
<a href="https://docs.oracle.com/en/java/javase/17/docs/api/java.base/java/util/regex/Matcher.html#start(int)"><span style="font-family:monospace">start</span></a> and
<a href="https://docs.oracle.com/en/java/javase/17/docs/api/java.base/java/util/regex/Matcher.html#end(int)"><span style="font-family:monospace">end</span></a> methods. To do this,
the type of <span style="font-family:monospace">Matcher</span> must be qualified with a <span style="font-family:monospace">@Regex</span> annotation
with the number of capturing groups in the regular expression. This is
handled implicitly by the Regex Checker for local variables (see
Section ‍<a href="#type-refinement">31.7</a>), but you may need to add <span style="font-family:monospace">@Regex</span> annotations
with a capturing group count to <span style="font-family:monospace">Pattern</span> and <span style="font-family:monospace">Matcher</span> fields and
parameters.</p>
<!--TOC subsection id="regex-partial-regex" Concatenation of partial regular expressions-->
<h3 id="regex-partial-regex" class="subsection">13.2.3 Concatenation of partial regular expressions <a href="#regex-partial-regex"><img src="chainlink.svg" width="10" height="10"></a></h3><!--SEC END --><blockquote class="figure"><div class="center"><hr class="floatrule"></div>
<pre class="verbatim">public @Regex String parenthesize(@Regex String regex) {
    return "(" + regex + ")"; // Even though the parentheses are not @Regex Strings,
                              // the whole expression is a @Regex String
}
</pre>
<div class="caption"><table style="border-spacing:6px;border-collapse:separate;" class="cellpading0"><tr><td style="vertical-align:top;text-align:left;" >Figure 13.2: An example of the Regex Checker’s support for concatenation
of non-regular-expression Strings to produce valid regular expression Strings.</td></tr>
</table></div>
<a id="fig-regex-partial"></a>
<div class="center"><hr class="floatrule"></div></blockquote><p>In general, concatenating a non-regular-expression String with any other
string yields a non-regular-expression String. The Regex Checker can
sometimes determine that concatenation of non-regular-expression Strings
will produce valid regular expression Strings. For an example see
Figure ‍<a href="#fig-regex-partial">13.2</a>.</p>
<!--TOC subsection id="regexutil-methods" Testing whether a string is a regular expression-->
<h3 id="regexutil-methods" class="subsection">13.2.4 Testing whether a string is a regular expression <a href="#regexutil-methods"><img src="chainlink.svg" width="10" height="10"></a></h3><!--SEC END --><p>Sometimes, the Regex Checker cannot infer whether a particular expression
is a regular expression — and sometimes your code cannot either! In
these cases, you can use the <span style="font-family:monospace">isRegex</span> method to perform such a test, and
other helper methods to provide useful error messages. A
common use is for user-provided regular expressions (such as ones passed
on the command-line).
Figure ‍<a href="#fig-regex-util-example">13.3</a> gives an
example of the intended use of the <span style="font-family:monospace">RegexUtil</span> methods.</p><dl class="description"><dt class="dt-description"><a href="../api/org/checkerframework/checker/regex/util/RegexUtil.html#isRegex(java.lang.String)"><span style="font-weight:bold"><span style="font-family:monospace">RegexUtil.isRegex</span></span></a></dt><dd class="dd-description">
returns <span style="font-family:monospace">true</span> if its argument is a valid regular expression.</dd><dt class="dt-description"><a href="../api/org/checkerframework/checker/regex/util/RegexUtil.html#regexError(java.lang.String)"><span style="font-weight:bold"><span style="font-family:monospace">RegexUtil.regexError</span></span></a></dt><dd class="dd-description">
returns a <span style="font-family:monospace">String</span> error message if its argument is not a valid regular
expression, or <span style="font-family:monospace">null</span> if its argument is a valid regular expression.</dd><dt class="dt-description"><a href="../api/org/checkerframework/checker/regex/util/RegexUtil.html#regexException(java.lang.String)"><span style="font-weight:bold"><span style="font-family:monospace">RegexUtil.regexException</span></span></a></dt><dd class="dd-description">
returns the
<a href="https://docs.oracle.com/en/java/javase/17/docs/api/java.base/java/util/regex/PatternSyntaxException.html"><span style="font-family:monospace">Pattern&#173;Syntax&#173;Exception</span></a>
that <a href="https://docs.oracle.com/en/java/javase/17/docs/api/java.base/java/util/regex/Pattern.html#compile(java.lang.String)"><span style="font-family:monospace">Pattern.compile(String)</span></a>
throws when compiling an invalid regular expression. It returns <span style="font-family:monospace">null</span>
if its argument is a valid regular expression.</dd></dl><p>An additional version of each of these methods is also provided that takes
an additional group count parameter. The
<a href="../api/org/checkerframework/checker/regex/util/RegexUtil.html#isRegex(java.lang.String,int)"><span style="font-family:monospace">RegexUtil.isRegex</span></a> method
verifies that the argument has at least the given number of groups. The
<a href="../api/org/checkerframework/checker/regex/util/RegexUtil.html#regexError(java.lang.String,int)"><span style="font-family:monospace">RegexUtil.regexError</span></a> and
<a href="../api/org/checkerframework/checker/regex/util/RegexUtil.html#regexException(java.lang.String,int)"><span style="font-family:monospace">RegexUtil.regexException</span></a>
methods return a <span style="font-family:monospace">String</span> error message and <span style="font-family:monospace">Pattern&#173;Syntax&#173;Exception</span>,
respectively, detailing why the given String is not a syntactically valid
regular expression with at least the given number of capturing groups.</p><p>
If you detect that a <span style="font-family:monospace">String</span> is not a valid regular expression but would like
to report the error higher up the call stack (potentially where you can
provide a more detailed error message) you can throw a
<a href="../api/org/checkerframework/checker/regex/util/RegexUtil.CheckedPatternSyntaxException.html"><span style="font-family:monospace">RegexUtil.CheckedPatternSyntaxException</span></a>. This exception is
functionally the same as a
<a href="https://docs.oracle.com/en/java/javase/17/docs/api/java.base/java/util/regex/PatternSyntaxException.html"><span style="font-family:monospace">Pattern&#173;Syntax&#173;Exception</span></a>
except it is checked to guarantee that the error will be handled up the
call stack. For more details, see the Javadoc for
<a href="../api/org/checkerframework/checker/regex/util/RegexUtil.CheckedPatternSyntaxException.html"><span style="font-family:monospace">RegexUtil.CheckedPatternSyntaxException</span></a>.
</p><p>To use the <span style="font-family:monospace">RegexUtil</span> class, the <span style="font-family:monospace">checker-util.jar</span> file
must be on the classpath at run time.</p><blockquote class="figure"><div class="center"><hr class="floatrule"></div>
<pre class="verbatim">String regex = getRegexFromUser();
if (! RegexUtil.isRegex(regex)) {
   throw new RuntimeException("Error parsing regex " + regex, RegexUtil.regexException(regex));
}
Pattern p = Pattern.compile(regex);
</pre>
<div class="caption"><table style="border-spacing:6px;border-collapse:separate;" class="cellpading0"><tr><td style="vertical-align:top;text-align:left;" >Figure 13.3: Example use of <span style="font-family:monospace">RegexUtil</span> methods.</td></tr>
</table></div>
<a id="fig-regex-util-example"></a>
<div class="center"><hr class="floatrule"></div></blockquote>
<!--TOC subsection id="regex-suppressing-warnings" Suppressing warnings-->
<h3 id="regex-suppressing-warnings" class="subsection">13.2.5 Suppressing warnings <a href="#regex-suppressing-warnings"><img src="chainlink.svg" width="10" height="10"></a></h3><!--SEC END --><p>If you are positive that a particular string that is being used as a
regular expression is syntactically valid, but the Regex Checker cannot
conclude this and issues a warning about possible use of an invalid regular
expression, then you can use the
<a href="../api/org/checkerframework/checker/regex/util/RegexUtil.html#asRegex(java.lang.String)"><span style="font-family:monospace">RegexUtil.asRegex</span></a> method to suppress the
warning.</p><p>You can think of this method
as a cast: it returns its argument unchanged, but with the type
<span style="font-family:monospace">@Regex String</span> if it is a valid regular expression. It throws an
error if its argument is not a valid regular expression, but you should
only use it when you are sure it will not throw an error.</p><p>There is an additional <a href="../api/org/checkerframework/checker/regex/util/RegexUtil.html#asRegex(java.lang.String,int)"><span style="font-family:monospace">RegexUtil.asRegex</span></a>
method that takes a capturing group parameter. This method works the same as
described above, but returns a <span style="font-family:monospace">@Regex String</span> with the parameter on the
annotation set to the value of the capturing group parameter passed to the method.</p><p>The use case shown in Figure ‍<a href="#fig-regex-util-example">13.3</a> should support most cases
so the <span style="font-family:monospace">asRegex</span> method should be used rarely.</p><hr>
<!--TOC chapter id="formatter-checker" Format String Checker-->
<h1 id="formatter-checker" class="chapter">Chapter ‍14 Format String Checker <a href="#formatter-checker"><img src="chainlink.svg" width="10" height="10"></a></h1><!--SEC END --><p>
The Format String Checker
prevents use of incorrect format strings
in format methods such as
<a href="https://docs.oracle.com/en/java/javase/17/docs/api/java.base/java/io/PrintStream.html#printf(java.lang.String,java.lang.Object...)"><span style="font-family:monospace">System.out.printf</span></a>
and <a href="https://docs.oracle.com/en/java/javase/17/docs/api/java.base/java/lang/String.html#format(java.lang.String,java.lang.Object...)"><span style="font-family:monospace">String.format</span></a>.
</p><p>The Format String Checker warns you if you write an invalid format string,
and it warns you if the other arguments are not consistent with the format
string (in number of arguments or in their types).
Here are examples of errors that the
Format String Checker
detects at compile time.
Section ‍<a href="#formatter-guarantees">14.3</a> provides more details.</p><pre class="verbatim">  String.format("%y", 7);           // error: invalid format string

  String.format("%d", "a string");  // error: invalid argument type for %d

  String.format("%d %s", 7);        // error: missing argument for %s
  String.format("%d", 7, 3);        // warning: unused argument 3
  String.format("{0}", 7);          // warning: unused argument 7, because {0} is wrong syntax
</pre><p>
To run the Format String Checker, supply the
<span style="font-family:monospace">-processor org.checkerframework.checker.formatter.FormatterChecker</span> command-line option to javac.
</p><p>The paper “A type system for format strings” ‍[<a href="#WeitzKSE2014">WKSE14</a>] (ISSTA
2014,
<a href="https://homes.cs.washington.edu/~mernst/pubs/format-string-issta2014-abstract.html"><span style="font-family:monospace">https://homes.cs.washington.edu/~mernst/pubs/format-string-issta2014-abstract.html</span></a>)
gives more details about the Format String Checker and the Internationalization Format
String Checker (Chapter ‍<a href="#i18n-formatter-checker">15</a>);</p>
<!--TOC section id="formatter-terminology" Formatting terminology-->
<h2 id="formatter-terminology" class="section">14.1 Formatting terminology <a href="#formatter-terminology"><img src="chainlink.svg" width="10" height="10"></a></h2><!--SEC END --><p>Printf-style formatting takes as an argument a <em>format string</em> and a
list of arguments. It produces a new string in which each <em>format
specifier</em> has been replaced by the corresponding argument.
The format specifier determines how the format argument is converted to a
string.
A format specifier is introduced by a <span style="font-family:monospace">%</span> character. For example,
<span style="font-family:monospace">String.format("The %s is %d.","answer",42)</span> yields
<span style="font-family:monospace">"The answer is 42."</span>. <span style="font-family:monospace">"The %s is %d."</span> is
the format string, <span style="font-family:monospace">"%s"</span> and <span style="font-family:monospace">"%d"</span> are the format specifiers;
<span style="font-family:monospace">"answer"</span> and <span style="font-family:monospace">42</span> are format arguments.</p>
<!--TOC section id="formatter-annotations" Format String Checker annotations-->
<h2 id="formatter-annotations" class="section">14.2 Format String Checker annotations <a href="#formatter-annotations"><img src="chainlink.svg" width="10" height="10"></a></h2><!--SEC END --><p>The <a href="../api/org/checkerframework/checker/formatter/qual/Format.html"><span style="font-family:monospace">@Format</span></a> qualifier on a string type
indicates a
<a href="https://docs.oracle.com/en/java/javase/17/docs/api/java.base/java/util/Formatter.html#syntax">valid format string</a>.
A programmer rarely writes the <span style="font-family:monospace">@Format</span> annotation, as it is inferred for
string literals. A programmer may need to write it on fields and on method
signatures.</p><p>The <a href="../api/org/checkerframework/checker/formatter/qual/Format.html"><span style="font-family:monospace">@Format</span></a> qualifier is parameterized with
a list of conversion categories that impose restrictions on the format arguments.
Conversion categories are explained in more detail in
Section ‍<a href="#formatter-categories">14.2.1</a>. The type qualifier for <span style="font-family:monospace">"%d %f"</span> is
for example <span style="font-family:monospace">@Format({INT, FLOAT})</span>.</p><p>Consider the below <span style="font-family:monospace">printFloatAndInt</span> method. Its parameter must be a
format string that can be used in a format method, where the first format
argument is “float-like” and the second format argument is
“integer-like”. The type of its parameter, <span style="font-family:monospace">@Format({FLOAT, INT})
String</span>, expresses that contract.</p><pre class="verbatim">    void printFloatAndInt(@Format({FLOAT, INT}) String fs) {
        System.out.printf(fs, 3.1415, 42);
    }

    printFloatAndInt("Float %f, Number %d");  // OK
    printFloatAndInt("Float %f");             // error
</pre><blockquote class="figure"><div class="center"><hr class="floatrule"></div>
<div class="center">
<img src="formatter-hierarchy.svg">
</div>
<div class="caption"><table style="border-spacing:6px;border-collapse:separate;" class="cellpading0"><tr><td style="vertical-align:top;text-align:left;" >Figure 14.1: The
Format String Checker type qualifier hierarchy.
The type qualifiers are applicable to <span style="font-family:monospace">CharSequence</span> and its subtypes.
The figure does not show the subtyping rules among different
<span style="font-family:monospace">@Format(...)</span>
qualifiers; see
Section ‍<a href="#formatter-format-subtyping">14.2.2</a>.
</td></tr>
</table></div>
<a id="fig-formatter-hierarchy"></a>
<div class="center"><hr class="floatrule"></div></blockquote><p>Figure ‍<a href="#fig-formatter-hierarchy">14.1</a> shows all the type qualifiers.
The annotations other than <span style="font-family:monospace">@Format</span> are only used
internally and cannot be written in your code.
<a href="../api/org/checkerframework/checker/formatter/qual/InvalidFormat.html"><span style="font-family:monospace">@InvalidFormat</span></a> indicates an invalid format
string — that is, a string that cannot be used as a format string. For
example, the type of <span style="font-family:monospace">"%y"</span> is <span style="font-family:monospace">@InvalidFormat String</span>.
<a href="../api/org/checkerframework/checker/formatter/qual/FormatBottom.html"><span style="font-family:monospace">@FormatBottom</span></a> is the type of the
<span style="font-family:monospace">null</span> literal.
<a href="../api/org/checkerframework/checker/formatter/qual/UnknownFormat.html"><span style="font-family:monospace">@UnknownFormat</span></a> is the default that is
applied to strings that are not literals and on which the user has not
written a <span style="font-family:monospace">@Format</span> annotation.</p><p>There is also a <a href="../api/org/checkerframework/checker/formatter/qual/FormatMethod.html"><span style="font-family:monospace">@FormatMethod</span></a>
annotation; see Section ‍<a href="#formatter-FormatMethod">14.5</a>.</p>
<!--TOC subsection id="formatter-categories" Conversion Categories-->
<h3 id="formatter-categories" class="subsection">14.2.1 Conversion Categories <a href="#formatter-categories"><img src="chainlink.svg" width="10" height="10"></a></h3><!--SEC END --><p>Given a format specifier, only certain format arguments are compatible with
it, depending on its “conversion” — its last, or last two,
characters. For example, in the format specifier <span style="font-family:monospace">"%d"</span>, the
conversion <span style="font-family:monospace">d</span> restricts the corresponding format argument
to be “integer-like”:</p><pre class="verbatim">    String.format("%d", 5);         // OK
    String.format("%d", "hello");   // error
</pre><p>Many conversions enforce the same restrictions. A set of
restrictions is represented as a <em>conversion
category</em>. The “integer like” restriction is for example the conversion
category <a href="../api/org/checkerframework/checker/formatter/qual/ConversionCategory.html#INT"><span style="font-family:monospace">INT</span></a>. The following conversion categories are defined in the
<a href="../api/org/checkerframework/checker/formatter/qual/ConversionCategory.html"><span style="font-family:monospace">ConversionCategory</span></a> enumeration:</p><dl class="description"><dt class="dt-description">
</dt><dd class="dd-description"><a href="../api/org/checkerframework/checker/formatter/qual/ConversionCategory.html#GENERAL"><span style="font-family:monospace">GENERAL</span></a> imposes no restrictions on a format argument’s type. Applicable for
conversions b, B, h, H, s, S.</dd><dt class="dt-description"></dt><dd class="dd-description"><a href="../api/org/checkerframework/checker/formatter/qual/ConversionCategory.html#CHAR"><span style="font-family:monospace">CHAR</span></a> requires that a format argument represents a Unicode character.
Specifically, <span style="font-family:monospace">char</span>, <span style="font-family:monospace">Character</span>, <span style="font-family:monospace">byte</span>,
<span style="font-family:monospace">Byte</span>, <span style="font-family:monospace">short</span>, and <span style="font-family:monospace">Short</span> are allowed.
<span style="font-family:monospace">int</span> or <span style="font-family:monospace">Integer</span> are allowed if
<span style="font-family:monospace">Character.isValidCodePoint(argument)</span> would return <span style="font-family:monospace">true</span>
for the format argument. (The Format String Checker permits any <span style="font-family:monospace">int</span>
or <span style="font-family:monospace">Integer</span> without issuing a warning or error — see
Section ‍<a href="#formatter-missed-alarms">14.3.2</a>.)
Applicable for conversions c, C.</dd><dt class="dt-description"></dt><dd class="dd-description"><a href="../api/org/checkerframework/checker/formatter/qual/ConversionCategory.html#INT"><span style="font-family:monospace">INT</span></a> requires that a format argument represents an integral type. Specifically,
<span style="font-family:monospace">byte</span>, <span style="font-family:monospace">Byte</span>, <span style="font-family:monospace">short</span>, <span style="font-family:monospace">Short</span>,
<span style="font-family:monospace">int</span> and <span style="font-family:monospace">Integer</span>, <span style="font-family:monospace">long</span>,
<span style="font-family:monospace">Long</span>, and <span style="font-family:monospace">BigInteger</span> are allowed. Applicable for
conversions d, o, x, X.</dd><dt class="dt-description"></dt><dd class="dd-description"><a href="../api/org/checkerframework/checker/formatter/qual/ConversionCategory.html#FLOAT"><span style="font-family:monospace">FLOAT</span></a> requires that a format argument represents a floating-point type. Specifically,
<span style="font-family:monospace">float</span>, <span style="font-family:monospace">Float</span>, <span style="font-family:monospace">double</span>,
<span style="font-family:monospace">Double</span>, and <span style="font-family:monospace">BigDecimal</span> are allowed. Surprisingly, integer
values are not allowed. Applicable for
conversions e, E, f, g, G, a, A.</dd><dt class="dt-description"></dt><dd class="dd-description"><a href="../api/org/checkerframework/checker/formatter/qual/ConversionCategory.html#TIME"><span style="font-family:monospace">TIME</span></a> requires that a format argument represents a date or time.
Specifically, <span style="font-family:monospace">long</span>, <span style="font-family:monospace">Long</span>, <span style="font-family:monospace">Calendar</span>, and
<span style="font-family:monospace">Date</span> are allowed. Applicable for conversions t, T.</dd><dt class="dt-description"></dt><dd class="dd-description"><a href="../api/org/checkerframework/checker/formatter/qual/ConversionCategory.html#UNUSED"><span style="font-family:monospace">UNUSED</span></a> imposes no restrictions on a format argument. This is the case if a
format argument is not used as replacement for any format specifier.
<span style="font-family:monospace">"%2$s"</span> for example ignores the first format argument.
</dd></dl><p>All conversion categories accept <span style="font-family:monospace">null</span>.
Furthermore, <span style="font-family:monospace">null</span> is always a legal argument array, because it is treated
as supplying <span style="font-family:monospace">null</span> to each format specifer. For example,
<span style="font-family:monospace">String.format("%d %f %s", (Object[]) null)</span> evaluates to <span style="font-family:monospace">"null null null"</span>.</p><p>The same format argument may serve as a replacement for multiple format specifiers.
Until now, we have assumed that the format specifiers simply consume format arguments left to right.
But there are two other ways for a format specifier to select a format argument:</p><ul class="itemize"><li class="li-itemize">
<span style="font-style:italic">n</span><span style="font-family:monospace">$</span> specifies a one-based index <span style="font-style:italic">n</span>. In the
format string <span style="font-family:monospace">"%2$s"</span>, the format specifier selects the
second format argument.
</li><li class="li-itemize">The <span style="font-family:monospace">&lt;</span> <em>flag</em> references the format argument
that was used by the previous format specifier. In the format string
<span style="font-family:monospace">"%d %&lt;d"</span> for example, both format specifiers select the first
format argument.
</li></ul><p>In the following example,
the format argument must be compatible with both conversion
categories, and can therefore be neither a <span style="font-family:monospace">Character</span> nor a <span style="font-family:monospace">long</span>.</p><pre class="verbatim">    format("Char %1$c, Int %1$d", (int)42);            // OK
    format("Char %1$c, Int %1$d", new Character(42));  // error
    format("Char %1$c, Int %1$d", (long)42);           // error
</pre><p>Only three additional conversion categories are needed represent all possible
intersections of previously-mentioned conversion categories:</p><dl class="description"><dt class="dt-description">
</dt><dd class="dd-description"><a href="../api/org/checkerframework/checker/formatter/qual/ConversionCategory.html#NULL"><span style="font-family:monospace">NULL</span></a> is used if no object of any type can be
passed as parameter. In this case, the only legal value is <span style="font-family:monospace">null</span>.
For example, the format string <span style="font-family:monospace">"%1$f %1$c"</span> requires that the first
format argument be <span style="font-family:monospace">null</span>. Passing either <span style="font-family:monospace">4</span> or
<span style="font-family:monospace">4.2</span> would lead to an exception.
</dd><dt class="dt-description"></dt><dd class="dd-description"><a href="../api/org/checkerframework/checker/formatter/qual/ConversionCategory.html#CHAR_AND_INT"><span style="font-family:monospace">CHAR_AND_INT</span></a> is used if a format argument is restricted by a <a href="../api/org/checkerframework/checker/formatter/qual/ConversionCategory.html#CHAR"><span style="font-family:monospace">CHAR</span></a> and a <a href="../api/org/checkerframework/checker/formatter/qual/ConversionCategory.html#INT"><span style="font-family:monospace">INT</span></a> conversion category (<span style="font-family:monospace">CHAR</span> ∩ <span style="font-family:monospace">INT</span>).
</dd><dt class="dt-description"></dt><dd class="dd-description"><a href="../api/org/checkerframework/checker/formatter/qual/ConversionCategory.html#INT_AND_TIME"><span style="font-family:monospace">INT_AND_TIME</span></a> is used if a format argument is restricted by an <a href="../api/org/checkerframework/checker/formatter/qual/ConversionCategory.html#INT"><span style="font-family:monospace">INT</span></a> and a <a href="../api/org/checkerframework/checker/formatter/qual/ConversionCategory.html#TIME"><span style="font-family:monospace">TIME</span></a> conversion category (<span style="font-family:monospace">INT</span> ∩ <span style="font-family:monospace">TIME</span>).
</dd></dl><p>All other intersections lead to already existing conversion categories.
For example, <span style="font-family:monospace">GENERAL</span> ∩ <span style="font-family:monospace">CHAR</span> = <span style="font-family:monospace">CHAR</span> and
<span style="font-family:monospace">UNUSED</span> ∩ <span style="font-family:monospace">GENERAL</span> = <span style="font-family:monospace">GENERAL</span>.</p><p>Figure ‍<a href="#fig-formatter-cat">14.2</a> summarizes the subset
relationship among all conversion categories.</p><blockquote class="figure"><div class="center"><hr class="floatrule"></div>
<div class="center">
<img src="formatter-categories.svg">
</div>
<div class="caption"><table style="border-spacing:6px;border-collapse:separate;" class="cellpading0"><tr><td style="vertical-align:top;text-align:left;" >Figure 14.2: The subset relationship
among conversion categories.</td></tr>
</table></div>
<a id="fig-formatter-cat"></a>
<div class="center"><hr class="floatrule"></div></blockquote>
<!--TOC subsection id="formatter-format-subtyping" Subtyping rules for <span style="font-family:monospace">@Format</span>-->
<h3 id="formatter-format-subtyping" class="subsection">14.2.2 Subtyping rules for <span style="font-family:monospace">@Format</span> <a href="#formatter-format-subtyping"><img src="chainlink.svg" width="10" height="10"></a></h3><!--SEC END --><p>Here are the subtyping rules among different
<a href="../api/org/checkerframework/checker/formatter/qual/Format.html"><span style="font-family:monospace">@Format</span></a>
qualifiers.
It is legal to:</p><ul class="itemize"><li class="li-itemize">
use a format string with a weaker (less restrictive) conversion category than required.
</li><li class="li-itemize">use a format string with fewer format specifiers than required.
Although this is legal a warning is issued because most occurrences of
this are due to programmer error.
</li></ul><p>The following example shows the subtyping rules in action:</p><pre class="verbatim">    @Format({FLOAT, INT}) String f;

    f = "%f %d";       // OK
    f = "%s %d";       // OK, %s is weaker than %f
    f = "%f";          // warning: last argument is ignored
    f = "%f %d %s";    // error: too many arguments
    f = "%d %d";       // error: %d is not weaker than %f

    String.format(f, 0.8, 42);
</pre>
<!--TOC section id="formatter-guarantees" What the Format String Checker checks-->
<h2 id="formatter-guarantees" class="section">14.3 What the Format String Checker checks <a href="#formatter-guarantees"><img src="chainlink.svg" width="10" height="10"></a></h2><!--SEC END --><p>If the Format String Checker issues no errors, it provides the following guarantees:</p><ol class="enumerate" type=1><li class="li-enumerate">
The following guarantees hold for every format method invocation:<ol class="enumerate" type=a><li class="li-enumerate">
The format method’s first parameter (or second if a <a href="https://docs.oracle.com/en/java/javase/17/docs/api/java.base/java/util/Locale.html"><span style="font-family:monospace">Locale</span></a> is provided) is a valid
format string (or <span style="font-family:monospace">null</span>).</li><li class="li-enumerate">A warning is issued if one of the format string’s conversion categories is <span style="font-family:monospace">UNUSED</span>.
<a id="formatter-unused-category-warning"></a>
</li><li class="li-enumerate">None of the format string’s conversion categories is <span style="font-family:monospace">NULL</span>.
<a id="formatter-null-category-error"></a>
</li></ol></li><li class="li-enumerate">If the format arguments are passed to the format method as varargs, the
Format String Checker guarantees the following additional properties:<ol class="enumerate" type=a><li class="li-enumerate">
No fewer format arguments are passed than required by the format string.
</li><li class="li-enumerate">A warning is issued if more format arguments are passed than required by the format string.
</li><li class="li-enumerate">Every format argument’s type satisfies its conversion category’s restrictions.
</li></ol></li><li class="li-enumerate">If the format arguments are passed to the format method as an array,
a warning is issued by the Format String Checker.
<a id="formatter-array-warning"></a>
</li></ol><p>Following are examples for every guarantee:</p><pre class="verbatim">    String.format("%d", 42);                      // OK
    String.format(Locale.GERMAN, "%d", 42);       // OK
    String.format(new Object());                  // error (1a)
    String.format("%y");                          // error (1a)
    String.format("%2$s", "unused", "used");      // warning (1b)
    String.format("%1$d %1$f", 5.5);              // error (1c)
    String.format("%1$d %1$f %d", null, 6);       // error (1c)
    String.format("%s");                          // error (2a)
    String.format("%s", "used", "ignored");       // warning (2b)
    String.format("%c",4.2);                      // error (2c)
    String.format("%c", (String)null);            // error (2c)
    String.format("%1$d %1$f", new Object[]{1});  // warning (3)
    String.format("%s", new Object[]{"hello"});   // warning (3)
</pre>
<!--TOC subsection id="formatter-false-alarms" Possible false alarms-->
<h3 id="formatter-false-alarms" class="subsection">14.3.1 Possible false alarms <a href="#formatter-false-alarms"><img src="chainlink.svg" width="10" height="10"></a></h3><!--SEC END --><p>There are three cases in which the Format String Checker may issue a
warning or error, even though the code cannot fail at run time.
(These are in addition to the general conservatism of a type system: code
may be correct because of application invariants that are not captured by
the type system.)
In each of these cases, you can rewrite the code, or you can manually check
it and write a <span style="font-family:monospace">@SuppressWarnings</span> annotation if you can reason that
the code is correct.</p><p>Case <a href="#formatter-unused-category-warning">1(b)</a>:
Unused format arguments. It is legal to provide more arguments than are
required by the format string; Java ignores the extras. However, this is
an uncommon case. In practice, a mismatch between the number of format
specifiers and the number of format arguments is usually an error.</p><p>Case <a href="#formatter-null-category-error">1(c)</a>:
Format arguments that can only be <span style="font-family:monospace">null</span>.
It is legal to write a format string that permits only null arguments and
throws an exception for any other argument. An example is
<span style="font-family:monospace">String.format("%1$d %1$f", null)</span>.
The Format String Checker forbids such a format string.
If you should ever need such a format string, simply replace the problematic
format specifier with <span style="font-family:monospace">"null"</span>. For example, you would replace the
call above by <span style="font-family:monospace">String.format("null null")</span>.</p><p>Case <a href="#formatter-array-warning">3</a>:
Array format arguments.
The Format String Checker performs no analysis of
arrays, only of varargs invocations. It is better style to use varargs
when possible.</p>
<!--TOC subsection id="formatter-missed-alarms" Possible missed alarms-->
<h3 id="formatter-missed-alarms" class="subsection">14.3.2 Possible missed alarms <a href="#formatter-missed-alarms"><img src="chainlink.svg" width="10" height="10"></a></h3><!--SEC END --><p>The Format String Checker helps prevent bugs by detecting, at compile time,
which invocations of format methods will fail. While the Format String Checker
finds most of these invocations, there are cases in which a format method call
will fail even though the Format String Checker issued neither errors nor
warnings. These cases are:</p><ol class="enumerate" type=1><li class="li-enumerate">
The format string is <span style="font-family:monospace">null</span>. Use the <a href="#nullness-checker">Nullness Checker</a> to prevent this.
</li><li class="li-enumerate">A format argument’s <span style="font-family:monospace">toString</span> method throws an exception.
</li><li class="li-enumerate">A format argument implements the <span style="font-family:monospace">Formattable</span> interface and throws an
exception in the <span style="font-family:monospace">formatTo</span> method.
</li><li class="li-enumerate">A format argument’s conversion category is <span style="font-family:monospace">CHAR</span> or <span style="font-family:monospace">CHAR_AND_INT</span>,
and the passed value is an <span style="font-family:monospace">int</span> or <span style="font-family:monospace">Integer</span>, and
<span style="font-family:monospace">Character.isValidCodePoint(argument)</span> returns <span style="font-family:monospace">false</span>.
</li></ol><p>The following examples illustrate these limitations:</p><pre class="verbatim">    class A {
        public String toString() {
            throw new Error();
        }
    }

    class B implements Formattable {
        public void formatTo(Formatter fmt, int f,
                int width, int precision) {
            throw new Error();
        }
    }

    // The checker issues no errors or warnings for the
    // following illegal invocations of format methods.
    String.format(null);          // NullPointerException (1)
    String.format("%s", new A()); // Error (2)
    String.format("%s", new B()); // Error (3)
    String.format("%c", (int)-1); // IllegalFormatCodePointException (4)
</pre>
<!--TOC section id="formatter-implicit" Implicit qualifiers-->
<h2 id="formatter-implicit" class="section">14.4 Implicit qualifiers <a href="#formatter-implicit"><img src="chainlink.svg" width="10" height="10"></a></h2><!--SEC END --><p>The Format String Checker adds implicit
qualifiers, reducing the number of annotations that must appear in your code
(see Section ‍<a href="#effective-qualifier">31.4</a>).
The checker implicitly adds the <span style="font-family:monospace">@Format</span> qualifier with the appropriate
conversion categories to any String literal that is a valid format string.</p>
<!--TOC section id="formatter-FormatMethod" @FormatMethod-->
<h2 id="formatter-FormatMethod" class="section">14.5 @FormatMethod <a href="#formatter-FormatMethod"><img src="chainlink.svg" width="10" height="10"></a></h2><!--SEC END --><p>Your project may contain methods that forward their arguments to a format method.
Consider for example the following <span style="font-family:monospace">log</span> method:</p><pre class="verbatim">@FormatMethod
void log(String format, Object... args) {
    if (enabled) {
        logfile.print(indent_str);
        logfile.printf(format , args);
    }
}
</pre><p>You should annotate such a method with the
<a href="../api/org/checkerframework/checker/formatter/qual/FormatMethod.html"><span style="font-family:monospace">@FormatMethod</span></a> annotation,
which indicates that the <span style="font-family:monospace">String</span> argument is a format string for the
remaining arguments.</p>
<!--TOC section id="formatter-run-time-tests" Testing whether a format string is valid-->
<h2 id="formatter-run-time-tests" class="section">14.6 Testing whether a format string is valid <a href="#formatter-run-time-tests"><img src="chainlink.svg" width="10" height="10"></a></h2><!--SEC END --><p>The Format String Checker automatically determines whether each <span style="font-family:monospace">String</span>
literal is a valid format string or not. When a string is computed or is
obtained from an external resource, then the string must be trusted or tested.</p><p>One way to test a string is to call the
<a href="../api/org/checkerframework/checker/formatter/util/FormatUtil.html#asFormat(java.lang.String,org.checkerframework.checker.formatter.qual.ConversionCategory...)"><span style="font-family:monospace">FormatUtil.asFormat</span></a>
method to check whether the format string is valid and its format
specifiers match certain conversion categories.
If this is not the case, <span style="font-family:monospace">asFormat</span> raises an exception. Your code should
catch this exception and handle it gracefully.</p><p>The following code examples may fail at run time, and therefore they do not
type check. The type-checking errors are indicated by comments.</p><pre class="verbatim">Scanner s = new Scanner(System.in);
String fs = s.next();
System.out.printf(fs, "hello", 1337);          // error: fs is not known to be a format string
</pre><pre class="verbatim">Scanner s = new Scanner(System.in);
@Format({GENERAL, INT}) String fs = s.next();  // error: fs is not known to have the given type
System.out.printf(fs, "hello", 1337);          // OK
</pre><p>The following variant does not throw a run-time error, and
therefore passes the type-checker:</p><pre class="verbatim">Scanner s = new Scanner(System.in);
String format = s.next()
try {
    format = FormatUtil.asFormat(format, GENERAL, INT);
} catch (IllegalFormatException e) {
    // Replace this by your own error handling.
    System.err.println("The user entered the following invalid format string: " + format);
    System.exit(2);
}
// fs is now known to be of type: @Format({GENERAL, INT}) String
System.out.printf(format, "hello", 1337);
</pre><p>To use the <a href="../api/org/checkerframework/checker/formatter/util/FormatUtil.html"><span style="font-family:monospace">FormatUtil</span></a> class, the <span style="font-family:monospace">checker-util.jar</span> file
must be on the classpath at run time.</p><hr>
<!--TOC chapter id="i18n-formatter-checker" Internationalization Format String Checker (I18n Format String Checker)-->
<h1 id="i18n-formatter-checker" class="chapter">Chapter ‍15 Internationalization Format String Checker (I18n Format String Checker) <a href="#i18n-formatter-checker"><img src="chainlink.svg" width="10" height="10"></a></h1><!--SEC END --><p>The Internationalization Format String Checker, or I18n Format String Checker,
prevents use of incorrect i18n format strings.</p><p>If the I18n Format String Checker issues no warnings or errors, then
<a href="https://docs.oracle.com/en/java/javase/17/docs/api/java.base/java/text/MessageFormat.html#format(java.lang.String,java.lang.Object...)"><span style="font-family:monospace">MessageFormat.format</span></a>
will raise no error at run time.
“I18n” is short for
“internationalization” because there are 18 characters between the “i” and
the “n”.</p><p>Here are the examples of errors that the
I18n Format Checker
detects at compile time.</p><pre class="verbatim">  // Warning: the second argument is missing.
  MessageFormat.format("{0} {1}", 3.1415);
  // String argument cannot be formatted as Time type.
  MessageFormat.format("{0, time}", "my string");
  // Invalid format string: unknown format type: thyme.
  MessageFormat.format("{0, thyme}", new Date());
  // Invalid format string: missing the right brace.
  MessageFormat.format("{0", new Date());
  // Invalid format string: the argument index is not an integer.
  MessageFormat.format("{0.2, time}", new Date());
  // Invalid format string: "#.#.#" subformat is invalid.
  MessageFormat.format("{0, number, #.#.#}", 3.1415);
</pre><p>For instructions on how to run the Internationalization Format String
Checker, see Section ‍<a href="#i18n-format-running">15.6</a>.</p><p>The Internationalization Checker or I18n Checker (Chapter ‍<a href="#i18n-checker">16.2</a>)
has a different purpose. It verifies that your code is properly
internationalized: any user-visible text should be obtained from a
localization resource and all keys exist in that resource.</p><p>The paper “A type system for format strings” ‍[<a href="#WeitzKSE2014">WKSE14</a>] (ISSTA
2014,
<a href="https://homes.cs.washington.edu/~mernst/pubs/format-string-issta2014-abstract.html"><span style="font-family:monospace">https://homes.cs.washington.edu/~mernst/pubs/format-string-issta2014-abstract.html</span></a>)
gives more details about the Internationalization Format String Checker and the Format
String Checker (Chapter ‍<a href="#formatter-checker">14</a>);</p>
<!--TOC section id="i18n-format-annotation" Internationalization Format String Checker annotations-->
<h2 id="i18n-format-annotation" class="section">15.1 Internationalization Format String Checker annotations <a href="#i18n-format-annotation"><img src="chainlink.svg" width="10" height="10"></a></h2><!--SEC END --><blockquote class="figure"><div class="center"><hr class="floatrule"></div>
<div class="center">
<img src="i18n-format-type-hierarchy.svg">
</div>
<div class="caption"><table style="border-spacing:6px;border-collapse:separate;" class="cellpading0"><tr><td style="vertical-align:top;text-align:left;" >Figure 15.1: The
Internationalization
Format String Checker type qualifier hierarchy.
The type qualifiers are applicable to <span style="font-family:monospace">CharSequence</span> and its subtypes.
The figure does not show the subtyping rules among different
<a href="../api/org/checkerframework/checker/i18nformatter/qual/I18nFormat.html"><span style="font-family:monospace">@I18nFormat</span></a><span style="font-family:monospace">(...)</span>
qualifiers; see
Section ‍<a href="#i18n-format-conversion-categories">15.2</a>.
All <a href="../api/org/checkerframework/checker/i18nformatter/qual/I18nFormatFor.html"><span style="font-family:monospace">@I18nFormatFor</span></a> annotations
are unrelated by subtyping, unless they are identical.
The qualifiers in gray are used internally by
the checker and should never be written by a programmer.
</td></tr>
</table></div>
<a id="i18n-format-type-hierarchy"></a>
<div class="center"><hr class="floatrule"></div></blockquote><p>The <a href="https://docs.oracle.com/en/java/javase/17/docs/api/java.base/java/text/MessageFormat.html"><span style="font-family:monospace">MessageFormat</span></a> documentation
specifies the syntax of the i18n format string.</p><p>These are the qualifiers that make up the I18n Format String type system.
Figure ‍<a href="#i18n-format-type-hierarchy">15.1</a> shows their subtyping relationships.</p><dl class="description"><dt class="dt-description"><a href="../api/org/checkerframework/checker/i18nformatter/qual/I18nFormat.html"><span style="font-weight:bold"><span style="font-family:monospace">@I18nFormat</span></span></a></dt><dd class="dd-description">
represents a valid i18n format string. For example,
<span style="font-family:monospace">@I18nFormat({GENERAL, NUMBER, UNUSED, DATE})</span> is a legal type for
<span style="font-family:monospace">"{0}{1, number} {3, date}"</span>, indicating that when the format
string is used,
the first argument should be of <span style="font-family:monospace">GENERAL</span> conversion category,
the second argument should be of <span style="font-family:monospace">NUMBER</span> conversion category, and so on.
Conversion categories such as <span style="font-family:monospace">GENERAL</span> are described in
Section ‍<a href="#i18n-format-conversion-categories">15.2</a>.</dd><dt class="dt-description"><a href="../api/org/checkerframework/checker/i18nformatter/qual/I18nFormatFor.html"><span style="font-weight:bold"><span style="font-family:monospace">@I18nFormatFor</span></span></a></dt><dd class="dd-description">
indicates that the qualified type is a valid i18n format string for use
with some array of values. For example,
<span style="font-family:monospace">@I18nFormatFor("#2")</span> indicates that the string can be used to
format the contents of the second parameter array.
The argument is a Java expression whose syntax
is explained in Section ‍<a href="#java-expressions-as-arguments">31.8</a>.
An example of its use is:<pre class="verbatim">  static void method(@I18nFormatFor("#2") String format, Object... args) {
    // the body may use the parameters like this:
    MessageFormat.format(format, args);
  }

  method("{0, number} {1}", 3.1415, "A string");  // OK
  // error: The string "hello" cannot be formatted as a Number.
  method("{0, number} {1}", "hello", "goodbye");
</pre></dd><dt class="dt-description"><a href="../api/org/checkerframework/checker/i18nformatter/qual/I18nInvalidFormat.html"><span style="font-weight:bold"><span style="font-family:monospace">@I18nInvalidFormat</span></span></a></dt><dd class="dd-description">
represents an invalid i18n format string. Programmers are not allowed to
write this annotation. It is only used internally by the type checker.</dd><dt class="dt-description"><a href="../api/org/checkerframework/checker/i18nformatter/qual/I18nUnknownFormat.html"><span style="font-weight:bold"><span style="font-family:monospace">@I18nUnknownFormat</span></span></a></dt><dd class="dd-description">
represents any string. The string might or might not be a valid i18n
format string. Programmers are not allowed to write this annotation.</dd><dt class="dt-description"><a href="../api/org/checkerframework/checker/i18nformatter/qual/I18nFormatBottom.html"><span style="font-weight:bold"><span style="font-family:monospace">@I18nFormatBottom</span></span></a></dt><dd class="dd-description">
indicates that the value is definitely <span style="font-family:monospace">null</span>. Programmers are not allowed
to write this annotation.
</dd></dl>
<!--TOC section id="i18n-format-conversion-categories" Conversion categories-->
<h2 id="i18n-format-conversion-categories" class="section">15.2 Conversion categories <a href="#i18n-format-conversion-categories"><img src="chainlink.svg" width="10" height="10"></a></h2><!--SEC END --><p>In a message string, the optional second element within the curly braces is
called a <em>format type</em> and must be one of <span style="font-family:monospace">number</span>, <span style="font-family:monospace">date</span>,
<span style="font-family:monospace">time</span>, and <span style="font-family:monospace">choice</span>. These four format types correspond to different
conversion categories. <span style="font-family:monospace">date</span> and <span style="font-family:monospace">time</span> correspond to <em>DATE</em> in the
conversion categories figure. <span style="font-family:monospace">choice</span> corresponds to <em>NUMBER</em>.
The format type restricts what arguments are legal.
For example, a date argument is not compatible with
the <span style="font-family:monospace">number</span> format type, i.e., <span style="font-family:monospace">MessageFormat.format("{0, number}",
new Date())</span> will throw an exception.</p><p>The I18n Checker represents the possible arguments via <em>conversion
categories</em>. A conversion category defines a set of restrictions or a
subtyping rule.</p><p>Figure ‍<a href="#i18n-format-category">15.2</a> summarizes the subset
relationship among all conversion categories.</p><blockquote class="figure"><div class="center"><hr class="floatrule"></div>
<div class="center">
<img src="i18n-format-category.svg">
</div>
<div class="caption"><table style="border-spacing:6px;border-collapse:separate;" class="cellpading0"><tr><td style="vertical-align:top;text-align:left;" >Figure 15.2: The subset relationship among
i18n
conversion categories.</td></tr>
</table></div>
<a id="i18n-format-category"></a>
<div class="center"><hr class="floatrule"></div></blockquote>
<!--TOC section id="i18n-formatter-format-subtyping" Subtyping rules for <span style="font-family:monospace">@I18nFormat</span>-->
<h2 id="i18n-formatter-format-subtyping" class="section">15.3 Subtyping rules for <span style="font-family:monospace">@I18nFormat</span> <a href="#i18n-formatter-format-subtyping"><img src="chainlink.svg" width="10" height="10"></a></h2><!--SEC END --><p>Here are the subtyping rules among different
<span style="font-family:monospace">@I18nFormat</span>
qualifiers.
It is legal to:</p><ul class="itemize"><li class="li-itemize">
use a format string with a weaker (less restrictive) conversion category than required.
</li><li class="li-itemize">use a format string with fewer format specifiers than required.
Although this is legal a warning is issued because most occurrences of
this are due to programmer error.
</li></ul><p>The following example shows the subtyping rules in action:</p><pre class="verbatim">  @I18nFormat({NUMBER, DATE}) String f;

  f = "{0, number, #.#} {1, date}"; // OK
  f = "{0, number} {1}";            // OK, GENERAL is weaker (less restrictive) than DATE
  f = "{0} {1, date}";              // OK, GENERAL is weaker (less restrictive) than NUMBER
  f = "{0, number}";                // warning: last argument is ignored
  f = "{0}";                        // warning: last argument is ignored
  f = "{0, number} {1, number}";    // error: NUMBER is stronger (more restrictive) than DATE
  f = "{0} {1} {2}";                // error: too many arguments
</pre><p>The conversion categories are:</p><dl class="description"><dt class="dt-description"><a href="../api/org/checkerframework/checker/i18nformatter/qual/I18nConversionCategory.html#UNUSED"><span style="font-weight:bold"><span style="font-family:monospace">UNUSED</span></span></a></dt><dd class="dd-description">
indicates an unused argument. For example, in
<span style="font-family:monospace">MessageFormat.format("{0, number} {2, number}", 3.14, "Hello", 2.718)</span>
, the second argument <span style="font-family:monospace">Hello</span> is unused. Thus, the conversion
categories for the format, <span style="font-family:monospace">0, number</span><span style="font-family:monospace"> </span><span style="font-family:monospace">2, number</span>, is
<span style="font-family:monospace">(NUMBER, UNUSED, NUMBER)</span>.</dd><dt class="dt-description"><a href="../api/org/checkerframework/checker/i18nformatter/qual/I18nConversionCategory.html#GENERAL"><span style="font-weight:bold"><span style="font-family:monospace">GENERAL</span></span></a></dt><dd class="dd-description">
means that any value can be supplied as an argument.</dd><dt class="dt-description"><a href="../api/org/checkerframework/checker/i18nformatter/qual/I18nConversionCategory.html#DATE"><span style="font-weight:bold"><span style="font-family:monospace">DATE</span></span></a></dt><dd class="dd-description">
is applicable for date, time, and number types. An argument needs to be
of <a href="https://docs.oracle.com/en/java/javase/17/docs/api/java.sql/java/sql/Date.html"><span style="font-family:monospace">Date</span></a>,
<a href="https://docs.oracle.com/en/java/javase/17/docs/api/java.sql/java/sql/Time.html"><span style="font-family:monospace">Time</span></a>, or
<a href="https://docs.oracle.com/en/java/javase/17/docs/api/java.base/java/lang/Number.html"><span style="font-family:monospace">Number</span></a> type or a subclass of them,
including <a href="https://docs.oracle.com/en/java/javase/17/docs/api/java.sql/java/sql/Timestamp.html"><span style="font-family:monospace">Timestamp</span></a> and the classes
listed immediately below.</dd><dt class="dt-description"><a href="../api/org/checkerframework/checker/i18nformatter/qual/I18nConversionCategory.html#NUMBER"><span style="font-weight:bold"><span style="font-family:monospace">NUMBER</span></span></a></dt><dd class="dd-description">
means that the argument needs to be of <span style="font-family:monospace">Number</span>
type or a subclass:
<a href="https://docs.oracle.com/en/java/javase/17/docs/api/java.base/java/lang/Number.html"><span style="font-family:monospace">Number</span></a>,
<a href="https://docs.oracle.com/en/java/javase/17/docs/api/java.base/java/util/concurrent/atomic/AtomicInteger.html"><span style="font-family:monospace">AtomicInteger</span></a>,
<a href="https://docs.oracle.com/en/java/javase/17/docs/api/java.base/java/util/concurrent/atomic/AtomicLong.html"><span style="font-family:monospace">AtomicLong</span></a>,
<a href="https://docs.oracle.com/en/java/javase/17/docs/api/java.base/java/math/BigDecimal.html"><span style="font-family:monospace">BigDecimal</span></a>,
<a href="https://docs.oracle.com/en/java/javase/17/docs/api/java.base/java/math/BigInteger.html"><span style="font-family:monospace">BigInteger</span></a>,
<a href="https://docs.oracle.com/en/java/javase/17/docs/api/java.base/java/lang/Byte.html"><span style="font-family:monospace">Byte</span></a>,
<a href="https://docs.oracle.com/en/java/javase/17/docs/api/java.base/java/lang/Double.html"><span style="font-family:monospace">Double</span></a>,
<a href="https://docs.oracle.com/en/java/javase/17/docs/api/java.base/java/lang/Float.html"><span style="font-family:monospace">Float</span></a>,
<a href="https://docs.oracle.com/en/java/javase/17/docs/api/java.base/java/lang/Integer.html"><span style="font-family:monospace">Integer</span></a>,
<a href="https://docs.oracle.com/en/java/javase/17/docs/api/java.base/java/lang/Long.html"><span style="font-family:monospace">Long</span></a>,
<a href="https://docs.oracle.com/en/java/javase/17/docs/api/java.base/java/lang/Short.html"><span style="font-family:monospace">Short</span></a>.</dd></dl>
<!--TOC section id="i18n-format-checks" What the Internationalization Format String Checker checks-->
<h2 id="i18n-format-checks" class="section">15.4 What the Internationalization Format String Checker checks <a href="#i18n-format-checks"><img src="chainlink.svg" width="10" height="10"></a></h2><!--SEC END --><p>The Internationalization Format String Checker checks calls to the i18n
formatting method <a href="https://docs.oracle.com/en/java/javase/17/docs/api/java.base/java/text/MessageFormat.html#format(java.lang.String,java.lang.Object...)"><span style="font-family:monospace">MessageFormat.format</span></a>
and guarantees the following:</p><ol class="enumerate" type=1><li class="li-enumerate">
The checker issues a warning for the following cases:
<ol class="enumerate" type=a><li class="li-enumerate">
There are missing arguments from what is required by the format string.<p><span style="font-family:monospace">MessageFormat.format("{0, number} {1, number}", 3.14); // Output: 3.14 {1}</span></p></li><li class="li-enumerate">More arguments are passed than what is required by the format string.<p><span style="font-family:monospace">MessageFormat.format("{0, number}", 1, new Date());</span></p><p><span style="font-family:monospace">MessageFormat.format("{0, number} {0, number}", 3.14, 3.14);</span></p><p>This does not cause an error at run time, but it often indicates a
programmer mistake. If it is intentional, then you should suppress
the warning (see Chapter ‍<a href="#suppressing-warnings">32</a>).</p></li><li class="li-enumerate">Some argument is an array of objects.<p><span style="font-family:monospace">MessageFormat.format("{0, number} {1}", array);</span></p><p>The checker cannot verify whether the format string is valid, so
the checker conservatively issues a warning. This is a limitation of
the Internationalization Format String Checker.</p></li></ol>
</li><li class="li-enumerate">The checker issues an error for the following cases:
<ol class="enumerate" type=a><li class="li-enumerate">
The format string is invalid.<ul class="itemize"><li class="li-itemize">
Unmatched braces.<p><span style="font-family:monospace">MessageFormat.format("{0, time", new Date());</span></p></li><li class="li-itemize">The argument index is not an integer or is negative.<p><span style="font-family:monospace">MessageFormat.format("{0.2, time}", new Date());</span></p><p><span style="font-family:monospace">MessageFormat.format("{-1, time}", new Date());</span></p></li><li class="li-itemize">Unknown format type.<p><span style="font-family:monospace">MessageFormat.format("{0, foo}", 3.14);</span></p></li><li class="li-itemize">Missing a format style required for <span style="font-family:monospace">choice</span> format.<p><span style="font-family:monospace">MessageFormat.format("{0, choice}", 3.14);</span></p></li><li class="li-itemize">Wrong format style.<p><span style="font-family:monospace">MessageFormat.format("{0, time, number}", 3.14);</span></p></li><li class="li-itemize">Invalid subformats.<p><span style="font-family:monospace">MessageFormat.format("{0, number, #.#.#}", 3.14)</span>
</p></li></ul></li><li class="li-enumerate">Some argument’s type doesn’t satisfy its conversion category.<p><span style="font-family:monospace">MessageFormat.format("{0, number}", new Date());</span>
</p></li></ol>
</li></ol><p>The Checker also detects illegal assignments: assigning a non-format-string
or an incompatible format string to a variable declared as containing a
specific type of format string. For example,</p><pre class="verbatim">  @I18nFormat({GENERAL, NUMBER}) String format;
  // OK.
  format = "{0} {1, number}";
  // OK, GENERAL is weaker (less restrictive) than NUMBER.
  format = "{0} {1}";
  // OK, it is legal to have fewer arguments than required (less restrictive).
  // But the warning will be issued instead.
  format = "{0}";

  // Error, the format string is stronger (more restrictive) than the specifiers.
  format = "{0} {1} {2}";
  // Error, the format string is more restrictive. NUMBER is a subtype of GENERAL.
  format = "{0, number} {1, number}";
</pre>
<!--TOC section id="i18n-format-resource-files" Resource files-->
<h2 id="i18n-format-resource-files" class="section">15.5 Resource files <a href="#i18n-format-resource-files"><img src="chainlink.svg" width="10" height="10"></a></h2><!--SEC END --><p>A programmer rarely writes an i18n format string literally. (The examples
in this chapter show that for simplicity.) Rather, the i18n format strings are
read from a resource file. The program chooses a resource file at run time
depending on the locale (for example, different resource files for English
and Spanish users).</p><p>For example, suppose that the <span style="font-family:monospace">resource1.properties</span> file contains</p><pre class="verbatim">  key1 = The number is {0, number}.
</pre><p>Then code such as the following:</p><pre class="verbatim">  String formatPattern = ResourceBundle.getBundle("resource1").getString("key1");
  System.out.println(MessageFormat.format(formatPattern, 2.2361));
</pre><p>will output “The number is 2.2361.” A different resource file would contain
<span style="font-family:monospace">key1 = El número es {0, number}.</span></p><p>When you run the I18n Format String Checker, you need to indicate which resource file it
should check. If you change the resource file or use a different resource
file, you should re-run the checker
to ensure that you did not make an error. The I18n Format String Checker supports two types of
resource files: ResourceBundles and property files. The example above shows use of
resource bundles.
For more about checking property files, see Chapter ‍<a href="#propkey-checker">16</a>.</p>
<!--TOC section id="i18n-format-running" Running the Internationalization Format Checker-->
<h2 id="i18n-format-running" class="section">15.6 Running the Internationalization Format Checker <a href="#i18n-format-running"><img src="chainlink.svg" width="10" height="10"></a></h2><!--SEC END --><p>The checker can be invoked by running one of the following commands (with
the whole command on one line).</p><ul class="itemize"><li class="li-itemize">
Using ResourceBundles:<p>
<span style="font-family:monospace">javac -processor
org.checkerframework.checker.i18nformatter.I18nFormatterChecker
-Abundlenames=MyResource MyFile.java</span>
</p></li><li class="li-itemize">Using property files:<p>
<span style="font-family:monospace">javac -processor
org.checkerframework.checker.i18nformatter.I18nFormatterChecker
-Apropfiles=MyResource.properties MyFile.java</span>
</p></li><li class="li-itemize">Not using a property file. Use this if the programmer hard-coded the
format patterns without loading them from a property file.<p>
<span style="font-family:monospace">javac -processor
org.checkerframework.checker.i18nformatter.I18nFormatterChecker MyFile.java</span>

</p></li></ul>
<!--TOC section id="i18n-format-testing" Testing whether a string has an i18n format type-->
<h2 id="i18n-format-testing" class="section">15.7 Testing whether a string has an i18n format type <a href="#i18n-format-testing"><img src="chainlink.svg" width="10" height="10"></a></h2><!--SEC END --><p>In the case that the checker cannot infer the i18n format type of a string,
you can use the <a href="../api/org/checkerframework/checker/i18nformatter/util/I18nFormatUtil.html#hasFormat(java.lang.String,org.checkerframework.checker.i18nformatter.qual.I18nConversionCategory...)"><span style="font-family:monospace">I18nFormatUtil.hasFormat</span></a>
method to define the type of the string in the scope of a conditional statement.</p><dl class="description"><dt class="dt-description"><a href="../api/org/checkerframework/checker/i18nformatter/util/I18nFormatUtil.html#hasFormat(java.lang.String,org.checkerframework.checker.i18nformatter.qual.I18nConversionCategory...)"><span style="font-weight:bold"><span style="font-family:monospace">I18nFormatUtil.hasFormat</span></span></a></dt><dd class="dd-description">
returns <span style="font-family:monospace">true</span> if the given string has the given i18n format type.</dd></dl><p>For an example, see Section ‍<a href="#i18n-format-examples">15.8</a>.</p><p>To use the <a href="../api/org/checkerframework/checker/i18nformatter/util/I18nFormatUtil.html"><span style="font-family:monospace">I18nFormatUtil</span></a> class, the <span style="font-family:monospace">checker-util.jar</span> file
must be on the classpath at run time.</p>
<!--TOC section id="i18n-format-examples" Examples of using the Internationalization Format Checker-->
<h2 id="i18n-format-examples" class="section">15.8 Examples of using the Internationalization Format Checker <a href="#i18n-format-examples"><img src="chainlink.svg" width="10" height="10"></a></h2><!--SEC END --><ul class="itemize"><li class="li-itemize">
Using <a href="https://docs.oracle.com/en/java/javase/17/docs/api/java.base/java/text/MessageFormat.html#format(java.lang.String,java.lang.Object...)"><span style="font-family:monospace">MessageFormat.format</span></a>.
<pre class="verbatim">      // suppose the bundle "MyResource" contains:  key1={0, number} {1, date}
      String value = ResourceBundle.getBundle("MyResource").getString("key1");
      MessageFormat.format(value, 3.14, new Date());  // OK
      // error: incompatible types in argument; found String, expected number
      MessageFormat.format(value, "Text", new Date());
</pre>
</li><li class="li-itemize">Using the
<a href="../api/org/checkerframework/checker/i18nformatter/util/I18nFormatUtil.html#hasFormat(java.lang.String,org.checkerframework.checker.i18nformatter.qual.I18nConversionCategory...)"><span style="font-family:monospace">I18nFormatUtil.hasFormat</span></a>
method to check whether a format
string has particular conversion categories.
<pre class="verbatim">      void test1(String format) {
        if (I18nFormatUtil.hasFormat(format, I18nConversionCategory.GENERAL,
                                             I18nConversionCategory.NUMBER)) {
          MessageFormat.format(format, "Hello", 3.14);  // OK
          // error: incompatible types in argument; found String, expected number
          MessageFormat.format(format, "Hello", "Bye");
          // error: missing arguments; expected 2 but 1 given
          MessageFormat.format(format, "Bye");
          // error: too many arguments; expected 2 but 3 given
          MessageFormat.format(format, "A String", 3.14, 3.14);
        }
      }
</pre>
</li><li class="li-itemize">Using <a href="../api/org/checkerframework/checker/i18nformatter/qual/I18nFormatFor.html"><span style="font-family:monospace">@I18nFormatFor</span></a>
to ensure that an argument is a particular type of format string.
<pre class="verbatim">      static void method(@I18nFormatFor("#2") String f, Object... args) {...}

      // OK, MessageFormat.format(...) would return "3.14 Hello greater than one"
      method("{0, number} {1} {2, choice,0#zero|1#one|1&lt;greater than one}",
             3.14, "Hello", 100);

      // error: incompatible types in argument; found String, expected number
      method("{0, number} {1}", "Bye", "Bye");
</pre>
</li><li class="li-itemize">Annotating a string with
<a href="../api/org/checkerframework/checker/i18nformatter/qual/I18nFormat.html"><span style="font-family:monospace">@I18nFormat</span></a>.
<pre class="verbatim">      @I18nFormat({I18nConversionCategory.DATE}) String;
      s1 = "{0}";
      s1 = "{0, number}";        // error: incompatible types in assignment
</pre>
</li></ul><hr>
<!--TOC chapter id="propkey-checker" Property File Checker-->
<h1 id="propkey-checker" class="chapter">Chapter ‍16 Property File Checker <a href="#propkey-checker"><img src="chainlink.svg" width="10" height="10"></a></h1><!--SEC END --><p>The Property File Checker ensures that a property file or resource bundle (both
of which act like maps from keys to values) is only accessed with valid keys.
Accesses without a valid key either return <span style="font-family:monospace">null</span> or a default value, which
can lead to a <span style="font-family:monospace">NullPointerException</span> or hard-to-trace behavior.
The Property File Checker (Section <a href="#genpropkey-checker">16.1</a>) ensures
that the used keys are found in the corresponding property file or resource
bundle.</p><p>We also provide two specialized checkers.
An Internationalization Checker (Section <a href="#i18n-checker">16.2</a>)
verifies that code is properly internationalized.
A Compiler Message Key Checker (Section <a href="#compilermsgs-checker">16.3</a>)
verifies that compiler message keys used in the Checker Framework are
declared in a property file.
This is an example of a simple specialization of the property
file checker, and the Checker Framework source code shows how it is used.</p><p>It is easy to customize the property key checker for other related purposes.
Take a look at the source code of the Compiler Message Key Checker and adapt it for
your purposes.</p>
<!--TOC section id="genpropkey-checker" General Property File Checker-->
<h2 id="genpropkey-checker" class="section">16.1 General Property File Checker <a href="#genpropkey-checker"><img src="chainlink.svg" width="10" height="10"></a></h2><!--SEC END --><p>The general Property File Checker ensures that a resource key is located
in a specified property file or resource bundle.</p><p>The annotation <a href="../api/org/checkerframework/checker/propkey/qual/PropertyKey.html"><span style="font-family:monospace">@PropertyKey</span></a>
indicates that the qualified <span style="font-family:monospace">CharSequence</span> is a valid key
found in the property file or resource bundle.
You do not need to annotate <span style="font-family:monospace">String</span> literals.
The checker looks up every <span style="font-family:monospace">String</span> literal in the specified
property file or resource bundle, and adds annotations as appropriate.</p><p>If you pass a <span style="font-family:monospace">CharSequence</span> (including <span style="font-family:monospace">String</span>) variable to be
eventually used as a key, you
also need to annotate all these variables with <span style="font-family:monospace">@PropertyKey</span>.</p><p>The checker can be invoked by running the following
command:</p><pre class="verbatim">  javac -processor org.checkerframework.checker.propkey.PropertyKeyChecker
        -Abundlenames=MyResource MyFile.java ...
</pre><p>You must specify the resources, which map keys to strings.
The checker supports two types of resource:
resource bundles and property files. You can specify one or both of the
following two command-line options:</p><ol class="enumerate" type=1><li class="li-enumerate"><span style="font-family:monospace">-Abundlenames=</span><span style="font-family:monospace"><em>resource_name</em></span><p><em>resource_name</em> is the name of the resource to be used with
<a href="https://docs.oracle.com/en/java/javase/17/docs/api/java.base/java/util/ResourceBundle.html#getBundle(java.lang.String,java.util.Locale,java.lang.ClassLoader)"><span style="font-family:monospace">ResourceBundle.getBundle()</span></a>.
The checker uses the default <span style="font-family:monospace">Locale</span> and <span style="font-family:monospace">ClassLoader</span> in the
compilation system.
(For a tutorial about <span style="font-family:monospace">ResourceBundle</span>s, see
<a href="https://docs.oracle.com/javase/tutorial/i18n/resbundle/concept.html"><span style="font-family:monospace">https://docs.oracle.com/javase/tutorial/i18n/resbundle/concept.html</span></a>.)
Multiple resource bundle names are separated by colons ’<span style="font-family:monospace">:</span>’.</p></li><li class="li-enumerate"><span style="font-family:monospace">-Apropfiles=</span><span style="font-family:monospace"><em>prop_file</em></span><p><em>prop_file</em> is the name of a properties file that maps
keys to values. The file format is described in
the Javadoc for
<a href="https://docs.oracle.com/en/java/javase/17/docs/api/java.base/java/util/Properties.html#load(java.io.Reader)"><span style="font-family:monospace">Properties.load()</span></a>.
Multiple files are separated by Java’s
<a href="https://docs.oracle.com/en/java/javase/17/docs/api/java.base/java/io/File.html#pathSeparator"><span style="font-family:monospace">File.pathSeparator</span></a>
(semicolon “<span style="font-family:monospace">;</span>” on Windows, colon “<span style="font-family:monospace">:</span>” on Linux and
Mac).</p></li></ol>
<!--TOC section id="i18n-checker" Internationalization Checker (I18n Checker)-->
<h2 id="i18n-checker" class="section">16.2 Internationalization Checker (I18n Checker) <a href="#i18n-checker"><img src="chainlink.svg" width="10" height="10"></a></h2><!--SEC END --><p>The Internationalization Checker, or I18n Checker, verifies that your code is properly
internationalized. Internationalization is the process of designing software so that
it can be adapted to different languages and locales without needing to change the code.
Localization is the process of adapting internationalized software to specific languages
and locales.</p><p>Internationalization is sometimes called i18n, because the word starts with “i”,
ends with “n”, and has 18 characters in between. Localization is similarly
sometimes abbreviated as l10n.</p><p>The checker focuses on one aspect of internationalization: user-visible text
should be presented in the user’s own language, such as English, French, or
German. This is achieved by looking up keys in a localization resource,
which maps keys to user-visible text. For instance, one version of a
resource might map <span style="font-family:monospace">"CANCEL_STRING"</span> to
<span style="font-family:monospace">"Cancel"</span>, and another version of the same resource might map
<span style="font-family:monospace">"CANCEL_STRING"</span> to <span style="font-family:monospace">"Abbrechen"</span>.</p><p>There are other aspects to localization, such as formatting of dates (3/5
vs. ‍5/3 for March 5), that the checker does not check.</p><p>The Internationalization Checker verifies these two properties:</p><ol class="enumerate" type=1><li class="li-enumerate">Any user-visible text should be obtained from a localization resource.
For example, <span style="font-family:monospace">String</span> literals should not be output to the user.</li><li class="li-enumerate">When looking up keys in a localization resource, the key should exist in
that resource. This check catches incorrect or misspelled localization
keys.</li></ol><p>If you use the Internationalization Checker, you may want to also use the
Internationalization Format String Checker, or I18n Format String Checker
(Chapter ‍<a href="#i18n-formatter-checker">15</a>).
It verifies that internationalization format strings are well-formed and
used with arguments of the proper type, so that
<a href="https://docs.oracle.com/en/java/javase/17/docs/api/java.base/java/text/MessageFormat.html#format(java.lang.String,java.lang.Object...)"><span style="font-family:monospace">MessageFormat.format</span></a>
does not fail at run time.</p>
<!--TOC subsection id="i18n-annotations" Internationalization annotations-->
<h3 id="i18n-annotations" class="subsection">16.2.1 Internationalization annotations <a href="#i18n-annotations"><img src="chainlink.svg" width="10" height="10"></a></h3><!--SEC END --><p>The Internationalization Checker supports two annotations:</p><dl class="description"><dt class="dt-description">
<a href="../api/org/checkerframework/checker/i18n/qual/Localized.html"><span style="font-weight:bold"><span style="font-family:monospace">@Localized</span></span></a></dt><dd class="dd-description">
indicates that the qualified
<span style="font-family:monospace">CharSequence</span> is a message that has been localized and/or formatted with
respect to the used locale.</dd><dt class="dt-description"><a href="../api/org/checkerframework/checker/i18n/qual/LocalizableKey.html"><span style="font-weight:bold"><span style="font-family:monospace">@LocalizableKey</span></span></a></dt><dd class="dd-description">
indicates that the
qualified <span style="font-family:monospace">CharSequence</span> or <span style="font-family:monospace">Object</span> is a valid key found in the
localization resource.
This annotation is a specialization of the <span style="font-family:monospace">@PropertyKey</span> annotation, that
gets checked by the general Property Key Checker.
</dd></dl><p>You may need to add the <span style="font-family:monospace">@Localized</span> annotation to more methods in the
JDK or other libraries, or in your own code.</p>
<!--TOC subsection id="i18n-running" Running the Internationalization Checker-->
<h3 id="i18n-running" class="subsection">16.2.2 Running the Internationalization Checker <a href="#i18n-running"><img src="chainlink.svg" width="10" height="10"></a></h3><!--SEC END --><p>The Internationalization Checker can be invoked by running the following
command:</p><pre class="verbatim">  javac -processor org.checkerframework.checker.i18n.I18nChecker -Abundlenames=MyResource MyFile.java ...
</pre><p>You must specify the localization resource, which maps keys to user-visible
text. Like the general Property Key Checker, the Internationalization Checker
supports two types of localization resource:
<span style="font-family:monospace">ResourceBundle</span>s using the
<span style="font-family:monospace">-Abundlenames=</span><span style="font-family:monospace"><em>resource_name</em></span> option
or property files using the
<span style="font-family:monospace">-Apropfiles=</span><span style="font-family:monospace"><em>prop_file</em></span> option.</p>
<!--TOC section id="compilermsgs-checker" Compiler Message Key Checker-->
<h2 id="compilermsgs-checker" class="section">16.3 Compiler Message Key Checker <a href="#compilermsgs-checker"><img src="chainlink.svg" width="10" height="10"></a></h2><!--SEC END --><p>The Checker Framework uses compiler message keys to output error messages.
These keys are substituted by localized strings for user-visible error messages.
Using keys instead of the localized strings in the source code enables easier
testing, as the expected message keys can stay unchanged while the localized
strings can still be modified.
We use the Compiler Message Key Checker to ensure that all internal
keys are correctly localized.
Instead of using the Property File Checker, we use a specialized checker,
giving us more precise documentation of the intended use of <span style="font-family:monospace">String</span>s.</p><p>The single annotation used by this checker is
<a href="../api/org/checkerframework/checker/compilermsgs/qual/CompilerMessageKey.html"><span style="font-family:monospace">@CompilerMessageKey</span></a>.
The Checker Framework is completely annotated;
for example, class <span style="font-family:monospace">org.checkerframework.framework.source.Result</span>
uses <span style="font-family:monospace">@CompilerMessageKey</span> in methods <span style="font-family:monospace">failure</span> and <span style="font-family:monospace">warning</span>.
For most users of the Checker Framework there will be no need to annotate any
<span style="font-family:monospace">String</span>s, as the checker looks up all <span style="font-family:monospace">String</span> literals and adds
annotations as appropriate.</p><p>The Compiler Message Key Checker can be invoked by running the following
command:</p><pre class="verbatim">  javac -processor org.checkerframework.checker.compilermsgs.CompilerMessagesChecker
        -Apropfiles=messages.properties MyFile.java ...
</pre><p>You must specify the resource, which maps compiler message keys to user-visible
text. The checker supports the same options as the general property key checker.
Within the Checker Framework we only use property files,
so the <span style="font-family:monospace">-Apropfiles=</span><span style="font-family:monospace"><em>prop_file</em></span> option should be used.</p><hr>
<!--TOC chapter id="signature-checker" Signature String Checker for string representations of types-->
<h1 id="signature-checker" class="chapter">Chapter ‍17 Signature String Checker for string representations of types <a href="#signature-checker"><img src="chainlink.svg" width="10" height="10"></a></h1><!--SEC END --><p>The Signature String Checker, or Signature Checker for short, verifies that
string representations of types and signatures are used correctly.</p><p>Java defines multiple different string representations for types (see
Section ‍<a href="#signature-annotations">17.1</a>), and it is easy to
misuse them or to miss bugs during testing. Using the wrong string format
leads to a run-time exception or an incorrect result. This is a particular
problem for fully qualified and binary names, which are nearly the same —
they differ only for nested classes and arrays.</p><p>The paper “Building and using pluggable
type-checkers” ‍[<a href="#DietlDEMS2011">DDE+11</a>] (ICSE 2011,
<a href="https://homes.cs.washington.edu/~mernst/pubs/pluggable-checkers-icse2011.pdf"><span style="font-family:monospace">https://homes.cs.washington.edu/~mernst/pubs/pluggable-checkers-icse2011.pdf</span></a>)
describes case studies of the Signature String Checker.</p>
<!--TOC section id="signature-annotations" Signature annotations-->
<h2 id="signature-annotations" class="section">17.1 Signature annotations <a href="#signature-annotations"><img src="chainlink.svg" width="10" height="10"></a></h2><!--SEC END --><p>Java defines six formats for the string representation of a type.
There is an annotation for each of these representations.
Figure ‍<a href="#fig-signature-hierarchy">17.1</a> shows how they are related;
examples appear in a table below.</p><blockquote class="figure"><div class="center"><hr class="floatrule"></div>
<div class="center">
<img src="signature-types.svg">
</div>
<div class="caption"><table style="border-spacing:6px;border-collapse:separate;" class="cellpading0"><tr><td style="vertical-align:top;text-align:left;" >Figure 17.1: Partial type hierarchy for the Signature type system, showing
string representations of a Java type.
The type qualifiers are applicable to <span style="font-family:monospace">CharSequence</span> and its subtypes.
Programmers usually only need to write
the boldfaced qualifiers; other qualifiers are
included to improve the internal handling of String literals.</td></tr>
</table></div>
<a id="fig-signature-hierarchy"></a>
<div class="center"><hr class="floatrule"></div></blockquote><p><a id="signature-annotations-descriptions"></a></p><dl class="description"><dt class="dt-description"><a href="../api/org/checkerframework/checker/signature/qual/FullyQualifiedName.html"><span style="font-weight:bold"><span style="font-family:monospace">@FullyQualifiedName</span></span></a></dt><dd class="dd-description">
A <em>fully qualified name</em> (<a href="https://docs.oracle.com/javase/specs/jls/se17/html/jls-6.html#jls-6.7">JLS §6.7</a>), such as
<span style="font-family:monospace">mypackage.Outer.Inner</span>, is used in Java code and in messages to
the user.</dd><dt class="dt-description"><a href="../api/org/checkerframework/checker/signature/qual/ClassGetName.html"><span style="font-weight:bold"><span style="font-family:monospace">@ClassGetName</span></span></a></dt><dd class="dd-description">

The type representation used by the
<a href="https://docs.oracle.com/en/java/javase/17/docs/api/java.base/java/lang/Class.html#getName()"><span style="font-family:monospace">Class.getName()</span></a>, <span style="font-family:monospace">Class.forName(String)</span>,
and <span style="font-family:monospace">Class.forName(String, boolean, ClassLoader)</span> methods. This format
is: for any non-array type, the binary name; and for any array type, a
format like the
<a href="https://docs.oracle.com/javase/specs/jvms/se17/html/jvms-4.html#jvms-4.3.2">FieldDescriptor
field descriptor</a>, but using
“<span style="font-family:monospace">.</span>” ‍where the field descriptor uses “<span style="font-family:monospace">/</span>”. See examples below.
</dd><dt class="dt-description"><a href="../api/org/checkerframework/checker/signature/qual/FieldDescriptor.html"><span style="font-weight:bold"><span style="font-family:monospace">@FieldDescriptor</span></span></a></dt><dd class="dd-description">
A <em>field descriptor</em> (<a href="https://docs.oracle.com/javase/specs/jvms/se17/html/jvms-4.html#jvms-4.3.2">JVMS §4.3.2</a>), such as
<span style="font-family:monospace">Lmypackage/Outer$Inner;</span>, is used in a <span style="font-family:monospace">.class</span> file’s constant pool,
for example to refer to other types. It abbreviates primitive types and
array types. It uses internal form (binary names, but with <span style="font-family:monospace">/</span> instead of
<span style="font-family:monospace">.</span>; see
<a href="https://docs.oracle.com/javase/specs/jvms/se17/html/jvms-4.html#jvms-4.2.1">JVMS
§4.2</a>) for class names. See examples below.</dd><dt class="dt-description"><a href="../api/org/checkerframework/checker/signature/qual/BinaryName.html"><span style="font-weight:bold"><span style="font-family:monospace">@BinaryName</span></span></a></dt><dd class="dd-description">
A <em>binary name</em> (<a href="https://docs.oracle.com/javase/specs/jls/se17/html/jls-13.html#jls-13.1">JLS §13.1</a>), such as
<span style="font-family:monospace">mypackage.Outer$Inner</span>, is
the conceptual name of a type in its own <span style="font-family:monospace">.class</span> file.</dd><dt class="dt-description"><a href="../api/org/checkerframework/checker/signature/qual/InternalForm.html"><span style="font-weight:bold"><span style="font-family:monospace">@InternalForm</span></span></a></dt><dd class="dd-description">
The <em>internal form</em>
(<a href="https://docs.oracle.com/javase/specs/jvms/se17/html/jvms-4.html#jvms-4.2">JVMS
§4.2</a>), such as <span style="font-family:monospace">mypackage/Outer$Inner</span>, is how a class name is
actually represented in its own <span style="font-family:monospace">.class</span> file. It is also known as the
“syntax of binary names that appear in class file structures”. It is
the same as the binary name, but with periods (<span style="font-family:monospace">.</span>) replaced by slashes
(<span style="font-family:monospace">/</span>). Programmers more often use the binary name, leaving the internal
form as a JVM implementation detail.</dd><dt class="dt-description"><a href="../api/org/checkerframework/checker/signature/qual/ClassGetSimpleName.html"><span style="font-weight:bold"><span style="font-family:monospace">@ClassGetSimpleName</span></span></a></dt><dd class="dd-description">
The type representation returned by the
<a href="https://docs.oracle.com/en/java/javase/17/docs/api/java.base/java/lang/Class.html#getSimpleName()"><span style="font-family:monospace">Class.getSimpleName()</span></a>
method. This format is not required by any method in the JDK, so you
will rarely write it in source code. The string can be empty. This
is not the same as the “simple name” defined in
(<a href="https://docs.oracle.com/javase/specs/jls/se17/html/jls-6.html#jls-6.2">JLS
§6.2</a>), which is the same as
<a href="../api/org/checkerframework/checker/signature/qual/Identifier.html"><span style="font-family:monospace">@Identifier</span></a>.</dd><dt class="dt-description"><a href="../api/org/checkerframework/checker/signature/qual/FqBinaryName.html"><span style="font-weight:bold"><span style="font-family:monospace">@FqBinaryName</span></span></a></dt><dd class="dd-description">
An extension of binary name format to represent primitives and arrays.
It is like <a href="../api/org/checkerframework/checker/signature/qual/FullyQualifiedName.html"><span style="font-family:monospace">@FullyQualifiedName</span></a>, but using
“<span style="font-family:monospace">$</span>” instead of “<span style="font-family:monospace">.</span>” to separate nested classes from their
containing classes. For example, <span style="font-family:monospace">"pkg.Outer$Inner"</span> or
<span style="font-family:monospace">"pkg.Outer$Inner[][]"</span> or <span style="font-family:monospace">"int[]"</span>.</dd><dt class="dt-description"><a href="../api/org/checkerframework/checker/signature/qual/CanonicalName.html"><span style="font-weight:bold"><span style="font-family:monospace">@CanonicalName</span></span></a></dt><dd class="dd-description">
Syntactically identical to
<a href="../api/org/checkerframework/checker/signature/qual/FullyQualifiedName.html"><span style="font-family:monospace">@FullyQualifiedName</span></a>, but some
classes have multiple fully-qualified names, only one of which is
canonical (see
<a href="https://docs.oracle.com/javase/specs/jls/se17/html/jls-6.html#jls-6.7">JLS
§6.7</a>).</dd></dl><p>Other type qualifiers are the intersection of two or more qualifiers listed
above; for example, a
<a href="../api/org/checkerframework/checker/signature/qual/BinaryNameWithoutPackage.html"><span style="font-family:monospace">@BinaryNameWithoutPackage</span></a> is a string
that is a valid internal form <em>and</em> a valid binary name. A
programmer should never or rarely use these qualifiers, and you can ignore
them as implementation details of the Signature Checker, though you might
occasionally see them in an error message. These qualifiers exist to give
literals sufficiently precise types that they can be used in any
appropriate context.</p><p>Java also defines other string formats for a type, notably qualified names
(<a href="https://docs.oracle.com/javase/specs/jls/se17/html/jls-6.html#jls-6.2">JLS
§6.2</a>). The Signature Checker does not include annotations for these.</p><p><a id="signature-annotations-table"></a></p><p>Here are examples of the supported formats: <a href="#signature-annotations-examples"><img src="chainlink.svg" width="10" height="10"></a>
<a id="signature-annotations-examples"></a></p><div class="center"><span style="font-size:small">
</span><table border=1  style="border-spacing:0;" class="cellpadding1"><tr><td style="text-align:center;border:solid 1px;white-space:nowrap" ><span style="font-size:small">fully qualified name</span></td><td style="text-align:center;border:solid 1px;white-space:nowrap" ><span style="font-size:small">Class.getName</span></td><td style="text-align:center;border:solid 1px;white-space:nowrap" ><span style="font-size:small">field descriptor</span></td><td style="text-align:center;border:solid 1px;white-space:nowrap" ><span style="font-size:small">binary name</span></td><td style="text-align:center;border:solid 1px;white-space:nowrap" ><span style="font-size:small">internal form</span></td><td style="text-align:center;border:solid 1px;white-space:nowrap" ><span style="font-size:small">Class.getSimpleName</span><span style="font-size:small"> </span></td></tr>
<tr><td style="text-align:left;border:solid 1px;white-space:nowrap" ><span style="font-size:small">int</span></td><td style="text-align:left;border:solid 1px;white-space:nowrap" ><span style="font-size:small">int</span></td><td style="text-align:left;border:solid 1px;white-space:nowrap" ><span style="font-size:small">I</span></td><td style="text-align:left;border:solid 1px;white-space:nowrap" ><span style="font-size:small"><em>n/a </em></span><span style="font-size:small"><em>for primitive type</em></span></td><td style="text-align:left;border:solid 1px;white-space:nowrap" ><span style="font-size:small"><em>n/a </em></span><span style="font-size:small"><em>for primitive type</em></span></td><td style="text-align:left;border:solid 1px;white-space:nowrap" ><span style="font-size:small">int </span></td></tr>
<tr><td style="text-align:left;border:solid 1px;white-space:nowrap" ><span style="font-size:small">int[][]</span></td><td style="text-align:left;border:solid 1px;white-space:nowrap" ><span style="font-size:small">[[I</span></td><td style="text-align:left;border:solid 1px;white-space:nowrap" ><span style="font-size:small">[[I</span></td><td style="text-align:left;border:solid 1px;white-space:nowrap" ><span style="font-size:small"><em>n/a </em></span><span style="font-size:small"><em>for array type</em></span></td><td style="text-align:left;border:solid 1px;white-space:nowrap" ><span style="font-size:small"><em>n/a </em></span><span style="font-size:small"><em>for array type</em></span></td><td style="text-align:left;border:solid 1px;white-space:nowrap" ><span style="font-size:small">int[][] </span></td></tr>
<tr><td style="text-align:left;border:solid 1px;white-space:nowrap" ><span style="font-size:small">MyClass</span></td><td style="text-align:left;border:solid 1px;white-space:nowrap" ><span style="font-size:small">MyClass</span></td><td style="text-align:left;border:solid 1px;white-space:nowrap" ><span style="font-size:small">LMyClass;</span></td><td style="text-align:left;border:solid 1px;white-space:nowrap" ><span style="font-size:small">MyClass</span></td><td style="text-align:left;border:solid 1px;white-space:nowrap" ><span style="font-size:small">MyClass</span></td><td style="text-align:left;border:solid 1px;white-space:nowrap" ><span style="font-size:small">MyClass </span></td></tr>
<tr><td style="text-align:left;border:solid 1px;white-space:nowrap" ><span style="font-size:small">MyClass[]</span></td><td style="text-align:left;border:solid 1px;white-space:nowrap" ><span style="font-size:small">[LMyClass;</span></td><td style="text-align:left;border:solid 1px;white-space:nowrap" ><span style="font-size:small">[LMyClass;</span></td><td style="text-align:left;border:solid 1px;white-space:nowrap" ><span style="font-size:small"><em>n/a </em></span><span style="font-size:small"><em>for array type</em></span></td><td style="text-align:left;border:solid 1px;white-space:nowrap" ><span style="font-size:small"><em>n/a </em></span><span style="font-size:small"><em>for array type</em></span></td><td style="text-align:left;border:solid 1px;white-space:nowrap" ><span style="font-size:small">MyClass[] </span></td></tr>
<tr><td style="text-align:left;border:solid 1px;white-space:nowrap" ><span style="font-size:small"><em>n/a </em></span><span style="font-size:small"><em>for anonymous class</em></span></td><td style="text-align:left;border:solid 1px;white-space:nowrap" ><span style="font-size:small">MyClass$22</span></td><td style="text-align:left;border:solid 1px;white-space:nowrap" ><span style="font-size:small">LMyClass$22;</span></td><td style="text-align:left;border:solid 1px;white-space:nowrap" ><span style="font-size:small">MyClass$22</span></td><td style="text-align:left;border:solid 1px;white-space:nowrap" ><span style="font-size:small">MyClass$22</span></td><td style="text-align:left;border:solid 1px;white-space:nowrap" ><span style="font-size:small"><em>(empty string)</em></span></td></tr>
<tr><td style="text-align:left;border:solid 1px;white-space:nowrap" ><span style="font-size:small"><em>n/a </em></span><span style="font-size:small"><em>for array of anon. ‍class</em></span></td><td style="text-align:left;border:solid 1px;white-space:nowrap" ><span style="font-size:small">[LMyClass$22;</span></td><td style="text-align:left;border:solid 1px;white-space:nowrap" ><span style="font-size:small">[LMyClass$22;</span></td><td style="text-align:left;border:solid 1px;white-space:nowrap" ><span style="font-size:small"><em>n/a </em></span><span style="font-size:small"><em>for array type</em></span></td><td style="text-align:left;border:solid 1px;white-space:nowrap" ><span style="font-size:small"><em>n/a </em></span><span style="font-size:small"><em>for array type</em></span></td><td style="text-align:left;border:solid 1px;white-space:nowrap" ><span style="font-size:small">[] </span></td></tr>
<tr><td style="text-align:left;border:solid 1px;white-space:nowrap" ><span style="font-size:small">java.lang.Integer</span></td><td style="text-align:left;border:solid 1px;white-space:nowrap" ><span style="font-size:small">java.lang.Integer</span></td><td style="text-align:left;border:solid 1px;white-space:nowrap" ><span style="font-size:small">Ljava/lang/Integer;</span></td><td style="text-align:left;border:solid 1px;white-space:nowrap" ><span style="font-size:small">java.lang.Integer</span></td><td style="text-align:left;border:solid 1px;white-space:nowrap" ><span style="font-size:small">java/lang/Integer</span></td><td style="text-align:left;border:solid 1px;white-space:nowrap" ><span style="font-size:small">Integer </span></td></tr>
<tr><td style="text-align:left;border:solid 1px;white-space:nowrap" ><span style="font-size:small">java.lang.Integer[]</span></td><td style="text-align:left;border:solid 1px;white-space:nowrap" ><span style="font-size:small">[Ljava.lang.Integer;</span></td><td style="text-align:left;border:solid 1px;white-space:nowrap" ><span style="font-size:small">[Ljava/lang/Integer;</span></td><td style="text-align:left;border:solid 1px;white-space:nowrap" ><span style="font-size:small"><em>n/a </em></span><span style="font-size:small"><em>for array type</em></span></td><td style="text-align:left;border:solid 1px;white-space:nowrap" ><span style="font-size:small"><em>n/a </em></span><span style="font-size:small"><em>for array type</em></span></td><td style="text-align:left;border:solid 1px;white-space:nowrap" ><span style="font-size:small">Integer[] </span></td></tr>
<tr><td style="text-align:left;border:solid 1px;white-space:nowrap" ><span style="font-size:small">pkg.Outer.Inner</span></td><td style="text-align:left;border:solid 1px;white-space:nowrap" ><span style="font-size:small">pkg.Outer$Inner</span></td><td style="text-align:left;border:solid 1px;white-space:nowrap" ><span style="font-size:small">Lpkg/Outer$Inner;</span></td><td style="text-align:left;border:solid 1px;white-space:nowrap" ><span style="font-size:small">pkg.Outer$Inner</span></td><td style="text-align:left;border:solid 1px;white-space:nowrap" ><span style="font-size:small">pkg/Outer$Inner</span></td><td style="text-align:left;border:solid 1px;white-space:nowrap" ><span style="font-size:small">Inner </span></td></tr>
<tr><td style="text-align:left;border:solid 1px;white-space:nowrap" ><span style="font-size:small">pkg.Outer.Inner[]</span></td><td style="text-align:left;border:solid 1px;white-space:nowrap" ><span style="font-size:small">[Lpkg.Outer$Inner;</span></td><td style="text-align:left;border:solid 1px;white-space:nowrap" ><span style="font-size:small">[Lpkg/Outer$Inner;</span></td><td style="text-align:left;border:solid 1px;white-space:nowrap" ><span style="font-size:small"><em>n/a </em></span><span style="font-size:small"><em>for array type</em></span></td><td style="text-align:left;border:solid 1px;white-space:nowrap" ><span style="font-size:small"><em>n/a </em></span><span style="font-size:small"><em>for array type</em></span></td><td style="text-align:left;border:solid 1px;white-space:nowrap" ><span style="font-size:small">Inner[] </span></td></tr>
<tr><td style="text-align:left;border:solid 1px;white-space:nowrap" ><span style="font-size:small"><em>n/a </em></span><span style="font-size:small"><em>for anonymous class</em></span></td><td style="text-align:left;border:solid 1px;white-space:nowrap" ><span style="font-size:small">pkg.Outer$22</span></td><td style="text-align:left;border:solid 1px;white-space:nowrap" ><span style="font-size:small">Lpkg/Outer$22;</span></td><td style="text-align:left;border:solid 1px;white-space:nowrap" ><span style="font-size:small">pkg.Outer$22</span></td><td style="text-align:left;border:solid 1px;white-space:nowrap" ><span style="font-size:small">pkg/Outer$22</span></td><td style="text-align:left;border:solid 1px;white-space:nowrap" ><span style="font-size:small"><em>(empty string)</em></span></td></tr>
<tr><td style="text-align:left;border:solid 1px;white-space:nowrap" ><span style="font-size:small"><em>n/a </em></span><span style="font-size:small"><em>for array of anon. ‍class</em></span></td><td style="text-align:left;border:solid 1px;white-space:nowrap" ><span style="font-size:small">[Lpkg.Outer$22;</span></td><td style="text-align:left;border:solid 1px;white-space:nowrap" ><span style="font-size:small">[Lpkg/Outer$22;</span></td><td style="text-align:left;border:solid 1px;white-space:nowrap" ><span style="font-size:small"><em>n/a </em></span><span style="font-size:small"><em>for array type</em></span></td><td style="text-align:left;border:solid 1px;white-space:nowrap" ><span style="font-size:small"><em>n/a </em></span><span style="font-size:small"><em>for array type</em></span></td><td style="text-align:left;border:solid 1px;white-space:nowrap" ><span style="font-size:small">[] </span></td></tr>
</table><span style="font-size:small">
</span></div><p>Java defines one format for the string representation of a method signature:</p><dl class="description"><dt class="dt-description"><a href="../api/org/checkerframework/checker/signature/qual/MethodDescriptor.html"><span style="font-weight:bold"><span style="font-family:monospace">@MethodDescriptor</span></span></a></dt><dd class="dd-description">
A <em>method descriptor</em> (<a href="https://docs.oracle.com/javase/specs/jvms/se17/html/jvms-4.html#jvms-4.3.3">JVMS §4.3.3</a>) identifies a method’s signature (its parameter and return
types), just as a field descriptor identifies a
type. The method descriptor for the method
<pre class="verbatim">    Object mymethod(int i, double d, Thread t)
</pre>
is
<pre class="verbatim">    (IDLjava/lang/Thread;)Ljava/lang/Object;
</pre></dd></dl>
<!--TOC section id="signature-checks" What the Signature Checker checks-->
<h2 id="signature-checks" class="section">17.2 What the Signature Checker checks <a href="#signature-checks"><img src="chainlink.svg" width="10" height="10"></a></h2><!--SEC END --><p>Certain methods in the JDK, such as <span style="font-family:monospace">Class.forName</span>, are annotated
indicating the type they require. The Signature Checker ensures that
clients call them with the proper arguments. The Signature Checker does
not reason about string operations such as concatenation, substring,
parsing, etc.</p><p>
To run the Signature Checker, supply the
<span style="font-family:monospace">-processor org.checkerframework.checker.signature.SignatureChecker</span>
command-line option to javac.
</p><hr>
<!--TOC chapter id="guieffect-checker" GUI Effect Checker-->
<h1 id="guieffect-checker" class="chapter">Chapter ‍18 GUI Effect Checker <a href="#guieffect-checker"><img src="chainlink.svg" width="10" height="10"></a></h1><!--SEC END --><p>One of the most prevalent GUI-related bugs is <em>invalid UI update</em> or <em>invalid thread access</em>: accessing the UI directly from a
background thread.</p><p>Most GUI frameworks (including Android, AWT, Swing, and SWT) create
a single distinguished thread — the UI event thread
— that handles all GUI events and updates.
To keep the interface responsive, any expensive computation should be
offloaded to <em>background threads</em> (also called <em>worker threads</em>).
If a background thread accesses a UI
element such as a JPanel (by calling a JPanel method or reading/writing a
field of JPanel),
the GUI framework raises an exception that terminates the program.
To fix the bug, the background thread should send a request to the
UI thread to perform the access on its behalf.</p><p>It is difficult for a programmer to remember which methods may be called on
which thread(s).
The GUI Effect Checker solves this problem.
The programmer annotates each method to indicate whether:
</p><ul class="itemize"><li class="li-itemize">
It accesses no UI elements (and may run on any thread);
such a method is said to have the “safe effect”.
</li><li class="li-itemize">It may access UI elements (and must run on the UI thread);
such a method is said to have the “UI effect”.
</li></ul><p>The GUI Effect Checker verifies these effects and statically enforces that UI methods are only
called from the correct thread. A method with the safe effect is prohibited from calling a method
with the UI effect.
</p><p>For example, the effect system can reason about when method calls must be dispatched to the UI
thread via a message such as <span style="font-family:monospace">Display.syncExec</span>.
</p><pre>
@SafeEffect
public void calledFromBackgroundThreads(JLabel l) {
    l.setText("Foo");       // Error: calling a @UIEffect method from a @SafeEffect method
    Display.syncExec(new Runnable {
        @UIEffect // inferred by default
        public void run() {
            l.setText("Bar");  // OK: accessing JLabel from code run on the UI thread
        }
    });

}
</pre><p>The GUI Effect Checker’s annotations fall into three categories:</p><ul class="itemize"><li class="li-itemize">
effect annotations on methods (Section ‍<a href="#guieffect-annotations">18.1</a>),
</li><li class="li-itemize">class or package annotations controlling the default effect (Section ‍<a href="#guieffect-defaults">18.4</a>), and
</li><li class="li-itemize"><em>effect-polymorphism</em>: code that works for both the safe effect and
the UI effect (Section ‍<a href="#guieffect-polymorphism">18.5</a>).
</li></ul>
<!--TOC section id="guieffect-annotations" GUI effect annotations-->
<h2 id="guieffect-annotations" class="section">18.1 GUI effect annotations <a href="#guieffect-annotations"><img src="chainlink.svg" width="10" height="10"></a></h2><!--SEC END --><p>There are two primary GUI effect annotations:
</p><dl class="description"><dt class="dt-description">
<a href="../api/org/checkerframework/checker/guieffect/qual/SafeEffect.html"><span style="font-weight:bold"><span style="font-family:monospace">@SafeEffect</span></span></a></dt><dd class="dd-description">
is a method annotation marking code that must not
access UI objects.
</dd><dt class="dt-description"><a href="../api/org/checkerframework/checker/guieffect/qual/UIEffect.html"><span style="font-weight:bold"><span style="font-family:monospace">@UIEffect</span></span></a></dt><dd class="dd-description">
is a method annotation marking code that may access
UI objects. Most UI object methods (e.g., methods of <span style="font-family:monospace">JPanel</span>) are
annotated as <span style="font-family:monospace">@UIEffect</span>.
</dd></dl><p><span style="font-family:monospace">@SafeEffect</span> is a sub-effect of <span style="font-family:monospace">@UIEffect</span>, in that it is always safe to
call a <span style="font-family:monospace">@SafeEffect</span> method anywhere it is permitted to call a
<span style="font-family:monospace">@UIEffect</span> method. We write this relationship as</p><div class="center"><span style="font-family:monospace">@SafeEffect</span> ≺ <span style="font-family:monospace">@UIEffect</span></div>
<!--TOC section id="guieffect-checks" What the GUI Effect Checker checks-->
<h2 id="guieffect-checks" class="section">18.2 What the GUI Effect Checker checks <a href="#guieffect-checks"><img src="chainlink.svg" width="10" height="10"></a></h2><!--SEC END --><p>The GUI Effect Checker ensures that only the UI thread accesses UI objects.
This prevents GUI errors such
as invalid UI update and invalid thread access.</p><p>The GUI Effect Checker issues errors in the following cases:</p><ul class="itemize"><li class="li-itemize">
A <span style="font-family:monospace">@UIEffect</span> method is invoked by a <span style="font-family:monospace">@SafeEffect</span> method.</li><li class="li-itemize">Method declarations violate subtyping restrictions: a supertype declares
a <span style="font-family:monospace">@SafeEffect</span> method, and a subtype annotates an overriding
version as <span style="font-family:monospace">@UIEffect</span>.</li></ul><p>Additionally, if a method implements or overrides a method in two
supertypes (two interfaces, or an interface and parent class), and those
supertypes give different effects for the methods, the GUI Effect Checker
issues a warning (not an error).</p>
<!--TOC section id="guieffect-running" Running the GUI Effect Checker-->
<h2 id="guieffect-running" class="section">18.3 Running the GUI Effect Checker <a href="#guieffect-running"><img src="chainlink.svg" width="10" height="10"></a></h2><!--SEC END --><p>The GUI Effect Checker can be invoked by running the following command:
</p><pre class="verbatim">  javac -processor org.checkerframework.checker.guieffect.GuiEffectChecker MyFile.java ...
</pre>
<!--TOC section id="guieffect-defaults" Annotation defaults-->
<h2 id="guieffect-defaults" class="section">18.4 Annotation defaults <a href="#guieffect-defaults"><img src="chainlink.svg" width="10" height="10"></a></h2><!--SEC END --><p>The default method annotation is <span style="font-family:monospace">@SafeEffect</span>, since most code in most programs is not related
to the UI. This also means that typically, code that is unrelated to the UI need not be annotated
at all.</p><p>The GUI Effect Checker provides three primary ways to change the default method effect for a class
or package:
</p><dl class="description"><dt class="dt-description">
<a href="../api/org/checkerframework/checker/guieffect/qual/UIType.html"><span style="font-weight:bold"><span style="font-family:monospace">@UIType</span></span></a></dt><dd class="dd-description">
is a class annotation that makes the effect for unannotated methods in
that class default to <span style="font-family:monospace">@UIEffect</span>. (See also <span style="font-family:monospace">@UI</span> in
Section ‍<a href="#guieffect-polymorphism-using">18.5.2</a>.)
</dd><dt class="dt-description"><a href="../api/org/checkerframework/checker/guieffect/qual/UIPackage.html"><span style="font-weight:bold"><span style="font-family:monospace">@UIPackage</span></span></a></dt><dd class="dd-description">
is a <em>package</em> annotation, that makes the effect for unannotated
methods in that package default to <span style="font-family:monospace">@UIEffect</span>. It is not
transitive; a package nested inside a package marked <span style="font-family:monospace">@UIPackage</span>
does not inherit the changed default.
</dd><dt class="dt-description"><a href="../api/org/checkerframework/checker/guieffect/qual/SafeType.html"><span style="font-weight:bold"><span style="font-family:monospace">@SafeType</span></span></a></dt><dd class="dd-description">
is a class annotation that makes the effect for unannotated methods in
that class default to <span style="font-family:monospace">@SafeEffect</span>. Because <span style="font-family:monospace">@SafeEffect</span> is
already the default effect, <span style="font-family:monospace">@SafeType</span> is only useful for class
types inside a package marked <span style="font-family:monospace">@UIPackage</span>.
</dd></dl><p>There is one other place where the default annotation is not automatically <span style="font-family:monospace">@SafeEffect</span>:
anonymous inner classes. Since anonymous inner classes exist primarily for brevity, it would be
unfortunate to spoil that brevity with extra annotations. By default, an anonymous inner class
method that overrides or implements a method of the parent type inherits that method’s effect.
For example, an anonymous inner class implementing an interface with method <span style="font-family:monospace">@UIEffect void
m()</span> need not explicitly annotate its implementation of <span style="font-family:monospace">m()</span>; the implementation will inherit
the parent’s effect. Methods of the anonymous inner class that are not inherited from a parent type
follow the standard defaulting rules.</p>
<!--TOC section id="guieffect-polymorphism" Polymorphic effects-->
<h2 id="guieffect-polymorphism" class="section">18.5 Polymorphic effects <a href="#guieffect-polymorphism"><img src="chainlink.svg" width="10" height="10"></a></h2><!--SEC END --><p>Sometimes a type is reused for both UI-specific and background-thread work. A good example is the
<span style="font-family:monospace">Runnable</span> interface, which is used both for creating new background threads (in which case the
<span style="font-family:monospace">run()</span> method must have the <span style="font-family:monospace">@SafeEffect</span>) and for sending code to the UI thread to
execute (in which case the <span style="font-family:monospace">run()</span> method may have the
<span style="font-family:monospace">@UIEffect</span>). But the declaration of
<span style="font-family:monospace">Runnable.run()</span> may have only one effect annotation in the source code.
How do we reconcile these
conflicting use cases?</p><p><em>Effect-polymorphism</em> permits a type to be used for both UI and non-UI
purposes. It is similar to Java’s generics in that you define, then use, the
effect-polymorphic type.
Recall that to <em>define</em> a generic type, you write a type parameter such as
<span style="font-family:monospace">&lt;T&gt;</span> and use it in the body of the type definition; for example,
<span style="font-family:monospace">class List&lt;T&gt; </span><span style="font-family:monospace">{</span><span style="font-family:monospace"> ...  T get() </span><span style="font-family:monospace">{</span><span style="font-family:monospace">...</span><span style="font-family:monospace">}</span><span style="font-family:monospace">  ...  </span><span style="font-family:monospace">}</span>.
To <em>instantiate</em> a generic type, you write its name along with a type
argument; for example, <span style="font-family:monospace">List&lt;Date&gt; myDates;</span>.</p>
<!--TOC subsection id="guieffect-polymorphism-defining" Defining an effect-polymorphic type-->
<h3 id="guieffect-polymorphism-defining" class="subsection">18.5.1 Defining an effect-polymorphic type <a href="#guieffect-polymorphism-defining"><img src="chainlink.svg" width="10" height="10"></a></h3><!--SEC END --><p>To declare that a class is effect-polymorphic, annotate its definition with
<a href="../api/org/checkerframework/checker/guieffect/qual/PolyUIType.html"><span style="font-family:monospace">@PolyUIType</span></a>.
To use the effect variable in the class body, annotate a method with <a href="../api/org/checkerframework/checker/guieffect/qual/PolyUIEffect.html"><span style="font-family:monospace">@PolyUIEffect</span></a>.
It is an error to use <span style="font-family:monospace">@PolyUIEffect</span> in a class that is not
effect-polymorphic.</p><p>Consider the following example:</p><pre>
@PolyUIType
public interface Runnable {
    @PolyUIEffect
    void run();
}
</pre><p>This declares that class <span style="font-family:monospace">Runnable</span> is parameterized over one
generic effect, and that when <span style="font-family:monospace">Runnable</span> is instantiated, the effect
argument will be used as the effect for the <span style="font-family:monospace">run</span> method.</p>
<!--TOC subsection id="guieffect-polymorphism-using" Using an effect-polymorphic type-->
<h3 id="guieffect-polymorphism-using" class="subsection">18.5.2 Using an effect-polymorphic type <a href="#guieffect-polymorphism-using"><img src="chainlink.svg" width="10" height="10"></a></h3><!--SEC END --><p>To instantiate an effect-polymorphic type, write one of these three type
qualifiers before a use of the type:
</p><dl class="description"><dt class="dt-description">
<a href="../api/org/checkerframework/checker/guieffect/qual/AlwaysSafe.html"><span style="font-weight:bold"><span style="font-family:monospace">@AlwaysSafe</span></span></a></dt><dd class="dd-description">
instantiates the type’s effect to <span style="font-family:monospace">@SafeEffect</span>.
</dd><dt class="dt-description"><a href="../api/org/checkerframework/checker/guieffect/qual/UI.html"><span style="font-weight:bold"><span style="font-family:monospace">@UI</span></span></a></dt><dd class="dd-description">
instantiates the type’s effect to <span style="font-family:monospace">@UIEffect</span>.
<em>Additionally</em>, it changes the
default method effect for the class to <span style="font-family:monospace">@UIEffect</span>.
</dd><dt class="dt-description"><a href="../api/org/checkerframework/checker/guieffect/qual/PolyUI.html"><span style="font-weight:bold"><span style="font-family:monospace">@PolyUI</span></span></a></dt><dd class="dd-description">
instantiates the type’s
effect to <span style="font-family:monospace">@PolyUIEffect</span> for the same instantiation as the current
(containing) class. For example, this is the qualifier of the receiver
<span style="font-family:monospace">this</span> inside a method of a <span style="font-family:monospace">@PolyUIType</span> class, which is how
one method of an effect-polymorphic class may call an effect-polymorphic
method of the same class.
</dd></dl><p>As an example:</p><pre>
@AlwaysSafe Runnable s = ...;    s.run();    // s.run() is @SafeEffect
@PolyUI Runnable p = ...;        p.run();    // p.run() is @PolyUIEffect (context-dependent)
@UI Runnable u = ...;            u.run();    // u.run() is @UIEffect
</pre><p>It is an error to apply an effect instantiation qualifier to a type that is not effect-polymorphic.</p><p>Note that no annotation is required on the anonymous class declaration itself (e.g. <span style="font-family:monospace">new Runnable(){...}</span>
does not require a type use annotation, although the variable, field, or argument it ends up being assigned to might).
Instead, the GUI Effect Checker will infer the effect qualifier based on the method being called from within the
members of that specific anonymous class.</p>
<!--TOC subsection id="guieffect-subclassing" Subclassing a specific instantiation of an effect-polymorphic type-->
<h3 id="guieffect-subclassing" class="subsection">18.5.3 Subclassing a specific instantiation of an effect-polymorphic type <a href="#guieffect-subclassing"><img src="chainlink.svg" width="10" height="10"></a></h3><!--SEC END --><p>Sometimes you may wish to subclass a specific instantiation of an effect-polymorphic type, just as
you may extend <span style="font-family:monospace">List&lt;String&gt;</span>.</p><p>To do this, simply place the effect instantiation qualifier by the name of the type you are
defining, e.g.:</p><pre>
@UI
public class UIRunnable extends Runnable {...}
@AlwaysSafe
public class SafeRunnable extends Runnable {...}
</pre><p>
The GUI Effect Checker will automatically apply the qualifier to all classes and interfaces the class
being defined extends or implements. (This means you cannot write a class that is a subtype of a
<span style="font-family:monospace">@AlwaysSafe Foo</span> and a <span style="font-family:monospace">@UI Bar</span>, but this has not been a problem in our experience.)</p>
<!--TOC subsection id="guieffect-subtyping" Subtyping with polymorphic effects-->
<h3 id="guieffect-subtyping" class="subsection">18.5.4 Subtyping with polymorphic effects <a href="#guieffect-subtyping"><img src="chainlink.svg" width="10" height="10"></a></h3><!--SEC END --><p>With three effect annotations, we must extend the static sub-effecting relationship:</p><div class="center"><span style="font-family:monospace">@SafeEffect</span> ≺ <span style="font-family:monospace">@PolyUIEffect</span> ≺ <span style="font-family:monospace">@UIEffect</span></div><p>This is the correct sub-effecting relation because it is always safe to
call a <span style="font-family:monospace">@SafeEffect</span>
method (whether from an effect-polymorphic method or a UI method), and a <span style="font-family:monospace">@UIEffect</span> method
may safely call any other method.
</p><p>This induces a subtyping hierarchy on type qualifiers:</p><div class="center"><span style="font-family:monospace">@AlwaysSafe</span> ≺ <span style="font-family:monospace">@PolyUI</span> ≺ <span style="font-family:monospace">@UI</span></div><p>This is sound because a method instantiated according to any qualifier will always be
safe to call in place of a method instantiated according to one of its super-qualifiers.
This allows clients to pass “safer” instances of some object type to a given method.</p>
<!--TOC subsubsection id="guieffect-overrides" Effect polymorphism and arguments-->
<h4 id="guieffect-overrides" class="subsubsection">Effect polymorphism and arguments <a href="#guieffect-overrides"><img src="chainlink.svg" width="10" height="10"></a></h4><!--SEC END --><p>Sometimes it is useful to have <span style="font-family:monospace">@PolyUI</span> parameters on a method. As a trivial example, this
permits us to specify an identity method that works for both <span style="font-family:monospace">@UI Runnable</span> and
<span style="font-family:monospace">@AlwaysSafe Runnable</span>:</p><pre>
public @PolyUI Runnable id(@PolyUI Runnable r) {
    return r;
}
</pre><p>This use of <span style="font-family:monospace">@PolyUI</span> will be handled as is standard for polymorphic qualifiers in the Checker
Framework (see Section <a href="#method-qualifier-polymorphism">30.2</a>).</p><p><span style="font-family:monospace">@PolyUIEffect</span> methods should generally not use <span style="font-family:monospace">@PolyUI</span> arguments: it is permitted by
the framework, but its interaction with inheritance is subtle, and may not behave as you would
hope.</p><p>The shortest explanation is this: <span style="font-family:monospace">@PolyUI</span> arguments may only be overridden by <span style="font-family:monospace">@PolyUI</span>
arguments, even though the implicitly <span style="font-family:monospace">@PolyUI</span> <em>receiver</em> may be overridden with a
<span style="font-family:monospace">@AlwaysSafe</span> receiver.</p><p>As noted earlier (Section <a href="#covariant-type-parameters">30.1.6</a>), Java’s generics are invariant —
<span style="font-family:monospace">A&lt;X&gt;</span> is a subtype of <span style="font-family:monospace">B&lt;Y&gt;</span> only if <span style="font-family:monospace">X</span> is identical to <span style="font-family:monospace">Y</span>.
Class-level use of <span style="font-family:monospace">@PolyUI</span> behaves slightly differently.
Marking a type declaration <span style="font-family:monospace">@PolyUIType</span> is conceptually
equivalent to parameterizing the type by some <span style="font-family:monospace">E extends Effect</span>. But in this view,
<span style="font-family:monospace">Runnable&lt;SafeEffect&gt;</span> (really <span style="font-family:monospace">@AlwaysSafe Runnable</span>) would be considered a subtype of
<span style="font-family:monospace">Runnable&lt;UIEffect&gt;</span> (really <span style="font-family:monospace">@UI Runnable</span>), as explained earlier in this section. Java’s
generics do not permit this, which is called <em>covariant</em> subtyping in the effect parameter.
Permitting it for all generics leads to problems where a type system can miss errors. Java solves
this by making all generics invariant, which rejects more programs than strictly necessary, but
leads to an easy-to-explain limitation. For this checker, covariant subtyping of effect parameters
is very important: being able to pass an <span style="font-family:monospace">@AlwaysSafe
Runnable</span> in place of a <span style="font-family:monospace">@UI Runnable</span> is extremely useful. Since we need to allow some
cases for flexibility, but need to reject other cases to avoid missing errors, the distinction is a
bit more subtle for this checker.</p><p>Consider this small example (warning: the following is rejected by the GUI Effect Checker):</p><pre>
@PolyUIType
public interface Dispatcher {
    @PolyUIEffect
    void dispatch(@PolyUI Runnable toRun);
}
@SafeType
public class SafeDispatcher implements Dispatcher {
    @Override
    public void dispatch(@AlwaysSafe Runnable toRun) {
        runOnBackgroundThread(toRun);
    }
}
</pre><p>This may initially seem like harmless code to write, which simply specializes the implicit effect
parameter from <span style="font-family:monospace">Dispatcher</span> in the <span style="font-family:monospace">SafeDispatcher</span> implementation. However, the way
method effect polymorphism is implemented is by implicitly making the receiver of a
<span style="font-family:monospace">@PolyUIEffect</span> method — the object on which the method is invoked — <span style="font-family:monospace">@PolyUI</span>. So
if the definitions above were permitted, the following client code would be possible:</p><pre>
@AlwaysSafe SafeDispatcher s = ...;
@UI Runnable uitask = ...;
s.dispatch(uitask);
</pre><p>At the call to <span style="font-family:monospace">dispatch</span>, the Checker Framework is free to consider <span style="font-family:monospace">s</span> as its
supertype, <span style="font-family:monospace">@UI SafeDispatcher</span>. This permits the framework to choose the same qualifier for
both the (implicit) receiver use of <span style="font-family:monospace">@PolyUI</span> and the <span style="font-family:monospace">toRun</span> argument to
<span style="font-family:monospace">Dispatcher.dispatch</span>, passing the checker. But this code would then pass a UI-thread-only
task to a method which should only accept background thread tasks — exactly what the checker
should prevent!</p><p>To resolve this, the GUI Effect Checker rejects the definitions above, specifically the
<span style="font-family:monospace">@AlwaysSafe</span> on <span style="font-family:monospace">SafeDispatcher.dispatch</span>’s parameter, which would need to remain
<span style="font-family:monospace">@PolyUI</span>.</p><p>A subtlety of the code above is that the receiver for <span style="font-family:monospace">SafeDispatcher.dispatch</span> is also
overridden, switching from a <span style="font-family:monospace">@PolyUI</span> receiver to a <span style="font-family:monospace">@Safe</span> receiver. That change is
permissible. But when that is done, the polymorphic arguments may no longer be interchangeable
with the receiver.</p>
<!--TOC section id="guieffect-references" References-->
<h2 id="guieffect-references" class="section">18.6 References <a href="#guieffect-references"><img src="chainlink.svg" width="10" height="10"></a></h2><!--SEC END --><p>The ECOOP 2013 paper “JavaUI: Effects for controlling UI object
access” ‍[<a href="#GordonDEG2013">GDEG13</a>] (ECOOP 2013,
<a href="https://homes.cs.washington.edu/~mernst/pubs/gui-thread-ecoop2013-abstract.html"><span style="font-family:monospace">https://homes.cs.washington.edu/~mernst/pubs/gui-thread-ecoop2013-abstract.html</span></a>)
includes some case studies on the checker’s efficacy, including
descriptions of the relatively few false warnings we encountered. It also
contains a more formal description of the effect system.</p><hr>
<!--TOC chapter id="units-checker" Units Checker-->
<h1 id="units-checker" class="chapter">Chapter ‍19 Units Checker <a href="#units-checker"><img src="chainlink.svg" width="10" height="10"></a></h1><!--SEC END --><p>For many applications, it is important to use the correct units of
measurement for primitive types. For example, NASA’s Mars Climate Orbiter
(cost: $327 million) was lost because of a discrepancy between use
of the metric unit Newtons and the imperial measure Pound-force.</p><p>The <em>Units Checker</em> ensures consistent usage of units.
For example, consider the following code:</p><pre>
@m int meters = 5 * UnitsTools.m;
@s int secs = 2 * UnitsTools.s;
@mPERs int speed = meters / secs;
</pre><p>Due to the annotations <span style="font-family:monospace">@m</span> and <span style="font-family:monospace">@s</span>, the variables <span style="font-family:monospace">meters</span> and <span style="font-family:monospace">secs</span> are guaranteed to contain
only values with meters and seconds as units of measurement.
The assignment of an unqualified value to <span style="font-family:monospace">meters</span>, as in
<span style="font-family:monospace">meters = 99</span>, will be flagged as an error by the Units Checker.
Utility class <a href="../api/org/checkerframework/checker/units/util/UnitsTools.html"><span style="font-family:monospace">UnitsTools</span></a> provides constants
that you can multiply with unqualified integer are multiplied to get values
of the corresponding unit; for example, <span style="font-family:monospace">meters = 99 *
UnitsTools.m</span> is legal, or just <span style="font-family:monospace">meters = 99 *
m</span> if the file contains
<span style="font-family:monospace">import static org.checkerframework.checker.units.util.UnitsTools.*;</span>.
To use the <a href="../api/org/checkerframework/checker/units/util/UnitsTools.html"><span style="font-family:monospace">UnitsTools</span></a> class, the
<span style="font-family:monospace">checker-util.jar</span> file must be on the classpath at run time.</p><p>The division <span style="font-family:monospace">meters/secs</span> takes the types of the two operands
into account and determines that the result is of type
meters per second, signified by the <span style="font-family:monospace">@mPERs</span> qualifier.
We provide an extensible framework to define the result of operations
on units.</p>
<!--TOC section id="units-annotations" Units annotations-->
<h2 id="units-annotations" class="section">19.1 Units annotations <a href="#units-annotations"><img src="chainlink.svg" width="10" height="10"></a></h2><!--SEC END --><p>The checker currently supports three varieties of units annotations:
kind annotations (<a href="../api/org/checkerframework/checker/units/qual/Length.html"><span style="font-family:monospace">@Length</span></a>,
<a href="../api/org/checkerframework/checker/units/qual/Mass.html"><span style="font-family:monospace">@Mass</span></a>, …),
the SI units (<a href="../api/org/checkerframework/checker/units/qual/m.html"><span style="font-family:monospace">@m</span></a>, <a href="../api/org/checkerframework/checker/units/qual/kg.html"><span style="font-family:monospace">@kg</span></a>, …), and polymorphic annotations
(<a href="../api/org/checkerframework/checker/units/qual/PolyUnit.html"><span style="font-family:monospace">@PolyUnit</span></a>).</p><p>Kind annotations can be used to declare what the expected unit of
measurement is, without fixing the particular unit used.
For example, one could write a method taking a <span style="font-family:monospace">@Length</span> value,
without specifying whether it will take meters or kilometers.
The following kind annotations are defined:</p><dl class="description"><dt class="dt-description">
<a href="../api/org/checkerframework/checker/units/qual/Acceleration.html"><span style="font-weight:bold"><span style="font-family:monospace">@Acceleration</span></span></a></dt><dd class="dd-description"></dd><dt class="dt-description"><a href="../api/org/checkerframework/checker/units/qual/Angle.html"><span style="font-weight:bold"><span style="font-family:monospace">@Angle</span></span></a></dt><dd class="dd-description"></dd><dt class="dt-description"><a href="../api/org/checkerframework/checker/units/qual/Area.html"><span style="font-weight:bold"><span style="font-family:monospace">@Area</span></span></a></dt><dd class="dd-description"></dd><dt class="dt-description"><a href="../api/org/checkerframework/checker/units/qual/Current.html"><span style="font-weight:bold"><span style="font-family:monospace">@Current</span></span></a></dt><dd class="dd-description"></dd><dt class="dt-description"><a href="../api/org/checkerframework/checker/units/qual/Force.html"><span style="font-weight:bold"><span style="font-family:monospace">@Force</span></span></a></dt><dd class="dd-description"></dd><dt class="dt-description"><a href="../api/org/checkerframework/checker/units/qual/Length.html"><span style="font-weight:bold"><span style="font-family:monospace">@Length</span></span></a></dt><dd class="dd-description"></dd><dt class="dt-description"><a href="../api/org/checkerframework/checker/units/qual/Luminance.html"><span style="font-weight:bold"><span style="font-family:monospace">@Luminance</span></span></a></dt><dd class="dd-description"></dd><dt class="dt-description"><a href="../api/org/checkerframework/checker/units/qual/Mass.html"><span style="font-weight:bold"><span style="font-family:monospace">@Mass</span></span></a></dt><dd class="dd-description"></dd><dt class="dt-description"><a href="../api/org/checkerframework/checker/units/qual/Speed.html"><span style="font-weight:bold"><span style="font-family:monospace">@Speed</span></span></a></dt><dd class="dd-description"></dd><dt class="dt-description"><a href="../api/org/checkerframework/checker/units/qual/Substance.html"><span style="font-weight:bold"><span style="font-family:monospace">@Substance</span></span></a></dt><dd class="dd-description"></dd><dt class="dt-description"><a href="../api/org/checkerframework/checker/units/qual/Temperature.html"><span style="font-weight:bold"><span style="font-family:monospace">@Temperature</span></span></a></dt><dd class="dd-description"></dd><dt class="dt-description"><a href="../api/org/checkerframework/checker/units/qual/Time.html"><span style="font-weight:bold"><span style="font-family:monospace">@Time</span></span></a></dt><dd class="dd-description"></dd><dt class="dt-description"><a href="../api/org/checkerframework/checker/units/qual/Volume.html"><span style="font-weight:bold"><span style="font-family:monospace">@Volume</span></span></a></dt><dd class="dd-description">
</dd></dl><p>For each kind of unit, the corresponding SI unit of
measurement is defined:</p><ol class="enumerate" type=1><li class="li-enumerate">
For <span style="font-family:monospace">@Acceleration</span>:
Meter Per Second Square <a href="../api/org/checkerframework/checker/units/qual/mPERs2.html"><span style="font-family:monospace">@mPERs2</span></a></li><li class="li-enumerate">For <span style="font-family:monospace">@Angle</span>:
Radians <a href="../api/org/checkerframework/checker/units/qual/radians.html"><span style="font-family:monospace">@radians</span></a>,
and the derived unit
Degrees <a href="../api/org/checkerframework/checker/units/qual/degrees.html"><span style="font-family:monospace">@degrees</span></a></li><li class="li-enumerate">For <span style="font-family:monospace">@Area</span>:
the derived units
square millimeters <a href="../api/org/checkerframework/checker/units/qual/mm2.html"><span style="font-family:monospace">@mm2</span></a>,
square meters <a href="../api/org/checkerframework/checker/units/qual/m2.html"><span style="font-family:monospace">@m2</span></a>, and
square kilometers <a href="../api/org/checkerframework/checker/units/qual/km2.html"><span style="font-family:monospace">@km2</span></a></li><li class="li-enumerate">For <span style="font-family:monospace">@Current</span>:
Ampere <a href="../api/org/checkerframework/checker/units/qual/A.html"><span style="font-family:monospace">@A</span></a></li><li class="li-enumerate">For <span style="font-family:monospace">@Force</span>:
Newton <a href="../api/org/checkerframework/checker/units/qual/N.html"><span style="font-family:monospace">@N</span></a>
and the derived unit
kilonewton <a href="../api/org/checkerframework/checker/units/qual/kN.html"><span style="font-family:monospace">@kN</span></a></li><li class="li-enumerate">For <span style="font-family:monospace">@Length</span>:
Meters <a href="../api/org/checkerframework/checker/units/qual/m.html"><span style="font-family:monospace">@m</span></a>
and the derived units
millimeters <a href="../api/org/checkerframework/checker/units/qual/mm.html"><span style="font-family:monospace">@mm</span></a> and
kilometers <a href="../api/org/checkerframework/checker/units/qual/km.html"><span style="font-family:monospace">@km</span></a></li><li class="li-enumerate">For <span style="font-family:monospace">@Luminance</span>:
Candela <a href="../api/org/checkerframework/checker/units/qual/cd.html"><span style="font-family:monospace">@cd</span></a></li><li class="li-enumerate">For <span style="font-family:monospace">@Mass</span>:
kilograms <a href="../api/org/checkerframework/checker/units/qual/kg.html"><span style="font-family:monospace">@kg</span></a>
and the derived units
grams <a href="../api/org/checkerframework/checker/units/qual/g.html"><span style="font-family:monospace">@g</span></a> and
metric tons <a href="../api/org/checkerframework/checker/units/qual/t.html"><span style="font-family:monospace">@t</span></a></li><li class="li-enumerate">For <span style="font-family:monospace">@Speed</span>:
meters per second <a href="../api/org/checkerframework/checker/units/qual/mPERs.html"><span style="font-family:monospace">@mPERs</span></a> and
kilometers per hour <a href="../api/org/checkerframework/checker/units/qual/kmPERh.html"><span style="font-family:monospace">@kmPERh</span></a></li><li class="li-enumerate">For <span style="font-family:monospace">@Substance</span>:
Mole <a href="../api/org/checkerframework/checker/units/qual/mol.html"><span style="font-family:monospace">@mol</span></a></li><li class="li-enumerate">For <span style="font-family:monospace">@Temperature</span>:
Kelvin <a href="../api/org/checkerframework/checker/units/qual/K.html"><span style="font-family:monospace">@K</span></a>
and the derived unit
Celsius <a href="../api/org/checkerframework/checker/units/qual/C.html"><span style="font-family:monospace">@C</span></a></li><li class="li-enumerate">For <span style="font-family:monospace">@Time</span>:
seconds <a href="../api/org/checkerframework/checker/units/qual/s.html"><span style="font-family:monospace">@s</span></a>
and the derived units
minutes <a href="../api/org/checkerframework/checker/units/qual/min.html"><span style="font-family:monospace">@min</span></a> and
hours <a href="../api/org/checkerframework/checker/units/qual/h.html"><span style="font-family:monospace">@h</span></a></li><li class="li-enumerate">For <span style="font-family:monospace">@Volume</span>:
the derived units
cubic millimeters <a href="../api/org/checkerframework/checker/units/qual/mm3.html"><span style="font-family:monospace">@mm3</span></a>,
cubic meters <a href="../api/org/checkerframework/checker/units/qual/m3.html"><span style="font-family:monospace">@m3</span></a>, and
cubic kilometers <a href="../api/org/checkerframework/checker/units/qual/km3.html"><span style="font-family:monospace">@km3</span></a>
</li></ol><p>You may specify SI unit prefixes, using enumeration <a href="../api/org/checkerframework/checker/units/qual/Prefix.html"><span style="font-family:monospace">Prefix</span></a>.
The basic SI units
(<span style="font-family:monospace">@s</span>, <span style="font-family:monospace">@m</span>, <span style="font-family:monospace">@g</span>, <span style="font-family:monospace">@A</span>, <span style="font-family:monospace">@K</span>,
<span style="font-family:monospace">@mol</span>, <span style="font-family:monospace">@cd</span>)
take an optional <span style="font-family:monospace">Prefix</span> enum as argument.
For example, to use nanoseconds as unit, you could use
<span style="font-family:monospace">@s(Prefix.nano)</span> as a unit type.
You can sometimes use a different annotation instead of a prefix;
for example, <span style="font-family:monospace">@mm</span> is equivalent to <span style="font-family:monospace">@m(Prefix.milli)</span>.</p><p>Class <span style="font-family:monospace">UnitsTools</span> contains a constant for each SI unit.
To create a value of the particular unit, multiply an unqualified
value with one of these constants.
By using static imports, this allows very natural notation; for
example, after statically importing <span style="font-family:monospace">UnitsTools.m</span>,
the expression <span style="font-family:monospace">5 * m</span> represents five meters.
As all these unit constants are public, static, and final with value
one, the compiler will optimize away these multiplications.
To use the <a href="../api/org/checkerframework/checker/units/util/UnitsTools.html"><span style="font-family:monospace">UnitsTools</span></a> class, the
<span style="font-family:monospace">checker-util.jar</span> file must be on the classpath at run time.</p><p>The polymorphic annotation <a href="../api/org/checkerframework/checker/units/qual/PolyUnit.html"><span style="font-family:monospace">@PolyUnit</span></a>
enables you to write a method that takes an argument of any unit type and
returns a result of that same type. For more about polymorphic qualifiers,
see Section ‍<a href="#method-qualifier-polymorphism">30.2</a>. For an example of its use, see
the
<a href="../api/org/checkerframework/checker/units/qual/PolyUnit.html"><span style="font-family:monospace">@PolyUnit</span>
Javadoc</a>.</p>
<!--TOC section id="extending-units" Extending the Units Checker-->
<h2 id="extending-units" class="section">19.2 Extending the Units Checker <a href="#extending-units"><img src="chainlink.svg" width="10" height="10"></a></h2><!--SEC END --><p>You can create new kind annotations and unit annotations that are specific
to the particular needs of your project. An easy way to do this is by
copying and adapting an existing annotation. (In addition, search for all
uses of the annotation’s name throughout the Units Checker implementation,
to find other code to adapt; read on for details.)</p><p>Here is an example of a new unit annotation.</p><pre>
@Documented
@Retention(RetentionPolicy.RUNTIME)
@Target({ElementType.TYPE_USE, ElementType.TYPE_PARAMETER})
@SubtypeOf(<span style="font-family:monospace">{</span>Time.class<span style="font-family:monospace">}</span>)
@UnitsMultiple(quantity=s.class, prefix=Prefix.nano)
public @interface ns <span style="font-family:monospace">{</span><span style="font-family:monospace">}</span>
</pre><p>The <span style="font-family:monospace">@SubtypeOf</span> meta-annotation specifies that this annotation
introduces an additional unit of time.
The <span style="font-family:monospace">@UnitsMultiple</span> meta-annotation specifies that this annotation
should be a nano multiple of the basic unit <span style="font-family:monospace">@s</span>: <span style="font-family:monospace">@ns</span> and
<span style="font-family:monospace">@s(Prefix.nano)</span>
behave equivalently and interchangeably.
Most annotation definitions do not have a <span style="font-family:monospace">@UnitsMultiple</span> meta-annotation.</p><p>Note that all custom annotations must have the
<span style="font-family:monospace">@Target(ElementType.TYPE_USE)</span> meta-annotation. See section
<a href="#creating-define-type-qualifiers">35.5.1</a>.</p><p>To take full advantage of the additional unit qualifier, you need to
do two additional steps.
(1) ‍Provide constants that convert from unqualified types to types that use
the new unit.
See class <span style="font-family:monospace">UnitsTools</span> for examples (you will need to suppress a
checker warning in just those few locations).
(2) ‍Put the new unit in relation to existing units.
Provide an
implementation of the <span style="font-family:monospace">UnitsRelations</span> interface as a
meta-annotation to one of the units.</p><p>See demonstration <span style="font-family:monospace">docs/examples/units-extension/</span> for an example
extension that defines Hertz (hz) as scalar per second, and defines an
implementation of <span style="font-family:monospace">UnitsRelations</span> to enforce it.</p>
<!--TOC section id="units-checks" What the Units Checker checks-->
<h2 id="units-checks" class="section">19.3 What the Units Checker checks <a href="#units-checks"><img src="chainlink.svg" width="10" height="10"></a></h2><!--SEC END --><p>The Units Checker ensures that unrelated types are not mixed.</p><p>All types with a particular unit annotation are
disjoint from all unannotated types, from all types with a different unit
annotation, and from all types with the same unit annotation but a
different prefix.</p><p>Subtyping between the units and the unit kinds is taken into account,
as is the <span style="font-family:monospace">@UnitsMultiple</span> meta-annotation.</p><p>Multiplying a scalar with a unit type results in the same unit type.</p><p>The division of a unit type by the same unit type
results in the unqualified type.</p><p>Multiplying or dividing different unit types, for which no unit
relation is known to the system, will result in a <span style="font-family:monospace">MixedUnits</span>
type, which is separate from all other units.
If you encounter a <span style="font-family:monospace">MixedUnits</span> annotation in an error message,
ensure that your operations are performed on correct units or refine
your <span style="font-family:monospace">UnitsRelations</span> implementation.</p><p>The Units Checker does <em>not</em> change units based on multiplication; for
example, if variable <span style="font-family:monospace">mass</span> has the type <span style="font-family:monospace">@kg double</span>, then <span style="font-family:monospace">mass *
1000</span> has that same type rather than the type <span style="font-family:monospace">@g double</span>. (The Units
Checker has no way of knowing whether you intended a conversion, or you
were computing the mass of 1000 items. You need to make all conversions
explicit in your code, and it’s good style to minimize the number of
conversions.)</p>
<!--TOC section id="units-running" Running the Units Checker-->
<h2 id="units-running" class="section">19.4 Running the Units Checker <a href="#units-running"><img src="chainlink.svg" width="10" height="10"></a></h2><!--SEC END --><p>The Units Checker can be invoked by running the following commands.</p><ul class="itemize"><li class="li-itemize">
If your code uses only the SI units that are provided by the
framework, simply invoke the checker:<pre class="verbatim">  javac -processor org.checkerframework.checker.units.UnitsChecker MyFile.java ...
</pre></li><li class="li-itemize">If you define your own units, provide the fully-qualified class names of the
annotations through the <span style="font-family:monospace">-Aunits</span> option, using a comma-no-space-separated
notation:<pre>
  javac -classpath <span style="font-style:italic">/full/path/to/myProject/bin</span>:<span style="font-style:italic">/full/path/to/myLibrary/bin</span> <span style="font-family:monospace">\</span>
        -processor org.checkerframework.checker.units.UnitsChecker <span style="font-family:monospace">\</span>
        -Aunits=<span style="font-style:italic">myPackage.qual.MyUnit</span>,<span style="font-style:italic">myPackage.qual.MyOtherUnit</span> MyFile.java ...
</pre><p>The annotations listed in <span style="font-family:monospace">-Aunits</span> must be accessible to
the compiler during compilation. Before you run the Units Checker with
<span style="font-family:monospace">javac</span>, they must be compiled and on the same path (the classpath or
processorpath) as the Checker Framework. It
is not sufficient to supply their source files on the command line.</p></li><li class="li-itemize">You can also provide the fully-qualified paths to a set of directories
that contain units qualifiers through the <span style="font-family:monospace">-AunitsDirs</span> option,
using a colon-no-space-separated notation. For example,
if the Checker Framework is on the classpath rather than the processorpath:<pre>
  javac -classpath <span style="font-style:italic">/full/path/to/myProject/bin</span>:<span style="font-style:italic">/full/path/to/myLibrary/bin</span> <span style="font-family:monospace">\</span>
        -processor org.checkerframework.checker.units.UnitsChecker <span style="font-family:monospace">\</span>
        -AunitsDirs=<span style="font-style:italic">/full/path/to/myProject/bin</span>:<span style="font-style:italic">/full/path/to/myLibrary/bin</span> MyFile.java ...
</pre><p>Note that in these two examples, the compiled class file of the
<span style="font-family:monospace">myPackage.qual.MyUnit</span> and <span style="font-family:monospace">myPackage.qual.MyOtherUnit</span> annotations
must exist in either the <span style="font-family:monospace">myProject/bin</span> directory or the
<span style="font-family:monospace">myLibrary/bin</span> directory. The following placement of the class files
will work with the above commands:</p><pre>
  .../myProject/bin/myPackage/qual/MyUnit.class
  .../myProject/bin/myPackage/qual/MyOtherUnit.class
</pre><p>The two options can be used at the same time to provide groups of annotations
from directories, and individually named annotations.</p></li></ul><p>Also, see the example project in the <span style="font-family:monospace">docs/examples/units-extension</span> directory.</p>
<!--TOC section id="units-suppressing" Suppressing warnings-->
<h2 id="units-suppressing" class="section">19.5 Suppressing warnings <a href="#units-suppressing"><img src="chainlink.svg" width="10" height="10"></a></h2><!--SEC END --><p>One example of when you need to suppress warnings is when you
initialize a variable with a unit type by a literal value.
To remove this warning message, it is best to introduce a
constant that represents the unit and to
add a <span style="font-family:monospace">@SuppressWarnings</span>
annotation to that constant.
For examples, see class <span style="font-family:monospace">UnitsTools</span>.</p>
<!--TOC section id="units-references" References-->
<h2 id="units-references" class="section">19.6 References <a href="#units-references"><img src="chainlink.svg" width="10" height="10"></a></h2><!--SEC END --><ul class="itemize"><li class="li-itemize">
The GNU Units tool provides a comprehensive list of units:<br>
 <a href="https://www.gnu.org/software/units/"><span style="font-family:monospace">https://www.gnu.org/software/units/</span></a></li><li class="li-itemize">The F# units of measurement system inspired some of our syntax:<br>
 <a href="https://en.wikibooks.org/wiki/F_Sharp_Programming/Units_of_Measure"><span style="font-family:monospace">https://en.wikibooks.org/wiki/F_Sharp_Programming/Units_of_Measure</span></a></li></ul><hr>
<!--TOC chapter id="signedness-checker" Signedness Checker-->
<h1 id="signedness-checker" class="chapter">Chapter ‍20 Signedness Checker <a href="#signedness-checker"><img src="chainlink.svg" width="10" height="10"></a></h1><!--SEC END --><p>The Signedness Checker guarantees that signed and unsigned integral values are not mixed
together in a computation. In addition, it prohibits meaningless operations, such
as division on an unsigned value.</p><p>Recall that a computer represents a number as a sequence of bits.
Signedness indicates how to interpret the most significant bit. For
example, the bits <span style="font-family:monospace">10000010</span> ordinarily represent the value -126, but when
interpreted as unsigned, those bits represent the value 130. The bits
<span style="font-family:monospace">01111110</span> represent the value 126 in signed and in unsigned interpretation.
The range of signed byte values is -128 to 127. The range of unsigned byte
values is 0 to 255.</p><p>Signedness is only applicable to the integral types <span style="font-family:monospace">byte</span>,
<span style="font-family:monospace">short</span>, <span style="font-family:monospace">int</span>, and <span style="font-family:monospace">long</span> and their boxed variants <span style="font-family:monospace">Byte</span>,
<span style="font-family:monospace">Short</span>, <span style="font-family:monospace">Integer</span>, and <span style="font-family:monospace">Long</span>.
<span style="font-family:monospace">char</span> and <span style="font-family:monospace">Character</span> are always unsigned.
Floating-point types <span style="font-family:monospace">float</span>, <span style="font-family:monospace">double</span>, <span style="font-family:monospace">Float</span>, and <span style="font-family:monospace">Double</span> are always signed.
</p><p>Signedness is primarily about how the bits of the representation are
<em>interpreted</em>, not about the values that it can represent. An unsigned value
is always non-negative, but just because a variable’s value is non-negative does
not mean that it should be marked as <span style="font-family:monospace">@Unsigned</span>. If variable <span style="font-style:italic">v</span> will be
compared to a signed value, or used in arithmetic operations with a signed
value, then <span style="font-style:italic">v</span> should have signed type.
To indicate the range of possible values for a variable, use the
<a href="../api/org/checkerframework/checker/index/qual/NonNegative.html"><span style="font-family:monospace">@NonNegative</span></a> annotation of the Index
Checker (see Chapter ‍<a href="#index-checker">12</a>) or the
<a href="../api/org/checkerframework/common/value/qual/IntRange.html"><span style="font-family:monospace">@IntRange</span></a> annotation of the Constant Value
Checker (see Chapter ‍<a href="#constant-value-checker">22</a>).</p><p>Additional details appear in the paper
“Preventing signedness errors in numerical computations in
Java” ‍[<a href="#Mackie2016">Mac16</a>] (FSE 2016).</p><p>To run the Signedness Checker, run javac with
<span style="font-family:monospace">-processor org.checkerframework.checker.signedness.SignednessChecker</span>.</p>
<!--TOC section id="signedness-checker-annotations" Annotations-->
<h2 id="signedness-checker-annotations" class="section">20.1 Annotations <a href="#signedness-checker-annotations"><img src="chainlink.svg" width="10" height="10"></a></h2><!--SEC END --><p>The Signedness Checker uses type annotations to indicate the signedness that the programmer intends an expression to have.</p><blockquote class="figure"><div class="center"><hr class="floatrule"></div>
<div class="center">
<img src="signedness.svg">
</div>
<div class="caption"><table style="border-spacing:6px;border-collapse:separate;" class="cellpading0"><tr><td style="vertical-align:top;text-align:left;" >Figure 20.1: The type qualifier hierarchy of the signedness annotations.
Qualifiers in gray are used internally by the type system but should never be written by a programmer.</td></tr>
</table></div>
<a id="fig-signedness-hierarchy"></a>
<div class="center"><hr class="floatrule"></div></blockquote><p>These are the qualifiers in the signedness type system:</p><dl class="description"><dt class="dt-description"><a href="../api/org/checkerframework/checker/signedness/qual/Unsigned.html"><span style="font-weight:bold"><span style="font-family:monospace">@Unsigned</span></span></a></dt><dd class="dd-description">
indicates that the programmer intends the value to be
interpreted as unsigned.
That is, if the most significant bit in the bitwise representation is
set, then the bits should be interpreted as a large positive value.</dd><dt class="dt-description"><a href="../api/org/checkerframework/checker/signedness/qual/Signed.html"><span style="font-weight:bold"><span style="font-family:monospace">@Signed</span></span></a></dt><dd class="dd-description">
indicates that the programmer intends the value to be
interpreted as signed.
That is, if the most significant bit in the bitwise representation is
set, then the bits should be interpreted as a negative value.
This is the default annotation.</dd><dt class="dt-description"><a href="../api/org/checkerframework/checker/signedness/qual/SignedPositive.html"><span style="font-weight:bold"><span style="font-family:monospace">@SignedPositive</span></span></a></dt><dd class="dd-description">
indicates that a value is known at compile time to be in the non-negative
signed range, so it has the same interpretation as signed or unsigned
and may be used with either interpretation. (Equivalently, the most
significant bit is guaranteed to be 0.) Programmers should usually
write <a href="../api/org/checkerframework/checker/signedness/qual/Signed.html"><span style="font-family:monospace">@Signed</span></a> or
<a href="../api/org/checkerframework/checker/signedness/qual/Unsigned.html"><span style="font-family:monospace">@Unsigned</span></a> instead.</dd><dt class="dt-description"><a href="../api/org/checkerframework/checker/signedness/qual/SignedPositiveFromUnsigned.html"><span style="font-weight:bold"><span style="font-family:monospace">@SignedPositiveFromUnsigned</span></span></a></dt><dd class="dd-description">
indicates that a value is in the non-negative signed range, as with
<a href="../api/org/checkerframework/checker/signedness/qual/SignedPositive.html"><span style="font-family:monospace">@SignedPositive</span></a>. Furthermore,
the value was derived from values that can be interpreted as
<a href="../api/org/checkerframework/checker/signedness/qual/Unsigned.html"><span style="font-family:monospace">@Unsigned</span></a>. Programmers should
rarely write this annotation.</dd><dt class="dt-description"><a href="../api/org/checkerframework/checker/signedness/qual/SignednessGlb.html"><span style="font-weight:bold"><span style="font-family:monospace">@SignednessGlb</span></span></a></dt><dd class="dd-description">
indicates that a value may be interpreted as unsigned or signed. It
covers the same cases as
<a href="../api/org/checkerframework/checker/signedness/qual/SignedPositive.html"><span style="font-family:monospace">@SignedPositive</span></a>, plus manifest literals, to
prevent the programmer from having to annotate them all explicitly.
<em>Programmers should rarely write this annotation,
except on fields whose value is a negative manifest literal.</em></dd><dt class="dt-description"><a href="../api/org/checkerframework/checker/signedness/qual/PolySigned.html"><span style="font-weight:bold"><span style="font-family:monospace">@PolySigned</span></span></a></dt><dd class="dd-description">
indicates qualifier polymorphism.
When two formal parameter types are annotated with
<a href="../api/org/checkerframework/checker/signedness/qual/PolySigned.html"><span style="font-family:monospace">@PolySigned</span></a>, the two arguments
at a call site
must have the same signedness type annotation. (This differs from the
standard rule for polymorphic qualifiers.)
For a description of qualifier polymorphism, see
Section ‍<a href="#method-qualifier-polymorphism">30.2</a>.</dd><dt class="dt-description"><a href="../api/org/checkerframework/checker/signedness/qual/UnknownSignedness.html"><span style="font-weight:bold"><span style="font-family:monospace">@UnknownSignedness</span></span></a></dt><dd class="dd-description">
indicates that a value’s type is not relevant or known to this checker.
This annotation is used internally, and should not be
written by the programmer.</dd><dt class="dt-description"><a href="../api/org/checkerframework/checker/signedness/qual/SignednessBottom.html"><span style="font-weight:bold"><span style="font-family:monospace">@SignednessBottom</span></span></a></dt><dd class="dd-description">
indicates that the value is <span style="font-family:monospace">null</span>.
This annotation is used internally, and should not
be written by the programmer.</dd></dl>
<!--TOC subsection id="signedness-checker-annotations-default-qualifiers" Default qualifiers-->
<h3 id="signedness-checker-annotations-default-qualifiers" class="subsection">20.1.1 Default qualifiers <a href="#signedness-checker-annotations-default-qualifiers"><img src="chainlink.svg" width="10" height="10"></a></h3><!--SEC END --><p>The only type qualifier that the programmer should need to write is
<a href="../api/org/checkerframework/checker/signedness/qual/Unsigned.html"><span style="font-family:monospace">@Unsigned</span></a>.
When a programmer leaves an expression unannotated, the
Signedness Checker treats it in one of the following ways:</p><ul class="itemize"><li class="li-itemize">All <span style="font-family:monospace">byte</span>, <span style="font-family:monospace">short</span>, <span style="font-family:monospace">int</span>, and <span style="font-family:monospace">long</span> literals default
to <a href="../api/org/checkerframework/checker/signedness/qual/SignednessGlb.html"><span style="font-family:monospace">@SignednessGlb</span></a>.
</li><li class="li-itemize">All <span style="font-family:monospace">char</span> and <span style="font-family:monospace">Character</span> expressions default to
<a href="../api/org/checkerframework/checker/signedness/qual/Unsigned.html"><span style="font-family:monospace">@Unsigned</span></a>.
</li><li class="li-itemize">All <span style="font-family:monospace">char</span> and <span style="font-family:monospace">Character</span> variables default to
<a href="../api/org/checkerframework/checker/signedness/qual/Unsigned.html"><span style="font-family:monospace">@Unsigned</span></a>.
</li><li class="li-itemize">All other expressions default to <a href="../api/org/checkerframework/checker/signedness/qual/Signed.html"><span style="font-family:monospace">@Signed</span></a>.</li></ul>
<!--TOC section id="signedness-checker-prohibited-operations" Prohibited operations-->
<h2 id="signedness-checker-prohibited-operations" class="section">20.2 Prohibited operations <a href="#signedness-checker-prohibited-operations"><img src="chainlink.svg" width="10" height="10"></a></h2><!--SEC END --><p>The Signedness Checker prohibits the following uses of operators:</p><ul class="itemize"><li class="li-itemize">Division (<span style="font-family:monospace">/</span>) or modulus (<span style="font-family:monospace">%</span>) with an <span style="font-family:monospace">@Unsigned</span>
operand.
</li><li class="li-itemize">Signed right shift (<code class="verb">&gt;&gt;</code>) with an <span style="font-family:monospace">@Unsigned</span> left operand.
</li><li class="li-itemize">Unsigned right shift (<code class="verb">&gt;&gt;&gt;</code>) with a <span style="font-family:monospace">@Signed</span> left operand.
</li><li class="li-itemize">Greater/less than (or equal) comparators
(<span style="font-family:monospace">&lt;</span>, <span style="font-family:monospace">&lt;=</span>, <span style="font-family:monospace">&gt;</span>, <span style="font-family:monospace">&gt;=</span>) with an <span style="font-family:monospace">@Unsigned</span>
operand.
</li><li class="li-itemize">Any other binary operator with one <span style="font-family:monospace">@Unsigned</span> operand and one
<span style="font-family:monospace">@Signed</span> operand, with the exception of left shift (<code class="verb">&lt;&lt;</code>).</li></ul><p>There are some special cases where these operations are permitted; see
Section ‍<a href="#signedness-checker-permitted-shifts">20.2.2</a>.</p><p>Like every type-checker built with the Checker Framework, the Signedness
Checker ensures that assignments and pseudo-assignments have consistent types.
For example, it is not permitted to assign a <span style="font-family:monospace">@Signed</span> expression to an
<span style="font-family:monospace">@Unsigned</span> variable or vice versa.</p>
<!--TOC subsection id="signedness-checker-rationale" Rationale-->
<h3 id="signedness-checker-rationale" class="subsection">20.2.1 Rationale <a href="#signedness-checker-rationale"><img src="chainlink.svg" width="10" height="10"></a></h3><!--SEC END --><p>The Signedness Checker prevents misuse of unsigned values in Java code.
Most Java operations interpret operands as signed. If applied to unsigned
values, those operations would produce unexpected, incorrect results.</p><p>Consider the following Java code:</p><pre class="verbatim">public class SignednessManualExample {

    int s1 = -2;
    int s2 = -1;

    @Unsigned int u1 = 2147483646; // unsigned: 2^32 - 2, signed: -2
    @Unsigned int u2 = 2147483647; // unsigned: 2^32 - 1, signed: -1

    void m() {
        int w = s1 / s2; // OK: result is 2, which is correct for -2 / -1
        int x = u1 / u2; // ERROR: result is 2, which is incorrect for (2^32 - 2) / (2^32 - 1)
    }

    int s3 = -1;
    int s4 = 5;

    @Unsigned int u3 = 2147483647; // unsigned: 2^32 - 1, signed: -1
    @Unsigned int u4 = 5;

    void m2() {
        int y = s3 % s4; // OK: result is -1, which is correct for -1 % 5
        int z = u3 % u4; // ERROR: result is -1, which is incorrect for (2^32 - 1) % 5 = 2
    }
}
</pre><p>These examples illustrate why division and modulus with an unsigned operand
are illegal. Other uses of operators are prohibited for similar reasons.</p>
<!--TOC subsection id="signedness-checker-permitted-shifts" Permitted shifts-->
<h3 id="signedness-checker-permitted-shifts" class="subsection">20.2.2 Permitted shifts <a href="#signedness-checker-permitted-shifts"><img src="chainlink.svg" width="10" height="10"></a></h3><!--SEC END --><p>As exceptions to the rules given above, the Signedness Checker permits
certain right shifts which are immediately followed by a cast or
masking operation.</p><p>For example, right shift by 8 then mask by 0xFF evaluates to the same value
whether the argument is interpreted as signed or unsigned. Thus, the
Signedness Checker permits both <code class="verb">((myInt &gt;&gt; 8) &amp; 0xFF)</code> and
<code class="verb">((myInt &gt;&gt;&gt; 8) &amp; 0xFF)</code>, regardless of the qualifier on the type of
<span style="font-family:monospace">myInt</span>.</p><p>Likewise, right shift by 8 then cast to byte evaluates to the
same value whether the argument is interpreted as signed or unsigned, so
the Signedness Checker permits both <code class="verb">(byte) (myInt &gt;&gt; 8)</code> and
<code class="verb">(byte) (myInt &gt;&gt;&gt; 8)</code>, regardless of the type of <span style="font-family:monospace">myInt</span>.</p>
<!--TOC section id="signedness-utilities" Utility routines for manipulating unsigned values-->
<h2 id="signedness-utilities" class="section">20.3 Utility routines for manipulating unsigned values <a href="#signedness-utilities"><img src="chainlink.svg" width="10" height="10"></a></h2><!--SEC END --><p>Class <a href="../api/org/checkerframework/checker/signedness/util/SignednessUtil.html"><span style="font-family:monospace">SignednessUtil</span></a> provides static
utility methods for working with unsigned values. They are
properly annotated with <a href="../api/org/checkerframework/checker/signedness/qual/Unsigned.html"><span style="font-family:monospace">@Unsigned</span></a>
where appropriate, so using them may reduce the number of annotations that
you need to write.
To use the <a href="../api/org/checkerframework/checker/signedness/util/SignednessUtil.html"><span style="font-family:monospace">SignednessUtil</span></a> class, the
<span style="font-family:monospace">checker-util.jar</span> file must be on the classpath at run time.</p><p>Class <a href="../api/org/checkerframework/checker/signedness/util/SignednessUtilExtra.html"><span style="font-family:monospace">SignednessUtilExtra</span></a> contains more utility
methods that reference packages not included in Android. This class is not
included in <span style="font-family:monospace">checker-util.jar</span>, so you may want to copy the methods to your code.</p>
<!--TOC section id="signedness-refinement" Local type refinement-->
<h2 id="signedness-refinement" class="section">20.4 Local type refinement <a href="#signedness-refinement"><img src="chainlink.svg" width="10" height="10"></a></h2><!--SEC END --><p>Local type refinement/inference (Section ‍<a href="#type-refinement">31.7</a>) may be
surprising for the Signedness type system. Ordinarily, an expression with
unsigned type may not participate in a division, as shown in
Sections ‍<a href="#signedness-checker-prohibited-operations">20.2</a>
and ‍<a href="#signedness-checker-rationale">20.2.1</a>. However, if a constant is assigned
to a variable that was declared with <span style="font-family:monospace">@Unsigned</span> type, then — just like
the constant — the variable may be treated as either signed or unsigned,
due to local type refinement (Section ‍<a href="#type-refinement">31.7</a>).
For example, it can participate in division.</p><pre class="verbatim">    void useLocalVariables() {

        int s1 = -2;
        int s2 = -1;

        @Unsigned int u1 = 2147483646; // unsigned: 2^32 - 2, signed: -2
        @Unsigned int u2 = 2147483647; // unsigned: 2^32 - 1, signed: -1

        int w = s1 / s2; // OK: result is 2, which is correct for -2 / -1
        int x = u1 / u2; // OK; computation over constants, interpreted as signed; result is signed
    }
</pre><p>To prevent local type refinement, use a cast:
</p><pre class="verbatim">        @Unsigned int u1 = (@Unsigned int) 2147483646;
</pre><p>Note that type-checking produces a different result for <span style="font-family:monospace">int x = u1 / u2;</span>
here than in the similar example in
Section ‍<a href="#signedness-checker-rationale">20.2.1</a>. In
Section ‍<a href="#signedness-checker-rationale">20.2.1</a>, the method is reading fields,
and all it knows is the declared type of the field. In 20.4, the method is
reading a local variable, and dataflow (that is, flow-sensitive type
refinement) refines the types of local variables.</p>
<!--TOC section id="signedness-instantiating-polymorphism" Instantiating polymorphism-->
<h2 id="signedness-instantiating-polymorphism" class="section">20.5 Instantiating polymorphism <a href="#signedness-instantiating-polymorphism"><img src="chainlink.svg" width="10" height="10"></a></h2><!--SEC END --><p>When calling a method with formal parameters annotated as
<a href="../api/org/checkerframework/checker/signedness/qual/PolySigned.html"><span style="font-family:monospace">@PolySigned</span></a>, all arguments for
<span style="font-family:monospace">@PolySigned</span> formal parameters must have comparable types. (One way to
do this is for all types to be the same.) This is different than the usual
rules for polymorphic qualifiers. If you violate this rule, then the
Signedness Checker’s error messages can be obscure, because they are about
<span style="font-family:monospace">@SignednessBottom</span>. You can fix the signedness error messages by casting
the arguments.</p>
<!--TOC section id="signedness-other-annotations" Other signedness annotations-->
<h2 id="signedness-other-annotations" class="section">20.6 Other signedness annotations <a href="#signedness-other-annotations"><img src="chainlink.svg" width="10" height="10"></a></h2><!--SEC END --><p>The Checker Framework’s signedness annotations are similar to annotations used
elsewhere.</p><p>If your code is already annotated with a different
annotation, the Checker Framework can type-check your code.
It treats annotations from other tools
as if you had written the corresponding annotation from the
Signedness Checker, as described in Figure ‍<a href="#fig-signedness-refactoring">20.2</a>.
</p><blockquote class="figure"><div class="center"><hr class="floatrule"></div>
<div class="center">
<table style="border-spacing:6px;border-collapse:separate;" class="cellpading0"><tr><td style="text-align:left;white-space:nowrap" ><table border=1  style="border-spacing:0;" class="cellpadding1"><tr><td style="text-align:left;border:solid 1px;white-space:nowrap" >  ‍jdk.jfr.Unsigned ‍ </td></tr>
</table></td><td style="text-align:left;white-space:nowrap" >⇒
 ‍org.checkerframework.checker.signedness.qual.Unsigned ‍
</td></tr>
</table>
</div>
<div class="caption"><table style="border-spacing:6px;border-collapse:separate;" class="cellpading0"><tr><td style="vertical-align:top;text-align:left;" >Figure 20.2: Correspondence between other signedness annotations
and the Checker Framework’s annotations.</td></tr>
</table></div>
<a id="fig-signedness-refactoring"></a>
<div class="center"><hr class="floatrule"></div></blockquote><hr>
<!--TOC chapter id="purity-checker" Purity Checker-->
<h1 id="purity-checker" class="chapter">Chapter ‍21 Purity Checker <a href="#purity-checker"><img src="chainlink.svg" width="10" height="10"></a></h1><!--SEC END --><p>The Purity Checker identifies methods that have no side effects, that
return the same value each time they are called on the same argument, or both.</p><p>Purity analysis aids type refinement (Section ‍<a href="#type-refinement">31.7</a>).</p><p>All checkers utilize purity annotations on called methods.
You do not need to run the Purity Checker directly.
However you may run just the Purity Checker by
supplying the following command-line options to javac:
<span style="font-family:monospace">-processor org.checkerframework.framework.util.PurityChecker</span>.</p><p>The Checker Framework can infer purity annotations.
If you supply the command-line option <span style="font-family:monospace">-AsuggestPureMethods</span>, then the
Checker Framework will suggest methods that can be marked as
<span style="font-family:monospace">@SideEffectFree</span>, <span style="font-family:monospace">@Deterministic</span>, or <span style="font-family:monospace">@Pure</span>.
In addition, such suggestions are output by <span style="font-family:monospace">-Ainfer</span> and when using
whole-program inference.</p>
<!--TOC section id="purity-annotations" Purity annotations-->
<h2 id="purity-annotations" class="section">21.1 Purity annotations <a href="#purity-annotations"><img src="chainlink.svg" width="10" height="10"></a></h2><!--SEC END --><dl class="description"><dt class="dt-description"><a href="../api/org/checkerframework/dataflow/qual/SideEffectFree.html"><span style="font-weight:bold"><span style="font-family:monospace">@SideEffectFree</span></span></a></dt><dd class="dd-description">
indicates that the method has no externally-visible side effects.</dd><dt class="dt-description"><a href="../api/org/checkerframework/dataflow/qual/Deterministic.html"><span style="font-weight:bold"><span style="font-family:monospace">@Deterministic</span></span></a></dt><dd class="dd-description">
indicates that if the method is called multiple times with identical
arguments, then it returns the identical result according to <span style="font-family:monospace">==</span>
(not just according to <span style="font-family:monospace">equals()</span>).</dd><dt class="dt-description"><a href="../api/org/checkerframework/dataflow/qual/Pure.html"><span style="font-weight:bold"><span style="font-family:monospace">@Pure</span></span></a></dt><dd class="dd-description">
indicates that the method is both <span style="font-family:monospace">@SideEffectFree</span> and <span style="font-family:monospace">@Deterministic</span>.</dd></dl>
<!--TOC section id="purity-trusted" Purity annotations are trusted-->
<h2 id="purity-trusted" class="section">21.2 Purity annotations are trusted <a href="#purity-trusted"><img src="chainlink.svg" width="10" height="10"></a></h2><!--SEC END --><p>By default, purity annotations are trusted. Purity annotations on called
methods affect type-checking of client code. However, you can make a
mistake by writing <span style="font-family:monospace">@SideEffectFree</span> on the declaration of a method that
is not actually side-effect-free or by writing <span style="font-family:monospace">@Deterministic</span> on the
declaration of a method that is not actually deterministic.</p><p>To enable
checking of the annotations, supply the command-line option
<span style="font-family:monospace">-AcheckPurityAnnotations</span>. It is not enabled by default because of a high false
positive rate. In the future, after a new purity-checking analysis is
implemented, the Checker Framework will default to checking purity
annotations.</p>
<!--TOC section id="purity-override" Overriding methods must respect specifications in superclasses-->
<h2 id="purity-override" class="section">21.3 Overriding methods must respect specifications in superclasses <a href="#purity-override"><img src="chainlink.svg" width="10" height="10"></a></h2><!--SEC END --><p>If a method in a superclass has a purity annotation, then every overriding
definition must also have that purity annotation (or a stronger one).</p><p>Here is an example error if this requirement is violated:</p><div style="font-size:small;">
<pre class="verbatim">MyClass.java:1465: error: int hashCode() in MyClass cannot override int hashCode(Object this) in java.lang.Object;
attempting to use an incompatible purity declaration
    public int hashCode() {
               ^
  found   : []
  required: [SIDE_EFFECT_FREE, DETERMINISTIC]
</pre>
</div><p>The reason for the error is that the <span style="font-family:monospace">Object</span> class is annotated as:</p><pre class="verbatim">class Object {
  ...
  @Pure int hashCode() { ... }
}
</pre><p>(where <a href="../api/org/checkerframework/dataflow/qual/Pure.html"><span style="font-family:monospace">@Pure</span></a> means both
<a href="../api/org/checkerframework/dataflow/qual/SideEffectFree.html"><span style="font-family:monospace">@SideEffectFree</span></a> and
<a href="../api/org/checkerframework/dataflow/qual/Deterministic.html"><span style="font-family:monospace">@Deterministic</span></a>). Every overriding
definition, including those in your program, must use be at least as strong
a specification. For <span style="font-family:monospace">hashCode</span>, every overriding definition must be
annotated as <span style="font-family:monospace">@Pure</span>.</p><p>You can fix the definition by adding <span style="font-family:monospace">@Pure</span> to your method definition.
Alternately, you can suppress the warning.
You can suppress each such warning individually using
<span style="font-family:monospace">@SuppressWarnings("purity.invalid.overriding")</span>,
or you can use the <span style="font-family:monospace">-AsuppressWarnings=purity.invalid.overriding</span>
command-line argument to suppress all such warnings.
In the future, the Checker Framework will support inheriting annotations
from superclass definitions.</p>
<!--TOC section id="purity-suppress-warnings" Suppressing warnings-->
<h2 id="purity-suppress-warnings" class="section">21.4 Suppressing warnings <a href="#purity-suppress-warnings"><img src="chainlink.svg" width="10" height="10"></a></h2><!--SEC END --><p>The command-line options <span style="font-family:monospace">-AassumeSideEffectFree</span>,
<span style="font-family:monospace">-AassumeDeterministic</span>, <span style="font-family:monospace">-AassumePure</span> make the Checker Framework unsoundly
assume that <em>every</em> called method is side-effect-free, is
deterministic, or is both, respectively. This can make
flow-sensitive type refinement much more effective, since method calls will
not cause the analysis to discard information that it has learned.
However, this option can mask real errors. It is most appropriate when you
are starting out annotating a project, or if you are using the Checker
Framework to find some bugs but not to give a guarantee that no more errors
exist of the given type.</p><hr>
<!--TOC chapter id="constant-value-checker" Constant Value Checker-->
<h1 id="constant-value-checker" class="chapter">Chapter ‍22 Constant Value Checker <a href="#constant-value-checker"><img src="chainlink.svg" width="10" height="10"></a></h1><!--SEC END --><p>The Constant Value Checker is a constant propagation analysis: for
each variable, it determines whether that variable’s value can be
known at compile time.</p><p>There are two ways to run the Constant Value Checker.
</p><ul class="itemize"><li class="li-itemize">
Typically, it is automatically run by another type checker.
</li><li class="li-itemize">Alternately, you can run just the Constant Value Checker, by
supplying the following command-line options to javac:
<span style="font-family:monospace">-processor org.checkerframework.common.value.ValueChecker</span>
</li></ul>
<!--TOC section id="constant-value-checker-annotations" Annotations-->
<h2 id="constant-value-checker-annotations" class="section">22.1 Annotations <a href="#constant-value-checker-annotations"><img src="chainlink.svg" width="10" height="10"></a></h2><!--SEC END --><p>The Constant Value Checker uses type annotations to indicate the value of
an expression (Section ‍<a href="#constant-value-checker-type-annotations">22.1.1</a>), and
it uses method annotations to indicate methods that the Constant Value
Checker can execute at compile time
(Section ‍<a href="#constant-value-staticallyexecutable-annotation">22.2.2</a>).</p>
<!--TOC subsection id="constant-value-checker-type-annotations" Type Annotations-->
<h3 id="constant-value-checker-type-annotations" class="subsection">22.1.1 Type Annotations <a href="#constant-value-checker-type-annotations"><img src="chainlink.svg" width="10" height="10"></a></h3><!--SEC END --><p>Typically, the programmer does not write any type annotations. Rather, the
type annotations are inferred by the Constant Value Checker.
The programmer is also permitted to write type annotations. This is only necessary in
locations where the Constant Value Checker does not infer annotations: on fields
and method signatures.</p><p>The main type annotations are
<a href="../api/org/checkerframework/common/value/qual/BoolVal.html"><span style="font-family:monospace">@BoolVal</span></a>,
<a href="../api/org/checkerframework/common/value/qual/IntVal.html"><span style="font-family:monospace">@IntVal</span></a>,
<a href="../api/org/checkerframework/common/value/qual/IntRange.html"><span style="font-family:monospace">@IntRange</span></a>,
<a href="../api/org/checkerframework/common/value/qual/DoubleVal.html"><span style="font-family:monospace">@DoubleVal</span></a>,
<a href="../api/org/checkerframework/common/value/qual/StringVal.html"><span style="font-family:monospace">@StringVal</span></a>,
<a href="../api/org/checkerframework/common/value/qual/MatchesRegex.html"><span style="font-family:monospace">@MatchesRegex</span></a>,
<a href="../api/org/checkerframework/common/value/qual/DoesNotMatchRegex.html"><span style="font-family:monospace">@DoesNotMatchRegex</span></a>,
and <a href="../api/org/checkerframework/common/value/qual/EnumVal.html"><span style="font-family:monospace">@EnumVal</span></a>.
Additional type annotations for arrays and strings are
<a href="../api/org/checkerframework/common/value/qual/ArrayLen.html"><span style="font-family:monospace">@ArrayLen</span></a>,
<a href="../api/org/checkerframework/common/value/qual/ArrayLenRange.html"><span style="font-family:monospace">@ArrayLenRange</span></a>,
and <a href="../api/org/checkerframework/common/value/qual/MinLen.html"><span style="font-family:monospace">@MinLen</span></a>.
A polymorphic qualifier (<a href="../api/org/checkerframework/common/value/qual/PolyValue.html"><span style="font-family:monospace">@PolyValue</span></a>)
is also supported (see Section ‍<a href="#method-qualifier-polymorphism">30.2</a>).
In addition, there are separate checkers for
<a href="../api/org/checkerframework/common/reflection/qual/ClassVal.html"><span style="font-family:monospace">@ClassVal</span></a> and
<a href="../api/org/checkerframework/common/reflection/qual/MethodVal.html"><span style="font-family:monospace">@MethodVal</span></a> annotations
(see Section ‍<a href="#methodval-and-classval-checkers">24.2</a>).</p><p>Each <span style="font-family:monospace">*Val</span> type annotation takes as an argument a set of values, and its
meaning is that at run time, the expression evaluates to one of the values. For
example, an expression of type
<a href="../api/org/checkerframework/common/value/qual/StringVal.html"><span style="font-family:monospace">@StringVal</span></a><span style="font-family:monospace">("a", "b")</span> evaluates to
one of the values <span style="font-family:monospace">"a"</span>, <span style="font-family:monospace">"b"</span>, or <span style="font-family:monospace">null</span>.
The set is limited to 10 entries; if a variable
could be more than 10 different values, the Constant Value
Checker gives up and its type becomes
<a href="../api/org/checkerframework/common/value/qual/IntRange.html"><span style="font-family:monospace">@IntRange</span></a> for integral types,
<a href="../api/org/checkerframework/common/value/qual/ArrayLenRange.html"><span style="font-family:monospace">@ArrayLenRange</span></a> for array types,
<a href="../api/org/checkerframework/common/value/qual/MatchesRegex.html"><span style="font-family:monospace">@MatchesRegex</span></a>,
<a href="../api/org/checkerframework/common/value/qual/DoesNotMatchRegex.html"><span style="font-family:monospace">@DoesNotMatchRegex</span></a>,
<a href="../api/org/checkerframework/common/value/qual/ArrayLen.html"><span style="font-family:monospace">@ArrayLen</span></a>, or
<a href="../api/org/checkerframework/common/value/qual/ArrayLenRange.html"><span style="font-family:monospace">@ArrayLenRange</span></a> for <span style="font-family:monospace">String</span>, and
<a href="../api/org/checkerframework/common/value/qual/UnknownVal.html"><span style="font-family:monospace">@UnknownVal</span></a> for all other types.
The <span style="font-family:monospace">@ArrayLen</span> annotation means that at run time, the expression
evaluates to an array or a string whose length is one of the annotation’s arguments.</p><p>In the case of too many strings in <span style="font-family:monospace">@StringVal</span>, the values are forgotten
and just the lengths are used in <span style="font-family:monospace">@ArrayLen</span>.
If this would result in too many lengths,
only the minimum and maximum lengths are used in <span style="font-family:monospace">@ArrayLenRange</span>,
giving a range of possible lengths of the string.</p><p>The <span style="font-family:monospace">@StringVal</span>, <span style="font-family:monospace">@MatchesRegex</span>, and <span style="font-family:monospace">@DoesNotMatchRegex</span>
annotations may be applied to char arrays. Although byte
arrays are often converted to/from strings, these annotations may
not be applied to them. This is because the conversion depends on the
platform’s character set.</p><p>The <span style="font-family:monospace">@MatchesRegex</span> and <span style="font-family:monospace">@DoesNotMatchRegex</span> annotations use the standard Java regular expression syntax.
<span style="font-family:monospace">@MatchesRegex(A)</span> is only a subtype of <span style="font-family:monospace">@MatchesRegex(B)</span> if the set of regular
expressions <span style="font-family:monospace">A</span> is a subset of the set of regular expressions <span style="font-family:monospace">B</span>. An
<span style="font-family:monospace">@StringVal</span> annotation is a subtype of an <span style="font-family:monospace">@MatchesRegex</span> annotation if
each string matches at least one of the regular expressions.
<span style="font-family:monospace">@DoesNotMatchRegex(A)</span> is only a subtype of <span style="font-family:monospace">@MatchesRegex(B)</span> if the set of regular
expressions <span style="font-family:monospace">A</span> is a superset of the set of regular expressions <span style="font-family:monospace">B</span>.
Matching is done
via the
<a href="https://docs.oracle.com/en/java/javase/17/docs/api/java.base/java/lang/String.html#matches(java.lang.String)">java.lang.String#matches</a>
method, which matches against the entire string (it does not look for a
matching substring).</p><p>The <span style="font-family:monospace">@EnumVal</span> annotation’s argument is the names of the enum constants
that the type might evaluate to. (Java syntax does not allow the enum
constants themselves to be arguments.) <span style="font-family:monospace">@EnumVal</span>
is treated identically to <span style="font-family:monospace">@StringVal</span> by the checker internally, so
<span style="font-family:monospace">@StringVal</span> may appear in error messages related to enums.</p><p><a href="../api/org/checkerframework/common/value/qual/IntRange.html"><span style="font-family:monospace">@IntRange</span></a> takes two arguments — a lower
bound and an upper bound. Its meaning is that at run time, the expression
evaluates to a value between the bounds (inclusive). For example, an
expression of type <span style="font-family:monospace">@IntRange(from=0, to=255)</span> evaluates to
0, 1, 2, …, 254, or 255.
An <a href="../api/org/checkerframework/common/value/qual/IntVal.html"><span style="font-family:monospace">@IntVal</span></a> and
<a href="../api/org/checkerframework/common/value/qual/IntRange.html"><span style="font-family:monospace">@IntRange</span></a> annotation that represent the
same set of values are semantically identical and interchangeable: they
have exactly the same meaning, and using either one has the same effect.
<a href="../api/org/checkerframework/common/value/qual/ArrayLenRange.html"><span style="font-family:monospace">@ArrayLenRange</span></a> has the same relationship
to <a href="../api/org/checkerframework/common/value/qual/ArrayLen.html"><span style="font-family:monospace">@ArrayLen</span></a> that
<a href="../api/org/checkerframework/common/value/qual/IntRange.html"><span style="font-family:monospace">@IntRange</span></a> has to
<a href="../api/org/checkerframework/common/value/qual/IntVal.html"><span style="font-family:monospace">@IntVal</span></a>.
The <span style="font-family:monospace">@MinLen</span> annotation is an alias for <span style="font-family:monospace">@ArrayLenRange</span> (meaning that every <span style="font-family:monospace">@MinLen</span> annotation
is automatically converted to an <span style="font-family:monospace">@ArrayLenRange</span> annotation) that only takes
one argument, which is the lower bound of the range. The upper bound of the
range is the maximum integer value.</p><p>Figure ‍<a href="#fig-value-hierarchy">22.1</a> shows the
subtyping relationship among the type annotations.
For two annotations of the same type, subtypes have a smaller set of
possible values, as also shown in the figure.
Because <span style="font-family:monospace">int</span> can be casted to <span style="font-family:monospace">double</span>, an <span style="font-family:monospace">@IntVal</span> annotation is a
subtype of a <span style="font-family:monospace">@DoubleVal</span> annotation with the same values.</p><blockquote class="figure"><div class="center"><hr class="floatrule"></div>
<div class="center">
<img src="value-subtyping.svg">
</div>
<div class="caption"><table style="border-spacing:6px;border-collapse:separate;" class="cellpading0"><tr><td style="vertical-align:top;text-align:left;" >Figure 22.1: At the top, the type qualifier hierarchy of the Constant Value Checker
annotations.
The first four qualifiers are applicable to primitives and their
wrappers; the next to <span style="font-family:monospace">String</span>s (it can also be written as <span style="font-family:monospace">@EnumVal</span> for
enumeration constants), and the final two to arrays.
Qualifiers in gray are used
internally by the type system but should never be written by a
programmer. At the bottom are examples of additional subtyping
relationships that depend on the annotations’ arguments.</td></tr>
</table></div>
<a id="fig-value-hierarchy"></a>
<div class="center"><hr class="floatrule"></div></blockquote><p>Figure ‍<a href="#fig-value-multivalue">22.2</a> illustrates how the Constant Value Checker
infers type annotations (using flow-sensitive type qualifier refinement, Section ‍<a href="#type-refinement">31.7</a>).</p><blockquote class="figure"><div class="center"><hr class="floatrule"></div>
<pre class="verbatim">public void flowSensitivityExample(boolean b) {
    int i = 1;     // i has type:  @IntVal({1}) int
    if (b) {
        i = 2;     // i now has type:  @IntVal({2}) int
    }
                   // i now has type:  @IntVal({1,2}) int
    i = i + 1;     // i now has type:  @IntVal({2,3}) int
}
</pre>
<div class="caption"><table style="border-spacing:6px;border-collapse:separate;" class="cellpading0"><tr><td style="vertical-align:top;text-align:left;" >Figure 22.2: The Constant Value Checker infers different types
for a variable on different lines of the program.</td></tr>
</table></div>
<a id="fig-value-multivalue"></a>
<div class="center"><hr class="floatrule"></div></blockquote>
<!--TOC section id="other-constant-value-annotations" Other constant value annotations-->
<h2 id="other-constant-value-annotations" class="section">22.2 Other constant value annotations <a href="#other-constant-value-annotations"><img src="chainlink.svg" width="10" height="10"></a></h2><!--SEC END --><p>The Checker Framework’s constant value annotations are similar to annotations used
elsewhere.</p><p>If your code is already annotated with a different constant value or range
annotation, the Checker Framework can type-check your code.
It treats annotations from other tools
as if you had written the corresponding annotation from the
Constant Value Checker, as described in Figure ‍<a href="#fig-constant-value-refactoring">22.3</a>.
If the other annotation is a declaration annotation, it may be moved; see
Section ‍<a href="#declaration-annotations-moved">38.6.8</a>.</p><blockquote class="figure"><div class="center"><hr class="floatrule"></div>
<div class="center">
<table style="border-spacing:6px;border-collapse:separate;" class="cellpading0"><tr><td style="text-align:left;white-space:nowrap" ><table border=1  style="border-spacing:0;" class="cellpadding1"><tr><td style="text-align:left;border:solid 1px;white-space:nowrap" >  ‍android.support.annotation.IntRange ‍ </td></tr>
</table></td><td style="text-align:left;white-space:nowrap" >⇒
 ‍org.checkerframework.checker.common.value.qual.IntRange ‍
</td></tr>
</table>
</div>
<div class="caption"><table style="border-spacing:6px;border-collapse:separate;" class="cellpading0"><tr><td style="vertical-align:top;text-align:left;" >Figure 22.3: Correspondence between other constant value and range annotations
and the Checker Framework’s annotations.</td></tr>
</table></div>
<a id="fig-constant-value-refactoring"></a>
<div class="center"><hr class="floatrule"></div></blockquote><p>The Constant Value Checker trusts the
<a href="../api/org/checkerframework/checker/index/qual/Positive.html"><span style="font-family:monospace">@Positive</span></a>,
<a href="../api/org/checkerframework/checker/index/qual/NonNegative.html"><span style="font-family:monospace">@NonNegative</span></a>,
and <a href="../api/org/checkerframework/checker/index/qual/GTENegativeOne.html"><span style="font-family:monospace">@GTENegativeOne</span></a> annotations. If your code
contains any of these annotations, then
in order to guarantee soundness, you must run the Index Checker whenever
you run the Constant Value Checker.</p>
<!--TOC subsection id="constant-value-compile-time-execution" Compile-time execution of expressions-->
<h3 id="constant-value-compile-time-execution" class="subsection">22.2.1 Compile-time execution of expressions <a href="#constant-value-compile-time-execution"><img src="chainlink.svg" width="10" height="10"></a></h3><!--SEC END --><p>Whenever all the operands of an expression are compile-time constants (that
is, their types have constant-value type annotations), the Constant Value
Checker attempts to execute the expression. This is independent of any
optimizations performed by the compiler and does not affect the code that
is generated.</p><p>The Constant Value Checker statically executes (at compile time) operators that do
not throw exceptions (e.g., <span style="font-family:monospace">+</span>, <span style="font-family:monospace">-</span>, <span style="font-family:monospace">&lt;</span><span style="font-family:monospace">&lt;</span>, <span style="font-family:monospace">!=</span>).</p>
<!--TOC subsection id="constant-value-staticallyexecutable-annotation" <span style="font-family:monospace">@StaticallyExecutable</span> methods and the classpath-->
<h3 id="constant-value-staticallyexecutable-annotation" class="subsection">22.2.2 <span style="font-family:monospace">@StaticallyExecutable</span> methods and the classpath <a href="#constant-value-staticallyexecutable-annotation"><img src="chainlink.svg" width="10" height="10"></a></h3><!--SEC END --><p>The Constant Value Checker statically executes (at compile time) methods annotated with
<a href="../api/org/checkerframework/common/value/qual/StaticallyExecutable.html"><span style="font-family:monospace">@StaticallyExecutable</span></a>.</p><blockquote class="figure"><div class="center"><hr class="floatrule"></div>
<pre class="verbatim">@StaticallyExecutable @Pure
public static int myAdd(int a, int b) {
    return a + b;
}

public void bar() {
    int a = 5;            // a has type:  @IntVal({5}) int
    int b = 4;            // b has type:  @IntVal({4}) int
    int c = myAdd(a, b);  // c has type:  @IntVal({9}) int
}
</pre>
<div class="caption"><table style="border-spacing:6px;border-collapse:separate;" class="cellpading0"><tr><td style="vertical-align:top;text-align:left;" >Figure 22.4: The
<a href="../api/org/checkerframework/common/value/qual/StaticallyExecutable.html"><span style="font-family:monospace">@StaticallyExecutable</span></a> annotation enables
constant propagation through method calls.</td></tr>
</table></div>
<a id="fig-staticallyexecutable"></a>
<div class="center"><hr class="floatrule"></div></blockquote><p>The static execution feature has some requirements:</p><ul class="itemize"><li class="li-itemize">
A <span style="font-family:monospace">@StaticallyExecutable</span> method must be
<a href="../api/org/checkerframework/dataflow/qual/Pure.html"><span style="font-family:monospace">@Pure</span></a> (side-effect-free and deterministic).</li><li class="li-itemize">The Constant Value Checker must have an estimate for all the arguments at
a call site.<p>This means that <span style="font-family:monospace">@StaticallyExecutable</span> is not applicable
to user-written instance methods. It is only applicable to instance
methods whose receiver is a compile-time constant, such as a primitive
wrapper or an array.</p></li><li class="li-itemize">The <span style="font-family:monospace">@StaticallyExecutable</span> method and any method it calls must be on
the same path (the classpath or the processorpath) as the Checker
Framework. This is because the Constant Value Checker reflectively calls
these methods at compile time.<p>To use <span style="font-family:monospace">@StaticallyExecutable</span> on methods in your own code, you should
first compile the code without the Constant Value Checker and then add
the location of the resulting <span style="font-family:monospace">.class</span> files to the
classpath or processorpath, whichever is appropriate. For example, the
command-line arguments to the Checker Framework
might include:
</p><pre class="verbatim">  -processor org.checkerframework.common.value.ValueChecker
  -classpath $CLASSPATH:MY_PROJECT/build/
</pre><p>
or
</p><pre class="verbatim">  -processor org.checkerframework.common.value.ValueChecker
  -processorpath ${CHECKERFRAMEWORK}/checker/build/libs/checker-3.6.1-SNAPSHOT.jar:MY_PROJECT/build/
</pre></li></ul>
<!--TOC section id="value-checker-warnings" Warnings-->
<h2 id="value-checker-warnings" class="section">22.3 Warnings <a href="#value-checker-warnings"><img src="chainlink.svg" width="10" height="10"></a></h2><!--SEC END --><p>If the option <span style="font-family:monospace">-AreportEvalWarns</span> options is used, the Constant Value Checker issues a warning if it cannot load and run, at
compile time, a method marked as <span style="font-family:monospace">@StaticallyExecutable</span>. If it issues
such a warning, then the return value of the method will be <span style="font-family:monospace">@UnknownVal</span>
instead of being able to be resolved to a specific value annotation.
Some examples of these:
</p><ul class="itemize"><li class="li-itemize">
<span style="font-family:monospace">[class.find.failed] Failed to find class named Test.</span><p>The checker could not find the class
specified for resolving a <span style="font-family:monospace">@StaticallyExecutable</span> method. Typically
this means that the path that contains the Checker Framework (the
classpath or the processorpath) lacks the given classfile.</p></li><li class="li-itemize"><span style="font-family:monospace">[method.find.failed] Failed to find a method named foo with argument types [@IntVal(3) int].</span><p>The checker could not find the method <span style="font-family:monospace">foo(int)</span> specified for
resolving a <span style="font-family:monospace">@StaticallyExecutable</span> method, but could find the
class. This is usually due to providing an outdated version of the
classfile that does not contain the
method that was annotated as <span style="font-family:monospace">@StaticallyExecutable</span>.</p></li><li class="li-itemize"><span style="font-family:monospace">[method.evaluation.exception] Failed to evaluate method public static int Test.foo(int) because it threw an exception: java.lang.ArithmeticException: / by zero.</span><p>An exception was thrown when trying to statically execute (at compile time) the
method. In this case it was a divide-by-zero exception. If the
arguments to the method each only had one value in their annotations
then this exception will always occur when the program is actually
run as well. If there are multiple possible values then the exception
might not be thrown on every execution, depending on the run-time values.</p></li></ul><p>There are some other situations in which the Constant Value Checker produces a
warning message:</p><ul class="itemize"><li class="li-itemize">
<span style="font-family:monospace">[too.many.values.given] The maximum number of arguments permitted is 10.</span><p>The Constant Value Checker only tracks up to 10 possible values for an
expression. If you write an annotation with more values than will be
tracked, the annotation is replaced with <span style="font-family:monospace">@IntRange</span>, <span style="font-family:monospace">@ArrayLen</span>, <span style="font-family:monospace">@ArrayLenRange</span>, or <span style="font-family:monospace">@UnknownVal</span>.</p></li></ul>
<!--TOC section id="value-checker-overflow" Unsoundly ignoring overflow-->
<h2 id="value-checker-overflow" class="section">22.4 Unsoundly ignoring overflow <a href="#value-checker-overflow"><img src="chainlink.svg" width="10" height="10"></a></h2><!--SEC END --><p>The Constant Value Checker takes Java’s overflow rules into account when
computing the possible values of expressions.
The <span style="font-family:monospace">-AignoreRangeOverflow</span> command-line option makes it ignore the
possibility of overflow for range annotations
<a href="../api/org/checkerframework/common/value/qual/IntRange.html"><span style="font-family:monospace">@IntRange</span></a> and
<a href="../api/org/checkerframework/common/value/qual/ArrayLenRange.html"><span style="font-family:monospace">@ArrayLenRange</span></a>.
Figure ‍<a href="#fig-value-ignore-overflow">22.5</a> gives an example of behavior with
and without the <span style="font-family:monospace">-AignoreRangeOverflow</span> command-line option.</p><blockquote class="figure"><div class="center"><hr class="floatrule"></div>
<pre class="verbatim">  ...
  if (i &gt; 5) {
    // i now has type:  @IntRange(from=5, to=Integer.MAX_VALUE)
    i = i + 1;
    // If i started out as Integer.MAX_VALUE, then i is now Integer.MIN_VALUE.
    // i's type is now @IntRange(from=Integer.MIN_VALUE, to=Integer.MAX_VALUE).
    // When ignoring overflow, i's type is now @IntRange(from=6, to=Integer.MAX_VALUE).
  }
</pre>
<div class="caption"><table style="border-spacing:6px;border-collapse:separate;" class="cellpading0"><tr><td style="vertical-align:top;text-align:left;" >Figure 22.5: With the <span style="font-family:monospace">-AignoreRangeOverflow</span> command-line option,
the Constant Value Checker ignores overflow
for range types, which gives smaller ranges to range types.</td></tr>
</table></div>
<a id="fig-value-ignore-overflow"></a>
<div class="center"><hr class="floatrule"></div></blockquote><p>As with any unsound behavior in the Checker Framework, this option reduces
the number of warnings and errors produced, and may reduce the number of
<span style="font-family:monospace">@IntRange</span> qualifiers that you need to write in the source code.
However, it is possible that at run time, an expression might evaluate to a
value that is not in its <span style="font-family:monospace">@IntRange</span> qualifier. You should either accept
that possibility, or verify the lack of overflow using some other tool or
manual analysis.</p>
<!--TOC section id="non-null-strings-concats" Strings can be null in concatenations-->
<h2 id="non-null-strings-concats" class="section">22.5 Strings can be null in concatenations <a href="#non-null-strings-concats"><img src="chainlink.svg" width="10" height="10"></a></h2><!--SEC END --><p>By default, the Constant Value Checker is sound with respect to string
concatenation and nullness. It assumes that, in a string concatenation,
every non-primitive argument might be null, except for String literals
and compile-time constants. It ignores Nullness Checker annotations.
(This behavior is conservative but sound.)</p><p>Consider a variable declared as
<a href="../api/org/checkerframework/common/value/qual/StringVal.html"><span style="font-family:monospace">@StringVal</span></a><span style="font-family:monospace">("a", "b") String x;</span>.
At run time, <span style="font-family:monospace">x</span> evaluates to one of the values <span style="font-family:monospace">"a"</span>, <span style="font-family:monospace">"b"</span>, or
<span style="font-family:monospace">null</span>.
Therefore, the type of “<span style="font-family:monospace">x + "c"</span>” is
<span style="font-family:monospace">@StringVal("ac", "bc", "nullc") String</span>.</p><p>The <span style="font-family:monospace">-AnonNullStringsConcatenation</span> command-line option makes the
Constant Value Checker unsoundly assume that no arguments in a string
concatenation are null.
With the command-line argument, the type of “<span style="font-family:monospace">x + "c"</span>” is
<span style="font-family:monospace">@StringVal("ac", "bc") String</span>.</p><hr>
<!--TOC chapter id="returns-receiver-checker" Returns Receiver Checker-->
<h1 id="returns-receiver-checker" class="chapter">Chapter ‍23 Returns Receiver Checker <a href="#returns-receiver-checker"><img src="chainlink.svg" width="10" height="10"></a></h1><!--SEC END --><p>The Returns Receiver Checker enables documenting and checking that a method
returns its receiver (i.e., the <span style="font-family:monospace">this</span> parameter).</p><p>There are two ways to run the Returns Receiver Checker.
</p><ul class="itemize"><li class="li-itemize">
Typically, it is automatically run by another checker.<p>If the code being checked does not use fluent APIs, you can pass the
<span style="font-family:monospace">-AdisableReturnsReceiver</span> command-line option. This disables the
Returns Receiver Checker and makes the other checker run faster.
</p></li><li class="li-itemize">Alternately, you can run just the Returns Receiver Checker, by
supplying the following command-line options to javac:
<span style="font-family:monospace">-processor org.checkerframework.common.returnsreceiver.ReturnsReceiverChecker</span>
</li></ul>
<!--TOC section id="returns-receiver-checker-annotations" Annotations-->
<h2 id="returns-receiver-checker-annotations" class="section">23.1 Annotations <a href="#returns-receiver-checker-annotations"><img src="chainlink.svg" width="10" height="10"></a></h2><!--SEC END --><p>The qualifier <a href="../api/org/checkerframework/common/returnsreceiver/qual/This.html"><span style="font-family:monospace">@This</span></a> on the return
type of a method indicates that the method returns its receiver. Methods
that return their receiver are common in so-called “fluent” APIs. Here
is an example:</p><pre class="verbatim">class MyBuilder {
  @This MyBuilder setName(String name) {
    this.name = name;
    return this;
  }
}
</pre><p>An <a href="../api/org/checkerframework/common/returnsreceiver/qual/This.html"><span style="font-family:monospace">@This</span></a> annotation can only be
written on a return type, a receiver type, or in a downcast.</p><p>As is standard, the Returns Receiver Checker has a top qualifier,
<a href="../api/org/checkerframework/common/returnsreceiver/qual/UnknownThis.html"><span style="font-family:monospace">@UnknownThis</span></a>, and a bottom qualifier,
<a href="../api/org/checkerframework/common/returnsreceiver/qual/BottomThis.html"><span style="font-family:monospace">@BottomThis</span></a>.
Programmers rarely need to write these annotations.</p><p>Here are additional details. <a href="../api/org/checkerframework/common/returnsreceiver/qual/This.html"><span style="font-family:monospace">@This</span></a>
is a polymorphic qualifier rather than a regular type qualifier (see
Section ‍<a href="#method-qualifier-polymorphism">30.2</a>). Conceptually, a receiver type always has
an <a href="../api/org/checkerframework/common/returnsreceiver/qual/This.html"><span style="font-family:monospace">@This</span></a> qualifier. When a method
return type also has an <a href="../api/org/checkerframework/common/returnsreceiver/qual/This.html"><span style="font-family:monospace">@This</span></a>
qualifier, the presence of the polymorphic annotation on both the method’s
return and receiver type forces their type qualifiers to be <em>equal</em>. Hence,
the method will only pass the type checker if it returns its receiver argument,
achieving the desired checking.</p>
<!--TOC section id="returns-receiver-checker-autovalue-lombok-support" AutoValue and Lombok Support-->
<h2 id="returns-receiver-checker-autovalue-lombok-support" class="section">23.2 AutoValue and Lombok Support <a href="#returns-receiver-checker-autovalue-lombok-support"><img src="chainlink.svg" width="10" height="10"></a></h2><!--SEC END --><blockquote class="figure"><div class="center"><hr class="floatrule"></div>
<pre class="verbatim">@AutoValue
abstract class Animal {
  abstract String name();
  abstract int numberOfLegs();
  static Builder builder() {
    return new AutoValue_Animal.Builder();
  }
  @AutoValue.Builder
  abstract static class Builder {
    abstract Builder setName(String value);       // @This is automatically added here
    abstract Builder setNumberOfLegs(int value);  // @This is automatically added here
    abstract Animal build();
  }
}
</pre>
<div class="caption"><table style="border-spacing:6px;border-collapse:separate;" class="cellpading0"><tr><td style="vertical-align:top;text-align:left;" >Figure 23.1: User-written code that uses the <span style="font-family:monospace">@AutoValue.Builder</span> annotation.
Given this code,
(1) AutoValue automatically generates a concrete subclass of
<span style="font-family:monospace">Animal.Builder</span>, see Figure ‍<a href="#fig-autovalue-builder-generated">23.2</a>, and
(2) the Returns Receiver Checker automatically adds <span style="font-family:monospace">@This</span> annotations
on setters in both user-written and automatically-generated code.</td></tr>
</table></div>
<a id="fig-autovalue-builder"></a>
<div class="center"><hr class="floatrule"></div></blockquote><blockquote class="figure"><div class="center"><hr class="floatrule"></div>
<pre class="verbatim">    class AutoValue_Animal {
      static final class Builder extends Animal.Builder {
        private String name;
        private Integer numberOfLegs;
        @This Animal.Builder setName(String name) {
          this.name = name;
          return this;
        }
        @This Animal.Builder setNumberOfLegs(int numberOfLegs) {
          this.numberOfLegs = numberOfLegs;
          return this;
        }
        @Override
        Animal build() {
          return new AutoValue_Animal(this.name, this.numberOfLegs);
        }
      }
    }
    </pre>
<div class="caption"><table style="border-spacing:6px;border-collapse:separate;" class="cellpading0"><tr><td style="vertical-align:top;text-align:left;" >Figure 23.2: Code generated by AutoValue for the example of
Figure ‍<a href="#fig-autovalue-builder">23.1</a>, including the <span style="font-family:monospace">@This</span> annotations added
by the Returns Receiver Checker.</td></tr>
</table></div>
<a id="fig-autovalue-builder-generated"></a>
<div class="center"><hr class="floatrule"></div></blockquote><p>The <a href="https://github.com/google/auto/tree/master/value">AutoValue</a> and
<a href="https://projectlombok.org/">Lombok</a> projects both support automatic
generation of builder classes, which enable flexible object construction.
For code using these two frameworks, the Returns Receiver Checker
automatically adds <span style="font-family:monospace">@This</span> annotations to setter methods in builder
classes. All the <span style="font-family:monospace">@This</span> annotations in
Figures ‍<a href="#fig-autovalue-builder">23.1</a>
and ‍<a href="#fig-autovalue-builder-generated">23.2</a> are automatically added by the
Returns Receiver Checker.</p><hr>
<!--TOC chapter id="reflection-resolution" Reflection resolution-->
<h1 id="reflection-resolution" class="chapter">Chapter ‍24 Reflection resolution <a href="#reflection-resolution"><img src="chainlink.svg" width="10" height="10"></a></h1><!--SEC END --><p>A call to
<a href="https://docs.oracle.com/en/java/javase/17/docs/api/java.base/java/lang/reflect/Method.html#invoke(java.lang.Object,java.lang.Object...)"><span style="font-family:monospace">Method.invoke</span></a>
might reflectively invoke any method. That method might place requirements
on its formal parameters, and it might return any value. To reflect these
facts, the annotated JDK contains
conservative annotations for <span style="font-family:monospace">Method.invoke</span>.
These conservative library annotations often cause a checker to issue false
positive warnings when type-checking code that uses reflection.</p><p>If you supply the <span style="font-family:monospace">-AresolveReflection</span> command-line option, the Checker
Framework attempts to resolve reflection. At each call to <span style="font-family:monospace">Method.invoke</span>
or <span style="font-family:monospace">Constructor.newInstance</span>, the Checker Framework first soundly estimates
which methods might be invoked at run time. When type-checking the call, the
Checker Framework uses the library annotations for the possibly-invoked
methods, rather than the imprecise one for <span style="font-family:monospace">Method.invoke</span>.</p><p>If the estimate of invoked methods is small,
the checker issues fewer false positive warnings.
If the estimate of invoked methods is large, these types may be no better than the
conservative library annotations.</p><p>Reflection resolution is disabled by default, because it increases the time
to type-check a program.
You should enable reflection resolution with the <span style="font-family:monospace">-AresolveReflection</span>
command-line option if, for some call site of <span style="font-family:monospace">Method.invoke</span> or
<span style="font-family:monospace">Constructor.newInstance</span> in your program:
</p><ol class="enumerate" type=1><li class="li-enumerate">
the conservative library annotations on <span style="font-family:monospace">Method.invoke</span> or
<span style="font-family:monospace">Constructor.newInstance</span> cause false positive warnings,
</li><li class="li-enumerate">the set of possibly-invoked methods or constructors can be known at
compile time,
and
</li><li class="li-enumerate">the reflectively invoked methods/constructors are on the class path at
compile time.
</li></ol><p>Reflection resolution does not change your source code or generated code.
In particular, it does not replace the <span style="font-family:monospace">Method.invoke</span> or
<span style="font-family:monospace">Constructor.newInstance</span> calls.</p><p>The command-line option <span style="font-family:monospace">-AresolveReflection=debug</span> outputs verbose
information about the reflection resolution process, which may be useful
for debugging.</p><p>Section ‍<a href="#reflection-examples">24.1</a> gives an example of reflection resolution.
Then,
Section ‍<a href="#methodval-and-classval-checkers">24.2</a> describes the MethodVal
and ClassVal Checkers, which reflection resolution uses internally.
The paper “Static analysis of implicit control flow: Resolving Java reflection and
Android intents” ‍[<a href="#BarrosJMVDdAE2015">BJM+15</a>] (ASE 2015,
<a href="https://homes.cs.washington.edu/~mernst/pubs/implicit-control-flow-ase2015-abstract.html"><span style="font-family:monospace">https://homes.cs.washington.edu/~mernst/pubs/implicit-control-flow-ase2015-abstract.html</span></a>)
gives further details.</p>
<!--TOC section id="reflection-examples" Reflection resolution example-->
<h2 id="reflection-examples" class="section">24.1 Reflection resolution example <a href="#reflection-examples"><img src="chainlink.svg" width="10" height="10"></a></h2><!--SEC END --><p>Consider the following example, in which the Nullness Checker employs
reflection resolution to avoid issuing a false positive warning.</p><pre class="verbatim">public class LocationInfo {
    @NonNull Location getCurrentLocation() {  ...  }
}

public class Example {
    LocationInfo privateLocation = ... ;
    String getCurrentCity() throws Exception {
        Method getCurrentLocationObj = LocationInfo.class.getMethod("getCurrentLocation");
        Location currentLocation = (Location) getCurrentLocationObj.invoke(privateLocation);
        return currentLocation.nameOfCity();
    }
}
</pre><p>When reflection resolution is not enabled, the Nullness Checker uses conservative
annotations on the <span style="font-family:monospace">Method.invoke</span> method signature:</p><p> <span style="font-family:monospace"><span style="font-weight:bold">@Nullable</span></span><span style="font-family:monospace"> Object invoke(</span><span style="font-family:monospace"><span style="font-weight:bold">@NonNull</span></span><span style="font-family:monospace"> Object recv, </span><span style="font-family:monospace"><span style="font-weight:bold">@NonNull</span></span><span style="font-family:monospace"> Object ... args)</span></p><p>This causes the Nullness Checker to issue the following warning even though
<span style="font-family:monospace">currentLocation</span> cannot be null.</p><pre class="verbatim">error: [dereference.of.nullable] dereference of possibly-null reference currentLocation
        return currentLocation.nameOfCity();
               ^
1 error
</pre><p>
When reflection resolution is enabled, the MethodVal Checker infers that the <span style="font-family:monospace">@MethodVal</span> annotation for <span style="font-family:monospace">getCurrentLocationObj</span> is:
</p><p> <span style="font-family:monospace">@MethodVal(className="LocationInfo", methodName="getCurrentLocation", params=0)</span></p><p>Based on this <span style="font-family:monospace">@MethodVal</span> annotation, the reflection resolver determines that
the reflective method call represents a call to <span style="font-family:monospace">getCurrentLocation</span> in class
<span style="font-family:monospace">LocationInfo</span>.
The reflection resolver uses this information to provide the
following precise procedure summary to the Nullness Checker, for this
call site only:</p><p> <span style="font-family:monospace"><span style="font-weight:bold">@NonNull</span></span><span style="font-family:monospace"> Object invoke(</span><span style="font-family:monospace"><span style="font-weight:bold">@NonNull</span></span><span style="font-family:monospace"> Object recv, </span><span style="font-family:monospace"><span style="font-weight:bold">@Nullable</span></span><span style="font-family:monospace"> Object ... args)</span></p><p>Using this more precise signature, the Nullness Checker does not issue the false positive warning shown above.</p>
<!--TOC section id="methodval-and-classval-checkers" MethodVal and ClassVal Checkers-->
<h2 id="methodval-and-classval-checkers" class="section">24.2 MethodVal and ClassVal Checkers <a href="#methodval-and-classval-checkers"><img src="chainlink.svg" width="10" height="10"></a></h2><!--SEC END --><p>The implementation of reflection resolution internally uses the ClassVal
Checker (Section ‍<a href="#classval-checker">24.2.1</a>) and the MethodVal Checker
(Section ‍<a href="#methodval-checker">24.2.2</a>). They are similar to the Constant
Value Checker (Section ‍<a href="#constant-value-checker">22</a>) in that their
annotations estimate the run-time value of an expression.</p><p>In some cases, you may need to write annotations such as
<a href="../api/org/checkerframework/common/reflection/qual/ClassVal.html"><span style="font-family:monospace">@ClassVal</span></a>,
<a href="../api/org/checkerframework/common/reflection/qual/MethodVal.html"><span style="font-family:monospace">@MethodVal</span></a>,
<a href="../api/org/checkerframework/common/value/qual/StringVal.html"><span style="font-family:monospace">@StringVal</span></a>, and
<a href="../api/org/checkerframework/common/value/qual/ArrayLen.html"><span style="font-family:monospace">@ArrayLen</span></a> to aid in reflection
resolution.
Often, though, these annotations can be inferred
(Section ‍<a href="#methodval-and-classval-inference">24.2.3</a>).</p>
<!--TOC subsection id="classval-checker" ClassVal Checker-->
<h3 id="classval-checker" class="subsection">24.2.1 ClassVal Checker <a href="#classval-checker"><img src="chainlink.svg" width="10" height="10"></a></h3><!--SEC END --><p>The ClassVal Checker defines the following annotations:</p><dl class="description"><dt class="dt-description">
<a href="../api/org/checkerframework/common/reflection/qual/ClassVal.html"><span style="font-weight:bold"><span style="font-family:monospace">@ClassVal</span></span></a><span style="font-weight:bold"><span style="font-family:monospace">(String[] value)</span></span></dt><dd class="dd-description">
If an expression has <span style="font-family:monospace">@ClassVal</span> type with a single argument,
then its exact run-time value is known at compile time.
For example, <span style="font-family:monospace">@ClassVal("java.util.HashMap")</span>
indicates that the <span style="font-family:monospace">Class</span> object represents the <span style="font-family:monospace">java.util.HashMap</span> class.<p>If multiple arguments are given, then the expression’s run-time value is
known to be in that set.</p><p>Each argument is a “fully-qualified binary name”
(<a href="../api/org/checkerframework/checker/signature/qual/FqBinaryName.html"><span style="font-family:monospace">@FqBinaryName</span></a>): a primitive or binary name
(<a href="https://docs.oracle.com/javase/specs/jls/se17/html/jls-13.html#jls-13.1">JLS
§13.1</a>), possibly followed by array brackets.</p></dd><dt class="dt-description"><a href="../api/org/checkerframework/common/reflection/qual/ClassBound.html"><span style="font-weight:bold"><span style="font-family:monospace">@ClassBound</span></span></a><span style="font-weight:bold"><span style="font-family:monospace">(String[] value)</span></span></dt><dd class="dd-description">
If an expression has <span style="font-family:monospace">@ClassBound</span> type, then its run-time value is known
to be upper-bounded by that type.
For example,
<span style="font-family:monospace">@ClassBound("java.util.HashMap")</span> indicates that the <span style="font-family:monospace">Class</span> object
represents <span style="font-family:monospace">java.util.HashMap</span> or a subclass of it.<p>If multiple arguments are given, then the run-time value is equal to or a
subclass of some class in that set.</p><p>Each argument is a “fully-qualified binary name”
(<a href="../api/org/checkerframework/checker/signature/qual/FqBinaryName.html"><span style="font-family:monospace">@FqBinaryName</span></a>): a primitive or binary name
(<a href="https://docs.oracle.com/javase/specs/jls/se17/html/jls-13.html#jls-13.1">JLS
§13.1</a>), possibly followed by array brackets.</p></dd><dt class="dt-description"><a href="../api/org/checkerframework/common/reflection/qual/UnknownClass.html"><span style="font-weight:bold"><span style="font-family:monospace">@UnknownClass</span></span></a></dt><dd class="dd-description"> Indicates that there is no
compile-time information about the run-time value of the class — or
that the Java type is not <span style="font-family:monospace">Class</span>.
This is the default qualifier, and it may not be written in source code.</dd><dt class="dt-description"><a href="../api/org/checkerframework/common/reflection/qual/ClassValBottom.html"><span style="font-weight:bold"><span style="font-family:monospace">@ClassValBottom</span></span></a></dt><dd class="dd-description"> Type given to the <span style="font-family:monospace">null</span> literal.
It may not be written in source code.
</dd></dl><blockquote class="figure"><div class="center"><hr class="floatrule"></div>
<div class="center">
<img src="classval.svg">
</div>
<div class="caption"><table style="border-spacing:6px;border-collapse:separate;" class="cellpading0"><tr><td style="vertical-align:top;text-align:left;" >Figure 24.1: Partial type hierarchy for the ClassVal type system. The type qualifiers in gray (<span style="font-family:monospace">@UnknownClass</span>
and <span style="font-family:monospace">@ClassValBottom</span>) should never be written in source code; they are used internally by the type system.</td></tr>
</table></div>
<a id="fig-classval-hierarchy"></a>
<div class="center"><hr class="floatrule"></div></blockquote>
<!--TOC subsubsection id="classval-subtyping-rules" Subtyping rules-->
<h4 id="classval-subtyping-rules" class="subsubsection">Subtyping rules <a href="#classval-subtyping-rules"><img src="chainlink.svg" width="10" height="10"></a></h4><!--SEC END --><p>
Figure ‍<a href="#fig-classval-hierarchy">24.1</a> shows part of the type hierarchy of the
ClassVal type system.
<span style="font-family:monospace">@ClassVal(A)</span> is a subtype of <span style="font-family:monospace">@ClassVal(B)</span> if A is a subset of B.
<span style="font-family:monospace">@ClassBound(A)</span> is a subtype of <span style="font-family:monospace">@ClassBound(B)</span> if A is a subset of B.
<span style="font-family:monospace">@ClassVal(A)</span> is a subtype of <span style="font-family:monospace">@ClassBound(B)</span> if A is a subset of B.</p>
<!--TOC subsection id="methodval-checker" MethodVal Checker-->
<h3 id="methodval-checker" class="subsection">24.2.2 MethodVal Checker <a href="#methodval-checker"><img src="chainlink.svg" width="10" height="10"></a></h3><!--SEC END --><p>The MethodVal Checker defines the following annotations:</p><dl class="description"><dt class="dt-description">
<a href="../api/org/checkerframework/common/reflection/qual/MethodVal.html"><span style="font-weight:bold"><span style="font-family:monospace">@MethodVal</span></span></a><span style="font-weight:bold"><span style="font-family:monospace">(String[] className, String[] methodName, int[] params)</span></span></dt><dd class="dd-description">
Indicates that an expression of type <span style="font-family:monospace">Method</span> or <span style="font-family:monospace">Constructor</span> has a
run-time value in a given set. If the set has size <span style="font-style:italic">n</span>, then each of
<span style="font-family:monospace">@MethodVal</span>’s arguments is an array of size <span style="font-style:italic">n</span>, and the <span style="font-style:italic">i</span>th method in the set is
represented by { className[i], methodName[i], params[i] }.
For a constructor, the method name is “<span style="font-family:monospace">&lt;init&gt;</span>”.
<p>Consider the following example:</p><pre class="verbatim">@MethodVal(className={"java.util.HashMap", "java.util.HashMap"},
           methodName={"containsKey", "containsValue"},
           params={1, 1})
</pre><p>This <span style="font-family:monospace">@MethodVal</span> annotation indicates that the <span style="font-family:monospace">Method</span>
is either <span style="font-family:monospace">HashMap.containsKey</span> with 1 formal parameter or
<span style="font-family:monospace">HashMap.containsValue</span> with 1 formal parameter.</p><p>The <span style="font-family:monospace">@MethodVal</span> type qualifier indicates the number of
parameters that the method takes, but not their type. This means that the
Checker Framework’s reflection resolution cannot distinguish among
overloaded methods.</p></dd><dt class="dt-description"><a href="../api/org/checkerframework/common/reflection/qual/UnknownMethod.html"><span style="font-weight:bold"><span style="font-family:monospace">@UnknownMethod</span></span></a></dt><dd class="dd-description"> Indicates that there is no
compile-time information about the run-time value of the method — or
that the Java type is not <span style="font-family:monospace">Method</span> or <span style="font-family:monospace">Constructor</span>.
This is the default qualifier, and it may not be written in source code.</dd><dt class="dt-description"><a href="../api/org/checkerframework/common/reflection/qual/MethodValBottom.html"><span style="font-weight:bold"><span style="font-family:monospace">@MethodValBottom</span></span></a></dt><dd class="dd-description"> Type given to the <span style="font-family:monospace">null</span> literal.
It may not be written in source code.
</dd></dl><blockquote class="figure"><div class="center"><hr class="floatrule"></div>
<div class="center">
<img src="methodval.svg">
</div>
<div class="caption"><table style="border-spacing:6px;border-collapse:separate;" class="cellpading0"><tr><td style="vertical-align:top;text-align:left;" >Figure 24.2: Partial type hierarchy for the MethodVal type system. The type qualifiers in gray (<span style="font-family:monospace">@UnknownMethod</span>
and <span style="font-family:monospace">@MethodValBottom</span>) should never be written in source code; they are used internally by the type system.</td></tr>
</table></div>
<a id="fig-methodval-hierarchy"></a>
<div class="center"><hr class="floatrule"></div></blockquote>
<!--TOC subsubsection id="methodval-subtyping-rules" Subtyping rules-->
<h4 id="methodval-subtyping-rules" class="subsubsection">Subtyping rules <a href="#methodval-subtyping-rules"><img src="chainlink.svg" width="10" height="10"></a></h4><!--SEC END --><p>
Figure ‍<a href="#fig-methodval-hierarchy">24.2</a> shows part of the type hierarchy of the
MethodVal type system. <span style="font-family:monospace">@MethodVal(classname=CA, methodname=MA, params=PA)</span> is a subtype of
<span style="font-family:monospace">@MethodVal(classname=CB, methodname=MB, params=PB)</span> if</p><table class="display dcenter"><tr style="vertical-align:middle"><td class="dcell">∀ indexes <span style="font-style:italic">i</span> ∃ an index <span style="font-style:italic">j</span>:  <span style="font-style:italic">CA</span>[<span style="font-style:italic">i</span>] = <span style="font-style:italic">CB</span>[<span style="font-style:italic">j</span>], <span style="font-style:italic">MA</span>[<span style="font-style:italic">i</span>] = <span style="font-style:italic">MA</span>[<span style="font-style:italic">j</span>], <span style="font-style:italic">and</span> <span style="font-style:italic">PA</span>[<span style="font-style:italic">i</span>] = <span style="font-style:italic">PB</span>[<span style="font-style:italic">j</span>]</td></tr>
</table><p>where CA, MA, and PA are lists of equal size and CB, MB, and PB are lists of equal size.</p>
<!--TOC subsection id="methodval-and-classval-inference" MethodVal and ClassVal inference-->
<h3 id="methodval-and-classval-inference" class="subsection">24.2.3 MethodVal and ClassVal inference <a href="#methodval-and-classval-inference"><img src="chainlink.svg" width="10" height="10"></a></h3><!--SEC END --><p>The developer rarely has to write <span style="font-family:monospace">@ClassVal</span> or <span style="font-family:monospace">@MethodVal</span>
annotations, because the Checker Framework infers them according to
Figure ‍<a href="#fig%3Areflection-inference">24.3</a>. Most readers can skip this
section, which explains the inference rules.</p><blockquote class="figure"><div class="center"><hr class="floatrule"></div><div class="center">
<span style="font-size:small">
<img src="manual001.png" srcset="manual001.svg, manual001.png"></span>
</div><div class="caption"><table style="border-spacing:6px;border-collapse:separate;" class="cellpading0"><tr><td style="vertical-align:top;text-align:left;" >Figure 24.3: <a id="fig:reflection-inference"></a>Example inference rules for @ClassVal, @ClassBound, and @MethodVal.
Additional rules exist for expressions with similar semantics but that call
methods with different names or signatures.
</td></tr>
</table></div><div class="center"><hr class="floatrule"></div></blockquote><p>The ClassVal Checker infers the exact class name (<span style="font-family:monospace">@ClassVal</span>) for a
<span style="font-family:monospace">Class</span> literal (<span style="font-family:monospace">C.class</span>), and for a static method call (e.g.,
<span style="font-family:monospace">Class.forName(arg)</span>, <span style="font-family:monospace">ClassLoader.loadClass(arg)</span>, ...) if the argument is a
statically computable expression. In contrast, it infers an upper bound
(<span style="font-family:monospace">@ClassBound</span>) for instance method calls (e.g., <span style="font-family:monospace">obj.getClass()</span>).</p><p>The MethodVal Checker infers <span style="font-family:monospace">@MethodVal</span> annotations for <span style="font-family:monospace">Method</span> and
<span style="font-family:monospace">Constructor</span> types that have been created using a method call to Java’s Reflection
API:
</p><ul class="itemize"><li class="li-itemize">
<span style="font-family:monospace">Class.getMethod(String name, Class&lt;?&gt;... ‍paramTypes)</span>
</li><li class="li-itemize"><span style="font-family:monospace">Class.getConstructor(Class&lt;?&gt;... ‍paramTypes)</span>
</li></ul><p>Note that an exact class name is necessary to precisely resolve
reflectively-invoked constructors since a constructor in a subclass does not
override a constructor in its superclass. This means that the MethodVal Checker
does not infer a <span style="font-family:monospace">@MethodVal</span> annotation for <span style="font-family:monospace">Class.getConstructor</span> if the
type of that class is <span style="font-family:monospace">@ClassBound</span>. In contrast, either an exact class name or a bound
is adequate to resolve reflectively-invoked methods because of the subtyping
rules for overridden methods.</p><hr>
<!--TOC chapter id="initialized-fields-checker" Initialized Fields Checker-->
<h1 id="initialized-fields-checker" class="chapter">Chapter ‍25 Initialized Fields Checker <a href="#initialized-fields-checker"><img src="chainlink.svg" width="10" height="10"></a></h1><!--SEC END --><p>The Initialized Fields Checker warns if a constructor does not initialize a
field.</p>
<!--TOC section id="initialized-fields-checker-running" Running the Initialized Fields Checker-->
<h2 id="initialized-fields-checker-running" class="section">25.1 Running the Initialized Fields Checker <a href="#initialized-fields-checker-running"><img src="chainlink.svg" width="10" height="10"></a></h2><!--SEC END --><p>An example invocation is</p><pre class="verbatim">javac -processor org.checkerframework.common.initializedfields.InitializedFieldsChecker MyFile.java
</pre><p>If you run it together with other checkers, then it issues warnings only if
the default value assigned by Java (0, false, or null) is not consistent
with the field’s annotation, for the other checkers.
An example invocation is</p><pre class="verbatim">javac -processor ValueChecker,InitializedFieldsChecker MyFile.java
</pre>
<!--TOC section id="initialized-fields-motivation" Motivation: uninitialized fields-->
<h2 id="initialized-fields-motivation" class="section">25.2 Motivation: uninitialized fields <a href="#initialized-fields-motivation"><img src="chainlink.svg" width="10" height="10"></a></h2><!--SEC END --><p>Without the Initialized Fields Checker, every type system is
unsound with respect to fields that are never set. (Exception: The
Nullness Checker (Chapter ‍<a href="#nullness-checker">3</a>) is sound. Also, a type
system is sound if every annotation is consistent with 0, false, and null.)
Consider the following code:</p><pre class="verbatim">import org.checkerframework.checker.index.qual.Positive;

class MyClass {
  @Positive int x;
  MyClass() {
    // empty body
  }

  @Positive int getX() {
    return x;
  }
}
</pre><p>Method <span style="font-family:monospace">getX</span> is incorrect because it returns 0, which is not positive.
However, the code type-checks because there is never an assignment to <span style="font-family:monospace">x</span>
whose right-hand side is not positive.
If you run the Index Checker together with the Initialized Fields Checker,
then the code correctly does not type-check.</p>
<!--TOC subsubsection id="initialized-fields-remaining-unsoundness" Remaining unsoundness-->
<h4 id="initialized-fields-remaining-unsoundness" class="subsubsection">Remaining unsoundness <a href="#initialized-fields-remaining-unsoundness"><img src="chainlink.svg" width="10" height="10"></a></h4><!--SEC END --><p>Even with the Initialized Fields Checker, every type system (except the
Nullness Checker, Chapter ‍<a href="#nullness-checker">3</a>) is unsound with
respect to partially-initialized fields. Consider the following code:</p><pre class="verbatim">import org.checkerframework.checker.index.qual.Positive;

class MyClass {
  @Positive int x;
  MyClass() {
    foo(this);
    x = 1;
  }

  @Positive int foo() {
    // ... use x, expecting it to be positive ...
  }
}
</pre><p>Within method <span style="font-family:monospace">foo</span>, <span style="font-family:monospace">x</span> can have the value 0 even though the type of
<span style="font-family:monospace">x</span> is <span style="font-family:monospace">@Positive int</span>.</p>
<!--TOC section id="initialized-fields-example" Example-->
<h2 id="initialized-fields-example" class="section">25.3 Example <a href="#initialized-fields-example"><img src="chainlink.svg" width="10" height="10"></a></h2><!--SEC END --><p>As an example, consider the following code:</p><pre class="verbatim">import org.checkerframework.checker.index.qual.Positive;

class MyClass {

  @Positive int x;
  @Positive int y;
  int z;

  // Warning: field y is not initialized
  MyClass() {
    x = 1;
  }
}
</pre><p>When run by itself, the Initialized Fields Checker warns that fields <span style="font-family:monospace">y</span>
and field <span style="font-family:monospace">z</span> are not set.</p><p>When run together with the Index Checker, the Initialized Fields Checker
warns that field <span style="font-family:monospace">y</span> is not set. It does not warn about field <span style="font-family:monospace">z</span>,
because its default value (0) is consistent with its annotations.</p>
<!--TOC section id="initialized-fields-annotations" Annotations-->
<h2 id="initialized-fields-annotations" class="section">25.4 Annotations <a href="#initialized-fields-annotations"><img src="chainlink.svg" width="10" height="10"></a></h2><!--SEC END --><p>The Initialized Fields type system uses the following type annotations:
</p><dl class="description"><dt class="dt-description">
<a href="../api/org/checkerframework/common/initializedfields/qual/InitializedFields.html"><span style="font-weight:bold"><span style="font-family:monospace">@InitializedFields</span></span></a></dt><dd class="dd-description">
indicates which fields have definitely been initialized so far.
</dd><dt class="dt-description"><a href="../api/org/checkerframework/common/initializedfields/qual/InitializedFieldsBottom.html"><span style="font-weight:bold"><span style="font-family:monospace">@InitializedFieldsBottom</span></span></a></dt><dd class="dd-description">
is the type of <span style="font-family:monospace">null</span>. Programmers rarely write this type.
</dd><dt class="dt-description"><a href="../api/org/checkerframework/common/initializedfields/qual/PolyInitializedFields.html"><span style="font-weight:bold"><span style="font-family:monospace">@PolyInitializedFields</span></span></a></dt><dd class="dd-description">
is a qualifier that is polymorphic over field initialization.
For a description of qualifier polymorphism, see
Section ‍<a href="#method-qualifier-polymorphism">30.2</a>.
</dd></dl><blockquote class="figure"><div class="center"><hr class="floatrule"></div>
<div class="center">
<img src="initializedfields.svg">
</div>
<div class="caption"><table style="border-spacing:6px;border-collapse:separate;" class="cellpading0"><tr><td style="vertical-align:top;text-align:left;" >Figure 25.1: The type qualifier hierarchy of the Initialized Fields Checker.
<span style="font-family:monospace">@InitializedFieldsBottom</span> is rarely written by a programmer.</td></tr>
</table></div>
<a id="fig-initialized-fields-hierarchy"></a>
<div class="center"><hr class="floatrule"></div></blockquote><p>Figure ‍<a href="#fig-initialized-fields-hierarchy">25.1</a> shows the subtyping
relationships among the type qualifiers.</p><p>There is also a method declaration annotation:</p><dl class="description"><dt class="dt-description">
<a href="../api/org/checkerframework/common/initializedfields/qual/EnsuresInitializedFields.html"><span style="font-weight:bold"><span style="font-family:monospace">@EnsuresInitializedFields</span></span></a></dt><dd class="dd-description">
indicates which fields the method sets. Use this for helper methods that
are called from a constructor.
</dd></dl>
<!--TOC section id="initialized-fields-vs-initialization" Comparison to the Initialization Checker-->
<h2 id="initialized-fields-vs-initialization" class="section">25.5 Comparison to the Initialization Checker <a href="#initialized-fields-vs-initialization"><img src="chainlink.svg" width="10" height="10"></a></h2><!--SEC END --><p>The Initialized Fields Checker is a lightweight version of the Initialization Checker
(Section ‍<a href="#initialization-checker">3.8</a>). Here is a comparison between them.</p><table border=1  style="border-spacing:0;" class="cellpadding1"><tr><td style="text-align:left;border:solid 1px;white-space:nowrap" ><span style="font-size:small">&nbsp;</span></td><td style="text-align:left;border:solid 1px;white-space:nowrap" ><span style="font-size:small">Initialization Checker</span></td><td style="text-align:left;border:solid 1px;white-space:nowrap" ><span style="font-size:small">Initialized Fields Checker
</span></td></tr>
<tr><td style="text-align:left;border:solid 1px;white-space:nowrap" ><span style="font-size:small"> superclasses</span></td><td style="text-align:left;border:solid 1px;white-space:nowrap" ><span style="font-size:small">tracks initialization of supertype fields</span></td><td style="text-align:left;border:solid 1px;white-space:nowrap" ><span style="font-size:small">checks one class at a time
</span></td></tr>
<tr><td style="text-align:left;border:solid 1px;white-space:nowrap" ><span style="font-size:small"> partial initialization</span></td><td style="text-align:left;border:solid 1px;white-space:nowrap" ><span style="font-size:small">changes the types of fields that are not initialized</span></td><td style="text-align:left;border:solid 1px;white-space:nowrap" ><span style="font-size:small">unsound treatment of partially-initialized objects (*)
</span></td></tr>
<tr><td style="text-align:left;border:solid 1px;white-space:nowrap" ><span style="font-size:small"> type systems</span></td><td style="text-align:left;border:solid 1px;white-space:nowrap" ><span style="font-size:small">works only with the Nullness Checker (**)</span></td><td style="text-align:left;border:solid 1px;white-space:nowrap" ><span style="font-size:small">works for any type system
</span></td></tr>
<tr><td style="text-align:left;border:solid 1px;white-space:nowrap" ><span style="font-size:small"> disabling</span></td><td style="text-align:left;border:solid 1px;white-space:nowrap" ><span style="font-size:small">always runs with the Nullness Checker</span></td><td style="text-align:left;border:solid 1px;white-space:nowrap" ><span style="font-size:small">can be enabled/disabled per run
</span></td></tr>
</table><p><span style="font-size:small">* See Section ‍</span><a href="#initialized-fields-remaining-unsoundness"><span style="font-size:small">25.2</span></a><span style="font-size:small"> for an example.
<br>
** The Initialization Checker could be made to work with any type system, but
doing so would require changing the implementation of both the type system and
the Initialization Checker.
</span></p><hr>
<!--TOC chapter id="aliasing-checker" Aliasing Checker-->
<h1 id="aliasing-checker" class="chapter">Chapter ‍26 Aliasing Checker <a href="#aliasing-checker"><img src="chainlink.svg" width="10" height="10"></a></h1><!--SEC END --><p>The Aliasing Checker identifies expressions that definitely have no
aliases.</p><p>Two expressions are aliased when they have the same non-primitive value;
that is, they are references to the identical Java object
in the heap. Another way of saying this is that two expressions,
<span style="font-style:italic">exprA</span> and <span style="font-style:italic">exprB</span>, are aliases of each other when
<span style="font-style:italic">exprA</span> <span style="font-family:monospace">==</span> <span style="font-style:italic">exprB</span> at the same program point.</p><p>Assigning to a variable or field typically creates an alias. For example,
after the statement <span style="font-family:monospace">a = b;</span>, the variables <span style="font-family:monospace">a</span> and <span style="font-family:monospace">b</span> are aliased.</p><p>Knowing that an expression is not aliased permits more accurate reasoning
about how side effects modify the expression’s value.</p><p>To run the Aliasing Checker, supply the
<span style="font-family:monospace">-processor org.checkerframework.common.aliasing.AliasingChecker</span>
command-line option to javac.
However, a user rarely runs the Aliasing Checker directly.
This type system is mainly intended to be used together with other type systems.
For example, the SPARTA information flow type-checker
(Section ‍<a href="#sparta-checker">29.20</a>) uses the Aliasing Checker to improve its
type refinement — if an expression has no aliases, a more refined type
can often be inferred, otherwise the type-checker makes conservative
assumptions.</p>
<!--TOC section id="aliasing-annotations" Aliasing annotations-->
<h2 id="aliasing-annotations" class="section">26.1 Aliasing annotations <a href="#aliasing-annotations"><img src="chainlink.svg" width="10" height="10"></a></h2><!--SEC END --><blockquote class="figure"><div class="center"><hr class="floatrule"></div>
<div class="center">
<img src="aliasing.svg">
</div>
<div class="caption"><table style="border-spacing:6px;border-collapse:separate;" class="cellpading0"><tr><td style="vertical-align:top;text-align:left;" >Figure 26.1: Type hierarchy for the Aliasing type system.
These qualifiers are applicable to any reference (non-primitive) type.</td></tr>
</table></div>
<a id="fig-aliasing-hierarchy"></a>
<div class="center"><hr class="floatrule"></div></blockquote><p>There are two possible types for an expression:</p><dl class="description"><dt class="dt-description"><a href="../api/org/checkerframework/common/aliasing/qual/MaybeAliased.html"><span style="font-weight:bold"><span style="font-family:monospace">@MaybeAliased</span></span></a></dt><dd class="dd-description">
is the type of an expression that might have an alias.
This is the default, so every unannotated type is
<span style="font-family:monospace">@MaybeAliased</span>. (This includes the type of <span style="font-family:monospace">null</span>.)</dd><dt class="dt-description"><a href="../api/org/checkerframework/common/aliasing/qual/Unique.html"><span style="font-weight:bold"><span style="font-family:monospace">@Unique</span></span></a></dt><dd class="dd-description">
is the type of an expression that has no aliases.<p>The <span style="font-family:monospace">@Unique</span> annotation is only allowed at local variables, method
parameters, constructor results, and method returns.
A constructor’s result should be annotated with <span style="font-family:monospace">@Unique</span> only if the
constructor’s body does not creates an alias to the constructed object.</p></dd></dl><p>There are also two annotations, which are currently trusted instead of verified,
that can be used on formal parameters (including
the receiver parameter, <span style="font-family:monospace">this</span>):</p><dl class="description"><dt class="dt-description"><a href="../api/org/checkerframework/common/aliasing/qual/NonLeaked.html"><span style="font-weight:bold"><span style="font-family:monospace">@NonLeaked</span></span></a></dt><dd class="dd-description">
identifies a formal parameter that is not leaked nor
returned by the method body.
For example, the formal parameter of the String copy constructor,
<span style="font-family:monospace">String(String s)</span>, is <span style="font-family:monospace">@NonLeaked</span> because the body of the method
only makes a copy of the parameter.</dd><dt class="dt-description"><a href="../api/org/checkerframework/common/aliasing/qual/LeakedToResult.html"><span style="font-weight:bold"><span style="font-family:monospace">@LeakedToResult</span></span></a></dt><dd class="dd-description">
is used when the parameter may be returned, but it is not
otherwise leaked.
For example, the receiver parameter of <span style="font-family:monospace">StringBuffer.append(StringBuffer
this, String s)</span> is
<span style="font-family:monospace">@LeakedToResult</span>, because the method returns the updated receiver.</dd></dl>
<!--TOC section id="aliasing-leaking-contexts" Leaking contexts-->
<h2 id="aliasing-leaking-contexts" class="section">26.2 Leaking contexts <a href="#aliasing-leaking-contexts"><img src="chainlink.svg" width="10" height="10"></a></h2><!--SEC END --><p>
This section lists the expressions that create aliases. These are also
called “leaking contexts”.</p><dl class="description"><dt class="dt-description">
<span style="font-weight:bold">Assignments</span></dt><dd class="dd-description">
After an assignment, the left-hand side and the right-hand side are
typically aliased. (The only counterexample is when the right-hand side is
a fresh expression; see Section ‍<a href="#aliasing-refinement">26.4</a>.)<pre class="verbatim">  @Unique Object u = ...;
  Object o = u;                    // (not.unique) type-checking error!
</pre><p>If this example type-checked, then <span style="font-family:monospace">u</span> and <span style="font-family:monospace">o</span> would be aliased.
For this example to type-check, either the <span style="font-family:monospace">@Unique</span> annotation on the
type of <span style="font-family:monospace">u</span>, or the <span style="font-family:monospace">o = u;</span> assignment, must be removed.</p></dd><dt class="dt-description"><span style="font-weight:bold">Method calls and returns (pseudo-assignments)</span></dt><dd class="dd-description">
Passing an argument to a method is a “pseudo-assignment” because it effectively
assigns the argument to the formal parameter. Return statements are also
pseudo-assignments.
As with assignments, the left-hand side and right-hand side of
pseudo-assignments are typically aliased.<p>Here is an example for argument-passing:</p><pre class="verbatim">  void mightDoAnything(Object o) { ... }

  @Unique Object u = ...;
  mightDoAnything(u);  // type-checking error, because the callee may create an alias of the passed argument
</pre><p>Passing a non-aliased
reference to a method does not necessarily create an alias.
However, the body of the method might create an alias or leak the
reference. Thus, the Aliasing Checker always treats a method call as
creating aliases for each argument unless the corresponding formal
parameter is marked as
@<a href="../api/org/checkerframework/common/aliasing/qual/NonLeaked.html"><span style="font-family:monospace">@NonLeaked</span></a> or
@<a href="../api/org/checkerframework/common/aliasing/qual/LeakedToResult.html"><span style="font-family:monospace">@LeakedToResult</span></a>.</p><p>Here is an example for a return statement:</p><pre class="verbatim">Object id(@Unique Object p) {
    return p;     // (not.unique) type-checking error!
}
</pre><p>If this code type-checked, then it would be possible for clients to write
code like this:</p><pre class="verbatim">@Unique Object u = ...;
Object o = id(u);
</pre><p>after which there is an alias to <span style="font-family:monospace">u</span> even though it is declared as <span style="font-family:monospace">@Unique</span>.</p><p>However, it is permitted to write</p><pre class="verbatim">Object id(@LeakedToResult Object p) {
    return p;
}
</pre><p>after which the following code type-checks:</p><pre class="verbatim">@Unique Object u = ...;
id(u);                   // method call result is not used
Object o1 = ...;
Object o2 = id(o1);      // argument is not @Unique
</pre></dd><dt class="dt-description"><span style="font-weight:bold">Throws</span></dt><dd class="dd-description">
A thrown exception can be captured by a catch block, which creates an
alias of the thrown exception.<pre class="verbatim">void aliasInCatchBlock() {
    @Unique Exception uex = new Exception();
    try {
        throw uex;    // (not.unique) type-checking error!
    } catch (Exception ex) {
        // uex and ex refer to the same object here.
    }
}
</pre></dd><dt class="dt-description"><span style="font-weight:bold">Array initializers</span></dt><dd class="dd-description"><p>Array initializers assign the elements in the initializers to corresponding
indexes in the array, therefore expressions in an array initializer are leaked.</p><pre class="verbatim">void aliasInArrayInitializer() {
    @Unique Object o = new Object();
    Object[] ar = new Object[] { o };  // (not.unique) type-checking error!
    // The expressions o and ar[0] are now aliased.
}
</pre></dd></dl>
<!--TOC section id="aliasing-unique-restrictions" Restrictions on where <span style="font-family:monospace">@Unique</span> may be written-->
<h2 id="aliasing-unique-restrictions" class="section">26.3 Restrictions on where <span style="font-family:monospace">@Unique</span> may be written <a href="#aliasing-unique-restrictions"><img src="chainlink.svg" width="10" height="10"></a></h2><!--SEC END --><p>The <span style="font-family:monospace">@Unique</span> qualifier may not be written on locations such as fields,
array elements, and type parameters.</p><p>As an example of why <span style="font-family:monospace">@Unique</span> may not be written on a field’s type,
consider the following code:</p><pre class="verbatim">class MyClass {
    @Unique Object field;
    void makesAlias() {
        MyClass myClass2 = this;
        // this.field is now an alias of myClass2.field
    }
}
</pre><p>That code must not type-check, because <span style="font-family:monospace">field</span> is declared as <span style="font-family:monospace">@Unique</span>
but has an alias. The Aliasing Checker solves the problem by forbidding
the <span style="font-family:monospace">@Unique</span> qualifier on subcomponents of a structure, such as fields.
Other solutions might be possible; they would be more complicated but would
permit more code to type-check.</p><p><span style="font-family:monospace">@Unique</span> may not be written on a type parameter for similar reasons.
The assignment</p><pre class="verbatim">List&lt;@Unique Object&gt; l1 = ...;
List&lt;@Unique Object&gt; l2 = l1;
</pre><p>must be forbidden because it would alias <span style="font-family:monospace">l1.get(0)</span> with <span style="font-family:monospace">l2.get(0)</span>
even though both have type <span style="font-family:monospace">@Unique</span>. The Aliasing Checker forbids this
code by rejecting the type <span style="font-family:monospace">List&lt;@Unique Object&gt;</span>.</p>
<!--TOC section id="aliasing-refinement" Aliasing type refinement-->
<h2 id="aliasing-refinement" class="section">26.4 Aliasing type refinement <a href="#aliasing-refinement"><img src="chainlink.svg" width="10" height="10"></a></h2><!--SEC END --><p>Type refinement enables a type checker to treat an expression as a subtype
of its declared type. For example, even if you declare a local variable as
<span style="font-family:monospace">@MaybeAliased</span> (or don’t write anything, since <span style="font-family:monospace">@MaybeAliased</span> is the
default), sometimes the Aliasing Checker can determine that it is actually
<span style="font-family:monospace">@Unique</span>.
For more details, see Section ‍<a href="#type-refinement">31.7</a>.</p><p>The Aliasing Checker treats type refinement in the usual way,
except that at (pseudo-)assignments
the right-hand-side (RHS) may lose its type refinement, before the
left-hand-side (LHS) is type-refined.
The RHS always loses its type refinement (it is widened to
<span style="font-family:monospace">@MaybeAliased</span>, and its declared type must have been
<span style="font-family:monospace">@MaybeAliased</span>) except in the following cases:</p><ul class="itemize"><li class="li-itemize">
The RHS is a fresh expression — an expression that returns a different value
each time it is evaluated. In practice, this is only method/constructor calls
with <span style="font-family:monospace">@Unique</span> return type. A variable/field is not fresh because it can
return the same value when evaluated twice.
</li><li class="li-itemize">The LHS is a <span style="font-family:monospace">@NonLeaked</span> formal parameter and the RHS is an argument in a
method call or constructor invocation.
</li><li class="li-itemize">The LHS is a <span style="font-family:monospace">@LeakedToResult</span> formal parameter, the RHS is an argument in
a method call or constructor invocation, and the method’s return value is
discarded — that is, the method call or constructor invocation is written
syntactically as a statement rather than as a part of a larger expression or
statement.
</li></ul><p>A consequence of the above rules is that most method calls are treated conservatively.
If a variable with declared type <span style="font-family:monospace">@MaybeAliased</span> has been refined
to <span style="font-family:monospace">@Unique</span> and is used as an argument of a method call, it usually loses its
<span style="font-family:monospace">@Unique</span> refined type.</p><p>Figure ‍<a href="#fig-aliasing-refinement-example">26.2</a> gives an example of the Aliasing Checker’s
type refinement rules.</p><blockquote class="figure"><div class="center"><hr class="floatrule"></div>
<pre class="verbatim">// Annotations on the StringBuffer class, used in the examples below.
// class StringBuffer {
//  @Unique StringBuffer();
//  StringBuffer append(@LeakedToResult StringBuffer this, @NonLeaked String s);
// }

void foo() {
    StringBuffer sb = new StringBuffer();    // sb is refined to @Unique.

    StringBuffer sb2 = sb;                   // sb loses its refinement.
    // Both sb and sb2 have aliases and because of that have type @MaybeAliased.
}

void bar() {
    StringBuffer sb = new StringBuffer();     // sb is refined to @Unique.

    sb.append("someString");
    // sb stays @Unique, as no aliases are created.

    StringBuffer sb2 = sb.append("someString");
    // sb is leaked and becomes @MaybeAliased.

    // Both sb and sb2 have aliases and because of that have type @MaybeAliased.
}

</pre>
<div class="caption"><table style="border-spacing:6px;border-collapse:separate;" class="cellpading0"><tr><td style="vertical-align:top;text-align:left;" >Figure 26.2: Example of the Aliasing Checker’s type refinement rules.</td></tr>
</table></div>
<a id="fig-aliasing-refinement-example"></a>
<div class="center"><hr class="floatrule"></div></blockquote><hr>
<!--TOC chapter id="must-call-checker" Must Call Checker-->
<h1 id="must-call-checker" class="chapter">Chapter ‍27 Must Call Checker <a href="#must-call-checker"><img src="chainlink.svg" width="10" height="10"></a></h1><!--SEC END --><p>The Must Call Checker conservatively over-approximates
the set of methods that an object should call before it is de-allocated.
The checker does not enforce any rules other than subtyping;
in particular, it does not enforce that the methods are called before
objects are de-allocated.
The Must Call Checker is intended to be run as a subchecker of another checker.
The primary client
of the Must Call Checker is the Resource Leak Checker (Section ‍<a href="#resource-leak-checker">8</a>),
which enforces that every method in a must-call obligation for an expression is called
before that expression is de-allocated.</p><p>For example, consider a <span style="font-family:monospace">java.io.OutputStream</span>. This <span style="font-family:monospace">OutputStream</span>
might have an obligation to call the <span style="font-family:monospace">close()</span> method, to release an
underlying file resource. The type of this <span style="font-family:monospace">OutputStream</span> is
<span style="font-family:monospace">@MustCall({"close"})</span>. Or, the <span style="font-family:monospace">OutputStream</span> might not have such an
obligation, if the underlying resource is a byte array. The type of this
<span style="font-family:monospace">OutputStream</span> is <span style="font-family:monospace">@MustCall({})</span>.
For an arbitrary <span style="font-family:monospace">OutputStream</span>, the Must Call
Checker over-approximates the methods that it should call by assigning it
the type <span style="font-family:monospace">@MustCall({"close"}) OutputStream</span>, which can be read as “an
OutputStream that might need to call <span style="font-family:monospace">close()</span> (but no other methods)
before it is de-allocated”.</p><p>If you are running the Resource Leak Checker
(Chapter ‍<a href="#resource-leak-checker">8</a>), then there is no need to run the
Must Call Checker, because the Resource Leak Checker does so automatically.
Running both may lead to warning suppressions for the Must Call Checker not
working.</p>
<!--TOC section id="must-call-annotations" Must Call annotations-->
<h2 id="must-call-annotations" class="section">27.1 Must Call annotations <a href="#must-call-annotations"><img src="chainlink.svg" width="10" height="10"></a></h2><!--SEC END --><p>The Must Call Checker supports these type qualifiers:</p><dl class="description"><dt class="dt-description"><a href="../api/org/checkerframework/checker/mustcall/qual/MustCall.html"><span style="font-weight:bold"><span style="font-family:monospace">@MustCall</span></span></a><span style="font-weight:bold"><span style="font-family:monospace">(String[] value)</span></span></dt><dd class="dd-description">
gives a superset of the methods that
must be called before the expression’s value is de-allocated.
The annotation is not refined after a method is called; an expression of
type <span style="font-family:monospace">@MustCall("foo")</span> might or might not have already had <span style="font-family:monospace">foo()</span>
called on it.
The default type qualifier for an unannotated type is <span style="font-family:monospace">@MustCall({})</span>.</dd><dt class="dt-description"><a href="../api/org/checkerframework/checker/mustcall/qual/MustCallUnknown.html"><span style="font-weight:bold"><span style="font-family:monospace">@MustCallUnknown</span></span></a></dt><dd class="dd-description">
represents a value with an unknown or infinite set of must-call obligations.
It is used internally by the type system but should never be written by a
programmer.</dd><dt class="dt-description"><a href="../api/org/checkerframework/checker/mustcall/qual/PolyMustCall.html"><span style="font-weight:bold"><span style="font-family:monospace">@PolyMustCall</span></span></a></dt><dd class="dd-description">
is the polymorphic annotation for the Must Call type system.
For a description of polymorphic qualifiers, see
Section ‍<a href="#method-qualifier-polymorphism">30.2</a>.</dd><dt class="dt-description"><a href="../api/org/checkerframework/checker/mustcall/qual/InheritableMustCall.html"><span style="font-weight:bold"><span style="font-family:monospace">@InheritableMustCall</span></span></a><span style="font-weight:bold"><span style="font-family:monospace">(String[] value)</span></span></dt><dd class="dd-description">
is an alias of <span style="font-family:monospace">@MustCall</span> that can only be written on a class declaration.
It applies both to the class declaration on which it is written and also to all subclasses.
This frees the user of the need to write the <span style="font-family:monospace">@MustCall</span> annotation on every subclass.
See Section ‍<a href="#must-call-on-class">27.2</a> for details.</dd></dl><blockquote class="figure"><div class="center"><hr class="floatrule"></div>
<div class="center">
<img src="mustcall.svg">
</div>
<div class="caption"><table style="border-spacing:6px;border-collapse:separate;" class="cellpading0"><tr><td style="vertical-align:top;text-align:left;" >Figure 27.1: Part of the Must Call Checker’s type
qualifier hierarchy. The full hierarchy contains one <span style="font-family:monospace">@MustCall</span> annotation
for every combination of methods.
Qualifiers in gray are used internally by the type system but should
never be written by a programmer.</td></tr>
</table></div>
<a id="fig-must-call-hierarchy"></a>
<div class="center"><hr class="floatrule"></div></blockquote><p>Here are some facts about the type qualifier hierarchy, which is shown in
Figure ‍<a href="#fig-must-call-hierarchy">27.1</a>.
Any expression of type <span style="font-family:monospace">@MustCall({}) Object</span> also has type
<span style="font-family:monospace">@MustCall({"foo"}) Object</span>.
The type <span style="font-family:monospace">@MustCall({"foo"}) Object</span>
contains objects that need to call <span style="font-family:monospace">foo</span> and objects that need to call
nothing, but the type does not contain an
object that needs to call <span style="font-family:monospace">bar</span> (or both <span style="font-family:monospace">foo</span> and <span style="font-family:monospace">bar</span>).
<span style="font-family:monospace">@MustCall({"foo", "bar"}) Object</span> represents all objects that need to
call <span style="font-family:monospace">foo</span>, <span style="font-family:monospace">bar</span>, both, or neither; it cannot not represent an object that needs
to call some other method.</p>
<!--TOC section id="must-call-on-class" Writing <span style="font-family:monospace">@MustCall</span>/<span style="font-family:monospace">@InheritableMustCall</span> on a class-->
<h2 id="must-call-on-class" class="section">27.2 Writing <span style="font-family:monospace">@MustCall</span>/<span style="font-family:monospace">@InheritableMustCall</span> on a class <a href="#must-call-on-class"><img src="chainlink.svg" width="10" height="10"></a></h2><!--SEC END --><p>As explained in Section ‍<a href="#upper-bound-for-use">31.3</a>, a type
annotation on a type declaration means that every use of the type has that
annotation by default. If a class <span style="font-family:monospace">A</span>’s declaration has a <span style="font-family:monospace">@MustCall</span>
annotation, then <span style="font-family:monospace">A</span>’s subclasses usually should too. To do so, a programmer can either write
a <span style="font-family:monospace">@MustCall</span> annotation on every subclass, or can write <span style="font-family:monospace">@InheritableMustCall</span>
on only <span style="font-family:monospace">A</span>, which will cause the checker to treat every subclass as if
it has an identical <span style="font-family:monospace">@MustCall</span> annotation. The latter is the preferred style.</p><p>For example, given the following class annotation:
</p><pre class="verbatim">    package java.net;

    import org.checkerframework.checker.mustcall.qual.InheritableMustCall;

    @InheritableMustCall({"close"}) class Socket { }
</pre><p>
any use of <span style="font-family:monospace">Socket</span> or a subclass of <span style="font-family:monospace">Socket</span> defaults to <span style="font-family:monospace">@MustCall({"close"}) Socket</span>.</p><p>The <span style="font-family:monospace">@InheritableMustCall</span> annotation is necessary because type
annotations cannot be made inheritable. <span style="font-family:monospace">@InheritableMustCall</span> is
a declaration annotation.</p>
<!--TOC section id="must-call-non-owning-parameter" Relationship to lightweight ownership-->
<h2 id="must-call-non-owning-parameter" class="section">27.3 Relationship to lightweight ownership <a href="#must-call-non-owning-parameter"><img src="chainlink.svg" width="10" height="10"></a></h2><!--SEC END --><p>The Must Call Checker interacts with the <span style="font-family:monospace">@Owning</span> and <span style="font-family:monospace">@NotOwning</span> annotations of the
Resource Leak Checker (Section ‍<a href="#resource-leak-checker">8</a>). In particular, any location that
the Resource Leak Checker would consider “non-owning” (e.g., unannotated parameters, <span style="font-family:monospace">@NotOwning</span>
returns, etc.) is treated as <span style="font-family:monospace">@MustCall()</span> by the Must Call Checker. This can lead to surprising
results when running the Must Call Checker alone (which is not recommended). For example,
consider the following program:</p><pre class="verbatim">  @MustCall({"toString"}) String foo(@MustCall({"hashCode"}) String arg) {
    return arg;
  }
</pre><p>The Must Call Checker will not issue a warning about this code, because <span style="font-family:monospace">arg</span>
is non-owning (and therefore treated as <span style="font-family:monospace">@MustCall()</span>).</p>
<!--TOC section id="must-call-reflection" Assumptions about reflection-->
<h2 id="must-call-reflection" class="section">27.4 Assumptions about reflection <a href="#must-call-reflection"><img src="chainlink.svg" width="10" height="10"></a></h2><!--SEC END --><p>The Must Call Checker is unsound with respect to reflection: it assumes
that objects instantiated reflectively do not have must-call obligations (i.e., that their
type is <span style="font-family:monospace">@MustCall({})</span>. If the checker is run with <span style="font-family:monospace">-AresolveReflection</span>, then
this assumption applies only to types that cannot be resolved.</p>
<!--TOC section id="must-call-type-params" Type parameter bounds often need to be annotated-->
<h2 id="must-call-type-params" class="section">27.5 Type parameter bounds often need to be annotated <a href="#must-call-type-params"><img src="chainlink.svg" width="10" height="10"></a></h2><!--SEC END --><p>In an unannotated program, there may be mismatches between defaulted type
qualifiers that lead to type-checking errors. That is, the defaulted
annotations at two different locations may be different and in conflict. A
specific example is in code that contains a mix of explicit upper bounds
with an <span style="font-family:monospace">extends</span> clause and implicit upper bounds without an <span style="font-family:monospace">extends</span>
clause.</p><p>For example, consider the following example (from
<a href="https://github.com/plume-lib/plume-util">plume-util</a>) of an
interface with explicit upper bounds and a client with implicit upper
bounds:
</p><pre class="verbatim">  interface Partition&lt;ELEMENT extends @Nullable Object, CLASS extends @Nullable Object&gt; {}

  class MultiRandSelector&lt;T&gt; {
    private Partition&lt;T, T&gt; eq;
  }
</pre><p>The code contains no <span style="font-family:monospace">@MustCall</span> annotations.
Running the Must Call Checker on this code produces an error at each use
of <span style="font-family:monospace">T</span> in <span style="font-family:monospace">MultiRandSelector</span>:</p><pre class="verbatim">error: [type.argument] incompatible type argument for type parameter ELEMENT of Partitioner.
        private Partitioner&lt;T, T&gt; eq;
                            ^
  found   : T extends @MustCallUnknown Object
  required: @MustCall Object
error: [type.argument] incompatible type argument for type parameter CLASS of Partitioner.
        private Partitioner&lt;T, T&gt; eq;
                               ^
  found   : T extends @MustCallUnknown Object
  required: @MustCall Object
</pre><p>The defaulted Must Call annotations differ.
<span style="font-family:monospace">Partitioner</span> has an explicit bound, which uses the usual default of <span style="font-family:monospace">@MustCall({})</span>.
<span style="font-family:monospace">MultiRandSelector</span> has an implicit bound, which defaults to top (that is,
<span style="font-family:monospace">@MustCallUnknown</span>), as explained in Section ‍<a href="#climb-to-top">31.5.3</a>.</p><p>In many cases, including this one, you can eliminate the false positive
warning without writing any <span style="font-family:monospace">@MustCall</span> annotations.
You can either:
</p><ul class="itemize"><li class="li-itemize">
add an explicit bound to <span style="font-family:monospace">MultiRandSelector</span>, changing its declaration to
<span style="font-family:monospace">class MultiRandSelector&lt;T extends Object&gt;</span>, or
</li><li class="li-itemize">remove the explicit bound from <span style="font-family:monospace">Partition</span>, changing its declaration to
<span style="font-family:monospace">interface Partition&lt;ELEMENT, CLASS&gt;</span>.
</li></ul><hr>
<!--TOC chapter id="subtyping-checker" Subtyping Checker-->
<h1 id="subtyping-checker" class="chapter">Chapter ‍28 Subtyping Checker <a href="#subtyping-checker"><img src="chainlink.svg" width="10" height="10"></a></h1><!--SEC END --><p>The Subtyping Checker enforces only subtyping rules. It operates over
annotations specified by a user on the command line. Thus, users can
create a simple type-checker without writing any code beyond definitions of
the type qualifier annotations.</p><p>The Subtyping Checker can accommodate all of the type system enhancements that
can be declaratively specified (see Chapter ‍<a href="#creating-a-checker">35</a>).
This includes type introduction rules via the
<a href="../api/org/checkerframework/framework/qual/QualifierForLiterals.html"><span style="font-family:monospace">@QualifierForLiterals</span></a> meta-annotation, and other features such as
type refinement (Section ‍<a href="#type-refinement">31.7</a>) and
qualifier polymorphism (Section ‍<a href="#method-qualifier-polymorphism">30.2</a>).</p><p>The Subtyping Checker is also useful to type system designers who wish to
experiment with a checker before writing code; the Subtyping Checker
demonstrates the functionality that a checker inherits from the Checker
Framework.</p><p>If you need typestate analysis, then you can extend a typestate checker.
For more details (including a definition of “typestate”), see
Chapter ‍<a href="#typestate-checker">29.30</a>.
See Section ‍<a href="#faq-typestate">38.7.1</a> for a simpler alternative.</p><p>For type systems that require special checks (e.g., warning about
dereferences of possibly-null values), you will need to write code and
extend the framework as discussed in Chapter ‍<a href="#creating-a-checker">35</a>.</p>
<!--TOC section id="subtyping-using" Using the Subtyping Checker-->
<h2 id="subtyping-using" class="section">28.1 Using the Subtyping Checker <a href="#subtyping-using"><img src="chainlink.svg" width="10" height="10"></a></h2><!--SEC END --><p>
The Subtyping Checker is used in the same way as other checkers (using the
<span style="font-family:monospace">-processor org.checkerframework.common.subtyping.SubtypingChecker</span> option; see Chapter ‍<a href="#using-a-checker">2</a>), except that it
requires an additional annotation processor argument via the standard
“<span style="font-family:monospace">-A</span>” switch. You must provide one or both of the two following
command-line arguments:
</p><ul class="itemize"><li class="li-itemize">Provide the fully-qualified class name(s) of the annotation(s) in the custom
type system through the <span style="font-family:monospace">-Aquals</span> option, using a comma-no-space-separated
notation:<pre>
  javac -classpath <span style="font-style:italic">/full/path/to/myProject/bin</span>:<span style="font-style:italic">/full/path/to/myLibrary/bin</span> <span style="font-family:monospace">\</span>
        -processor org.checkerframework.common.subtyping.SubtypingChecker <span style="font-family:monospace">\</span>
        -Aquals=<span style="font-style:italic">myPackage.qual.MyQual</span>,<span style="font-style:italic">myPackage.qual.OtherQual</span> MyFile.java ...
</pre></li><li class="li-itemize">Provide the fully-qualified paths to a set of directories that contain the
annotations in the custom type system through the <span style="font-family:monospace">-AqualDirs</span> option,
using a colon-no-space-separated notation. For example,
if the Checker Framework is on the classpath rather than the processorpath:<pre>
  javac -classpath <span style="font-style:italic">/full/path/to/myProject/bin</span>:<span style="font-style:italic">/full/path/to/myLibrary/bin</span> <span style="font-family:monospace">\</span>
        -processor org.checkerframework.common.subtyping.SubtypingChecker <span style="font-family:monospace">\</span>
        -AqualDirs=<span style="font-style:italic">/full/path/to/myProject/bin</span>:<span style="font-style:italic">/full/path/to/myLibrary/bin</span> MyFile.java
</pre></li></ul><p>If the Checker Framework is on the processorpath, place the annotations on
the processorpath instead of on the classpath.</p>
<!--TOC subsection id="subtyping-compiling" Compiling your qualifiers and your project-->
<h3 id="subtyping-compiling" class="subsection">28.1.1 Compiling your qualifiers and your project <a href="#subtyping-compiling"><img src="chainlink.svg" width="10" height="10"></a></h3><!--SEC END --><p>The annotations listed in <span style="font-family:monospace">-Aquals</span> or <span style="font-family:monospace">-AqualDirs</span> must be accessible to
the compiler during compilation. Before you run the Subtyping Checker with
<span style="font-family:monospace">javac</span>, they must be compiled and on the same path (the classpath or
processorpath) as the Checker Framework. It
is not sufficient to supply their source files on the command line.</p>
<!--TOC subsection id="subtyping-suppressing" Suppressing warnings from the Subtyping Checker-->
<h3 id="subtyping-suppressing" class="subsection">28.1.2 Suppressing warnings from the Subtyping Checker <a href="#subtyping-suppressing"><img src="chainlink.svg" width="10" height="10"></a></h3><!--SEC END --><p>When suppressing a warning issued by the Subtyping Checker, as the
“checker name” you may use the unqualified, uncapitalized name of any of
the annotations passed to <span style="font-family:monospace">-Aquals</span>. (See
Section ‍<a href="#suppresswarnings-annotation-syntax">32.1.1</a> for details about the
<span style="font-family:monospace">@SuppressWarnings</span> syntax.) As a matter of style, you should
choose one of the annotations as the “checker name” part of the
<span style="font-family:monospace">@SuppressWarnings</span> string and use it consistently; this avoids
confusion and makes it easier to search for uses.</p>
<!--TOC section id="encrypted-example" Subtyping Checker example-->
<h2 id="encrypted-example" class="section">28.2 Subtyping Checker example<a id="subtyping-example"></a> <a href="#subtyping-example"><img src="chainlink.svg" width="10" height="10"></a></h2><!--SEC END --><p>Consider a hypothetical <span style="font-family:monospace">Encrypted</span> type qualifier, which denotes that the
representation of an object (such as a <span style="font-family:monospace">String</span>, <span style="font-family:monospace">CharSequence</span>, or
<span style="font-family:monospace">byte[]</span>) is encrypted. To use the Subtyping Checker for the <span style="font-family:monospace">Encrypted</span>
type system, follow three steps.</p><p>(This example also appears in the
<a href="https://eisop.github.io/cf/tutorial/webpages/encryption-checker-cmd.html">Checker
Framework Tutorial</a>, in more detail.)</p><ol class="enumerate" type=1><li class="li-enumerate">
Define two annotations for the <span style="font-family:monospace">Encrypted</span> and <span style="font-family:monospace">PossiblyUnencrypted</span> qualifiers:<pre>
package <span style="font-style:italic">myPackage</span>.qual;

import org.checkerframework.framework.qual.DefaultFor;
import org.checkerframework.framework.qual.SubtypeOf;
import java.lang.annotation.ElementType;
import java.lang.annotation.Target;

/**
 * Denotes that the representation of an object is encrypted.
 */
@SubtypeOf(PossiblyUnencrypted.class)
@DefaultFor({TypeUseLocation.LOWER_BOUND})
@Target({ElementType.TYPE_USE, ElementType.TYPE_PARAMETER})
public @interface Encrypted {}
</pre><p> ‍</p><pre>
package <span style="font-style:italic">myPackage</span>.qual;

import org.checkerframework.framework.qual.DefaultQualifierInHierarchy;
import org.checkerframework.framework.qual.SubtypeOf;
import java.lang.annotation.ElementType;
import java.lang.annotation.Target;

/**
 * Denotes that the representation of an object might not be encrypted.
 */
@DefaultQualifierInHierarchy
@SubtypeOf({})
@Target({ElementType.TYPE_USE, ElementType.TYPE_PARAMETER})
public @interface PossiblyUnencrypted {}
</pre><p>Note that all custom annotations must have the
<span style="font-family:monospace">@Target(ElementType.TYPE_USE)</span> meta-annotation.
See Section ‍<a href="#creating-define-type-qualifiers">35.5.1</a>.</p><p>Don’t forget to compile these classes:</p><pre class="verbatim">$ javac myPackage/qual/Encrypted.java myPackage/qual/PossiblyUnencrypted.java
</pre><p>The resulting <span style="font-family:monospace">.class</span> files should either be on the same path (the classpath or
processor path) as the Checker Framework.</p></li><li class="li-enumerate">Write <span style="font-family:monospace">@Encrypted</span> annotations in your program (say, in file
<span style="font-family:monospace">YourProgram.java</span>):<pre>
import <span style="font-style:italic">myPackage</span>.qual.Encrypted;

...

public @Encrypted String encrypt(String text) {
    // ...
}

// Only send encrypted data!
public void sendOverInternet(@Encrypted String msg) {
    // ...
}

void sendText() {
    // ...
    @Encrypted String ciphertext = encrypt(plaintext);
    sendOverInternet(ciphertext);
    // ...
}

void sendPassword() {
    String password = getUserPassword();
    sendOverInternet(password);
}
</pre><p>You may also need to add <span style="font-family:monospace">@SuppressWarnings</span> annotations to the
<span style="font-family:monospace">encrypt</span> and <span style="font-family:monospace">decrypt</span> methods. Analyzing them is beyond the
capability of any realistic type system.</p></li><li class="li-enumerate">Invoke the compiler with the Subtyping Checker, specifying the
<span style="font-family:monospace">@Encrypted</span> annotation using the <span style="font-family:monospace">-Aquals</span> option.
You should add the <span style="font-family:monospace">Encrypted</span> classfile to the processor classpath:<pre>
  javac -processorpath <span style="font-style:italic">myqualpath</span> -processor org.checkerframework.common.subtyping.SubtypingChecker 
        -Aquals=<span style="font-style:italic">myPackage.qual.Encrypted</span>,<span style="font-style:italic">myPackage.qual.PossiblyUnencrypted</span> YourProgram.java

YourProgram.java:42: incompatible types.
found   : @myPackage.qual.PossiblyUnencrypted java.lang.String
required: @myPackage.qual.Encrypted java.lang.String
    sendOverInternet(password);
                     ^
</pre></li><li class="li-enumerate">You can also provide the fully-qualified paths to a set of directories
that contain the qualifiers using the <span style="font-family:monospace">-AqualDirs</span> option, and add
the directories to the boot classpath, for example:<pre>
  javac -classpath <span style="font-style:italic">/full/path/to/myProject/bin</span>:<span style="font-style:italic">/full/path/to/myLibrary/bin</span> <span style="font-family:monospace">\</span>
        -processor org.checkerframework.common.subtyping.SubtypingChecker <span style="font-family:monospace">\</span>
        -AqualDirs=<span style="font-style:italic">/full/path/to/myProject/bin</span>:<span style="font-style:italic">/full/path/to/myLibrary/bin</span> YourProgram.java
</pre><p>
Note that in these two examples, the compiled class file of the
<span style="font-family:monospace">myPackage.qual.Encrypted</span> and <span style="font-family:monospace">myPackage.qual.PossiblyUnencrypted</span> annotations
must exist in either the <span style="font-family:monospace">myProject/bin</span> directory or the <span style="font-family:monospace">myLibrary/bin</span>
directory. The following placement of the class files will work with the above
commands:
</p><pre>
  .../myProject/bin/myPackage/qual/Encrypted.class
  .../myProject/bin/myPackage/qual/PossiblyUnencrypted.class
</pre></li></ol><p>Also, see the example project in the <span style="font-family:monospace">docs/examples/subtyping-extension</span> directory.</p>
<!--TOC section id="subtyping-type-alias" Type aliases and typedefs-->
<h2 id="subtyping-type-alias" class="section">28.3 Type aliases and typedefs <a href="#subtyping-type-alias"><img src="chainlink.svg" width="10" height="10"></a></h2><!--SEC END --><p>A type alias or typedef is a type that shares the same representation as
another type but is conceptually distinct from it. For example, some
strings in your program may be street addresses; others may be passwords;
and so on. You wish to indicate, for each string, which one it is, and to
avoid mixing up the different types of strings. Likewise, you could
distinguish integers that are offsets from those that are absolute values.</p><p>Creating a new type makes your code easier to understand by conveying the
intended use of each variable. It also prevents errors that come from
using the wrong type or from mixing incompatible types in an operation.</p><p>If you want to create a type alias or typedef, you have multiple options:
a regular Java subtype,
the Units Checker (Chapter ‍<a href="#units-checker">19</a>),
the Fake Enum Checker (Chapter ‍<a href="#fenum-checker">9</a>), or
the Subtyping Checker.</p><p>A Java subtype is easy to create and does not require a tool such as the
Checker Framework; for instance, you would declare <span style="font-family:monospace">class Address extends
String</span>. There are a number of limitations to this “pseudo-typedef”,
however ‍[<a href="#Goetz2006%3Atypedef">Goe06</a>].
Primitive types and final types (including <span style="font-family:monospace">String</span>) cannot be extended.
Equality and identity tests can return incorrect results when a wrapper
object is used. Existing return types in code would need to be changed,
which is easy with an annotation but disruptive to change the Java type.
Therefore, it is best to avoid the pseudo-typedef antipattern.</p><p>The Units Checker (Chapter ‍<a href="#units-checker">19</a>) is useful for the
particular case of units of measurement, such as kilometers verses miles.</p><p>The Fake Enum Checker (Chapter ‍<a href="#fenum-checker">9</a>)
builds in a set of assumptions. If those fit your
use case, then it’s easiest to use the Fake Enum Checker (though you can
achieve them using the Subtyping Checker). The Fake Enum Checker forbids
mixing of fenums of different types, or fenums and unannotated types. For
instance, binary operations other than string concatenations are forbidden,
such as <span style="font-family:monospace">NORTH+1</span>, <span style="font-family:monospace">NORTH+MONDAY</span>, and <span style="font-family:monospace">NORTH==MONDAY</span>. However,
<span style="font-family:monospace">NORTH+SOUTH</span> is permitted.</p><p>By default, the Subtyping Checker does not forbid any operations.</p><p>If you choose to use the Subtyping Checker, then you have an additional
design choice to make about the type system. In the general case, your
type system will look something like Figure ‍<a href="#fig-typedef-hierarchy">28.1</a>.</p><blockquote class="figure"><div class="center"><hr class="floatrule"></div>
<div class="center">
<img src="typedef.svg">
</div>
<div class="caption"><table style="border-spacing:6px;border-collapse:separate;" class="cellpading0"><tr><td style="vertical-align:top;text-align:left;" >Figure 28.1: Type system for a type alias or typedef type system.
The type system designer may choose to omit some of these types, but
this is the general case.
The type system designer’s choice of defaults affects the interpretation
of unannotated code, which affects the guarantees given for unannotated code.
<a id="fig-typedef-hierarchy"></a></td></tr>
</table></div>
<div class="center"><hr class="floatrule"></div></blockquote><p>References whose type is <span style="font-family:monospace">@MyType</span> are known to store only values from
your new type. There is no such guarantee for <span style="font-family:monospace">@MyTypeUnknown</span> and
<span style="font-family:monospace">@NotMyType</span>, but those types mean different things. An expression of type
<span style="font-family:monospace">@NotMyType</span> is guaranteed never to evaluate to a value of your new type.
An expression of type <span style="font-family:monospace">@MyTypeUnknown</span> may evaluate to any value —
including values of your new type and values not of your new type.
(<span style="font-family:monospace">@MyTypeBottom</span> is the type of <span style="font-family:monospace">null</span> and is also used for dead code and
erroneous situations; it can be ignored for this
discussion.)</p><p>A key choice for the type system designer is which type is the default.
That is, if a programmer does not write <span style="font-family:monospace">@MyType</span> on a given type use,
should that type use be interpreted as <span style="font-family:monospace">@MyTypeUnknown</span> or as
<span style="font-family:monospace">@NotMyType</span>?</p><ul class="itemize"><li class="li-itemize">
If unannotated types are interpreted as <span style="font-family:monospace">@NotMyType</span>, then the type system
enforces very strong separation between your new type and all other types.
Values of your type will never mix with values of other types. If you
don’t see <span style="font-family:monospace">@MyType</span> written explicitly on a type, you will know that
it does not contain values of your type.</li><li class="li-itemize">If unannotated types are interpreted as <span style="font-family:monospace">@MyTypeUnknown</span>, then
a generic, unannotated type may contain a value of your new type.
In this case, <span style="font-family:monospace">@NotMyType</span> does not need to exist, and <span style="font-family:monospace">@MyTypeBottom</span>
may or may not exist in your type system.
</li></ul><p>A downside of the stronger guarantee that comes from using <span style="font-family:monospace">@NotMyType</span> as
the default is the need to write additional annotations.
For example, if <span style="font-family:monospace">@NotMyType</span> is the default, this code does not typecheck:</p><pre class="verbatim">void method(Object o) { ... }
&lt;U&gt; void use(List&lt;U&gt; list) {
  method(list.get(0));
}
</pre><p>Because (implicit) upper bounds are interpreted as the top type (see
Section ‍<a href="#generics-defaults">30.1.2</a>), this is interpreted as</p><pre class="verbatim">void method(@NotMyType Object o) { ... }
&lt;@U extends @MyTypeUnknown Object&gt; void use(List&lt;U&gt; list) {
  // type error: list.get(0) has type @MyTypeUnknown, method expects @NotMyType
  method(list.get(0));
}
</pre><p>To make the code type-check, it is necessary to write an explicit
annotation, either to restrict <span style="font-family:monospace">use</span>’s argument or to expand <span style="font-family:monospace">method</span>’s
parameter type.</p><hr>
<!--TOC chapter id="external-checkers" Third-party checkers-->
<h1 id="external-checkers" class="chapter">Chapter ‍29 Third-party checkers<a id="third-party-checkers"></a> <a href="#third-party-checkers"><img src="chainlink.svg" width="10" height="10"></a></h1><!--SEC END --><p>The Checker Framework has been used to build other checkers that are not
distributed together with the framework. This chapter gives an <em>incomplete</em>
list of them. (If you know of others, or
if you want this chapter to reference your checker,
please send us a link and a short description.)
Many of the publications in Section ‍<a href="#publications">39.7</a> provide
implementations, which are not necessarily listed here yet.</p><p>These tools are externally-maintained, so if you have problems or questions, you
should contact their maintainers rather than the Checker Framework
maintainers.</p><p>This list is in reverse chronological order; newer tools appear
first and older ones appear last.</p>
<!--TOC section id="deteriminism-checker" Determinism checker-->
<h2 id="deteriminism-checker" class="section">29.1 Determinism checker <a href="#deteriminism-checker"><img src="chainlink.svg" width="10" height="10"></a></h2><!--SEC END --><p>The
<a href="https://github.com/t-rasmud/checker-framework/tree/nondet-checker">Determinism
Checker</a> ensures that a program is deterministic across executions. A
determinismic program is easier to test, and it is easier to debug (such as
comparing executions).</p><p>The Determinism Checker focuses on sequential programs. It detects
determinism due to the iteration order of a hash table (or on any other
property of hash codes), default formatting (such as Java’s
<span style="font-family:monospace">Object.toString()</span>, which includes a memory address), <span style="font-family:monospace">random</span>,
date-and-time functions, and accessing system properties such as the file
system or environment variables.</p><p>The paper
<a href="https://homes.cs.washington.edu/~mernst/pubs/determinism-icse2021-abstract.html">“Verifying
determinism in sequential programs”</a> ‍[<a href="#MudduluruWME2021">MWME21</a>]
describes the Determinism Checker.</p>
<!--TOC section id="interval-inference-checker" Constant Value Inference (Interval Inference)-->
<h2 id="interval-inference-checker" class="section">29.2 Constant Value Inference (Interval Inference) <a href="#interval-inference-checker"><img src="chainlink.svg" width="10" height="10"></a></h2><!--SEC END --><p>Interval analysis estimates the run-time values of numerical expressions in
the source code by computing a lower bound and an upper bound. The
<a href="https://github.com/d367wang/value-inference/tree/artifact">Constant
Value Inference</a> project is a whole-program inference approach for
integral range analysis (interval analysis).</p><p>The thesis
<a href="https://uwspace.uwaterloo.ca/bitstream/handle/10012/17788/Wang_Di.pdf">“Interval
Type Inference: Improvements and Evaluations”</a> ‍[<a href="#Wang2021">Wan21</a>] describes
Constant Value Inference.</p>
<!--TOC section id="crypto-checker" Crypto Checker-->
<h2 id="crypto-checker" class="section">29.3 Crypto Checker <a href="#crypto-checker"><img src="chainlink.svg" width="10" height="10"></a></h2><!--SEC END --><p>The <a href="https://github.com/vehiloco/crypto-checker">Crypto Checker</a> can
help you find whether there are any weak or unsupported crypto algorithms
and the unsupported algorithm providers being used in your program. If the
Crypto Checker issues no warnings for a given program, then you have a
guarantee that your program at runtime will never have these issues. This
is similar to the earlier AWS Crypto Policy Compliance Checker
(Section ‍<a href="#crypto-policy-compliance-checker">29.4</a>).</p><p>The paper
<a href="https://vehiloco.github.io/crypto-checker/2021-06-04-Crypto-Checker-FTfJP-2021-preprint.pdf">“Ensuring
correct cryptographic algorithm and provider usage at compile
time”</a> ‍[<a href="#XingCD2021">XCD21</a>] (FTFjP 2021) and the thesis
<a href="https://uwspace.uwaterloo.ca/bitstream/handle/10012/16555/Xing_Weitian.pdf">“Light-weight
verification of cryptographic API usage”</a> ‍[<a href="#Xing2020">Xin20</a>] describe the
Crypto Checker.</p>
<!--TOC section id="crypto-policy-compliance-checker" AWS crypto policy compliance checker-->
<h2 id="crypto-policy-compliance-checker" class="section">29.4 AWS crypto policy compliance checker <a href="#crypto-policy-compliance-checker"><img src="chainlink.svg" width="10" height="10"></a></h2><!--SEC END --><p>The
<a href="https://github.com/awslabs/aws-crypto-policy-compliance-checker">AWS
crypto policy compliance checker</a> checks that no weak cipher algorithms
are used with the Java crypto API.</p><p>The paper
<a href="https://homes.cs.washington.edu/~mernst/pubs/continuous-compliance-ase2020-abstract.html">“Continuous
Compliance”</a> ‍[<a href="#KelloggSTE2020">KSTE20</a>] (ASE 2020) describes several custom
Checker Framework checkers in the context of a compliance regime at Amazon
Web Services.</p>
<!--TOC section id="kms-compliance-checker" AWS KMS compliance checker-->
<h2 id="kms-compliance-checker" class="section">29.5 AWS KMS compliance checker <a href="#kms-compliance-checker"><img src="chainlink.svg" width="10" height="10"></a></h2><!--SEC END --><p>The <a href="https://github.com/awslabs/aws-kms-compliance-checker">AWS KMS
compliance checker</a> extends the Constant Value Checker (see
Chapter ‍<a href="#constant-value-checker">22</a>) to enforce that calls to Amazon
Web Services’ Key Management System only request 256-bit (or longer) data
keys. This checker can be used to help enforce a compliance requirement
(such as from SOC or PCI-DSS) that customer data is always encrypted with
256-bit keys.</p><p>The KMS compliance checker is available in Maven Central. To use it in
<span style="font-family:monospace">build.gradle</span>, add the following dependency:</p><pre class="verbatim"><span style="font-size:small">compile group: 'software.amazon.checkerframework', name: 'aws-kms-compliance-checker', version: '1.0.2'
</span></pre><p><a href="https://repo1.maven.org/maven2/software/amazon/checkerframework/aws-kms-compliance-checker/1.0.2/aws-kms-compliance-checker-1.0.2.jar">Other build systems</a> are similar.</p><p>The paper
<a href="https://homes.cs.washington.edu/~mernst/pubs/continuous-compliance-ase2020-abstract.html">“Continuous
Compliance”</a> ‍[<a href="#KelloggSTE2020">KSTE20</a>] (ASE 2020) describes several custom
Checker Framework checkers in the context of a compliance regime at Amazon
Web Services.</p>
<!--TOC section id="punits-checker" PUnits units of measurement-->
<h2 id="punits-checker" class="section">29.6 PUnits units of measurement <a href="#punits-checker"><img src="chainlink.svg" width="10" height="10"></a></h2><!--SEC END --><p>The <a href="https://github.com/opprop/units-inference">PUnits system</a>
can check the correctness of a program or annotate a program with units of
measurement. It is described in the paper
“Precise inference of
expressive units of measurement types” (OOPSLA 2020) ‍[<a href="#XiangLD2020">XLD20</a>].</p>
<!--TOC section id="jatyc-checker" JaTyC typestate checker-->
<h2 id="jatyc-checker" class="section">29.7 JaTyC typestate checker <a href="#jatyc-checker"><img src="chainlink.svg" width="10" height="10"></a></h2><!--SEC END --><p><a href="https://github.com/jdmota/java-typestate-checker">JaTyC, Java
Typestate Checker</a>, ensures that methods are called in the correct
order. The sequences of method calls allowed are specified in a protocol
file which is associated with a Java class by adding a <span style="font-family:monospace">@Typestate</span>
annotation to the class. It is described in
<a href="https://arxiv.org/pdf/2002.12793.pdf">“Behavioural Types for Memory
and Method Safety in a Core Object-Oriented
Language”</a> ‍[<a href="#BravettiFGHJKR2020">BFG+20</a>], and the implementation is an
extension of Mungo
(<a href="https://www.dcs.gla.ac.uk/research/mungo/index.html"><span style="font-family:monospace">https://www.dcs.gla.ac.uk/research/mungo/index.html</span></a>).</p>
<!--TOC section id="nullaway-checker" NullAway-->
<h2 id="nullaway-checker" class="section">29.8 NullAway <a href="#nullaway-checker"><img src="chainlink.svg" width="10" height="10"></a></h2><!--SEC END --><p><a href="https://github.com/uber/NullAway">NullAway</a> is
a fast type-checker for only nullness properties. It is built on top of
Error Prone and the Checker Framework’s Dataflow Framework. See
Section ‍<a href="#faq-nullaway">38.10.3</a> for a comparison between NullAway and the
Nullness Checker. NullAway is described in the paper
<a href="https://lazaroclapp.com/preprints/fse19-nullaway.pdf">“NullAway:
Practical type-based null safety for Java”</a> ‍[<a href="#BanerjeeCS2019">BCS19</a>].</p>
<!--TOC section id="initialization-rawness-checker" Nullness Rawness Checker-->
<h2 id="initialization-rawness-checker" class="section">29.9 Nullness Rawness Checker <a href="#initialization-rawness-checker"><img src="chainlink.svg" width="10" height="10"></a></h2><!--SEC END --><p>The Nullness Rawness Checker is a variant of the Nullness Checker that uses
a different type system for initialization. It was distributed with the
Checker Framework through release 2.9.0 (dated 3 July 2019). If you wish to
use it, install <a href="https://checkerframework.org/releases/2.9.0/">Checker
Framework version 2.9.0</a>.</p><p>The paper
<a href="https://homes.cs.washington.edu/~mernst/pubs/initialization-icse2011-abstract.html">“Inference
of field initialization”</a> ‍[<a href="#SpotoE2011">SE11</a>] describes
inference for the Rawness Initialization Checker.</p>
<!--TOC section id="rx-thread-checker" UI Thread Checker for ReactiveX-->
<h2 id="rx-thread-checker" class="section">29.10 UI Thread Checker for ReactiveX <a href="#rx-thread-checker"><img src="chainlink.svg" width="10" height="10"></a></h2><!--SEC END --><p>The <a href="https://github.com/uber-research/RxThreadEffectChecker">Rx
Thread &amp; Effect Checker</a> enforces UI Thread safety properties for
stream-based Android applications. The paper
<a href="https://www.bennostein.org/ase18.pdf">“Safe Stream-Based Programming
with Refinement Types”</a> ‍[<a href="#SteinCSC2018">SCSC18</a>] describes the Rx Thread &amp;
Effect Checker.</p>
<!--TOC section id="pico-checker" Practical Immutability For Classes And Objects (PICO)-->
<h2 id="pico-checker" class="section">29.11 Practical Immutability For Classes And Objects (PICO) <a href="#pico-checker"><img src="chainlink.svg" width="10" height="10"></a></h2><!--SEC END --><p>Practical Immutability For Classes And Objects (PICO) is a type system that
supports class level and object level immutability based on Checker
Framework.
The implementation is available at
<a href="https://github.com/opprop/immutability"><span style="font-family:monospace">https://github.com/opprop/immutability</span></a>, and
a docker image is available at
<a href="https://hub.docker.com/repository/docker/lnsun/pico"><span style="font-family:monospace">https://hub.docker.com/repository/docker/lnsun/pico</span></a>.</p><p>The theses
<a href="https://uwspace.uwaterloo.ca/bitstream/handle/10012/13185/Ta_Mier.pdf">“Context
Sensitive Typechecking And Inference: Ownership And
Immutability”</a> ‍[<a href="#Ta2018">Ta18</a>] and
<a href="https://uwspace.uwaterloo.ca/bitstream/handle/10012/16882/Lian_Sun.pdf">“An
Immutability Type System for Classes and Objects: Improvements,
Experiments, and Comparisons”</a> ‍[<a href="#Sun2021">Sun21</a>] describe PICO.</p>
<!--TOC section id="read-checker" Read Checker and Cast Checker for ensuring that EOF is recognized-->
<h2 id="read-checker" class="section">29.12 Read Checker and Cast Checker for ensuring that EOF is recognized <a href="#read-checker"><img src="chainlink.svg" width="10" height="10"></a></h2><!--SEC END --><p>The <span style="font-family:monospace">InputStream.read()</span> and <span style="font-family:monospace">Reader.read()</span> methods read
a byte (or character) from a stream. The methods return an <span style="font-family:monospace">int</span>, using
-1 to indicate the end of the stream. It is an error to cast the value to
a byte (or character) without first checking the value against -1. This is
rule
<a href="https://wiki.sei.cmu.edu/confluence/display/java/FIO08-J.+Distinguish+between+characters+or+bytes+read+from+a+stream+and+-1">CERT-FIO08-J</a>.
The <a href="https://github.com/opprop/ReadChecker">Read Checker</a> and/or
<a href="https://github.com/opprop/cast-checker">Cast Checker</a> enforces it.</p><p>The paper “Don’t miss the end: Preventing unsafe end-of-file
comparisons” ‍[<a href="#ChenD2018">CD18</a>] and the thesis
<a href="https://uwspace.uwaterloo.ca/bitstream/handle/10012/13181/zhuo_chen.pdf">“Pluggable
Properties for Program Understanding: Ontic Type Checking and
Inference”</a> ‍[<a href="#Chen2018">Che18</a>] describes the Read Checker.</p>
<!--TOC section id="ontology-checker" Ontology type system-->
<h2 id="ontology-checker" class="section">29.13 Ontology type system <a href="#ontology-checker"><img src="chainlink.svg" width="10" height="10"></a></h2><!--SEC END --><p>The <a href="https://github.com/opprop/ontology">Ontology type system</a>
groups related types into coarser concepts. For example, the SEQUENCE
concept includes Java’s <span style="font-family:monospace">Array</span>, <span style="font-family:monospace">List</span>, and their subtypes. Other
examples are VELOCITY and FORCE.</p><p>The thesis
<a href="https://uwspace.uwaterloo.ca/bitstream/handle/10012/13181/zhuo_chen.pdf">“Pluggable
Properties for Program Understanding: Ontic Type Checking and
Inference”</a> ‍[<a href="#Chen2018">Che18</a>] describes the Ontic type
system.</p>
<!--TOC section id="glacier-immutability-checker" Glacier: Class immutability-->
<h2 id="glacier-immutability-checker" class="section">29.14 Glacier: Class immutability <a href="#glacier-immutability-checker"><img src="chainlink.svg" width="10" height="10"></a></h2><!--SEC END --><p><a href="http://glacier.coblenz.us/">Glacier</a>
enforces transitive class immutability in Java. According to its webpage:</p><ul class="itemize"><li class="li-itemize">
Transitive: if a class is immutable, then every field must be
immutable. This means that all reachable state from an immutable object’s
fields is immutable.
</li><li class="li-itemize">Class: the immutability of an object depends only on its class’s
immutability declaration.
</li><li class="li-itemize">Immutability: state in an object is not changable through any reference to
the object.
</li></ul><p>Glacier is described by the paper
“Glacier: Transitive class immutability for Java” (ICSE
2017) ‍[<a href="#CoblenzNAMS2017">CNA+17</a>] and the PhD thesis
<a href="http://reports-archive.adm.cs.cmu.edu/anon/2020/CMU-CS-20-127.pdf">“User-Centered
Design of Principled Programming Languages”</a> ‍[<a href="#Coblenz2020">Cob20</a>].</p>
<!--TOC section id="sql-schecker" SQL checker that supports multiple dialects-->
<h2 id="sql-schecker" class="section">29.15 SQL checker that supports multiple dialects <a href="#sql-schecker"><img src="chainlink.svg" width="10" height="10"></a></h2><!--SEC END --><p><a href="http://www.jooq.org/">jOOQ</a> is a database API that lets you build
typesafe SQL queries. jOOQ version 3.0.9 and later ships with a SQL
checker that provides even more safety: it ensures that you don’t use SQL
features that are not supported by your database implementation. You can
learn about the SQL checker at
<a href="https://blog.jooq.org/jsr-308-and-the-checker-framework-add-even-more-typesafety-to-jooq-3-9/"><span style="font-family:monospace">https://blog.jooq.org/jsr-308-and-the-checker-framework-add-even-more-typesafety-to-jooq-3-9/</span></a>.</p>
<!--TOC section id="javari-checker" Immutability checkers: IGJ, OIGJ, and Javari-->
<h2 id="javari-checker" class="section">29.16 Immutability checkers: IGJ, OIGJ, and Javari<a id="igj-checker"></a> <a href="#igj-checker"><img src="chainlink.svg" width="10" height="10"></a></h2><!--SEC END --><p>Javari ‍[<a href="#TschantzE2005">TE05</a>], IGJ ‍[<a href="#ZibinPAAKE2007">ZPA+07</a>], and
OIGJ ‍[<a href="#ZibinPLAE2010">ZPL+10</a>] are type systems that enforce immutability
constraints. Type-checkers for all three type systems were distributed
with the Checker Framework through release 1.9.13 (dated 1 April 2016).
If you wish to use them, install
<a href="https://checkerframework.org/releases/1.9.13/">Checker
Framework version 1.9.13</a>.</p><p>They were removed from the main distribution on June 1, 2016 because the
implementations were not being maintained as the Checker Framework evolved.
The type systems are valuable, and some people found the type-checkers
useful. However,
we wanted
to focus on distributing checkers that are currently being maintained.</p><p>IGJ and OIGJ are described in the papers
<a href="https://homes.cs.washington.edu/~mernst/pubs/immutability-generics-fse2007-abstract.html">“Object
and reference immutability using Java generics”</a> ‍[<a href="#ZibinPAAKE2007">ZPA+07</a>]
(ESEC/FSE 2007) and
<a href="https://homes.cs.washington.edu/~mernst/pubs/ownership-immutability-oopsla2010-abstract.html">“Ownership
and immutability in generic Java”</a> ‍[<a href="#ZibinPLAE2010">ZPL+10</a>] (OOPSLA 2010).
The Javari type system is described in
<a href="https://homes.cs.washington.edu/~mernst/pubs/ref-immutability-oopsla2005-abstract.html">“Javari:
Adding reference immutability to Java”</a> ‍[<a href="#TschantzE2005">TE05</a>] (OOPSLA
2005); for inference, see
<a href="https://homes.cs.washington.edu/~mernst/pubs/infer-refimmutability-ecoop2008-abstract.html">“Inference
of reference immutability”</a> ‍[<a href="#QuinonezTE2008">QTE08</a>] (ECOOP 2008) and
<a href="https://homes.cs.washington.edu/~mernst/pubs/mutability-jase2009-abstract.html">“Parameter
reference immutability: Formal definition, inference tool, and
comparison”</a> ‍[<a href="#ArtziQKE2009">AQKE09</a>] (J.ASE 2009). The paper
<a href="https://homes.cs.washington.edu/~mernst/pubs/pluggable-checkers-issta2008.pdf">“Practical
pluggable types for Java”</a> ‍[<a href="#PapiACPE2008">PAC+08</a>] (ISSTA 2008) describes
case studies in which the Javari and IGJ Checkers found previously-unknown
errors in real software.</p>
<!--TOC section id="jcrypt-checker" JCrypt: computation over encrypted data-->
<h2 id="jcrypt-checker" class="section">29.17 JCrypt: computation over encrypted data <a href="#jcrypt-checker"><img src="chainlink.svg" width="10" height="10"></a></h2><!--SEC END --><p><a href="https://github.com/proganalysis/type-inference">JCrypt</a> is a
static program analysis which transforms a Java program into an equivalent
one, so that it performs computation over encrypted data and preserves data
confidentiality. It is described in the paper
<a href="http://cs.rpi.edu/~dongy6/docs/pppj16-jcrypt.pdf">“JCrypt: Towards
computation over encrypted data”</a> ‍[<a href="#DongMD2016%3AJCrypt">DMD16a</a>].</p>
<!--TOC section id="droidinfer-checker" DroidInfer: information flow-->
<h2 id="droidinfer-checker" class="section">29.18 DroidInfer: information flow <a href="#droidinfer-checker"><img src="chainlink.svg" width="10" height="10"></a></h2><!--SEC END --><p><a href="https://github.com/proganalysis/type-inference">DroidInfer</a>
determines the Android library sources (e.g., location access, phone state)
and sinks (e.g., Internet access) used by a program, and determines whether
there is impermissible information flow between them. It is described in
the paper
<a href="https://www.cs.rpi.edu/~milanova/docs/DroidInfer.pdf">“Scalable and
Precise Taint Analysis for Android”</a> (ISSTA 2015) ‍[<a href="#HuangDMD2015">HDMD15</a>].</p>
<!--TOC section id="error-prone-checker" Error Prone linter-->
<h2 id="error-prone-checker" class="section">29.19 Error Prone linter <a href="#error-prone-checker"><img src="chainlink.svg" width="10" height="10"></a></h2><!--SEC END --><p><a href="https://errorprone.info/">Error Prone</a> is a linter or bug detector
for Java. It reports violations of style rules. It is built on top of the
Checker Framework’s Dataflow Framework. See
Section ‍<a href="#faq-type-checking-vs-bug-detectors">38.10.1</a> for a comparison between
Error Prone and the Nullness Checker.</p>
<!--TOC section id="sparta-checker" SPARTA information flow type-checker for Android-->
<h2 id="sparta-checker" class="section">29.20 SPARTA information flow type-checker for Android <a href="#sparta-checker"><img src="chainlink.svg" width="10" height="10"></a></h2><!--SEC END --><p><a href="https://checkerframework.org/sparta/">SPARTA</a> is a security
toolset aimed at preventing malware from appearing in an app store. SPARTA
provides an information-flow type-checker that is customized to Android but
can also be applied to other domains. The paper
<a href="https://homes.cs.washington.edu/~mernst/pubs/infoflow-ccs2014.pdf">“Collaborative
verification of information flow for a high-assurance app
store”</a> ‍[<a href="#ErnstJMDPRKBBHVW2014">EJM+14</a>] (CCS 2014) describes the SPARTA
toolset and information flow type-checker.</p>
<!--TOC section id="sflow-checker" SFlow type system for information flow-->
<h2 id="sflow-checker" class="section">29.21 SFlow type system for information flow <a href="#sflow-checker"><img src="chainlink.svg" width="10" height="10"></a></h2><!--SEC END --><p><a href="https://github.com/proganalysis/type-inference">SFlow</a> is a
context-sensitive type system for secure information flow. It contains two
variants, SFlow/Integrity and SFlow/Confidentiality.
SFlowInfer is its worst-case-cubic inference analysis.</p><p>The paper
<a href="https://www.cs.rpi.edu/~milanova/docs/FASE14.pdf">“Type-based
taint analysis for Java web applications”</a> (FASE 2014) and the thesis
“An Inference And Checking Framework For Context-Sensitive Pluggable
Types” (PhD thesis, 2014) describe SFlow and SFlowInfer.</p>
<!--TOC section id="checklt-checker" CheckLT taint checker-->
<h2 id="checklt-checker" class="section">29.22 CheckLT taint checker <a href="#checklt-checker"><img src="chainlink.svg" width="10" height="10"></a></h2><!--SEC END --><p><a href="http://checklt.github.io/">CheckLT</a> uses taint tracking to
detect illegal information flows, such as unsanitized data that could
result in a SQL injection attack.</p>
<!--TOC section id="enerj-checker" EnerJ checker-->
<h2 id="enerj-checker" class="section">29.23 EnerJ checker <a href="#enerj-checker"><img src="chainlink.svg" width="10" height="10"></a></h2><!--SEC END --><p><a href="http://sampa.cs.washington.edu/research/approximation/enerj.html">EnerJ</a>
is an extension to Java that exposes hardware faults in a safe, principled
manner to save energy with only slight sacrifices to the quality of
service.
More details appear in the paper
<a href="https://homes.cs.washington.edu/~luisceze/publications/Enerj-pldi2011.pdf">“EnerJ:
Approximate Data Types for Safe and General Low-Power
Computation”</a> ‍[<a href="#SampsonDFGCG2011">SDF+11</a>] (PLDI 2011).</p>
<!--TOC section id="reim-checker" ReIm immutability-->
<h2 id="reim-checker" class="section">29.24 ReIm immutability <a href="#reim-checker"><img src="chainlink.svg" width="10" height="10"></a></h2><!--SEC END --><p>A checker and inference tool for ReIm ‍[<a href="#HuangMDE2012">HMDE12</a>, <a href="#Huang2014">Hua14</a>], an immutability
type system, is available at
<a href="http://www.cs.rpi.edu/~huangw5/cf-inference/"><span style="font-family:monospace">http://www.cs.rpi.edu/~huangw5/cf-inference/</span></a>.</p>
<!--TOC section id="sflow-reim-checker" SFlow x ReIm for information flow and reference immutability-->
<h2 id="sflow-reim-checker" class="section">29.25 SFlow x ReIm for information flow and reference immutability <a href="#sflow-reim-checker"><img src="chainlink.svg" width="10" height="10"></a></h2><!--SEC END --><p>The <a href="https://github.com/proganalysis/type-inference">“SFlow
× ReIm”</a> system combines information flow and reference
immutability. It is described in the paper
<a href="https://www.cs.rpi.edu/~milanova/docs/FTFJP13.pdf">“Composing
polymorphic information flow systems with reference
immutability”</a> ‍[<a href="#MilanovaH2013">MH13</a>].</p>
<!--TOC section id="gut-checker" Generic Universe Types checker-->
<h2 id="gut-checker" class="section">29.26 Generic Universe Types checker <a href="#gut-checker"><img src="chainlink.svg" width="10" height="10"></a></h2><!--SEC END --><p>A checker for Generic Universe Types ‍[<a href="#DietlEM2011">DEM11</a>], a lightweight ownership type
system, is available from
<a href="https://ece.uwaterloo.ca/~wdietl/ownership/"><span style="font-family:monospace">https://ece.uwaterloo.ca/~wdietl/ownership/</span></a> and
<a href="https://github.com/opprop/universe"><span style="font-family:monospace">https://github.com/opprop/universe</span></a>.</p><p>The paper
<a href="https://homes.cs.washington.edu/~mernst/pubs/tunable-typeinf-ecoop2011-abstract.html">“Tunable
static inference for Generic Universe Types”</a> ‍[<a href="#DietlEM2011">DEM11</a>] (ECOOP
2011) describes inference for the Generic Universe Types type system.
Another implementation of Universe Types and
<a href="http://www.cs.rpi.edu/~huangw5/cf-inference/">ownership types</a> is
described in
<a href="https://homes.cs.washington.edu/~mernst/pubs/infer-ownership-ecoop2012-abstract.html">“Inference
and checking of object ownership”</a> ‍[<a href="#HuangDME2012">HDME12</a>] (ECOOP 2012).</p>
<!--TOC section id="safety-critical-java-checker" Safety-Critical Java checker-->
<h2 id="safety-critical-java-checker" class="section">29.27 Safety-Critical Java checker <a href="#safety-critical-java-checker"><img src="chainlink.svg" width="10" height="10"></a></h2><!--SEC END --><p>A checker for Safety-Critical Java (SCJ, JSR 302) ‍[<a href="#TangPJ2010">TPV10</a>, <a href="#TangPNV2011">TPNV11</a>] is available at
<a href="https://sss.cs.purdue.edu/projects/oscj/checker/checker.html"><span style="font-family:monospace">https://sss.cs.purdue.edu/projects/oscj/checker/checker.html</span></a>.
Developer resources are available at the project page
<a href="https://code.google.com/archive/p/scj-jsr302/"><span style="font-family:monospace">https://code.google.com/archive/p/scj-jsr302/</span></a>.</p>
<!--TOC section id="loci-thread-locality-checker" Thread locality checker-->
<h2 id="loci-thread-locality-checker" class="section">29.28 Thread locality checker <a href="#loci-thread-locality-checker"><img src="chainlink.svg" width="10" height="10"></a></h2><!--SEC END --><p><a href="http://www.it.uu.se/research/upmarc/loci/">Loci</a> is a checker
for thread locality.
For more details, see the paper
<a href="http://janvitek.org/pubs/ecoop09.pdf">“Loci: Simple thread-locality
for Java”</a> ‍[<a href="#WrigstadPMZV2009">WPM+09</a>] (ECOOP 2009) and the thesis
<a href="http://uu.diva-portal.org/smash/get/diva2:428159/FULLTEXT01.pdf">“The
Design, Implementation and Evaluation of a Pluggable Type Checker for
Thread-Locality in Java”</a> ‍[<a href="#Sherwany2011">She11</a>].</p>
<!--TOC section id="units-and-dimensions-checker" Units and dimensions checker-->
<h2 id="units-and-dimensions-checker" class="section">29.29 Units and dimensions checker <a href="#units-and-dimensions-checker"><img src="chainlink.svg" width="10" height="10"></a></h2><!--SEC END --><p>A checker for units and dimensions is available at
<a href="https://www.lexspoon.org/expannots/"><span style="font-family:monospace">https://www.lexspoon.org/expannots/</span></a>.</p><p>Unlike the Units Checker that is distributed with the Checker Framework
(see Section ‍<a href="#units-checker">19</a>), this checker includes dynamic checks and
permits annotation arguments that are Java expressions. This added
flexibility, however, requires that you use a special version both of the
Checker Framework and of the javac compiler.</p>
<!--TOC section id="typestate-checker" Typestate checkers-->
<h2 id="typestate-checker" class="section">29.30 Typestate checkers <a href="#typestate-checker"><img src="chainlink.svg" width="10" height="10"></a></h2><!--SEC END --><p>In a regular type system, a variable has the same type throughout its
scope.
In a typestate system, a variable’s type can change as operations
are performed on it.</p><p>The most common example of typestate is for a <span style="font-family:monospace">File</span> object. Assume a file
can be in two states, <span style="font-family:monospace">@Open</span> and <span style="font-family:monospace">@Closed</span>. Calling the <span style="font-family:monospace">close()</span> method
changes the file’s state. Any subsequent attempt to read, write, or close
the file will lead to a run-time error. It would be better for the type
system to warn about such problems, or guarantee their absence, at compile
time.</p><p>Accumulation analysis (Chapter ‍<a href="#accumulation-checker">36</a>) is a special
case of typestate analysis. One instantiation of it is the Called Methods
Checker (Chapter ‍<a href="#called-methods-checker">7</a>), which can check any
property of the form “call method A before method B”. It also ensures
that builders are used correctly.</p><p>JaTyC (Section ‍<a href="#jatyc-checker">29.7</a>) is a Java typestate checker.</p>
<!--TOC subsection id="typestate-vs-type-refinement" Comparison to flow-sensitive type refinement-->
<h3 id="typestate-vs-type-refinement" class="subsection">29.30.1 Comparison to flow-sensitive type refinement <a href="#typestate-vs-type-refinement"><img src="chainlink.svg" width="10" height="10"></a></h3><!--SEC END --><p>The Checker Framework’s flow-sensitive type refinement
(Section ‍<a href="#type-refinement">31.7</a>) implements a form of typestate analysis.
For example, after code that tests a variable against null, the Nullness
Checker (Chapter ‍<a href="#nullness-checker">3</a>) treats the variable’s type as
<span style="font-family:monospace">@NonNull </span><span style="font-family:monospace"><em>T</em></span>, for some <span style="font-family:monospace"><em>T</em></span>.</p><p>For many type systems, flow-sensitive type refinement is sufficient. But
sometimes, you need full typestate analysis. This section compares the
two.
(Unused variables
(Section ‍<a href="#unused-fields">31.10</a>)
also have similarities
with typestate analysis and can occasionally substitute for it. For
brevity, this discussion omits them.)</p><p>A typestate analysis is easier for a user to create or extend.
Flow-sensitive type refinement is built into the Checker Framework and is
optionally extended by each checker. Modifying the rules requires writing
Java code in your checker. By contrast, it is possible to write a simple
typestate checker declaratively, by writing annotations on the methods
(such as <span style="font-family:monospace">close()</span>) that change a reference’s typestate.</p><p>A typestate analysis can change a reference’s type to something that is not
consistent with its original definition. For example, suppose that a
programmer decides that the <span style="font-family:monospace">@Open</span> and <span style="font-family:monospace">@Closed</span> qualifiers are
incomparable — neither is a subtype of the other. A typestate analysis
can specify that the <span style="font-family:monospace">close()</span> operation converts an <span style="font-family:monospace">@Open File</span> into a
<span style="font-family:monospace">@Closed File</span>. By contrast, flow-sensitive type refinement can only give
a new type that is a subtype of the declared type — for flow-sensitive
type refinement to be effective, <span style="font-family:monospace">@Closed</span> would need to be a child of
<span style="font-family:monospace">@Open</span> in the qualifier hierarchy (and <span style="font-family:monospace">close()</span> would need to be
treated specially by the checker).
</p><hr>
<!--TOC chapter id="polymorphism" Generics and polymorphism-->
<h1 id="polymorphism" class="chapter">Chapter ‍30 Generics and polymorphism <a href="#polymorphism"><img src="chainlink.svg" width="10" height="10"></a></h1><!--SEC END --><p>Section ‍<a href="#generics">30.1</a> describes support for Java generics (also known as
“parametric polymorphism”).
Section ‍<a href="#method-qualifier-polymorphism">30.2</a> describes polymorphism over
type qualifiers for methods. Section ‍<a href="#class-qualifier-polymorphism">30.3</a> describes
polymorphism over type qualifiers for classes.</p>
<!--TOC section id="generics" Generics (parametric polymorphism or type polymorphism)-->
<h2 id="generics" class="section">30.1 Generics (parametric polymorphism or type polymorphism) <a href="#generics"><img src="chainlink.svg" width="10" height="10"></a></h2><!--SEC END --><p>The Checker Framework fully supports
type-qualified Java generic types and methods (also known as “parametric
polymorphism”).
When instantiating a generic type,
clients supply the qualifier along with the type argument, as in
<span style="font-family:monospace">List&lt;@NonNull String&gt;</span>.
When using a type variable <span style="font-family:monospace">T</span> within the implementation of a generic type,
typically no type qualifier is written (see Section ‍<a href="#type-variable-use">30.1.3</a>);
rather, the instantiation of the type parameter is restricted (see
Section ‍<a href="#generics-instantiation">30.1.2</a>).</p>
<!--TOC subsection id="generics-raw-types" Raw types-->
<h3 id="generics-raw-types" class="subsection">30.1.1 Raw types <a href="#generics-raw-types"><img src="chainlink.svg" width="10" height="10"></a></h3><!--SEC END --><p>Before running any pluggable type-checker, we recommend that you eliminate
raw types from your code (e.g., your code should use <span style="font-family:monospace">List&lt;...&gt;</span> as
opposed to <span style="font-family:monospace">List</span>).
Your code should compile without warnings when using the standard Java
compiler and the <span style="font-family:monospace">-Xlint:unchecked -Xlint:rawtypes</span> command-line options.
Using generics helps prevent type errors just as using a pluggable
type-checker does, and makes the Checker Framework’s warnings easier to
understand.</p><p>If your code uses raw types, then the Checker Framework will do its best to
infer the Java type arguments and the type qualifiers. By default these
inferred types are ignored in subtyping checks. If you supply the
command-line option <span style="font-family:monospace">-AignoreRawTypeArguments=false</span> you will see errors
from raw types.</p>
<!--TOC subsection id="generics-instantiation" Restricting instantiation of a generic class-->
<h3 id="generics-instantiation" class="subsection">30.1.2 Restricting instantiation of a generic class <a href="#generics-instantiation"><img src="chainlink.svg" width="10" height="10"></a></h3><!--SEC END --><p>When you define a generic class in Java, the <span style="font-family:monospace">extends</span> clause
of the generic type parameter (known as the “upper bound”) requires that
the corresponding type argument must be a subtype of the bound.
For example, given the definition
<code class="verb">class G&lt;T extends Number&gt; {...}</code>,
the upper bound is <span style="font-family:monospace">Number</span>
and a client can instantiate it as <span style="font-family:monospace">G&lt;Number&gt;</span> or <span style="font-family:monospace">G&lt;Integer&gt;</span>
but not <span style="font-family:monospace">G&lt;Date&gt;</span>.</p><p>You can write a type qualifier on the <span style="font-family:monospace">extends</span> clause to make the upper
bound a qualified type. For example, you can declare that a generic list class can hold only non-null values:
</p><pre class="verbatim">  class MyList&lt;T extends @NonNull Object&gt; {...}

  MyList&lt;@NonNull String&gt; m1;       // OK
  MyList&lt;@Nullable String&gt; m2;      // error
</pre><p>That is, in the above example, all
arguments that replace <span style="font-family:monospace">T</span> in <span style="font-family:monospace">MyList&lt;T&gt;</span> must be subtypes of
<span style="font-family:monospace">@NonNull Object</span>.</p>
<!--TOC subsubsection id="generics-bounds-syntax" Syntax for upper and lower bounds-->
<h4 id="generics-bounds-syntax" class="subsubsection">Syntax for upper and lower bounds <a href="#generics-bounds-syntax"><img src="chainlink.svg" width="10" height="10"></a></h4><!--SEC END --><p>Conceptually, each generic type parameter has two bounds — a lower bound
and an upper bound — and at instantiation, the type argument must be
within the bounds. Java only allows you to specify the upper bound; the
lower bound is implicitly the bottom type <span style="font-family:monospace">void</span>. The Checker Framework
gives you more power: you can specify both an upper and lower bound for
type parameters.
Write the upper bound on the <span style="font-family:monospace">extends</span> clause, and
write the lower bound on the type variable.</p><pre class="verbatim">  class MyList&lt;@LowerBound T extends @UpperBound Object&gt; { ... }
</pre><p>You may omit either the upper or the lower bound, and the Checker Framework
will use a default.</p><p>For a discussion of wildcards, see Section ‍<a href="#annotations-on-wildcards">30.1.4</a>.</p><p>For a concrete example, consider the type system of the Regex Checker (see
Figure ‍<a href="#fig-regex-hierarchy">13.1</a>) in which
<span style="font-family:monospace">@Regex(0)</span> :&gt;
<span style="font-family:monospace">@Regex(1)</span> :&gt;
<span style="font-family:monospace">@Regex(2)</span> :&gt;
<span style="font-family:monospace">@Regex(3)</span> :&gt; ….</p><pre class="verbatim">  class MyRegexes&lt;@Regex(5) T extends @Regex(1) String&gt; { ... }

  MyRegexes&lt;@Regex(0) String&gt; mu;   // error - @Regex(0) is not a subtype of @Regex(1)
  MyRegexes&lt;@Regex(1) String&gt; m1;   // OK
  MyRegexes&lt;@Regex(3) String&gt; m3;   // OK
  MyRegexes&lt;@Regex(5) String&gt; m5;   // OK
  MyRegexes&lt;@Regex(6) String&gt; m6;   // error - @Regex(6) is not a supertype of @Regex(5)
</pre><p>The above declaration states that the upper bound of the type variable
is <span style="font-family:monospace">@Regex(1) String</span> and the lower bound is <span style="font-family:monospace">@Regex(5) void</span>. That is,
arguments that replace <span style="font-family:monospace">T</span> in <span style="font-family:monospace">MyList&lt;T&gt;</span> must be subtypes of
<span style="font-family:monospace">@Regex(1) String</span> and supertypes of <span style="font-family:monospace">@Regex(5) void</span>.
Since <span style="font-family:monospace">void</span> cannot be used to instantiate a generic class, <span style="font-family:monospace">MyList</span> may
be instantiated with <span style="font-family:monospace">@Regex(1) String</span> through <span style="font-family:monospace">@Regex(5) String</span>.</p><p>To specify an exact bound, place the same annotation on both bounds. For example:</p><pre class="verbatim">  class MyListOfNonNulls&lt;@NonNull T extends @NonNull Object&gt; { ... }
  class MyListOfNullables&lt;@Nullable T extends @Nullable Object&gt; { ... }

  MyListOfNonNulls&lt;@NonNull Number&gt; v1;      // OK
  MyListOfNonNulls&lt;@Nullable Number&gt; v2;     // error
  MyListOfNullables&lt;@NonNull Number&gt; v4;     // error
  MyListOfNullables&lt;@Nullable Number&gt; v3;    // OK
</pre><p>It is an error if the lower bound is not a subtype of the upper bound.</p><pre class="verbatim">  class MyClass&lt;@Nullable T extends @NonNull Object&gt;  // error: @Nullable is not a subtype of @NonNull
</pre>
<!--TOC subsubsection id="generics-defaults" Defaults-->
<h4 id="generics-defaults" class="subsubsection">Defaults <a href="#generics-defaults"><img src="chainlink.svg" width="10" height="10"></a></h4><!--SEC END --><p>A generic type parameter or wildcard is written as <span style="font-family:monospace">class
MyClass&lt;</span><span style="font-family:monospace"><em>@LowerBound</em></span><span style="font-family:monospace"> T extends </span><span style="font-family:monospace"><em>@UpperBound</em></span><span style="font-family:monospace"> JavaUpperBound&gt;</span> or as
<span style="font-family:monospace">MyClass&lt;</span><span style="font-family:monospace"><em>@UpperBound</em></span><span style="font-family:monospace"> ? super </span><span style="font-family:monospace"><em>@LowerBound</em></span><span style="font-family:monospace"> JavaLowerBound&gt;</span>, where
“<span style="font-family:monospace"><em>@LowerBound</em></span>” and “<span style="font-family:monospace"><em>@UpperBound</em></span>” are type qualifiers.</p><p>For lower bounds:
If no type annotation is written in front of <span style="font-family:monospace">?</span>,
then the lower bound defaults to <span style="font-family:monospace">@</span><span style="font-family:monospace"><em>BottomType</em></span><span style="font-family:monospace"> void</span>.</p><p>For upper bounds:
</p><ul class="itemize"><li class="li-itemize">
If the <span style="font-family:monospace">extends</span> clause is omitted,
then the upper bound defaults to <span style="font-family:monospace">@</span><span style="font-family:monospace"><em>TopType</em></span><span style="font-family:monospace"> Object</span>.
</li><li class="li-itemize">If the <span style="font-family:monospace">extends</span> clause is written but contains no type qualifier,
then the normal defaulting rules apply to the type in the <span style="font-family:monospace">extends</span>
clause (see Section ‍<a href="#climb-to-top">31.5.3</a>).
</li></ul><p>The upper-bound rules mean that even though in Java the following two
declarations are equivalent:</p><pre class="verbatim">  class MyClass&lt;T&gt;
  class MyClass&lt;T extends Object&gt;
</pre><p>they specify different type qualifiers on the upper bound,
if the type system’s default annotation is not its top annotation.</p><p>The Nullness type system is an example.</p><pre class="verbatim">  class MyClass&lt;T&gt;                 ==  class MyClass&lt;T extends @Nullable Object&gt;
  class MyClass&lt;T extends Object&gt;  ==  class MyClass&lt;T extends @NonNull Object&gt;
</pre><p>The rationale for this choice is:
</p><ul class="itemize"><li class="li-itemize">
The “<span style="font-family:monospace">&lt;T&gt;</span>” in <span style="font-family:monospace">MyClass&lt;T&gt;</span> means “fully unconstrained”,
and the rules maintain that, without the need for a programmer to
change existing code.
</li><li class="li-itemize">The “<span style="font-family:monospace">Object</span>” in <span style="font-family:monospace">MyClass&lt;T extends Object&gt;</span> is treated
exactly like every other occurrence of <span style="font-family:monospace">Object</span> in the program —
it would be confusing for different occurrences of <span style="font-family:monospace">Object</span> to mean
different annotated types.
</li></ul><p>Here are some style guidelines:
</p><ul class="itemize"><li class="li-itemize">
Use “<span style="font-family:monospace">&lt;T&gt;</span>” when there are no constraints on the type qualifiers.
This is short and is what already appears in source code.
</li><li class="li-itemize">Whenever you write an <span style="font-family:monospace">extends</span> clause, write an explicit type
annotation on it. For example, for the Nullness Checker, write
<span style="font-family:monospace">class MyClass&lt;T&gt;</span> rather than <span style="font-family:monospace">class MyClass&lt;T extends
@Nullable Object&gt;</span>, and write <span style="font-family:monospace">class MyClass&lt;T extends @NonNull
Object&gt;</span> rather than <span style="font-family:monospace">class MyClass&lt;T extends Object&gt;</span>.
</li></ul><p>For further discussion, see Section ‍<a href="#faq-implicit-bounds">38.7.2</a>.</p>
<!--TOC subsection id="type-variable-use" Type annotations on a use of a generic type variable-->
<h3 id="type-variable-use" class="subsection">30.1.3 Type annotations on a use of a generic type variable <a href="#type-variable-use"><img src="chainlink.svg" width="10" height="10"></a></h3><!--SEC END --><p>A type annotation on a use of a generic type variable overrides/ignores any type
qualifier (in the same type hierarchy) on the corresponding actual type
argument. For example, suppose that <span style="font-family:monospace">T</span> is a formal type parameter.
Then using <span style="font-family:monospace">@Nullable T</span> within the scope of <span style="font-family:monospace">T</span> applies the type
qualifier <span style="font-family:monospace">@Nullable</span> to the (unqualified) Java type of <span style="font-family:monospace">T</span>.
This feature is sometimes useful, but more often the implementation of a
generic type just uses the type variable <span style="font-family:monospace">T</span>, whose instantiation is
restricted (see Section ‍<a href="#generics-instantiation">30.1.2</a>).</p><p>Here is an example of applying a type annotation to a generic type
variable:</p><pre class="verbatim">  class MyClass2&lt;T&gt; {
    ...
    @Nullable T myField = null;
    ...
  }
</pre><p>The type annotation does not restrict how <span style="font-family:monospace">MyClass2</span> may be
instantiated. In other words, both
<span style="font-family:monospace">MyClass2&lt;@NonNull String&gt;</span> and <span style="font-family:monospace">MyClass2&lt;@Nullable String&gt;</span> are
legal, and in both cases <span style="font-family:monospace">@Nullable T</span> means <span style="font-family:monospace">@Nullable String</span>.
In <span style="font-family:monospace">MyClass2&lt;@Interned String&gt;</span>,
<span style="font-family:monospace">@Nullable T</span> means <span style="font-family:monospace">@Nullable @Interned String</span>.</p><p>Defaulting never affects a use of a type variable, even if the type
variable use has no explicit annotation. Defaulting helps to choose a
single type qualifier for a concrete Java class or interface. By contrast,
a type variable use represents a set of possible types.</p>
<!--TOC subsection id="annotations-on-wildcards" Annotations on wildcards-->
<h3 id="annotations-on-wildcards" class="subsection">30.1.4 Annotations on wildcards <a href="#annotations-on-wildcards"><img src="chainlink.svg" width="10" height="10"></a></h3><!--SEC END --><p>At an instantiation of a generic type, a Java wildcard indicates that some
constraints are known on the type argument, but the type argument is not known
exactly.
For example, you can indicate that the type parameter for variable <span style="font-family:monospace">ls</span> is
some unknown subtype of <span style="font-family:monospace">CharSequence</span>:</p><pre class="verbatim">  List&lt;? extends CharSequence&gt; ls;
  ls = new ArrayList&lt;String&gt;();      // OK
  ls = new ArrayList&lt;Integer&gt;();     // error: Integer is not a subtype of CharSequence
</pre><p>For more details about wildcards, see the
<a href="https://docs.oracle.com/javase/tutorial/java/generics/wildcards.html">Java
tutorial on wildcards</a> or
<a href="https://docs.oracle.com/javase/specs/jls/se17/html/jls-4.html#jls-4.5.1">JLS
§4.5.1</a>.</p><p>You can write a type annotation on the bound of a wildcard:</p><pre class="verbatim">  List&lt;? extends @NonNull CharSequence&gt; ls;
  ls = new ArrayList&lt;@NonNull String&gt;();    // OK
  ls = new ArrayList&lt;@Nullable String&gt;();   // error: @Nullable is not a subtype of @NonNull
</pre><p>Conceptually, every wildcard has two bounds — an upper bound and a lower
bound. Java only permits you to write one bound.
You can specify the upper bound with <span style="font-family:monospace">&lt;? extends SomeType&gt;</span>, in which
case the lower bound is implicitly the bottom type <span style="font-family:monospace">void</span>.
You can specify the lower bound (with <span style="font-family:monospace">&lt;? super OtherType&gt;</span>), in
which case the upper bound is implicitly the top type <span style="font-family:monospace">Object</span>.
The Checker Framework is more flexible: it lets you similarly write
annotations on both the upper and lower bound.</p><p>To annotate the <em>implicit</em> bound, write the type annotation
before the <span style="font-family:monospace">?</span>. For example:</p><pre class="verbatim">  List&lt;@LowerBound ? extends @UpperBound CharSequence&gt; lo;
  List&lt;@UpperBound ? super @NonNull Number&gt; ls;
</pre><p>For an unbounded wildcard (<span style="font-family:monospace">&lt;?&gt;</span>, with neither
bound specified), the annotation in front of a wildcard applies
to both bounds. The following three declarations are equivalent (except
that you cannot write the bottom type <span style="font-family:monospace">void</span>; note that
<a href="https://docs.oracle.com/en/java/javase/17/docs/api/java.base/java/lang/Void.html"><span style="font-family:monospace">Void</span></a> does not denote the bottom type):</p><pre class="verbatim">  List&lt;@NonNull ?&gt; lnn;
  List&lt;@NonNull ? extends @NonNull Object&gt; lnn;
  List&lt;@NonNull ? super @NonNull void&gt; lnn;
</pre><p>Note that the annotation in front of a type parameter always applies to its
lower bound, because type parameters can only be written with <span style="font-family:monospace">extends</span>
and never <span style="font-family:monospace">super</span>.</p><p>The defaulting rules for
wildcards also differ from those of type parameters (see
Section ‍<a href="#inherited-wildcard-annotations">31.5.5</a>).</p>
<!--TOC subsection id="type-parameter-qualifier-examples" Examples of qualifiers on a type parameter-->
<h3 id="type-parameter-qualifier-examples" class="subsection">30.1.5 Examples of qualifiers on a type parameter <a href="#type-parameter-qualifier-examples"><img src="chainlink.svg" width="10" height="10"></a></h3><!--SEC END --><p>Recall that <span style="font-family:monospace">@Nullable </span><span style="font-family:monospace"><em>X</em></span> is a supertype of <span style="font-family:monospace">@NonNull </span><span style="font-family:monospace"><em>X</em></span>,
for any <em>X</em>.
Most of the following types mean different things:</p><pre class="verbatim">  class MyList1&lt;@Nullable T&gt; { ... }
  class MyList1a&lt;@Nullable T extends @Nullable Object&gt; { ... } // same as MyList1
  class MyList2&lt;@NonNull T extends @NonNull Object&gt; { ... }
  class MyList2a&lt;T extends @NonNull Object&gt; { ... } // same as MyList2
  class MyList3&lt;T extends @Nullable Object&gt; { ... }
</pre><p><span style="font-family:monospace">MyList1</span> and <span style="font-family:monospace">MyList1a</span> must be instantiated with a nullable type.
The implementation of <span style="font-family:monospace">MyList1</span> must be able to consume (store) a null
value and produce (retrieve) a null value.</p><p><span style="font-family:monospace">MyList2</span> and <span style="font-family:monospace">MyList2a</span> must be instantiated with non-null type.
The implementation of <span style="font-family:monospace">MyList2</span> has to account for only non-null values — it
does not have to account for consuming or producing null.</p><p><span style="font-family:monospace">MyList3</span> may be instantiated either way:
with a nullable type or a non-null type. The implementation of <span style="font-family:monospace">MyList3</span> must consider
that it may be instantiated either way — flexible enough to support either
instantiation, yet rigorous enough to impose the correct constraints of the
specific instantiation. It must also itself comply with the constraints of
the potential instantiations.</p><p>One way to express the difference among <span style="font-family:monospace">MyList1</span>, <span style="font-family:monospace">MyList2</span>, and
<span style="font-family:monospace">MyList3</span> is by comparing what expressions are legal in the implementation
of the list — that is, what expressions may appear in the ellipsis in the
declarations above, such as inside a method’s body. Suppose each class
has, in the ellipsis, these declarations:</p><pre class="verbatim">  T t;
  @Nullable T nble;      // Section "Type annotations on a use of a generic type variable", below,
  @NonNull T nn;         // further explains the meaning of "@Nullable T" and "@NonNull T".
  void add(T arg) {}
  T get(int i) {}
</pre><p>Then the following expressions would be legal, inside a given
implementation — that is, also within the ellipses.
(Compilable source code appears as file
<span style="font-family:monospace">checker-framework/checker/tests/nullness/generics/GenericsExample.java</span>.)</p><table border=1  style="border-spacing:0;" class="cellpadding1"><tr><td style="text-align:left;border:solid 1px;white-space:nowrap" >&nbsp;</td><td style="text-align:center;border:solid 1px;white-space:nowrap" >MyList1</td><td style="text-align:center;border:solid 1px;white-space:nowrap" >MyList2</td><td style="text-align:center;border:solid 1px;white-space:nowrap" >MyList3 </td></tr>
<tr><td style="text-align:left;border:solid 1px;white-space:nowrap" > t = null;</td><td style="text-align:center;border:solid 1px;white-space:nowrap" >OK</td><td style="text-align:center;border:solid 1px;white-space:nowrap" >error</td><td style="text-align:center;border:solid 1px;white-space:nowrap" >error </td></tr>
<tr><td style="text-align:left;border:solid 1px;white-space:nowrap" > t = nble;</td><td style="text-align:center;border:solid 1px;white-space:nowrap" >OK</td><td style="text-align:center;border:solid 1px;white-space:nowrap" >error</td><td style="text-align:center;border:solid 1px;white-space:nowrap" >error </td></tr>
<tr><td style="text-align:left;border:solid 1px;white-space:nowrap" > nble = null;</td><td style="text-align:center;border:solid 1px;white-space:nowrap" >OK</td><td style="text-align:center;border:solid 1px;white-space:nowrap" >OK</td><td style="text-align:center;border:solid 1px;white-space:nowrap" >OK </td></tr>
<tr><td style="text-align:left;border:solid 1px;white-space:nowrap" > nn = null;</td><td style="text-align:center;border:solid 1px;white-space:nowrap" >error</td><td style="text-align:center;border:solid 1px;white-space:nowrap" >error</td><td style="text-align:center;border:solid 1px;white-space:nowrap" >error </td></tr>
<tr><td style="text-align:left;border:solid 1px;white-space:nowrap" > t = this.get(0);</td><td style="text-align:center;border:solid 1px;white-space:nowrap" >OK</td><td style="text-align:center;border:solid 1px;white-space:nowrap" >OK</td><td style="text-align:center;border:solid 1px;white-space:nowrap" >OK </td></tr>
<tr><td style="text-align:left;border:solid 1px;white-space:nowrap" > nble = this.get(0);</td><td style="text-align:center;border:solid 1px;white-space:nowrap" >OK</td><td style="text-align:center;border:solid 1px;white-space:nowrap" >OK</td><td style="text-align:center;border:solid 1px;white-space:nowrap" >OK </td></tr>
<tr><td style="text-align:left;border:solid 1px;white-space:nowrap" > nn = this.get(0);</td><td style="text-align:center;border:solid 1px;white-space:nowrap" >error</td><td style="text-align:center;border:solid 1px;white-space:nowrap" >OK</td><td style="text-align:center;border:solid 1px;white-space:nowrap" >error </td></tr>
<tr><td style="text-align:left;border:solid 1px;white-space:nowrap" > this.add(t);</td><td style="text-align:center;border:solid 1px;white-space:nowrap" >OK</td><td style="text-align:center;border:solid 1px;white-space:nowrap" >OK</td><td style="text-align:center;border:solid 1px;white-space:nowrap" >OK </td></tr>
<tr><td style="text-align:left;border:solid 1px;white-space:nowrap" > this.add(nble);</td><td style="text-align:center;border:solid 1px;white-space:nowrap" >OK</td><td style="text-align:center;border:solid 1px;white-space:nowrap" >error</td><td style="text-align:center;border:solid 1px;white-space:nowrap" >error </td></tr>
<tr><td style="text-align:left;border:solid 1px;white-space:nowrap" > this.add(nn);</td><td style="text-align:center;border:solid 1px;white-space:nowrap" >OK</td><td style="text-align:center;border:solid 1px;white-space:nowrap" >OK</td><td style="text-align:center;border:solid 1px;white-space:nowrap" >OK </td></tr>
</table><p>The differences are more
significant when the qualifier hierarchy is more complicated than just
<span style="font-family:monospace">@Nullable</span> and <span style="font-family:monospace">@NonNull</span>.</p>
<!--TOC subsection id="covariant-type-parameters" Covariant type parameters-->
<h3 id="covariant-type-parameters" class="subsection">30.1.6 Covariant type parameters <a href="#covariant-type-parameters"><img src="chainlink.svg" width="10" height="10"></a></h3><!--SEC END --><p>Java types are <em>invariant</em> in their type parameter. This means that
<span style="font-family:monospace">A&lt;X&gt;</span> is a subtype of <span style="font-family:monospace">B&lt;Y&gt;</span> only if <span style="font-family:monospace">X</span> is identical to <span style="font-family:monospace">Y</span>. For
example, <span style="font-family:monospace">ArrayList&lt;Number&gt;</span> is a subtype of <span style="font-family:monospace">List&lt;Number&gt;</span>, but
neither <span style="font-family:monospace">ArrayList&lt;Integer&gt;</span> nor <span style="font-family:monospace">List&lt;Integer&gt;</span> is a subtype of
<span style="font-family:monospace">List&lt;Number&gt;</span>. (If they were, there would be a loophole in the Java
type system.) For the same reason, type parameter annotations are treated
invariantly. For example, <span style="font-family:monospace">List&lt;@Nullable String&gt;</span> is not a subtype
of <span style="font-family:monospace">List&lt;String&gt;</span>.</p><p>When a type parameter is used in a read-only way — that is, when clients
read values of that type from the class but never pass values of that type
to the class — then it is safe for the
type to be <em>covariant</em> in the type parameter. Use the
<a href="../api/org/checkerframework/framework/qual/Covariant.html"><span style="font-family:monospace">@Covariant</span></a> annotation to indicate this.
When a type parameter is covariant, two instantiations of the class with
different type arguments have the same subtyping relationship as the type
arguments do.</p><p>For example, consider <span style="font-family:monospace">Iterator</span>. A client can read elements but not
write them, so <span style="font-family:monospace">Iterator&lt;@Nullable String&gt;</span> can be a subtype of
<span style="font-family:monospace">Iterator&lt;String&gt;</span> without introducing a hole in the type system.
Therefore, its type parameter is annotated with
<a href="../api/org/checkerframework/framework/qual/Covariant.html"><span style="font-family:monospace">@Covariant</span></a>.
The first type parameter of <span style="font-family:monospace">Map.Entry</span> is also covariant.
Another example would be the type parameter of a hypothetical class
<span style="font-family:monospace">ImmutableList</span>.</p><p>The <span style="font-family:monospace">@Covariant</span> annotation is trusted but not checked.
If you incorrectly specify as covariant a type parameter that can be
written (say, the class supports a
<span style="font-family:monospace">set</span> operation or some other mutation on an object of that type), then
you have created an unsoundness in the type system.
For example, it would be incorrect to annotate the type parameter of
<span style="font-family:monospace">ListIterator</span> as covariant, because <span style="font-family:monospace">ListIterator</span> supports a <span style="font-family:monospace">set</span>
operation.</p>
<!--TOC subsection id="infer-method-type-qualifiers" Method type argument inference and type qualifiers-->
<h3 id="infer-method-type-qualifiers" class="subsection">30.1.7 Method type argument inference and type qualifiers <a href="#infer-method-type-qualifiers"><img src="chainlink.svg" width="10" height="10"></a></h3><!--SEC END --><p>Sometimes method type argument inference does not interact well with
type qualifiers. In such situations, you might need to provide
explicit method type arguments, for which the syntax is as follows:</p><pre>
    Collections.&lt;@MyTypeAnnotation Object&gt;sort(l, c);
</pre><p>This uses Java’s existing syntax for specifying a method call’s type arguments.</p>
<!--TOC subsection id="bottom-type" The Bottom type-->
<h3 id="bottom-type" class="subsection">30.1.8 The Bottom type <a href="#bottom-type"><img src="chainlink.svg" width="10" height="10"></a></h3><!--SEC END --><p>Many type systems have a <span style="font-family:monospace">*Bottom</span> type that is used only for the <span style="font-family:monospace">null</span>
value, dead code, and some erroneous situations. A programmer should
rarely write the bottom type.</p><p>One use is on a lower bound, to indicate that any type qualifier is
permitted. A lower-bounded wildcard indicates that a consumer method can
accept a collection containing any Java type above some Java type, and you
can add the bottom type qualifier as well:</p><pre class="verbatim">public static void addNumbers(List&lt;? super @SignednessBottom Integer&gt; list) { ... }
</pre>
<!--TOC section id="qualifier-polymorphism" Qualifier polymorphism for methods-->
<h2 id="qualifier-polymorphism" class="section">30.2 Qualifier polymorphism for methods<a id="method-qualifier-polymorphism"></a> <a href="#method-qualifier-polymorphism"><img src="chainlink.svg" width="10" height="10"></a></h2><!--SEC END --><p>Type qualifier polymorphism permits a single method to have multiple different qualified
type signatures.</p><p>Here is where a polymorphic qualifier (e.g., <span style="font-family:monospace">@PolyNull</span>) can be used:
</p><ul class="itemize"><li class="li-itemize">
Polymorphic qualifiers are most often used in method signatures.
See the examples below in Section ‍<a href="#qualifier-polymorphism-examples">30.2.1</a>.
</li><li class="li-itemize">Polymorphic qualifiers can also be written in method bodies
(implementations).
</li><li class="li-itemize">If you can use generics, you typically do not need to use a
polymorphic qualifier. Do not write a polymorphic qualifier on a type
variable declaration.
</li><li class="li-itemize">Polymorphic qualifiers may not be used on a class declaration.
To apply qualifier polymorphism to classes, use a class qualifier
parameter; see Section ‍<a href="#class-qualifier-polymorphism">30.3</a>.
</li><li class="li-itemize">A polymorphic qualifier may be used on a field declaration only in a
class with a class qualifier parameter; see Section ‍<a href="#class-qual-param-field">30.3.2</a>.
</li><li class="li-itemize">If a class has a class qualifier parameter, then a polymorphic
qualifier written on a method in the class has a slightly different
meaning, see Section ‍<a href="#class-qual-param-method">30.3.1</a>.
</li></ul><p>Section ‍<a href="#creating-declarative-hierarchy">35.5.2</a> explains how to define a
polymorphic qualifier.</p>
<!--TOC subsection id="qualifier-polymorphism-examples" Using polymorphic qualifiers in a method signature-->
<h3 id="qualifier-polymorphism-examples" class="subsection">30.2.1 Using polymorphic qualifiers in a method signature <a href="#qualifier-polymorphism-examples"><img src="chainlink.svg" width="10" height="10"></a></h3><!--SEC END --><p>A method whose signature has a polymorphic qualifier (such as <span style="font-family:monospace">@PolyNull</span>) conceptually has multiple
versions, somewhat like the generics feature of Java or a template in C++.
In each version, each instance of the polymorphic qualifier has been
replaced by the same other qualifier from the hierarchy.</p><p>The method body must type-check with all signatures. A method call is
type-correct if it type-checks under any one of the signatures. If a call
matches multiple signatures, then the compiler uses the most specific
matching signature for the purpose of type-checking. This is the same as
Java’s rule for resolving overloaded methods.</p><p>As an example of the use of <span style="font-family:monospace">@PolyNull</span>, method
<a href="https://docs.oracle.com/en/java/javase/17/docs/api/java.base/java/lang/Class.html#cast(java.lang.Object)"><span style="font-family:monospace">Class.cast</span></a>
returns null if and only if its argument is <span style="font-family:monospace">null</span>:</p><pre class="verbatim">  @PolyNull T cast(@PolyNull Object obj) { ... }
</pre><p>This is like writing:</p><pre class="verbatim">   @NonNull T cast( @NonNull Object obj) { ... }
  @Nullable T cast(@Nullable Object obj) { ... }
</pre><p>except that the latter is not legal Java, since it defines two
methods with the same Java signature.</p><p>As another example, consider</p><pre class="verbatim">  // Returns null if either argument is null.
  @PolyNull T max(@PolyNull T x, @PolyNull T y);
</pre><p>which is like writing</p><pre class="verbatim">   @NonNull T max( @NonNull T x,  @NonNull T y);
  @Nullable T max(@Nullable T x, @Nullable T y);
</pre><p>At a call site, the most specific applicable signature is selected.</p><p>Another way of thinking about which one of the two <span style="font-family:monospace">max</span> variants is
selected is that the nullness annotations of (the declared types of) both
arguments are <em>unified</em> to a type that is a supertype of both, also
known as the <em>least upper bound</em> or lub. If both
arguments are <span style="font-family:monospace">@NonNull</span>, their unification (lub) is <span style="font-family:monospace">@NonNull</span>, and the
method return type is <span style="font-family:monospace">@NonNull</span>. But if even one of the arguments is <span style="font-family:monospace">@Nullable</span>,
then the unification (lub) is <span style="font-family:monospace">@Nullable</span>, and so is the return type.</p>
<!--TOC subsection id="qualifier-polymorphism-vs-subtyping" Relationship to subtyping and generics-->
<h3 id="qualifier-polymorphism-vs-subtyping" class="subsection">30.2.2 Relationship to subtyping and generics <a href="#qualifier-polymorphism-vs-subtyping"><img src="chainlink.svg" width="10" height="10"></a></h3><!--SEC END --><p>Qualifier polymorphism has the same purpose and plays the same role as
Java’s generics. You use them for the similar reasons, such as:
</p><ul class="itemize"><li class="li-itemize">
A method operates on collections with different types of
elements.
</li><li class="li-itemize">Two different arguments have the same type, without constraining them to
be one specific type.
</li><li class="li-itemize">A method returns a value of the same type as its argument.
</li></ul><p>If a method is written using Java generics, it usually does not need
qualifier polymorphism. If you can use Java’s generics, then that is often
better. On the other hand, if you have legacy code that is not
written generically, and you cannot change it to use generics, then you can
use qualifier polymorphism to achieve a similar effect, with respect to
type qualifiers only. The Java compiler still treats the base Java types
non-generically.</p><p>In some cases, you don’t need qualifier polymorphism because subtyping
already provides the needed functionality.
<span style="font-family:monospace">String</span> is a supertype of <span style="font-family:monospace">@Interned String</span>, so a method <span style="font-family:monospace">toUpperCase</span>
that is declared to take a <span style="font-family:monospace">String</span> parameter can also be called on an
<span style="font-family:monospace">@Interned String</span> argument.</p>
<!--TOC subsection id="qualifier-polymorphism-multiple-qualifiers" Using multiple polymorphic qualifiers in a method signature-->
<h3 id="qualifier-polymorphism-multiple-qualifiers" class="subsection">30.2.3 Using multiple polymorphic qualifiers in a method signature <a href="#qualifier-polymorphism-multiple-qualifiers"><img src="chainlink.svg" width="10" height="10"></a></h3><!--SEC END --><p>Usually, it does not make sense to write only a single instance of a polymorphic
qualifier in a method definition: if you write one instance of (say)
<span style="font-family:monospace">@PolyNull</span>, then you should use at least two.
The main benefit of polymorphic qualifiers comes when one is used multiple times
in a method, since then each instance turns into the same type qualifier.
(Section ‍<a href="#qualifier-polymorphism-single-qualifier">30.2.4</a> describes some
exceptions to this rule: times when it makes sense to write a single
polymorphic qualifier in a signature.)</p><p>Most frequently, the polymorphic qualifier appears on at least one formal
parameter and also on the return type.</p><p>It can also be useful to have
polymorphic qualifiers on (only) multiple formal parameters, especially if
the method side-effects one of its arguments.
For example, consider</p><pre class="verbatim">void moveBetweenStacks(Stack&lt;@PolyNull Object&gt; s1, Stack&lt;@PolyNull Object&gt; s2) {
  s1.push(s2.pop());
}
</pre><p>In this particular example, it would be cleaner to rewrite your code to use
Java generics, if you can do so:</p><pre class="verbatim">&lt;T&gt; void moveBetweenStacks(Stack&lt;T&gt; s1, Stack&lt;T&gt; s2) {
  s1.push(s2.pop());
}
</pre>
<!--TOC subsection id="qualifier-polymorphism-single-qualifier" Using a single polymorphic qualifier in a method signature-->
<h3 id="qualifier-polymorphism-single-qualifier" class="subsection">30.2.4 Using a single polymorphic qualifier in a method signature <a href="#qualifier-polymorphism-single-qualifier"><img src="chainlink.svg" width="10" height="10"></a></h3><!--SEC END --><p>As explained in Section ‍<a href="#qualifier-polymorphism-multiple-qualifiers">30.2.3</a>,
you will usually use a polymorphic qualifier
multiple times in a signature.
This section describes situations when it makes sense to write just one
polymorphic qualifier in a method signature.
Some of these situations can be avoided by writing a generic method,
but in legacy code it may not be possible for you to change a method to be
generic.</p>
<!--TOC subsubsection id="qualifier-polymorphism-return-type" Using a single polymorphic qualifier on a return type-->
<h4 id="qualifier-polymorphism-return-type" class="subsubsection">Using a single polymorphic qualifier on a return type <a href="#qualifier-polymorphism-return-type"><img src="chainlink.svg" width="10" height="10"></a></h4><!--SEC END --><p>It is unusual, but permitted, to write just one polymorphic qualifier, on a return type.</p><p>This is just like it is unusual, but permitted, to write just one
occurrence of a generic type parameter, on a return type. An example of
such a method is
<a href="https://docs.oracle.com/en/java/javase/17/docs/api/java.base/java/util/Collections.html#emptyList()"><span style="font-family:monospace">Collections.emptyList()</span></a>.</p>
<!--TOC subsubsection id="qualifier-polymorphism-element-types" Using a single polymorphic qualifier on an element type-->
<h4 id="qualifier-polymorphism-element-types" class="subsubsection">Using a single polymorphic qualifier on an element type <a href="#qualifier-polymorphism-element-types"><img src="chainlink.svg" width="10" height="10"></a></h4><!--SEC END --><p>It can make sense to use a polymorphic qualifier just once, on an array or
generic element type.</p><p>For example, consider a routine that returns the index, in an array, of a
given element:</p><pre class="verbatim">  public static int indexOf(@PolyNull Object[] a, @Nullable Object elt) { ... }
</pre><p>If <span style="font-family:monospace">@PolyNull</span> were replaced with either <span style="font-family:monospace">@Nullable</span> or <span style="font-family:monospace">@NonNull</span>, then
one of these safe client calls would be rejected:</p><pre class="verbatim">  @Nullable Object[] a1;
  @NonNull Object[] a2;

  indexOf(a1, someObject);
  indexOf(a2, someObject);
</pre><p>Of course, it would be better style to use a generic method, as in either
of these signatures:</p><pre class="verbatim"> public static &lt;T extends @Nullable Object&gt; int indexOf(T[] a, @Nullable Object elt) { ... }
 public static &lt;T extends @Nullable Object&gt; int indexOf(T[] a, T elt) { ... }
</pre><p>Another example is a method that writes bytes to a file. It accepts an
array of signed or unsigned bytes, and it behaves identically for both:</p><pre class="verbatim">  void write(@PolySigned byte[] b) { ... }
</pre><p>These examples use arrays, but there are similar examples that
use collections.</p>
<!--TOC subsubsection id="qualifier-polymorphism-formal-parameter" Don’t use a single polymorphic qualifier on a formal parameter type-->
<h4 id="qualifier-polymorphism-formal-parameter" class="subsubsection">Don’t use a single polymorphic qualifier on a formal parameter type <a href="#qualifier-polymorphism-formal-parameter"><img src="chainlink.svg" width="10" height="10"></a></h4><!--SEC END --><p>There is no point to writing just one polymorphic qualifier in a method
signature, as the main type qualifier on a formal parameter type.
Consider this signature:</p><pre class="verbatim">  void m(@PolyNull Object obj)
</pre><p>which expands to</p><pre class="verbatim">  void m(@NonNull Object obj)
  void m(@Nullable Object obj)
</pre><p>This is no different (in terms of which calls to the method will
type-check) than writing just</p><pre class="verbatim">  void m(@Nullable Object obj)
</pre><p>However, it does make sense to write a single polymorphic qualifier
<em>within</em> a formal parameter type, as in
</p><pre class="verbatim">  void m2a(List&lt;@PolyNull MySubClass&gt; strings)
</pre><p>
which is similar to
</p><pre class="verbatim">  void m2b(List&lt;? extends @Nullable MySubClass&gt; strings)
</pre><p>
Method <span style="font-family:monospace">m2b()</span> can be called on (for example) <span style="font-family:monospace">List&lt;@Nullable
MySubClass&gt;</span> and <span style="font-family:monospace">List&lt;@NonNull MySubClass&gt;</span>, which are not legal
arguments to method <span style="font-family:monospace">m2a()</span>.</p>
<!--TOC section id="class-qualifier-polymorphism" Class qualifier parameters-->
<h2 id="class-qualifier-polymorphism" class="section">30.3 Class qualifier parameters <a href="#class-qualifier-polymorphism"><img src="chainlink.svg" width="10" height="10"></a></h2><!--SEC END --><p>Class qualifier parameters permit you to supply a type qualifier (only,
without a Java basetype) to any class (generic or not).</p><p>When a generic class represents a collection, a user can write a type
qualifier on the type argument, as in <span style="font-family:monospace">List&lt;@Tainted Character&gt;</span>
versus <span style="font-family:monospace">List&lt;@Untainted Character&gt;</span>. When a non-generic class
represents a collection with a hard-coded type (as <span style="font-family:monospace">StringBuffer</span>
hard-codes <span style="font-family:monospace">Character</span>), you can use a class qualifier parameter to
distinguish <span style="font-family:monospace">StringBuffer</span>s that contain different types of characters.
</p><p>To add a qualifier parameter to a class, annotate its declaration with <a href="../api/org/checkerframework/framework/qual/HasQualifierParameter.html"><span style="font-family:monospace">@HasQualifierParameter</span></a>
and write the class of the top qualifier as its element.</p><pre class="verbatim">@HasQualifierParameter(Tainted.class)
class StringBuffer { ... }
</pre><p>A qualifier on a use of <span style="font-family:monospace">StringBuffer</span> is treated as
appearing both on the <span style="font-family:monospace">StringBuffer</span> and on its conceptual type argument. That
is:<br>
<span style="font-family:monospace">
@Tainted StringBuffer </span>≈<span style="font-family:monospace"> @Tainted Collection&lt;@Tainted Character&gt;<br>
 @Untainted StringBuffer </span>≈<span style="font-family:monospace"> @Untainted Collection&lt;@Untainted Character&gt;
</span></p><p>If two types have different qualifier arguments, they have no subtyping
relationship. (This is “invariant subtyping”, also used by Java for
generic classes.) In particular, <span style="font-family:monospace">@Untainted StringBuffer</span> is not a
subtype of <span style="font-family:monospace">@Tainted StringBuffer</span>; an attempt to cast between them, in
either direction, will yield an <span style="font-family:monospace">invariant.cast.unsafe</span> error.</p><p>If a subclass extends a <span style="font-family:monospace">@HasQualifierParameter</span> class (or implements a
<span style="font-family:monospace">@HasQualifierParameter</span> interface), then the subclass must also be marked
<span style="font-family:monospace">@HasQualifierParameter</span>.</p><p>Within a class with a qualifier parameter,
the default qualifier for uses of that class is the polymorphic qualifier.</p>
<!--TOC subsection id="class-qual-param-method" Resolving polymorphism when the receiver type has a polymorphic qualifier-->
<h3 id="class-qual-param-method" class="subsection">30.3.1 Resolving polymorphism when the receiver type has a polymorphic qualifier <a href="#class-qual-param-method"><img src="chainlink.svg" width="10" height="10"></a></h3><!--SEC END --><p>Qualifier polymorphism changes the rules for instantiating polymorphic
qualifiers (Section ‍<a href="#method-qualifier-polymorphism">30.2</a>).
If the receiver type has a qualifier parameter and is annotated with a polymorphic qualifier,
then at a call site all polymorphic annotations are instantiated to
the same qualifier as the type of the receiver expression of the method call.
Otherwise, use the rules of Section ‍<a href="#method-qualifier-polymorphism">30.2</a></p><p>For example, consider</p><pre class="verbatim">@HasQualifierParameter(Tainted.class)
class Buffer {
  void append(@PolyTainted Buffer this, @PolyTainted String s) { ... }
}
</pre><p>Because <span style="font-family:monospace">@PolyTainted</span> applies to a type (<span style="font-family:monospace">Buffer</span>) with a qualifier parameter, all
uses of <span style="font-family:monospace">@PolyTainted</span> are instantiated to the qualifiers on the type of
the receiver expression at call sites to <span style="font-family:monospace">append</span>. For example,</p><pre class="verbatim">@Untainted Buffer untaintedBuffer = ...;
@Tainted String taintedString = ...;
untaintedBuffer.append(taintedString); // error: (argument.type.incompatible)
</pre><p>
The above <span style="font-family:monospace">append</span> call is illegal because the <span style="font-family:monospace">@PolyTainted</span> is instantiated to <span style="font-family:monospace">@Untainted</span> and
the type of the argument is <span style="font-family:monospace">@Tainted</span> which is a supertype of <span style="font-family:monospace">@Untainted</span>. If the type of
<span style="font-family:monospace">untaintedBuffer</span> were <span style="font-family:monospace">@Tainted</span> then the call would be legal.</p>
<!--TOC subsection id="class-qual-param-field" Using class qualifier parameters in the type of a field-->
<h3 id="class-qual-param-field" class="subsection">30.3.2 Using class qualifier parameters in the type of a field <a href="#class-qual-param-field"><img src="chainlink.svg" width="10" height="10"></a></h3><!--SEC END --><p>To express that the type of a field
should have the same qualifier as the class qualifier parameter,
annotate the field type with the polymorphic qualifier for the type system.</p><pre class="verbatim">@HasQualifierParameter(Tainted.class)
class Buffer {
  @PolyTainted String field;
}
</pre><p>At a field access where the declared type of the field has a polymorphic
qualifier, that polymorphic qualifier is instantiated to the qualifier on the
type of the receiver of the field access (or in the case of type variables, the
qualifier on the upper bound). That is, the qualifier on <span style="font-family:monospace">myBuffer.field</span>
is that same as that on <span style="font-family:monospace">myBuffer</span>.</p>
<!--TOC subsection id="local-vars-qual-param-defaults" Local variable defaults for types with qualifier parameters-->
<h3 id="local-vars-qual-param-defaults" class="subsection">30.3.3 Local variable defaults for types with qualifier parameters <a href="#local-vars-qual-param-defaults"><img src="chainlink.svg" width="10" height="10"></a></h3><!--SEC END --><p>Local variables default to the top type (see
Section ‍<a href="#climb-to-top">31.5.3</a>). Type refinement determines if a variable can be
treated as a suitable subtype, and annotations on local variables are rarely
needed as a result. However, since qualifier parameters add invariant subtyping,
type refinement is no longer valid. For example, suppose in the following code
that <span style="font-family:monospace">StringBuffer</span> is annotated with <span style="font-family:monospace">@HasQualifierParameter(Tainted.class)</span>.</p><pre class="verbatim">    void method(@Untainted StringBuffer buffer) {
        StringBuffer local = buffer;
        executeSql(local.toString());
    }

    void executeSql(@Untainted String code) {
        // ...
    }
</pre><p>Normally, the framework would determine that <span style="font-family:monospace">local</span> has type <span style="font-family:monospace">@Untainted
StringBuffer</span> and the call to <span style="font-family:monospace">executeSql</span> would be valid. However, since by
default <span style="font-family:monospace">local</span> has type <span style="font-family:monospace">@Tainted StringBuffer</span>, and
<span style="font-family:monospace">@Untainted StringBuffer</span> is not a subtype, no type refinement would be
performed, leading to an error. Fixing this would require manually annotating
<span style="font-family:monospace">local</span> as an <span style="font-family:monospace">@Untainted StringBuffer</span>, increasing the annotation burden on
programmers.</p><p>For this reason, local variables with types that have a qualifier parameter use
different defaulting rules. When a local variable has an initializer, the type
of that initializer is used as the default type of that variable if no other
annotations are written. For example, in the above code, the type of <span style="font-family:monospace">local</span>
would be <span style="font-family:monospace">@Untainted StringBuffer</span>. This eliminates the need for type
refinement.</p>
<!--TOC subsection id="default-has-qualifier-parameter" Qualifier parameters by default-->
<h3 id="default-has-qualifier-parameter" class="subsection">30.3.4 Qualifier parameters by default <a href="#default-has-qualifier-parameter"><img src="chainlink.svg" width="10" height="10"></a></h3><!--SEC END --><p>If many classes in a project should have <span style="font-family:monospace">@HasQualifierParameter</span>, it’s
possible to enable it on all classes in a package by default. Writing
<span style="font-family:monospace">@HasQualifierParameter</span> on a package is equivalent to writing
<span style="font-family:monospace">@HasQualifierParameter</span> on each class in that package and all subpackages with
the same arguments.</p><p>For example, writing this annotation enables <span style="font-family:monospace">@HasQualifierParameter</span>
for all classes in <span style="font-family:monospace">mypackage</span>.</p><pre class="verbatim">@HasQualifierParameter(Tainted.class)
package mypackage;
</pre><p>When using <span style="font-family:monospace">@HasQualifierParameter</span> on a package, it’s possible to disable it
for a specific class using <a href="../api/org/checkerframework/framework/qual/NoQualifierParameter.html"><span style="font-family:monospace">@NoQualifierParameter</span></a>.
Writing this on a class indicates it has no class qualifier parameter and
<span style="font-family:monospace">@HasQualifierParameter</span> will not be enabled by default. Like
<span style="font-family:monospace">@HasQualifierParameter</span>, it takes one or more top annotations. It is illegal
to explicitly write both <span style="font-family:monospace">@HasQualifierParameter</span> and <span style="font-family:monospace">@NoQualifierParameter</span>
on the same class for the same hierarchy.</p>
<!--TOC subsection id="class-qual-param-type-arg" Types with qualifier parameters as type arguments-->
<h3 id="class-qual-param-type-arg" class="subsection">30.3.5 Types with qualifier parameters as type arguments <a href="#class-qual-param-type-arg"><img src="chainlink.svg" width="10" height="10"></a></h3><!--SEC END --><p>Types with qualifier parameters are only allowed as type arguments to type parameters whose upper bound
have a qualifier parameter. If they were allowed for as type arguments for any type parameter, then
unsound casts would be permitted. For example:</p><pre class="verbatim">    @HasQualifierParameter(Tainted.class)
    interface Buffer {
        void append(@PolyTainted String s);
    }

    public class ClassQPTypeVarTest {
        &lt;T&gt; @Tainted T cast(T param) {
            return param;
        }

        void bug(@Untainted Buffer b, @Tainted String s) {
            cast(b).append(s);  // error
        }
    }


</pre><hr>
<!--TOC chapter id="advanced-type-system-features" Advanced type system features-->
<h1 id="advanced-type-system-features" class="chapter">Chapter ‍31 Advanced type system features <a href="#advanced-type-system-features"><img src="chainlink.svg" width="10" height="10"></a></h1><!--SEC END --><p>This chapter describes features that are automatically supported by every
checker written with the Checker Framework.
You may wish to skim or skip this chapter on first reading. After you have
used a checker for a little while and want to be able to express more
sophisticated and useful types, or to understand more about how the Checker
Framework works, you can return to it.</p>
<!--TOC section id="invariant-arrays" Invariant array types-->
<h2 id="invariant-arrays" class="section">31.1 Invariant array types <a href="#invariant-arrays"><img src="chainlink.svg" width="10" height="10"></a></h2><!--SEC END --><p>Java’s type system is unsound with respect to arrays. That is, the Java
type-checker approves code that is unsafe and will cause a run-time crash.
Technically, the problem is that Java has “covariant array types”, such
as treating <span style="font-family:monospace">String[]</span> as a subtype of <span style="font-family:monospace">Object[]</span>. Consider the
following example:</p><pre class="verbatim">  String[] strings = new String[] {"hello"};
  Object[] objects = strings;
  objects[0] = new Object();
  String myString = strs[0];
</pre><p>The above code puts an <span style="font-family:monospace">Object</span> in the array <span style="font-family:monospace">strings</span> and thence in
<span style="font-family:monospace">myString</span>, even though <span style="font-family:monospace">myString = new Object()</span> should be, and is,
rejected by the Java type system. Java prevents corruption of the JVM by
doing a costly run-time check at every array assignment; nonetheless, it is
undesirable to learn about a type error only via a run-time crash rather
than at compile time.</p><p>When you pass the <span style="font-family:monospace">-AinvariantArrays</span> command-line option,
the Checker Framework is stricter than Java, in the sense that it treats
arrays invariantly rather than covariantly. This means that a type system
built upon the Checker Framework is sound: you get a compile-time
guarantee without the need for any run-time checks. But it also means that
the Checker Framework rejects code that is similar to what Java unsoundly
accepts. The guarantee and the compile-time checks are about your
extended type system. The Checker Framework does not reject the example
code above, which contains no type annotations.</p><p>Java’s covariant array typing is sound if the array is used in a read-only
fashion: that is, if the array’s elements are accessed but the array is
not modified. However, facts about read-only usage are not built into any of
the type-checkers. Therefore, when using type systems
along with <span style="font-family:monospace">-AinvariantArrays</span>, you will need to suppress any warnings that
are false positives because the array is treated in a read-only way.</p>
<!--TOC section id="array-context-sensitive" Context-sensitive type inference for array constructors-->
<h2 id="array-context-sensitive" class="section">31.2 Context-sensitive type inference for array constructors <a href="#array-context-sensitive"><img src="chainlink.svg" width="10" height="10"></a></h2><!--SEC END --><p>When you write an expression, the Checker Framework gives it the most
precise possible type, depending on the particular expression or value.
For example, when using the Regex Checker (Chapter ‍<a href="#regex-checker">13</a>),
the string <span style="font-family:monospace">"hello"</span> is given type <span style="font-family:monospace">@Regex String</span> because it is a legal
regular expression (whether it is meant to be used as one or not) and the
string <span style="font-family:monospace">"(foo"</span> is given the type <span style="font-family:monospace">@RegexBottom String</span> because it is not
a legal regular expression.</p><p>Array constructors work differently. When you create an array with the
array constructor syntax, such as the right-hand side of this assignment:</p><pre class="verbatim">String[] myStrings = {"hello"};
</pre><p>then the expression does not get the most precise possible type, because
doing so could cause inconvenience. Rather, its type is determined by the
context in which it is used: the left-hand side if it is in an assignment,
the declared formal parameter type if it is in a method call, etc.</p><p>In particular, if the expression <code class="verb">{"hello"}</code> were given the type
<span style="font-family:monospace">@Regex String[]</span>, then the assignment would be illegal! But the Checker
Framework gives the type <span style="font-family:monospace">String[]</span> based on the assignment context, so the code
type-checks.</p><p>If you prefer a specific type for a constructed array, you can indicate
that either in the context (change the declaration of <span style="font-family:monospace">myStrings</span>) or in a
<span style="font-family:monospace">new</span> construct (change the expression to <span style="font-family:monospace">new @Regex String[] </span><code class="verb">{"hello"}</code>).</p>
<!--TOC section id="upper-bound-for-use" Upper bound of qualifiers on uses of a given type (annotations on a class declaration)-->
<h2 id="upper-bound-for-use" class="section">31.3 Upper bound of qualifiers on uses of a given type (annotations on a class declaration) <a href="#upper-bound-for-use"><img src="chainlink.svg" width="10" height="10"></a></h2><!--SEC END --><p>The examples in this section use the type qualifier hierarchy <span style="font-family:monospace">@A :&gt; @B :&gt; @C</span>.</p><p>A qualifier on a use of a certain type must be a subtype or equal to the upper bound for that type.
The upper bound of qualifiers used on a given type is specified by annotating the type declaration
with some qualifier — that is, by writing an annotation on a class declaration.
</p><pre class="verbatim">  @C class MyClass {}
</pre><p>This means that <span style="font-family:monospace">@B MyClass</span> is an invalid type. (Annotations on class declarations may also specify
default annotations for uses of the type; see Section ‍<a href="#default-for-use">31.5.1</a>)</p><p>If it is not possible to annotate the class’s definition (e.g., for
primitives and some library classes),
the type-system designer can specify an upper bound by using the meta-annotation
<a href="../api/org/checkerframework/framework/qual/UpperBoundFor.html"><span style="font-family:monospace">@UpperBoundFor</span></a>.</p><p>If no annotation is present on a type declaration and if no <span style="font-family:monospace">@UpperBoundFor</span> mentions the type, then
the bound is top. This can be changed by overriding
<a href="../api/org/checkerframework/framework/type/AnnotatedTypeFactory.html#getTypeDeclarationBounds(javax.lang.model.type.TypeMirror)"><span style="font-family:monospace">AnnotatedTypeFactory#getTypeDeclarationBounds</span></a>.</p><p>There are two exceptions.
</p><ul class="itemize"><li class="li-itemize">
An expression can have a supertype of the upper bound; that is, some expression could
have type <span style="font-family:monospace">@B MyClass</span>. This type is not written explicitly, but results from viewpoint adaptation.
</li><li class="li-itemize">Using usual CLIMB-to-top rules (Section ‍<a href="#climb-to-top">31.5.3</a>),
local variables of type MyClass default to <span style="font-family:monospace">@A MyClass</span>.
It is legal for <span style="font-family:monospace">@A MyClass</span> to be the type of a local variable.
For consistency, users are allowed to write such a type on a local variable declaration.
</li></ul><p>Due to existing type rules, an expression of type <span style="font-family:monospace">@A MyClass</span> can only be used in limited ways.
</p><ul class="itemize"><li class="li-itemize">
Since every field, formal parameter, and return type of type MyClass (or lower) is annotated as
<span style="font-family:monospace">@B</span> (or lower), it cannot be assigned to a field, passed to a method, or returned from a method.
</li><li class="li-itemize">It can be used in a context that requires <span style="font-family:monospace">@A Object</span> (or whatever the least supertype is of MyClass
for which the <span style="font-family:monospace">@A</span> qualifier is permitted). Examples include being tested against <span style="font-family:monospace">null</span> or
(for most type systems) being passed to polymorphic routines such as <span style="font-family:monospace">System.out.println</span> or <span style="font-family:monospace">System.identityHashCode</span>.
</li></ul><p>These operations might refine its type. If a user wishes to annotate a method that does type refinement,
its formal parameter must be of illegal type <span style="font-family:monospace">@A MyClass</span>, which requires a warning suppression.</p><p>If the framework were to forbid expressions and local variables from having types inconsistent with the class annotation,
then important APIs and common coding paradigms would no longer type-check.</p><p>Consider the annotation
</p><pre class="verbatim">  @NonNull class Optional { ... }
</pre><p>
and the client code</p><pre class="verbatim">  Map&lt;String, Optional&gt; m;
  String key = ...;
  Optional value = m.get(key);
  if (value != null) {
    ...
  }
</pre><p>The type of <span style="font-family:monospace">m.get(key)</span> is <span style="font-family:monospace">@Nullable Optional</span>, which is an illegal type.
However, this is a very common paradigm. Programmers should not need to rewrite the code to test
<span style="font-family:monospace">m.containsKey(key)</span> nor suppress a warning in this safe code.</p>
<!--TOC section id="effective-qualifier" The effective qualifier on a type (defaults and inference)-->
<h2 id="effective-qualifier" class="section">31.4 The effective qualifier on a type (defaults and inference) <a href="#effective-qualifier"><img src="chainlink.svg" width="10" height="10"></a></h2><!--SEC END --><p>A checker sometimes treats a type as having a slightly different qualifier
than what is written on the type — especially if the programmer wrote no
qualifier at all.
Most readers can skip this section on first reading, because you will
probably find the system simply “does what you mean”, without forcing
you to write too many qualifiers in your program.
particular, programmers rarely write qualifiers in method bodies (except on
type arguments and array component types).</p><p>The following steps determine the effective
qualifier on a type — the qualifier that the checkers treat as being present.</p><ol class="enumerate" type=1><li class="li-enumerate">
If a type qualifier is present in the source code, that qualifier is used.</li><li class="li-enumerate">If there is no explicit qualifier on a type, then a default
qualifier
is applied; see Section ‍<a href="#defaults">31.5</a>. Defaulted qualifiers are treated by checkers
exactly as if the programmer had written them explicitly.</li><li class="li-enumerate">The type system may refine a qualified type on a local variable — that
is, treat it as a subtype of how it was declared or defaulted. This
refinement is always sound and has the effect of eliminating false
positive error messages. See Section ‍<a href="#type-refinement">31.7</a>.</li></ol>
<!--TOC section id="defaults" Default qualifier for unannotated types-->
<h2 id="defaults" class="section">31.5 Default qualifier for unannotated types <a href="#defaults"><img src="chainlink.svg" width="10" height="10"></a></h2><!--SEC END --><p>An unannotated
Java type is treated as if it had a default annotation.
Both the type system designer and an end-user programmer can control the defaulting.
Defaulting never applies to uses of type variables, even if they do not
have an explicit type annotation.
Most of this section is about defaults for source code that is read by
the compiler. When the compiler reads a <span style="font-family:monospace">.class</span> file, different
defaulting rules apply.
See Section ‍<a href="#defaults-classfile">31.5.6</a> for these rules.</p><p>There are several defaulting mechanisms, for convenience and flexibility.
When determining the default qualifier for a use of an unannotated type, <span style="font-family:monospace">MyClass</span>, the following
rules are used in order, until one applies.
</p><ol class="enumerate" type=1><li class="li-enumerate">
The qualifier specified via <span style="font-family:monospace">@DefaultQualifierForUse</span> on the declaration of <span style="font-family:monospace">MyClass</span>.
(Section ‍<a href="#default-for-use">31.5.1</a>)
</li><li class="li-enumerate">If no <span style="font-family:monospace">@NoDefaultQualifierForUse</span> is written on the declaration of <span style="font-family:monospace">MyClass</span>, the qualifier
explicitly written on the declaration of <span style="font-family:monospace">MyClass</span>. (Section ‍<a href="#default-for-use">31.5.1</a>)
</li><li class="li-enumerate">The qualifier with a meta-annotation <span style="font-family:monospace">@DefaultFor(types = MyClass.class)</span>. (Section ‍<a href="#default-for-use">31.5.1</a>)
</li><li class="li-enumerate">The qualifier with a meta-annotation <span style="font-family:monospace">@DefaultFor(typeKinds = KIND)</span>, where <span style="font-family:monospace">KIND</span> is the
<span style="font-family:monospace">TypeKind</span> of <span style="font-family:monospace">MyClass</span>. (Section ‍<a href="#default-for-use">31.5.1</a>)
</li><li class="li-enumerate">The qualifier with a meta-annotation <span style="font-family:monospace">@DefaultFor(names = REGEX)</span>, where <span style="font-family:monospace">REGEX</span>
matches the name of the variable being defined (if any). For return types, the name of
the method is used. (Section ‍<a href="#default-for-use">31.5.1</a>)
</li><li class="li-enumerate">The qualifier in the innermost user-written <span style="font-family:monospace">@DefaultQualifier</span> for the location of the use of <span style="font-family:monospace">MyClass</span>.
(Section ‍<a href="#default-qualifier">31.5.2</a>)
</li><li class="li-enumerate">The qualifier in the meta-annotation <span style="font-family:monospace">@DefaultFor</span> for the location of the use of <span style="font-family:monospace">MyClass</span>.
These are defaults specified by the type system designer (Section ‍<a href="#creating-typesystem-defaults">35.5.4</a>);
this is usually CLIMB-to-top (Section ‍<a href="#climb-to-top">31.5.3</a>).
</li><li class="li-enumerate">The qualifier with the meta-annotation <a href="../api/org/checkerframework/framework/qual/DefaultQualifierInHierarchy.html"><span style="font-family:monospace">@DefaultQualifierInHierarchy</span></a>.
</li></ol><p>If the unannotated type is the type of a local variable, then the first 5 rules are skipped and only
rules 6 and 7 apply. If rule 6 applies, it makes the type of local variables top so they can be refined.</p>
<!--TOC subsection id="default-for-use" Default for use of a type-->
<h3 id="default-for-use" class="subsection">31.5.1 Default for use of a type <a href="#default-for-use"><img src="chainlink.svg" width="10" height="10"></a></h3><!--SEC END --><p>
The type declaration annotation <a href="../api/org/checkerframework/framework/qual/DefaultQualifierForUse.html"><span style="font-family:monospace">@DefaultQualifierForUse</span></a>
indicates that the specified qualifier should be added to all unannotated uses of the type.</p><p>For example:
</p><pre class="verbatim">@DefaultQualifierForUse(B.class)
class MyClass {}
</pre><p>This means any unannotated use of <span style="font-family:monospace">MyClass</span> is treated as <span style="font-family:monospace">@B MyClass</span> by the checker.
(Except for locals, which can be refined.)</p><p>Similarly, the meta-annotation <a href="../api/org/checkerframework/framework/qual/DefaultFor.html"><span style="font-family:monospace">@DefaultFor</span></a> can be used to specify defaults
for uses of types, using the <span style="font-family:monospace">types</span> element, or type kinds, using the <span style="font-family:monospace">typeKinds</span> elements.</p><p>Interaction between qualifier bounds and <span style="font-family:monospace">DefaultQualifierForUse</span>:
</p><ul class="itemize"><li class="li-itemize">
If a type declaration is annotated with a qualifier bound, but not a <span style="font-family:monospace">@DefaultQualifierForUse</span>,
then the qualifier bound is added to all unannotated uses of that type (except locals).
For example, <span style="font-family:monospace">@C class MyClass </span> is equivalent to
<pre class="verbatim">@DefaultQualifierForUse(C.class)
@C class MyClass {}
</pre></li><li class="li-itemize">If the qualifier bound should not be added to all unannotated uses, then
<a href="../api/org/checkerframework/framework/qual/NoDefaultQualifierForUse.html"><span style="font-family:monospace">@NoDefaultQualifierForUse</span></a> should be written on the declaration:
<pre class="verbatim">@NoDefaultQualifierForUse
@C class MyClass {}
</pre>
This means that unannotated uses of MyClass are defaulted normally.
</li><li class="li-itemize">If neither <span style="font-family:monospace">@DefaultQualifierForUse</span> nor a qualifier bound is present on a type declaration, that
is equivalent to writing <span style="font-family:monospace">@NoDefaultQualifierForUse</span>.</li></ul>
<!--TOC subsection id="default-qualifier" Controlling defaults in source code-->
<h3 id="default-qualifier" class="subsection">31.5.2 Controlling defaults in source code <a href="#default-qualifier"><img src="chainlink.svg" width="10" height="10"></a></h3><!--SEC END --><p>
The end-user programmer specifies a default qualifier by writing the
<a href="../api/org/checkerframework/framework/qual/DefaultQualifier.html"><span style="font-family:monospace">@DefaultQualifier</span></a><span style="font-family:monospace">(</span><span style="font-family:monospace"><em>ClassName</em></span><span style="font-family:monospace">, </span>[<em>locations</em>]<span style="font-family:monospace">)</span>
annotation on a package, class, method, or variable declaration. The
argument to <a href="../api/org/checkerframework/framework/qual/DefaultQualifier.html"><span style="font-family:monospace">@DefaultQualifier</span></a> is the <span style="font-family:monospace">Class</span>
name of an annotation.
The optional second argument indicates where the default
applies. If the second argument is omitted, the specified annotation is
the default in all locations. See the Javadoc of <a href="../api/org/checkerframework/framework/qual/DefaultQualifier.html"><span style="font-family:monospace">DefaultQualifier</span></a> for details.</p><p>For example, using the Nullness type system (Chapter ‍<a href="#nullness-checker">3</a>):</p><pre class="verbatim">import org.checkerframework.framework.qual.DefaultQualifier;
import org.checkerframework.checker.nullness.qual.NonNull;

@DefaultQualifier(NonNull.class)
class MyClass {

  public boolean compile(File myFile) { // myFile has type "@NonNull File"
    if (!myFile.exists())          // no warning: myFile is non-null
      ...
    @Nullable File srcPath = ...;  // must annotate to specify "@Nullable File"
    if (srcPath.exists())          // warning: srcPath might be null
      ...
  }

  @DefaultQualifier(Tainted.class)
  public boolean isJavaFile(File myfile) {  // myFile has type "@Tainted File"
    ...
  }
}
</pre><p>You may write multiple
<a href="../api/org/checkerframework/framework/qual/DefaultQualifier.html"><span style="font-family:monospace">@DefaultQualifier</span></a> annotations at a single location.</p><p>If <span style="font-family:monospace">@DefaultQualifier</span>[<span style="font-family:monospace">s</span>] is placed on a package (via the
<span style="font-family:monospace">package-info.java</span> file), then it applies to the given package <em>and</em>
all subpackages.
</p>
<!--TOC subsection id="climb-to-top" Defaulting rules and CLIMB-to-top-->
<h3 id="climb-to-top" class="subsection">31.5.3 Defaulting rules and CLIMB-to-top <a href="#climb-to-top"><img src="chainlink.svg" width="10" height="10"></a></h3><!--SEC END --><p>Each type system defines a default qualifier (see
Section ‍<a href="#creating-typesystem-defaults">35.5.4</a>). For example, the default
qualifier for the Nullness Checker is
<a href="../api/org/checkerframework/checker/nullness/qual/NonNull.html"><span style="font-family:monospace">@NonNull</span></a>. When a user
writes an unqualified type such as <span style="font-family:monospace">Date</span>, the Nullness Checker interprets it as
<span style="font-family:monospace">@NonNull Date</span>.</p><p>The type system applies that default qualifier to most but
not all type uses. In particular, unless otherwise stated, every type system
uses the CLIMB-to-top rule. This
rule states that the <em>top</em> qualifier in the hierarchy is the default for
the CLIMB locations: <span style="font-weight:bold">C</span>asts, <span style="font-weight:bold">L</span>ocals,
and (some) <span style="font-weight:bold">Im</span>plicit <span style="font-weight:bold">B</span>ounds.
For example, when the user writes an unqualified type such as <span style="font-family:monospace">Date</span> in such a
location, the Nullness Checker interprets it as <span style="font-family:monospace">@Nullable Date</span> (because
<a href="../api/org/checkerframework/checker/nullness/qual/Nullable.html"><span style="font-family:monospace">@Nullable</span></a> is the top qualifier in the
hierarchy, see Figure ‍<a href="#fig-nullness-hierarchy">3.1</a>).
(Casts are treated a bit specially; see below.)</p><p>The CLIMB-to-top rule is used only for unannotated source code that is
being processed by a checker. For unannotated libraries (code read by the
compiler in <span style="font-family:monospace">.class</span> or <span style="font-family:monospace">.jar</span> form), see Section ‍<a href="#defaults-classfile">31.5.6</a>.</p><p>The rest of this section explains the rationale and implementation of
CLIMB-to-top.</p><p>Here is the rationale for CLIMB-to-top:</p><ul class="itemize"><li class="li-itemize">
Local variables are defaulted to top because type refinement
(Section ‍<a href="#type-refinement">31.7</a>) is applied to local variables. If a local
variable starts as the top type, then the Checker Framework refines it to
the best (most specific) possible type based on assignments to it. As a
result, a programmer rarely writes an explicit annotation on any of those
locations.<p>Variables defaulted to top include local variables, resource variables in the
try-with-resources construct, variables in <span style="font-family:monospace">for</span> statements, and <span style="font-family:monospace">catch</span>
arguments (known as exception parameters in the Java Language Specification).</p><p>Exception parameters default to the top type because they might catch an
exception thrown anywhere in the program.</p><p>An alternate design for exception parameters would be to default exception
parameters some other type T (instead of the top type); then the Checker
Framework would need to issue a warning at every <span style="font-family:monospace">throw</span> statement whose
argument might not be a subtype of T. A checker can implement this
alternate design by overriding a few methods. The alternative is not
appropriate for all type systems. The alternative is unsound for deep type
systems because the JDK’s annotations are trusted rather than checked. A
deep type system is one where the type of a field can determine the type of
its containing instance, such as tainting, Example: a user passes a secret
regex to the JDK, and the JDK throws a format exception that includes the
regex. This could be caught by a <span style="font-family:monospace">catch</span> clause in the program whose
exception parameter is not annotated as secret. As another example, the
user passes a secret integer and the JDK throws a DivideByZeroException
that reveals the value.</p></li><li class="li-itemize">Cast types are defaulted to the same type as their argument expression.
This has the same effect as if they were given the
top type and then flow-sensitively refined to the type of their argument.
However, note that programmer-written type qualifiers are <em>not</em>
refined, so writing the top annotation is not the same as writing no annotation.
</li><li class="li-itemize">Implicit upper bounds are defaulted to top to allow them to be instantiated
in any way.<p>Suppose a user declares a class as <span style="font-family:monospace">class C&lt;T&gt; </span><span style="font-family:monospace">{</span><span style="font-family:monospace"> ... </span><span style="font-family:monospace">}</span>.
The Checker Framework assumes that the user intended to allow any
instantiation of the class. The Checker Framework interprets the
declaration as <span style="font-family:monospace">class C&lt;T extends @Nullable
Object&gt; </span><span style="font-family:monospace">{</span><span style="font-family:monospace"> ... </span><span style="font-family:monospace">}</span> rather than as <span style="font-family:monospace">class C&lt;T extends
@NonNull Object&gt; </span><span style="font-family:monospace">{</span><span style="font-family:monospace"> ... </span><span style="font-family:monospace">}</span>. The latter would forbid
instantiations such as <span style="font-family:monospace">C&lt;@Nullable String&gt;</span>, or would require
rewriting of code. On the other hand, if a user writes an explicit bound
such as <span style="font-family:monospace">class C&lt;T extends D&gt; </span><span style="font-family:monospace">{</span><span style="font-family:monospace"> ... </span><span style="font-family:monospace">}</span>, then the user
intends some restriction on instantiation and can write a qualifier on the
upper bound as desired.</p><p>This rule means that the upper bound of <span style="font-family:monospace">class C&lt;T&gt;</span> is defaulted
differently than the upper bound of <span style="font-family:monospace">class C&lt;T extends Object&gt;</span>.
This is a bit unfortunate, but it is the least bad option. The
more confusing alternative would be for “<span style="font-family:monospace">Object</span>” to be defaulted
differently in <span style="font-family:monospace">class C&lt;T extends Object&gt;</span> and in an
instantiation <span style="font-family:monospace">C&lt;Object&gt;</span>, and for the upper bounds to be defaulted
differently in <span style="font-family:monospace">class C&lt;T extends Object&gt;</span>
and <span style="font-family:monospace">class C&lt;T extends Date&gt;</span>.</p></li><li class="li-itemize">Implicit <em>lower</em> bounds are defaulted to the bottom type, again to allow
maximal instantiation. Note that Java does not allow a programmer to
express both the upper and lower bounds of a type, but the Checker
Framework allows the programmer to specify either or both;
see Section ‍<a href="#generics-defaults">30.1.2</a>.</li></ul><p>A <a href="../api/org/checkerframework/framework/qual/DefaultQualifier.html"><span style="font-family:monospace">@DefaultQualifier</span></a> that specifies a
CLIMB-to-top location takes precedence over the CLIMB-to-top rule.</p><p>Here is how the Nullness Checker overrides part of the CLIMB-to-top rule:</p><pre class="verbatim">@DefaultQualifierInHierarchy
@DefaultFor({ TypeUseLocation.EXCEPTION_PARAMETER })
public @interface NonNull {}

public @interface Nullable {}
</pre><p>As mentioned above, the exception parameters are always non-null, so
<span style="font-family:monospace">@DefaultFor({ TypeUseLocation.EXCEPTION_PARAMETER })</span> on <span style="font-family:monospace">@NonNull</span> overrides
the CLIMB-to-top rule.</p>
<!--TOC subsection id="inherited-defaults" Inherited defaults-->
<h3 id="inherited-defaults" class="subsection">31.5.4 Inherited defaults <a href="#inherited-defaults"><img src="chainlink.svg" width="10" height="10"></a></h3><!--SEC END --><p>When overriding a method, programmers must fully specify types in the overriding
method, which duplicates information on the overridden method.
By contrast, declaration annotations that are meta-annotated with
<span style="font-family:monospace">@InheritedAnnotation</span> are inherited by overriding methods.</p><p>An example for type annotations is that when defining an <span style="font-family:monospace">equals()</span>
method, programmers must write the type annotation <span style="font-family:monospace">@Nullable</span>:</p><pre class="verbatim">  public boolean equals(@Nullable Object obj) {
      ...
  }
</pre><p>An alternate design would be for every annotation on a superclass member to
to be automatically inherited by subclasses that override it.</p><p>The alternate design would reduce annotation effort.</p><p>The alternate design would reduce program comprehensibility.
Currently, a user can determine the annotation on a parameter or return
value by looking at a single file. If annotations could be inherited from
supertypes, then a user would have to examine all supertypes, and do
computations over them, to understand the meaning of an unannotated type in
a given file.
For declaration annotations, no computation is necessary; that is why they
may be inherited.
Computation is necessary for type annotations because different annotations might be inherited
from a supertype and an interface, or from two interfaces. For return
types, the inherited type should be the least upper bound of all
annotations on overridden implementations in supertypes. For method
parameters, the inherited type should be the greatest lower bound of all
annotations on overridden implementations in supertypes. In each case, the
Checker Framework would need to issue an error if no such annotations existed.</p><p>Because a program is read more often than it is edited/annotated, the
Checker Framework does not currently support the alternate design. In the
future, this feature may be added.</p>
<!--TOC subsection id="inherited-wildcard-annotations" Inherited wildcard annotations-->
<h3 id="inherited-wildcard-annotations" class="subsection">31.5.5 Inherited wildcard annotations <a href="#inherited-wildcard-annotations"><img src="chainlink.svg" width="10" height="10"></a></h3><!--SEC END --><p>If a wildcard is unbounded and has no annotation (e.g. <span style="font-family:monospace">List&lt;?&gt;</span>),
the annotations on the wildcard’s bounds are copied from the type parameter
to which the wildcard is an argument.</p><p>For example, the two wildcards in
the declarations below are equivalent.</p><pre class="verbatim">class MyList&lt;@Nullable T extends @Nullable Object&gt; {}

MyList&lt;?&gt; listOfNullables;
MyList&lt;@Nullable ? extends @Nullable Object&gt; listOfNullables;
</pre><p>The Checker Framework copies
these annotations because wildcards must be within the bounds of their
corresponding type parameter.
By contrast, if the bounds of a wildcard
were defaulted differently from the bounds of its corresponding type
parameter, then there would be many false positive
<span style="font-family:monospace">type.argument.type.incompatible</span> warnings.</p><p>Here is another example of two equivalent wildcard declarations:</p><pre class="verbatim">class MyList&lt;@Regex(5) T extends @Regex(1) Object&gt; {}

MyList&lt;?&gt; listOfRegexes;
MyList&lt;@Regex(5) ? extends @Regex(1) Object&gt; listOfRegexes;
</pre><p>Note, this copying of annotations for a wildcard’s bounds applies only to
unbounded wildcards. The two wildcards in the
following example are equivalent.</p><pre class="verbatim">class MyList&lt;@NonNull T extends @Nullable Object&gt; {}

MyList&lt;? extends Object&gt; listOfNonNulls;
MyList&lt;@NonNull ? extends @NonNull Object&gt; listOfNonNulls2;
</pre><p>Note, the upper bound of the wildcard <span style="font-family:monospace">? ‍extends Object</span> is defaulted to
<span style="font-family:monospace">@NonNull</span> using the CLIMB-to-top rule (see Section ‍<a href="#climb-to-top">31.5.3</a>).
Also note that the <span style="font-family:monospace">MyList</span> class declaration could have been more succinctly
written as: <span style="font-family:monospace">class MyList&lt;T extends @Nullable Object&gt;</span> where the lower bound
is implicitly the bottom annotation: <span style="font-family:monospace">@NonNull</span>.</p>
<!--TOC subsection id="defaults-classfile" Default qualifiers for <span style="font-family:monospace">.class</span> files (library defaults)-->
<h3 id="defaults-classfile" class="subsection">31.5.6 Default qualifiers for <span style="font-family:monospace">.class</span> files (library defaults) <a href="#defaults-classfile"><img src="chainlink.svg" width="10" height="10"></a></h3><!--SEC END --><p>(<em>Note:</em> Currently, the conservative library defaults presented in this section
are off by default and can be turned on by supplying the <span style="font-family:monospace">-AuseConservativeDefaultsForUncheckedCode=bytecode</span>
command-line option. In a future release, they will be turned on
by default and it will be possible to turn them off by supplying a
<span style="font-family:monospace">-AuseConservativeDefaultsForUncheckedCode=-bytecode</span> command-line option.)</p><p>The defaulting rules presented so far apply to source code that is read by
the compiler. When the compiler reads a <span style="font-family:monospace">.class</span> file, different
defaulting rules apply.</p><p>If the checker was run during the compiler execution that created the
<span style="font-family:monospace">.class</span> file,
then there is no need for
defaults: the <span style="font-family:monospace">.class</span> file has an explicit qualifier at each type use.
(Furthermore, unless warnings were suppressed, those qualifiers are
guaranteed to be correct.)
When you are performing pluggable type-checking,
it is best to ensure that the compiler only reads such <span style="font-family:monospace">.class</span> files.
Section ‍<a href="#compiling-libraries">34.4</a> discusses how to create annotated
libraries.
</p><p>If the checker was not run during the compiler execution that created the
<span style="font-family:monospace">.class</span> file, then the <span style="font-family:monospace">.class</span> file contains only the type qualifiers
that the programmer wrote explicitly. (Furthermore, there is no guarantee
that these qualifiers are correct, since they have not been checked.)
In this case, each checker decides what qualifier to use for the
locations where the programmer did not write an annotation. Unless otherwise noted, the
choice is:</p><ul class="itemize"><li class="li-itemize">
For method parameters and lower bounds, use the bottom qualifier (see
Section ‍<a href="#creating-bottom-qualifier">35.5.7</a>).
</li><li class="li-itemize">For method return values, fields, and upper bounds, use the top qualifier (see
Section ‍<a href="#creating-top-qualifier">35.5.7</a>).
</li></ul><p>These choices are conservative. They are likely to cause many
false-positive type-checking errors, which will help you to know which
library methods need annotations. You can then write those library
annotations (see Chapter ‍<a href="#annotating-libraries">34</a>) or alternately
suppress the warnings (see Chapter ‍<a href="#suppressing-warnings">32</a>).</p><p>For example, an unannotated method</p><pre class="verbatim">  String concatenate(String p1, String p2)
</pre><p>in a classfile would be interpreted as</p><pre class="verbatim">  @Top String concatenate(@Bottom String p1, @Bottom String p2)
</pre><p>There is no single possible default that is sound for fields. In the rare
circumstance that there is a mutable public field in an unannotated
library, the Checker Framework may fail to warn about code that can
misbehave at run time.</p>
<!--TOC section id="annotations-on-constructors" Annotations on constructors-->
<h2 id="annotations-on-constructors" class="section">31.6 Annotations on constructors <a href="#annotations-on-constructors"><img src="chainlink.svg" width="10" height="10"></a></h2><!--SEC END -->
<!--TOC subsection id="annotations-on-constructor-declarations" Annotations on constructor declarations-->
<h3 id="annotations-on-constructor-declarations" class="subsection">31.6.1 Annotations on constructor declarations <a href="#annotations-on-constructor-declarations"><img src="chainlink.svg" width="10" height="10"></a></h3><!--SEC END --><p>An annotation on the “return type” of a constructor declaration indicates
what the constructor creates. For example,</p><pre class="verbatim">@B class MyClass {
  @C MyClass() {}
}
</pre><p>means that invoking that constructor creates a <span style="font-family:monospace">@C MyClass</span>.</p><p>The Checker Framework cannot verify that the constructor really creates
such an object, because the Checker Framework does not know the
type-system-specific semantics of the <span style="font-family:monospace">@C</span> annotation.
Therefore, if the constructor result type is different than the top annotation in the
hierarchy, the Checker Framework will issue a warning.
The programmer should check the annotation manually, then
suppress the warning.</p>
<!--TOC subsubsection id="constructor-declaration-defaults" Defaults-->
<h4 id="constructor-declaration-defaults" class="subsubsection">Defaults <a href="#constructor-declaration-defaults"><img src="chainlink.svg" width="10" height="10"></a></h4><!--SEC END --><p>If a constructor declaration is unannotated, it defaults to the same type as that of
its enclosing class (rather than the default qualifier in the hierarchy).
For example, the Tainting Checker (Chapter ‍<a href="#tainting-checker">10</a>) has <span style="font-family:monospace">@Tainted</span>
as its default qualifier. Consider the following class:</p><pre class="verbatim">  @Untainted class MyClass {
    MyClass() {}
  }
</pre><p>The constructor declaration is equivalent to <span style="font-family:monospace">@Untainted MyClass() </span><span style="font-family:monospace">{</span><span style="font-family:monospace">}</span>.</p><p>The Checker Framework produces the same error messages for
explicitly-written and defaulted annotations.</p>
<!--TOC subsection id="annotations-on-constructor-invocations" Annotations on constructor invocations-->
<h3 id="annotations-on-constructor-invocations" class="subsection">31.6.2 Annotations on constructor invocations <a href="#annotations-on-constructor-invocations"><img src="chainlink.svg" width="10" height="10"></a></h3><!--SEC END --><p>The type of a method call expression <span style="font-family:monospace">x.myMethod(y, z)</span> is determined by
the return type of the declaration of <span style="font-family:monospace">myMethod</span>. There is no way to
write an annotation on the call to change its type. However, it is
possible to write a cast: <span style="font-family:monospace">(@Anno SomeType) x.myMethod(y, z)</span>. The Checker
Framework will issue a warning that it cannot verify that the downcast is
correct. The programmer should manually determine that the annotation is
correct and then suppress the warning.</p><p>A constructor invocation <span style="font-family:monospace">new MyClass()</span> is also a call, so its semantics
are similar. The type of the expression is determined by the annotation on
the result type of the constructor declaration. It is possible to write a cast
<span style="font-family:monospace">(@Anno MyClass) new MyClass()</span>. The syntax <span style="font-family:monospace">new @Anno MyClass()</span> is shorthand
for the cast. For either syntax, the Checker Framework will issue a
warning that it cannot verify that the cast is correct. The programmer may
suppress the warning if the code is correct.</p>
<!--TOC section id="type-refinement" Type refinement (flow-sensitive type qualifier inference)-->
<h2 id="type-refinement" class="section">31.7 Type refinement (flow-sensitive type qualifier inference) <a href="#type-refinement"><img src="chainlink.svg" width="10" height="10"></a></h2><!--SEC END --><p>A checker can sometimes deduce that an expression’s type is more specific
than — that is, a subtype of — its declared or defaulted (Section ‍<a href="#defaults">31.5</a>).
This is called “flow-sensitive type refinement” or “local type inference”.</p><p>Due to local type refinement, a programmer typically
does not write any qualifiers on local variables within a method body
(except on type arguments and array component types).
However, the programmer must write type annotations for method
signatures (arguments and return values) and fields, unless the default
annotations are correct.
Local type refinement does not change the source code; it re-runs every time
you run a checker.</p>
<!--TOC subsection id="type-refinement-examples" Type refinement examples-->
<h3 id="type-refinement-examples" class="subsection">31.7.1 Type refinement examples <a href="#type-refinement-examples"><img src="chainlink.svg" width="10" height="10"></a></h3><!--SEC END --><p>Here is an example for the Nullness Checker
(Chapter ‍<a href="#nullness-checker">3</a>).
<span style="font-family:monospace">myVar</span> is declared as <span style="font-family:monospace">@Nullable String</span>, but
it is treated as <span style="font-family:monospace">@NonNull String</span> within the body of the <span style="font-family:monospace">if</span> test.</p><pre class="verbatim">  @Nullable String myVar;
  ...                   // myVar has type @Nullable String here.
  myVar.hashCode();     // warning: possible dereference of null.
  ...
  if (myVar != null) {
    ...                 // myVar has type @NonNull String here.
    myVar.hashCode();   // no warning.
  }
</pre><p>Here is another example.
Note that the same expression may yield a
warning or not depending on its context (that is, depending on the current
type refinement).</p><pre class="verbatim">  @Nullable String myVar;
  ...                   // myVar has type @Nullable String
  myVar = "hello";
  ...                   // myVar has type @NonNull String
  myVar.hashCode();     // no warning
  ...
  myVar = myMap.get(someKey);
  ...                   // myVar has type @Nullable String
  myVar.hashCode();     // warning: posible dereference of null
</pre><p>Type refinement applies to every checker, including new
checkers that you write. Here is an example for the Regex Checker
(Chapter ‍<a href="#regex-checker">13</a>):</p><pre class="verbatim">  void m2(@Unannotated String s) {
    s = RegexUtil.asRegex(s, 2);  // asRegex throws an exception if its argument is not
                                  // a regex with the given number of capturing groups
    ...   // s now has type "@Regex(2) String"
  }
</pre>
<!--TOC subsection id="type-refinement-behavior" Type refinement behavior-->
<h3 id="type-refinement-behavior" class="subsection">31.7.2 Type refinement behavior <a href="#type-refinement-behavior"><img src="chainlink.svg" width="10" height="10"></a></h3><!--SEC END --><p>The checker treats a variable or expression as a subtype of its declared type:
</p><ul class="itemize"><li class="li-itemize">
starting at the time that
it is assigned a value,
a method establishes a postcondition (e.g., as
expressed by <a href="../api/org/checkerframework/checker/nullness/qual/EnsuresNonNull.html"><span style="font-family:monospace">@EnsuresNonNull</span></a> or
<a href="../api/org/checkerframework/framework/qual/EnsuresQualifierIf.html"><span style="font-family:monospace">@EnsuresQualifierIf</span></a>), or
a run-time check is performed (e.g., via an assertion or
<span style="font-family:monospace">if</span> statement).
</li><li class="li-itemize">until its value might change (e.g.,
via an assignment, or because a method call might have a side effect).
</li></ul><p>The checker never treats a variable as
a supertype of its declared type. For example, an expression with declared type <a href="../api/org/checkerframework/checker/nullness/qual/NonNull.html"><span style="font-family:monospace">@NonNull</span></a>
type is never treated as possibly-null, and such an assignment is always illegal.</p><p>The functionality has a variety of names: type refinement,
flow-sensitive type qualifier inference, local type inference, and
sometimes just “flow”.</p>
<!--TOC subsection id="type-refinement-which-types" Which types are refined-->
<h3 id="type-refinement-which-types" class="subsection">31.7.3 Which types are refined <a href="#type-refinement-which-types"><img src="chainlink.svg" width="10" height="10"></a></h3><!--SEC END --><p>You generally do not need to annotate the top-level type of a local variable.
You do need to annotate its type arguments or array element types.
(Type refinement does not change them, because doing so would not produce a
subtype, as explained in see Section ‍<a href="#covariant-type-parameters">30.1.6</a> and
Section ‍<a href="#invariant-arrays">31.1</a>.)
Type refinement works within a method, so you still need to
annotate method signatures (parameter and return type) and field types.</p><p>If you find examples where you think a value should be inferred to have
(or not have) a
given annotation, but the checker does not do so, please submit a bug
report (see Section ‍<a href="#reporting-bugs">39.2</a>) that includes a small piece of
Java code that reproduces the problem.</p>
<!--TOC subsubsection id="type-refinement-fields" Fields and type refinement-->
<h4 id="type-refinement-fields" class="subsubsection">Fields and type refinement <a href="#type-refinement-fields"><img src="chainlink.svg" width="10" height="10"></a></h4><!--SEC END --><p>Type refinement infers the type of fields in some restricted cases:</p><ul class="itemize"><li class="li-itemize">A final initialized field:
Type inference is performed for final fields that are initialized to a
compile-time constant at the declaration site; so the type of <span style="font-family:monospace">protocol</span>
is <span style="font-family:monospace">@NonNull String</span> in the following declaration:<pre class="verbatim">    public final String protocol = "https";
</pre><p>Such an inferred type may leak to the public interface of the class.
If you wish to override such behavior, you can explicitly insert the desired
annotation, e.g.,</p><pre class="verbatim">    public final @Nullable String protocol = "https";
</pre></li><li class="li-itemize">Within method bodies:
Type inference is performed for fields in the context of method bodies,
like local variables or any other expression.
Consider the following example, where <span style="font-family:monospace">updatedAt</span> is a nullable
field:<pre class="verbatim">class DBObject {
  @Nullable Date updatedAt;

  void m() {
    // updatedAt is @Nullable, so warning about .getTime()
    ... updatedAt.getTime() ... // warning about possible NullPointerException

    if (updatedAt == null) {
      updatedAt = new Date();
    }

    // updatedAt is now @NonNull, so .getTime() call is OK
    ... updatedAt.getTime() ...
  }
}
</pre><p>A method call may invalidate inferences about field types; see
Section ‍<a href="#type-refinement-purity">31.7.5</a>.</p></li></ul>
<!--TOC subsection id="type-refinement-runtime-tests" Run-time tests and type refinement-->
<h3 id="type-refinement-runtime-tests" class="subsection">31.7.4 Run-time tests and type refinement <a href="#type-refinement-runtime-tests"><img src="chainlink.svg" width="10" height="10"></a></h3><!--SEC END --><p>Some type systems support a run-time test that the Checker Framework can
use to refine types within the scope of a conditional such as <span style="font-family:monospace">if</span>, after
an <span style="font-family:monospace">assert</span> statement, etc.</p><p>Whether a type system supports such a run-time test depends on whether the
type system is computing properties of data itself, or properties of
provenance (the source of the data). An example of a property about data is
whether a string is a regular expression. An example of a property about
provenance is units of measure: there is no way to look at the
representation of a number and determine whether it is intended to
represent kilometers or miles.</p><p>Type systems that support a run-time test are:
</p><ul class="itemize"><li class="li-itemize">
<a href="#nullness-checker">Nullness Checker</a> for null pointer errors
(see Chapter ‍<a href="#nullness-checker">3</a>)
</li><li class="li-itemize"><a href="#map-key-checker">Map Key Checker</a> to track which values are
keys in a map (see Chapter ‍<a href="#map-key-checker">4</a>)
</li><li class="li-itemize"><a href="#optional-checker">Optional Checker</a> for errors in using the
<a href="https://docs.oracle.com/en/java/javase/17/docs/api/java.base/java/util/Optional.html"><span style="font-family:monospace">Optional</span></a> type (see
Chapter ‍<a href="#optional-checker">5</a>)
</li><li class="li-itemize"><a href="#lock-checker">Lock Checker</a> for concurrency and lock errors
(see Chapter ‍<a href="#lock-checker">11</a>)
</li><li class="li-itemize"><a href="#index-checker">Index Checker</a> for array accesses
(see Chapter ‍<a href="#index-checker">12</a>)
</li><li class="li-itemize"><a href="#resource-leak-checker">Resource Leak Checker</a> for ensuring that resources are disposed of properly
(see Chapter ‍<a href="#resource-leak-checker">8</a>)
</li><li class="li-itemize"><a href="#regex-checker">Regex Checker</a> to prevent use of syntactically
invalid regular expressions (see Chapter ‍<a href="#regex-checker">13</a>)
</li><li class="li-itemize"><a href="#formatter-checker">Format String Checker</a> to ensure that format
strings have the right number and type of <span style="font-family:monospace">%</span> directives (see
Chapter ‍<a href="#formatter-checker">14</a>)
</li><li class="li-itemize"><a href="#i18n-formatter-checker">Internationalization Format String Checker</a>
to ensure that i18n format strings have the right number and type of
<span style="font-family:monospace">{}</span> directives (see Chapter ‍<a href="#i18n-formatter-checker">15</a>)
</li></ul><p>Type systems that do not currently support a run-time test, but could do so with some
additional implementation work, are</p><ul class="itemize"><li class="li-itemize">
<a href="#interning-checker">Interning Checker</a> for errors in equality
testing and interning (see Chapter ‍<a href="#interning-checker">6</a>)
</li><li class="li-itemize"><a href="#propkey-checker">Property File Checker</a> to ensure that valid
keys are used for property files and resource bundles (see
Chapter ‍<a href="#propkey-checker">16</a>)
</li><li class="li-itemize"><a href="#i18n-checker">Internationalization Checker</a> to
ensure that code is properly internationalized (see
Chapter ‍<a href="#i18n-checker">16.2</a>)
</li><li class="li-itemize"><a href="#signature-checker">Signature String Checker</a> to ensure that the
string representation of a type is properly used, for example in
<span style="font-family:monospace">Class.forName</span> (see Chapter ‍<a href="#signature-checker">17</a>).
</li><li class="li-itemize"><a href="#constant-value-checker">Constant Value Checker</a> to determine
whether an expression’s value can be known at compile time
(see Chapter ‍<a href="#constant-value-checker">22</a>)
</li></ul><p>Type systems that cannot support a run-time test are:</p><ul class="itemize"><li class="li-itemize">
<a href="#initialization-checker">Initialization Checker</a> to ensure all
fields are set in the constructor (see
Chapter ‍<a href="#initialization-checker">3.8</a>)
</li><li class="li-itemize"><a href="#called-methods-checker">Called Methods Checker</a> for
the builder pattern (see Chapter ‍<a href="#called-methods-checker">7</a>)
</li><li class="li-itemize"><a href="#fenum-checker">Fake Enum Checker</a> to allow type-safe fake enum
patterns and type aliases or typedefs (see Chapter ‍<a href="#fenum-checker">9</a>)
</li><li class="li-itemize"><a href="#tainting-checker">Tainting Checker</a> for trust and security errors
(see Chapter ‍<a href="#tainting-checker">10</a>)
</li><li class="li-itemize"><a href="#guieffect-checker">GUI Effect Checker</a> to ensure that non-GUI
threads do not access the UI, which would crash the application
(see Chapter ‍<a href="#guieffect-checker">18</a>)
</li><li class="li-itemize"><a href="#units-checker">Units Checker</a> to ensure operations are
performed on correct units of measurement
(see Chapter ‍<a href="#units-checker">19</a>)
</li><li class="li-itemize"><a href="#signedness-checker">Signedness Checker</a> to
ensure unsigned and signed values are not mixed
(see Chapter ‍<a href="#signedness-checker">20</a>)
</li><li class="li-itemize"><a href="#purity-checker">Purity Checker</a> to identify whether
methods have side effects (see Chapter ‍<a href="#purity-checker">21</a>)
</li><li class="li-itemize"><a href="#initialized-fields-checker">Initialized Fields Checker</a> to ensure all
fields are set in the constructor (see
Chapter ‍<a href="#initialization-checker">3.8</a>)
</li><li class="li-itemize"><a href="#aliasing-checker">Aliasing Checker</a> to identify whether
expressions have aliases (see Chapter ‍<a href="#aliasing-checker">26</a>)
</li><li class="li-itemize"><a href="#must-call-checker">Must Call Checker</a> to over-approximate the
methods that should be called on an object before it is de-allocated (see Chapter ‍<a href="#must-call-checker">27</a>)
</li><li class="li-itemize"><a href="#subtyping-checker">Subtyping Checker</a> for customized checking without
writing any code (see Chapter ‍<a href="#subtyping-checker">28</a>)
</li></ul>
<!--TOC subsection id="type-refinement-purity" Side effects, determinism, purity, and type refinement-->
<h3 id="type-refinement-purity" class="subsection">31.7.5 Side effects, determinism, purity, and type refinement <a href="#type-refinement-purity"><img src="chainlink.svg" width="10" height="10"></a></h3><!--SEC END --><p>Calling a method typically causes the checker to discard its knowledge of
the refined type, because the method might assign a field.
The <a href="../api/org/checkerframework/dataflow/qual/SideEffectFree.html"><span style="font-family:monospace">@SideEffectFree</span></a> annotation indicates that
the method has no side effects, so calling it does not invalidate any
dataflow facts.</p><p>Calling a method twice might have different results, so facts known about
one call cannot be relied upon at another call.
The <a href="../api/org/checkerframework/dataflow/qual/Deterministic.html"><span style="font-family:monospace">@Deterministic</span></a> annotation indicates that
the method returns the same result every time it is called on the same
arguments.</p><p><a href="../api/org/checkerframework/dataflow/qual/Pure.html"><span style="font-family:monospace">@Pure</span></a> means both
<a href="../api/org/checkerframework/dataflow/qual/SideEffectFree.html"><span style="font-family:monospace">@SideEffectFree</span></a> and
<a href="../api/org/checkerframework/dataflow/qual/Deterministic.html"><span style="font-family:monospace">@Deterministic</span></a>.
The <a href="../api/org/checkerframework/dataflow/qual/TerminatesExecution.html"><span style="font-family:monospace">@TerminatesExecution</span></a> annotation
indicates that a given method never returns. This can enable the
type refinement to be more precise.</p><p>Chapter ‍<a href="#purity-checker">21</a> gives more information about these annotations.
This section explains how to use them to improve type refinement.</p>
<!--TOC subsubsection id="type-refinement-side-effects" Side effects-->
<h4 id="type-refinement-side-effects" class="subsubsection">Side effects <a href="#type-refinement-side-effects"><img src="chainlink.svg" width="10" height="10"></a></h4><!--SEC END --><p>Consider the following declarations and uses:</p><pre class="verbatim">  @Nullable Object myField;

  int computeValue() { ... }

  void m() {
    ...
    if (myField != null) {
                        // The type of myField is now "@NonNull Object".
      int result = computeValue();
                        // The type of myField is now "@Nullable Object",
                        // because computeValue might have set myField to null.
      myField.toString(); // Warning: possible null pointer exception.
    }
  }
</pre><p>There are three ways to express that <span style="font-family:monospace">computeValue</span> does not set
<span style="font-family:monospace">myField</span> to <span style="font-family:monospace">null</span>, and thus to prevent the Nullness Checker from
issuing a warning about the call <span style="font-family:monospace">myField.toString()</span>.</p><ol class="enumerate" type=1><li class="li-enumerate">
If <span style="font-family:monospace">computeValue</span> has no side effects, declare the method as
<a href="../api/org/checkerframework/dataflow/qual/SideEffectFree.html"><span style="font-family:monospace">@SideEffectFree</span></a>:<pre class="verbatim">  @SideEffectFree
  int computeValue() { ... }
</pre><p>The Nullness Checker issues no warnings, because it can reason that
the second occurrence of <span style="font-family:monospace">myField</span> has the same (non-null) value as
the one in the test.</p></li><li class="li-enumerate">If no method resets <span style="font-family:monospace">myField</span> to <span style="font-family:monospace">null</span> after it has been initialized
to a non-null value (even if a method has some other side effect),
declare the field as <a href="../api/org/checkerframework/checker/nullness/qual/MonotonicNonNull.html"><span style="font-family:monospace">@MonotonicNonNull</span></a>:<pre class="verbatim">  @MonotonicNonNull Object myField;
</pre></li><li class="li-enumerate">If <span style="font-family:monospace">computeValue</span> sets <span style="font-family:monospace">myField</span> to a non-null value (or maintains it
as a non-null value), declare the method as
<a href="../api/org/checkerframework/checker/nullness/qual/EnsuresNonNull.html"><span style="font-family:monospace">@EnsuresNonNull</span></a>:<pre class="verbatim">  @EnsuresNonNull("myField")
  int computeValue() { ... }
</pre><p>If <span style="font-family:monospace">computeValue</span> maintains <span style="font-family:monospace">myField</span> as a non-null value, even if it
might have other side effects and even if other methods might set
<span style="font-family:monospace">myField</span> to <span style="font-family:monospace">null</span>, declare it as</p><pre class="verbatim">  @RequiresNonNull("myField")
  @EnsuresNonNull("myField")
  int computeValue() { ... }
</pre></li></ol><p>There are two other ways to suppress the warning:</p><ul class="itemize"><li class="li-itemize">
Put the expression in a local variable before the invocation. A method
call never affects the value of a local variable.
</li><li class="li-itemize">If the warning is about an argument (including the receiver) to a
method <span style="font-family:monospace">foo()</span>, then instead of declaring <span style="font-family:monospace">foo()</span> as
<span style="font-family:monospace">@SideEffectFree</span>, you can unsoundly not use the
<span style="font-family:monospace">-AconservativeArgumentNullnessAfterInvocation</span> command-line argument; see
Section ‍<a href="#nullness-lint">3.1.1</a>.
</li></ul>
<!--TOC subsubsection id="type-refinement-determinism" Deterministic methods-->
<h4 id="type-refinement-determinism" class="subsubsection">Deterministic methods <a href="#type-refinement-determinism"><img src="chainlink.svg" width="10" height="10"></a></h4><!--SEC END --><p>Consider the following declaration and uses:</p><pre class="verbatim">  @Nullable Object getField(Object arg) { ... }

  void m() {
    ...
    if (x.getField(y) != null) {
      x.getField(y).toString(); // warning: possible null pointer exception
    }
  }
</pre><p>The Nullness Checker issues a warning regarding the
<span style="font-family:monospace">toString()</span> call, because its receiver <span style="font-family:monospace">x.getField(y)</span> might
be <span style="font-family:monospace">null</span>, according to the <span style="font-family:monospace">@Nullable</span> return type in the
declaration of <span style="font-family:monospace">getField</span>. The Nullness Checker cannot assume that
<span style="font-family:monospace">getField</span> returns non-null on the second call, just based on the fact
that it returned non-null on the first call.</p><p>To indicate that a method returns the same value each time it is called on
the same arguments, use the <a href="../api/org/checkerframework/dataflow/qual/Deterministic.html"><span style="font-family:monospace">@Deterministic</span></a> annotation.
Actually, it is necessary to use <a href="../api/org/checkerframework/dataflow/qual/Pure.html"><span style="font-family:monospace">@Pure</span></a> which
means both <span style="font-family:monospace">@Deterministic</span> and <span style="font-family:monospace">@SideEffectFree</span>, because otherwise the
first call might change a value that the method depends on.</p><p>If you change the declaration of <span style="font-family:monospace">getField</span> to</p><pre class="verbatim">  @Pure
  @Nullable Object getField(Object arg) { ... }
</pre><p>then the Nullness Checker issues no warnings.
Because <span style="font-family:monospace">getField</span> is <span style="font-family:monospace">@SideEffectFree</span>, the values of <span style="font-family:monospace">x</span> and <span style="font-family:monospace">y</span> are the
same at both invocations.
Because <span style="font-family:monospace">getField</span> is <span style="font-family:monospace">@Deterministic</span>, the two invocations of
<span style="font-family:monospace">x.getField(y)</span> have the same value.
Therefore, <span style="font-family:monospace">x.getField(y)</span> is non-null within the <span style="font-family:monospace">then</span> branch
of the <span style="font-family:monospace">if</span> statement.</p>
<!--TOC subsection id="type-refinement-assertions" Assertions-->
<h3 id="type-refinement-assertions" class="subsection">31.7.6 Assertions <a href="#type-refinement-assertions"><img src="chainlink.svg" width="10" height="10"></a></h3><!--SEC END --><p>If your code contains an <span style="font-family:monospace">assert</span> statement, then your code could behave
in two different ways at run time, depending on whether assertions are
enabled or disabled
via the <span style="font-family:monospace">-ea</span> or <span style="font-family:monospace">-da</span> command-line options to java.</p><p>By default, the Checker Framework outputs warnings about any error that
could happen at run time, whether assertions are enabled or disabled.</p><p>If you supply the <span style="font-family:monospace">-AassumeAssertionsAreEnabled</span> command-line option, then
the Checker Framework assumes assertions are enabled. If you supply the
<span style="font-family:monospace">-AassumeAssertionsAreDisabled</span> command-line option, then the Checker
Framework assumes assertions are disabled. You may not supply both
command-line options. It is uncommon to supply either one.</p><p>These command-line arguments have no effect on processing of <span style="font-family:monospace">assert</span>
statements whose message contains the text <span style="font-family:monospace">@AssumeAssertion</span>; see
Section ‍<a href="#assumeassertion">32.2</a>.</p>
<!--TOC section id="java-expressions-as-arguments" Writing Java expressions as annotation arguments-->
<h2 id="java-expressions-as-arguments" class="section">31.8 Writing Java expressions as annotation arguments <a href="#java-expressions-as-arguments"><img src="chainlink.svg" width="10" height="10"></a></h2><!--SEC END --><p>Sometimes, it is necessary to write a Java expression as the argument to an
annotation. The annotations that take a Java
expression as an argument include:</p><ul class="itemize"><li class="li-itemize">
<a href="../api/org/checkerframework/framework/qual/RequiresQualifier.html"><span style="font-family:monospace">@RequiresQualifier</span></a>
</li><li class="li-itemize"><a href="../api/org/checkerframework/framework/qual/EnsuresQualifier.html"><span style="font-family:monospace">@EnsuresQualifier</span></a>
</li><li class="li-itemize"><a href="../api/org/checkerframework/framework/qual/EnsuresQualifierIf.html"><span style="font-family:monospace">@EnsuresQualifierIf</span></a>
</li><li class="li-itemize"><a href="../api/org/checkerframework/checker/nullness/qual/RequiresNonNull.html"><span style="font-family:monospace">@RequiresNonNull</span></a>
</li><li class="li-itemize"><a href="../api/org/checkerframework/checker/nullness/qual/EnsuresNonNull.html"><span style="font-family:monospace">@EnsuresNonNull</span></a>
</li><li class="li-itemize"><a href="../api/org/checkerframework/checker/nullness/qual/EnsuresNonNullIf.html"><span style="font-family:monospace">@EnsuresNonNullIf</span></a>
</li><li class="li-itemize"><a href="../api/org/checkerframework/checker/nullness/qual/KeyFor.html"><span style="font-family:monospace">@KeyFor</span></a>
</li><li class="li-itemize"><a href="../api/org/checkerframework/checker/nullness/qual/EnsuresKeyFor.html"><span style="font-family:monospace">@EnsuresKeyFor</span></a>
</li><li class="li-itemize"><a href="../api/org/checkerframework/checker/nullness/qual/EnsuresKeyForIf.html"><span style="font-family:monospace">@EnsuresKeyForIf</span></a>
</li><li class="li-itemize"><a href="../api/org/checkerframework/checker/i18nformatter/qual/I18nFormatFor.html"><span style="font-family:monospace">@I18nFormatFor</span></a>
</li><li class="li-itemize"><a href="../api/org/checkerframework/checker/lock/qual/EnsuresLockHeld.html"><span style="font-family:monospace">@EnsuresLockHeld</span></a>
</li><li class="li-itemize"><a href="../api/org/checkerframework/checker/lock/qual/EnsuresLockHeldIf.html"><span style="font-family:monospace">@EnsuresLockHeldIf</span></a>
</li><li class="li-itemize"><a href="../api/org/checkerframework/checker/lock/qual/GuardedBy.html"><span style="font-family:monospace">@GuardedBy</span></a>
</li><li class="li-itemize"><a href="../api/org/checkerframework/checker/lock/qual/Holding.html"><span style="font-family:monospace">@Holding</span></a>
</li></ul><p>The set of permitted expressions is a subset of all Java expressions,
with a few extensions.
The extensions are formal parameters like <span style="font-family:monospace">#1</span> and (for some type
systems) <span style="font-family:monospace">&lt;self&gt;</span>.</p><ul class="itemize"><li class="li-itemize">
<span style="font-family:monospace">this</span>, the receiver object. You can write <span style="font-family:monospace">this</span> to annotate any
variable or declaration where you could write <span style="font-family:monospace">this</span> in code.
Notably, it cannot be used in annotations on declarations of
static fields or methods. For a field, <span style="font-family:monospace">this</span> is the field’s
receiver (sometimes called its container). For a local variable, it is the
method’s receiver.</li><li class="li-itemize"><span style="font-family:monospace">super</span>, the receiver object as seen from the superclass. This can be used
to refer to fields shadowed in the subclass (although shadowing fields is
discouraged in Java).</li><li class="li-itemize"><span style="font-family:monospace">&lt;self&gt;</span>, the value of the annotated reference (non-primitive) variable.
Currently only defined for the <span style="font-family:monospace">@GuardedBy</span> type system.
For example, <span style="font-family:monospace">@GuardedBy("&lt;self&gt;") Object o</span> indicates that the value
referenced by <span style="font-family:monospace">o</span> is guarded by the intrinsic (monitor) lock of the value
referenced by <span style="font-family:monospace">o</span>.</li><li class="li-itemize">a formal parameter, e.g., <span style="font-family:monospace">#2</span>. It is represented as <span style="font-family:monospace">#</span> followed by the <span style="font-weight:bold">one-based</span> parameter
index. For example: <span style="font-family:monospace">#1</span>, <span style="font-family:monospace">#3</span>. It is not permitted to write <span style="font-family:monospace">#0</span> to
refer to the receiver object; use <span style="font-family:monospace">this</span> instead.<p>The formal parameter syntax <span style="font-family:monospace">#1</span> is less natural in source code
than writing the formal parameter name. This syntax is necessary for
separate compilation, because no formal parameter name information is
available in a <span style="font-family:monospace">.class</span> file. Suppose an annotated method <span style="font-family:monospace">m</span> has
already been compiled into a <span style="font-family:monospace">.class</span> file, perhaps by a compilation
that did not use the Checker Framework. When a client of <span style="font-family:monospace">m</span> is later
compiled, it cannot interpret a formal parameter name, but it can
interpret a number.</p><p>Within a method <em>body</em>, you may use the formal parameter name. The
formal parameter name never works within a method <em>signature</em> or for
a contract (pre- or post-condition) annotation; in those locations, an
identifier is interpreted as a field name (not a formal parameter).</p></li><li class="li-itemize">a local variable, e.g., <span style="font-family:monospace">myLocalVar</span>.
The variable must be in scope; for example, a method annotation on method
<span style="font-family:monospace">m</span> cannot mention a local variable that is declared inside <span style="font-family:monospace">m</span>.</li><li class="li-itemize">a static variable, e.g., <span style="font-family:monospace">System.out</span>.
Write the class name and the variable.</li><li class="li-itemize">a field of any expression. For example: <span style="font-family:monospace">next</span>,
<span style="font-family:monospace">this.next</span>, <span style="font-family:monospace">#1.next</span>. You may optionally omit a leading “<span style="font-family:monospace">this.</span>”, just as in Java. Thus,
<span style="font-family:monospace">this.next</span> and <span style="font-family:monospace">next</span> are equivalent.</li><li class="li-itemize">an array access. For example: <span style="font-family:monospace">this.myArray[i]</span>, <span style="font-family:monospace">vals[#1]</span>.</li><li class="li-itemize">an array creation. For example: <span style="font-family:monospace">new int[10]</span>, <span style="font-family:monospace">new String[] </span><span style="font-family:monospace">"a", "b"</span>.</li><li class="li-itemize">literals: string, integer, char, long, float, double, null, class literals.</li><li class="li-itemize">a method invocation on any expression.
This even works for overloaded methods and methods with type parameters.
For example:
<span style="font-family:monospace">m1(x, y.z, #2)</span>, <span style="font-family:monospace">a.m2("hello")</span>.<p>Currently, the Checker Framework cannot prove all contracts about method
calls, so you may need to suppress some warnings.</p><p>One unusual feature of the Checker Framework’s Java expressions is that a
method call is allowed to have side effects. Other tools forbid methods
with side effects (and doing so is necessary if a specification is going
to be checked at run time via assertions). The Checker Framework enables
you to state more facts. For example, consider the annotation on
<span style="font-family:monospace">java.io.BufferedReader.ready()</span>:</p><pre class="verbatim">  @EnsuresNonNullIf(expression="readLine()", result=true)
  @Pure public boolean ready() throws IOException { ... }
</pre><p>This states that if <span style="font-family:monospace">readLine()</span> is called immediately after <span style="font-family:monospace">ready()</span>
returns true, then <span style="font-family:monospace">readLine()</span> returns a non-null value.</p></li><li class="li-itemize">a binary expression, e.g., <span style="font-family:monospace">x + y</span> or &lt;#1 - 1&gt;. These are used by
the Index Checker, for example.</li><li class="li-itemize">a class name expression within another expression, e.g., “String”
in <span style="font-family:monospace">String.class</span> or “pkg.MyClass” in <span style="font-family:monospace">pkg.MyClass.staticField</span>. The
class name must be fully-qualified unless it can be referenced by its
simple name without an <span style="font-family:monospace">import</span> statement at the location where the
annotation appears. For example, an annotation in class <span style="font-family:monospace">C</span> can use the
simple name of a class in <span style="font-family:monospace">java.lang</span> or in the same package as <span style="font-family:monospace">C</span>.</li></ul><p><span style="font-weight:bold">Limitations:</span>
It is not possible to write a
quantification over all array components (e.g., to express that all
array elements are non-null). There is no such Java expression, but it
would be useful when writing specifications.</p>
<!--TOC section id="field-invariants" Field invariants-->
<h2 id="field-invariants" class="section">31.9 Field invariants <a href="#field-invariants"><img src="chainlink.svg" width="10" height="10"></a></h2><!--SEC END --><p>Sometimes a field declared in a superclass has a more precise type in a
subclass. To express this fact, write
<a href="../api/org/checkerframework/framework/qual/FieldInvariant.html"><span style="font-family:monospace">@FieldInvariant</span></a> on the subclass. It specifies
the field’s type in the class on which this annotation is written.
The field must be declared in a superclass and
must be final.</p><p>For example,
</p><pre class="verbatim">class Person {
  final @Nullable String nickname;
  public Person(@Nullable String nickname) {
    this.nickname = nickname;
  }
}

// A rapper always has a nickname.
@FieldInvariant(qualifier = NonNull.class, field = "nickname")
class Rapper extends Person {
  public Rapper(String nickname) {
    super(nickname);
  }
  void method() {
    ... nickname.length() ...   // legal, nickname is non-null in this class.
  }
}
</pre><p>
A field invariant annotation can refer to more than one field. For example,
<span style="font-family:monospace">@FieldInvariant(qualifier = NonNull.class, field = {fieldA, fieldB})</span> means
that <span style="font-family:monospace">fieldA</span> and <span style="font-family:monospace">fieldB</span> are both non-null in the class upon which the
annotation is written. A field invariant annotation
can also apply different qualifiers to different fields. For example,
<span style="font-family:monospace">@FieldInvariant(qualifier = {NonNull.class, Untainted.class}, field =
{fieldA, fieldB})</span> means that <span style="font-family:monospace">fieldA</span> is non-null and <span style="font-family:monospace">fieldB</span> is untainted.</p><p>This annotation is inherited: if a superclass is annotated with
<span style="font-family:monospace">@FieldInvariant</span>, its subclasses have the same annotation. If a subclass has its
own <span style="font-family:monospace">@FieldInvariant</span>, then it must include the fields in the superclass
annotation and those fields’ annotations must be a subtype (or equal) to the
annotations for those fields in the superclass <span style="font-family:monospace">@FieldInvariant</span>.</p><p>Currently, the <span style="font-family:monospace">@FieldInvariant</span> annotation is trusted rather than
checked. In other words, the <span style="font-family:monospace">@FieldInvariant</span> annotation introduces a
loophole in the type system, which requires verification by other means
such as manual examination.</p>
<!--TOC section id="unused-fields" Unused fields-->
<h2 id="unused-fields" class="section">31.10 Unused fields <a href="#unused-fields"><img src="chainlink.svg" width="10" height="10"></a></h2><!--SEC END --><p>In an inheritance hierarchy, subclasses often introduce new methods and
fields. For example, a <span style="font-family:monospace">Marsupial</span> (and its subclasses such as
<span style="font-family:monospace">Kangaroo</span>) might have a variable <span style="font-family:monospace">pouchSize</span> indicating the size of the animal’s
pouch. The field does not exist in superclasses such as
<span style="font-family:monospace">Mammal</span> and <span style="font-family:monospace">Animal</span>, so Java issues a compile-time
error if a program tries to access <span style="font-family:monospace">myMammal.pouchSize</span>.</p><p>If you cannot use subtypes in your program, you can enforce similar
requirements using type qualifiers.
For fields, use the <span style="font-family:monospace">@Unused</span> annotation (Section ‍<a href="#unused-annotation">31.10.1</a>), which enforces that a field or method may only
be accessed from a receiver expression with a given annotation (or one of
its subtypes).
For methods, annotate the receiver parameter <span style="font-family:monospace">this</span>; then a method call
type-checks only if the actual receiver is of the specified type.</p><p>Also see the discussion of typestate checkers, in
Chapter ‍<a href="#typestate-checker">29.30</a>.</p>
<!--TOC subsection id="unused-annotation" <span style="font-family:monospace">@Unused</span> annotation-->
<h3 id="unused-annotation" class="subsection">31.10.1 <span style="font-family:monospace">@Unused</span> annotation <a href="#unused-annotation"><img src="chainlink.svg" width="10" height="10"></a></h3><!--SEC END --><p>A Java subtype can have more fields than its supertype. For example:</p><pre class="verbatim">class Animal {}
class Mammal extends Animal { ... }
class Marsupial extends Mammal {
  int pouchSize;  // pouch capacity, in cubic centimeters
  ...
}
</pre><p>You can simulate
the same effect for type qualifiers:
the <a href="../api/org/checkerframework/framework/qual/Unused.html"><span style="font-family:monospace">@Unused</span></a> annotation
on a field declares that the field may <em>not</em> be accessed via a receiver of
the given qualified type (or any <em>super</em>type).
For example:</p><pre class="verbatim">class Animal {
  @Unused(when=Mammal.class)
  int pouchSize;  // pouch capacity, in cubic centimeters
  ...
}
@interface Mammal {}
@interface Marsupial {}

@Marsupial Animal joey = ...;
... joey.pouchSize ...    // OK
@Mammal Animal mae = ...;
... mae.pouchSize ...    // compile-time error
</pre><p>The above class declaration is like writing</p><pre class="verbatim">class @Mammal-Animal { ... }
class @Marsupial-Animal {
  int pouchSize;  // pouch capacity, in cubic centimeters
  ...
}
</pre><hr>
<!--TOC chapter id="suppressing-warnings" Suppressing warnings-->
<h1 id="suppressing-warnings" class="chapter">Chapter ‍32 Suppressing warnings <a href="#suppressing-warnings"><img src="chainlink.svg" width="10" height="10"></a></h1><!--SEC END --><p>When the Checker Framework reports a warning, it’s best to fix the
underlying problem, by changing the code or its annotations. For each
warning, follow the methodology in Section ‍<a href="#handling-warnings">2.4.5</a> to
correct the underlying problem.</p><p>This section describes what to do if the methodology of
Section ‍<a href="#handling-warnings">2.4.5</a> indicates that you need to suppress the
warning. You won’t change your code, but you will prevent the Checker
Framework from reporting this particular warning to you. (Changing the
code to fix a bug is another way to prevent the Checker Framework from
issuing a warning, but it is not what this chapter is about.)</p><p>You may wish to suppress checker warnings because of unannotated libraries
or un-annotated portions of your own code, because of application
invariants that are beyond the capabilities of the type system, because of
checker limitations, because you are interested in only some of the
guarantees provided by a checker, or for other reasons.
Suppressing a warning is similar to writing a cast in a Java
program: the programmer knows more about the type than the type system does
and uses the warning suppression or cast to convey that information to the
type system.</p><p>You can suppress a warning message in a single variable initializer,
method, or class by using the following mechanisms:</p><ul class="itemize"><li class="li-itemize">
the <span style="font-family:monospace">@SuppressWarnings</span> annotation
(Section ‍<a href="#suppresswarnings-annotation">32.1</a>), or
</li><li class="li-itemize">the <span style="font-family:monospace">@AssumeAssertion</span> string in an <span style="font-family:monospace">assert</span> message (Section ‍<a href="#assumeassertion">32.2</a>).
</li></ul><p>You can suppress warnings throughout the codebase by using the following mechanisms:</p><ul class="itemize"><li class="li-itemize">
the <span style="font-family:monospace">-AsuppressWarnings</span> command-line option (Section ‍<a href="#suppresswarnings-command-line">32.3</a>),
</li><li class="li-itemize">the <span style="font-family:monospace">-AskipUses</span> and <span style="font-family:monospace">-AonlyUses</span> command-line options (Section ‍<a href="#askipuses">32.4</a>),
</li><li class="li-itemize">the <span style="font-family:monospace">-AskipDefs</span> and <span style="font-family:monospace">-AonlyDefs</span> command-line options (Section ‍<a href="#askipdefs">32.5</a>),
</li><li class="li-itemize">the <span style="font-family:monospace">-AuseConservativeDefaultsForUncheckedCode=source</span> command-line
option (Section ‍<a href="#compiling-libraries">34.4</a>),
</li><li class="li-itemize">the <span style="font-family:monospace">-Alint</span> command-line option enables/disables optional checks (Section ‍<a href="#alint">32.6</a>),
</li><li class="li-itemize">changing the specification of a method (Section ‍<a href="#suppressing-warnings-stub">32.7</a>), or
</li><li class="li-itemize">not running the annotation processor
(Section ‍<a href="#no-processor">32.8</a>).
</li></ul><p>Some type checkers can suppress warnings via
</p><ul class="itemize"><li class="li-itemize">
checker-specific mechanisms (Section ‍<a href="#checker-specific-suppression">32.9</a>).
</li></ul><p>The rest of this chapter explains these mechanisms in turn.</p><p>You can use the <span style="font-family:monospace">-AwarnUnneededSuppressions</span> command-line option to issue a
warning if a <span style="font-family:monospace">@SuppressWarnings</span> did not suppress any warnings issued by the current checker.</p>
<!--TOC section id="suppresswarnings-annotation" <span style="font-family:monospace">@SuppressWarnings</span> annotation-->
<h2 id="suppresswarnings-annotation" class="section">32.1 <span style="font-family:monospace">@SuppressWarnings</span> annotation <a href="#suppresswarnings-annotation"><img src="chainlink.svg" width="10" height="10"></a></h2><!--SEC END --><p>
You can suppress specific errors and warnings by use of the
<span style="font-family:monospace">@SuppressWarnings</span> annotation, for example
<span style="font-family:monospace">@SuppressWarnings("interning")</span> or <span style="font-family:monospace">@SuppressWarnings("nullness")</span>.
Section ‍<a href="#suppresswarnings-annotation-syntax">32.1.1</a> explains the syntax of the
argument string.
</p><p>A <a href="https://docs.oracle.com/en/java/javase/17/docs/api/java.base/java/lang/SuppressWarnings.html"><span style="font-family:monospace">@SuppressWarnings</span></a>
annotation may be placed on program declarations such as a local
variable declaration, a method, or a class. It suppresses all warnings
within that program element.
Section ‍<a href="#suppresswarnings-annotation-locations">32.1.2</a> discusses where the
annotation may be written in source code.</p><p>Section ‍<a href="#suppresswarnings-best-practices">32.1.3</a> gives best practices for
writing <span style="font-family:monospace">@SuppressWarnings</span> annotations.</p>
<!--TOC subsection id="suppresswarnings-annotation-syntax" <span style="font-family:monospace">@SuppressWarnings</span> syntax-->
<h3 id="suppresswarnings-annotation-syntax" class="subsection">32.1.1 <span style="font-family:monospace">@SuppressWarnings</span> syntax <a href="#suppresswarnings-annotation-syntax"><img src="chainlink.svg" width="10" height="10"></a></h3><!--SEC END --><p>The <span style="font-family:monospace">@SuppressWarnings</span> annotation takes a string argument, in one of
the following forms:
<span style="font-family:monospace">"</span><span style="font-family:monospace"><em>checkername</em></span><span style="font-family:monospace">:</span><span style="font-family:monospace"><em>messagekey</em></span><span style="font-family:monospace">"</span>,
<span style="font-family:monospace">"</span><span style="font-family:monospace"><em>checkername</em></span><span style="font-family:monospace">"</span>,
or
<span style="font-family:monospace">"</span><span style="font-family:monospace"><em>messagekey</em></span><span style="font-family:monospace">"</span>.</p><p>The argument <em>checkername</em> is the checker name, without “Checker”.
It is lower case by default, though a checker can choose a different casing.
For
example, if you invoke a checker as
<span style="font-family:monospace">javac -processor MyNiftyChecker ...</span>,
then you would suppress its error messages with
<span style="font-family:monospace">@SuppressWarnings("mynifty")</span>. (An exception is the Subtyping
Checker, for which you use the annotation name; see
Section ‍<a href="#subtyping-using">28.1</a>.)
Sometimes, a checker honors multiple <em>checkername</em> arguments; use
the <span style="font-family:monospace">-AshowSuppressWarningsStrings</span> command-line option to see them.</p><p>The argument <em>messagekey</em> is the message key for the error.
Each warning message from the compiler gives the most specific
suppression string that can be used to suppress that warning.
An example is “<span style="font-family:monospace">dereference.of.nullable</span>” in</p><pre class="verbatim">MyFile.java:107: error: [dereference.of.nullable] dereference of possibly-null reference myList
          myList.add(elt);
          ^
</pre><p>You are allowed to use any substring of a message key, so long as the
substring extends at each end to a period or an end of the key. For
example, to suppress a warning with message key
<span style="font-family:monospace">"assignment.type.incompatible"</span>, you could use
<span style="font-family:monospace">@SuppressWarnings("assignment")</span>,
<span style="font-family:monospace">@SuppressWarnings("assignment.type")</span>,
<span style="font-family:monospace">@SuppressWarnings("type.incompatible")</span>, or other variants.
We recommend using
the longest possible message key; a short message might suppress more
warnings than you expect.</p><p>The checkername <span style="font-family:monospace">"allcheckers"</span> means all checkers. Using this is not
recommended, except for messages common to all checkers such as
purity-related messages when using <span style="font-family:monospace">-AcheckPurityAnnotations</span>. If you use
<span style="font-family:monospace">"allcheckers"</span>, you run some checker that does not issue any warnings,
and you suply the <span style="font-family:monospace">-AwarnUnneededSuppressions</span> command-line argument, then
the Checker Framework will issue an <span style="font-family:monospace">unneeded.suppression</span>
warning.</p><p>The special messagekey “<span style="font-family:monospace">all</span>” means to suppress all warnings.</p><p>If the <em>checkername</em> part is omitted, the <span style="font-family:monospace">@SuppressWarnings</span> applies
to all checkers.
If the <em>messagekey</em> part is omitted, the <span style="font-family:monospace">@SuppressWarnings</span> applies
to all messages (it suppresses all warnings from the given checker).</p><p>With the <span style="font-family:monospace">-ArequirePrefixInWarningSuppressions</span> command-line
option, the Checker Framework only suppresses warnings when the string is in
the <span style="font-family:monospace">"</span><span style="font-family:monospace"><em>checkername</em></span><span style="font-family:monospace">"</span> or <span style="font-family:monospace">"</span><span style="font-family:monospace"><em>checkername</em></span><span style="font-family:monospace">:</span><span style="font-family:monospace"><em>messagekey</em></span><span style="font-family:monospace">"</span>
format, as in
<span style="font-family:monospace">@SuppressWarnings("nullness")</span> or
<span style="font-family:monospace">@SuppressWarnings("nullness:assignment.type.incompatible")</span>.
For example, <span style="font-family:monospace">@SuppressWarnings("assignment.type.incompatible")</span> and
<span style="font-family:monospace">@SuppressWarnings("all")</span> have no effect (they are ignored) when
<span style="font-family:monospace">-ArequirePrefixInWarningSuppressions</span> is used. You can use
<span style="font-family:monospace">@SuppressWarnings("allcheckers")</span> to suppress all Checker Framework
warnings.</p>
<!--TOC subsection id="suppresswarnings-annotation-locations" Where <span style="font-family:monospace">@SuppressWarnings</span> can be written-->
<h3 id="suppresswarnings-annotation-locations" class="subsection">32.1.2 Where <span style="font-family:monospace">@SuppressWarnings</span> can be written <a href="#suppresswarnings-annotation-locations"><img src="chainlink.svg" width="10" height="10"></a></h3><!--SEC END --><p><span style="font-family:monospace">@SuppressWarnings</span> is a declaration annotation, so it may be placed on
program declarations such as a local variable declaration, a method, or a
class.</p><p><span style="font-family:monospace">@SuppressWarnings</span> cannot be used on <span style="font-weight:bold">statements, expressions, or types</span>.
To work around this, you can
</p><ul class="itemize"><li class="li-itemize">
extract an expression into a local variable
and suppress a warning on its declaration,
</li><li class="li-itemize">write <span style="font-family:monospace">assert</span> plus <span style="font-family:monospace">@AssumeAssertion</span> between statements; it can
affect arbitrary expressions (see Section ‍<a href="#assumeassertion">32.2</a>), or
</li><li class="li-itemize">use a type-system-specific method call, such as
<a href="../api/org/checkerframework/checker/nullness/util/NullnessUtil.html#castNonNull(T)"><span style="font-family:monospace">NullnessUtil.castNonNull</span></a>.
</li></ul><p>Always write a <span style="font-family:monospace">@SuppressWarnings</span> annotation on the <span style="font-weight:bold">smallest possible
scope</span>. To reduce the scope of a <span style="font-family:monospace">@SuppressWarnings</span> annotation, it is
sometimes desirable to refactor the code. You might extract an expression
into a local variable, so that warnings can be suppressed just for that
local variable’s initializer expression. Likewise, you might extract some
code into a separate method, so that warnings can be suppressed just for
its body. Or, you can use <span style="font-family:monospace">@AssumeAssertion</span> on an <span style="font-family:monospace">assert</span> statement;
see Section ‍<a href="#assumeassertion">32.2</a>.</p><p>As an example, consider suppressing a warning at an assignment that you know is
safe. Here is an example that uses the Tainting Checker
(Section ‍<a href="#tainting-checker">10</a>). Assume that <span style="font-family:monospace">expr</span> has compile-time
(declared) type <span style="font-family:monospace">@Tainted String</span>, but you know that the run-time value of
<span style="font-family:monospace">expr</span> is untainted.</p><pre class="verbatim">  @SuppressWarnings("tainting:cast.unsafe") // expr is untainted because ... [explanation goes here]
  @Untainted String myvar = expr;
</pre><p>Java does not permit annotations (such as <span style="font-family:monospace">@SuppressWarnings</span>) on
assignments (or on other statements or expressions), so
it would have been <em>illegal</em> to write</p><pre class="verbatim">  @Untainted String myvar;
  ...
  @SuppressWarnings("tainting:cast.unsafe") // expr is untainted because ...
  myvar = expr;
</pre>
<!--TOC subsection id="suppresswarnings-best-practices" Good practices when suppressing warnings-->
<h3 id="suppresswarnings-best-practices" class="subsection">32.1.3 Good practices when suppressing warnings <a href="#suppresswarnings-best-practices"><img src="chainlink.svg" width="10" height="10"></a></h3><!--SEC END -->
<!--TOC subsubsection id="suppresswarnings-best-practices-smallest-scope" Suppress warnings in the smallest possible scope-->
<h4 id="suppresswarnings-best-practices-smallest-scope" class="subsubsection">Suppress warnings in the smallest possible scope <a href="#suppresswarnings-best-practices-smallest-scope"><img src="chainlink.svg" width="10" height="10"></a></h4><!--SEC END --><p>Prefer <span style="font-family:monospace">@SuppressWarnings</span> on a local variable declaration to one on a method, and
prefer one on a method to one on a class.
<span style="font-family:monospace">@SuppressWarnings</span> on a local variable declaration applies only to the
declaration (including its initializer if any), not to all uses of the variable.</p><p>You may be able to suppress a warning about a use of an expression by
writing <span style="font-family:monospace">@AssumeAssertion</span> for the expression, before the use. See
Section ‍<a href="#assumeassertion">32.2</a>.</p><p>Another way to reduce the scope of a <span style="font-family:monospace">@SuppressWarnings</span> is to
extract the expression into a new local variable
and place a <span style="font-family:monospace">@SuppressWarnings</span> annotation on the variable
declaration. See Section ‍<a href="#suppresswarnings-annotation-locations">32.1.2</a>.</p>
<!--TOC subsubsection id="suppresswarnings-best-practices-specific-argument" Use a specific argument to <span style="font-family:monospace">@SuppressWarnings</span>-->
<h4 id="suppresswarnings-best-practices-specific-argument" class="subsubsection">Use a specific argument to <span style="font-family:monospace">@SuppressWarnings</span> <a href="#suppresswarnings-best-practices-specific-argument"><img src="chainlink.svg" width="10" height="10"></a></h4><!--SEC END --><p><a id="compiler-message-keys"></a></p><p>It is best to use the most specific possible message key to suppress just a
specific error that you know to be a false positive. The checker outputs
this message key when it issues an error. If you use a broader
<span style="font-family:monospace">@SuppressWarnings</span> annotation, then it may mask other errors that you
needed to know about.</p><p>Any of the following would have suppressed the warning in
Section ‍<a href="#suppresswarnings-annotation-locations">32.1.2</a>:</p><pre class="verbatim">  @SuppressWarnings("tainting")              // suppresses all tainting-related warnings
  @SuppressWarnings("cast")                  // suppresses warnings from all checkers about casts
  @SuppressWarnings("unsafe")                // suppresses warnings from all checkers about unsafe code
  @SuppressWarnings("cast.unsafe")           // suppresses warnings from all checkers about unsafe casts
  @SuppressWarnings("tainting:cast")         // suppresses tainting warnings about casts
  @SuppressWarnings("tainting:unsafe")       // suppresses tainting warnings about unsafe code
  @SuppressWarnings("tainting:cast.unsafe")  // suppresses tainting warnings about unsafe casts
</pre><p>The last one is the most specific, and therefore is the best style.</p>
<!--TOC subsubsection id="suppresswarnings-best-practices-justification" Justify why the warning is a false positive-->
<h4 id="suppresswarnings-best-practices-justification" class="subsubsection">Justify why the warning is a false positive <a href="#suppresswarnings-best-practices-justification"><img src="chainlink.svg" width="10" height="10"></a></h4><!--SEC END --><p>A <span style="font-family:monospace">@SuppressWarnings</span> annotation asserts that the programmer knows that
the code is actually correct or safe (that is, no undesired behavior will
occur), even though the type system is unable to prove that the code is
correct or safe.</p><p>Whenever you write a <span style="font-family:monospace">@SuppressWarnings</span> annotation, you should also
write, typically on the same line, a code comment
explaining why the code is actually correct. In some cases you might also
justify why the code cannot be rewritten in a simpler way that would be
amenable to type-checking. Also make it clear what error is being
suppressed. (This is particularly important when the <span style="font-family:monospace">@SuppressWarnings</span> is
on a method declaration and the suppressed warning might be anywhere in the
method body.)</p><p>This documentation will help you and others to understand the reason for
the <span style="font-family:monospace">@SuppressWarnings</span> annotation. It will also help you audit your code
to verify all the warning suppressions. (The code is correct only if the
checker issues no warnings <em>and</em> each <span style="font-family:monospace">@SuppressWarnings</span> is correct.)</p><p>A suppression message like “a.f is not null” is not useful. The fact
that you are suppressing the warning means that you believe that <span style="font-family:monospace">a.f</span> is
not null. The message should explain <em>why</em> you believe that; for
example, “a.f was checked above and no subsequent side effect can affect it”.</p><p>Here are some terse examples from libraries in <a href="https://github.com/plume-lib/">plume-lib</a>:</p><pre class="verbatim">@SuppressWarnings("cast") // cast is redundant (except when checking nullness)
@SuppressWarnings("interning") // FbType.FREE is interned but is not annotated
@SuppressWarnings("interning") // equality testing optimization
@SuppressWarnings("nullness") // used portion of array is non-null
@SuppressWarnings("nullness") // oi.factory is a static method, so null first argument is OK
@SuppressWarnings("purity") // side effect to local state of type BitSet
</pre><p>A particularly good (and concise) justification is to reference an issue in
the issue tracker, as in these two from <a href="https://plse.cs.washington.edu/daikon/">Daikon</a>:</p><pre class="verbatim">@SuppressWarnings("flowexpr.parse.error") // https://tinyurl.com/cfissue/862
@SuppressWarnings("keyfor") // https://tinyurl.com/cfissue/877
</pre><p>Please report false positive warnings, then reference them in your warning suppressions.
This permits the Checker Framework maintainers to know about the
problem, it helps them with prioritization (by knowing how often in your
codebase a particular issue arises), and it enables you to know when an
issue has been fixed (though the <span style="font-family:monospace">-AwarnUnneededSuppressions</span> command-line
option also serves the latter purpose).</p>
<!--TOC section id="assumeassertion" <span style="font-family:monospace">@AssumeAssertion</span> string in an <span style="font-family:monospace">assert</span> message-->
<h2 id="assumeassertion" class="section">32.2 <span style="font-family:monospace">@AssumeAssertion</span> string in an <span style="font-family:monospace">assert</span> message <a href="#assumeassertion"><img src="chainlink.svg" width="10" height="10"></a></h2><!--SEC END --><p>
Sometimes, it is too disruptive to refactor your code to create a location
where <span style="font-family:monospace">@SuppressWarnings</span> can be written. You can instead suppress a
warning by writing an assertion whose message contains the string
<span style="font-family:monospace">@AssumeAssertion(</span><span style="font-family:monospace"><em>checkername</em></span><span style="font-family:monospace">)</span>.
</p><p>For example, in this code:</p><pre class="verbatim">while (c != Object.class) {
  ...
  c = c.getSuperclass();
  assert c != null
    : "@AssumeAssertion(nullness): c was not Object, so its superclass is not null";
 }
</pre><p>the Nullness Checker assumes that <span style="font-family:monospace">c</span> is non-null from the <span style="font-family:monospace">assert</span>
statement forward (including on the next iteration through the loop).</p><p>The <span style="font-family:monospace">assert</span> expression must be an expression that would affect flow-sensitive
type refinement (Section ‍<a href="#type-refinement">31.7</a>), if the
expression appeared in a conditional test. Each type system has its own
rules about what type refinement it performs.</p><p>The value in parentheses is a checker name (typically lowercase),
exactly as in the <span style="font-family:monospace">@SuppressWarnings</span> annotation
(Section ‍<a href="#suppresswarnings-annotation-syntax">32.1.1</a>).
Any subcheckers will also assume that the
assertion is true (e.g., the Map Key Checker will assume that
the assertion in the example above cannot fail, when it runs
as a subchecker of the Nullness Checker).</p><p>The same good practices apply
as for <span style="font-family:monospace">@SuppressWarnings</span> annotations, such as writing a comment
justifying why the assumption is safe
(Section ‍<a href="#suppresswarnings-best-practices">32.1.3</a>).</p><p>The <span style="font-family:monospace">-AassumeAssertionsAreEnabled</span> and <span style="font-family:monospace">-AassumeAssertionsAreDisabled</span>
command-line options (Section ‍<a href="#type-refinement-assertions">31.7.6</a>) do not
affect processing of <span style="font-family:monospace">assert</span> statements that have <span style="font-family:monospace">@AssumeAssertion</span> in
their message. Writing <span style="font-family:monospace">@AssumeAssertion</span> means that the assertion would
succeed if it were executed, and the Checker Framework makes use of that
information regardless of the <span style="font-family:monospace">-AassumeAssertionsAreEnabled</span> and
<span style="font-family:monospace">-AassumeAssertionsAreDisabled</span> command-line options.</p>
<!--TOC subsection id="defensive-programming" Suppressing warnings and defensive programming-->
<h3 id="defensive-programming" class="subsection">32.2.1 Suppressing warnings and defensive programming <a href="#defensive-programming"><img src="chainlink.svg" width="10" height="10"></a></h3><!--SEC END --><p>This section explains the distinction between two different uses for
assertions: debugging a program (also known as defensive programming)
versus specifying a program. The examples use nullness annotations, but
the concepts apply to any checker.</p><p>The purpose of assertions is to aid debugging by throwing an exception
when a program does not work correctly. Sometimes, programmers use assertions for a
different purpose: documenting how
the program works. By default, the Checker Framework assumes that each assertion
is used for its primary purpose of debugging: the assertion might fail at run time, and the programmer
wishes to be informed at compile time about such possible run-time errors.</p><p>Suppose that a
programmer encounters a failing test, adds an assertion to aid debugging, and fixes the
test. The programmer leaves the assertion in the program if the programmer
is worried that the program might fail in a similar way in the future.
The Checker Framework should not assume that the assertion succeeds —
doing so would defeat the very purpose of the Checker Framework, which is
to detect errors at compile time and prevent them from occurring at run
time.</p><p>A non-standard use for annotations is to document facts that a programmer
has independently verified to be true. The Checker Framework can
leverage these assertions in order to avoid issuing false positive
warnings. The programmer marks such assertions with the <span style="font-family:monospace">@AssumeAssertion</span>
string in the <span style="font-family:monospace">assert</span> message (see Section ‍<a href="#assumeassertion">32.2</a>). Only
do so if you are sure that the assertion always succeeds at run time.</p><p><a id="assertion-methods"></a>
Methods such as
<a href="https://docs.oracle.com/en/java/javase/17/docs/api/java.base/java/util/Objects.html#requireNonNull(T)"><span style="font-family:monospace">Objects.requireNonNull</span></a>,
JUnit’s <span style="font-family:monospace">Assert.assertNotNull</span>, and
Guava’s <span style="font-family:monospace">verifyNotNull</span> and <span style="font-family:monospace">checkNotNull</span> are
similar to assertions. Just as for assertions, their intended use is as
debugging aids, they might fail at run time, and the Checker Framework
warns if that might happen.
Some programmers may use assert methods as documentation of facts
that the programmer has verified in some other manner.
If you know that a particular codebase always uses
an assertion method not for defensive programming but to indicate
facts that are guaranteed to be true (that is, these assertions cannot
fail at run time), then there are two approaches to avoid false positive
warnings: write specifications or suppress
warnings; see below for an explanation of each approach.</p><p>The method
<a href="../api/org/checkerframework/checker/nullness/util/NullnessUtil.html#castNonNull(T)"><span style="font-family:monospace">NullnessUtil.castNonNull</span></a> is not an
assertion method. It is a warning suppression method.</p><p>Note that some libraries have an imprecise/incorrect specification of their assertion
methods. For example, Guava’s <span style="font-family:monospace">Verify.verifyNotNull</span> is imprecisely/incorrectly
specified to have a <span style="font-family:monospace">@Nullable</span> formal parameter. In a correct execution,
<span style="font-family:monospace">null</span> never flows there, so its type can and should be annotated as
<span style="font-family:monospace">@NonNull</span>. That annotation allows the Nullness Checker to warn about
programs that crash due to passing <span style="font-family:monospace">null</span> to <span style="font-family:monospace">verifyNotNull</span>.
(A comment in Guava’s <span style="font-family:monospace">Preconditions.java</span> agrees with this reasoning:
“the first parameter to <span style="font-family:monospace">checkNotNull</span> <em>should</em> be annotated to
require it to be non-null.” The comment goes on to say “I had hoped to
take a principled stand on this” (that, is, write the annotation
<span style="font-family:monospace">@NonNull</span>), but Guava annotates it as <span style="font-family:monospace">@Nullable</span> to accommodate misuses
within the Google codebase.)</p><p>By default, the Checker Framework uses Guava’s annotations as written. If
you wish to take the principled stand in order to prevent <em>all</em>
<span style="font-family:monospace">NullPointerException</span>s, you can
use a different version of Guava with a small change to your build file. Where the
build file refers to Maven Central’s <span style="font-family:monospace">guava</span> artifact, change the group
name from “com.google.guava” to “org.checkerframework.annotatedlib”.
(The code is identical; the only difference is annotations.)</p>
<!--TOC paragraph id="specifications-based-on-assertion-methods" Option 1: Write specifications based on uses of assertion methods-->
<h5 id="specifications-based-on-assertion-methods" class="paragraph">Option 1: Write specifications based on uses of assertion methods <a href="#specifications-based-on-assertion-methods"><img src="chainlink.svg" width="10" height="10"></a></h5><!--SEC END --><p>
Suppose you are annotating a codebase that already contains precondition checks,
such as:</p><pre class="verbatim">  public String myGet(String key, String def) {
    checkNotNull(key, "key"); // NOI18N
    ...
  }
</pre><p>Because <span style="font-family:monospace">key</span> is non-null in every correct execution, its type should be
<span style="font-family:monospace">@NonNull</span> in <span style="font-family:monospace">myGet</span>’s signature. (<span style="font-family:monospace">@NonNull</span> is the default, so in
this case there is nothing to write.) The checker will not issue a warning
about the <span style="font-family:monospace">checkNotNull</span> call, but will issue a warning at incorrect calls
to <span style="font-family:monospace">myGet</span>.</p>
<!--TOC paragraph id="assert-method-suppress-warnings" Option 2: Suppress warnings at uses of assertion methods-->
<h5 id="assert-method-suppress-warnings" class="paragraph">Option 2: Suppress warnings at uses of assertion methods <a href="#assert-method-suppress-warnings"><img src="chainlink.svg" width="10" height="10"></a></h5><!--SEC END --><p>This section explains how to suppress warnings at all uses of an assertion
method. As with any warning suppression, you will compromise the checker’s
guarantee that your code is correct and will not fail at run time.</p><ul class="itemize"><li class="li-itemize">
If the method is defined in your source code, annotate its definition just as
<a href="../api/org/checkerframework/checker/nullness/util/NullnessUtil.html#castNonNull(T)"><span style="font-family:monospace">NullnessUtil.castNonNull</span></a> is
annotated; see its Javadoc or the source code for the Checker Framework.
Also, be sure to document the intention in the method’s Javadoc, so that
programmers do not
accidentally misuse it for defensive programming.
</li><li class="li-itemize">If the method is defined in an external library, write a stub file that
changes the method’s annotations, or use <span style="font-family:monospace">-AskipUses</span> to make the
Checker Framework ignore all calls to an entire class.<p>As a special case, if you want the Nullness Checker to prevent most null
pointer exceptions in your code, but to <em>permit</em> null pointer
exceptions at nullness assertion methods, you can pass
<span style="font-family:monospace">-Astubs=permit-nullness-assertion-exception.astub</span>.
</p></li></ul>
<!--TOC section id="suppresswarnings-command-line" <span style="font-family:monospace">-AsuppressWarnings</span> command-line option-->
<h2 id="suppresswarnings-command-line" class="section">32.3 <span style="font-family:monospace">-AsuppressWarnings</span> command-line option <a href="#suppresswarnings-command-line"><img src="chainlink.svg" width="10" height="10"></a></h2><!--SEC END --><p>Supplying the <span style="font-family:monospace">-AsuppressWarnings</span> command-line option is equivalent to
writing a <span style="font-family:monospace">@SuppressWarnings</span> annotation on every class that the compiler
type-checks. The argument to <span style="font-family:monospace">-AsuppressWarnings</span> is a comma-separated
list of warning suppression strings, as in
<span style="font-family:monospace">-AsuppressWarnings=purity,uninitialized</span>.</p><p>When possible, it is better to write a <span style="font-family:monospace">@SuppressWarnings</span> annotation with a
smaller scope, rather than using the <span style="font-family:monospace">-AsuppressWarnings</span> command-line option.</p>
<!--TOC section id="askipuses" <span style="font-family:monospace">-AskipUses</span> and <span style="font-family:monospace">-AonlyUses</span> command-line options-->
<h2 id="askipuses" class="section">32.4 <span style="font-family:monospace">-AskipUses</span> and <span style="font-family:monospace">-AonlyUses</span> command-line options <a href="#askipuses"><img src="chainlink.svg" width="10" height="10"></a></h2><!--SEC END --><p>You can suppress all errors and warnings at all <em>uses</em> of a given
class, or suppress all errors and warnings <em>except</em> those at uses of a given
class. (The class itself is still type-checked, unless you also use
the <span style="font-family:monospace">-AskipDefs</span> or <span style="font-family:monospace">-AonlyDefs</span> command-line option, see ‍<a href="#askipdefs">32.5</a>).
You can also use these options to affect entire packages or directories/folders.</p><p>Set the <span style="font-family:monospace">-AskipUses</span> command-line option to a
regular expression that matches fully-qualified class names (not file names) for which warnings and errors
should be suppressed.
Or, set the <span style="font-family:monospace">-AonlyUses</span> command-line option to a
regular expression that matches fully-qualified class names (not file names) for which warnings and errors
should be emitted; warnings about uses of all other classes will be suppressed.</p><p>For example, suppose that you use
“<code class="verb">-AskipUses=^java\.</code>” on the command line
(with appropriate quoting) when invoking
<span style="font-family:monospace">javac</span>. Then the checkers will suppress all warnings related to
classes whose fully-qualified name starts with <code class="verb">java.</code>, such
as all warnings relating to invalid arguments and all warnings relating to
incorrect use of the return value.</p><p>To suppress all errors and warnings related to multiple classes, you can use
the regular expression alternative operator “<span style="font-family:monospace">|</span>”, as in
“<code class="verb">-AskipUses="java\.lang\.|java\.util\."</code>” to suppress
all warnings related to uses of classes that belong to the <span style="font-family:monospace">java.lang</span> or
<span style="font-family:monospace">java.util</span> packages. (Depending on your shell or other tool, you
might need to change or remove the quoting.)</p><p>You can supply both <span style="font-family:monospace">-AskipUses</span> and <span style="font-family:monospace">-AonlyUses</span>, in which case
the <span style="font-family:monospace">-AskipUses</span> argument takes precedence, and <span style="font-family:monospace">-AonlyUses</span> does
further filtering but does not add anything that <span style="font-family:monospace">-AskipUses</span> removed.</p><p>Warning: Use the <span style="font-family:monospace">-AonlyUses</span> command-line option with care,
because it can have unexpected results. For example, if the
given regular expression does not match classes in the JDK, then the
Checker Framework will suppress every warning that involves a JDK class
such as <span style="font-family:monospace">Object</span> or <span style="font-family:monospace">String</span>. The meaning of <span style="font-family:monospace">-AonlyUses</span> may be
refined in the future. Oftentimes <span style="font-family:monospace">-AskipUses</span> is more useful.</p>
<!--TOC section id="askipdefs" <span style="font-family:monospace">-AskipDefs</span> and <span style="font-family:monospace">-AonlyDefs</span> command-line options-->
<h2 id="askipdefs" class="section">32.5 <span style="font-family:monospace">-AskipDefs</span> and <span style="font-family:monospace">-AonlyDefs</span> command-line options <a href="#askipdefs"><img src="chainlink.svg" width="10" height="10"></a></h2><!--SEC END --><p>You can suppress all errors and warnings in the <em>definition</em> of a given
class, or suppress all errors and warnings <em>except</em> those in the definition
of a given class. (Uses of the class are still type-checked, unless you also use
the <span style="font-family:monospace">-AskipUses</span> or <span style="font-family:monospace">-AonlyUses</span> command-line option,
see ‍<a href="#askipuses">32.4</a>.)
You can also use these options to affect entire packages or directories/folders.</p><p>Set the <span style="font-family:monospace">-AskipDefs</span> command-line option to a
regular expression that matches fully-qualified class names (not file names) in whose definition warnings and errors
should be suppressed.
Or, set the <span style="font-family:monospace">-AonlyDefs</span> command-line option to a
regular expression that matches fully-qualified class names (not file names) whose
definitions should be type-checked.
(This is somewhat similar to NullAway’s
<span style="font-family:monospace">-XepOpt:NullAway:AnnotatedPackages</span> command-line argument.)</p><p>For example, if you use
“<code class="verb">-AskipDefs=^mypackage\.</code>” on the command line
(with appropriate quoting) when invoking
<span style="font-family:monospace">javac</span>, then the definitions of
classes whose fully-qualified name starts with <code class="verb">mypackage.</code>
will not be checked.</p><p>If you supply both <span style="font-family:monospace">-AskipDefs</span> and <span style="font-family:monospace">-AonlyDefs</span>, then
<span style="font-family:monospace">-AskipDefs</span> takes precedence.</p><p>Another way not to type-check a file is not to pass it on the compiler
command-line: the Checker Framework type-checks only files that are passed
to the compiler on the command line, and does not type-check any file that
is not passed to the compiler. The <span style="font-family:monospace">-AskipDefs</span> and <span style="font-family:monospace">-AonlyDefs</span>
command-line options
are intended for situations in which the build system is hard to understand
or change. In such a situation, a programmer may find it easier to supply
an extra command-line argument, than to change the set of files that is
compiled.</p><p>A common scenario for using the arguments is when you are starting out by
type-checking only part of a legacy codebase. After you have verified the
most important parts, you can incrementally check more classes until you
are type-checking the whole thing.</p>
<!--TOC section id="lint-options" <span style="font-family:monospace">-Alint</span> command-line option-->
<h2 id="lint-options" class="section">32.6 <span style="font-family:monospace">-Alint</span> command-line option<a id="alint"></a> <a href="#alint"><img src="chainlink.svg" width="10" height="10"></a></h2><!--SEC END --><p>The <span style="font-family:monospace">-Alint</span> option enables or disables optional checks, analogously to
javac’s <span style="font-family:monospace">-Xlint</span> option.
Each of the distributed checkers supports at least the following lint
options (and possibly more, see the checker’s documentation):</p><ul class="itemize"><li class="li-itemize"><span style="font-family:monospace">cast:unsafe</span> (default: on) warn about unsafe casts that are not
checked at run time, as in <span style="font-family:monospace">((@NonNull String) myref)</span>. Such casts
are generally not necessary because of type refinement
(Section ‍<a href="#type-refinement">31.7</a>).</li><li class="li-itemize"><span style="font-family:monospace">cast:redundant</span> (default: on) warn about redundant
casts that are guaranteed to succeed at run time,
as in <span style="font-family:monospace">((@NonNull String) "m")</span>. Such casts are not necessary,
because the target expression of the cast already has the given type
qualifier.</li><li class="li-itemize"><span style="font-family:monospace">cast</span> Enable or disable all cast-related warnings.</li><li class="li-itemize">
<span style="font-family:monospace">all</span> Enable or disable all lint warnings, including
checker-specific ones if any. Examples include <span style="font-family:monospace">redundantNullComparison</span> for the
Nullness Checker (see Section ‍<a href="#nullness-lint-nulltest">2</a>) and <span style="font-family:monospace">dotequals</span> for
the Interning Checker (see Section ‍<a href="#lint-dotequals">6.4</a>). This option
does not enable/disable the checker’s standard checks, just its optional
ones.
</li><li class="li-itemize"><span style="font-family:monospace">none</span> The inverse of <span style="font-family:monospace">all</span>: disable or enable all lint warnings,
including checker-specific ones if any.</li></ul><p>To activate a lint option, write <span style="font-family:monospace">-Alint=</span> followed by a
comma-delimited list of check names. If the option is preceded by a
hyphen (<span style="font-family:monospace">-</span>), the warning is disabled. For example, to disable all
lint options except redundant casts, you can pass
<span style="font-family:monospace">-Alint=-all,cast:redundant</span> on the command line.</p><p>Only the last <span style="font-family:monospace">-Alint</span> option is used; all previous <span style="font-family:monospace">-Alint</span>
options are silently ignored. In particular, this means that <span style="font-family:monospace">-Alint=all
-Alint=cast:redundant</span> is <em>not</em> equivalent to
<span style="font-family:monospace">-Alint=-all,cast:redundant</span>.</p>
<!--TOC section id="suppressing-warnings-stub" Change the specification of a method-->
<h2 id="suppressing-warnings-stub" class="section">32.7 Change the specification of a method <a href="#suppressing-warnings-stub"><img src="chainlink.svg" width="10" height="10"></a></h2><!--SEC END --><p>To prevent a checker from issuing a warning at calls to a specific method,
you can change the annotations on that method by writing a stub file (see
Section ‍<a href="#stub">34.5</a>).</p><p>Stub files are usually used to provide correct specifications for
unspecified code.</p><p>Stub files can also be used to provide <em>incorrect</em> specifications, for
the purpose of suppressing warnings. For example, suppose that you are
running the Nullness Checker to prevent null pointer exceptions. Further
suppose that for some reason you do not care if method
<span style="font-family:monospace">Objects.requireNonNull</span> crashes with a <span style="font-family:monospace">NullPointerException</span>. You can
supply a stub file containing:</p><pre class="verbatim">package java.util;
class Objects {
  @EnsuresNonNull("#1")
  public static &lt;T&gt; @NonNull T requireNonNull(@Nullable T obj);
}
</pre><p>This particular stub file already exists.
If you want the Nullness Checker to prevent most null
pointer exceptions in your code, but to <em>permit</em> null pointer
exceptions at nullness assertion methods, you can pass
<span style="font-family:monospace">-Astubs=permit-nullness-assertion-exception.astub</span>.</p>
<!--TOC section id="no-processor" Don’t run the processor-->
<h2 id="no-processor" class="section">32.8 Don’t run the processor <a href="#no-processor"><img src="chainlink.svg" width="10" height="10"></a></h2><!--SEC END --><p>You can compile parts of your code without use of the
<span style="font-family:monospace">-processor</span> switch to <span style="font-family:monospace">javac</span>. No checking is done during
such compilations, so no warnings are issued related to pluggable
type-checking.</p><p>You can direct your build system to avoid compiling certain parts of your
code. For example, the <span style="font-family:monospace">-Dmaven.test.skip=true</span> command-line argument
tells Maven not to compile (or run) the tests.</p>
<!--TOC section id="checker-specific-suppression" Checker-specific mechanisms-->
<h2 id="checker-specific-suppression" class="section">32.9 Checker-specific mechanisms <a href="#checker-specific-suppression"><img src="chainlink.svg" width="10" height="10"></a></h2><!--SEC END --><p>Finally, some checkers have special rules. For example, the Nullness
checker (Chapter ‍<a href="#nullness-checker">3</a>) uses
the special <span style="font-family:monospace">castNonNull</span> method to suppress warnings
(Section ‍<a href="#suppressing-warnings-with-assertions">3.4.1</a>).
This manual also explains special mechanisms for
suppressing warnings issued by the Fenum Checker
(Section ‍<a href="#fenum-suppressing">9.4</a>) and the Units Checker
(Section ‍<a href="#units-suppressing">19.5</a>).</p><hr>
<!--TOC chapter id="type-inference" Type inference-->
<h1 id="type-inference" class="chapter">Chapter ‍33 Type inference <a href="#type-inference"><img src="chainlink.svg" width="10" height="10"></a></h1><!--SEC END --><p>This chapter is about tools that infer annotations for your
program’s method signatures and fields, before you run a type-checker.
To learn about local type inference within a method body,
see Section ‍<a href="#type-refinement">31.7</a>.</p><p>A typical workflow (Section ‍<a href="#tips-about-writing-annotations">2.4</a>) is for a
programmer to first write annotations on method signatures and fields, then
run a type-checker. Type inference performs the first step automatically
for you. This saves time for programmers who would otherwise have to
understand the code, then write annotations manually.</p><p>Type inference outputs type qualifiers that are consistent with your
program’s source code. Your program still might not type-check if your
program contains a bug or contains tricky code that is beyond the
capabilities of the type checker.</p><p>The qualifiers are output into an annotation file. They can be viewed and
adjusted by the programmer, can be used by tools such as the type-checker,
and can be inserted into the source code or the class file.</p><p>Inserting the inferred annotations into the program source code creates documentation in the form of type
qualifiers, which can aid programmer understanding and may make
type-checking warnings more comprehensible.
Storing annotations in side-files is more desirable if the program’s source code cannot
be modified for some reason, if the typechecking is "one-off" (typechecking will
be done once and its results will be evaluated, but it will not be done
repeatedly), or if the set of annotations is extremely voluminous and would
clutter the code.</p><p>Type inference is most effective when you run it on a program rather than
on a library — unless you also run it on an extensive test suite for the
library. See Section ‍<a href="#whole-program-inference-non-representative-uses">33.6</a>
for an explanation.</p><p>Type inference is costly: it takes several times longer than
type-checking does. However, it only needs to be run once, after which
you can use and possibly modify the results.</p>
<!--TOC section id="type-inference-tools" Type inference tools-->
<h2 id="type-inference-tools" class="section">33.1 Type inference tools <a href="#type-inference-tools"><img src="chainlink.svg" width="10" height="10"></a></h2><!--SEC END --><p>This section lists tools that take a program and output a set of
annotations for it.
It first lists tools that work only for a single type system (but may do a
more accurate job for that type system)
then lists general tools that work for any type system.</p><dl class="description"><dt class="dt-description">
<span style="font-weight:bold">For the Nullness Checker:</span></dt><dd class="dd-description">
Section ‍<a href="#nullness-inference">3.3.7</a> lists several tools that infer
annotations for the Nullness Checker.</dd><dt class="dt-description"><span style="font-weight:bold">For the Purity Checker:</span></dt><dd class="dd-description">
If you run the Checker Framework with the <span style="font-family:monospace">-AsuggestPureMethods</span>
command-line option, it will suggest methods that can be marked as
<span style="font-family:monospace">@SideEffectFree</span>, <span style="font-family:monospace">@Deterministic</span>, or <span style="font-family:monospace">@Pure</span>; see
Section ‍<a href="#type-refinement-purity">31.7.5</a>.</dd><dt class="dt-description"><span style="font-weight:bold">WPI, for any type system:</span></dt><dd class="dd-description">
“Whole program inference”, or WPI, is distributed with the Checker
Framework. See Section ‍<a href="#whole-program-inference">33.2</a>.</dd><dt class="dt-description"><span style="font-weight:bold">CFI, for any type system:</span></dt><dd class="dd-description">
<a href="https://github.com/opprop/checker-framework-inference">“Checker
Framework Inference”</a>, or CFI, is a type inference framework built on
a variant of the Checker Framework. You need to slightly rewrite your type system to
work with CFI. The
<a href="https://github.com/opprop/checker-framework-inference">CFI
repository</a> contains rewritten versions of some of
the type systems that are distributed with the Checker Framework.</dd><dt class="dt-description"><span style="font-weight:bold">Cascade, for any type system:</span></dt><dd class="dd-description">
<a href="https://github.com/reprogrammer/cascade/">Cascade</a> ‍[<a href="#VakilianPEJ2015">VPEJ15</a>]
is an Eclipse plugin that implements interactive type qualifier inference.
Cascade is interactive rather than fully-automated: it makes it easier for
a developer to insert annotations.
Cascade starts with an unannotated program and runs a type-checker. For each
warning it suggests multiple fixes, the developer chooses a fix, and
Cascade applies it. Cascade works with any checker built on the Checker
Framework.
You can find installation instructions and a video tutorial at <a href="https://github.com/reprogrammer/cascade"><span style="font-family:monospace">https://github.com/reprogrammer/cascade</span></a>.
Cascade was last updated in November 2014, so it might or might not work for you.</dd></dl><p>Except for one of the nullness inference tools, all these
type inference tools are static analyses. They analyze your program’s
source code, but they do not run your program.</p>
<!--TOC section id="whole-program-inference" Whole-program inference-->
<h2 id="whole-program-inference" class="section">33.2 Whole-program inference <a href="#whole-program-inference"><img src="chainlink.svg" width="10" height="10"></a></h2><!--SEC END --><p>Whole-program inference
infers types for fields, method parameters, and method return types that do not
have a user-written qualifier (for the given type system).
The inferred type qualifiers are output into annotation files.
The inferred type is the most specific type that is compatible with all the
uses in the program. For example, the inferred type for a field is the
least upper bound of the types of all the expressions that are assigned
into the field.</p><p>There are three scripts that you can use to run whole-program inference.
Each has advantages and disadvantages, discussed below:</p><ul class="itemize"><li class="li-itemize">
To run whole-program inference on a single project without modifying its source code,
use the <span style="font-family:monospace">wpi.sh</span> script (Section ‍<a href="#wpi-one">33.3</a>). This script can automatically understand
many Ant, Maven, and Gradle build files, so it requires little manual configuration.</li><li class="li-itemize">To run whole-program inference on many projects without modifying their source code
(say, when running it on projects from GitHub), use the <span style="font-family:monospace">wpi-many.sh</span> script (Section ‍<a href="#wpi-many">33.4</a>).
This script can understand the same build files as <span style="font-family:monospace">wpi.sh</span>.</li><li class="li-itemize">If you want to insert the inferred annotations directly into a single
project’s source code, use the <span style="font-family:monospace">infer-and-annotate.sh</span> script (Section ‍<a href="#wpi-insert">33.5</a>).
</li></ul><p>These type inference scripts appear in the <span style="font-family:monospace">checker/bin/</span> directory.
The remainder of this chapter describes them
(Sections ‍<a href="#wpi-one">33.3</a>–<a href="#wpi-insert">33.5</a>), then concludes with discussion
that applies to all of them.</p>
<!--TOC section id="wpi-one" Running whole-program inference on a single project-->
<h2 id="wpi-one" class="section">33.3 Running whole-program inference on a single project <a href="#wpi-one"><img src="chainlink.svg" width="10" height="10"></a></h2><!--SEC END --><p>A typical invocation of <span style="font-family:monospace">wpi.sh</span> is</p><pre class="verbatim">  wpi.sh -- --checker nullness
</pre><p>The result is a set of log files placed in the <span style="font-family:monospace">dljc-out/</span> folder of the
target project. The results of type-checking with each candidate set of
annotations will be concatenated into the file <span style="font-family:monospace">dljc-out/wpi-stdout.log</span>; the final
results (i.e., those obtained using the most precise, consistent set of annotations)
will appear at the end of this file.
The inferred annotations appear in <span style="font-family:monospace">.ajava</span> files in a
temporary directory whose name appears in the <span style="font-family:monospace">dlcj-out/wpi-stdout.log</span> file;
you can find their location by examining the <span style="font-family:monospace">-Ajava</span> argument
to the last <span style="font-family:monospace">javac</span> command that was run. The annotation files generated in
each round of inference appear in directories labeled <span style="font-family:monospace">iteration0</span>, <span style="font-family:monospace">iteration1</span>, etc.</p><p>The <span style="font-family:monospace">wpi.sh</span> script is most useful when analyzing projects that follow the standard
conventions of their build system for single-module projects. When analyzing a project
that requires non-standard build system commands, use the <span style="font-family:monospace">-c</span> and <span style="font-family:monospace">-b</span> options to
override the defaults used by <span style="font-family:monospace">wpi.sh</span>. For example, suppose that you wanted to use
<span style="font-family:monospace">wpi.sh</span> to infer annotations for the Resource Leak Checker on
<a href="https://github.com/apache/zookeeper">Apache Zookeeper’s</a>
<span style="font-family:monospace">zookeeper-server</span> module only. Without <span style="font-family:monospace">wpi.sh</span>, one might use the following command:
<span style="font-family:monospace">mvn -B --projects zookeeper-server --also-make install -DskipTests</span>. To use this command via
<span style="font-family:monospace">wpi.sh</span>, use the following:
<span style="font-family:monospace">sh wpi.sh -b "-B --projects zookeeper-server --also-make" -c "install -DskipTests" -- --checker resourceleak</span>.</p><p>The full syntax for invoking <span style="font-family:monospace">wpi.sh</span> is</p><pre class="verbatim">  wpi.sh [-d PROJECTDIR] [-t TIMEOUT] [-c COMPILATION_TARGET] [-b EXTRA_BUILD_ARGS] [-g GRADLECACHEDIR] -- [DLJC-ARGS]
</pre><p>Arguments in square brackets are optional.
Here is an explanation of the arguments:</p><dl class="description"><dt class="dt-description">
<span style="font-weight:bold">-d PROJECTDIR</span></dt><dd class="dd-description">
The top-level directory of the project. It must contain an Ant, Gradle,
or Maven buildfile. The default is the current working directory.</dd><dt class="dt-description"><span style="font-weight:bold">-t TIMEOUT</span></dt><dd class="dd-description">
The timeout for running the checker, in seconds.</dd><dt class="dt-description"><span style="font-weight:bold">-c COMPILATION_TARGET</span></dt><dd class="dd-description">
The name(s) of the build system target(s) used to compile
the target project. The default is chosen based on the build
system (e.g., <span style="font-family:monospace">compileJava</span> for Gradle, <span style="font-family:monospace">compile</span> for Maven, etc.).
This argument is passed directly to the build system when compiling the
target project, so it can also include command-line arguments that only
apply to the compilation targets (and not other targets like <span style="font-family:monospace">clean</span>);
for general command-line arguments that apply to all targets, use the
<span style="font-family:monospace">-b</span> option instead.
When running WPI on a single module of a multi-module project,
you might want to use this option (possibly in combination with <span style="font-family:monospace">-b</span>, below),
depending on the setup of the target project.
The argument may contain spaces and is re-tokenized by the shell.</dd><dt class="dt-description"><span style="font-weight:bold">-b EXTRA_BUILD_ARGS</span></dt><dd class="dd-description">
Extra arguments to pass to the build script invocation. This argument
will be passed to compilation tasks, such as
<span style="font-family:monospace">ant compile</span>, <span style="font-family:monospace">gradle compileJava</span>, or <span style="font-family:monospace">mvn compile</span>.
The main difference between this option and <span style="font-family:monospace">-c</span> is that the values
of the <span style="font-family:monospace">-b</span> option are also passed to other, non-compilation build system commands, such as
<span style="font-family:monospace">ant clean</span>, <span style="font-family:monospace">gradle clean</span>, or <span style="font-family:monospace">mvn clean</span>.
The argument may contain spaces and is re-tokenized by the shell.</dd><dt class="dt-description"><span style="font-weight:bold">-g GRADLECACHEDIR</span></dt><dd class="dd-description">
The directory to use for the <span style="font-family:monospace">-g</span> option to Gradle (the Gradle home
directory). This option is ignored if the target project does not
build with Gradle. The default is <span style="font-family:monospace">.gradle</span> relative to the target
project (i.e., each target project has its own Gradle home). This default
is motivated by
<a href="https://github.com/gradle/gradle/issues/1319">Gradle issue #1319</a>.<p><a id="DLJC-ARGS"></a>
</p></dd><dt class="dt-description"><span style="font-weight:bold">DLJC-ARGS</span></dt><dd class="dd-description">
Arguments that are passed directly to
<a href="https://github.com/kelloggm/do-like-javac">do-like-javac</a>’s
<span style="font-family:monospace">dljc</span> program without
modification. One argument is required: <span style="font-family:monospace">--checker</span>, which indicates
what type-checker(s) to run (in the format described in Section ‍<a href="#shorthand-for-checkers">2.2.4</a>).<p>The <a href="https://github.com/kelloggm/do-like-javac">documentation of do-like-javac</a>
describes the other commands that its WPI tool supports. Notably, to pass checker-specific
arguments to invocations of <span style="font-family:monospace">javac</span>,
use the <span style="font-family:monospace">--extraJavacArgs</span> argument to <span style="font-family:monospace">dljc</span>. For example, to use the <span style="font-family:monospace">-AignoreRangeOverflow</span>
option for the Constant Value Checker (Chapter ‍<a href="#constant-value-checker">22</a>) when running
inference, you would add <span style="font-family:monospace">--extraJavacArgs=’-AignoreRangeOverflow’</span> anywhere after the <span style="font-family:monospace">--</span>
argument to <span style="font-family:monospace">wpi.sh</span>.
</p></dd></dl><p>You may need to wait a few minutes for the command to complete.</p>
<!--TOC subsection id="wpi-shared-requirements" Requirements for whole-program inference scripts-->
<h3 id="wpi-shared-requirements" class="subsection">33.3.1 Requirements for whole-program inference scripts <a href="#wpi-shared-requirements"><img src="chainlink.svg" width="10" height="10"></a></h3><!--SEC END --><p>The requirements to run <span style="font-family:monospace">wpi.sh</span> and <span style="font-family:monospace">wpi-many.sh</span> are the same:</p><ul class="itemize"><li class="li-itemize">
The project on which inference is run must contain an Ant, Gradle,
or Maven buildfile that compiles the project.
</li><li class="li-itemize">At least one of the <code class="verb">JAVA_HOME</code>,
<code class="verb">JAVA8_HOME</code>, <code class="verb">JAVA11_HOME</code>, <code class="verb">JAVA17_HOME</code>, or <code class="verb">JAVA20_HOME</code>
environment variables must be set.
</li><li class="li-itemize">If set, the <code class="verb">JAVA_HOME</code> environment variable must point to a
Java 8, 11, 17, or 20 JDK.
</li><li class="li-itemize">If set, the <code class="verb">JAVA8_HOME</code> environment variable must point to a Java 8 JDK.
</li><li class="li-itemize">If set, the <code class="verb">JAVA11_HOME</code> environment variable must point to a Java 11 JDK.
</li><li class="li-itemize">If set, the <code class="verb">JAVA17_HOME</code> environment variable must point to a Java 17 JDK.
</li><li class="li-itemize">If set, the <code class="verb">JAVA20_HOME</code> environment variable must point to a Java 20 JDK.
</li><li class="li-itemize"><span style="font-family:monospace">CHECKERFRAMEWORK</span> environment variable must point to a built copy of the Checker Framework.
</li><li class="li-itemize">If set, the <code class="verb">DLJC</code> environment variable must point to a copy of the <span style="font-family:monospace">dljc</span> script
from <a href="https://github.com/kelloggm/do-like-javac">do-like-javac</a>. (If this variable is not
set, the WPI scripts will download this dependency automatically.)
</li><li class="li-itemize">Other dependencies:
ant,
awk,
curl,
git,
gradle,
mvn,
python3 (for dljc),
wget.<p>Python2.7 modules:
subprocess32.
</p></li></ul>
<!--TOC section id="wpi-many" Running whole-program inference on many projects-->
<h2 id="wpi-many" class="section">33.4 Running whole-program inference on many projects <a href="#wpi-many"><img src="chainlink.svg" width="10" height="10"></a></h2><!--SEC END --><p>The requirements to run <span style="font-family:monospace">wpi.sh</span> and <span style="font-family:monospace">wpi-many.sh</span> are the same. See Section ‍<a href="#wpi-shared-requirements">33.3.1</a>
for the list of requirements.</p><p>To run an experiment on many projects:
</p><ol class="enumerate" type=1><li class="li-enumerate">
Use <span style="font-family:monospace">query-github.sh</span> to search GitHub for candidate repositories.
File <span style="font-family:monospace">docs/examples/wpi-many/securerandom.query</span> is an example query, and file
<span style="font-family:monospace">docs/manual/securerandom.list</span> is the standard output
created by running <span style="font-family:monospace">query-github.sh securerandom.query 100</span>. If you do
not want to use GitHub, construct a file yourself that matches the format of
the file <span style="font-family:monospace">securerandom.list</span>.</li><li class="li-enumerate">Use <span style="font-family:monospace">wpi-many.sh</span> to run whole-program inference on every
Ant, Gradle, or Maven project in a list of (GitHub repository URL, git hash)
pairs.
<ul class="itemize"><li class="li-itemize">
If you are using a checker that is distributed with the Checker
Framework, use <span style="font-family:monospace">wpi-many.sh</span> directly.
</li><li class="li-itemize">If you are using a checker that is not distributed with the Checker
Framework (also known as a "custom checker"), file
<span style="font-family:monospace">docs/examples/wpi-many/wpi-many-custom-checker-example.sh</span> is a no-arguments
script that serves as an example of how to use <span style="font-family:monospace">wpi-many.sh</span>.
</li></ul><p>Log files are copied into a results directory.
For a failed run, the log file indicates the reason that WPI could not
be run to completion on the project.
For a successful run, the log file indicates whether the project was verified
(i.e., no errors were reported), or whether the checker issued warnings
(which might be true positive or false positive warnings).</p></li><li class="li-enumerate">Use <span style="font-family:monospace">wpi-summary.sh</span> to summarize the logs in the output results directory.
Use its output to guide your analysis of the results of running <span style="font-family:monospace">wpi-many.sh</span>:
you should manually examine the log files for the projects that appear in the
"results available" list it produces. This list is the list of every project
that the script was able to successfully run WPI on. (This does not mean
that the project type-checks without errors afterward, or even typechecks at
all — just that the Checker Framework attempted to typecheck the project and
some output was produced.)</li><li class="li-enumerate">(Optional) Add annotations that WPI does not infer, to eliminate
false positive warnings. There are two ways you can add annotations to a target
program:
<ul class="itemize"><li class="li-itemize">
Fork the project and add the annotations directly to the project’s
source code, and add a dependency on
<span style="font-family:monospace">org.checkerframework:checker-qual</span> to the project’s build
system. This approach is the most difficult, but has the advantage that
the checker will attempt to verify any annotations you add.
</li><li class="li-itemize">Add the annotations in a stub file, creating the <span style="font-family:monospace">.astub</span> file as
a copy of the <span style="font-family:monospace">.java</span> file. When you run the checker, supply the
<span style="font-family:monospace">-AmergeStubsWithSource</span> and <span style="font-family:monospace">-Astubs=...</span> command-line arguments.
</li></ul></li></ol><p>A typical invocation is</p><pre class="verbatim">wpi-many.sh -o outdir -i /path/to/repo.list -t 7200 -- --checker optional
</pre><p>The <span style="font-family:monospace">wpi-many.sh</span> script takes the following command-line arguments.
The <span style="font-family:monospace">-o</span> and <span style="font-family:monospace">-i</span> arguments are mandatory.
An invocation should also include <span style="font-family:monospace">-- [</span><span style="font-family:monospace"><em>DLJC-ARGS</em></span><span style="font-family:monospace">]</span> at the end;
<em>DLJC-ARGS</em> is documented in Section ‍<a href="#DLJC-ARGS">33.3</a>.</p><dl class="description"><dt class="dt-description">
<span style="font-weight:bold">-o outdir</span></dt><dd class="dd-description">
run the experiment in the <span style="font-family:monospace"><em>outdir</em></span> directory, and place the results in
the <span style="font-family:monospace"><em>outdir</em></span><span style="font-family:monospace">-results</span> directory. Both will be created if they do not
exist. The directory may be specified as an absolute or relative path.</dd><dt class="dt-description"><span style="font-weight:bold">-i infile</span></dt><dd class="dd-description">
Read the list of repositories to use from the file infile.
The file must be specified as an absolute, not relative, path.
Each line
should have 2 elements, separated by whitespace:
<ol class="enumerate" type=1><li class="li-enumerate">
The URL of the git repository on GitHub. The URL must be of the form
https://github.com/username/repository . The script is reliant on the
number of slashes, so excluding “https://” is an error.
</li><li class="li-enumerate">The commit hash to use.
</li></ol></dd><dt class="dt-description"><span style="font-weight:bold">-t timeout</span></dt><dd class="dd-description">
The timeout for running the checker on each project, in seconds.</dd><dt class="dt-description"><span style="font-weight:bold">-g GRADLECACHEDIR</span></dt><dd class="dd-description">
The directory to use for the <span style="font-family:monospace">-g</span> option to Gradle (the Gradle home
directory). This option is ignored if the target project does not
build with Gradle. The default is <span style="font-family:monospace">.gradle</span> relative to the target
project (i.e., each target project has its own Gradle home). This default
is motivated by
<a href="https://github.com/gradle/gradle/issues/1319">Gradle issue #1319</a>.</dd><dt class="dt-description"><span style="font-weight:bold">-s</span></dt><dd class="dd-description">
If this flag is present, then projects which are not buildable — for which
no supported build file is present or for which running the standard build
commands fail — are skipped on future runs but are <em>not</em> deleted immediately
(such projects are deleted immediately if this flag is not present). This flag is useful
if you intend to run <span style="font-family:monospace">wpi-many.sh</span> several times on the same set of repositories
(for example, during checker development), to avoid re-downloading unusable projects.</dd></dl>
<!--TOC section id="wpi-insert" Whole-program inference that inserts annotations into source code-->
<h2 id="wpi-insert" class="section">33.5 Whole-program inference that inserts annotations into source code <a href="#wpi-insert"><img src="chainlink.svg" width="10" height="10"></a></h2><!--SEC END --><p>
To use this version of whole-program inference, make sure that
<span style="font-family:monospace">insert-annotations-to-source</span>, from the Annotation File Utilities project,
is on your path (for example, its directory is in the <span style="font-family:monospace">$PATH</span> environment variable).
Then, run the script <span style="font-family:monospace">checker-framework/checker/bin/infer-and-annotate.sh</span>.
Its command-line arguments are:
</p><ol class="enumerate" type=1><li class="li-enumerate">
Optional: Command-line arguments to
<a href="https://eisop.github.io/afu/#insert-annotations-to-source"><span style="font-family:monospace">insert-annotations-to-source</span></a>.
</li><li class="li-enumerate">Processor’s name.
</li><li class="li-enumerate">Target program’s classpath. This argument is required; pass "" if it
is empty.
</li><li class="li-enumerate">Optional: Extra processor arguments which will be passed to the checker, if any.
You may supply any number of such arguments, or none. Each such argument
must start with a hyphen.
</li><li class="li-enumerate">Optional: Paths to <span style="font-family:monospace">.jaif</span> files used as input in the inference
process.
</li><li class="li-enumerate">Paths to <span style="font-family:monospace">.java</span> files in the program.
</li></ol><p>For example, to add annotations to the <span style="font-family:monospace">plume-lib</span> project:
</p><pre class="verbatim">git clone https://github.com/mernst/plume-lib.git
cd plume-lib
make jar
$CHECKERFRAMEWORK/checker/bin/infer-and-annotate.sh \
    "LockChecker,NullnessChecker" java/plume.jar:java/lib/junit-4.12.jar:$JAVA_HOME/lib/tools.jar \
    `find java/src/plume/ -name "*.java"`
# View the results
git diff
</pre><p>You may need to wait a few minutes for the command to complete.
You can ignore warnings that the command outputs while it tries different
annotations in your code.</p><p>It is recommended that you run <span style="font-family:monospace">infer-and-annotate.sh</span> on a copy of your
code, so that you can see what changes it made and so that it does not
change your only copy. One way to do this is to work in a clone of your
repository that has no uncommitted changes.</p>
<!--TOC section id="whole-program-inference-non-representative-uses" Inference results depend on uses in your program or test suite-->
<h2 id="whole-program-inference-non-representative-uses" class="section">33.6 Inference results depend on uses in your program or test suite <a href="#whole-program-inference-non-representative-uses"><img src="chainlink.svg" width="10" height="10"></a></h2><!--SEC END --><p>Type inference outputs the most specific type qualifiers that are
consistent with all the source code it is given.
(Section ‍<a href="#whole-program-inference-ignores-some-code">33.6.1</a>
explains when type inference ignores some code.)
This may be different than the specification the programmer had in mind
when writing tho code.
If the program uses a method or field in a limited way, then the inferred
annotations will be legal for the program as
currently written but may not be as general as possible and may not
accommodate future program changes.</p><p>Here are some examples:</p><ul class="itemize"><li class="li-itemize">
Suppose that your program (or test suite) currently calls
method <span style="font-family:monospace">m1</span> only with non-null
arguments. The tool will infer that <span style="font-family:monospace">m1</span>’s parameter has
<span style="font-family:monospace">@NonNull</span> type. If you had intended the method to be able to
take <span style="font-family:monospace">null</span> as an argument and you later add such a call, the type-checker
will issue a warning because the inferred <span style="font-family:monospace">@NonNull</span>
annotation is inconsistent with the new call.</li><li class="li-itemize">If your program (or test suite) passes only <span style="font-family:monospace">null</span> as an argument, the
inferred type will be the bottom type, such as <span style="font-family:monospace">@GuardedByBottom</span>.</li><li class="li-itemize">Suppose that method <span style="font-family:monospace">m2</span> has no body, because it is defined in an interface or
abstract class.
Type inference can still infer types for its signature, based on the
overriding implementations.
If all the methods that override <span style="font-family:monospace">m2</span> return a non-null value, type
inference will infer that <span style="font-family:monospace">m2</span>’s return type has <span style="font-family:monospace">@NonNull</span> type, even if
some other overriding method is allowed to return
<span style="font-family:monospace">null</span>.</li></ul><p>If the program contains erroneous calls, the
inferred annotations may reflect those errors.
Suppose you intend method <span style="font-family:monospace">m3</span> to be called with
non-null arguments, but your program contains an error and one of the calls
to <span style="font-family:monospace">m3</span> passes <span style="font-family:monospace">null</span> as the argument. Then the tool will infer that
<span style="font-family:monospace">m3</span>’s parameter has <span style="font-family:monospace">@Nullable</span> type.</p><p>If you run whole-program inference on a library that contains mutually
recursive routines, and there are no non-recursive calls to the routines,
then whole-program inference may run a long time and eventually produce
incorrect results. In this case, write type annotations on the formal
parameters of one of the routines.</p><p>Whole-program inference is a “forward analysis”.
It determines a method parameter’s type
annotation based on what arguments are passed to the method but not on how the
parameter is used within the method body.
It determines a method’s return type based on code in the method body but
not on uses of the method return value in client code.</p>
<!--TOC subsection id="whole-program-inference-ignores-some-code" Whole-program inference ignores some code-->
<h3 id="whole-program-inference-ignores-some-code" class="subsection">33.6.1 Whole-program inference ignores some code <a href="#whole-program-inference-ignores-some-code"><img src="chainlink.svg" width="10" height="10"></a></h3><!--SEC END --><p>Whole-program inference ignores code within the scope of a
<span style="font-family:monospace">@SuppressWarnings</span> annotation with an appropriate key
(Section ‍<a href="#suppresswarnings-annotation">32.1</a>). In particular, uses within
the scope do not contribute to the inferred type, and declarations within
the scope are not changed. You should remove <span style="font-family:monospace">@SuppressWarnings</span> annotations
from the class declaration of any class you wish to infer types for.</p><p>As noted above, whole-program inference generalizes from invocations of methods and
assignments to fields. If a field is set via
reflection (such as via injection), there are no explicit assignments to it
for type inference to generalize from, and type inference will produce
an inaccurate result. There are two ways to make whole-program inference
ignore such a field.
(1)
You probably have an annotation such as
<a href="https://docs.oracle.com/javaee/7/api/javax/inject/Inject.html"><span style="font-family:monospace">@Inject</span></a>
or
<a href="https://types.cs.washington.edu/plume-lib/api/plume/Option.html"><span style="font-family:monospace">@Option</span></a>
that indicates such fields. Meta-annotate the declaration of the <span style="font-family:monospace">Inject</span>
or <span style="font-family:monospace">Option</span> annotation with
<a href="../api/org/checkerframework/framework/qual/IgnoreInWholeProgramInference.html"><span style="font-family:monospace">@IgnoreInWholeProgramInference</span></a>.
(2)
Annotate the field to be ignored with
<a href="../api/org/checkerframework/framework/qual/IgnoreInWholeProgramInference.html"><span style="font-family:monospace">@IgnoreInWholeProgramInference</span></a>.</p><p>Whole-program inference, for a type-checker other than the Nullness Checker,
ignores assignments and pseudo-assignments where the right-hand-side is the <span style="font-family:monospace">null</span> literal.</p>
<!--TOC subsection id="whole-program-inference-manual-checking" Manually checking whole-program inference results-->
<h3 id="whole-program-inference-manual-checking" class="subsection">33.6.2 Manually checking whole-program inference results <a href="#whole-program-inference-manual-checking"><img src="chainlink.svg" width="10" height="10"></a></h3><!--SEC END --><p>With any type inference tool, it is a good idea to manually examine the
results. This can help you find bugs in your code or places where type
inference inferred an overly-precise result.
You can correct the inferred results manually, or you can
add tests that pass additional values and then re-run inference.</p><p>When arguments or assignments are literals, whole-program inference
commonly infers overly precise type annotations, such as <span style="font-family:monospace">@Interned</span> and
<span style="font-family:monospace">@Regex</span> annotations when the analyzed code only uses a constant string.</p><p>When an annotation is inferred for a <em>use</em> of a type variable,
you may wish to move the annotation
to the corresponding upper bounds of the type variable <em>declaration</em>.</p>
<!--TOC section id="how-whole-program-inference-works" How whole-program inference works-->
<h2 id="how-whole-program-inference-works" class="section">33.7 How whole-program inference works <a href="#how-whole-program-inference-works"><img src="chainlink.svg" width="10" height="10"></a></h2><!--SEC END --><p>This section explains how the <span style="font-family:monospace">wpi.sh</span> and <span style="font-family:monospace">infer-and-annotate.sh</span> scripts work. If you
merely want to run the scripts and you are not encountering trouble, you can
skip this section.</p><p>Each script repeatedly runs the checker with an <span style="font-family:monospace">-Ainfer=</span> command-line option to infer
types for fields and method signatures. The output of this step
is a <span style="font-family:monospace">.jaif</span> (for <span style="font-family:monospace">infer-and-annotate.sh</span>) or <span style="font-family:monospace">.ajava</span> (for <span style="font-family:monospace">wpi.sh</span>) file that records the inferred types.
Each script adds the inferred annotation to the next run, so that the checker takes them into
account (and checks them). <span style="font-family:monospace">wpi.sh</span> does this by updating the set of <span style="font-family:monospace">.ajava</span> files that are passed
to the checker via the <span style="font-family:monospace">-Aajava</span> command-line argument;
<span style="font-family:monospace">infer-and-annotate.sh</span> inserts the inferred annotations in the program using the
<a href="https://eisop.github.io/afu/">Annotation File Utilities</a>.</p><p>On each
iteration through the process, there may be new annotations in the <span style="font-family:monospace">.jaif</span> or <span style="font-family:monospace">.ajava</span>
files, and some type-checking errors may be eliminated (though others might
be introduced).
The process halts when there are no more changes to the inference results,
that is, the <span style="font-family:monospace">.jaif</span> or <span style="font-family:monospace">.ajava</span> files are unchanged between two runs.</p><p>When the type-checker is run on the program with the final annotations
inserted, there might still be errors. This may be because the tool did
not infer enough annotations, or because your program cannot typecheck
(either because contains a defect, or because it contains subtle code that
is beyond the capabilities of the type system).
However, each of the inferred annotations is sound, and this reduces your
manual effort in annotating the program.</p><p>The iterative process is required because type-checking is modular: it
processes each class and each method only once, independently. Modularity
enables you to run type-checking on only part of your program, and it makes
type-checking fast. However, it has some disadvantages:
</p><ul class="itemize"><li class="li-itemize">
The first run of the type-checker cannot take advantage of whole-program
inference results because whole-program inference is only complete at the
end of type-checking, and modular type-checking does not revisit any
already-processed classes.
</li><li class="li-itemize">Revisiting an
already-processed class may result in a better estimate.
</li></ul>
<!--TOC section id="type-inference-vs-whole-program-analysis" Type inference compared to other whole-program analyses-->
<h2 id="type-inference-vs-whole-program-analysis" class="section">33.8 Type inference compared to other whole-program analyses <a href="#type-inference-vs-whole-program-analysis"><img src="chainlink.svg" width="10" height="10"></a></h2><!--SEC END --><p>There exist monolithic whole-program analyses that run without requiring any
annotations in the source code. An advantage of such a tool is that the
programmer never needs to write any type annotations.</p><p>Running a whole-program inference tool, then running a type-checker, has
some benefits:
</p><ul class="itemize"><li class="li-itemize">
The type qualifiers act as machine-checked documentation,
which can aid programmer understanding.
</li><li class="li-itemize">Error messages may be more comprehensible. With a monolithic
whole-program analysis, error messages can be obscure, because the
analysis has already inferred (possibly incorrect) types for a number of
variables.
</li><li class="li-itemize">Errors are localized. A change to one part of the program does not lead
to an error message in a far-removed part of the program.
</li><li class="li-itemize">Type-checking is modular, which can be faster than re-doing a
whole-program analysis every time the program changes.
</li></ul><hr>
<!--TOC chapter id="annotating-libraries" Annotating libraries-->
<h1 id="annotating-libraries" class="chapter">Chapter ‍34 Annotating libraries <a href="#annotating-libraries"><img src="chainlink.svg" width="10" height="10"></a></h1><!--SEC END --><p>When your code uses a library that is not currently being compiled,
the Checker Framework looks up the library’s annotations in its class files.
Section ‍<a href="#annotated-libraries-using">2.2.1</a> tells you how to find and use a
version of a library that contains type annotations.</p><p>If your code uses a library that does <em>not</em> contain type annotations,
then the type-checker has no way to know the library’s behavior.
The type-checker
makes conservative assumptions about unannotated bytecode.
(See
Section ‍<a href="#defaults-classfile">31.5.6</a> for details, an example, and how to
override this conservative behavior.)
These conservative library
annotations invariably lead to checker warnings.</p><p>This chapter describes how to eliminate
the warnings by adding annotations to the library.
(Alternately, the <span style="font-family:monospace">-AskipUses</span> or <span style="font-family:monospace">-AonlyUses</span> command-line
option can
suppress all warnings related to an unannotated library, or to part of your
codebase; see
Sections ‍<a href="#askipuses">32.4</a>–<a href="#askipdefs">32.5</a>.)</p><p>You can write annotations for a library, and make them known to a checker, in two ways.</p><ol class="enumerate" type=1><li class="li-enumerate">
Write annotations in a copy of the library’s source code (for instance,
in a fork of the library’s GitHub project). In addition to writing
annotations, adjust the build system to run pluggable-type-checking when
compiling (see Chapter ‍<a href="#external-tools">37</a>). Now, when you compile
the library, the resulting <span style="font-family:monospace">.jar</span> file contains type annotations.<p>When checking a client of the library,
put the annotated library’s <span style="font-family:monospace">.jar</span> file on the classpath, as explained in
Section ‍<a href="#annotated-libraries-using">2.2.1</a>.
</p><p>With this compilation approach, the syntax of the library annotations is
validated ahead of time. Thus, this compilation approach is less
error-prone, and the type-checker runs faster. You get
correctness guarantees about the library in addition to your code.</p><p>For instructions, see Section ‍<a href="#annotating-libraries-create">34.2</a>.</p></li><li class="li-enumerate">Write annotations in a “stub file”, if you do not have access to the
source code.
<p>Then, when check a client of the library,
supply the “stub file” textually to the Checker Framework.</p><p>This approach does not require you to compile the library source
code.
A stub file is applicable to multiple versions of a library, so
the stub file does not need to be updated when a new version of the
library is released, unless the API has changed (such as defining a new
class or method).</p><p>For instructions, see Section ‍<a href="#stub">34.5</a>.</p></li></ol><p>If you annotate a new library (either in its source code or in a stub
file), please inform the Checker Framework
developers so that your annotated library can be advertised to users of the
Checker Framework.
Sharing your annotations is useful even if the library is only partially
annotated.
However, as noted in Sections ‍<a href="#get-started-with-legacy-code">2.4.2</a> and ‍<a href="#library-tips-fully-annotate">34.1.4</a>, you
should annotate an entire class at a time.
You may find type inference tools (Chapter ‍<a href="#type-inference">33</a>) helpful
when getting started, but you should always examine their results.</p>
<!--TOC section id="library-tips" Tips for annotating a library-->
<h2 id="library-tips" class="section">34.1 Tips for annotating a library <a href="#library-tips"><img src="chainlink.svg" width="10" height="10"></a></h2><!--SEC END --><p>Section ‍<a href="#tips-about-writing-annotations">2.4</a> gives general tips for writing
annotations. This section gives tips that are specific to annotating a
third-party library.</p>
<!--TOC subsection id="library-tips-dont-change-the-code" Don’t change the code-->
<h3 id="library-tips-dont-change-the-code" class="subsection">34.1.1 Don’t change the code <a href="#library-tips-dont-change-the-code"><img src="chainlink.svg" width="10" height="10"></a></h3><!--SEC END --><p>If you annotate a library that you maintain, you can refactor it to improve
its design.</p><p>When you annotate a library that you do not maintain, you should only add
annotations and, when necessary, documentation of those annotations. You
can place the documentation in a Java comment (<span style="font-family:monospace">//</span> or <span style="font-family:monospace">/*...*/</span>) or in a
<a href="../api/org/checkerframework/framework/qual/CFComment.html"><span style="font-family:monospace">@CFComment</span></a> annotation.</p><p>Do not change the library’s code, which will change its behavior and make
the annotated version inconsistent with the unannotated version.
(Sometimes it is acceptable to make a refactoring, such as extracting an
expression into a new local variable in order to annotate its type or
suppress a warning. Perform refactoring only when you cannot use
<span style="font-family:monospace">@AssumeAssertion</span>.)
</p><p>Do not change publicly-visible documentation, such as Javadoc comments.
That also makes the annotated version inconsistent with the unannotated
version.</p><p>Do not change formatting and whitespace.</p><p>Any of these changes would increase the difference between upstream (the original
version) and your annotated version. Unnecessary differences make it harder for others to
understand what you have done, and they make it harder to pull changes from
upstream into the annotated library.</p>
<!--TOC subsection id="library-tips-specification" Library annotations should reflect the specification, not the implementation-->
<h3 id="library-tips-specification" class="subsection">34.1.2 Library annotations should reflect the specification, not the implementation <a href="#library-tips-specification"><img src="chainlink.svg" width="10" height="10"></a></h3><!--SEC END --><p>Publicly-visible annotations (including those on public method formal
parameters and return types) should be based on the
documentation, typically the method’s Javadoc.
In other words, your annotations should re-state facts that are in the Javadoc
documentation.</p><p>Do not add requirements or guarantees beyond what the library author has
already committed to. If a project’s Javadoc says nothing about nullness,
then you should not assume that the specification forbids or permits null.
(If the project’s Javadoc explicitly mentions null everywhere it is permitted,
then you can assume it is forbidden elsewhere, where the author omitted those
statements.)</p><p>If a fact is not mentioned in the documentation, then it is usually an
implementation detail. Clients should not depend on implementation
details, which are prone to change without notice.
(In some cases, you can infer some facts from the
implementation, such as that null is permitted for a method’s parameter or
return type if the implementation explicitly passes null to the method or
the method implementation returns null.)</p><p>If there is a fact that you think should be in the library’s documentation
but was unintentionally omitted by its authors, then please submit a bug
report asking them to update the documentation to reflect this fact. After
they do, you can also express the fact as an annotation.</p>
<!--TOC subsection id="library-tips-report-bugs" Report bugs upstream-->
<h3 id="library-tips-report-bugs" class="subsection">34.1.3 Report bugs upstream <a href="#library-tips-report-bugs"><img src="chainlink.svg" width="10" height="10"></a></h3><!--SEC END --><p>While annotating the library, you may discover bugs or missing/wrong
documentation. If you have a documentation improvement or a bug fix, then
open a pull request against the upstream version of the library. This will
benefit all users of the library. And, once the documentation is updated,
you will be able to add annotations that are consistent with the
documentation.</p>
<!--TOC subsection id="library-tips-fully-annotate" Fully annotate the library, or indicate which parts you did not-->
<h3 id="library-tips-fully-annotate" class="subsection">34.1.4 Fully annotate the library, or indicate which parts you did not <a href="#library-tips-fully-annotate"><img src="chainlink.svg" width="10" height="10"></a></h3><!--SEC END --><p>If you do not annotate all the files in the library, then use
<a href="../api/org/checkerframework/framework/qual/AnnotatedFor.html"><span style="font-family:monospace">@AnnotatedFor</span></a> to indicate what files you have
annotated.</p><p>Whenever you annotate any part of a file, fully annotate the file! That
is, write annotations for all the methods and fields, based on their
documentation. Here are reasons for this rule:</p><ul class="itemize"><li class="li-itemize">
If you annotate just part of the file, then users may be surprised that
calls to some methods type-check as expected whereas other methods do not
(because they have not been annotated).
</li><li class="li-itemize">Annotating one method or field at a time may lead to inconsistencies
between different parts of the file. Different people may make different
assumptions, might write annotations in a way that is locally convenient
but globally inconsistent, or might not read all the documentation of the
class to understand how it works.
</li><li class="li-itemize">It is not much more effort to annotate an entire class versus one method
or field. In either case it is usually necessary to understand the entire
class’s design and implementation. Once you have done that, you might as
well annotate the whole thing.
</li><li class="li-itemize">If you fully annotate the file, it is possible to type-check the library to
verify the annotations. (Even if you do not do this right now, it eases
the task in the future.)
</li></ul>
<!--TOC subsection id="library-tips-verify" Verify your annotations-->
<h3 id="library-tips-verify" class="subsection">34.1.5 Verify your annotations <a href="#library-tips-verify"><img src="chainlink.svg" width="10" height="10"></a></h3><!--SEC END --><p>Ideally, after you annotate a file, you should type-check the file to verify
the correctness and completeness of your annotations.</p><p>An alternative is to
only annotate method signatures. The alternative is quicker but more
error-prone. There is no difference from the point of view of clients,
who can only see annotations on public methods and fields. When you
compile the library, the type-checker will probably issue warnings; you can
supply <span style="font-family:monospace">-Awarns</span> so that the
compiler will still produce <span style="font-family:monospace">.class</span> files.</p>
<!--TOC section id="annotating-libraries-create" Creating an annotated library-->
<h2 id="annotating-libraries-create" class="section">34.2 Creating an annotated library <a href="#annotating-libraries-create"><img src="chainlink.svg" width="10" height="10"></a></h2><!--SEC END --><p>This section describes how to create an annotated library.</p><ol class="enumerate" type=1><li class="li-enumerate">
See the
<a href="https://search.maven.org/search?q=org.checkerframework.annotatedlib"><span style="font-family:monospace">org.checkerframework.annotatedlib</span>
group in the Maven Central Repository</a>
to find out whether an annotated version of the library already exists.
<ul class="itemize"><li class="li-itemize">
If it exists, but you want to add annotations for a different checker:<p>Clone its repository from <a href="https://github.com/typetools/"><span style="font-family:monospace">https://github.com/typetools/</span></a>, and tweak
its buildfile to run an additional checker.</p></li><li class="li-itemize">If it does not already exist:<p>Fork the project. (First, verify that its license permits forking.)</p><p>Add a line in its main README to indicate that this is an annotated
version of the library. That line should also indicate how to obtain
the corresponding upstream version (typically a git tag
<a href="https://htmlpreview.github.io/?https://github.com/eisop/checker-framework/master/docs/developer/developer-manual.html#annotated-library-version-numbers">corresponding
to a release</a>), so that others can see exactly what edits you have
made.</p><p>Adjust the library’s
build process, such as an Ant, Gradle, or Maven buildfile (for guidance,
see Chapter ‍<a href="#external-tools">37</a>).
Every time the build system runs the compiler, it should:
</p><ul class="itemize"><li class="li-itemize">
pass the <span style="font-family:monospace">-AuseConservativeDefaultsForUncheckedCode=source,bytecode</span>
command-line option and
</li><li class="li-itemize">run every pluggable type-checker for which any
annotations exist, using <span style="font-family:monospace">-processor
</span><span style="font-family:monospace"><em>TypeSystem1</em></span><span style="font-family:monospace">,</span><span style="font-family:monospace"><em>TypeSystem2</em></span><span style="font-family:monospace">,</span><span style="font-family:monospace"><em>TypeSystem3</em></span>
</li></ul><p>You are not adding new build targets, but modifying existing targets.
The reason to run every type-checker is to verify
the annotations you wrote, and to use appropriate defaults for all
unannotated type uses.
</p></li></ul></li><li class="li-enumerate">Annotate some files.
<p>When you annotate a file, annotate the whole thing, not just a few of its
methods. Add an
<a href="../api/org/checkerframework/framework/qual/AnnotatedFor.html"><span style="font-family:monospace">@AnnotatedFor</span></a><span style="font-family:monospace">(</span><span style="font-family:monospace">{</span><span style="font-family:monospace">"</span><span style="font-family:monospace"><em>checkername</em></span><span style="font-family:monospace">"</span><span style="font-family:monospace">}</span><span style="font-family:monospace">)</span>
annotation to each class declaration, or augment an existing <span style="font-family:monospace">@AnnotatedFor</span>
annotation.</p></li><li class="li-enumerate">Build the library.<p>Because of the changes that you made in step 1, this will run pluggable
type-checkers. If there are any compiler warnings, fix them and re-compile.</p><p>Now you have a <span style="font-family:monospace">.jar</span> file that you can use while type-checking and at
run time.</p></li><li class="li-enumerate">Tell other people about your work so that they can benefit from it.<ul class="itemize"><li class="li-itemize">
Please inform the Checker Framework developers
about your new annotated library by opening a pull request or an issue.
This will let us add your annotations to a repository in
<a href="https://github.com/typetools/"><span style="font-family:monospace">https://github.com/typetools/</span></a> and upload a compiled artifact to
the Maven Central Repository.</li><li class="li-itemize">Optionally, encourage the library’s maintainers to accept your annotations into its
main version control repository. This suggestion will be most
compelling if you have already reported bugs in the library that were
revealed by pluggable type-checking. Once the annotations are in the
main version control repository, they will be easier
to maintain, the library will obtain the correctness guarantees of
pluggable type-checking, and there will be no need
to distribute an annotated version of the library.<p>If the library maintainers do not accept the annotations, then
periodically, such as when a new version of the library is released,
pull changes from upstream (the library’s main version control system)
into your fork, add annotations to any newly-added methods in classes
that are annotated with <span style="font-family:monospace">@AnnotatedFor</span>, rebuild to create an updated
<span style="font-family:monospace">.jar</span> file, and inform the Checker Framework developers by opening an
issue or issuing a pull request.
</p></li></ul></li></ol>
<!--TOC section id="annotating-jdk" Creating an annotated JDK-->
<h2 id="annotating-jdk" class="section">34.3 Creating an annotated JDK <a href="#annotating-jdk"><img src="chainlink.svg" width="10" height="10"></a></h2><!--SEC END --><p>When you create a new checker, you need to also supply annotations for
parts of the JDK. You can do so either as stub files or in a copy of the
JDK source code, as described in Section ‍<a href="#creating-a-checker-annotated-jdk">35.10</a>.
Section ‍<a href="#reporting-bugs-annotated-libraries">39.2.1</a> tells how to improve
JDK annotations for an existing type system.</p>
<!--TOC section id="compiling-libraries" Compiling partially-annotated libraries-->
<h2 id="compiling-libraries" class="section">34.4 Compiling partially-annotated libraries <a href="#compiling-libraries"><img src="chainlink.svg" width="10" height="10"></a></h2><!--SEC END --><p>If you <em>completely</em> annotate a library, then you can compile it using a
pluggable type-checker. You get a guarantee that the library contains no
errors (that is, it is consistent with the specifications you wrote).</p><p>The rest of this section tells you how to compile a library if you
<em>partially</em> annotate it: that is, you write annotations for some of its
classes but not others.
(There is another type of partial annotation, which is when you annotate
method signatures but do not type-check the bodies.
See Section ‍<a href="#library-tips">34.1</a>.)</p><p>Here are two concerns you may have when partially annotating a library:</p><ul class="itemize"><li class="li-itemize">
Ignoring type-checking errors in unannotated parts of the library.
Use the <span style="font-family:monospace">-AskipDefs</span> or <span style="font-family:monospace">-AonlyDefs</span> command-line arguments; see
Section ‍<a href="#askipdefs">32.5</a>.</li><li class="li-itemize">Putting conservative annotations in unannotated parts of the library.
The checker needs to use normal defaulting rules
(Section ‍<a href="#climb-to-top">31.5.3</a>) for code you have annotated and conservative
defaulting rules (Section ‍<a href="#defaults-classfile">31.5.6</a>) for code you have not
yet annotated. This section describes how to do this. You use
<span style="font-family:monospace">@AnnotatedFor</span> to indicate which classes you have annotated.
</li></ul>
<!--TOC subsection id="AuseConservativeDefaultsForUncheckedCodesource" The <span style="font-family:monospace">-AuseConservativeDefaultsForUncheckedCode=source,bytecode</span> command-line argument-->
<h3 id="AuseConservativeDefaultsForUncheckedCodesource" class="subsection">34.4.1 The <span style="font-family:monospace">-AuseConservativeDefaultsForUncheckedCode=source,bytecode</span> command-line argument <a href="#AuseConservativeDefaultsForUncheckedCodesource"><img src="chainlink.svg" width="10" height="10"></a></h3><!--SEC END --><p>
When compiling a library that is not fully annotated, use command-line
argument <span style="font-family:monospace">-AuseConservativeDefaultsForUncheckedCode=source,bytecode</span>. This causes
the checker to behave normally for classes with a relevant <span style="font-family:monospace">@AnnotatedFor</span>
annotation. For classes without <span style="font-family:monospace">@AnnotatedFor</span>, the checker uses
conservative defaults
(see Section ‍<a href="#defaults-classfile">31.5.6</a>) for any type use with no explicit
user-written annotation, <em>and</em> the checker issues no warnings.
</p><p>The <a href="../api/org/checkerframework/framework/qual/AnnotatedFor.html"><span style="font-family:monospace">@AnnotatedFor</span></a> annotation, written on a
class, indicates that the class has been annotated for certain type
systems. For example, <span style="font-family:monospace">@AnnotatedFor(</span><span style="font-family:monospace">{</span><span style="font-family:monospace">"nullness", "regex"</span><span style="font-family:monospace">}</span><span style="font-family:monospace">)</span> means that
the programmer has written annotations for the Nullness and Regular
Expression type systems. If one of those two type-checkers is run,
the <span style="font-family:monospace">-AuseConservativeDefaultsForUncheckedCode=source,bytecode</span> command-line argument
has no effect and this class is treated normally:
unannotated types are defaulted using normal source-code
defaults and type-checking warnings are issued.
<a href="../api/org/checkerframework/framework/qual/AnnotatedFor.html"><span style="font-family:monospace">@AnnotatedFor</span></a>’s arguments are any string that
may be passed to the <span style="font-family:monospace">-processor</span> command-line argument: the
fully-qualified class name for the checker, or a shorthand for built-in
checkers (see Section ‍<a href="#shorthand-for-checkers">2.2.4</a>).
The argument to <a href="../api/org/checkerframework/framework/qual/AnnotatedFor.html"><span style="font-family:monospace">@AnnotatedFor</span></a> is not an
annotation name, but a checker name.
Writing <span style="font-family:monospace">@AnnotatedFor</span> on a class doesn’t necessarily mean that you wrote
any annotations, but that you examined the source code and verified
that all appropriate annotations are present.</p><p>
Whenever you compile a class using the Checker Framework, including when
using the <span style="font-family:monospace">-AuseConservativeDefaultsForUncheckedCode=source,bytecode</span> command-line
argument, the resulting <span style="font-family:monospace">.class</span> files are fully-annotated; each type use
in the <span style="font-family:monospace">.class</span> file has an explicit type qualifier for any checker that
is run.
</p>
<!--TOC section id="stub" Using stub classes-->
<h2 id="stub" class="section">34.5 Using stub classes <a href="#stub"><img src="chainlink.svg" width="10" height="10"></a></h2><!--SEC END --><p>You use a “stub file” to write annotations
for a library, when you cannot edit and recompile the library. A
checker uses the annotated signatures at compile time, instead of or in
addition to annotations that appear in the library’s <span style="font-family:monospace">.class</span> files.</p><p>A stub file cannot override the types of a package-private class, method, or field.</p><p>A stub class is Java source code that is allowed to omit certain parts,
such as method bodies. Section ‍<a href="#stub-format">34.5.4</a> describes
the stub file format.</p><p>Section ‍<a href="#annotating-jdk">34.3</a> explains how you should choose between
creating stub classes or creating an annotated library.
Section ‍<a href="#stub-creating">34.5.5</a> describes how to create stub classes.
Section ‍<a href="#stub-using">34.5.1</a> describes how to use stub classes.
These sections illustrate stub classes via the example of creating a <a href="../api/org/checkerframework/checker/interning/qual/Interned.html"><span style="font-family:monospace">@Interned</span></a>-annotated
version of <span style="font-family:monospace">java.lang.String</span>. You don’t need to repeat these steps
to handle <span style="font-family:monospace">java.lang.String</span> for the Interning Checker,
but you might do something similar for a different class and/or checker.</p><p>There are two types of annotation files, which are files containing annotations that
can be read by the Checker Framework.
This section describes stub files, which are used by programmers and
type system designers.
Section ‍<a href="#ajava-files">34.6</a> dscribes ajava files, which are used by
tools, such as type inference.</p>
<!--TOC subsection id="stub-using" Using a stub file-->
<h3 id="stub-using" class="subsection">34.5.1 Using a stub file <a href="#stub-using"><img src="chainlink.svg" width="10" height="10"></a></h3><!--SEC END --><p>The <span style="font-family:monospace">-Astubs</span> argument causes the Checker Framework to read
annotations from annotated stub classes in preference to the unannotated
original library classes. For example:</p><div style="font-size:x-small;">
<pre class="verbatim">  javac -processor org.checkerframework.checker.interning.InterningChecker \
    -Astubs=path/to/String.astub:stubs MyFile.java MyOtherFile.java ...
</pre>
</div><p>Each stub path entry is a stub file (ending with <span style="font-family:monospace">.astub</span>), directory, or
<span style="font-family:monospace">.jar</span> file; specifying a directory or <span style="font-family:monospace">.jar</span> file is
equivalent to specifying every file in it whose name ends with
<span style="font-family:monospace">.astub</span>. The stub path entries are delimited by
<span style="font-family:monospace">File.pathSeparator</span> (‘<span style="font-family:monospace">:</span>’ for Linux and Mac, ‘<span style="font-family:monospace">;</span>’ for Windows).</p><p>A checker automatically reads some of its own stub files, even without a
<span style="font-family:monospace">-Astubs</span> command-line argument; see
Section ‍<a href="#creating-a-checker-annotated-jdk">35.10</a>.</p><p>User-supplied stub files override a checker’s built-in stub files and the
annotated JDK.</p>
<!--TOC subsection id="stub-multiple-specifications" Multiple specifications for a method-->
<h3 id="stub-multiple-specifications" class="subsection">34.5.2 Multiple specifications for a method <a href="#stub-multiple-specifications"><img src="chainlink.svg" width="10" height="10"></a></h3><!--SEC END --><p>There are three possible sources of information for a given
element: source files, stub files, and bytecode files.
Usually source files take precedence over the other two,
and stub files take precedence over bytecode.
In other words:
</p><ul class="itemize"><li class="li-itemize">
If file <span style="font-family:monospace">A.java</span> is being compiled, then by default any stub for class
<span style="font-family:monospace">A</span> is ignored. See below for how to change this behavior and respect
both types of annotations.
</li><li class="li-itemize">An un-annotated type variable in a stub file is used instead of
annotations on a type variable in bytecode.
<br>
 Use the <span style="font-family:monospace">-AstubWarnIfRedundantWithBytecode</span> command-line option to get a
warning whenever a stub file specification is redundant with bytecode
annotations.
</li><li class="li-itemize">If a stub file does not mention a method or field (and no source is
available), its annotations are taken from bytecode.
</li></ul><p>If a method appears in more than one stub file (or twice in the same
stub file), then, for each type hierarchy, the last annotation read is used.</p><p>The annotated JDK is read as a stub file.
You can override JDK annotations by providing your own stub file.
If your stub file contains a JDK method <span style="font-family:monospace">m</span>, then no type annotations from
the JDK’s <span style="font-family:monospace">m</span> are used. If the JDK’s <span style="font-family:monospace">m</span> contains a declaration
annotation <span style="font-family:monospace">@D</span>, it is used unless your stub file contains a different
<span style="font-family:monospace">@D</span> annotation for <span style="font-family:monospace">m</span>.</p><p>The command-line option <span style="font-family:monospace">-AmergeStubsWithSource</span> tells the checker to use
both source files and stub files. The checker permits only values that are
permitted by <em>both</em> the source and stub annotations. (This is called
the greatest lower bound, or GLB, of the types.)</p><p>As an example of GLB, suppose the source annotation says the value is in
the range [1..20] and the stub file says the value is in the range
[11..30]. Since both sources of information are trusted, the value must be
in the range [11..20]. Equivalently, the GLB of
<a href="../api/org/checkerframework/common/value/qual/IntRange.html"><span style="font-family:monospace">@IntRange</span></a><span style="font-family:monospace">(from=1, to=20)</span> and
<a href="../api/org/checkerframework/common/value/qual/IntRange.html"><span style="font-family:monospace">@IntRange</span></a><span style="font-family:monospace">(from=11, to=30)</span> is
<a href="../api/org/checkerframework/common/value/qual/IntRange.html"><span style="font-family:monospace">@IntRange</span></a><span style="font-family:monospace">(from=11, to=20)</span>.
As another example, the GLB of
<a href="../api/org/checkerframework/checker/nullness/qual/KeyFor.html"><span style="font-family:monospace">@KeyFor</span></a><span style="font-family:monospace">({"map1", "map2"})</span> and
<a href="../api/org/checkerframework/checker/nullness/qual/KeyFor.html"><span style="font-family:monospace">@KeyFor</span></a><span style="font-family:monospace">({"map2", "map3"})</span> is
<a href="../api/org/checkerframework/checker/nullness/qual/KeyFor.html"><span style="font-family:monospace">@KeyFor</span></a><span style="font-family:monospace">({"map1", "map2", "map3"})</span>
since the value is known to be a key for all three maps.</p>
<!--TOC subsection id="stub-fake-override" Stub methods in subclasses of the declaring class-->
<h3 id="stub-fake-override" class="subsection">34.5.3 Stub methods in subclasses of the declaring class <a href="#stub-fake-override"><img src="chainlink.svg" width="10" height="10"></a></h3><!--SEC END --><p>Sometimes, a method’s return type is different in a subclass than in a
superclass, even though the subclass inherits (does not define) the method.
An example, <span style="font-family:monospace">SecureRandom.nextInt()</span>, is shown below.</p><p>To express that method <span style="font-family:monospace">m</span> has a different type in subclass <span style="font-family:monospace">Sub</span> than
where <span style="font-family:monospace">m</span> is defined, write a “fake override”: write the method in
class <span style="font-family:monospace">Sub</span> in a stub file. The Checker Framework will use that type for
<span style="font-family:monospace">m</span> at calls where the receiver’s declared type is <span style="font-family:monospace">Sub</span> or lower.</p><p>In a fake override of <span style="font-family:monospace">m</span>, the formal parameter Java types of the method
must be identical to those where <span style="font-family:monospace">m</span> is defined, but you can change its
annotations. (The return type and the receiver type can be different.)
If a fake override has no annotations on a given type use, that type use is
defaulted according to the usual defaulting rules.</p><p>This feature currently only works for return types. That is, a fake
override changes the return type at certain calls, but formal parameter
type annotations on fake overrides have no effect. Type annotations on
fake overrides of fields also have no effect. Fake overrides will be able
to change formal parameter and field type annotations in a future release
of the Checker Framework.</p>
<!--TOC paragraph id="stub-fake-override-example" Example-->
<h5 id="stub-fake-override-example" class="paragraph">Example <a href="#stub-fake-override-example"><img src="chainlink.svg" width="10" height="10"></a></h5><!--SEC END --><p>As an example, consider a type system that tracks whether a value is
cryptographically secure. <span style="font-family:monospace">@Secure</span> is a subtype of <span style="font-family:monospace">@Insecure</span>.
Although <span style="font-family:monospace">SecureRandom</span> does not override <span style="font-family:monospace">Random.nextInt</span> (it overrides
the source of randomness instead), you are allowed to write the following
stub file:</p><pre class="verbatim">package java.util;
class Random {
  @Insecure int nextInt();
}

package java.security;
class SecureRandom extends Random {
  @Secure int nextInt();
}
</pre><p>Client code behaves as follows:</p><pre class="verbatim">Random r = ...;
SecureRandom sr = ...;

@Secure int i1 = r.nextInt(); // error
@Secure int i2 = sr.nextInt(); // OK
</pre>
<!--TOC subsection id="stub-format" Stub file format-->
<h3 id="stub-format" class="subsection">34.5.4 Stub file format <a href="#stub-format"><img src="chainlink.svg" width="10" height="10"></a></h3><!--SEC END --><p>Every Java file is a valid stub file. However, you can omit information
that is not relevant to pluggable type-checking; this makes the stub file
smaller and easier for people to read and write.
Also note that the stub file’s extension must be <span style="font-family:monospace">.astub</span>, not <span style="font-family:monospace">.java</span>.</p><p>As an illustration, a stub file for the Interning type system
(Chapter ‍<a href="#interning-checker">6</a>) could be:</p><pre class="verbatim">  import org.checkerframework.checker.interning.qual.Interned;
  package java.lang;
  @Interned class Class&lt;T&gt; {}
  class String {
    @Interned String intern();
  }
</pre><p>The stub file format is allowed to differ from Java source code in the
following ways:
</p><dl class="description"><dt class="dt-description"></dt><dd class="dd-description"><span style="font-weight:bold">Method bodies:</span>
The stub class does not require method bodies for classes; any method
body may be replaced by a semicolon (<span style="font-family:monospace">;</span>), as in an interface or
abstract method declaration.</dd><dt class="dt-description"></dt><dd class="dd-description"><span style="font-weight:bold">Method declarations:</span>
You only have to specify the methods that you need to annotate.
Any method declaration may be omitted, in which case the checker reads
its annotations from library’s <span style="font-family:monospace">.class</span> files. (If you are using a stub class, then
typically the library is unannotated.)</dd><dt class="dt-description"></dt><dd class="dd-description"><span style="font-weight:bold">Declaration specifiers:</span>
Declaration specifiers (e.g., <span style="font-family:monospace">public</span>, <span style="font-family:monospace">final</span>, <span style="font-family:monospace">volatile</span>)
may be omitted.</dd><dt class="dt-description"></dt><dd class="dd-description"><span style="font-weight:bold">Return types:</span>
The return type of a method does not need to match the real method.
In particular, it is valid to use <span style="font-family:monospace">java.lang.Object</span> for every method.
This simplifies the creation of stub files.</dd><dt class="dt-description"></dt><dd class="dd-description"><span style="font-weight:bold">Import statements:</span>
Imports may appear at the beginning of the file or after any package declaration.
The only required import statements are the ones to import type
annotations. Import statements for types are optional.</dd><dt class="dt-description"></dt><dd class="dd-description"><span style="font-weight:bold">Multiple classes and packages:</span>
The stub file format permits having multiple classes and packages.
The packages are separated by a package statement:
<span style="font-family:monospace">package my.package;</span>. Each package declaration may occur only once; in
other words, all classes from a package must appear together.</dd></dl>
<!--TOC subsection id="stub-creating" Creating a stub file-->
<h3 id="stub-creating" class="subsection">34.5.5 Creating a stub file <a href="#stub-creating"><img src="chainlink.svg" width="10" height="10"></a></h3><!--SEC END -->
<!--TOC subsubsection id="stub-creating-with-source" If you have access to the Java source code-->
<h4 id="stub-creating-with-source" class="subsubsection">If you have access to the Java source code <a href="#stub-creating-with-source"><img src="chainlink.svg" width="10" height="10"></a></h4><!--SEC END --><p>Every Java file is a stub file. If you have access to the Java file,
copy file <span style="font-family:monospace">A.java</span> to <span style="font-family:monospace">A.astub</span>. You can add
annotations to the signatures, leaving the method bodies unchanged.
The stub file parser silently ignores any annotations that it cannot
resolve to a type, so don’t forget the <span style="font-family:monospace">import</span> statement.</p><p>Optionally (but highly recommended!), run the type-checker to verify that
your annotations are correct. When you run the type-checker on your
annotations, there should not be any stub file that also contains
annotations for the class. In particular, if you are type-checking the JDK
itself, then you should use the <span style="font-family:monospace">-Aignorejdkastub</span> command-line option.</p><p>This approach retains the original
documentation and source code, making it easier for a programmer to
double-check the annotations. It also enables creation of diffs, easing
the process of upgrading when a library adds new methods. And, the
annotations are in a format that the library maintainers can even
incorporate.</p><p>The downside of this approach is that the stub files are larger. This can
slow down the Checker Framework, because it parses the stub files each time
it runs.
</p><p>Alternatively, you can minimize source files to make them more suitable as stub files.
Use the <span style="font-family:monospace">JavaStubifier</span> to convert, in-place, all <span style="font-family:monospace">.java</span> files in given directories into
minimal stub files.</p><pre class="verbatim">  mkdir project-stubs
  cp -R project/src project-stubs
  java -cp $CHECKERFRAMEWORK/checker/dist/checker.jar org.checkerframework.framework.stub.JavaStubifier project-stubs
  find project-stubs -type f -name "*.java" -exec rename 's/.java$/.astub/' {} \;
</pre><p>Supply it a list of directories to process. Replacement happens in-place, so make sure to
process a copy of your sources.</p><p>You can now provide <span style="font-family:monospace">project-stubs</span> as a stub directory using <span style="font-family:monospace">-Astubs=project-stubs</span> as
an additional command-line option.</p><p>If you wish to use a single stub file, rather than a stub directory,
you can concatenate all the minimized <span style="font-family:monospace">.java</span> files into a single <span style="font-family:monospace">.astub</span> file:</p><pre class="verbatim">find project-stubs/ -name "*.java" -type f | xargs cat &gt; project.astub
</pre>
<!--TOC subsection id="stub-distributing" Distributing stub files-->
<h3 id="stub-distributing" class="subsection">34.5.6 Distributing stub files <a href="#stub-distributing"><img src="chainlink.svg" width="10" height="10"></a></h3><!--SEC END --><p>If you are writing stub files but are not writing a checker, you can place
the stub files anywhere that is convenient. However, please consider
providing your stub files to the checker author, so that other users can
also benefit from the stub files you wrote.</p><p>Stub files distributed with a checker appear in the same directory as the
checker implementation (the <span style="font-family:monospace">*Checker.java</span> file, see
Section ‍<a href="#creating-parts-of-a-checker">35.2</a>). For example, in the Checker
Framework they appear in files such as
</p><pre class="verbatim">checker/src/main/java/org/checkerframework/checker/regex/apache-xerces.astub
checker/src/main/java/org/checkerframework/checker/signature/javaparser.astub
</pre><p>If you are distributing stub files with a checker implementation, you must
configure your build system to copy the stub files into the distributed jar for
your checker. Here are instructions if you are using the Checker Framework
Gradle plugin:
</p><ul class="itemize"><li class="li-itemize">
If the stub files appear in the same directory as the checker class, which is
a subtype of <span style="font-family:monospace">BaseTypeChecker</span>, use the following build configuration:
<pre class="verbatim">  sourceSets {
    main {
        resources {
            srcDirs += ['src/main/java']
        }
    }
  }
</pre>
</li><li class="li-itemize">If the stub files appear under the <span style="font-family:monospace">src/main/resources/</span>
directory in a sub-directory matching the package of your checker class,
the default Gradle build configuration is sufficient.
</li></ul><p>
In either case, recall that a <a href="../api/org/checkerframework/framework/qual/StubFiles.html"><span style="font-family:monospace">@StubFiles</span></a>
annotation on the checker class lists stub files that are always used. For
stub files whose use is optional (for example, because the behavior is
unsound, or unsound except in certain circumstances), users must supply the
<span style="font-family:monospace">-Astubs=...</span> command-line option.</p><p>If a stub file contains annotations that are used by the framework rather
than by any specific checker (such as purity annotations), and you wish to
distribute it with the Checker Framework, put the stub file in directory
<span style="font-family:monospace">checker/resources/</span>. You can also do this if the stub file has
annotations for multiple checkers. To use a stub file in directory
<span style="font-family:monospace">checker/resources/</span>, users must supply the
<span style="font-family:monospace">-Astubs=checker.jar/stub-file-name.astub</span> command-line option.</p>
<!--TOC subsection id="stub-troubleshooting" Troubleshooting stub libraries-->
<h3 id="stub-troubleshooting" class="subsection">34.5.7 Troubleshooting stub libraries <a href="#stub-troubleshooting"><img src="chainlink.svg" width="10" height="10"></a></h3><!--SEC END -->
<!--TOC subsubsection id="stub-troubleshooting-type-checking-results" Type-checking does not yield the expected results-->
<h4 id="stub-troubleshooting-type-checking-results" class="subsubsection">Type-checking does not yield the expected results <a href="#stub-troubleshooting-type-checking-results"><img src="chainlink.svg" width="10" height="10"></a></h4><!--SEC END --><p>By default, the stub parser silently ignores
annotations on unknown classes and methods.
The stub parser also silently ignores unknown annotations, so don’t forget to
<span style="font-family:monospace">import</span> any annotations.
Some command-line options make the stub parser issue more warnings:</p><dl class="description"><dt class="dt-description">
<span style="font-weight:bold"><span style="font-family:monospace">-AstubWarnIfNotFound</span></span></dt><dd class="dd-description">
</dd><dt class="dt-description"><span style="font-weight:bold"><span style="font-family:monospace">-AstubNoWarnIfNotFound</span></span></dt><dd class="dd-description">
The Checker Framework can issue a “Type not found” warning
when a stub file contains a nonexistent
element, for example when the stub file mentions a method that the class
does not contain.
By default, the Checker Framework warns about such problems in a stub
file provided on the command line, but does not warn about built-in stub files.
These command-line options turn the warnings on or off (respectively) for
all stub files. <br>
 The <span style="font-family:monospace">@NoStubParserWarning</span> annotation on a package or type in a stub file
causes no warning to be issued for that package or type, regardless of
the command-line options.</dd><dt class="dt-description"><span style="font-weight:bold"><span style="font-family:monospace">-AstubWarnIfNotFoundIgnoresClasses</span></span></dt><dd class="dd-description">
Modifies the behavior of <span style="font-family:monospace">-AstubWarnIfNotFound</span>
to report only missing methods/fields, but ignore missing classes, even if
other classes from the same package are present.
Useful if a package spans more than one jar.</dd><dt class="dt-description"><span style="font-weight:bold"><span style="font-family:monospace">-AstubWarnIfRedundantWithBytecode</span></span></dt><dd class="dd-description">
Warn if a stub file entry is redundant with bytecode information. The
warning means that the stub file’s type is the same as the bytecode type,
so that entry in the stub file has no effect. You could remove the
entry in the stub file to make it shorter, or you could add an annotation
to the stub file to make the entry have an effect.</dd><dt class="dt-description"><span style="font-weight:bold"><span style="font-family:monospace">-AstubWarnNote</span></span></dt><dd class="dd-description">
Issue a “note”, not a warning, for the <span style="font-family:monospace">-AstubWarn*</span> command-line
arguments. A warning may prevents further compilation (depending on
whether the <span style="font-family:monospace">-Werror</span> command-line argument is passed), but a note permits
compilation to proceed.</dd></dl><p>Finally,
use command-line option <span style="font-weight:bold"><span style="font-family:monospace">-AstubDebug</span></span> to output debugging messages while
parsing stub files, including about unknown classes, methods, and
annotations. This overrides the <span style="font-family:monospace">@NoAnnotationFileParserWarning</span> annotation.</p>
<!--TOC subsubsection id="stub-troubleshooting-parsing" Problems parsing stub libraries-->
<h4 id="stub-troubleshooting-parsing" class="subsubsection">Problems parsing stub libraries <a href="#stub-troubleshooting-parsing"><img src="chainlink.svg" width="10" height="10"></a></h4><!--SEC END --><p>When using command-line option <span style="font-family:monospace">-AstubWarnIfNotFound</span>,
an error is issued if a stub file has a typo or the API method does not
exist.</p><p>Fix an error of the form
</p><pre class="verbatim">AnnotationFileParser: Method isLLowerCase(char) not found in type java.lang.Character
</pre><p>by removing the extra “L” in the method name.</p><p>Fix an error of the form
</p><pre class="verbatim">AnnotationFileParser: Method enableForegroundNdefPush(Activity,NdefPushCallback)
      not found in type android.nfc.NfcAdapter
</pre><p>by removing the method <span style="font-family:monospace">enableForgroundNdefPush(...)</span> from
the stub file, because it is not defined in class <span style="font-family:monospace">android.nfc.NfcAdapter</span>
in the version of the library you are using.</p>
<!--TOC section id="ajava-files" Ajava files-->
<h2 id="ajava-files" class="section">34.6 Ajava files <a href="#ajava-files"><img src="chainlink.svg" width="10" height="10"></a></h2><!--SEC END --><p>There are two types of annotation files, which are files containing annotations that
can be read by the Checker Framework.
Section ‍<a href="#stub">34.5</a> describes stub files, which are used by programmers and
type system designers.
This section dscribes ajava files.
Ajava files are read and written by tools, such as whole-program type
inference (see Section ‍<a href="#whole-program-inference">33.2</a>). This section about
ajava files is primarily of interest to the maintainers of such tools.</p><p>An ajava file is simply a valid Java source file.
The Checker Framework reads its annotations.
(This includes annotations that are written
on anonymous and local classes — annotations in such locations are ignored
in stub files.)</p>
<!--TOC subsection id="ajava-using" Using an Ajava file-->
<h3 id="ajava-using" class="subsection">34.6.1 Using an Ajava file <a href="#ajava-using"><img src="chainlink.svg" width="10" height="10"></a></h3><!--SEC END --><p>The <span style="font-family:monospace">-Aajava</span> command-line argument works like <span style="font-family:monospace">-Astubs</span> (see
Section ‍<a href="#stub-using">34.5.1</a>). It takes a colon-separated list of
files and directories containing ajava files, which end in the <span style="font-family:monospace">.ajava</span>
extension.</p><p>For example:</p><div style="font-size:x-small;">
<pre class="verbatim">  javac -processor org.checkerframework.checker.interning.InterningChecker \
    -Aajava=path/to/String.ajava:ajavadir MyFile.java MyOtherFile.java ...
</pre>
</div><p>If there’s an annotation in both a source file and the corresponding a
source file, the Checker Framework uses the greatest lower bound, as with
the <span style="font-family:monospace">-AmergeStubsWithSource</span> option.</p>
<!--TOC subsection id="ajava-corresponding" Corresponding source files and ajava files-->
<h3 id="ajava-corresponding" class="subsection">34.6.2 Corresponding source files and ajava files <a href="#ajava-corresponding"><img src="chainlink.svg" width="10" height="10"></a></h3><!--SEC END --><p>If the Checker Framework reads both a source file and an ajava file that
corresponds to it, then the source file and the ajava file must have a
specific relationship to one another, to prevent errors that could occur
due to mismatches.</p>
<!--TOC subsubsection id="ajava-file-name" Names of ajava files-->
<h4 id="ajava-file-name" class="subsubsection">Names of ajava files <a href="#ajava-file-name"><img src="chainlink.svg" width="10" height="10"></a></h4><!--SEC END --><p>The ajava file must either (1) be found below one of the arguments to
<span style="font-family:monospace">-Aajava</span>, in a subdirectory matching its package name, or (2) be
unambiguously specified directly with its full path. A pair of <span style="font-family:monospace">.ajava</span>
files are specified ambiguously if one of their fully-qualified names
is a substring of the other, and both are specified as <span style="font-family:monospace">.ajava</span> files (rather
than being found under directories). For example, if the <span style="font-family:monospace">-Aajava</span> argument
was <span style="font-family:monospace">-Aajava= ‍/foo/Bar.ajava: ‍/baz/foo/Bar.ajava</span>, the two <span style="font-family:monospace">.ajava</span> files
would be considered ambiguous and a <span style="font-family:monospace">ambiguous.ajava</span> warning would be issued.
Files found under a directory are always unambiguous, because their file structure
must match their package name; the solution to a <span style="font-family:monospace">ambiguous.ajava</span> warning is to
convert the specific files in the <span style="font-family:monospace">-Aajava</span> argument to directories.</p><p>The ajava file must be named
<span style="font-family:monospace">ClassName-checker.qualified.name.ajava</span> where
<span style="font-family:monospace">checker.qualified.name</span> is the fully qualified name of the checker that
the ajava file’s annotations belong to.</p><p>For example, an ajava file with
tainting annotations for a class <span style="font-family:monospace">outerpackage.innerpackage.MyClass</span> would
be located in a subdirectory <span style="font-family:monospace">outerpackage/innerpackage</span> and it would be
named
<span style="font-family:monospace">MyClass-org.checkerframework.checker.tainting.TaintingChecker.ajava</span>.</p>
<!--TOC subsubsection id="ajava-contents" Contents of an ajava file-->
<h4 id="ajava-contents" class="subsubsection">Contents of an ajava file <a href="#ajava-contents"><img src="chainlink.svg" width="10" height="10"></a></h4><!--SEC END --><p>The
ajava file must contain the same source code as the source file with the following exceptions:
</p><ul class="itemize"><li class="li-itemize">
The two may differ in annotations.
</li><li class="li-itemize">The two may have different import statements.
</li><li class="li-itemize">The ajava file may have explicit receivers where the source file
doesn’t. If a source file has a method declaration <span style="font-family:monospace">void
myMethod()</span>, the ajava file might contain <span style="font-family:monospace">void myMethod(MyClass
this)</span> or <span style="font-family:monospace">void myMethod(@Interned MyClass this)</span>.
</li><li class="li-itemize">The ajava file may have explicit type bounds that are implicit in the source file.
If a source file has a type argument <span style="font-family:monospace">?</span>,
the ajava file might contain <span style="font-family:monospace">? extends Object</span> or <span style="font-family:monospace">? extends
@Nullable Object</span>.
</li></ul>
<!--TOC subsubsection id="ajava-insert-annotations" Inserting annotations from ajava files-->
<h4 id="ajava-insert-annotations" class="subsubsection">Inserting annotations from ajava files <a href="#ajava-insert-annotations"><img src="chainlink.svg" width="10" height="10"></a></h4><!--SEC END --><p>The <span style="font-family:monospace">InsertAjavaAnnotations.java</span> program inserts annotations
from ajava files into Java files. This can be used to
insert the annotations inferred by whole program inference into the source code
of a program, similarly to the
<a href="https://eisop.github.io/afu/#insert-annotations-to-source"><span style="font-family:monospace">insert-annotations-to-source</span>
script</a> from the
<a href="https://eisop.github.io/afu/">Annotation
File Utilities project</a>.</p><p>Its arguments are a directory containing ajava files and a directory
containing Java files. The <span style="font-family:monospace">checker.jar</span> file must be in the classpath.
Here is an example invocation:
</p><pre class="verbatim">  java -cp $CHECKERFRAMEWORK/checker/dist/checker.jar \
    org.checkerframework.framework.ajava.InsertAjavaAnnoations \
    &lt;path-to-ajava-files&gt; &lt;path-to-java-files&gt;
</pre>
<!--TOC section id="libraries-troubleshooting" Troubleshooting/debugging annotated libraries-->
<h2 id="libraries-troubleshooting" class="section">34.7 Troubleshooting/debugging annotated libraries <a href="#libraries-troubleshooting"><img src="chainlink.svg" width="10" height="10"></a></h2><!--SEC END --><p>Sometimes, it may seem that a checker is treating a library as unannotated
even though the library has annotations. The compiler has a flag that
may help you in determining which library files are read.</p><dl class="description"><dt class="dt-description">
</dt><dd class="dd-description"><span style="font-family:monospace">-verbose</span>
Outputs info about compile phases — when the compiler
reads/parses/attributes/writes any file. Also outputs the classpath and
sourcepath paths.
</dd></dl><p>A syntax error in a stub file or the annotated JDK can lead to the file
being silently ignored. A typo in an annotation name, or a missing
<span style="font-family:monospace">import</span> statement, can lead to annotations being silently ignored.</p><hr>
<!--TOC chapter id="creating-a-checker" How to create a new checker-->
<h1 id="creating-a-checker" class="chapter">Chapter ‍35 How to create a new checker <a href="#creating-a-checker"><img src="chainlink.svg" width="10" height="10"></a></h1><!--SEC END --><p>
<a id="writing-a-checker"></a> </p><p>This chapter describes how to create a checker
— a type-checking compiler plugin that detects bugs or verifies their
absence. After a programmer annotates a program,
the checker verifies that the code is consistent
with the annotations.
If you only want to <em>use</em> a checker, you do not need to read this
chapter.
People who wish to edit the Checker Framework source code or
make pull requests should read the
<a href="https://htmlpreview.github.io/?https://github.com/eisop/checker-framework/master/docs/developer/developer-manual.html">Checker
Framework Developer Manual</a>.</p><p>Writing a simple checker is easy! For example, here is a complete, useful
type-checker:</p><pre class="verbatim">import java.lang.annotation.Documented;
import java.lang.annotation.Target;
import java.lang.annotation.ElementType;
import org.checkerframework.common.subtyping.qual.Unqualified;
import org.checkerframework.framework.qual.SubtypeOf;

@Documented
@Target({ElementType.TYPE_USE, ElementType.TYPE_PARAMETER})
@SubtypeOf(Unqualified.class)
public @interface Encrypted {}
</pre><p>This checker is so short because it builds on the Subtyping Checker
(Chapter ‍<a href="#subtyping-checker">28</a>).
See Section ‍<a href="#subtyping-example">28.2</a> for more details about this particular checker.
When you wish to create a new checker, it is often easiest to begin by
building it declaratively on top of the Subtyping Checker, and then return to
this chapter when you need more expressiveness or power than the Subtyping
Checker affords.</p><p>Three choices for creating your own checker are:
</p><ul class="itemize"><li class="li-itemize">
Customize an existing checker.
Checkers that are designed for extension include
the Subtyping Checker (Chapter ‍<a href="#subtyping-checker">28</a>),
the Accumulation Checker (Chapter ‍<a href="#accumulation-checker">36</a>),
the Fake Enumeration Checker (Chapter ‍<a href="#fenum-checker">9</a>),
and the Units Checker (Chapter ‍<a href="#units-checker">19</a>).
</li><li class="li-itemize">Follow the instructions in this chapter to create a checker from scratch.
This enables creation of checkers that are more powerful than customizing
an existing checker.
</li><li class="li-itemize">Copy and then modify a different existing checker — whether
one distributed with the Checker Framework or a third-party one.
You can get tangled up if you don’t fully understand
the subtleties of the existing checker that you are modifying.
Usually, it is easier to follow the instructions in this chapter.
(If you are going to copy a checker, one good choice to copy and modify
is the Regex Checker (Chapter ‍<a href="#regex-checker">13</a>). A bad choice is
the Nullness Checker (Chapter ‍<a href="#nullness-checker">3</a>),
which is more sophisticated than anything you want to start out building.)
</li></ul><p>You do not need all of the details in this chapter, at least at first.
In addition to reading this chapter of the manual, you may find it helpful
to examine the implementations of the checkers that are distributed with
the Checker Framework.
The Javadoc documentation of the framework and the checkers is in the
distribution and is also available online at
<a href="https://eisop.github.io/cf/api/"><span style="font-family:monospace">https://eisop.github.io/cf/api/</span></a>.</p><p>If you write a new checker and wish to advertise it to the world, let us
know so we can mention it in Chapter ‍<a href="#third-party-checkers">29</a>
or even include it in the Checker Framework distribution.</p>
<!--TOC section id="creating-tool-relationships" How checkers build on the Checker Framework-->
<h2 id="creating-tool-relationships" class="section">35.1 How checkers build on the Checker Framework <a href="#creating-tool-relationships"><img src="chainlink.svg" width="10" height="10"></a></h2><!--SEC END --><p>This table shows the relationship among tools that the Checker Framework
builds on or that are built on the Checker Framework.
You use the Checker Framework to build pluggable type systems, and the
Annotation File Utilities to manipulate <span style="font-family:monospace">.java</span> and <span style="font-family:monospace">.class</span> files.</p><div class="center">
<table border=1  style="border-spacing:0;" class="cellpadding1"><tr><td style="vertical-align:top;text-align:left;border:solid 1px;" ><div class="center">Subtyping </div><p>Checker</p></td><td style="vertical-align:top;text-align:left;border:solid 1px;" ><div class="center">Nullness </div><p>Checker</p></td><td style="vertical-align:top;text-align:left;border:solid 1px;" ><div class="center">Index </div><p>Checker</p></td><td style="vertical-align:top;text-align:left;border:solid 1px;" ><div class="center">Tainting </div><p>Checker</p></td><td style="vertical-align:top;text-align:left;border:solid 1px;" ><div class="center">…</div></td><td style="vertical-align:top;text-align:left;border:solid 1px;" ><div class="center">Your </div><p>Checker</p></td><td style="text-align:center;border:solid 1px;white-space:nowrap"  colspan=2>&nbsp;</td></tr>
<tr><td style="vertical-align:top;text-align:left;border:solid 1px;"  colspan=6><div class="center">Base Checker </div><p>(enforces subtyping rules)</p></td><td style="vertical-align:top;text-align:left;border:solid 1px;" ><div class="center">Type </div><p>inference</p></td><td style="vertical-align:top;text-align:left;border:solid 1px;" >Other <p>tools
</p></td></tr>
<tr><td style="vertical-align:top;text-align:left;border:solid 1px;"  colspan=6><div class="center">Checker Framework </div><p>(enables creation of pluggable type-checkers)</p></td><td style="vertical-align:top;text-align:left;border:solid 1px;"  colspan=2><div class="center"><a href="https://eisop.github.io/afu/">Annotation File Utilities</a> </div><p>(<span style="font-family:monospace">.java</span> ↔ <span style="font-family:monospace">.class</span> files)
</p></td></tr>
<tr><td style="vertical-align:top;text-align:left;border:solid 1px;"  colspan=8><div class="center"><a href="https://checkerframework.org/jsr308/">Java type annotations</a> syntax
and classfile format </div><p>(no built-in semantics) </p></td></tr>
</table>
</div><p>The Base Checker
(more precisely, the <a href="../api/org/checkerframework/common/basetype/BaseTypeChecker.html"><span style="font-family:monospace">BaseTypeChecker</span></a>)
enforces the standard subtyping rules.
The Subtyping Checker is a simple use of the Base Checker that supports
providing type qualifiers on the command line.
You usually want to build your checker on the Base Checker.</p>
<!--TOC section id="creating-parts-of-a-checker" The parts of a checker-->
<h2 id="creating-parts-of-a-checker" class="section">35.2 The parts of a checker <a href="#creating-parts-of-a-checker"><img src="chainlink.svg" width="10" height="10"></a></h2><!--SEC END --><p>The Checker Framework provides abstract base classes (default
implementations), and a specific checker overrides as little or as much of
the default implementations as necessary.
To simplify checker implementations, by default the Checker Framework
automatically discovers the parts of a checker by looking for specific files.
Thus, checker implementations follow a very formulaic structure.
To illustrate, a checker for MyProp must be laid out as follows:
</p><pre class="verbatim">myPackage/
  | qual/                               type qualifiers
  | MyPropChecker.java                  interface to the compiler
  | MyPropVisitor.java                  [optional] type rules
  | MyPropAnnotatedTypeFactory.java     [optional] type introduction and dataflow rules
</pre><p>
<span style="font-family:monospace">MyPropChecker.java</span> is occasionally optional, such as if you are
building on the Subtyping Checker. If you want to create an artifact
containing just the qualifiers (similar to the Checker Framework’s
<span style="font-family:monospace">checker-qual</span> artifact), you should put the <span style="font-family:monospace">qual/</span> directory in a
separate Maven module or Gradle subproject.</p><p>Sections ‍<a href="#creating-typequals">35.5</a>–<a href="#creating-dataflow">35.9</a> describe
the individual components of a type system as written using the Checker
Framework:</p><dl class="description"><dt class="dt-description"></dt><dd class="dd-description"><a href="#creating-typequals">35.5</a>
<span style="font-weight:bold">Type qualifiers and hierarchy.</span> You define the annotations for
the type system and the subtyping relationships among qualified types
(for instance, <span style="font-family:monospace">@NonNull Object</span> is a subtype of <span style="font-family:monospace">@Nullable
Object</span>). This is also where you specify the default annotation that
applies whenever the programmer wrote no annotation and no other defaulting
rule applies.</dd><dt class="dt-description"></dt><dd class="dd-description"><a href="#creating-compiler-interface">35.6</a>
<span style="font-weight:bold">Interface to the compiler.</span> The compiler interface indicates
which annotations are part of the type system, which command-line options
and <span style="font-family:monospace">@SuppressWarnings</span> annotations the checker recognizes, etc.</dd><dt class="dt-description"></dt><dd class="dd-description"><a href="#creating-extending-visitor">35.7</a>
<span style="font-weight:bold">Type rules.</span> You specify the type system semantics (type
rules), violation of which yields a type error. A type system has two types of
rules.
<ul class="itemize"><li class="li-itemize">
Subtyping rules related to the type hierarchy, such as that in every
assignment,
the type of the right-hand-side is a subtype of the type of the left-hand-side.
Your checker automatically inherits these subtyping rules from the Base
Checker (Chapter ‍<a href="#subtyping-checker">28</a>), so there is nothing for you to do.
</li><li class="li-itemize">Additional rules that are specific to your particular checker. For
example, in the Nullness type system, only references whose type is
<a href="../api/org/checkerframework/checker/nullness/qual/NonNull.html"><span style="font-family:monospace">@NonNull</span></a> may be dereferenced. You
write these additional rules yourself.
</li></ul></dd><dt class="dt-description"></dt><dd class="dd-description"><a href="#creating-type-introduction">35.8</a>
<span style="font-weight:bold">Type introduction rules.</span> You specify the type of some expressions where
the rules differ from the built-in framework rules.</dd><dt class="dt-description"></dt><dd class="dd-description"><a href="#creating-dataflow">35.9</a>
<span style="font-weight:bold">Dataflow rules.</span> These optional rules enhance flow-sensitive
type qualifier inference (also sometimes called “local variable type inference”).
</dd></dl>
<!--TOC section id="creating-compiling" Compiling and using a custom checker-->
<h2 id="creating-compiling" class="section">35.3 Compiling and using a custom checker <a href="#creating-compiling"><img src="chainlink.svg" width="10" height="10"></a></h2><!--SEC END --><p>You can place your checker’s source files wherever you like.
One choice is to write your checker in a fork of the Checker Framework
repository <a href="https://github.com/typetools/checker-framework"><span style="font-family:monospace">https://github.com/typetools/checker-framework</span></a>.
Another choice is to write it in a stand-alone repository. Here is a
template for a stand-alone repository:
<a href="https://github.com/typetools/templatefora-checker"><span style="font-family:monospace">https://github.com/typetools/templatefora-checker</span></a>; at that URL,
click the “Use this template” button.</p><p>Once your custom checker is written, using it is very similar to using a
built-in checker (Section ‍<a href="#running">2.2</a>):
simply pass the fully-qualified name of your <span style="font-family:monospace">BaseTypeChecker</span>
subclass to the <span style="font-family:monospace">-processor</span> command-line option:
</p><pre>
  javac -processor <span style="font-style:italic">mypackage.MyPropChecker</span> SourceFile.java
</pre><p>
Note that your custom checker’s
<span style="font-family:monospace">.class</span> files must be on the same path (the classpath or processorpath)
as the Checker Framework.
Invoking a custom checker that builds on
the Subtyping Checker is slightly different (Section ‍<a href="#subtyping-using">28.1</a>).</p>
<!--TOC section id="creating-tips" Tips for creating a checker-->
<h2 id="creating-tips" class="section">35.4 Tips for creating a checker <a href="#creating-tips"><img src="chainlink.svg" width="10" height="10"></a></h2><!--SEC END --><p>To make your job easier, we recommend that you build your type-checker
incrementally, testing at each phase rather than trying to build the whole
thing at once.</p><p>Here is a good way to proceed.</p><ol class="enumerate" type=1><li class="li-enumerate">
<a id="creating-tips-write-manual"></a>
Write the user manual. Do this before you start coding. The manual
explains the type system, what it guarantees, how to use it, etc., from
the point of view of a user. Writing the manual will help you flesh out
your goals and the concepts, which are easier to understand and change in
text than in an implementation.
Section ‍<a href="#creating-documenting-a-checker">35.13</a> gives a suggested structure
for the manual chapter, which will help you avoid omitting any parts.
Get feedback from someone else at this point to ensure that your manual
is comprehensible.<p>Once you have designed and documented the parts of your type system, you
should “play computer”, manually
type-checking some code according to the rules you defined.
During manual checking, ask
yourself what reasoning you applied, what information you needed, and
whether your written-down rules were sufficient.
It is more efficient to find problems now rather than after coding up
your design.</p></li><li class="li-enumerate"><a id="creating-tips-implement-qualifiers"></a>
Implement the type qualifiers and hierarchy
(Section ‍<a href="#creating-typequals">35.5</a>).<p>Write simple test cases that consist of only assignments,
to test your type hierarchy. For instance, if
your type hierarchy consists of a supertype <span style="font-family:monospace">@UnknownSign</span> and a subtype
<span style="font-family:monospace">@NonNegative</span>, then you could write a test case such as:</p><pre class="verbatim">  void testHierarchy(@UnknownSign int us, @NonNegative int nn) {
    @UnknownSign int a = us;
    @UnknownSign int b = nn;
    // :: error: (assignment.type.incompatible)
    @NonNegative int c = us;  // expected error on this line
    @NonNegative int d = nn;
  }
</pre><p>Type-check your test files using the Subtyping Checker
(Chapter ‍<a href="#subtyping-checker">28</a>).</p></li><li class="li-enumerate"><a id="creating-tips-implement-checker"></a>
Write the checker class itself
(Section ‍<a href="#creating-compiler-interface">35.6</a>).<p>Ensure that you can still type-check your test files and that the results
are the same. You will not use the Subtyping Checker any more; you will
call the checker directly, as in</p><pre class="verbatim">  javac -processor mypackage.MyChecker File1.java File2.java ...
</pre></li><li class="li-enumerate"><a id="creating-tips-test-infrastructure"></a>
Test infrastructure.
If your checker source code is in a clone of the Checker Framework
repository, integrate your checker with the Checker Framework’s Gradle
targets for testing (Section ‍<a href="#creating-testing-framework">35.11</a>). This
will make it much more convenient to run tests, and to ensure that they
are passing, as your work proceeds.</li><li class="li-enumerate">Annotate parts of the JDK, if relevant
(Section ‍<a href="#creating-a-checker-annotated-jdk">35.10</a>).<p>Write test cases for a few of the annotated JDK methods to ensure
that the annotations are being properly read by your checker.</p></li><li class="li-enumerate">Implement type rules, if any (Section ‍<a href="#creating-extending-visitor">35.7</a>).
(Some type systems need JDK annotations but don’t have any additional
type rules.)<p>Before implementing type rules (or any other code in your type-checker),
read the Javadoc to familiarize yourself with the utility routines in the
<span style="font-family:monospace">org.checkerframework.javacutil</span> package, especially
<a href="../api/org/checkerframework/javacutil/AnnotationBuilder.html"><span style="font-family:monospace">AnnotationBuilder</span></a>,
<a href="../api/org/checkerframework/javacutil/AnnotationUtils.html"><span style="font-family:monospace">AnnotationUtils</span></a>,
<a href="../api/org/checkerframework/javacutil/ElementUtils.html"><span style="font-family:monospace">ElementUtils</span></a>,
<a href="../api/org/checkerframework/javacutil/TreeUtils.html"><span style="font-family:monospace">TreeUtils</span></a>,
<a href="../api/org/checkerframework/javacutil/TypeAnnotationUtils.html"><span style="font-family:monospace">TypeAnnotationUtils</span></a>, and
<a href="../api/org/checkerframework/javacutil/TypesUtils.html"><span style="font-family:monospace">TypesUtils</span></a>.
You will learn how to access needed information and avoid
reimplementing existing functionality.</p><p>Write simple test cases to test the type rules, and ensure that the
type-checker behaves as expected on those test files.
For example, if your type system forbids indexing an array by a
possibly-negative value, then you would write a test case such as:</p><pre class="verbatim">  void testArrayIndexing(String[] myArray, @UnknownSign int us, @NonNegative int nn) {
    myArray[us];  // expected error on this line
    myArray[nn];
  }
</pre></li><li class="li-enumerate">Implement type introduction rules, if any (Section ‍<a href="#creating-type-introduction">35.8</a>).<p>Test your type introduction rules.
For example, if your type system sets the qualifier for manifest literal
integers and for array lengths, you would write a test case like the following:</p><pre class="verbatim">  void testTypeIntroduction(String[] myArray) {
    @NonNegative nn1 = -1;  // expected error on this line
    @NonNegative nn2 = 0;
    @NonNegative nn3 = 1;
    @NonNegative nn4 = myArray.length;
  }
</pre></li><li class="li-enumerate">Optionally, implement dataflow refinement rules
(Section ‍<a href="#creating-dataflow">35.9</a>).<p>Test them if you wrote any.
For instance, if after an arithmetic comparison, your type system infers
which expressions are now known to be non-negative, you could write a
test case such as:</p><pre class="verbatim">  void testDataflow(@UnknownSign int us, @NonNegative int nn) {
    @NonNegative nn2;
    nn2 = us;  // expected error on this line
    if (us &gt; j) {
      nn2 = us;
    }
    if (us &gt;= j) {
      nn2 = us;
    }
    if (j &lt; us) {
      nn2 = us;
    }
    if (j &lt;= us) {
      nn2 = us;
    }
    nn = us;  // expected error on this line
  }
</pre></li></ol>
<!--TOC section id="creating-typequals" Annotations: Type qualifiers and hierarchy-->
<h2 id="creating-typequals" class="section">35.5 Annotations: Type qualifiers and hierarchy <a href="#creating-typequals"><img src="chainlink.svg" width="10" height="10"></a></h2><!--SEC END --><p>A type system designer specifies the qualifiers in the type system (Section ‍<a href="#creating-define-type-qualifiers">35.5.1</a>)
and
the type hierarchy that relates them.
The type hierarchy — the subtyping relationships among the qualifiers —
can be defined either
declaratively via meta-annotations (Section ‍<a href="#creating-declarative-hierarchy">35.5.2</a>), or procedurally through
subclassing <a href="../api/org/checkerframework/framework/type/QualifierHierarchy.html"><span style="font-family:monospace">QualifierHierarchy</span></a> or
<a href="../api/org/checkerframework/framework/type/TypeHierarchy.html"><span style="font-family:monospace">TypeHierarchy</span></a> (Section ‍<a href="#creating-procedural-hierarchy">35.5.3</a>).</p>
<!--TOC subsection id="creating-define-type-qualifiers" Defining the type qualifiers-->
<h3 id="creating-define-type-qualifiers" class="subsection">35.5.1 Defining the type qualifiers <a href="#creating-define-type-qualifiers"><img src="chainlink.svg" width="10" height="10"></a></h3><!--SEC END --><p>Type qualifiers are defined as Java annotations. In Java, an
annotation is defined using the Java <span style="font-family:monospace">@interface</span> keyword.
Here is how to define a two-qualifier hierarchy:</p><pre class="verbatim">package mypackage.qual;
import java.lang.annotation.Documented;
import java.lang.annotation.ElementType;
import java.lang.annotation.Retention;
import java.lang.annotation.RetentionPolicy;
import java.lang.annotation.Target;
import org.checkerframework.framework.qual.DefaultQualifierInHierarchy;
import org.checkerframework.framework.qual.SubtypeOf;
/**
 * The run-time value of the integer is unknown.
 *
 * @checker_framework.manual #nonnegative-checker Non-Negative Checker
 */
@Documented
@Retention(RetentionPolicy.RUNTIME)
@Target({ElementType.TYPE_USE, ElementType.TYPE_PARAMETER})
@SubtypeOf({})
@DefaultQualifierInHierarchy
public @interface UnknownSign {}


package mypackage.qual;
import java.lang.annotation.Documented;
import java.lang.annotation.ElementType;
import java.lang.annotation.Retention;
import java.lang.annotation.RetentionPolicy;
import java.lang.annotation.Target;
import org.checkerframework.framework.qual.LiteralKind;
import org.checkerframework.framework.qual.SubtypeOf;
/**
 * Indicates that the value is greater than or equal to zero.
 *
 * @checker_framework.manual #nonnegative-checker Non-Negative Checker
 */
@Documented
@Retention(RetentionPolicy.RUNTIME)
@Target({ElementType.TYPE_USE, ElementType.TYPE_PARAMETER})
@SubtypeOf({UnknownSign.class})
public @interface NonNegative {}
</pre><p>The <a href="../api/org/checkerframework/framework/qual/SubtypeOf.html"><span style="font-family:monospace">@SubtypeOf</span></a> meta-annotation
indicates the parent in the type hierarchy.</p><p>The <a href="https://docs.oracle.com/en/java/javase/17/docs/api/java.base/java/lang/annotation/Target.html"><span style="font-family:monospace">@Target</span></a>
meta-annotation indicates where the annotation
may be written. All type qualifiers that users can write in source code should
have the value <span style="font-family:monospace">ElementType.TYPE_USE</span> and optionally with the additional value
of <span style="font-family:monospace">ElementType.TYPE_PARAMETER</span>, but no other <span style="font-family:monospace">ElementType</span> values.
</p><p>The qualifiers should be in a <span style="font-family:monospace">qual</span> subpackage of the type checker package —
by default, the checker reflectively determines the qualifiers and the only thing that matters for that is the package name.
As mentioned in creating-parts-of-a-checker, the files for that <span style="font-family:monospace">qual</span> package can be
either in a subdirectory or in a separate gradle module, depending on whether
they should be distributable separately.
The Checker Framework automatically treats any annotation that
is declared in the <span style="font-family:monospace">qual</span> package as a type qualifier.
(See Section <a href="#creating-indicating-supported-annotations">35.6.1</a> for more details.)
For example, the Nullness Checker’s source file is located at
<span style="font-family:monospace">.../nullness/NullnessChecker.java</span>. The <span style="font-family:monospace">@NonNull</span> qualifier is defined in
file <span style="font-family:monospace">.../nullness/qual/NonNull.java</span>.</p><p>Your type system should include a top qualifier and a bottom qualifier
(Section ‍<a href="#creating-bottom-and-top-qualifier">35.5.7</a>).
The top qualifier is conventionally named <span style="font-family:monospace"><em>CheckerName</em></span><span style="font-family:monospace">Unknown</span>.
Most type systems should also include a
polymorphic qualifier <span style="font-family:monospace">@Poly</span><span style="font-family:monospace"><em>MyTypeSystem</em></span>
(Section ‍<a href="#creating-declarative-hierarchy">35.5.2</a>).</p><p>One of the annotations must be meta-annotated with
<a href="../api/org/checkerframework/framework/qual/DefaultQualifierInHierarchy.html"><span style="font-family:monospace">@DefaultQualifierInHierarchy</span></a> or
<a href="../api/org/checkerframework/framework/qual/DefaultFor.html"><span style="font-family:monospace">@DefaultFor</span></a><span style="font-family:monospace">(TypeUseLocation.OTHERWISE)</span>.
It is usually easiest to make the top type be the default; this may or may
not be the correct default for the type system design.</p><p>Choose good names for the qualifiers, because users will write these in
their source code.
The Javadoc of every type qualifier should include a precise English
description and an example use of the qualifier.</p>
<!--TOC subsection id="creating-declarative-hierarchy" Declaratively defining the qualifier hierarchy-->
<h3 id="creating-declarative-hierarchy" class="subsection">35.5.2 Declaratively defining the qualifier hierarchy <a href="#creating-declarative-hierarchy"><img src="chainlink.svg" width="10" height="10"></a></h3><!--SEC END --><p>Declaratively, the type system designer uses two meta-annotations (written
on the declaration of qualifier annotations) to specify the qualifier
hierarchy.</p><ul class="itemize"><li class="li-itemize"><a href="../api/org/checkerframework/framework/qual/SubtypeOf.html"><span style="font-family:monospace">@SubtypeOf</span></a> denotes that a qualifier is a subtype of
another qualifier or qualifiers, specified as an array of class
literals. For example, for any type <span style="font-style:italic">T</span>,
<a href="../api/org/checkerframework/checker/nullness/qual/NonNull.html"><span style="font-family:monospace">@NonNull</span></a> <span style="font-style:italic">T</span> is a subtype of <a href="../api/org/checkerframework/checker/nullness/qual/Nullable.html"><span style="font-family:monospace">@Nullable</span></a> <span style="font-style:italic">T</span>:<pre class="verbatim">    @Target({ElementType.TYPE_USE, ElementType.TYPE_PARAMETER})
    @SubtypeOf( { Nullable.class } )
    public @interface NonNull {}
  </pre><p><a href="../api/org/checkerframework/framework/qual/SubtypeOf.html"><span style="font-family:monospace">@SubtypeOf</span></a> accepts multiple annotation classes as an argument,
permitting the type hierarchy to be an arbitrary DAG.</p><p>All type qualifiers, except for polymorphic qualifiers (see below and
also Section ‍<a href="#method-qualifier-polymorphism">30.2</a>), need to be
properly annotated with <a href="../api/org/checkerframework/framework/qual/SubtypeOf.html"><span style="font-family:monospace">SubtypeOf</span></a>.</p><p>The top qualifier is annotated with
<span style="font-family:monospace">@SubtypeOf( { } )</span>. The top qualifier is the qualifier that is
a supertype of all other qualifiers. For example, <a href="../api/org/checkerframework/checker/nullness/qual/Nullable.html"><span style="font-family:monospace">@Nullable</span></a>
is the top qualifier of the Nullness type system, hence is defined as:</p><pre class="verbatim">    @Target({ElementType.TYPE_USE, ElementType.TYPE_PARAMETER})
    @SubtypeOf( {} )
    public @interface Nullable {}
  </pre><p>
If the top qualifier of the hierarchy is the generic unqualified type
(this is not recommended!), then its children
will use <span style="font-family:monospace">@SubtypeOf(Unqualified.class)</span>. For an example, see the
<span style="font-family:monospace">Encrypted</span> type system of Section ‍<a href="#encrypted-example">28.2</a>.
</p></li><li class="li-itemize"><a href="../api/org/checkerframework/framework/qual/PolymorphicQualifier.html"><span style="font-family:monospace">@PolymorphicQualifier</span></a> denotes that a qualifier is a
polymorphic qualifier. For example:<pre class="verbatim">  import java.lang.annotation.ElementType;
  import java.lang.annotation.Target;
  import org.checkerframework.framework.qual.PolymorphicQualifier;

  @PolymorphicQualifier
  @Target({ElementType.TYPE_USE, ElementType.TYPE_PARAMETER})
  public @interface PolyNull {}
</pre><p>A polymorphic qualifier must not have
a <a href="../api/org/checkerframework/framework/qual/SubtypeOf.html"><span style="font-family:monospace">@SubtypeOf</span></a> meta-annotation nor be
mentioned in any other <a href="../api/org/checkerframework/framework/qual/SubtypeOf.html"><span style="font-family:monospace">@SubtypeOf</span></a>
meta-annotation.</p><p>For how to restrict instantiation, see Section ‍<a href="#qualifier-polymorphism-define-restrict">35.5.2</a>.
For a general description of polymorphic qualifiers, see
Section ‍<a href="#method-qualifier-polymorphism">30.2</a>.</p></li></ul><p>The declarative and procedural mechanisms for specifying the hierarchy can
be used together. If any of the annotations representing type qualifiers have elements, then
the relationships between those qualifiers must be defined procedurally.</p>
<!--TOC subsubsection id="qualifier-polymorphism-define-restrict" Restricting instantiation-->
<h4 id="qualifier-polymorphism-define-restrict" class="subsubsection">Restricting instantiation <a href="#qualifier-polymorphism-define-restrict"><img src="chainlink.svg" width="10" height="10"></a></h4><!--SEC END --><p>Sometimes, you wish to restrict how a polymorphic qualifier can be
instantiated. An example is the Signedness Checker
(Chapter ‍<a href="#signedness-checker">20</a>). Its two main qualifiers are
<a href="../api/org/checkerframework/checker/signedness/qual/Signed.html"><span style="font-family:monospace">@Signed</span></a> and
<a href="../api/org/checkerframework/checker/signedness/qual/Unsigned.html"><span style="font-family:monospace">@Unsigned</span></a>, and the top qualifier
(which should be rarely used) is
<a href="../api/org/checkerframework/checker/signedness/qual/UnknownSignedness.html"><span style="font-family:monospace">@UnknownSignedness</span></a>.</p><p>As described so far, there is no way for a programmer to require that two
method arguments have the same signedness type. Writing</p><pre class="verbatim">  void foo(@PolySigned Object a, @PolySigned Object b) { ... }
</pre><p>permits every invocation, because one of its instantiations is</p><pre class="verbatim">  void foo(@UnknownSignedness Object a, @UnknownSignedness Object b) { ... }
</pre><p>which is consistent with any two arguments, regardless of their signedness
type.</p><p>It is possible to permit only method calls whose arguments have exactly the
same type qualifier. This is enabled for an entire type system. To do so,
create a subclass of
<a href="../api/org/checkerframework/framework/type/poly/DefaultQualifierPolymorphism.html"><span style="font-family:monospace">DefaultQualifierPolymorphism</span></a>, override its
<span style="font-family:monospace">combine</span> method, and make method <span style="font-family:monospace">createQualifierPolymorphism</span> in the
type factory return an instance of the new subclass. The Signedness
Checker gives an example.</p><p>Changing the qualifier polymorphism allows a loophole: upcasts to top.
For example, the type system permits a call like</p><pre class="verbatim">  Objects.equals((@UnknownSignedness) mySigned, (@UnknownSignedness) myUnsigned)
</pre><p>A type system can forbid upcasts to top (including in assignments, not just
explicit casts) to close this loophole.</p><p>If you change the qualifier polymorphism, your type system may need class
qualifier polymorphism (see Section ‍<a href="#class-qualifier-polymorphism">30.3</a>).
And, you may need to suppress
false positive warnings within the body of methods whose formal parameter
types are annotated with the polymorphic qualifier (e.g.,
<a href="../api/org/checkerframework/checker/signedness/qual/PolySigned.html"><span style="font-family:monospace">@PolySigned</span></a>).</p>
<!--TOC subsection id="creating-procedural-hierarchy" Procedurally defining the qualifier hierarchy-->
<h3 id="creating-procedural-hierarchy" class="subsection">35.5.3 Procedurally defining the qualifier hierarchy <a href="#creating-procedural-hierarchy"><img src="chainlink.svg" width="10" height="10"></a></h3><!--SEC END --><p>The declarative syntax suffices for most cases. More complex type
hierarchies can be expressed by overriding, in your subclass of
<a href="../api/org/checkerframework/common/basetype/BaseAnnotatedTypeFactory.html"><span style="font-family:monospace">BaseAnnotatedTypeFactory</span></a>, either
<a href="../api/org/checkerframework/framework/type/AnnotatedTypeFactory.html#createQualifierHierarchy()"><span style="font-family:monospace">createQualifierHierarchy</span></a>
or <a href="../api/org/checkerframework/framework/type/AnnotatedTypeFactory.html#createTypeHierarchy()"><span style="font-family:monospace">createTypeHierarchy</span></a>
(typically only one of these needs to be overridden).</p><p>For more details, see the Javadoc of those methods and of the classes
<a href="../api/org/checkerframework/framework/type/QualifierHierarchy.html"><span style="font-family:monospace">QualifierHierarchy</span></a> and <a href="../api/org/checkerframework/framework/type/TypeHierarchy.html"><span style="font-family:monospace">TypeHierarchy</span></a>.</p><p>The <a href="../api/org/checkerframework/framework/type/QualifierHierarchy.html"><span style="font-family:monospace">QualifierHierarchy</span></a> class represents the qualifier hierarchy (not the
type hierarchy). A type-system designer may subclass
<a href="../api/org/checkerframework/framework/type/QualifierHierarchy.html"><span style="font-family:monospace">QualifierHierarchy</span></a> to express customized qualifier
relationships (e.g., relationships based on annotation
arguments).</p><p>The <a href="../api/org/checkerframework/framework/type/TypeHierarchy.html"><span style="font-family:monospace">TypeHierarchy</span></a> class represents the type hierarchy —
that is, relationships between
annotated types, rather than merely type qualifiers, e.g., <span style="font-family:monospace">@NonNull
Date</span> is a subtype of <span style="font-family:monospace">@Nullable Date</span>. The default <a href="../api/org/checkerframework/framework/type/TypeHierarchy.html"><span style="font-family:monospace">TypeHierarchy</span></a> uses
<a href="../api/org/checkerframework/framework/type/QualifierHierarchy.html"><span style="font-family:monospace">QualifierHierarchy</span></a> to determine all subtyping relationships.
The default <a href="../api/org/checkerframework/framework/type/TypeHierarchy.html"><span style="font-family:monospace">TypeHierarchy</span></a> handles
generic type arguments, array components, type variables, and
wildcards in a similar manner to the Java standard subtype
relationship but with taking qualifiers into consideration. Some type
systems may need to override that behavior. For instance, the Java
Language Specification specifies that two generic types are subtypes only
if their type arguments are identical: for example,
<span style="font-family:monospace">List&lt;Date&gt;</span> is not a subtype of <span style="font-family:monospace">List&lt;Object&gt;</span>, or of any other
generic <span style="font-family:monospace">List</span>.
(In the technical jargon, the generic arguments are “invariant” or “novariant”.)</p>
<!--TOC subsection id="creating-typesystem-defaults" Defining the default annotation-->
<h3 id="creating-typesystem-defaults" class="subsection">35.5.4 Defining the default annotation <a href="#creating-typesystem-defaults"><img src="chainlink.svg" width="10" height="10"></a></h3><!--SEC END --><p>A type system applies the default qualifier where the user has not written a
qualifier (and no other default qualifier is applicable), as explained in
Section ‍<a href="#defaults">31.5</a>.</p><p>The type system designer must specify the default annotation. The designer can specify the default annotation declaratively,
using the <a href="../api/org/checkerframework/framework/qual/DefaultQualifierInHierarchy.html"><span style="font-family:monospace">@DefaultQualifierInHierarchy</span></a>
meta-annotation.
Note that the default will apply to any source code that the checker reads,
including stub libraries, but will not apply to compiled <span style="font-family:monospace">.class</span>
files that the checker reads.</p><p>
Alternately, the type system designer may specify a default procedurally,
by calling the
<a href="../api/org/checkerframework/framework/type/GenericAnnotatedTypeFactory.html#addCheckedCodeDefaults(org.checkerframework.framework.util.defaults.QualifierDefaults)"><span style="font-family:monospace">GenericAnnotatedTypeFactory.addCheckedCodeDefaults</span></a>
method. You may do this even if you have declaratively defined the
qualifier hierarchy.
</p><p>If the default qualifier in the type hierarchy requires a value, there are
ways for the type system designer to specify a default value both
declaratively and procedurally, as well. To do so declaratively, append
the string <span style="font-family:monospace">default </span><span style="font-family:monospace"><em>value</em></span> where <em>value</em> is the actual value
you want to be the default, after the declaration of the value in the
qualifier file. For instance, <span style="font-family:monospace">int value() default 0;</span> would make
<span style="font-family:monospace">value</span> default to zero. Alternatively, the procedural method
described above can be used.</p><p>The default qualifier applies to most, but not all, unannotated types, Section ‍<a href="#climb-to-top">31.5.3</a>
other defaulting rules are automatically added to every checker. Also, Section ‍<a href="#defaults">31.5</a>
describes other meta-annotations used to specify default annotations.</p>
<!--TOC subsection id="creating-relevant-java-types" Relevant Java types-->
<h3 id="creating-relevant-java-types" class="subsection">35.5.5 Relevant Java types <a href="#creating-relevant-java-types"><img src="chainlink.svg" width="10" height="10"></a></h3><!--SEC END --><p>Sometimes, a checker only processes certain Java types. For example, the
<a href="#formatter-checker">Format String Checker</a> is relevant only to
<span style="font-family:monospace">CharSequence</span> and its subtypes such as <span style="font-family:monospace">String</span>.
The <a href="../api/org/checkerframework/framework/qual/RelevantJavaTypes.html"><span style="font-family:monospace">@RelevantJavaTypes</span></a>
annotation on the checker class indicates that its qualifiers may only be
written on those types and no others. All irrelevant types are defaulted to
the top annotation.</p>
<!--TOC subsection id="creating-do-not-re-use-type-qualifiers" Do not re-use type qualifiers-->
<h3 id="creating-do-not-re-use-type-qualifiers" class="subsection">35.5.6 Do not re-use type qualifiers <a href="#creating-do-not-re-use-type-qualifiers"><img src="chainlink.svg" width="10" height="10"></a></h3><!--SEC END --><p>Every annotation should belong to only one type system. No annotation
should be used by multiple type systems. This is true even of annotations
that are internal to the type system and are not intended to be written by
the programmer.</p><p>Suppose that you have two type systems that both use the same type
qualifier <span style="font-family:monospace">@Bottom</span>. In a client program, a use of type <span style="font-family:monospace">T</span> may require type
qualifier <span style="font-family:monospace">@Bottom</span> for one type system but a different qualifier for the other
type system. There is no annotation that a programmer can write to make
the program type-check under both type systems.</p><p>This also applies to type qualifiers that a programmer does not write,
because the compiler outputs <span style="font-family:monospace">.class</span> files that contain an explicit type
qualifier on every type — a defaulted or inferred type qualifier if the
programmer didn’t write a type qualifier explicitly.</p>
<!--TOC subsection id="creating-bottom-and-top-qualifier" Completeness of the qualifier hierarchy-->
<h3 id="creating-bottom-and-top-qualifier" class="subsection">35.5.7 Completeness of the qualifier hierarchy <a href="#creating-bottom-and-top-qualifier"><img src="chainlink.svg" width="10" height="10"></a></h3><!--SEC END --><p>When you define a type system, its qualifier hierarchy must be a
lattice: every set of qualifiers has a unique least upper bound and a unique
greatest lower bound. This implies that there must be a top qualifier that is a
supertype of all other qualifiers, and there must be a bottom qualifier that is a
subtype of all other qualifiers.
Furthermore, the top qualifier and bottom qualifier should be defined
specifically for the type system. Don’t reuse an existing qualifier from the
Checker Framework such as <span style="font-family:monospace">@Unqualified</span>.</p><p>It is possible that a single type-checker checks multiple qualifier hierarchies.
An example is the Nullness Checker, which has three separate qualifier
hierarchies, one each for
nullness, initialization, and map keys. In this case, each qualifier hierarchy
would have its own top qualifier and its own bottom qualifier; they don’t
all have to share a single top qualifier or a single bottom qualifier.</p>
<!--TOC paragraph id="creating-bottom-qualifier" Bottom qualifier-->
<h5 id="creating-bottom-qualifier" class="paragraph">Bottom qualifier <a href="#creating-bottom-qualifier"><img src="chainlink.svg" width="10" height="10"></a></h5><!--SEC END --><p>
Your qualifier hierarchy must have a bottom qualifier
— a qualifier that is a (direct or indirect) subtype of every other
qualifier.</p><p><span style="font-family:monospace">null</span> has the bottom type. Because the only value with type <span style="font-family:monospace">Void</span> is
<span style="font-family:monospace">null</span>, uses of the type <span style="font-family:monospace">Void</span> are also bottom.
(The only exception
is if the type system has special treatment for <span style="font-family:monospace">null</span> values, as the
Nullness Checker does. In that case, add the meta-annotation
<a href="../api/org/checkerframework/framework/qual/QualifierForLiterals.html"><span style="font-family:monospace">@QualifierForLiterals</span></a><span style="font-family:monospace">(LiteralKind.NULL)</span>
to the correct qualifier.)
This legal code
will not type-check unless <span style="font-family:monospace">null</span> has the bottom type:
</p><pre class="verbatim">&lt;T&gt; T f() {
    return null;
}
</pre><p>Some type systems have a special bottom type that is used <em>only</em> for
the <span style="font-family:monospace">null</span> value, and for dead code and other erroneous situations.
In this case, users should only write the bottom qualifier on explicit
bounds. In this case, the definition of the bottom qualifier should be
meta-annotated with:</p><pre class="verbatim">@Target({ElementType.TYPE_USE, ElementType.TYPE_PARAMETER})
@TargetLocations({TypeUseLocation.EXPLICIT_LOWER_BOUND, TypeUseLocation.EXPLICIT_UPPER_BOUND})
</pre><p>Furthermore, by convention the name of such a qualifier ends with “<span style="font-family:monospace">Bottom</span>”.</p><p>The hierarchy shown in Figure ‍<a href="#fig-initialization-hierarchy">3.5</a> lacks
a bottom qualifier, but the actual implementation does contain a (non-user-visible) bottom qualifier.</p>
<!--TOC paragraph id="creating-top-qualifier" Top qualifier-->
<h5 id="creating-top-qualifier" class="paragraph">Top qualifier <a href="#creating-top-qualifier"><img src="chainlink.svg" width="10" height="10"></a></h5><!--SEC END --><p>
Your qualifier hierarchy must have a top qualifier
— a qualifier that is a (direct or indirect) supertype of every other
qualifier.
Here is one reason.
The default type for local variables is the top
qualifier (that type is then flow-sensitively
refined depending on what values are stored in the local variable).
If there is no single top qualifier, then there is no
unambiguous choice to make for local variables.</p>
<!--TOC subsection id="expression-annotations" Annotations whose argument is a Java expression (dependent type annotations)-->
<h3 id="expression-annotations" class="subsection">35.5.8 Annotations whose argument is a Java expression (dependent type annotations)<a id="dependent-types"></a> <a href="#dependent-types"><img src="chainlink.svg" width="10" height="10"></a></h3><!--SEC END --><p>Sometimes, an annotation needs to refer to a Java expression.
Section ‍<a href="#java-expressions-as-arguments">31.8</a> gives examples of such
annotations and also explains what Java expressions can and cannot be
referred to.</p><p>This section explains how to implement a dependent type annotation.</p><p>A “dependent type annotation”
must have one attribute, <span style="font-family:monospace">value</span>, that is an
array of strings. The Checker Framework verifies that the annotation’s
arguments are valid expressions according to the rules of
Section ‍<a href="#java-expressions-as-arguments">31.8</a>. If
the expression is not valid, an error is issued and the string in the
annotation is changed to indicate that the expression is not valid.</p><p>The Checker Framework standardizes the expression strings. For example, a
field <span style="font-family:monospace">f</span> can be referred to as either “<span style="font-family:monospace">f</span>” or “<span style="font-family:monospace">this.f</span>”. If the
programmer writes “<span style="font-family:monospace">f</span>”, the Checker Framework treats it
as if the programmer had written “<span style="font-family:monospace">this.f</span>”.
An advantage of this canonicalization is
that comparisons, such as <span style="font-family:monospace">isSubtype</span>, can be implemented as string comparisons.</p><p>The Checker Framework viewpoint-adapts type annotations on method, constructor,
and field declarations at uses for those methods. For example, given the
following class</p><pre class="verbatim">class MyClass {
   Object field = ...;
   @Anno("this.field") Object field2 = ...;
}
</pre><p>
and assuming the variable <span style="font-family:monospace">myClass</span> is of type <span style="font-family:monospace">MyClass</span>, then the type of
<span style="font-family:monospace">myClass.field</span> is viewpoint-adapted to <span style="font-family:monospace">@Anno("myClass.field")</span>.</p><p>To use this built-in functionality, add a <a href="../api/org/checkerframework/framework/qual/JavaExpression.html"><span style="font-family:monospace">@JavaExpression</span></a> annotation
to any annotation element that should be interpreted as a Java expression. The type of the
element must be an array of Strings. If your checker requires special handling of Java expressions,
your checker implementation should override
<a href="../api/org/checkerframework/framework/type/GenericAnnotatedTypeFactory.html#createDependentTypesHelper()"><span style="font-family:monospace">GenericAnnotatedTypeFactory.createDependentTypesHelper</span></a>
to return a subclass of <span style="font-family:monospace">DependentTypesHelper</span>.</p><p>Given a specific expression in the program (of type Tree or Node), a
checker may need to obtain its canonical string representation. This
enables the checker to create an dependent type annotation that refers to
it, or to compare to the string expression of an existing expression
annotation.
To obtain the string, first create a
<a href="../api/org/checkerframework/dataflow/expression/JavaExpression.html"><span style="font-family:monospace">JavaExpression</span></a> object by calling
<a href="../api/org/checkerframework/dataflow/expression/JavaExpression.html#fromTree(com.sun.source.tree.ExpressionTree)"><span style="font-family:monospace">fromTree(
ExpressionTree)</span></a> or
<a href="../api/org/checkerframework/dataflow/expression/JavaExpression.html#fromNode(org.checkerframework.dataflow.cfg.node.Node)"><span style="font-family:monospace">fromNode(
Node)</span></a>.
Then, call <span style="font-family:monospace">toString()</span> on the <span style="font-family:monospace">JavaExpression</span> object.</p>
<!--TOC subsection id="repeatable-annotations" Repeatable annotations-->
<h3 id="repeatable-annotations" class="subsection">35.5.9 Repeatable annotations <a href="#repeatable-annotations"><img src="chainlink.svg" width="10" height="10"></a></h3><!--SEC END --><p>Some pre- and post-condition annotations that have multiple elements (that
is, annotations that take multiple arguments) should be repeatable, so that
programmers can specify them more than once. An example is
<a href="../api/org/checkerframework/checker/nullness/qual/EnsuresNonNullIf.html"><span style="font-family:monospace">@EnsuresNonNullIf</span></a>; it could not be
defined with each of its elements being a list, as (for example)
<a href="../api/org/checkerframework/checker/nullness/qual/KeyFor.html"><span style="font-family:monospace">@KeyFor</span></a> is.</p><p>Make an annotation <em>A</em> repeatable by defining a nested annotation (within
<em>A</em>’s definition) named <span style="font-family:monospace">List</span>, and writing
<span style="font-family:monospace">@Repeatable(</span><span style="font-family:monospace"><em>A</em></span><span style="font-family:monospace">.List.class)</span> on <em>A</em>’s definition.
</p>
<!--TOC section id="creating-compiler-interface" The checker class: Compiler interface-->
<h2 id="creating-compiler-interface" class="section">35.6 The checker class: Compiler interface <a href="#creating-compiler-interface"><img src="chainlink.svg" width="10" height="10"></a></h2><!--SEC END --><p>A checker’s entry point is a subclass of
<a href="../api/org/checkerframework/framework/source/SourceChecker.html"><span style="font-family:monospace">SourceChecker</span></a>, and is usually a direct subclass
of either <a href="../api/org/checkerframework/common/basetype/BaseTypeChecker.html"><span style="font-family:monospace">BaseTypeChecker</span></a> or
<a href="../api/org/checkerframework/framework/source/AggregateChecker.html"><span style="font-family:monospace">AggregateChecker</span></a>.
This entry
point, which we call the checker class, serves two
roles: an interface to the compiler and a factory for constructing
type-system classes.</p><p>Because the Checker Framework provides reasonable defaults, oftentimes the
checker class has no work to do. Here are the complete definitions of the
checker classes for the Interning Checker and the Nullness Checker:</p><pre class="verbatim">  package my.package;
  import org.checkerframework.common.basetype.BaseTypeChecker;
  @SupportedLintOptions({"dotequals"})
  public final class InterningChecker extends BaseTypeChecker {}

  package my.package;
  import org.checkerframework.common.basetype.BaseTypeChecker;
  @SupportedLintOptions({"flow", "cast", "cast:redundant"})
  public class NullnessChecker extends BaseTypeChecker {}
</pre><p>(The <a href="../api/org/checkerframework/framework/source/SupportedLintOptions.html"><span style="font-family:monospace">@SupportedLintOptions</span></a> annotation is
optional, and many checker classes do not have one.)</p><p>The checker class bridges between the Java compiler and the checker. It
invokes the type-rule check visitor on every Java source file being
compiled. The checker uses
<a href="../api/org/checkerframework/framework/source/SourceChecker.html#reportError(java.lang.Object,java.lang.String,java.lang.Object...)"><span style="font-family:monospace">SourceChecker.reportError</span></a>
and
<a href="../api/org/checkerframework/framework/source/SourceChecker.html#reportWarning(java.lang.Object,java.lang.String,java.lang.Object...)"><span style="font-family:monospace">SourceChecker.reportWarning</span></a>
to issue errors.</p><p>Also, the checker class follows the factory method pattern to
construct the concrete classes (e.g., visitor, factory) and annotation
hierarchy representation. It is a convention that, for
a type system named Foo, the compiler
interface (checker), the visitor, and the annotated type factory are
named as <span style="font-family:monospace">FooChecker</span>, <span style="font-family:monospace">FooVisitor</span>, and <span style="font-family:monospace">FooAnnotatedTypeFactory</span>.
<a href="../api/org/checkerframework/common/basetype/BaseTypeChecker.html"><span style="font-family:monospace">BaseTypeChecker</span></a> uses the convention to
reflectively construct the components. Otherwise, the checker writer
must specify the component classes for construction.</p><p>
A checker can customize the default error messages through a
<a href="https://docs.oracle.com/en/java/javase/17/docs/api/java.base/java/util/Properties.html"><span style="font-family:monospace">Properties</span></a>-loadable text file named
<span style="font-family:monospace">messages.properties</span> that appears in the same directory as the checker class.
The property file keys are the strings passed to <a href="../api/org/checkerframework/framework/source/SourceChecker.html#reportError(java.lang.Object,java.lang.String,java.lang.Object...)"><span style="font-family:monospace">reportError</span></a>
and
<a href="../api/org/checkerframework/framework/source/SourceChecker.html#reportWarning(java.lang.Object,java.lang.String,java.lang.Object...)"><span style="font-family:monospace">reportWarning</span></a>
(like <span style="font-family:monospace">"type.incompatible"</span>) and the values are the strings to be
printed (<span style="font-family:monospace">"cannot assign ..."</span>).
The <span style="font-family:monospace">messages.properties</span> file only need to mention the new messages that
the checker defines.
It is also allowed to override messages defined in superclasses, but this
is rarely needed.
Section ‍<a href="#compiler-message-keys">32.1.3</a> discusses best practices
when using a message key in a <span style="font-family:monospace">@SuppressWarnings</span> annotation.
</p>
<!--TOC subsection id="creating-indicating-supported-annotations" Indicating supported annotations-->
<h3 id="creating-indicating-supported-annotations" class="subsection">35.6.1 Indicating supported annotations <a href="#creating-indicating-supported-annotations"><img src="chainlink.svg" width="10" height="10"></a></h3><!--SEC END --><p>A checker must indicate the annotations that it supports (that make up its type
hierarchy).</p><p>By default, a checker supports all type annotations located in a
subdirectory called <span style="font-family:monospace">qual</span> that’s located in the same directory as the
checker (unless you are creating multiple distribution artifacts, one for your
checker and one for its qualifiers).
A type annotation is meta-annotated with either
<span style="font-family:monospace">@Target(ElementType.TYPE_USE)</span>
or
<span style="font-family:monospace">@Target(</span><span style="font-family:monospace">ElementType.TYPE_USE, ElementType.TYPE_PARAMETER</span><span style="font-family:monospace">)</span>.</p><p>To indicate support for annotations that are located outside of the <span style="font-family:monospace">qual</span>
subdirectory, annotations that have other <span style="font-family:monospace">ElementType</span> values,
checker writers can override the
<a href="../api/org/checkerframework/framework/type/AnnotatedTypeFactory.html#createSupportedTypeQualifiers()"><span style="font-family:monospace">createSupportedTypeQualifiers</span></a>
method (see its Javadoc for details).
It is required to define <span style="font-family:monospace">createSupportedTypeQualifiers</span> if you are mixing
qualifiers from multiple directories (including when extending an existing
checker that has its own qualifiers) and when using the Buck build tool,
whose class loader cannot find the qualifier directory.</p><p>An aggregate checker (which extends
<a href="../api/org/checkerframework/framework/source/AggregateChecker.html"><span style="font-family:monospace">AggregateChecker</span></a>) does not need to specify its
type qualifiers, but each of its component checkers should do so.</p>
<!--TOC subsection id="creating-bundling-multiple-checkers" Bundling multiple checkers-->
<h3 id="creating-bundling-multiple-checkers" class="subsection">35.6.2 Bundling multiple checkers <a href="#creating-bundling-multiple-checkers"><img src="chainlink.svg" width="10" height="10"></a></h3><!--SEC END --><p>Sometimes, multiple checkers work together and should always be run
together. There are two different ways to bundle multiple checkers
together, by creating either an “aggregate checker” or a “compound checker”.</p><ol class="enumerate" type=1><li class="li-enumerate">
An aggregate checker runs multiple independent, unrelated checkers. There
is no communication or cooperation among them.<p>The effect is the same as if a user passes
multiple processors to the <span style="font-family:monospace">-processor</span> command-line option.</p><p>For example, instead of a user having to run</p><pre class="verbatim">  javac -processor DistanceUnitChecker,VelocityUnitChecker,MassUnitChecker MyFile.java
</pre><p>the user can write</p><pre class="verbatim">  javac -processor MyUnitCheckers MyFile.java
</pre><p>if you define an aggregate checker class. Extend <a href="../api/org/checkerframework/framework/source/AggregateChecker.html"><span style="font-family:monospace">AggregateChecker</span></a> and override
the <span style="font-family:monospace">getSupportedTypeCheckers</span> method, like the following:</p><pre class="verbatim">  public class MyUnitCheckers extends AggregateChecker {
    protected Collection&lt;Class&lt;? extends SourceChecker&gt;&gt; getSupportedCheckers() {
      return Arrays.asList(DistanceUnitChecker.class,
                           VelocityUnitChecker.class,
                           MassUnitChecker.class);
    }
  }
</pre><p>An example of an aggregate checker is <a href="../api/org/checkerframework/checker/i18n/I18nChecker.html"><span style="font-family:monospace">I18nChecker</span></a>
(see Chapter ‍<a href="#i18n-checker">16.2</a>), which consists of
<a href="../api/org/checkerframework/checker/i18n/I18nSubchecker.html"><span style="font-family:monospace">I18nSubchecker</span></a> and
<a href="../api/org/checkerframework/checker/i18n/LocalizableKeyChecker.html"><span style="font-family:monospace">LocalizableKeyChecker</span></a>.</p></li><li class="li-enumerate">Use a compound checker to express dependencies among checkers. Suppose it
only makes sense to run MyChecker if MyHelperChecker has already been run;
that might be the case if MyHelperChecker computes some information that
MyChecker needs to use.<p>Override
<span style="font-family:monospace">MyChecker.</span><a href="../api/org/checkerframework/common/basetype/BaseTypeChecker.html#getImmediateSubcheckerClasses()"><span style="font-family:monospace">getImmediateSubcheckerClasses</span></a>
to return a list of the checkers that MyChecker depends on. Every one of
them will be run before MyChecker is run. One of MyChecker’s subcheckers
may itself be a compound checker, and multiple checkers may declare a
dependence on the same subchecker. The Checker Framework will run each
checker once, and in an order consistent with all the dependences.</p><p>A checker obtains information from its subcheckers (those that ran before
it) by querying their <a href="../api/org/checkerframework/framework/type/AnnotatedTypeFactory.html"><span style="font-family:monospace">AnnotatedTypeFactory</span></a> to
determine the types of variables. Obtain the <span style="font-family:monospace">AnnotatedTypeFactory</span> by
calling
<a href="../api/org/checkerframework/common/basetype/BaseTypeChecker.html#getTypeFactoryOfSubchecker(java.lang.Class)"><span style="font-family:monospace">getTypeFactoryOfSubchecker</span></a>.</p></li></ol>
<!--TOC subsection id="creating-providing-command-line-options" Providing command-line options-->
<h3 id="creating-providing-command-line-options" class="subsection">35.6.3 Providing command-line options <a href="#creating-providing-command-line-options"><img src="chainlink.svg" width="10" height="10"></a></h3><!--SEC END --><p>A checker can provide two kinds of command-line options:
boolean flags and
named string values (the standard annotation processor
options).</p>
<!--TOC subsubsection id="creating-providing-command-line-options-boolean-flags" Boolean flags-->
<h4 id="creating-providing-command-line-options-boolean-flags" class="subsubsection">Boolean flags <a href="#creating-providing-command-line-options-boolean-flags"><img src="chainlink.svg" width="10" height="10"></a></h4><!--SEC END --><p>To specify a simple boolean flag, add:</p><pre>
  <a href="../api/org/checkerframework/framework/source/SupportedLintOptions.html"><span style="font-family:monospace">@SupportedLintOptions</span></a>({"myflag"})
</pre><p>to your checker subclass.
The value of the flag can be queried using</p><pre class="verbatim">  checker.getLintOption("myflag", false)
</pre><p>The second argument sets the default value that should be returned.</p><p>To pass a flag on the command line, call javac as follows:</p><pre class="verbatim">  javac -processor mypackage.MyChecker -Alint=myflag
</pre>
<!--TOC subsubsection id="creating-providing-command-line-options-named-string-values" Named string values-->
<h4 id="creating-providing-command-line-options-named-string-values" class="subsubsection">Named string values <a href="#creating-providing-command-line-options-named-string-values"><img src="chainlink.svg" width="10" height="10"></a></h4><!--SEC END --><p>For more complicated options, one can use the standard
<span style="font-family:monospace">@SupportedOptions</span> annotation on the checker, as in:</p><pre>
  <a href="../api/org/checkerframework/framework/source/SupportedOptions.html"><span style="font-family:monospace">@SupportedOptions</span></a>({"myoption"})
</pre><p>The value of the option can be queried using</p><pre class="verbatim">  checker.getOption("myoption")
</pre><p>To pass an option on the command line, call javac as follows:</p><pre class="verbatim">  javac -processor mypackage.MyChecker -Amyoption=p1,p2
</pre><p>The value is returned as a single string and you have to perform the
required parsing of the option.</p>
<!--TOC section id="creating-extending-visitor" Visitor: Type rules-->
<h2 id="creating-extending-visitor" class="section">35.7 Visitor: Type rules <a href="#creating-extending-visitor"><img src="chainlink.svg" width="10" height="10"></a></h2><!--SEC END --><p>A type system’s rules define which operations on values of a
particular type are forbidden.
These rules must be defined procedurally, not declaratively.
Put them in a file <span style="font-family:monospace"><em>MyChecker</em></span><span style="font-family:monospace">Visitor.java</span> that extends
<a href="../api/org/checkerframework/common/basetype/BaseTypeVisitor.html"><span style="font-family:monospace">BaseTypeVisitor</span></a>.</p><p>BaseTypeVisitor performs type-checking at each node of a
source file’s AST. It uses the visitor design pattern to traverse
Java syntax trees as provided by Oracle’s
<a href="https://docs.oracle.com/en/java/javase/17/docs/api/jdk.compiler/module-summary.html">jdk.compiler
API</a>,
and it issues a warning (by calling
<a href="../api/org/checkerframework/framework/source/SourceChecker.html#reportError(java.lang.Object,java.lang.String,java.lang.Object...)"><span style="font-family:monospace">reportError</span></a>
or
<a href="../api/org/checkerframework/framework/source/SourceChecker.html#reportWarning(java.lang.Object,java.lang.String,java.lang.Object...)"><span style="font-family:monospace">reportWarning</span></a>)
whenever the type system is violated.</p><p>Most type-checkers
override only a few methods in <a href="../api/org/checkerframework/common/basetype/BaseTypeVisitor.html"><span style="font-family:monospace">BaseTypeVisitor</span></a>.
A checker’s visitor overrides one method in the base visitor for each special
rule in the type qualifier system.
The last line of the overridden version is
“<span style="font-family:monospace">return super.visit</span><span style="font-family:monospace"><em>TreeType</em></span><span style="font-family:monospace">(node, p);</span>”.
If the method didn’t raise any error,
the superclass implementation can perform standard checks.</p><p>By default, <a href="../api/org/checkerframework/common/basetype/BaseTypeVisitor.html"><span style="font-family:monospace">BaseTypeVisitor</span></a> performs subtyping checks that are
similar to Java subtype rules, but taking the type qualifiers into account.
<a href="../api/org/checkerframework/common/basetype/BaseTypeVisitor.html"><span style="font-family:monospace">BaseTypeVisitor</span></a> issues these errors:</p><ul class="itemize"><li class="li-itemize">invalid assignment (type.incompatible) for an assignment from
an expression type to an incompatible type. The assignment may be a
simple assignment, or pseudo-assignment like return expressions or
argument passing in a method invocation<p>In particular, in every assignment and pseudo-assignment, the
left-hand side of the assignment is a supertype of (or the same type
as) the right-hand side. For example, this assignment is not
permitted:</p><pre class="verbatim">    @Nullable Object myObject;
    @NonNull Object myNonNullObject;
    ...
    myNonNullObject = myObject;  // invalid assignment
  </pre></li><li class="li-itemize">invalid generic argument (type.argument.type.incompatible) when a type
is bound to an incompatible generic type variable</li><li class="li-itemize">invalid method invocation (method.invocation.invalid) when a
method is invoked on an object whose type is incompatible with the
method receiver type</li><li class="li-itemize">invalid overriding parameter type (override.parameter.invalid)
when a parameter in a method declaration is incompatible with that
parameter in the overridden method’s declaration</li><li class="li-itemize">invalid overriding return type (override.return.invalid) when the
return type in a method declaration is incompatible with the
return type in the overridden method’s declaration</li><li class="li-itemize">invalid overriding receiver type (override.receiver.invalid)
when a receiver in a method declaration is incompatible with that
receiver in the overridden method’s declaration</li></ul>
<!--TOC subsection id="creating-ast-traversal" AST traversal-->
<h3 id="creating-ast-traversal" class="subsection">35.7.1 AST traversal <a href="#creating-ast-traversal"><img src="chainlink.svg" width="10" height="10"></a></h3><!--SEC END --><p>The Checker Framework needs to do its own traversal of the AST even though
it operates as an ordinary annotation processor ‍[<a href="#JSR269">Dar06</a>]. Java
provides a visitor for Java code that is intended to be used by annotation
processors, but that visitor only
visits the public elements of Java code, such as classes, fields, methods,
and method arguments — it does not visit code bodies or various other
locations. The Checker Framework hardly uses the built-in visitor — as
soon as the built-in visitor starts to visit a class, then the Checker
Framework’s visitor takes over and visits all of the class’s source code.</p><p>Because there is no standard API for the AST of Java
code<sup><a id="text1" href="#note1">1</a></sup>, the Checker Framework uses
the javac implementation. This is why the Checker Framework is not deeply
integrated with Eclipse or IntelliJ IDEA, but runs as an external tool (see
Section ‍<a href="#eclipse">37.7</a>).</p>
<!--TOC subsection id="creating-avoid-hardcoding" Avoid hardcoding-->
<h3 id="creating-avoid-hardcoding" class="subsection">35.7.2 Avoid hardcoding <a href="#creating-avoid-hardcoding"><img src="chainlink.svg" width="10" height="10"></a></h3><!--SEC END --><p>If a method’s contract is expressible in the type system’s annotation
syntax, then you should write annotations, in a stub file or annotated JDK
(Chapter ‍<a href="#annotating-libraries">34</a>).</p><p>If the contract is not expressible, you can create a declaration
annotation, and your checker can treat methods with that annotation
specially. An example is the
<a href="../api/org/checkerframework/checker/formatter/qual/FormatMethod.html"><span style="font-family:monospace">@FormatMethod</span></a> annotation; see
Section ‍<a href="#formatter-FormatMethod">14.5</a>.</p><p>A final alternative is to write a type-checking rule for method invocation,
where your rule checks the (class and) name of the method
being called and then treats the method in a special way.</p>
<!--TOC section id="creating-type-introduction" Type factory: Type introduction rules-->
<h2 id="creating-type-introduction" class="section">35.8 Type factory: Type introduction rules <a href="#creating-type-introduction"><img src="chainlink.svg" width="10" height="10"></a></h2><!--SEC END --><p>The annotated type of expressions and types are defined via type introduction rules in the
type factory. For most expressions and types, these rules are the same regardless of the type system.
For example, the type of a method invocation expression is the return type of the invoked method,
viewpoint-adapted for the call site. The framework implements these rules so that all type systems
automatically use them. For other expressions, such as string literals, their (annotated) types depend
on the type system, so the framework provides way to specify what qualifiers should apply to these expressions.</p><p>Defaulting rules are type introduction rules for computing the annotated type for an unannotated type;
these rules are explained in Section ‍<a href="#creating-typesystem-defaults">35.5.4</a>. The meta-annotation <a href="../api/org/checkerframework/framework/qual/QualifierForLiterals.html"><span style="font-family:monospace">@QualifierForLiterals</span></a> can be written on an annotation
declaration to specify that the annotation should be applied to the type of literals listed in the
meta-annotation.</p>
<!--TOC subsection id="creating-procedurally-specifying-implicit-annotations" Procedurally specifying type introduction rules-->
<h3 id="creating-procedurally-specifying-implicit-annotations" class="subsection">35.8.1 Procedurally specifying type introduction rules <a href="#creating-procedurally-specifying-implicit-annotations"><img src="chainlink.svg" width="10" height="10"></a></h3><!--SEC END --><p>If the meta-annotations are not sufficiently expressive, then you
can write your own type introduction rules. There are three ways to do so.
Each makes changes to an <a href="../api/org/checkerframework/framework/type/AnnotatedTypeMirror.html"><span style="font-family:monospace">AnnotatedTypeMirror</span></a>,
which is the Checker Framework’s representation of an annotated type.</p><ol class="enumerate" type=1><li class="li-enumerate">
Define a subclass of
<a href="../api/org/checkerframework/framework/type/treeannotator/TreeAnnotator.html"><span style="font-family:monospace">TreeAnnotator</span></a>,
typically as a private inner class of your <span style="font-family:monospace">AnnotatedTypeFactory</span>.
There is a method of <span style="font-family:monospace">TreeAnnotator</span> for every AST node, and the visitor
has access to both the tree (the AST node) and its type. In your
subclass of <span style="font-family:monospace">AnnotatedTypeFactory</span>, override <span style="font-family:monospace">createTreeAnnotator</span> to
return a <span style="font-family:monospace">ListTreeAnnotator</span> containing that annotator, as in<pre class="verbatim">  @Override
  protected TreeAnnotator createTreeAnnotator() {
      return new ListTreeAnnotator(super.createTreeAnnotator(), new MyTreeAnnotator(this));
  }
</pre><p>(or put your TreeAnnotator first; several tree annotators are run by
default, and among them, <span style="font-family:monospace">PropagationTreeAnnotator</span>
adds annotations to <span style="font-family:monospace">AnnotatedTypeMirror</span>s that do not have an annotation,
but has no effect on those that have an annotation).</p></li><li class="li-enumerate">Define a subclass of a
<a href="../api/org/checkerframework/framework/type/typeannotator/TypeAnnotator.html"><span style="font-family:monospace">TypeAnnotator</span></a>,
typically as a private inner class of your <span style="font-family:monospace">AnnotatedTypeFactory</span>.
There is a method of <span style="font-family:monospace">TypeAnnotator</span> for every kind of type, and the
visitor has access to only the type. In your subclass of
<span style="font-family:monospace">AnnotatedTypeFactory</span>, override <span style="font-family:monospace">createTypeAnnotator</span> to return a
<span style="font-family:monospace">ListTypeAnnotator</span> containing that annotator, as in<pre class="verbatim">  @Override
  protected TypeAnnotator createTypeAnnotator() {
      return new ListTypeAnnotator(new MyTypeAnnotator(this), super.createTypeAnnotator());
  }
</pre><p>(or put your TypeAnnotator last).</p></li><li class="li-enumerate">Create a subclass of <a href="../api/org/checkerframework/framework/type/AnnotatedTypeFactory.html"><span style="font-family:monospace">AnnotatedTypeFactory</span></a> and
override two <span style="font-family:monospace">addComputedTypeAnnotations</span> methods:
<a href="../api/org/checkerframework/framework/type/AnnotatedTypeFactory.html#addComputedTypeAnnotations(com.sun.source.tree.Tree,org.checkerframework.framework.type.AnnotatedTypeMirror)"><span style="font-family:monospace">addComputedTypeAnnotations(Tree,AnnotatedTypeMirror)</span></a>
(or
<a href="../api/org/checkerframework/framework/type/GenericAnnotatedTypeFactory.html#addComputedTypeAnnotations(com.sun.source.tree.Tree,org.checkerframework.framework.type.AnnotatedTypeMirror,boolean)"><span style="font-family:monospace">addComputedTypeAnnotations(Tree,AnnotatedTypeMirror,boolean)</span></a>
if extending <span style="font-family:monospace">GenericAnnotatedTypeFactory</span>)
and
<a href="../api/org/checkerframework/framework/type/AnnotatedTypeFactory.html#addComputedTypeAnnotations(javax.lang.model.element.Element,org.checkerframework.framework.type.AnnotatedTypeMirror)"><span style="font-family:monospace">addComputedTypeAnnotations(Element,AnnotatedTypeMirror)</span></a>.
The methods can make arbitrary changes to the annotations on a type.<p>Recall that <span style="font-family:monospace">AnnotatedTypeFactory</span>, when given a program
expression, returns the expression’s type. This should include not only
the qualifiers that the programmer explicitly wrote in the source code, but
also default annotations and type
refinement (see Section ‍<a href="#effective-qualifier">31.4</a> for explanations of these
concepts).</p><p>The approach of overriding <span style="font-family:monospace">addComputedTypeAnnotations</span> is a last
resort, if your logic cannot be implemented using a TreeAnnotator or a
TypeAnnotator. The implementation of <span style="font-family:monospace">addComputedTypeAnnotations</span> in
<span style="font-family:monospace">GenericAnnotatedTypeFactory</span> calls the tree annotator and the type
annotator (in that order), but by overriding the method you can cause
your logic to be run even earlier or even later.</p></li></ol>
<!--TOC section id="creating-dataflow" Dataflow: enhancing flow-sensitive type refinement-->
<h2 id="creating-dataflow" class="section">35.9 Dataflow: enhancing flow-sensitive type refinement <a href="#creating-dataflow"><img src="chainlink.svg" width="10" height="10"></a></h2><!--SEC END --><p>By default, every checker performs flow-sensitive type refinement, as described
in Section ‍<a href="#type-refinement">31.7</a>.</p><p>This section of the manual explains how to enhance the Checker Framework’s
built-in type refinement.
Most commonly, you will inform the Checker Framework about a run-time test
that gives information about the type qualifiers in your type system.
Section ‍<a href="#type-refinement-runtime-tests">31.7.4</a> gives examples of
type systems with and without run-time tests.</p><p>The steps to customizing type refinement are:
</p><ol class="enumerate" type=1><li class="li-enumerate">
§<a href="#creating-dataflow-determine-expressions">35.9.1</a>
Determine which expressions will be refined.
</li><li class="li-enumerate">§<a href="#creating-dataflow-create-classes">35.9.2</a>
Create required class and configure its use.
</li><li class="li-enumerate">§<a href="#creating-dataflow-override-methods">35.9.3</a>
Override methods that handle <a href="../api/org/checkerframework/dataflow/cfg/node/Node.html"><span style="font-family:monospace">Node</span></a>s of interest.
</li><li class="li-enumerate">§<a href="#creating-dataflow-implement-refinement">35.9.4</a>
Implement the refinement.
</li></ol><p>The Regex Checker’s dataflow customization for the
<a href="../api/org/checkerframework/checker/regex/util/RegexUtil.html#asRegex(java.lang.String)"><span style="font-family:monospace">RegexUtil.asRegex</span></a>
run-time check is used as a running example.</p><p>If needed, you can find more details about the implementation of
type refinement, and the control flow graph (CFG) data
structure that it uses, in the
<a href="https://eisop.github.io/cf/manual/checker-framework-dataflow-manual.pdf">Dataflow
Manual</a>.</p>
<!--TOC subsection id="creating-dataflow-determine-expressions" Determine expressions to refine the types of-->
<h3 id="creating-dataflow-determine-expressions" class="subsection">35.9.1 Determine expressions to refine the types of <a href="#creating-dataflow-determine-expressions"><img src="chainlink.svg" width="10" height="10"></a></h3><!--SEC END --><p>A run-time check or run-time
operation involves multiple expressions (arguments, results).
Determine which expression the customization will refine. This is
usually specific to the type system and run-time test.
There is no code to write in this step; you are merely determining
the design of your type refinement.</p><p>For the program operation <span style="font-family:monospace">op(a,b)</span>, you can refine
the types in either or both of the following ways:
</p><ol class="enumerate" type=1><li class="li-enumerate">
Change the result type of the entire expression <span style="font-family:monospace">op(a,b)</span>.<p>As an example (and as the running example of implementing a dataflow
refinement), the <span style="font-family:monospace">RegexUtil.asRegex</span> method is declared as:</p><pre class="verbatim">  @Regex(0) String asRegex(String s, int groups) { ... }
</pre><p>This annotation is sound and conservative: it says that an expression such
as <span style="font-family:monospace">RegexUtil.asRegex(myString, myInt)</span> has type <span style="font-family:monospace">@Regex(0)
String</span>. However, this annotation is imprecise. When the <span style="font-family:monospace">group</span>
argument is known at compile time, a better estimate can be given. For
example, <span style="font-family:monospace">RegexUtil.asRegex(myString, 2)</span> has type <span style="font-family:monospace">@Regex(2)
String</span>.</p></li><li class="li-enumerate">Change the type of some other expression, such as <span style="font-family:monospace">a</span> or <span style="font-family:monospace">b</span>.<p>As an example, consider an equality test in the Nullness type system:</p><pre class="verbatim">  @Nullable String s;
    if (s != null) {
      ...
    } else {
      ...
    }
</pre><p>The type of <span style="font-family:monospace">s != null</span> is always <span style="font-family:monospace">boolean</span>. However, in the
true branch, the type of <span style="font-family:monospace">s</span> can be refined to <span style="font-family:monospace">@NonNull String</span>.</p></li></ol><p>If you are refining the types of arguments or the result of a method call,
then you may be able to implement your flow-sensitive refinement rules by
just writing <a href="../api/org/checkerframework/framework/qual/EnsuresQualifier.html"><span style="font-family:monospace">@EnsuresQualifier</span></a> and/or
<a href="../api/org/checkerframework/framework/qual/EnsuresQualifierIf.html"><span style="font-family:monospace">@EnsuresQualifierIf</span></a> annotations.
When this is possible, it is the best approach.</p><p>Sections ‍<a href="#creating-dataflow-create-classes">35.9.2</a>–<a href="#creating-dataflow-implement-refinement">35.9.4</a>
explain how to create a transfer class when the
<a href="../api/org/checkerframework/framework/qual/EnsuresQualifier.html"><span style="font-family:monospace">@EnsuresQualifier</span></a> and
<a href="../api/org/checkerframework/framework/qual/EnsuresQualifierIf.html"><span style="font-family:monospace">@EnsuresQualifierIf</span></a> annotations are insufficient.</p>
<!--TOC subsection id="creating-dataflow-create-classes" Create required class-->
<h3 id="creating-dataflow-create-classes" class="subsection">35.9.2 Create required class <a href="#creating-dataflow-create-classes"><img src="chainlink.svg" width="10" height="10"></a></h3><!--SEC END --><p>In the same directory as <span style="font-family:monospace"><em>MyChecker</em></span><span style="font-family:monospace">Checker.java</span>, create a class
named <span style="font-family:monospace"><em>MyChecker</em></span><span style="font-family:monospace">Transfer</span> that extends
<a href="../api/org/checkerframework/framework/flow/CFTransfer.html"><span style="font-family:monospace">CFTransfer</span></a>.</p><p>Leave the class body empty for now. Your class will add functionality by
overriding methods of <span style="font-family:monospace">CFTransfer</span>, which performs the default Checker
Framework type refinement.</p><p>As an example, the Regex Checker’s extended
<a href="../api/org/checkerframework/framework/flow/CFTransfer.html"><span style="font-family:monospace">CFTransfer</span></a> is
<a href="../api/org/checkerframework/checker/regex/RegexTransfer.html"><span style="font-family:monospace">RegexTransfer</span></a>.</p><p>(If you disregard the instructions above and choose a different name or a
different directory for your <span style="font-family:monospace"><em>MyChecker</em></span><span style="font-family:monospace">Transfer</span> class, you will
also need to override the <span style="font-family:monospace">createFlowTransferFunction</span> method in your type
factory to return a new instance of the class.)</p><p>(As a reminder, use of <a href="../api/org/checkerframework/framework/qual/EnsuresQualifier.html"><span style="font-family:monospace">@EnsuresQualifier</span></a> and
<a href="../api/org/checkerframework/framework/qual/EnsuresQualifierIf.html"><span style="font-family:monospace">@EnsuresQualifierIf</span></a> may obviate the need for
a transfer class.)</p>
<!--TOC subsection id="creating-dataflow-override-methods" Override methods that handle Nodes of interest-->
<h3 id="creating-dataflow-override-methods" class="subsection">35.9.3 Override methods that handle Nodes of interest <a href="#creating-dataflow-override-methods"><img src="chainlink.svg" width="10" height="10"></a></h3><!--SEC END --><p>Decide what source code syntax is relevant to the run-time checks or
run-time operations you are trying to support. The CFG (control flow
graph) represents source code as <a href="../api/org/checkerframework/dataflow/cfg/node/Node.html"><span style="font-family:monospace">Node</span></a>, a
node in the abstract syntax tree of the program being checked (see
Section ‍<a href="#creating-dataflow-representation">35.9.3</a>).</p><p>In your extended <a href="../api/org/checkerframework/framework/flow/CFTransfer.html"><span style="font-family:monospace">CFTransfer</span></a>
override the visitor method that handles the <a href="../api/org/checkerframework/dataflow/cfg/node/Node.html"><span style="font-family:monospace">Node</span></a>s
relevant to your run-time check or run-time operation.
Leave the body of the overriding method empty for now.</p><p>For example, the Regex Checker refines the type of a run-time test method
call. A method call is represented by a
<a href="../api/org/checkerframework/dataflow/cfg/node/MethodInvocationNode.html"><span style="font-family:monospace">MethodInvocationNode</span></a>. Therefore,
<a href="../api/org/checkerframework/checker/regex/RegexTransfer.html"><span style="font-family:monospace">RegexTransfer</span></a> overrides the
<span style="font-family:monospace">visitMethodInvocation</span> method:</p><pre class="verbatim">  public TransferResult&lt;CFValue, CFStore&gt; visitMethodInvocation(
    MethodInvocationNode n, TransferInput&lt;CFValue, CFStore&gt; in)  { ... }
</pre>
<!--TOC subsubsection id="creating-dataflow-representation" Program representation-->
<h4 id="creating-dataflow-representation" class="subsubsection">Program representation <a href="#creating-dataflow-representation"><img src="chainlink.svg" width="10" height="10"></a></h4><!--SEC END --><p>The <a href="../api/org/checkerframework/dataflow/cfg/node/Node.html"><span style="font-family:monospace">Node</span></a> subclasses can be found in the
<span style="font-family:monospace">org.checkerframework.dataflow.cfg.node</span> package. Some examples are
<a href="../api/org/checkerframework/dataflow/cfg/node/EqualToNode.html"><span style="font-family:monospace">EqualToNode</span></a>,
<a href="../api/org/checkerframework/dataflow/cfg/node/LeftShiftNode.html"><span style="font-family:monospace">LeftShiftNode</span></a>,
<a href="../api/org/checkerframework/dataflow/cfg/node/VariableDeclarationNode.html"><span style="font-family:monospace">VariableDeclarationNode</span></a>.</p><p>A <a href="../api/org/checkerframework/dataflow/cfg/node/Node.html"><span style="font-family:monospace">Node</span></a>
is basically equivalent to a javac compiler <a href="https://docs.oracle.com/en/java/javase/17/docs/api/jdk.compiler/com/sun/source/tree/Tree.html?is-external=true"><span style="font-family:monospace">Tree</span></a>.</p><p>See Section ‍<a href="#creating-javac-tips">35.14</a> for more information about <a href="https://docs.oracle.com/en/java/javase/17/docs/api/jdk.compiler/com/sun/source/tree/Tree.html?is-external=true"><span style="font-family:monospace">Tree</span></a>s.
As an example, the statement <span style="font-family:monospace">String a = "";</span> is represented as this
abstract syntax tree:
</p><pre class="verbatim">VariableTree:
  name: "a"
  type:
    IdentifierTree
      name: String
  initializer:
    LiteralTree
      value: ""
</pre>
<!--TOC subsection id="creating-dataflow-implement-refinement" Implement the refinement-->
<h3 id="creating-dataflow-implement-refinement" class="subsection">35.9.4 Implement the refinement <a href="#creating-dataflow-implement-refinement"><img src="chainlink.svg" width="10" height="10"></a></h3><!--SEC END --><p>
Each visitor method in <a href="../api/org/checkerframework/framework/flow/CFAbstractTransfer.html"><span style="font-family:monospace">CFAbstractTransfer</span></a>
returns a <a href="../api/org/checkerframework/dataflow/analysis/TransferResult.html"><span style="font-family:monospace">TransferResult</span></a>. A
<a href="../api/org/checkerframework/dataflow/analysis/TransferResult.html"><span style="font-family:monospace">TransferResult</span></a> represents the
refined information that is known after an operation. It has two
components: the result type for the <a href="../api/org/checkerframework/dataflow/cfg/node/Node.html"><span style="font-family:monospace">Node</span></a>
being evaluated, and a map from expressions in scope to estimates of their
types (a <a href="../api/org/checkerframework/dataflow/analysis/Store.html"><span style="font-family:monospace">Store</span></a>). Each of these components is
relevant to one of the two cases in
Section ‍<a href="#creating-dataflow-determine-expressions">35.9.1</a>:
</p><ol class="enumerate" type=1><li class="li-enumerate">

Changing the <a href="../api/org/checkerframework/dataflow/analysis/TransferResult.html"><span style="font-family:monospace">TransferResult</span></a>’s result type changes
the type that is returned by the <a href="../api/org/checkerframework/framework/type/AnnotatedTypeFactory.html"><span style="font-family:monospace">AnnotatedTypeFactory</span></a>
for the tree corresponding to the <a href="../api/org/checkerframework/dataflow/cfg/node/Node.html"><span style="font-family:monospace">Node</span></a> that was
visited. (Remember that <a href="../api/org/checkerframework/common/basetype/BaseTypeVisitor.html"><span style="font-family:monospace">BaseTypeVisitor</span></a> uses the
<a href="../api/org/checkerframework/framework/type/AnnotatedTypeFactory.html"><span style="font-family:monospace">AnnotatedTypeFactory</span></a> to look up the type of a
<a href="https://docs.oracle.com/en/java/javase/17/docs/api/jdk.compiler/com/sun/source/tree/Tree.html?is-external=true"><span style="font-family:monospace">Tree</span></a>, and then performs checks on types of one or more
<a href="https://docs.oracle.com/en/java/javase/17/docs/api/jdk.compiler/com/sun/source/tree/Tree.html?is-external=true"><span style="font-family:monospace">Tree</span></a>s.)
<p>For example, When <a href="../api/org/checkerframework/checker/regex/RegexTransfer.html"><span style="font-family:monospace">RegexTransfer</span></a> evaluates a
<span style="font-family:monospace">RegexUtils.asRegex</span> invocation, it updates the
<a href="../api/org/checkerframework/dataflow/analysis/TransferResult.html"><span style="font-family:monospace">TransferResult</span></a>’s result type. This changes the
type of the <span style="font-family:monospace">RegexUtils.asRegex</span> invocation when its
<a href="https://docs.oracle.com/en/java/javase/17/docs/api/jdk.compiler/com/sun/source/tree/Tree.html?is-external=true"><span style="font-family:monospace">Tree</span></a> is looked up by the
<a href="../api/org/checkerframework/framework/type/AnnotatedTypeFactory.html"><span style="font-family:monospace">AnnotatedTypeFactory</span></a>. See below for details.</p></li><li class="li-enumerate">Updating the <a href="../api/org/checkerframework/dataflow/analysis/Store.html"><span style="font-family:monospace">Store</span></a> treats an expression as
having a refined type for the remainder of the method or conditional block. For
example, when the Nullness Checker’s dataflow evaluates <span style="font-family:monospace">myvar != null</span>, it
updates the <a href="../api/org/checkerframework/dataflow/analysis/Store.html"><span style="font-family:monospace">Store</span></a> to specify that the variable
<span style="font-family:monospace">myvar</span> should be treated as having type <span style="font-family:monospace">@NonNull</span> for the rest of the
then conditional block. Not all kinds of expressions can be refined; currently
method return values, local variables, fields, and array values can be stored in
the <a href="../api/org/checkerframework/dataflow/analysis/Store.html"><span style="font-family:monospace">Store</span></a>. Other kinds of expressions, like
binary expressions or casts, cannot be stored in the
<a href="../api/org/checkerframework/dataflow/analysis/Store.html"><span style="font-family:monospace">Store</span></a>.</li></ol><p>
The rest of this section details implementing the visitor method
<span style="font-family:monospace">RegexTransfer.visitMethodInvocation</span> for the <span style="font-family:monospace">RegexUtil.asRegex</span>
run-time test. You can find other examples of visitor methods in
<a href="../api/org/checkerframework/checker/lock/LockTransfer.html"><span style="font-family:monospace">LockTransfer</span></a> and
<a href="../api/org/checkerframework/checker/formatter/FormatterTransfer.html"><span style="font-family:monospace">FormatterTransfer</span></a>.
</p><ol class="enumerate" type=1><li class="li-enumerate">
<span style="font-weight:bold">Determine if the visited </span><a href="../api/org/checkerframework/dataflow/cfg/node/Node.html"><span style="font-weight:bold"><span style="font-family:monospace">Node</span></span></a><span style="font-weight:bold"> is of
interest</span><p>A visitor method is invoked for all
instances of a given <a href="../api/org/checkerframework/dataflow/cfg/node/Node.html"><span style="font-family:monospace">Node</span></a> kind in the
program.
The visitor must inspect the
<a href="../api/org/checkerframework/dataflow/cfg/node/Node.html"><span style="font-family:monospace">Node</span></a> to determine if it is an
instance of the desired run-time test or operation. For example,
<span style="font-family:monospace">visitMethodInvocation</span> is called when dataflow processes any method
invocation, but the <a href="../api/org/checkerframework/checker/regex/RegexTransfer.html"><span style="font-family:monospace">RegexTransfer</span></a> should only refine
the result of <span style="font-family:monospace">RegexUtils.asRegex</span> invocations:</p><pre class="verbatim">  @Override
  public TransferResult&lt;CFValue, CFStore&gt; visitMethodInvocation(...)
    ...
    MethodAccessNode target = n.getTarget();
    ExecutableElement method = target.getMethod();
    Node receiver = target.getReceiver();
    if (receiver instanceof ClassNameNode) {
      String receiverName = ((ClassNameNode) receiver).getElement().toString();

      // Is this a call to static method isRegex(s, groups) in a class named RegexUtil?
      if (receiverName.equals("RegexUtil")
          &amp;&amp; ElementUtils.matchesElement(method,
                 "isRegex", String.class, int.class)) {
            ...
</pre></li><li class="li-enumerate"><span style="font-weight:bold">Determine the refined type</span><p>Sometimes the refined type is dependent on the parts of the operation,
such as arguments passed to it.</p><p>For example, the refined type of <span style="font-family:monospace">RegexUtils.asRegex</span> is dependent on the
integer argument to the method call. The <a href="../api/org/checkerframework/checker/regex/RegexTransfer.html"><span style="font-family:monospace">RegexTransfer</span></a>
uses this argument to build the resulting type <span style="font-family:monospace">@Regex(</span><span style="font-family:monospace"><em>i</em></span><span style="font-family:monospace">)</span>, where <span style="font-family:monospace"><em>i</em></span>
is the value of the integer argument. For simplicity the below code only uses
the value of the integer argument if the argument was an integer literal. It
could be extended to use the value of the argument if it was any compile-time
constant or was inferred at compile time by another analysis, such as the
Constant Value Checker (Chapter ‍<a href="#constant-value-checker">22</a>).</p><pre class="verbatim">  AnnotationMirror regexAnnotation;
  Node count = n.getArgument(1);
  if (count instanceof IntegerLiteralNode) {
    // argument is a literal integer
    IntegerLiteralNode iln = (IntegerLiteralNode) count;
    Integer groupCount = iln.getValue();
    regexAnnotation = factory.createRegexAnnotation(groupCount);
  } else {
    // argument is not a literal integer; fall back to @Regex(), which is the same as @Regex(0)
    regexAnnotation = AnnotationBuilder.fromClass(factory.getElementUtils(), Regex.class);
  }
</pre></li><li class="li-enumerate"><span style="font-weight:bold">Return a </span><a href="../api/org/checkerframework/dataflow/analysis/TransferResult.html"><span style="font-weight:bold"><span style="font-family:monospace">TransferResult</span></span></a><span style="font-weight:bold"> with the
refined types</span><p>Recall that the type of an expression is refined by modifying the
<a href="../api/org/checkerframework/dataflow/analysis/TransferResult.html"><span style="font-family:monospace">TransferResult</span></a> returned by a visitor method.
Since the <a href="../api/org/checkerframework/checker/regex/RegexTransfer.html"><span style="font-family:monospace">RegexTransfer</span></a> is updating the type of
the run-time test itself, it will update the result type and not the
<a href="../api/org/checkerframework/dataflow/analysis/Store.html"><span style="font-family:monospace">Store</span></a>.</p><p>A <a href="../api/org/checkerframework/framework/flow/CFValue.html"><span style="font-family:monospace">CFValue</span></a> is created to hold the type inferred.
<a href="../api/org/checkerframework/framework/flow/CFValue.html"><span style="font-family:monospace">CFValue</span></a> is a wrapper class for values being inferred
by dataflow:
</p><pre class="verbatim">  CFValue newResultValue = analysis.createSingleAnnotationValue(regexAnnotation,
      result.getResultValue().getType().getUnderlyingType());
</pre><p>Then, RegexTransfer’s <span style="font-family:monospace">visitMethodInvocation</span> creates and returns a
<a href="../api/org/checkerframework/dataflow/analysis/TransferResult.html"><span style="font-family:monospace">TransferResult</span></a> using <span style="font-family:monospace">newResultValue</span> as the
result type.</p><pre class="verbatim">  return new RegularTransferResult&lt;&gt;(newResultValue, result.getRegularStore());
</pre><p>As a result of this code, when the Regex Checker encounters a
<span style="font-family:monospace">RegexUtils.asRegex</span> method call, the checker will refine the return
type of the method if it can determine the value of the integer parameter
at compile time.</p></li></ol>
<!--TOC subsection id="creating-dataflow-disable" Disabling flow-sensitive inference-->
<h3 id="creating-dataflow-disable" class="subsection">35.9.5 Disabling flow-sensitive inference <a href="#creating-dataflow-disable"><img src="chainlink.svg" width="10" height="10"></a></h3><!--SEC END --><p>In the uncommon case that you wish to disable the Checker Framework’s
built-in flow inference in your checker (this is different than choosing
not to extend it as described in Section ‍<a href="#creating-dataflow">35.9</a>), put the
following two lines at the beginning of the constructor for your subtype of
<a href="../api/org/checkerframework/common/basetype/BaseAnnotatedTypeFactory.html"><span style="font-family:monospace">BaseAnnotatedTypeFactory</span></a>:</p><pre class="verbatim">        // disable flow inference
        super(checker, /*useFlow=*/ false);
</pre>
<!--TOC section id="creating-a-checker-annotated-jdk" Annotated JDK and other annotated libraries-->
<h2 id="creating-a-checker-annotated-jdk" class="section">35.10 Annotated JDK and other annotated libraries <a href="#creating-a-checker-annotated-jdk"><img src="chainlink.svg" width="10" height="10"></a></h2><!--SEC END --><p>You will need to supply annotations for relevant parts of the JDK;
otherwise, your type-checker may produce spurious warnings for code that
uses the JDK. You have two options:</p><ul class="itemize"><li class="li-itemize">
Write JDK annotations in a fork of
<a href="https://github.com/typetools/jdk"><span style="font-family:monospace">https://github.com/typetools/jdk</span></a>.<p>If your checker is written in a fork of
<a href="https://github.com/typetools/jdk"><span style="font-family:monospace">https://github.com/typetools/jdk</span></a>,
then use the same fork name (GitHub organization) and branch name;
this is necessary so that the CI jobs use the right annotated JDK.</p><p>Clone the JDK and the Checker Framework in the same place; that is, your
working copy of the JDK (a <span style="font-family:monospace">jdk</span> directory) should be a sibling of your
working copy of the Checker Framework (a <span style="font-family:monospace">checker-framework</span> directory).</p><p>Here are some tips:
</p><ul class="itemize"><li class="li-itemize">
Add
an <a href="../api/org/checkerframework/framework/qual/AnnotatedFor.html"><span style="font-family:monospace">@AnnotatedFor</span></a> annotation to each file you annotate.
</li><li class="li-itemize">Whenever you add a file, fully annotate it, as described in
Section ‍<a href="#library-tips">34.1</a>.
</li><li class="li-itemize">If you are only annotating fields and method signatures (but not
ensuring that method bodies type-check), then you don’t need to suppress
warnings, because the JDK is not type-checked.
</li></ul></li><li class="li-itemize">Write JDK annotations as stub files (partial Java source files).<p>Create a file <span style="font-family:monospace">jdk.astub</span> in
the checker’s main source directory. You can also create <span style="font-family:monospace">jdk</span><span style="font-family:monospace"><em>N</em></span><span style="font-family:monospace">.astub</span> files that contain methods
or classes that only exist in certain JDK versions.
The JDK stub files will be automatically used by the
checker, unless the user supplies the command-line option <span style="font-family:monospace">-Aignorejdkastub</span>.</p><p>You can also supply <span style="font-family:monospace">.astub</span> files in that directory for other libraries.
You should list those other libraries in a
<a href="../api/org/checkerframework/framework/qual/StubFiles.html"><span style="font-family:monospace">@StubFiles</span></a> annotation on the checker’s main
class, so that they will also be automatically used.</p><p>When a stub file should be used by multiple checkers (for example, if it
contains purity annotations that are needed by multiple distinct checkers),
the stub file should appear in directory <span style="font-family:monospace">checker/src/main/resources/</span>.
In the distribution, it will appear at the top level of the <span style="font-family:monospace">checker.jar</span> file.
It will not be used automatically; a user must pass the
<span style="font-family:monospace">-Astubs=checker.jar/</span><span style="font-family:monospace"><em>stubfilename.astub</em></span> command-line argument
(see Section ‍<a href="#annotated-libraries-using">2.2.1</a>)</p><p>While creating a stub file, you may find the debugging options described in
Section ‍<a href="#stub-troubleshooting">34.5.7</a> useful.</p></li></ul>
<!--TOC section id="creating-testing-framework" Testing framework-->
<h2 id="creating-testing-framework" class="section">35.11 Testing framework <a href="#creating-testing-framework"><img src="chainlink.svg" width="10" height="10"></a></h2><!--SEC END --><p>The Checker Framework provides a convenient way to write tests for your
checker. Each test case is a Java file, with inline indications of what
errors and warnings (if any) a checker should emit. An example is</p><pre class="verbatim">class MyNullnessTest {
  void method() {
    Object nullable = null;
    // :: error: (dereference.of.nullable)
    nullable.toString();
  }
}
</pre><p>When the Nullness Checker is run on the above code, it should produce
exactly one error, whose message key is <span style="font-family:monospace">dereference.of.nullable</span>, on
the line following the “// ::” comment.</p><p>The testing infrastructure is extensively documented in file <a href="https://github.com/typetools/checker-framework/blob/master/checker/tests/README"><span style="font-family:monospace">checker-framework/checker/tests/README</span></a>.</p><p>If your checker’s source code is within a fork of the Checker Framework
repository, then you can copy the testing infrastructure used by some
existing type system.</p>
<!--TOC section id="creating-debugging-options" Debugging options-->
<h2 id="creating-debugging-options" class="section">35.12 Debugging options <a href="#creating-debugging-options"><img src="chainlink.svg" width="10" height="10"></a></h2><!--SEC END --><p>The Checker Framework provides debugging options that can be helpful when
implementing a checker. These are provided via the standard <span style="font-family:monospace">javac</span> “<span style="font-family:monospace">-A</span>”
switch, which is used to pass options to an annotation processor.</p>
<!--TOC subsection id="creating-debugging-options-detail" Amount of detail in messages-->
<h3 id="creating-debugging-options-detail" class="subsection">35.12.1 Amount of detail in messages <a href="#creating-debugging-options-detail"><img src="chainlink.svg" width="10" height="10"></a></h3><!--SEC END --><ul class="itemize"><li class="li-itemize">
<span style="font-family:monospace">-AprintAllQualifiers</span>: print all type qualifiers, including
qualifiers meta-annotated with <span style="font-family:monospace">@InvisibleQualifier</span>, which are
usually not shown.</li><li class="li-itemize"><span style="font-family:monospace">-AprintVerboseGenerics</span>: print more information about type
parameters and wildcards when they appear in warning messages. Supplying
this also implies <span style="font-family:monospace">-AprintAllQualifiers</span>.</li><li class="li-itemize"><span style="font-family:monospace">-Anomsgtext</span>: use message keys (such as “<span style="font-family:monospace">type.invalid</span>”)
rather than full message text when reporting errors or warnings. This is
used by the Checker Framework’s own tests, so they do not need to be
changed if the English message is updated.</li><li class="li-itemize"><span style="font-family:monospace">-AnoPrintErrorStack</span>: don’t print a stack trace when an
internal Checker Framework error occurs. Setting this option is rare. You
should only do it if you have discovered a bug in a checker, you have
already reported the bug, and you want to continue using the checker on a
large codebase without being inundated in stack traces.</li><li class="li-itemize"><span style="font-family:monospace">-AnoWarnMemoryConstraints</span>: when memory constraints are
impeding performance, issue a note rather than a warning.
This prevents the message from being elevated to an error by <span style="font-family:monospace">-Werror</span>.</li><li class="li-itemize"><span style="font-family:monospace">-AdumpOnErrors</span>: Outputs a stack trace when reporting errors or warnings.</li></ul>
<!--TOC subsection id="creating-debugging-options-format" Format of output-->
<h3 id="creating-debugging-options-format" class="subsection">35.12.2 Format of output <a href="#creating-debugging-options-format"><img src="chainlink.svg" width="10" height="10"></a></h3><!--SEC END --><ul class="itemize"><li class="li-itemize"><span style="font-family:monospace">-Adetailedmsgtext</span>: Output error/warning messages in a
stylized format that is easy for tools to parse. This is useful for
tools that run the Checker Framework and parse its output, such as IDE
plugins. See the source code of <span style="font-family:monospace">SourceChecker.java</span> for details about
the format.</li></ul><p>The
<a href="https://github.com/eisopux/javac-diagnostics-wrapper">javac-diagnostic-wrapper</a>
tool can transform javac’s textual output into other formats, such as JSON
in LSP (Language Server Protocol) format.</p>
<!--TOC subsection id="creating-debugging-options-libraries" Stub and JDK libraries-->
<h3 id="creating-debugging-options-libraries" class="subsection">35.12.3 Stub and JDK libraries <a href="#creating-debugging-options-libraries"><img src="chainlink.svg" width="10" height="10"></a></h3><!--SEC END --><ul class="itemize"><li class="li-itemize"><span style="font-family:monospace">-Aignorejdkastub</span>:
ignore the <span style="font-family:monospace">jdk.astub</span> and <span style="font-family:monospace">jdk</span><span style="font-family:monospace"><em>N</em></span><span style="font-family:monospace">.astub</span> files in the checker directory. Files passed
through the <span style="font-family:monospace">-Astubs</span> option are still processed. This is useful
when experimenting with an alternative stub file.</li><li class="li-itemize"><span style="font-family:monospace">-ApermitMissingJdk</span>:
don’t issue an error if no annotated JDK can be found.</li><li class="li-itemize"><span style="font-family:monospace">-AparseAllJdk</span>:
parse all JDK files at startup rather than as needed.</li><li class="li-itemize"><span style="font-family:monospace">-AstubDebug</span>:
Print debugging messages while processing stub files.
Section ‍<a href="#stub-troubleshooting">34.5.7</a> describes more diagnostic command-line
arguments.</li></ul>
<!--TOC subsection id="creating-debugging-options-progress" Progress tracing-->
<h3 id="creating-debugging-options-progress" class="subsection">35.12.4 Progress tracing <a href="#creating-debugging-options-progress"><img src="chainlink.svg" width="10" height="10"></a></h3><!--SEC END --><ul class="itemize"><li class="li-itemize"><span style="font-family:monospace">-Afilenames</span>: print the name of each file before type-checking it.
This can be useful for determining that a long compilation job is making
progress.<p>This option can also help to keep a Travis CI job alive (since Travis CI
terminates any job that does not produce output for 10 minutes).
This does not work if you are using Maven, because it does not print
the full output of the Java compiler (see <a href="https://github.com/codehaus-plexus/plexus-compiler/issues/149"><span style="font-family:monospace">https://github.com/codehaus-plexus/plexus-compiler/issues/149</span></a>).
(Also, maven-compiler-plugin is buggy: it sometimes
doesn’t print any output if it cannot parse it.)
</p></li><li class="li-itemize"><span style="font-family:monospace">-Ashowchecks</span>: print debugging information for each
pseudo-assignment check (<span style="font-family:monospace">commonAssignmentCheck</span>) performed by
<a href="../api/org/checkerframework/common/basetype/BaseTypeVisitor.html"><span style="font-family:monospace">BaseTypeVisitor</span></a>; see
Section ‍<a href="#creating-extending-visitor">35.7</a>.</li><li class="li-itemize"><span style="font-family:monospace">-AshowInferenceSteps</span>: print debugging information
about intermediate steps in method type argument inference
(as performed by <a href="../api/org/checkerframework/framework/util/typeinference/DefaultTypeArgumentInference.html"><span style="font-family:monospace">DefaultTypeArgumentInference</span></a>).</li><li class="li-itemize"><span style="font-family:monospace">-AshowWpiFailedInferences</span>: print debugging information
about failed inference steps during whole-program inference. Must
be used with <span style="font-family:monospace">-Ainfer</span>; see Section ‍<a href="#whole-program-inference">33.2</a>.</li></ul>
<!--TOC subsection id="creating-debugging-options-output-args" Saving the command-line arguments to a file-->
<h3 id="creating-debugging-options-output-args" class="subsection">35.12.5 Saving the command-line arguments to a file <a href="#creating-debugging-options-output-args"><img src="chainlink.svg" width="10" height="10"></a></h3><!--SEC END --><ul class="itemize"><li class="li-itemize"><span style="font-family:monospace">-AoutputArgsToFile</span>:
This saves the final command-line parameters as passed to the compiler in a file.
The file can be used as a script to re-execute the same compilation command.
(The script file must be marked as executable on Unix, or
must have a <span style="font-family:monospace">.bat</span> extension on Windows.)
Example usage: <span style="font-family:monospace">-AoutputArgsToFile=$HOME/scriptfile</span><p>The <span style="font-family:monospace">-AoutputArgsToFile</span> command-line argument is processed by
<span style="font-family:monospace">CheckerMain</span>, not by the annotation processor. That means that it can be
supplied only when you use the Checker Framework compiler (the “Checker
Framework javac wrapper”), and it cannot be written in a file containing
command-line arguments passed to the compiler using the @argfile syntax.</p></li></ul>
<!--TOC subsection id="creating-debugging-dataflow-graph" Visualizing the dataflow graph-->
<h3 id="creating-debugging-dataflow-graph" class="subsection">35.12.6 Visualizing the dataflow graph <a href="#creating-debugging-dataflow-graph"><img src="chainlink.svg" width="10" height="10"></a></h3><!--SEC END --><p>To understand control flow in your program and the resulting type
refinement, you can create a graphical representation of the CFG.</p><p>Typical use is:</p><pre class="verbatim">javacheck -processor mypackage.MyProcessor -Aflowdotdir=. MyClass.java
for dotfile in *.dot; do dot -Tpdf -o "$dotfile.pdf" "$dotfile"; done
</pre><p>where the first command creates file <span style="font-family:monospace">MyClass.dot</span> that
represents the CFG, and the last command draws the CFG in a PDF file.
The <span style="font-family:monospace">dot</span> program is part of <a href="http://www.graphviz.org">Graphviz</a>.</p><p>Note that you can also convert the <span style="font-family:monospace">.dot</span> file to various other file formats using
the <span style="font-family:monospace">dot</span> program. The full list of supported file types can be found <a href="http://www.graphviz.org/doc/info/output.html">here</a>.</p><p>For example, to convert to SVG, use:</p><pre class="verbatim">dot -Tsvg &lt;file.dot&gt; -o &lt;file.svg&gt;
</pre><p>In the output, conditional basic blocks are represented as octagons with
two successors. Special basic blocks are represented as ovals (e.g., the
entry and exit point of the method).</p>
<!--TOC subsubsection id="creating-debugging-dataflow-graph-with-typechecker" Creating a CFG while running a type-checker-->
<h4 id="creating-debugging-dataflow-graph-with-typechecker" class="subsubsection">Creating a CFG while running a type-checker <a href="#creating-debugging-dataflow-graph-with-typechecker"><img src="chainlink.svg" width="10" height="10"></a></h4><!--SEC END --><p>To create a CFG while running a type-checker, use the following
command-line options. <br>
(See above for typical usage.)</p><ul class="itemize"><li class="li-itemize"><span style="font-family:monospace">-Aflowdotdir=</span><span style="font-family:monospace"><em>somedir</em></span>:
Specify directory for <span style="font-family:monospace">.dot</span> files visualizing the CFG.
Shorthand for<br>
 <span style="font-family:monospace">-Acfgviz=org.checkerframework.dataflow.cfg.DOTCFGVisualizer,outdir=</span><span style="font-family:monospace"><em>somedir</em></span>.
The directory must already exist.</li><li class="li-itemize"><span style="font-family:monospace">-Averbosecfg</span>:
Enable additional output in the CFG visualization.
Equivalent to passing <span style="font-family:monospace">verbose</span> to <span style="font-family:monospace">cfgviz</span>, e.g. as in
<span style="font-family:monospace">-Acfgviz=MyVisualizer,verbose</span></li><li class="li-itemize"><span style="font-family:monospace">-Acfgviz=</span><span style="font-family:monospace"><em>VizClassName</em></span><span style="font-family:monospace">[,</span><span style="font-family:monospace"><em>opts</em></span><span style="font-family:monospace">,...]</span>:
Mechanism to visualize the control flow graph (CFG) of
all the methods and code fragments
analyzed by the dataflow analysis (Section ‍<a href="#creating-dataflow">35.9</a>).
The graph also contains information about flow-sensitively refined
types of various expressions at many program points.<p>The argument is a comma-separated sequence of keys or key–value pairs.
The first argument is the fully-qualified name of the
<span style="font-family:monospace">org.checkerframework.dataflow.cfg.CFGVisualizer</span> implementation
that should be used. The remaining keys or key–value pairs are
passed to <span style="font-family:monospace">CFGVisualizer.init</span>. Supported keys include
</p><ul class="itemize"><li class="li-itemize">
<span style="font-family:monospace">verbose</span>
</li><li class="li-itemize"><span style="font-family:monospace">outdir</span> directory into which to write files
</li><li class="li-itemize"><span style="font-family:monospace">checkerName</span>
</li></ul></li></ul>
<!--TOC subsubsection id="creating-debugging-dataflow-graph-with-cfgvisualizelauncher" Creating a CFG by running CFGVisualizeLauncher-->
<h4 id="creating-debugging-dataflow-graph-with-cfgvisualizelauncher" class="subsubsection">Creating a CFG by running CFGVisualizeLauncher <a href="#creating-debugging-dataflow-graph-with-cfgvisualizelauncher"><img src="chainlink.svg" width="10" height="10"></a></h4><!--SEC END --><p>You can also use <a href="../api/org/checkerframework/dataflow/cfg/visualize/CFGVisualizeLauncher.html"><span style="font-family:monospace">CFGVisualizeLauncher</span></a> to generate a DOT
or String representation of the control flow graph of a given method in a given class.
The CFG is generated and output, but no dataflow analysis is performed.</p><ul class="itemize"><li class="li-itemize">With JDK 8:<pre class="verbatim">java -Xbootclasspath/p:$CHECKERFRAMEWORK/checker/dist/javac.jar \
  -cp $CHECKERFRAMEWORK/checker/dist/checker.jar \
  org.checkerframework.dataflow.cfg.visualize.CFGVisualizeLauncher \
  MyClass.java --class MyClass --method test --pdf
</pre></li><li class="li-itemize">With JDK 11 or later:<pre class="verbatim">java -cp $CHECKERFRAMEWORK/checker/dist/checker.jar \
  org.checkerframework.dataflow.cfg.visualize.CFGVisualizeLauncher \
  MyClass.java --class MyClass --method test --pdf
</pre></li></ul><p>The above command will generate the corresponding <span style="font-family:monospace">.dot</span> and <span style="font-family:monospace">.pdf</span> files for the
method <span style="font-family:monospace">test</span> in the class <span style="font-family:monospace">MyClass</span> in the project directory. If you run into
issues with the <span style="font-family:monospace">com.sun</span> packages not being exported for JDK 11+, add the <span style="font-family:monospace">---add-exports</span> flags
found in Section ‍<a href="#javac-jdk11-non-modularized">37.6.2</a> to the above command.</p><p>To generate a string representation of the graph to standard output,
remove <span style="font-family:monospace">--pdf</span> but add <span style="font-family:monospace">--string</span>. For example (with JDK 8):</p><pre class="verbatim">java -Xbootclasspath/p:$CHECKERFRAMEWORK/checker/dist/javac.jar \
  -cp $CHECKERFRAMEWORK/checker/dist/checker.jar \
  org.checkerframework.dataflow.cfg.visualize.CFGVisualizeLauncher \
  MyClass.java --class MyClass --method test --string
</pre><p>For more details about invoking
<a href="../api/org/checkerframework/dataflow/cfg/visualize/CFGVisualizeLauncher.html"><span style="font-family:monospace">CFGVisualizeLauncher</span></a>, run it with
no arguments.</p>
<!--TOC subsection id="creating-debugging-options-misc" Miscellaneous debugging options-->
<h3 id="creating-debugging-options-misc" class="subsection">35.12.7 Miscellaneous debugging options <a href="#creating-debugging-options-misc"><img src="chainlink.svg" width="10" height="10"></a></h3><!--SEC END --><ul class="itemize"><li class="li-itemize"><span style="font-family:monospace">-AresourceStats</span>:
Whether to output resource statistics at JVM shutdown.</li><li class="li-itemize"><span style="font-family:monospace">-AatfDoNotCache</span>:
If provided, the Checker Framework will not cache results but will
recompute them. This makes the Checker Framework run slower. If the
Checker Framework behaves differently with and without this flag, then
there is a bug in its caching code. Please report that bug.</li><li class="li-itemize"><span style="font-family:monospace">-AatfCacheSize</span>:
The size of the Checker Framework’s internal caches.
Ignored if <span style="font-family:monospace">-AatfDoNotCache</span> is provided.
Most users have no need to set this.</li></ul>
<!--TOC subsection id="creating-debugging-options-examples" Examples-->
<h3 id="creating-debugging-options-examples" class="subsection">35.12.8 Examples <a href="#creating-debugging-options-examples"><img src="chainlink.svg" width="10" height="10"></a></h3><!--SEC END --><p>The following example demonstrates how these options are used:</p><pre class="verbatim">$ javac -processor org.checkerframework.checker.interning.InterningChecker \
    docs/examples/InternedExampleWithWarnings.java -Ashowchecks -Anomsgtext -Afilenames

[InterningChecker] InterningExampleWithWarnings.java
 success (line  18): STRING_LITERAL "foo"
     actual: DECLARED @org.checkerframework.checker.interning.qual.Interned java.lang.String
   expected: DECLARED @org.checkerframework.checker.interning.qual.Interned java.lang.String
 success (line  19): NEW_CLASS new String("bar")
     actual: DECLARED java.lang.String
   expected: DECLARED java.lang.String
docs/examples/InterningExampleWithWarnings.java:21: (not.interned)
    if (foo == bar) {
            ^
 success (line  22): STRING_LITERAL "foo == bar"
     actual: DECLARED @org.checkerframework.checker.interning.qual.Interned java.lang.String
   expected: DECLARED java.lang.String
1 error
</pre>
<!--TOC subsection id="creating-debugging-options-external" Using an external debugger-->
<h3 id="creating-debugging-options-external" class="subsection">35.12.9 Using an external debugger <a href="#creating-debugging-options-external"><img src="chainlink.svg" width="10" height="10"></a></h3><!--SEC END --><p>You can use any standard debugger to observe the execution of your checker.</p><p>You can also set up remote (or local) debugging using the following command as a template:</p><pre class="verbatim">java -jar "$CHECKERFRAMEWORK/checker/dist/checker.jar" \
    -J-Xdebug -J-Xrunjdwp:transport=dt_socket,server=y,suspend=y,address=5005 \
    -processor org.checkerframework.checker.nullness.NullnessChecker \
    src/sandbox/FileToCheck.java

</pre>
<!--TOC section id="creating-documenting-a-checker" Documenting the checker-->
<h2 id="creating-documenting-a-checker" class="section">35.13 Documenting the checker <a href="#creating-documenting-a-checker"><img src="chainlink.svg" width="10" height="10"></a></h2><!--SEC END --><p>This section describes how to write a chapter for this manual that
describes a new type-checker. This is a prerequisite to having your
type-checker distributed with the Checker Framework, which is the best way
for users to find it and for it to be kept up to date with Checker
Framework changes. Even if you do not want your checker distributed with
the Checker Framework, these guidelines may help you write better
documentation.</p><p>When writing a chapter about a new type-checker, see the existing chapters
for inspiration. (But recognize that the existing chapters aren’t perfect:
maybe they can be improved too.)</p><p>A chapter in the Checker Framework manual should generally have the
following sections:</p><dl class="description"><dt class="dt-description"><span style="font-weight:bold">Chapter: Belly Rub Checker</span></dt><dd class="dd-description">
The text before the first section in the chapter should state the
guarantee that the checker provides and why it is important. It should
give an overview of the concepts. It should state how to run the checker.</dd><dt class="dt-description"><span style="font-weight:bold">Section: Belly Rub annotations</span></dt><dd class="dd-description">
This section includes descriptions of the annotations with links to the
Javadoc. Separate type annotations from declaration annotations, and put
any type annotations that a programmer may not write (they are only used
internally by the implementation) last within variety of annotation.<p>Draw a diagram of the type hierarchy. A textual description of
the hierarchy is not sufficient; the diagram really helps readers to
understand the system.
The diagram will appear in directory <span style="font-family:monospace">docs/manual/figures/</span>;
see its <span style="font-family:monospace">README</span> file for tips.</p><p>The Javadoc for the annotations deserves the same care as the manual
chapter. Each annotation’s Javadoc comment should use the
<span style="font-family:monospace">@checker_framework.manual</span> Javadoc taglet to refer to the chapter that
describes the checker, and the polymorphic qualifier’s Javadoc should
also refer to the <span style="font-family:monospace">qualifier-polymorphism</span> section. For example, in
<span style="font-family:monospace">PolyPresent.java</span>:</p><pre class="verbatim"> * @checker_framework.manual #optional-checker Optional Checker
 * @checker_framework.manual #qualifier-polymorphism Qualifier polymorphism
  </pre></dd><dt class="dt-description"><span style="font-weight:bold">Section: What the Belly Rub Checker checks</span></dt><dd class="dd-description">
This section gives more details about when an error is issued, with examples.
This section may be omitted if the checker does not contain special
type-checking rules — that is, if the checker only enforces the usual
Java subtyping rules.</dd><dt class="dt-description"><span style="font-weight:bold">Section: Examples</span></dt><dd class="dd-description">
Code examples.
</dd></dl><p>Sometimes you can omit some of the above sections. Sometimes there are
additional sections, such as tips on suppressing warnings, comparisons to
other tools, and run-time support.</p><p>You will create a new <span style="font-family:monospace">belly-rub-checker.tex</span> file,
then <code class="verb">\input</code> it at a logical place in <span style="font-family:monospace">manual.tex</span> (not
necessarily as the last checker-related chapter). Also add two references
to the checker’s chapter: one at the beginning of
chapter ‍<a href="#introduction">1</a>, and identical text in the appropriate part of
Section ‍<a href="#type-refinement-runtime-tests">31.7.4</a>. Add the new file to
<span style="font-family:monospace">docs/manual/Makefile</span>. Keep the lists in
the same order as the manual chapters, to help us notice if anything is
missing.</p><p>For a chapter or (sub)*section, use <code class="verb">\sectionAndLabel{Section title}{section-label}</code>.
Section labels should start with the checker
name (as in <code class="verb">bellyrub-examples</code>) and not with “<span style="font-family:monospace">sec:</span>”.
Figure labels should start with “fig-<em>checkername</em>” and not with “fig:”.
These conventions are for the benefit of the Hevea program that produces
the HTML version of the manual.
Use <code class="verb">\begin{figure}</code> for all figures, including those whose
content is a table, in order to have a single consistent numbering for all
figures.</p><p>Don’t forget to write Javadoc for any annotations that the checker uses.
That is part of the documentation and is the first thing that many users
may see. The documentation for any annotation should include an example
use of the annotation.
Also ensure that the Javadoc links back to the manual, using the
<span style="font-family:monospace">@checker_framework.manual</span> custom Javadoc tag.</p>
<!--TOC section id="creating-javac-tips" javac implementation survival guide-->
<h2 id="creating-javac-tips" class="section">35.14 javac implementation survival guide <a href="#creating-javac-tips"><img src="chainlink.svg" width="10" height="10"></a></h2><!--SEC END --><p>Since this section of the manual was written, the useful “The Hitchhiker’s
Guide to javac” has become available at
<a href="https://openjdk.org/groups/compiler/doc/hhgtjavac/index.html"><span style="font-family:monospace">https://openjdk.org/groups/compiler/doc/hhgtjavac/index.html</span></a>.
See it first, and then refer to this section. (This section of the manual
should be revised, or parts eliminated, in light of that document.)</p><p>A checker built using the Checker Framework makes use of a few interfaces
from the underlying compiler (Oracle’s OpenJDK javac).
This section describes those interfaces.</p>
<!--TOC subsection id="creating-compiler-information" Checker access to compiler information-->
<h3 id="creating-compiler-information" class="subsection">35.14.1 Checker access to compiler information <a href="#creating-compiler-information"><img src="chainlink.svg" width="10" height="10"></a></h3><!--SEC END --><p>The compiler uses and exposes three hierarchies to model the Java
source code and classfiles.</p>
<!--TOC subsubsection id="creating-javac-types" Types — Java Language Model API-->
<h4 id="creating-javac-types" class="subsubsection">Types — Java Language Model API <a href="#creating-javac-types"><img src="chainlink.svg" width="10" height="10"></a></h4><!--SEC END --><p>A <a href="https://docs.oracle.com/en/java/javase/17/docs/api/java.compiler/javax/lang/model/type/TypeMirror.html?is-external=true"><span style="font-family:monospace">TypeMirror</span></a> represents a Java type.
</p><p>
There is a <span style="font-family:monospace">TypeMirror</span> interface to represent each type kind,
e.g., <span style="font-family:monospace">PrimitiveType</span> for primitive types, <span style="font-family:monospace">ExecutableType</span>
for method types, and <span style="font-family:monospace">NullType</span> for the type of the <span style="font-family:monospace">null</span> literal.
</p><p><span style="font-family:monospace">TypeMirror</span> does not represent annotated types though. A checker
should use the Checker Framework types API,
<a href="../api/org/checkerframework/framework/type/AnnotatedTypeMirror.html"><span style="font-family:monospace">AnnotatedTypeMirror</span></a>, instead. <span style="font-family:monospace">AnnotatedTypeMirror</span>
parallels the <span style="font-family:monospace">TypeMirror</span> API, but also presents the type annotations
associated with the type.</p><p>The Checker Framework and the checkers use the types API extensively.</p>
<!--TOC subsubsection id="creating-javac-elements" Elements — Java Language Model API-->
<h4 id="creating-javac-elements" class="subsubsection">Elements — Java Language Model API <a href="#creating-javac-elements"><img src="chainlink.svg" width="10" height="10"></a></h4><!--SEC END --><p>An <a href="https://docs.oracle.com/en/java/javase/17/docs/api/java.compiler/javax/lang/model/element/Element.html?is-external=true"><span style="font-family:monospace">Element</span></a> represents a potentially-public
declaration that can be accessed from elsewhere: classes, interfaces, methods, constructors, and
fields. <span style="font-family:monospace">Element</span> represents elements found in both source
code and bytecode.</p><p>There is an <span style="font-family:monospace">Element</span> interface to represent each construct, e.g.,
<span style="font-family:monospace">TypeElement</span> for classes/interfaces, <span style="font-family:monospace">ExecutableElement</span> for
methods/constructors, and <span style="font-family:monospace">VariableElement</span> for local variables and
method parameters.</p><p>If you need to operate on the declaration level, always use elements rather
than trees
(see below). This allows the code to work on
both source and bytecode elements.</p><p>Example: retrieve declaration annotations, check variable
modifiers (e.g., <span style="font-family:monospace">strictfp</span>, <span style="font-family:monospace">synchronized</span>)</p>
<!--TOC subsubsection id="creating-javac-trees" Trees — Compiler Tree API-->
<h4 id="creating-javac-trees" class="subsubsection">Trees — Compiler Tree API <a href="#creating-javac-trees"><img src="chainlink.svg" width="10" height="10"></a></h4><!--SEC END --><p>A <a href="https://docs.oracle.com/en/java/javase/17/docs/api/jdk.compiler/com/sun/source/tree/Tree.html?is-external=true"><span style="font-family:monospace">Tree</span></a> represents a syntactic unit in the source code,
such as a method declaration, statement, block, <span style="font-family:monospace">for</span> loop, etc. Trees only
represent source code to be compiled (or found in <span style="font-family:monospace">-sourcepath</span>);
no tree is available for classes read from bytecode.</p><p>There is a Tree interface for each Java source structure, e.g.,
<span style="font-family:monospace">ClassTree</span> for class declaration, <span style="font-family:monospace">MethodInvocationTree</span>
for a method invocation, and <span style="font-family:monospace">ForEachTree</span> for an enhanced <span style="font-family:monospace">for</span>
statement (also known as a foreach loop).</p><p>You should limit your use of trees. A checker uses Trees mainly to
traverse the source code and retrieve the types/elements corresponding to
them. Then, the checker performs any needed checks on the types/elements instead.</p><p>To obtain the position (line number and column number) of a Tree,
cast the Tree to a <span style="font-family:monospace">com.sun.tools.javac.tree.JCTree</span> and then use one of
its methods, such as <span style="font-family:monospace">pos()</span> which returns a <span style="font-family:monospace">JCDiagnostic.DiagnosticPosition</span>.
<span style="font-family:monospace">com.sun.source.tree.CompilationUnitTree</span> has a LineMap that lets you convert
positions to line numbers.</p>
<!--TOC subsubsection id="creating-using-the-apis" Using the APIs-->
<h4 id="creating-using-the-apis" class="subsubsection">Using the APIs <a href="#creating-using-the-apis"><img src="chainlink.svg" width="10" height="10"></a></h4><!--SEC END --><p>The three APIs use some common idioms and conventions; knowing them will
help you to create your checker.</p><p><em>Type-checking</em>:
Do not use <span style="font-family:monospace">instanceof Subinterface</span> to determine which kind of <span style="font-family:monospace">TypeMirror</span> or <span style="font-family:monospace">Element</span> an expression is,
because some of the classes that implement the TypeMirror and Element subinterfaces implement multiple
subinterfaces. For example, <span style="font-family:monospace">type instanceof DeclaredType</span> and <span style="font-family:monospace">type instanceof UnionType</span>
both return true if <span style="font-family:monospace">type</span> is an <span style="font-family:monospace">com.sun.tools.javac.code.Type.UnionClassType</span> object.</p><p>Instead, use the
<a href="https://docs.oracle.com/en/java/javase/17/docs/api/java.compiler/javax/lang/model/type/TypeMirror.html#getKind()"><span style="font-family:monospace">TypeMirror.getKind()</span></a>
or
<a href="https://docs.oracle.com/en/java/javase/17/docs/api/java.compiler/javax/lang/model/element/Element.html#getKind()"><span style="font-family:monospace">Element.getKind()</span></a>
method. For example, if <span style="font-family:monospace">type</span> is an <span style="font-family:monospace">com.sun.tools.javac.code.Type.UnionClassType</span> object, then
<span style="font-family:monospace">expr.getKind() == TypeKind.DECLARED</span> is false and <span style="font-family:monospace">expr.getKind() == TypeKind.UNION</span> is true.</p><p>For <span style="font-family:monospace">Tree</span>s, you can use either <span style="font-family:monospace">Tree.getKind()</span> or <span style="font-family:monospace">instanceof</span>.</p><p><em>Visitors and Scanners</em>:
The compiler and the Checker Framework use the visitor pattern
extensively. For example, visitors are used to traverse the source tree
(<a href="../api/org/checkerframework/common/basetype/BaseTypeVisitor.html"><span style="font-family:monospace">BaseTypeVisitor</span></a> extends
<a href="https://docs.oracle.com/en/java/javase/17/docs/api/jdk.compiler/com/sun/source/util/TreePathScanner.html?is-external=true"><span style="font-family:monospace">TreePathScanner</span></a>) and for type
checking (<a href="../api/org/checkerframework/framework/type/treeannotator/TreeAnnotator.html"><span style="font-family:monospace">TreeAnnotator</span></a> implements
<a href="https://docs.oracle.com/en/java/javase/17/docs/api/jdk.compiler/com/sun/source/tree/TreeVisitor.html?is-external=true"><span style="font-family:monospace">TreeVisitor</span></a>).</p><p><em>Utility classes</em>:
Some useful methods appear in a utility class. The OpenJDK convention is that
the utility class for a <span style="font-family:monospace">Foo</span> hierarchy is <span style="font-family:monospace">Foos</span> (e.g.,
<a href="https://docs.oracle.com/en/java/javase/17/docs/api/java.compiler/javax/lang/model/util/Types.html?is-external=true"><span style="font-family:monospace">Types</span></a>, <a href="https://docs.oracle.com/en/java/javase/17/docs/api/java.compiler/javax/lang/model/util/Elements.html?is-external=true"><span style="font-family:monospace">Elements</span></a>, and
<a href="https://docs.oracle.com/en/java/javase/17/docs/api/jdk.compiler/com/sun/source/util/Trees.html?is-external=true"><span style="font-family:monospace">Trees</span></a>). The Checker Framework uses a common
<span style="font-family:monospace">Utils</span> suffix to distinguish the class names (e.g., <a href="../api/org/checkerframework/javacutil/TypesUtils.html"><span style="font-family:monospace">TypesUtils</span></a>,
<a href="../api/org/checkerframework/javacutil/TreeUtils.html"><span style="font-family:monospace">TreeUtils</span></a>, <a href="../api/org/checkerframework/javacutil/ElementUtils.html"><span style="font-family:monospace">ElementUtils</span></a>), with one
notable exception: <a href="../api/org/checkerframework/framework/util/AnnotatedTypes.html"><span style="font-family:monospace">AnnotatedTypes</span></a>.</p>
<!--TOC subsubsection id="equality-for-annotations" Equality for annotations-->
<h4 id="equality-for-annotations" class="subsubsection">Equality for annotations <a href="#equality-for-annotations"><img src="chainlink.svg" width="10" height="10"></a></h4><!--SEC END --><p><span style="font-family:monospace">AnnotationMirror</span> is an interface that is implemented both by javac and
the Checker Framework. The documentation of
<a href="https://docs.oracle.com/en/java/javase/17/docs/api/java.compiler/javax/lang/model/element/AnnotationMirror.html?is-external=true"><span style="font-family:monospace">AnnotationMirror</span></a> says, “Annotations should be
compared using the equals method. There is no guarantee that any particular
annotation will always be represented by the same object.” The second
sentence is true, but the first sentence is wrong. You should never
compare <span style="font-family:monospace">AnnotationMirror</span>s using <span style="font-family:monospace">equals()</span>, which (for some
implementations) is reference equality.
<a href="../api/org/checkerframework/javacutil/AnnotationUtils.html"><span style="font-family:monospace">AnnotationUtils</span></a> has various
methods that should be used instead. Also,
<a href="../api/org/checkerframework/framework/util/AnnotationMirrorMap.html"><span style="font-family:monospace">AnnotationMirrorMap</span></a> and
<a href="../api/org/checkerframework/framework/util/AnnotationMirrorSet.html"><span style="font-family:monospace">AnnotationMirrorSet</span></a> can be used.</p>
<!--TOC subsection id="creating-checker-as-annotation-processor" How a checker fits in the compiler as an annotation processor-->
<h3 id="creating-checker-as-annotation-processor" class="subsection">35.14.2 How a checker fits in the compiler as an annotation processor <a href="#creating-checker-as-annotation-processor"><img src="chainlink.svg" width="10" height="10"></a></h3><!--SEC END --><p>The Checker Framework builds on the Annotation Processing API
introduced in Java 6. A type-checking annotation processor is one that extends
<a href="../api/org/checkerframework/javacutil/AbstractTypeProcessor.html"><span style="font-family:monospace">AbstractTypeProcessor</span></a>; it gets run on each class
source file after the compiler confirms that the class is valid Java code.</p><p>The most important methods of <a href="../api/org/checkerframework/javacutil/AbstractTypeProcessor.html"><span style="font-family:monospace">AbstractTypeProcessor</span></a>
are <span style="font-family:monospace">typeProcess</span> and <span style="font-family:monospace">getSupportedSourceVersion</span>. The former
class is where you would insert any sort of method call to walk the AST,
and the latter just returns a constant indicating that we are targeting
version 8 of the compiler. Implementing these two methods should be enough
for a basic plugin; see the Javadoc for the class for other methods that
you may find useful later on.</p><p>The Checker Framework uses Oracle’s Tree API to access a program’s AST.
The Tree API is specific to the Oracle OpenJDK, so the Checker Framework only
works with the OpenJDK javac, not with Eclipse’s compiler ecj.
This also limits the tightness of
the integration of the Checker Framework into other IDEs such as <a href="https://www.jetbrains.com/idea/">IntelliJ IDEA</a>.
An implementation-neutral API would be preferable.
In the future, the Checker Framework
can be migrated to use the Java Model AST of JSR 198 (Extension API for
Integrated Development Environments) ‍[<a href="#JSR198">Cro06</a>], which gives access to
the source code of a method. But, at present no tools
implement JSR ‍198. Also see Section ‍<a href="#creating-ast-traversal">35.7.1</a>.</p>
<!--TOC subsubsection id="creating-learning-more-about-javac" Learning more about javac-->
<h4 id="creating-learning-more-about-javac" class="subsubsection">Learning more about javac <a href="#creating-learning-more-about-javac"><img src="chainlink.svg" width="10" height="10"></a></h4><!--SEC END --><p>Sun’s javac compiler interfaces can be daunting to a
newcomer, and its documentation is a bit sparse. The Checker Framework
aims to abstract a lot of these complexities.
You do not have to understand the implementation of javac to
build powerful and useful checkers.
Beyond this document,
other useful resources include the Java Infrastructure
Developer’s guide at
<a href="https://netbeans.apache.org/wiki/Java_DevelopersGuide.html"><span style="font-family:monospace">https://netbeans.apache.org/wiki/Java_DevelopersGuide.html</span></a> and the compiler
mailing list archives at
<a href="https://mail.openjdk.org/pipermail/compiler-dev/"><span style="font-family:monospace">https://mail.openjdk.org/pipermail/compiler-dev/</span></a>
(subscribe at
<a href="https://mail.openjdk.org/mailman/listinfo/compiler-dev"><span style="font-family:monospace">https://mail.openjdk.org/mailman/listinfo/compiler-dev</span></a>).</p>
<!--TOC section id="creating-integrating-a-checker" Integrating a checker with the Checker Framework-->
<h2 id="creating-integrating-a-checker" class="section">35.15 Integrating a checker with the Checker Framework <a href="#creating-integrating-a-checker"><img src="chainlink.svg" width="10" height="10"></a></h2><!--SEC END --><p>To integrate a new checker with the Checker Framework release, perform
the following:</p><ul class="itemize"><li class="li-itemize">Make sure <span style="font-family:monospace">check-compilermsgs</span> and <span style="font-family:monospace">check-purity</span> run
without warnings or errors.</li></ul><hr>
<!--BEGIN NOTES chapter-->
<hr class="footnoterule"><dl class="thefootnotes"><dt class="dt-thefootnotes">
<a id="note1" href="#text1">1</a></dt><dd class="dd-thefootnotes"><div class="footnotetext">Actually, there is a standard API for Java ASTs — JSR 198
(Extension API for Integrated Development Environments) ‍[<a href="#JSR198">Cro06</a>].
If tools were to implement it (which would just require writing wrappers
or adapters), then the Checker Framework and similar tools could be
portable among different compilers and IDEs.</div></dd></dl>
<!--END NOTES-->
<!--TOC chapter id="accumulation-checker" Building an accumulation checker-->
<h1 id="accumulation-checker" class="chapter">Chapter ‍36 Building an accumulation checker <a href="#accumulation-checker"><img src="chainlink.svg" width="10" height="10"></a></h1><!--SEC END --><p>This chapter describes how to build a checker for an accumulation analysis.
If you want to <em>use</em> an existing checker, you do not need to read this chapter.</p><p>An <em>accumulation analysis</em> is a program analysis where the
analysis abstraction is a monotonically increasing set — that is, the
analysis learns new facts, and facts are never retracted.
Typically, some operation in code is legal
only when the set is large enough — that is, the estimate has accumulated
sufficiently many facts.</p><p>The Called Methods Checker (Chapter ‍<a href="#called-methods-checker">7</a>)
is an accumulation analysis.
The
<a href="https://github.com/typetools/checker-framework/blob/master/framework/src/test/java/org/checkerframework/framework/testchecker/testaccumulation/TestAccumulationChecker.java">Test Accumulation Checker</a>
is a simplified version of the Called Methods Checker that you can also use as a model.</p><p>Accumulation analysis is a special case of typestate analysis in which
(1) the order in which operations are performed does not affect what is subsequently legal,
and (2) the accumulation does not add restrictions; that is, as
more operations are performed, more operations become legal.
Unlike a traditional typestate analysis, an accumulation analysis does
not require an alias analysis for soundness. It can therefore be implemented
as a flow-sensitive type system.</p><p>The rest of this chapter assumes you have read how to create a checker
(Chapter ‍<a href="#creating-a-checker">35</a>).</p>
<!--TOC paragraph id="accumulation-qualifiers" Defining type qualifiers-->
<h5 id="accumulation-qualifiers" class="paragraph">Defining type qualifiers <a href="#accumulation-qualifiers"><img src="chainlink.svg" width="10" height="10"></a></h5><!--SEC END --><p>
Define 2 or 3 type qualifiers.</p><ul class="itemize"><li class="li-itemize">
The “accumulator” type qualifier has a single argument: a <span style="font-family:monospace">String[]</span> named
<span style="font-family:monospace">value</span> that defaults to the an empty array. Note that the Checker Framework’s
support for accumulation analysis requires you to accumulate a string representation
of whatever you are accumulating. For example, when accumulating which methods have
been called, you might choose to accumulate method names.<p>The accumulator
qualifier should have no supertypes (<span style="font-family:monospace">@SubtypeOf()</span>) and should
be the default qualifier in the hierarchy (<span style="font-family:monospace">@DefaultQualifierInHierarchy</span>).</p><p>An example of such a qualifier can be found in the Checker Framework’s tests:
<a href="https://github.com/typetools/checker-framework/blob/master/framework/src/test/java/org/checkerframework/framework/testchecker/testaccumulation/qual/TestAccumulation.java">TestAccumulation.java</a>.</p></li><li class="li-itemize">Define a bottom type, analogous to
<a href="https://github.com/typetools/checker-framework/blob/master/framework/src/test/java/org/checkerframework/framework/testchecker/testaccumulation/qual/TestAccumulationBottom.java">TestAccumulationBottom.java</a>.
It should take no arguments, and should be a subtype of the accumulator type you defined earlier.</li><li class="li-itemize">Optionally, define a predicate annotation, analogous to
<a href="https://github.com/typetools/checker-framework/blob/master/framework/src/test/java/org/checkerframework/framework/testchecker/testaccumulation/qual/TestAccumulationPredicate.java">TestAccumulationPredicate.java</a>.
It must have a single argument named <span style="font-family:monospace">value</span> of type <span style="font-family:monospace">String</span>.
The predicate syntax supports
<ul class="itemize"><li class="li-itemize">
<span style="font-family:monospace">||</span> disjunctions
</li><li class="li-itemize"><span style="font-family:monospace">&amp;&amp;</span> conjunctions
</li><li class="li-itemize"><span style="font-family:monospace">!</span> logical complement. <span style="font-family:monospace">"!x"</span> means
“it is not true that <span style="font-family:monospace">x</span> was definitely accumulated” or, equivalently, “there is no path on which <span style="font-family:monospace">x</span> was accumulated”.
Note that this does <span style="font-weight:bold">not</span> mean “<span style="font-family:monospace">x</span> was not accumulated” — it is not a violation of the specification <span style="font-family:monospace">"!x"</span> if <span style="font-family:monospace">x</span> is accumulated
on some paths, but not others.
</li><li class="li-itemize"><span style="font-family:monospace">(...)</span> parentheses for precedence
</li></ul></li></ul>
<!--TOC paragraph id="accumulation-setup" Setting up the checker-->
<h5 id="accumulation-setup" class="paragraph">Setting up the checker <a href="#accumulation-setup"><img src="chainlink.svg" width="10" height="10"></a></h5><!--SEC END --><p>Define a new class that extends <a href="../api/org/checkerframework/common/accumulation/AccumulationChecker.html"><span style="font-family:monospace">AccumulationChecker</span></a>.
It does not need any content.</p><p>Define a new class that extends <a href="../api/org/checkerframework/common/accumulation/AccumulationAnnotatedTypeFactory.html"><span style="font-family:monospace">AccumulationAnnotatedTypeFactory</span></a>.
You must create a new constructor whose only argument is a <a href="../api/org/checkerframework/common/basetype/BaseTypeChecker.html"><span style="font-family:monospace">BaseTypeChecker</span></a>.
Your constructor should call one of the <span style="font-family:monospace">super</span> constructors defined in
<a href="../api/org/checkerframework/common/accumulation/AccumulationAnnotatedTypeFactory.html"><span style="font-family:monospace">AccumulationAnnotatedTypeFactory</span></a> (which one depends on whether or not
you defined a predicate annotation).</p>
<!--TOC paragraph id="accumulation-accumulating" Adding accumulation logic-->
<h5 id="accumulation-accumulating" class="paragraph">Adding accumulation logic <a href="#accumulation-accumulating"><img src="chainlink.svg" width="10" height="10"></a></h5><!--SEC END --><p>Define a class that extends <a href="../api/org/checkerframework/common/accumulation/AccumulationTransfer.html"><span style="font-family:monospace">AccumulationTransfer</span></a>.
To update the estimate of what has been accumulated, override some method in
<a href="../api/org/checkerframework/framework/flow/CFAbstractTransfer.html"><span style="font-family:monospace">CFAbstractTransfer</span></a> to call
<a href="../api/org/checkerframework/common/accumulation/AccumulationTransfer.html#accumulate(org.checkerframework.dataflow.cfg.node.Node,org.checkerframework.dataflow.analysis.TransferResult,java.lang.String...)"><span style="font-family:monospace">accumulate</span></a>.</p><p>For example, to accumulate the names of methods called, a checker would override
<a href="../api/org/checkerframework/framework/flow/CFAbstractTransfer.html#visitMethodInvocation(org.checkerframework.dataflow.cfg.node.MethodInvocationNode,org.checkerframework.dataflow.analysis.TransferInput)"><span style="font-family:monospace">CFAbstractTransfer.visitMethodInvocation</span></a> to:
call <span style="font-family:monospace">super</span> to get a <span style="font-family:monospace">TransferResult</span>, compute the method name from the <span style="font-family:monospace">MethodInvocationNode</span>,
and then call <span style="font-family:monospace">accumulate</span>.</p>
<!--TOC paragraph id="accumulation-enforcing" Enforcing program properties-->
<h5 id="accumulation-enforcing" class="paragraph">Enforcing program properties <a href="#accumulation-enforcing"><img src="chainlink.svg" width="10" height="10"></a></h5><!--SEC END --><p>At this point, your checker ensures that all annotations are consistent
with one another and the source code, and it flow-sensitively refines the
annotations.
Te enforce properties in the code being type-checked, write type rules
(Section ‍<a href="#creating-extending-visitor">35.7</a>) that are specific to your type
system.</p>
<!--TOC section id="accumulation-publications" Publications-->
<h2 id="accumulation-publications" class="section">36.1 Publications <a href="#accumulation-publications"><img src="chainlink.svg" width="10" height="10"></a></h2><!--SEC END --><p>The paper
<a href="https://homes.cs.washington.edu/~mernst/pubs/accumulation-analysis-ecoop2022.pdf">“Accumulation
Analysis”</a> ‍[<a href="#KelloggSSE2022">KSSE22</a>] describes theoretical properties of
accumulation analysis. The papers
<a href="https://homes.cs.washington.edu/~mernst/pubs/object-construction-icse2020.pdf">“Verifying
Object Construction”</a> ‍[<a href="#KelloggRSSE2020">KRS+20</a>] and
<a href="https://homes.cs.washington.edu/~mernst/pubs/resource-leak-esecfse2021.pdf">“Lightweight
and modular resource leak verification”</a> ‍[<a href="#KelloggSSE2021">KSSE21</a>] describe
specific accumulation analyses.</p><hr>
<!--TOC chapter id="external-tools" Integration with external tools-->
<h1 id="external-tools" class="chapter">Chapter ‍37 Integration with external tools <a href="#external-tools"><img src="chainlink.svg" width="10" height="10"></a></h1><!--SEC END --><p>This chapter discusses how to run a checker from the command line, from a
build system, or from an IDE. You can skip to the appropriate section:</p><ul class="itemize"><li class="li-itemize">
Android (Section ‍<a href="#android">37.1</a>)
</li><li class="li-itemize">Android Gradle Plugin (Section ‍<a href="#android-gradle">37.2</a>)
</li><li class="li-itemize">Ant (Section ‍<a href="#ant-task">37.3</a>)
</li><li class="li-itemize">Buck (Section ‍<a href="#buck">37.4</a>)
</li><li class="li-itemize">Command line, via Checker Framework javac wrapper (Section ‍<a href="#javac-wrapper">37.5</a>)
</li><li class="li-itemize">Command line, via JDK javac (Section ‍<a href="#javac">37.6</a>)
</li><li class="li-itemize">Eclipse (Section ‍<a href="#eclipse">37.7</a>)
</li><li class="li-itemize">Gradle (Section ‍<a href="#gradle">37.8</a>)
</li><li class="li-itemize">IntelliJ IDEA (Section ‍<a href="#intellij">37.9</a>)
</li><li class="li-itemize">javac Diagnostics Wrapper (Section ‍<a href="#javac-diagnostics-wrapper">37.10</a>)
</li><li class="li-itemize">Lombok (Section ‍<a href="#lombok">37.11</a>)
</li><li class="li-itemize">Maven (Section ‍<a href="#maven">37.12</a>)
</li><li class="li-itemize">NetBeans (Section ‍<a href="#netbeans">37.13</a>)
</li><li class="li-itemize">sbt (Section ‍<a href="#sbt">37.14</a>)
</li><li class="li-itemize">tIDE (Section ‍<a href="#tide">37.15</a>)
</li></ul><p>If your build system or IDE is not listed above, you should customize how
it runs the javac command on your behalf. See your build system or IDE
documentation to learn how to
customize it, adapting the instructions for javac in Section ‍<a href="#javac">37.6</a>.
If you make another tool support running a checker, please
inform us via the
<a href="https://groups.google.com/forum/#!forum/checker-framework-discuss">mailing
list</a> or
<a href="https://github.com/typetools/checker-framework/issues">issue tracker</a> so
we can add it to this manual.</p><p>All examples in this chapter are in the public domain, with no copyright nor
licensing restrictions.</p>
<!--TOC section id="android" Android-->
<h2 id="android" class="section">37.1 Android <a href="#android"><img src="chainlink.svg" width="10" height="10"></a></h2><!--SEC END --><p>When creating an Android app, you may wish to use <span style="font-family:monospace">checker-qual-android</span>
whenever this document mentions <span style="font-family:monospace">checker-qual</span>. This can lead to smaller
dex files (smaller distributed apps).</p><p>The <span style="font-family:monospace">checker-qual-android</span> artifact is identical to the <span style="font-family:monospace">checker-qual</span>
artifact, except that in <span style="font-family:monospace">checker-qual-android</span> annotations have classfile
retention. The default Android Gradle plugin retains types annotated with
runtime-retention annotations in the main dex, but strips out class-retention
annotations.</p>
<!--TOC section id="android-gradle" Android Studio and the Android Gradle Plugin-->
<h2 id="android-gradle" class="section">37.2 Android Studio and the Android Gradle Plugin <a href="#android-gradle"><img src="chainlink.svg" width="10" height="10"></a></h2><!--SEC END --><p>Android Studio 3.0 and later, and Android Gradle Plugin 3.0.0 and later, support type
annotations. (See
<a href="https://developer.android.com/studio/write/java8-support"><span style="font-family:monospace">https://developer.android.com/studio/write/java8-support</span></a>
for more details.) This section explains how to configure your Android
project to use the Checker Framework. All the changes should be made to
the module’s <span style="font-family:monospace">build.gradle</span> file — not the project’s <span style="font-family:monospace">build.gradle</span> file.</p><p>Different changes are required for JDK 8
(Section ‍<a href="#android-jdk8">37.2.1</a>) and for JDK 9+ (Section ‍<a href="#android-jdk11">37.2.2</a>).</p>
<!--TOC subsection id="android-jdk8" JDK 8-->
<h3 id="android-jdk8" class="subsection">37.2.1 JDK 8 <a href="#android-jdk8"><img src="chainlink.svg" width="10" height="10"></a></h3><!--SEC END --><p>
This section shows what changes to make if you are using JDK 8.</p><ol class="enumerate" type=1><li class="li-enumerate">In your module’s <span style="font-family:monospace">build.gradle</span> file, set the source and target
compatibility to <span style="font-family:monospace">JavaVersion.VERSION_1_8</span>:<pre class="verbatim">android {
    ...
    compileOptions {
        sourceCompatibility JavaVersion.VERSION_1_8
        targetCompatibility JavaVersion.VERSION_1_8
    }
}
</pre></li><li class="li-enumerate">Add a build variant for running checkers:<pre class="verbatim"> android {
    ...
      buildTypes {
      ...
        checkTypes {
            javaCompileOptions.annotationProcessorOptions.
                    classNames.add("org.checkerframework.checker.nullness.NullnessChecker")
            // You can pass options like so:
            // javaCompileOptions.annotationProcessorOptions.arguments.put("warns", "")
        }
    }
}
</pre></li><li class="li-enumerate">Add a dependency configuration for the Java 9 compiler:<div style="font-size:small;">
<pre class="verbatim">configurations {
    errorproneJavac {
        description = 'Java 9 compiler; required to run the Checker Framework under JDK 8.'
    }
}

</pre>
</div></li><li class="li-enumerate">Declare the Checker Framework dependencies:<div style="font-size:small;">
<pre class="verbatim">dependencies {
    ... existing dependencies...
    ext.checkerFrameworkVersion = '3.34.0-eisop1'
    implementation "io.github.eisop:checker-qual-android:${checkerFrameworkVersion}"
    // or if you use no annotations in source code the above line could be
    // compileOnly "io.github.eisop:checker-qual-android:${checkerFrameworkVersion}"
    annotationProcessor "io.github.eisop:checker:${checkerFrameworkVersion}"
    errorproneJavac 'com.google.errorprone:javac:9+181-r4173-1'
}
</pre>
</div></li><li class="li-enumerate">Direct all tasks of type <span style="font-family:monospace">JavaCompile</span> used by the <span style="font-family:monospace">checkTypes</span>
build variant to use the Error Prone compiler:
<div style="font-size:small;">
<pre class="verbatim">gradle.projectsEvaluated {
    tasks.withType(JavaCompile).all { compile -&gt;
        if (compile.name.contains("CheckTypes")) {
            options.fork = true
            options.forkOptions.jvmArgs += ["-Xbootclasspath/p:${configurations.errorproneJavac.asPath}".toString()]
        }
    }
}
</pre>
</div></li><li class="li-enumerate">To run the checkers, build using the <span style="font-family:monospace">checkTypes</span> variant:
<pre class="verbatim">gradlew assembleCheckTypes
</pre>
</li></ol>
<!--TOC subsection id="android-jdk11" JDK 11+-->
<h3 id="android-jdk11" class="subsection">37.2.2 JDK 11+ <a href="#android-jdk11"><img src="chainlink.svg" width="10" height="10"></a></h3><!--SEC END --><p>
This section shows what changes to make if you are using JDK 11 or later.
</p><ol class="enumerate" type=1><li class="li-enumerate">In your module’s <span style="font-family:monospace">build.gradle</span> file, set the source and target
compatibility to <span style="font-family:monospace">JavaVersion.VERSION_1_8</span>:<pre class="verbatim">android {
    ...
    compileOptions {
        sourceCompatibility JavaVersion.VERSION_1_8
        targetCompatibility JavaVersion.VERSION_1_8
    }
}
</pre></li><li class="li-enumerate">Add a build variant for running checkers:<pre class="verbatim"> android {
    ...
      buildTypes {
      ...
        checkTypes {
            javaCompileOptions.annotationProcessorOptions.
                    classNames.add("org.checkerframework.checker.nullness.NullnessChecker")
            // You can pass options like so:
            // javaCompileOptions.annotationProcessorOptions.arguments.put("warns", "")
        }
    }
}
</pre></li><li class="li-enumerate">Declare the Checker Framework dependencies:<div style="font-size:small;">
<pre class="verbatim">dependencies {
    ... existing dependencies...
    ext.checkerFrameworkVersion = '3.34.0-eisop1'
    implementation "io.github.eisop:checker-qual-android:${checkerFrameworkVersion}"
    // or if you use no annotations in source code the above line could be
    // compileOnly "io.github.eisop:checker-qual-android:${checkerFrameworkVersion}"
    annotationProcessor "io.github.eisop:checker:${checkerFrameworkVersion}"
}
</pre>
</div></li><li class="li-enumerate">To run the checkers, build using the <span style="font-family:monospace">checkTypes</span> variant:
<pre class="verbatim">gradlew assembleCheckTypes
</pre></li></ol>
<!--TOC section id="ant-task" Ant task-->
<h2 id="ant-task" class="section">37.3 Ant task <a href="#ant-task"><img src="chainlink.svg" width="10" height="10"></a></h2><!--SEC END --><p>If you use the <a href="https://ant.apache.org/">Ant</a> build tool to compile
your software, then you can add an Ant task that runs a checker. We assume
that your Ant file already contains a compilation target that uses the
<span style="font-family:monospace">javac</span> task, and that the <span style="font-family:monospace">CHECKERFRAMEWORK</span> environment variable is set.</p><ol class="enumerate" type=1><li class="li-enumerate">
Set the <span style="font-family:monospace">cfJavac</span> property:<pre class="verbatim">  &lt;property environment="env"/&gt;
  &lt;property name="checkerframework" value="${env.CHECKERFRAMEWORK}" /&gt;
  &lt;condition property="cfJavac" value="javac.bat" else="javac"&gt;
    &lt;os family="windows" /&gt;
  &lt;/condition&gt;
  &lt;presetdef name="cf.javac"&gt;
    &lt;javac fork="yes" executable="${checkerframework}/checker/bin/${cfJavac}" &gt;
      &lt;compilerarg value="-version"/&gt;
      &lt;compilerarg value="-implicit:class"/&gt;
    &lt;/javac&gt;
  &lt;/presetdef&gt;
</pre></li><li class="li-enumerate"><span style="font-weight:bold">Duplicate</span> the compilation target, then <span style="font-weight:bold">modify</span> it slightly as
indicated in this example:<pre class="verbatim">  &lt;target name="check-nullness"
          description="Check for null pointer dereferences"
          depends="clean,..."&gt;
    &lt;!-- use cf.javac instead of javac --&gt;
    &lt;cf.javac ... &gt;
      &lt;compilerarg line="-processor org.checkerframework.checker.nullness.NullnessChecker"/&gt;
      &lt;!-- optional, to not check uses of library methods:
        &lt;compilerarg value="-AskipUses=^(java\.awt\.|javax\.swing\.)"/&gt;
      --&gt;
      &lt;compilerarg line="-Xmaxerrs 10000"/&gt;
      ...
    &lt;/cf.javac&gt;
  &lt;/target&gt;
</pre><p>Fill in each ellipsis (…) from the original compilation target.
However, do not copy any <span style="font-family:monospace">fork=</span> setting from the original <span style="font-family:monospace">&lt;javac&gt;</span>
task invocation.</p><p>If your original compilation target set the bootclasspath, then you cannot
use the javac wrapper script as the above instructions do. You should edit
your Ant buildfile to make invocations similar to those described in
Section ‍<a href="#javac">37.6</a>, but accommodating your bootclasspath.</p><p>In the example, the target is named <span style="font-family:monospace">check-nullness</span>, but you can
name it whatever you like.
</p></li></ol>
<!--TOC subsection id="ant-task-explanation" Explanation-->
<h3 id="ant-task-explanation" class="subsection">37.3.1 Explanation <a href="#ant-task-explanation"><img src="chainlink.svg" width="10" height="10"></a></h3><!--SEC END --><p>This section explains each part of the Ant task.</p><ol class="enumerate" type=1><li class="li-enumerate">
Definition of <span style="font-family:monospace">cf.javac</span>:<p>The <span style="font-family:monospace">fork</span> field of the <span style="font-family:monospace">javac</span> task
ensures that an external <span style="font-family:monospace">javac</span> program is called. Otherwise, Ant will run
<span style="font-family:monospace">javac</span> via a Java method call, and there is no guarantee that it will get
correct version of <span style="font-family:monospace">javac</span>.</p><p>The <span style="font-family:monospace">-version</span> compiler argument is just for debugging; you may omit
it.</p><p>The <span style="font-family:monospace">-implicit:class</span> compiler argument causes annotation processing
to be performed on implicitly compiled files. (An implicitly compiled file
is one that was not specified on the command line, but for which the source
code is newer than the <span style="font-family:monospace">.class</span> file.) This is the default, but
supplying the argument explicitly suppresses a compiler warning.</p></li><li class="li-enumerate">The <span style="font-family:monospace">check-nullness</span> target:<p>The target assumes the existence of a <span style="font-family:monospace">clean</span> target that removes all
<span style="font-family:monospace">.class</span> files. That is necessary because Ant’s <span style="font-family:monospace">javac</span> target
doesn’t re-compile <span style="font-family:monospace">.java</span> files for which a <span style="font-family:monospace">.class</span> file
already exists.</p><p>The <span style="font-family:monospace">-processor ...</span> compiler argument indicates which checker to
run. You can supply additional arguments to the checker as well.</p></li></ol>
<!--TOC section id="buck" Buck-->
<h2 id="buck" class="section">37.4 Buck <a href="#buck"><img src="chainlink.svg" width="10" height="10"></a></h2><!--SEC END --><p>Buck is a build system maintained by Facebook.</p><p>Buck has support for annotation processors, but that support is
undocumented because the Buck maintainers may change the syntax in the
future and they don’t wish to ever change anything that is documented.
You can learn more about Buck and annotation processors at these URLs:
<a href="https://stackoverflow.com/questions/32915721/documentation-for-annotation-processors-buck"><span style="font-family:monospace">https://stackoverflow.com/questions/32915721/documentation-for-annotation-processors-buck</span></a>,
<a href="https://github.com/facebook/buck/issues/85"><span style="font-family:monospace">https://github.com/facebook/buck/issues/85</span></a>.</p><p>In order to use Checker Framework with Buck on <span style="font-weight:bold">JDK 8</span>, you first need
to place the Error Prone JDK 9 compiler in Buck’s bootclasspath
(further explanation in Section ‍<a href="#javac-jdk8">37.6.1</a>). To do so,
follow the instructions on this page: <br>
<a href="https://github.com/uber/okbuck/wiki/Using-Error-Prone-with-Buck-and-OkBuck#using-error-prone-javac-on-jdk-8"><span style="font-family:monospace">https://github.com/uber/okbuck/wiki/Using-Error-Prone-with-Buck-and-OkBuck#using-error-prone-javac-on-jdk-8</span></a> <br>
You only need to follow the instructions to use Error Prone javac on
that page, not the instructions to enable Error Prone.</p><p>Here is an example <span style="font-family:monospace">BUCK</span> build
file showing how to enable the Checker Framework:</p><pre class="verbatim">prebuilt_jar(
    name = 'checker-framework',
    binary_jar = 'checker-3.34.0-eisop1.jar',
    visibility = [ 'PUBLIC' ]
)

prebuilt_jar(
    name = 'checker-qual',
    binary_jar = 'checker-qual-3.34.0-eisop1.jar',
    visibility = [ 'PUBLIC' ]
)

java_library (
    name = 'hello',
    srcs = glob(['src/main/java/**/*.java']),
    java_version = '1.8',
    provided_deps = [ ':checker-framework', ':checker-qual' ],
# To add annotation processing
    annotation_processors = [ 'org.checkerframework.checker.units.UnitsChecker' ],
    annotation_processor_deps = [ ':checker-framework', ':checker-qual' ],
)
</pre>
<!--TOC subsection id="buck-troubleshooting" Troubleshooting-->
<h3 id="buck-troubleshooting" class="subsection">37.4.1 Troubleshooting <a href="#buck-troubleshooting"><img src="chainlink.svg" width="10" height="10"></a></h3><!--SEC END --><p>Use <span style="font-family:monospace">--verbose 8</span> to see diagnostic output including a command line that
ought to be equivalent to Buck’s use of an in-process Java compiler.
For example, you might run</p><pre class="verbatim">./buck clean
./buck fetch //...
./buck build --verbose 8 //app:main
</pre><p>However, the command lines that buck prints with <span style="font-family:monospace">-v 8</span> is <em>not</em> what
Buck actually executes. Buck’s invocation of the Checker Framework may
produce errors that cannot be reproduced from the command line. This is
because Buck uses
<a href="https://github.com/facebook/buck/blob/main/src/com/facebook/buck/jvm/java/Jsr199Javac.java">in-process
compilation</a>, potentially multi-threaded, and because Buck may use
<a href="https://github.com/facebook/buck/blob/main/src/com/facebook/buck/util/ClassLoaderCache.java">multiple
classloaders</a> that are cached.</p><p>You can force Buck to run an external javac, thus behaving exactly like the
command line that its diagnostics print. Use the configuration flag <span style="font-family:monospace">-c
tools.javac=</span><span style="font-family:monospace"><em>path-to-javac</em></span>, for example:</p><pre class="verbatim">./buck clean &amp;&amp; ./buck fetch //... &amp;&amp; ./buck build //app:main -c tools.javac=$(which javac)
</pre>
<!--TOC section id="javac-wrapper" Command line, via Checker Framework javac wrapper-->
<h2 id="javac-wrapper" class="section">37.5 Command line, via Checker Framework javac wrapper <a href="#javac-wrapper"><img src="chainlink.svg" width="10" height="10"></a></h2><!--SEC END --><p>
<a id="javac-installation"></a> </p><p>To perform pluggable type-checking from the command line, run the <span style="font-family:monospace">javac</span>
command that ships with the Checker Framework. This is called the
“Checker Framework compiler” or the “Checker Framework <span style="font-family:monospace">javac</span> wrapper”.
It is exactly the same as the OpenJDK
<span style="font-family:monospace">javac</span> compiler, with one small difference: it includes the Checker
Framework jar file on its classpath.</p><p>You cannot use the <span style="font-family:monospace">javac</span> wrapper if you wish to set the bootclasspath.</p><p>There are three ways to use the Checker Framework compiler from the command
line. You can use any
one of them. However, if you are using the Windows command shell, you must
use the last one.
Adjust the pathnames if you have installed the Checker Framework somewhere
other than <span style="font-family:monospace">$</span><span style="font-family:monospace">HOME</span><span style="font-family:monospace">/checker-framework-3.34.0-eisop1/</span>.</p><ul class="itemize"><li class="li-itemize">
Option 1:
Add directory
<span style="font-family:monospace">.../checker-framework-3.34.0-eisop1/checker/bin</span> to your path, <em>before</em> any other
directory that contains a <span style="font-family:monospace">javac</span> executable.<p>If you are
using the bash shell, a way to do this is to add the following to your
<code class="verb">~/.profile</code> (or alternately <code class="verb">~/.bash_profile</code> or <code class="verb">~/.bashrc</code>) file:
</p><pre class="verbatim">  export CHECKERFRAMEWORK=${HOME}/checker-framework-3.34.0-eisop1
  export PATH=${CHECKERFRAMEWORK}/checker/bin:${PATH}
</pre><p>After editing the file, log out and back in to ensure that the environment variable
setting takes effect.</p></li><li class="li-itemize">
Option 2:
Whenever this document tells you to run <span style="font-family:monospace">javac</span>,
instead run <span style="font-family:monospace">$CHECKERFRAMEWORK/checker/bin/javac</span>.
<p>You can simplify this by introducing an alias <span style="font-family:monospace">javacheck</span>. Then,
whenever this document tells you to run <span style="font-family:monospace">javac</span>, instead run
<span style="font-family:monospace">javacheck</span>. Here is the syntax for your
<code class="verb">~/.bashrc</code>, <code class="verb">~/.profile</code>, or <code class="verb">~/.bash_profile</code>
file:
</p><pre class="verbatim">  export CHECKERFRAMEWORK=${HOME}/checker-framework-3.34.0-eisop1
  alias javacheck='$CHECKERFRAMEWORK/checker/bin/javac'
</pre><p>After editing the file, log out and back in to ensure that the environment variable
setting and alias take effect.</p></li><li class="li-itemize">Option 3:
Whenever this document tells you to run <span style="font-family:monospace">javac</span>, instead
run <span style="font-family:monospace">checker.jar</span> via <span style="font-family:monospace">java</span> (not <span style="font-family:monospace">javac</span>) as in:<pre class="verbatim">  java -jar "$CHECKERFRAMEWORK/checker/dist/checker.jar" -cp "myclasspath" -processor nullness MyFile.java
</pre><p>You can simplify the above command by introducing an alias
<span style="font-family:monospace">javacheck</span>. Then, whenever this document tells you to run
<span style="font-family:monospace">javac</span>, instead run <span style="font-family:monospace">javacheck</span>. For example:</p><pre class="verbatim">  # Unix
  export CHECKERFRAMEWORK=${HOME}/checker-framework-3.34.0-eisop1
  alias javacheck='java -jar "$CHECKERFRAMEWORK/checker/dist/checker.jar"'

  # Windows
  set CHECKERFRAMEWORK = C:\Program Files\checker-framework-3.34.0-eisop1\
  doskey javacheck=java -jar "%CHECKERFRAMEWORK%\checker\dist\checker.jar" $*
</pre><p>(Explanation for advanced users:
More generally, anywhere that you would use <span style="font-family:monospace">javac.jar</span>, you can substitute
<span style="font-family:monospace">$CHECKERFRAMEWORK/checker/dist/checker.jar</span>;
the result is to use the Checker
Framework compiler instead of the regular <span style="font-family:monospace">javac</span>.)</p></li></ul>
<!--TOC section id="javac" Command line, via JDK javac-->
<h2 id="javac" class="section">37.6 Command line, via JDK javac <a href="#javac"><img src="chainlink.svg" width="10" height="10"></a></h2><!--SEC END --><p>This section explains how to use the Checker Framework with the OpenJDK or
OracleJDK <span style="font-family:monospace">javac</span>, rather than with the <span style="font-family:monospace">javac</span> wrapper script described in
Section ‍<a href="#javac-wrapper">37.5</a>.</p><p>This
section assumes you have downloaded the Checker Framework release zip and set
the environment variable <span style="font-family:monospace">CHECKERFRAMEWORK</span> to point to the unzipped directory.
Alternately, you can get all of the jars mentioned in this section from Maven Central:</p><ul class="itemize"><li class="li-itemize">
<span style="font-family:monospace">javac.jar</span>: <a href="https://search.maven.org/artifact/com.google.errorprone/javac/9%2B181-r4173-1/jar"><span style="font-family:monospace">https://search.maven.org/artifact/com.google.errorprone/javac/9%2B181-r4173-1/jar</span></a>
</li><li class="li-itemize"><span style="font-family:monospace">checker-qual.jar</span>: <a href="https://repo1.maven.org/maven2/io/github/eisop/checker-qual/3.34.0-eisop1/checker-qual-3.34.0-eisop1.jar"><span style="font-family:monospace">https://repo1.maven.org/maven2/io/github/eisop/checker-qual/3.34.0-eisop1/checker-qual-3.34.0-eisop1.jar</span></a>
</li><li class="li-itemize"><span style="font-family:monospace">checker-util.jar</span>: <a href="https://repo1.maven.org/maven2/io/github/eisop/checker-util/3.34.0-eisop1/checker-util-3.34.0-eisop1.jar"><span style="font-family:monospace">https://repo1.maven.org/maven2/io/github/eisop/checker-util/3.34.0-eisop1/checker-util-3.34.0-eisop1.jar</span></a>
</li><li class="li-itemize"><span style="font-family:monospace">checker.jar</span>: <a href="https://repo1.maven.org/maven2/io/github/eisop/checker/3.34.0-eisop1/checker-3.34.0-eisop1-all.jar"><span style="font-family:monospace">https://repo1.maven.org/maven2/io/github/eisop/checker/3.34.0-eisop1/checker-3.34.0-eisop1-all.jar</span></a>
</li></ul><p>Different arguments to <span style="font-family:monospace">javac</span> are required for JDK 8
(Section ‍<a href="#javac-jdk8">37.6.1</a>) and for JDK 9+ (Section ‍<a href="#javac-jdk11">37.6.2</a>).</p>
<!--TOC subsection id="javac-jdk8" JDK 8-->
<h3 id="javac-jdk8" class="subsection">37.6.1 JDK 8 <a href="#javac-jdk8"><img src="chainlink.svg" width="10" height="10"></a></h3><!--SEC END --><p>This section shows what arguments to pass to the OpenJDK or OracleJDK
<span style="font-family:monospace">javac</span> (<em>not</em> the <span style="font-family:monospace">javac</span> wrapper script of
Section ‍<a href="#javac-wrapper">37.5</a>) to run the Checker
Framework, if you are using JDK 8.</p><pre class="verbatim">javac \
-J-Xbootclasspath/p:$CHECKERFRAMEWORK/checker/dist/javac.jar \
-cp $CHECKERFRAMEWORK/checker/dist/checker-qual.jar \
-processorpath $CHECKERFRAMEWORK/checker/dist/checker.jar \
-processor org.checkerframework.checker.nullness.NullnessChecker \
-source 8 -target 8
</pre><p>Below is an explanation of each argument.
</p><ol class="enumerate" type=1><li class="li-enumerate">
<span style="font-family:monospace">-J-Xbootclasspath/p:$CHECKERFRAMEWORK/checker/dist/javac.jar</span>:
even when running under JDK 8, a Java 9+ compiler (either the Error Prone
compiler or the OpenJDK Java compiler (version 9 or later) must be on the JVM bootclasspath.
The <span style="font-family:monospace">-J</span> indicates that this is a JVM argument rather than a compiler
argument.<p>The following exception is thrown if this argument is missing:
</p><pre class="verbatim">error: SourceChecker.typeProcessingStart: unexpected Throwable (NoSuchMethodError);
message: com.sun.tools.javac.code.Type.stripMetadata()Lcom/sun/tools/javac/code/Type;
</pre><p>If you are compiling your own checker, the following exception is thrown if this argument is missing:
</p><pre class="verbatim">java.lang.NoSuchFieldError: ANNOTATION_PROCESSOR_MODULE_PATH
</pre></li><li class="li-enumerate"><span style="font-family:monospace">-cp $CHECKERFRAMEWORK/checker/dist/checker-qual.jar</span>: <span style="font-family:monospace">checker-qual.jar</span>
must be on the compilation classpath.</li><li class="li-enumerate"><span style="font-family:monospace">-processorpath $CHECKERFRAMEWORK/checker/dist/checker.jar</span>:
<span style="font-family:monospace">checker.jar</span> must be on the processor path. Using this option means that the processor path, not
the classpath, will be searched for annotation processors
and for classes that they load.</li><li class="li-enumerate"><span style="font-family:monospace">-processor org.checkerframework.checker.nullness.NullnessChecker</span>:
Choose which checker to run by passing its fully qualified name as a processor.
(Note, using this option means that javac will not search for annotation
processors, but rather will run only those specified here.)</li><li class="li-enumerate"><span style="font-family:monospace">-source 8 -target 8</span>: Because the build is using
a Java 9 compiler, these options ensure that the
source code is Java 8 and that Java 8 bytecode is created.</li></ol>
<!--TOC subsection id="javac-jdk11" JDK 11+-->
<h3 id="javac-jdk11" class="subsection">37.6.2 JDK 11+ <a href="#javac-jdk11"><img src="chainlink.svg" width="10" height="10"></a></h3><!--SEC END --><p>This section shows what arguments to pass to the OpenJDK or OracleJDK
<span style="font-family:monospace">javac</span> (<em>not</em> the <span style="font-family:monospace">javac</span> wrapper script of
Section ‍<a href="#javac-wrapper">37.5</a>) to run the Checker
Framework, if you are using JDK 9 or later. These
instructions should work on JDK 9 or later, but we only test with supported
versions of Java: JDK 11, JDK 17, and JDK 20.</p>
<!--TOC subsubsection id="javac-jdk11-non-modularized" Non-modularized code-->
<h4 id="javac-jdk11-non-modularized" class="subsubsection">Non-modularized code <a href="#javac-jdk11-non-modularized"><img src="chainlink.svg" width="10" height="10"></a></h4><!--SEC END --><p>To compile non-modularized code:</p><pre class="verbatim">javac \
-J--add-exports=jdk.compiler/com.sun.tools.javac.api=ALL-UNNAMED \
-J--add-exports=jdk.compiler/com.sun.tools.javac.code=ALL-UNNAMED \
-J--add-exports=jdk.compiler/com.sun.tools.javac.file=ALL-UNNAMED \
-J--add-exports=jdk.compiler/com.sun.tools.javac.main=ALL-UNNAMED \
-J--add-exports=jdk.compiler/com.sun.tools.javac.model=ALL-UNNAMED \
-J--add-exports=jdk.compiler/com.sun.tools.javac.processing=ALL-UNNAMED \
-J--add-exports=jdk.compiler/com.sun.tools.javac.tree=ALL-UNNAMED \
-J--add-exports=jdk.compiler/com.sun.tools.javac.util=ALL-UNNAMED \
-J--add-opens=jdk.compiler/com.sun.tools.javac.comp=ALL-UNNAMED \
-processorpath $CHECKERFRAMEWORK/checker/dist/checker.jar \
-cp $CHECKERFRAMEWORK/checker/dist/checker-qual.jar \
-processor org.checkerframework.checker.nullness.NullnessChecker
</pre><p>The arguments are explained above, except for two of them:
</p><ol class="enumerate" type=1><li class="li-enumerate"><span style="font-family:monospace">-J--add-opens=jdk.compiler/com.sun.tools.javac.comp=ALL-UNNAMED</span> which
opens the <span style="font-family:monospace">jdk.compiler/com.sun.tools.java.comp</span> package. This is
required because the Checker Framework reflectively accesses private members of this package.</li><li class="li-enumerate"><span style="font-family:monospace">-J--add-exports=...=ALL-UNNAMED</span> which exports the listed packages. This is
required with JDK 16+ because the Checker Framework accesses non-exported members of these packages.
(These are also required with JDK 11 if <span style="font-family:monospace">--illegal-access</span> is set to <span style="font-family:monospace">deny</span>.)</li></ol><p>If this option is missing, <span style="font-family:monospace">javac</span> may issue one of the below warnings:
</p><pre class="verbatim">WARNING: An illegal reflective access operation has occurred
WARNING: Illegal reflective access by org.checkerframework.javacutil.Resolver
  (file:$CHECKERFRAMEWORK/checker/dist/checker.jar) to method com.sun.tools.javac.comp.Resolve.findMethod(...)
WARNING: Please consider reporting this to the maintainers of org.checkerframework.javacutil.Resolver
WARNING: Use --illegal-access=warn to enable warnings of further illegal reflective access operations
WARNING: All illegal access operations will be denied in a future release
</pre><pre class="verbatim">java.lang.IllegalAccessError: class org.checkerframework.javacutil.AbstractTypeProcessor
  (in unnamed module ...) cannot access class com.sun.tools.javac.processing.JavacProcessingEnvironment
  (in module jdk.compiler) because module jdk.compiler does not export com.sun.tools.javac.processing
  to unnamed module ...
</pre>
<!--TOC subsubsection id="javac-jdk11-modularized" Modularized code-->
<h4 id="javac-jdk11-modularized" class="subsubsection">Modularized code <a href="#javac-jdk11-modularized"><img src="chainlink.svg" width="10" height="10"></a></h4><!--SEC END --><p>To compile a module, first add <span style="font-family:monospace">requires
org.checkerframework.checker.qual;</span> to your <span style="font-family:monospace">module-info.java</span>. The Checker
Framework inserts inferred annotations into bytecode even if none appear in source code,
so you must do this even if you write no annotations in your code.</p><pre class="verbatim">javac \
  -J--add-exports=jdk.compiler/com.sun.tools.javac.api=ALL-UNNAMED \
  -J--add-exports=jdk.compiler/com.sun.tools.javac.code=ALL-UNNAMED \
  -J--add-exports=jdk.compiler/com.sun.tools.javac.file=ALL-UNNAMED \
  -J--add-exports=jdk.compiler/com.sun.tools.javac.main=ALL-UNNAMED \
  -J--add-exports=jdk.compiler/com.sun.tools.javac.model=ALL-UNNAMED \
  -J--add-exports=jdk.compiler/com.sun.tools.javac.processing=ALL-UNNAMED \
  -J--add-exports=jdk.compiler/com.sun.tools.javac.tree=ALL-UNNAMED \
  -J--add-exports=jdk.compiler/com.sun.tools.javac.util=ALL-UNNAMED \
  -J--add-opens=jdk.compiler/com.sun.tools.javac.comp=ALL-UNNAMED \
  -processorpath $CHECKERFRAMEWORK/checker/dist/checker.jar \
  --module-path $CHECKERFRAMEWORK/checker/dist/checker-qual.jar \
  -processor org.checkerframework.checker.nullness.NullnessChecker
</pre><p><span style="font-family:monospace">checker-qual.jar</span> must be on the module path rather than the class path, but
do not put <span style="font-family:monospace">checker.jar</span> on the processor module path as it is not
modularized.</p>
<!--TOC section id="eclipse" Eclipse-->
<h2 id="eclipse" class="section">37.7 Eclipse <a href="#eclipse"><img src="chainlink.svg" width="10" height="10"></a></h2><!--SEC END --><p>You
need to run the Checker Framework via a build tool (Ant, Gradle, Maven, etc.), rather
than by supplying the <span style="font-family:monospace">-processor</span> command-line option to the <span style="font-family:monospace">ejc</span>
compiler, which is also known as <span style="font-family:monospace">eclipsec</span>.
The reason is that the Checker Framework is built upon <span style="font-family:monospace">javac</span>,
and <span style="font-family:monospace">ejc</span> represents the Java program differently. (If both <span style="font-family:monospace">javac</span> and <span style="font-family:monospace">ejc</span>
implemented JSR 198 ‍[<a href="#JSR198">Cro06</a>], then it would be possible to build
an annotation processor that works with both compilers.)</p><p>There is no dedicated Eclipse plug-in for running the Checker Framework,
but it’s still easy to run the Checker Framework. First, create a
target/task in your build system to run the Checker Framework. Then, run
the target/task from Eclipse. Section ‍<a href="#eclipse-ant">37.7.1</a> gives details for
Ant, but other build systems are similar.</p>
<!--TOC subsection id="eclipse-ant" Using an Ant task-->
<h3 id="eclipse-ant" class="subsection">37.7.1 Using an Ant task <a href="#eclipse-ant"><img src="chainlink.svg" width="10" height="10"></a></h3><!--SEC END --><p>Add an Ant target as described in Section ‍<a href="#ant-task">37.3</a>. You can
run the Ant target by executing the following steps
(instructions copied from
<a href="https://help.eclipse.org/luna/index.jsp?topic=%2Forg.eclipse.platform.doc.user%2FgettingStarted%2Fqs-84_run_ant.htm"><span style="font-family:monospace">https://help.eclipse.org/luna/index.jsp?topic=%2Forg.eclipse.platform.doc.user%2FgettingStarted%2Fqs-84_run_ant.htm</span></a>):</p><ol class="enumerate" type=1><li class="li-enumerate">Select <span style="font-family:monospace">build.xml</span> in one of the navigation views and choose
<span style="font-weight:bold">Run As </span>&gt;<span style="font-weight:bold"> Ant Build...</span> from its context menu.</li><li class="li-enumerate">A launch configuration dialog is opened on a launch configuration
for this Ant buildfile.</li><li class="li-enumerate">In the <span style="font-weight:bold">Targets</span> tab, select the new ant task (e.g., check-interning).</li><li class="li-enumerate">Click <span style="font-weight:bold">Run</span>.</li><li class="li-enumerate">The Ant buildfile is run, and the output is sent to the Console view.</li></ol>
<!--TOC subsection id="eclipse-troubleshooting" Troubleshooting Eclipse-->
<h3 id="eclipse-troubleshooting" class="subsection">37.7.2 Troubleshooting Eclipse <a href="#eclipse-troubleshooting"><img src="chainlink.svg" width="10" height="10"></a></h3><!--SEC END --><p>Eclipse issues an “Unhandled Token in @SuppressWarnings” warning if you
write a <span style="font-family:monospace">@SuppressWarnings</span> annotation containing a string that Eclipse does not
know about. Unfortunately, Eclipse
<a href="https://bugs.eclipse.org/bugs/show_bug.cgi?id=122475">hard-codes</a>
this list.</p><p>To eliminate the warnings:
disable all “Unhandled Token in @SuppressWarnings” warnings in Eclipse.
Look under the menu headings
“Java → Compiler → Errors/Warnings →
Annotations → Unhandled Token in ’@SuppressWarnings’,”
and set it to ignore.</p>
<!--TOC section id="gradle" Gradle-->
<h2 id="gradle" class="section">37.8 Gradle <a href="#gradle"><img src="chainlink.svg" width="10" height="10"></a></h2><!--SEC END --><p>To run a checker
on a project that uses the <a href="https://gradle.org/">Gradle</a> build system,
use the
<a href="https://github.com/kelloggm/checkerframework-gradle-plugin">Checker
Framework Gradle plugin</a>. Its documentation explains how to use it.</p>
<!--TOC section id="intellij" IntelliJ IDEA-->
<h2 id="intellij" class="section">37.9 IntelliJ IDEA <a href="#intellij"><img src="chainlink.svg" width="10" height="10"></a></h2><!--SEC END --><p>This section tells you how to make IntelliJ IDEA automatically run a
checker on every compile for Java projects and/or modules.</p><p>If your project uses a build tool (Ant, Gradle, Maven, etc.), <em>do not</em>
use the instructions in this section.
Follow the instructions for that build tool instead (they are in
a different section of this chapter). To compile your project, run the
build tool (possibly from within IntelliJ IDEA, possibly not).</p>
<!--TOC subsection id="intellij-every-compilation" Running a checker on every IntelliJ compilation-->
<h3 id="intellij-every-compilation" class="subsection">37.9.1 Running a checker on every IntelliJ compilation <a href="#intellij-every-compilation"><img src="chainlink.svg" width="10" height="10"></a></h3><!--SEC END --><p>If your project does not use a build tool, use the following instructions
to run a checker within IntelliJ IDEA on every compile:</p><ol class="enumerate" type=1><li class="li-enumerate">Change the project SDK to 11 or later, as explained at
<a href="https://www.jetbrains.com/help/idea/sdk.html#change-project-sdk"><span style="font-family:monospace">https://www.jetbrains.com/help/idea/sdk.html#change-project-sdk</span></a>.</li><li class="li-enumerate">Make sure the language level for your project is 8 or higher, as explained at
<a href="https://www.jetbrains.com/help/idea/project-page.html"><span style="font-family:monospace">https://www.jetbrains.com/help/idea/project-page.html</span></a>.</li><li class="li-enumerate">Create and configure an annotation profile, following the instructions at <a href="https://www.jetbrains.com/help/idea/annotation-processors-support.html"><span style="font-family:monospace">https://www.jetbrains.com/help/idea/annotation-processors-support.html</span></a>.
When configuring the profile:
<ol class="enumerate" type=a><li class="li-enumerate">
Add <span style="font-family:monospace">.../checker-framework/checker/dist/checker.jar</span> to the processor path.
</li><li class="li-enumerate">Add checkers to be run during compilation by writing the
fully-qualified name of the checker in the “Processor FQ Name”
section. An example of a fully-qualified checker name is
“org.checkerframework.checker.nullness.NullnessChecker”.
</li></ol></li><li class="li-enumerate">Add <span style="font-family:monospace">.../checker-framework/checker/dist/checker-qual.jar</span>, as a dependency to all
modules you wish to type check. (They should all have been associated with
the annotation profile above.)
Instructions appear at
<a href="https://www.jetbrains.com/help/idea/creating-and-managing-projects.html"><span style="font-family:monospace">https://www.jetbrains.com/help/idea/creating-and-managing-projects.html</span></a>.</li></ol><p>Now, when you compile your code, the checker will be run.</p><p>It is necessary to manually inform the IDE via a plugin if an annotation
system adds any dependencies beyond those that normally exist in Java.
For information about the extension points, see
<a href="https://youtrack.jetbrains.com/issue/IDEA-159286"><span style="font-family:monospace">https://youtrack.jetbrains.com/issue/IDEA-159286</span></a>.</p>
<!--TOC subsection id="intellij-every-save" Running a checker on every IntelliJ change or save-->
<h3 id="intellij-every-save" class="subsection">37.9.2 Running a checker on every IntelliJ change or save <a href="#intellij-every-save"><img src="chainlink.svg" width="10" height="10"></a></h3><!--SEC END --><p>To make IntelliJ compile on every change or save,
follow the instructions at
<a href="https://www.jetbrains.com/help/idea/compiling-applications.html#auto-build"><span style="font-family:monospace">https://www.jetbrains.com/help/idea/compiling-applications.html#auto-build</span></a>.</p><p>You can also configure IntelliJ to automatically save (and thus
automatically compile) your work periodically. Instructions appear at
<a href="https://www.jetbrains.com/help/idea/system-settings.html#sync"><span style="font-family:monospace">https://www.jetbrains.com/help/idea/system-settings.html#sync</span></a>.</p>
<!--TOC section id="javac-diagnostics-wrapper" javac diagnostics wrapper-->
<h2 id="javac-diagnostics-wrapper" class="section">37.10 javac diagnostics wrapper <a href="#javac-diagnostics-wrapper"><img src="chainlink.svg" width="10" height="10"></a></h2><!--SEC END --><p>The <a href="https://github.com/eisopux/javac-diagnostics-wrapper">javac
diagnostics wrapper</a> project can post-process the javac
diagnostics output into other formats, such as
the LSP (Language Server Protocol) JSON style.</p>
<!--TOC section id="lombok" Lombok-->
<h2 id="lombok" class="section">37.11 Lombok <a href="#lombok"><img src="chainlink.svg" width="10" height="10"></a></h2><!--SEC END --><p>Project Lombok (<a href="https://projectlombok.org/"><span style="font-family:monospace">https://projectlombok.org/</span></a>) is a library that
generates getter, setter, and builder methods, among other features.
For example, if you declare
a field:</p><pre class="verbatim">  @Getter @Setter
  private @Regex String role;
</pre><p>then Lombok will generate getter and setter methods:</p><pre class="verbatim">  public @Regex String getRole() { return role; }
  public void setRole(@Regex String role) { this.role = role; }
</pre>
<!--TOC subsection id="lombok-copying-annotations" Annotations on generated code-->
<h3 id="lombok-copying-annotations" class="subsection">37.11.1 Annotations on generated code <a href="#lombok-copying-annotations"><img src="chainlink.svg" width="10" height="10"></a></h3><!--SEC END --><p>As illustrated in the example above, Lombok copies type annotations from fields
to generated methods, when the user writes Lombok’s <span style="font-family:monospace">@Getter</span>, <span style="font-family:monospace">@Setter</span>,
and <span style="font-family:monospace">@Builder</span> annotations. Lombok does so only for certain type
annotations (including all annotations in the Checker Framework
distribution); see variable <span style="font-family:monospace">BASE_COPYABLE_ANNOTATIONS</span> in file
<a href="https://github.com/projectlombok/lombok/blob/master/src/core/lombok/core/handlers/HandlerUtil.java"><span style="font-family:monospace">HandlerUtil.java</span></a>.</p><p>To make Lombok copy other type annotations from fields to generated code,
add those type annotations to the <span style="font-family:monospace">lombok.copyableAnnotations</span>
configuration key in your <span style="font-family:monospace">lombok.config</span> file. For example:</p><pre class="verbatim">  lombok.copyableAnnotations += my.checker.qual.MyTypeAnnotation
</pre><p>Directory <span style="font-family:monospace">docs/examples/lombok</span> contains an example Gradle project that
augments the configuration key.</p>
<!--TOC subsection id="lombok-typechecking" Type-checking code with Lombok annotations-->
<h3 id="lombok-typechecking" class="subsection">37.11.2 Type-checking code with Lombok annotations <a href="#lombok-typechecking"><img src="chainlink.svg" width="10" height="10"></a></h3><!--SEC END --><p>If you run the Checker Framework and Lombok in the same <span style="font-family:monospace">javac</span>
invocation, the Checker Framework cannot type-check a class that contains
Lombok annotations. The way that Lombok changes the class prevents the
Checker Framework from seeing any of the class. (The Checker Framework
works fine on classes that do not contain Lombok annotations, including if
they call Lombok-generated code.)</p><p>Therefore, you must run the Checker Framework in a postpass after the
<span style="font-family:monospace">javac</span> that runs Lombok has completed. Use the
<a href="https://projectlombok.org/features/delombok">Delombok</a> tool
(distributed with Lombok) to generate Java source code, then run the
Checker Framework on that. The
<a href="https://github.com/kelloggm/checkerframework-gradle-plugin">Checker
Framework Gradle plugin</a> does this for you automatically.</p>
<!--TOC subsection id="lombok-maven" Maven Projects using Lombok-->
<h3 id="lombok-maven" class="subsection">37.11.3 Maven Projects using Lombok <a href="#lombok-maven"><img src="chainlink.svg" width="10" height="10"></a></h3><!--SEC END --><p><a href="http://anthonywhitford.com/lombok.maven/lombok-maven-plugin/">Lombok Maven Plugin</a>
can be used to delombok source code for Maven projects. The
<a href="http://anthonywhitford.com/lombok.maven/lombok-maven-plugin/faq.html#alt-src-setup">Lombok Maven Plugin FAQ</a> discusses how to configure the plugin when code
using Lombok is mixed with standard Java code. Once the Lombok Maven plugin
is configured correctly, the Checker Framework Maven configuration can be added
independently.</p>
<!--TOC section id="maven" Maven-->
<h2 id="maven" class="section">37.12 Maven <a href="#maven"><img src="chainlink.svg" width="10" height="10"></a></h2><!--SEC END --><p>If you use the <a href="https://maven.apache.org/">Maven</a> tool,
then you can enable Checker Framework checkers by following the
instructions below.</p><p>See the directory <span style="font-family:monospace">docs/examples/MavenExample/</span> for examples of the use of
Maven build files.
This example can be used to verify that
Maven is correctly downloading the Checker Framework from the
<a href="https://search.maven.org/search?q=io.github.eisop">Maven
Central Repository</a> and executing it.</p><p>Please note that the <span style="font-family:monospace">-AoutputArgsToFile</span> command-line option
(see Section ‍<a href="#creating-debugging-options-output-args">35.12.5</a>) and shorthands for built-in checkers
(see Section ‍<a href="#shorthand-for-checkers">2.2.4</a>) are not available when
following these instructions. Both these features are available only when a checker is
launched via <span style="font-family:monospace">checker.jar</span> such as when <span style="font-family:monospace">$CHECKERFRAMEWORK/checker/bin/javac</span>
is run. The instructions in this section
bypass <span style="font-family:monospace">checker.jar</span> and cause the compiler to run a
checker as an annotation processor directly.</p><p>Debugging your Maven configuration can be tricky because of a
<a href="https://issues.apache.org/jira/browse/MCOMPILER-434">bug in
maven-compiler-plugin versions before 3.10.1</a>: Maven does not report
annotation processor exceptions, even when
the <span style="font-family:monospace">-X</span> command-line argument is passed.</p><ol class="enumerate" type=1><li class="li-enumerate">Declare a dependency on the Checker Framework artifacts from
Maven Central. Find the
existing <span style="font-family:monospace">&lt;dependencies&gt;</span> section (not within
<span style="font-family:monospace">&lt;dependencyManagement&gt;</span>, but somewhere else) and add the following new
<span style="font-family:monospace">&lt;dependency&gt;</span> items:<pre>
  &lt;dependencies&gt;
    ... existing &lt;dependency&gt; items ...

    &lt;!-- Annotations from the Checker Framework: nullness, interning, locking, ... --&gt;
    &lt;dependency&gt;
      &lt;groupId&gt;io.github.eisop&lt;/groupId&gt;
      &lt;artifactId&gt;checker-qual&lt;/artifactId&gt;
      &lt;version&gt;3.34.0-eisop1&lt;/version&gt;
    &lt;/dependency&gt;
  &lt;/dependencies&gt;
</pre><p>Periodically update to the most recent version, to obtain the
latest bug fixes and new features:
</p><pre class="verbatim">  mvn versions:use-latest-versions -Dincludes="io.github.eisop:*"
</pre></li><li class="li-enumerate">If using JDK 8, use a Maven property to hold the location of the
Error Prone <span style="font-family:monospace">javac.jar</span>.
To set the value of these properties automatically, you will use the Maven Dependency plugin.<p>Add a dependency:</p><pre>
  &lt;dependencies&gt;
    ... existing &lt;dependency&gt; items ...

    &lt;dependency&gt;
      &lt;groupId&gt;com.google.errorprone&lt;/groupId&gt;
      &lt;artifactId&gt;javac&lt;/artifactId&gt;
      &lt;version&gt;9+181-r4173-1&lt;/version&gt;
    &lt;/dependency&gt;
  &lt;/dependencies&gt;
</pre><p>Java 11 and later do not need the <span style="font-family:monospace">com.google.errorprone:javac</span>
dependency, but it does no harm.
The need for the <span style="font-family:monospace">com.google.errorprone:javac</span> artifact when running under
JDK 8 is explained in Section ‍<a href="#javac-jdk8">37.6.1</a>.</p><p>Create the property in the <span style="font-family:monospace">properties</span> section of the POM:</p><pre>
&lt;properties&gt;
  &lt;!-- These properties will be set by the Maven Dependency plugin --&gt;
  &lt;errorProneJavac&gt;${com.google.errorprone:javac:jar}&lt;/errorProneJavac&gt;
&lt;/properties&gt;
</pre><p>Change the reference to the <span style="font-family:monospace">maven-dependency-plugin</span> within the <span style="font-family:monospace">&lt;plugins&gt;</span>
section, or add it if it is not present.</p><pre>
    &lt;plugin&gt;
      &lt;!-- This plugin will set properties values using dependency information --&gt;
      &lt;groupId&gt;org.apache.maven.plugins&lt;/groupId&gt;
      &lt;artifactId&gt;maven-dependency-plugin&lt;/artifactId&gt;
      &lt;executions&gt;
        &lt;execution&gt;
          &lt;goals&gt;
            &lt;goal&gt;properties&lt;/goal&gt;
          &lt;/goals&gt;
        &lt;/execution&gt;
      &lt;/executions&gt;
    &lt;/plugin&gt;
</pre></li><li class="li-enumerate">Direct the Maven compiler plugin to use the desired checkers by
creating three new profiles as shown below (the example uses the Nullness
Checker). If you do not use Java 8, then you only need two of the
profiles, or you can combine them into one profile.<p>If your POM file does not already use the
<span style="font-family:monospace">maven-compiler-plugin</span> plugin, you can use the text below as is.
If your POM file
already uses the plugin, copy and edit the first profile to incorporate the
existing configuration.
If the existing configuration uses <span style="font-family:monospace">proc:none</span>, you need to remove that
or comment it out.</p><div style="font-size:small;">
<pre>
  &lt;profiles&gt;
    &lt;profile&gt;
      &lt;id&gt;checkerframework&lt;/id&gt;
      &lt;!-- If you omit the activation block, run mvn with "-P checkerframework" to run checkers. --&gt;
      &lt;activation&gt;
        &lt;jdk&gt;[1.8,)&lt;/jdk&gt;
      &lt;/activation&gt;
      &lt;build&gt;
        &lt;plugins&gt;
          &lt;plugin&gt;
            &lt;artifactId&gt;maven-compiler-plugin&lt;/artifactId&gt;
            &lt;version&gt;3.10.1&lt;/version&gt;
            &lt;configuration&gt;
              &lt;fork&gt;true&lt;/fork&gt; &lt;!-- Must fork or else JVM arguments are ignored. --&gt;
              &lt;compilerArguments&gt;
                &lt;Xmaxerrs&gt;10000&lt;/Xmaxerrs&gt;
                &lt;Xmaxwarns&gt;10000&lt;/Xmaxwarns&gt;
              &lt;/compilerArguments&gt;
              &lt;annotationProcessorPaths&gt;
                &lt;path&gt;
                  &lt;groupId&gt;io.github.eisop&lt;/groupId&gt;
                  &lt;artifactId&gt;checker&lt;/artifactId&gt;
                  &lt;version&gt;3.34.0-eisop1&lt;/version&gt;
                &lt;/path&gt;
              &lt;/annotationProcessorPaths&gt;
              &lt;annotationProcessors&gt;
                &lt;!-- Add all the checkers you want to enable here --&gt;
                &lt;annotationProcessor&gt;org.checkerframework.checker.nullness.NullnessChecker&lt;/annotationProcessor&gt;
              &lt;/annotationProcessors&gt;
              &lt;compilerArgs&gt;
                &lt;!-- &lt;arg&gt;-Awarns&lt;/arg&gt; --&gt; &lt;!-- -Awarns turns type-checking errors into warnings. --&gt;
              &lt;/compilerArgs&gt;
            &lt;/configuration&gt;
          &lt;/plugin&gt;
        &lt;/plugins&gt;
      &lt;/build&gt;
      &lt;dependencies&gt;
        &lt;dependency&gt;
          &lt;groupId&gt;io.github.eisop&lt;/groupId&gt;
          &lt;artifactId&gt;checker&lt;/artifactId&gt;
          &lt;version&gt;3.34.0-eisop1&lt;/version&gt;
        &lt;/dependency&gt;
      &lt;/dependencies&gt;
    &lt;/profile&gt;

    &lt;profile&gt;
      &lt;id&gt;checkerframework-jdk8&lt;/id&gt;
      &lt;activation&gt;
        &lt;jdk&gt;1.8&lt;/jdk&gt;
      &lt;/activation&gt;
      &lt;!-- using github.com/google/error-prone-javac is required when running on JDK 8 --&gt;
      &lt;properties&gt;
        &lt;javac.version&gt;9+181-r4173-1&lt;/javac.version&gt;
      &lt;/properties&gt;
      &lt;dependencies&gt;
        &lt;dependency&gt;
          &lt;groupId&gt;com.google.errorprone&lt;/groupId&gt;
          &lt;artifactId&gt;javac&lt;/artifactId&gt;
          &lt;version&gt;9+181-r4173-1&lt;/version&gt;
        &lt;/dependency&gt;
      &lt;/dependencies&gt;
      &lt;build&gt;
        &lt;plugins&gt;
          &lt;plugin&gt;
            &lt;groupId&gt;org.apache.maven.plugins&lt;/groupId&gt;
            &lt;artifactId&gt;maven-compiler-plugin&lt;/artifactId&gt;
            &lt;configuration&gt;
              &lt;fork&gt;true&lt;/fork&gt;
              &lt;compilerArgs combine.children="append"&gt;
                &lt;arg&gt;-J-Xbootclasspath/p:${settings.localRepository}/com/google/errorprone/javac/${javac.version}/javac-${javac.version}.jar&lt;/arg&gt;
              &lt;/compilerArgs&gt;
            &lt;/configuration&gt;
          &lt;/plugin&gt;
        &lt;/plugins&gt;
      &lt;/build&gt;
    &lt;/profile&gt;

    &lt;profile&gt;
      &lt;id&gt;checkerframework-jdk9orlater&lt;/id&gt;
      &lt;activation&gt;
        &lt;jdk&gt;[9,)&lt;/jdk&gt;
      &lt;/activation&gt;
      &lt;build&gt;
        &lt;plugins&gt;
          &lt;plugin&gt;
            &lt;groupId&gt;org.apache.maven.plugins&lt;/groupId&gt;
            &lt;artifactId&gt;maven-compiler-plugin&lt;/artifactId&gt;
            &lt;configuration&gt;
              &lt;fork&gt;true&lt;/fork&gt;
              &lt;compilerArgs combine.children="append"&gt;
                &lt;arg&gt;-J--add-exports=jdk.compiler/com.sun.tools.javac.api=ALL-UNNAMED&lt;/arg&gt;
                &lt;arg&gt;-J--add-exports=jdk.compiler/com.sun.tools.javac.code=ALL-UNNAMED&lt;/arg&gt;
                &lt;arg&gt;-J--add-exports=jdk.compiler/com.sun.tools.javac.file=ALL-UNNAMED&lt;/arg&gt;
                &lt;arg&gt;-J--add-exports=jdk.compiler/com.sun.tools.javac.main=ALL-UNNAMED&lt;/arg&gt;
                &lt;arg&gt;-J--add-exports=jdk.compiler/com.sun.tools.javac.model=ALL-UNNAMED&lt;/arg&gt;
                &lt;arg&gt;-J--add-exports=jdk.compiler/com.sun.tools.javac.processing=ALL-UNNAMED&lt;/arg&gt;
                &lt;arg&gt;-J--add-exports=jdk.compiler/com.sun.tools.javac.tree=ALL-UNNAMED&lt;/arg&gt;
                &lt;arg&gt;-J--add-exports=jdk.compiler/com.sun.tools.javac.util=ALL-UNNAMED&lt;/arg&gt;
                &lt;arg&gt;-J--add-opens=jdk.compiler/com.sun.tools.javac.comp=ALL-UNNAMED&lt;/arg&gt;
              &lt;/compilerArgs&gt;
            &lt;/configuration&gt;
          &lt;/plugin&gt;
        &lt;/plugins&gt;
      &lt;/build&gt;
      &lt;properties&gt;
        &lt;!-- Needed for animal-sniffer-maven-plugin version 1.19 which is broken (version 1.20 is fixed). --&gt;
        &lt;animal.sniffer.skip&gt;true&lt;/animal.sniffer.skip&gt;
      &lt;/properties&gt;
    &lt;/profile&gt;
  &lt;/profiles&gt;
</pre>
</div><p>Now, building with Maven will run the checkers during every compilation
that uses JDK 8 or higher.</p><p>If you wish to run checkers while compiling your source code but not your
tests, wrap the <span style="font-family:monospace">&lt;configuration&gt;...&lt;/configuration&gt;</span> within</p><pre class="verbatim">&lt;executions&gt;
  &lt;execution&gt;
    &lt;id&gt;default-compile&lt;/id&gt;
    ...
  &lt;/execution&gt;
&lt;/executions&gt;
</pre><p>To compile without using the Checker Framework, pass
<span style="font-family:monospace">-P !checkerframework</span>
on the Maven command line.
</p><p>Warning: adding</p><div style="font-size:small;">
<pre>
&lt;compilerArgs&gt;
  ...
  &lt;arg&gt;-verbose&lt;/arg&gt;
</pre>
</div><p>may suppress warnings from the stub parser.</p></li></ol>
<!--TOC subsection id="maven-locally-built" Maven, with a locally-built version of the Checker Framework-->
<h3 id="maven-locally-built" class="subsection">37.12.1 Maven, with a locally-built version of the Checker Framework <a href="#maven-locally-built"><img src="chainlink.svg" width="10" height="10"></a></h3><!--SEC END --><p>To use a locally-built version of the Checker Framework, first run:</p><pre>
./gradlew publishToMavenLocal
</pre><p>Then use the Maven instructions, but modify the version number for the
Checker Framework artifacts. Instead of <span style="font-family:monospace">3.34.0-eisop1</span>, use the
version number that is output when you run <span style="font-family:monospace">./gradlew version</span>.</p>
<!--TOC section id="netbeans" NetBeans-->
<h2 id="netbeans" class="section">37.13 NetBeans <a href="#netbeans"><img src="chainlink.svg" width="10" height="10"></a></h2><!--SEC END --><p>There are two approaches to running a checker in NetBeans: via modifying the
project properties, or via a custom ant target.</p><p>Note: The “compile and save” action in NetBeans 8.1 automatically
runs the Checker Framework, but this functionality has not yet
been incorporated into NetBeans 8.2. Additionally, JDK annotations
are currently unavailable on NetBeans 8.1 and 8.2.</p>
<!--TOC subsection id="netbeans-project-properties" Adding a checker via the Project Properties window-->
<h3 id="netbeans-project-properties" class="subsection">37.13.1 Adding a checker via the Project Properties window <a href="#netbeans-project-properties"><img src="chainlink.svg" width="10" height="10"></a></h3><!--SEC END --><ol class="enumerate" type=1><li class="li-enumerate">
Add the Checker Framework libraries to your project’s
library. First, right click on the project in the Projects panel,
and select “Properties” in the drop-down menu. Then, in the
“Project Properties” window, navigate to the “Libraries” tab.</li><li class="li-enumerate">Add <span style="font-family:monospace">checker-qual.jar</span> to the compile-time libraries. To do so,
select the “Compile” tab, click the “Add JAR/Folder” button on
the right and browse to
add <span style="font-family:monospace">$CHECKERFRAMEWORK/checker/dist/checker-qual.jar</span>.</li><li class="li-enumerate">Add <span style="font-family:monospace">checker.jar</span> to the processor-path libraries. To do so, select
the “Processor” tab, click the “Add JAR/Folder” button on the
right and browse to
add <span style="font-family:monospace">$CHECKERFRAMEWORK/checker/dist/checker.jar</span>.</li><li class="li-enumerate">Enable annotation processor underlining in the editor. Go to
“Build&gt;Compiling” and check the box “Enable Annotation
Processing,” and under that, “Enable Annotation Processing in
Editor.”</li><li class="li-enumerate">Add the checker to run, by clicking “Add” next to the box labeled
“Annotation Processors” and enter the fully qualified name of the
checker (for
example, <span style="font-family:monospace">org.checkerframework.checker.nullness.NullnessChecker</span>)
and click “OK” to add.
</li></ol><p>The selected checker should be run on the project either on a save (if
Compile on Save is enabled), or when the project is built, and
annotation processor output will appear in the editor.</p>
<!--TOC subsection id="netbeans-ant-target" Adding a checker via an ant target-->
<h3 id="netbeans-ant-target" class="subsection">37.13.2 Adding a checker via an ant target <a href="#netbeans-ant-target"><img src="chainlink.svg" width="10" height="10"></a></h3><!--SEC END --><ol class="enumerate" type=1><li class="li-enumerate">
Set the <span style="font-family:monospace">cfJavac</span> property:<pre class="verbatim">  &lt;property environment="env"/&gt;
  &lt;property name="checkerframework" value="${env.CHECKERFRAMEWORK}" /&gt;
  &lt;condition property="cfJavac" value="javac.bat" else="javac"&gt;
    &lt;os family="windows" /&gt;
  &lt;/condition&gt;
  &lt;presetdef name="cf.javac"&gt;
    &lt;javac fork="yes" executable="${checkerframework}/checker/bin/${cfJavac}" &gt;
      &lt;compilerarg value="-version"/&gt;
      &lt;compilerarg value="-implicit:class"/&gt;
    &lt;/javac&gt;
  &lt;/presetdef&gt;
</pre></li><li class="li-enumerate">Override the <span style="font-family:monospace">-init-macrodef-javac-with-processors</span> target to
use <span style="font-family:monospace">cf.javac</span> instead of <span style="font-family:monospace">javac</span> and to run the checker.
In this example, a nullness checker is run:<pre class="verbatim">  &lt;target depends="-init-ap-cmdline-properties" if="ap.supported.internal"
        name="-init-macrodef-javac-with-processors"&gt;
    &lt;echo message = "${checkerframework}"/&gt;
    &lt;macrodef name="javac" uri="http://www.netbeans.org/ns/j2se-project/3"&gt;
        &lt;attribute default="${src.dir}" name="srcdir"/&gt;
        &lt;attribute default="${build.classes.dir}" name="destdir"/&gt;
        &lt;attribute default="${javac.classpath}" name="classpath"/&gt;
        &lt;attribute default="${javac.processorpath}" name="processorpath"/&gt;
        &lt;attribute default="${build.generated.sources.dir}/ap-source-output" name="apgeneratedsrcdir"/&gt;
        &lt;attribute default="${includes}" name="includes"/&gt;
        &lt;attribute default="${excludes}" name="excludes"/&gt;
        &lt;attribute default="${javac.debug}" name="debug"/&gt;
        &lt;attribute default="${empty.dir}" name="sourcepath"/&gt;
        &lt;attribute default="${empty.dir}" name="gensrcdir"/&gt;
        &lt;element name="customize" optional="true"/&gt;
        &lt;sequential&gt;
            &lt;property location="${build.dir}/empty" name="empty.dir"/&gt;
            &lt;mkdir dir="${empty.dir}"/&gt;
            &lt;mkdir dir="@{apgeneratedsrcdir}"/&gt;
            &lt;cf.javac debug="@{debug}" deprecation="${javac.deprecation}"
                    destdir="@{destdir}" encoding="${source.encoding}"
                    excludes="@{excludes}" fork="${javac.fork}"
                    includeantruntime="false" includes="@{includes}"
                    source="${javac.source}" sourcepath="@{sourcepath}"
                    srcdir="@{srcdir}" target="${javac.target}"
                    tempdir="${java.io.tmpdir}"&gt;
                &lt;src&gt;
                    &lt;dirset dir="@{gensrcdir}" erroronmissingdir="false"&gt;
                        &lt;include name="*"/&gt;
                    &lt;/dirset&gt;
                &lt;/src&gt;
                &lt;classpath&gt;
                    &lt;path path="@{classpath}"/&gt;
                &lt;/classpath&gt;
                &lt;compilerarg line="${endorsed.classpath.cmd.line.arg}"/&gt;
                &lt;compilerarg line="${javac.profile.cmd.line.arg}"/&gt;
                &lt;compilerarg line="${javac.compilerargs}"/&gt;
                &lt;compilerarg value="-processorpath"/&gt;
                &lt;compilerarg path="@{processorpath}:${empty.dir}"/&gt;
                &lt;compilerarg line="${ap.processors.internal}"/&gt;
                &lt;compilerarg line="${annotation.processing.processor.options}"/&gt;
                &lt;compilerarg value="-s"/&gt;
                &lt;compilerarg path="@{apgeneratedsrcdir}"/&gt;
                &lt;compilerarg line="${ap.proc.none.internal}"/&gt;
                &lt;compilerarg line="-processor org.checkerframework.checker.nullness.NullnessChecker"/&gt;
                &lt;compilerarg line="-Xmaxerrs 10000"/&gt;
                &lt;compilerarg line="-Xmaxwarns 10000"/&gt;
                &lt;customize/&gt;
            &lt;/cf.javac&gt;
        &lt;/sequential&gt;
    &lt;/macrodef&gt;
  &lt;/target&gt;
  &lt;target name="-post-jar"&gt;
  &lt;/target&gt;
</pre><p>When Build and Clean Project is used, the output of the checker will
now appear in the build console. However, annotation processor output
will not appear in the editor.</p></li></ol>
<!--TOC section id="sbt" sbt-->
<h2 id="sbt" class="section">37.14 sbt <a href="#sbt"><img src="chainlink.svg" width="10" height="10"></a></h2><!--SEC END --><p><a href="https://www.scala-sbt.org/">sbt</a> is a build tool for
Scala, Java, and more.</p><p>Adjust the <span style="font-family:monospace">-processor</span> command-line argument for the processor(s)
you wish to run (see Section ‍<a href="#running">2.2</a>).</p>
<!--TOC subsection id="sbt-jdk8" JDK 8-->
<h3 id="sbt-jdk8" class="subsection">37.14.1 JDK 8 <a href="#sbt-jdk8"><img src="chainlink.svg" width="10" height="10"></a></h3><!--SEC END --><pre class="verbatim">javacOptions ++= Seq(
    "-J-Xbootclasspath/p:$CHECKERFRAMEWORK/checker/dist/javac.jar",
    "-cp $CHECKERFRAMEWORK/checker/dist/checker-qual.jar",
    "-processorpath $CHECKERFRAMEWORK/checker/dist/checker.jar",
    "-processor org.checkerframework.checker.nullness.NullnessChecker",
    "-source 8", "-target 8"
  )
</pre>
<!--TOC subsection id="sbt-jdk11-nonmodularized-code" JDK 11 and later, for non-modularized code-->
<h3 id="sbt-jdk11-nonmodularized-code" class="subsection">37.14.2 JDK 11 and later, for non-modularized code <a href="#sbt-jdk11-nonmodularized-code"><img src="chainlink.svg" width="10" height="10"></a></h3><!--SEC END --><pre class="verbatim">javacOptions ++= Seq(
    "-J--add-exports=jdk.compiler/com.sun.tools.javac.api=ALL-UNNAMED",
    "-J--add-exports=jdk.compiler/com.sun.tools.javac.code=ALL-UNNAMED",
    "-J--add-exports=jdk.compiler/com.sun.tools.javac.file=ALL-UNNAMED",
    "-J--add-exports=jdk.compiler/com.sun.tools.javac.main=ALL-UNNAMED",
    "-J--add-exports=jdk.compiler/com.sun.tools.javac.model=ALL-UNNAMED",
    "-J--add-exports=jdk.compiler/com.sun.tools.javac.processing=ALL-UNNAMED",
    "-J--add-exports=jdk.compiler/com.sun.tools.javac.tree=ALL-UNNAMED",
    "-J--add-exports=jdk.compiler/com.sun.tools.javac.util=ALL-UNNAMED",
    "-J--add-opens=jdk.compiler/com.sun.tools.javac.comp=ALL-UNNAMED",
    "-processorpath $CHECKERFRAMEWORK/checker/dist/checker.jar",
    "-cp $CHECKERFRAMEWORK/checker/dist/checker-qual.jar",
    "-processor org.checkerframework.checker.nullness.NullnessChecker"
  )
</pre>
<!--TOC subsection id="sbt-modularized-code" For modularized code-->
<h3 id="sbt-modularized-code" class="subsection">37.14.3 For modularized code <a href="#sbt-modularized-code"><img src="chainlink.svg" width="10" height="10"></a></h3><!--SEC END --><pre class="verbatim">For compiling modularized code:
javacOptions ++= Seq(
    "-J--add-exports=jdk.compiler/com.sun.tools.javac.api=ALL-UNNAMED",
    "-J--add-exports=jdk.compiler/com.sun.tools.javac.code=ALL-UNNAMED",
    "-J--add-exports=jdk.compiler/com.sun.tools.javac.file=ALL-UNNAMED",
    "-J--add-exports=jdk.compiler/com.sun.tools.javac.main=ALL-UNNAMED",
    "-J--add-exports=jdk.compiler/com.sun.tools.javac.model=ALL-UNNAMED",
    "-J--add-exports=jdk.compiler/com.sun.tools.javac.processing=ALL-UNNAMED",
    "-J--add-exports=jdk.compiler/com.sun.tools.javac.tree=ALL-UNNAMED",
    "-J--add-exports=jdk.compiler/com.sun.tools.javac.util=ALL-UNNAMED",
    "-J--add-opens=jdk.compiler/com.sun.tools.javac.comp=ALL-UNNAMED",
    "-processorpath $CHECKERFRAMEWORK/checker/dist/checker.jar",
    "--module-path $CHECKERFRAMEWORK/checker/dist/checker-qual.jar",
    "-processor org.checkerframework.checker.nullness.NullnessChecker"
  )
</pre>
<!--TOC section id="tide" tIDE-->
<h2 id="tide" class="section">37.15 tIDE <a href="#tide"><img src="chainlink.svg" width="10" height="10"></a></h2><!--SEC END --><p>
tIDE, an open-source Java IDE, supports the Checker Framework.
You can download it from <a href="https://sourceforge.net/projects/tide/"><span style="font-family:monospace">https://sourceforge.net/projects/tide/</span></a>.
</p>
<!--TOC section id="type-inference-varieties" Type inference tools-->
<h2 id="type-inference-varieties" class="section">37.16 Type inference tools <a href="#type-inference-varieties"><img src="chainlink.svg" width="10" height="10"></a></h2><!--SEC END --><p>A type inference tool infers type annotations for a program’s method
signatures and fields, so that the programmer does not need to manually
annotate the program’s source code. Section ‍<a href="#type-inference-tools">33.1</a>
lists type inference tools.</p><hr>
<!--TOC chapter id="faq" Frequently Asked Questions (FAQs)-->
<h1 id="faq" class="chapter">Chapter ‍38 Frequently Asked Questions (FAQs) <a href="#faq"><img src="chainlink.svg" width="10" height="10"></a></h1><!--SEC END --><p>These are some common questions about the Checker Framework and about
pluggable type-checking in general. Feel free to suggest improvements to
the answers, or other questions to include here.</p><p><span style="font-weight:bold">Contents:</span></p><p><a href="#faq-motivation-section"><span style="font-weight:bold">38.1</span></a><span style="font-weight:bold">: Motivation for pluggable type-checking</span>
<br>
<a href="#faq-never-make-type-errors">38.1.1</a>: I don’t make type errors, so would pluggable type-checking help me?
<br>
<a href="#faq-typequals-vs-subtypes">38.1.2</a>: Should I use pluggable types (type qualifiers), or should I use Java subtypes?</p><p><a href="#faq-getting-started-section"><span style="font-weight:bold">38.2</span></a><span style="font-weight:bold">: Getting started</span>
<br>
<a href="#faq-annotate-existing-program">38.2.1</a>: How do I get started annotating an existing program?
<br>
<a href="#faq-first-checker">38.2.2</a>: Which checker should I start with?
<br>
<a href="#faq-checker-framework-dev">38.2.3</a>: How can I join the checker-framework-dev mailing list?</p><p><a href="#faq-usability-section"><span style="font-weight:bold">38.3</span></a><span style="font-weight:bold">: Usability of pluggable type-checking</span>
<br>
<a href="#faq-ease-of-use">38.3.1</a>: Are type annotations easy to read and write?
<br>
<a href="#faq-code-clutter">38.3.2</a>: Will my code become cluttered with type annotations?
<br>
<a href="#faq-slowdown">38.3.3</a>: Will using the Checker Framework slow down my program? Will it slow down the compiler?
<br>
<a href="#faq-shorten-command-line">38.3.4</a>: How do I shorten the command line when invoking a checker?
<br>
<a href="#faq-pre-conditions">38.3.5</a>: Method pre-condition contracts, including formal parameter annotations, make no sense for public methods.</p><p><a href="#faq-warnings-section"><span style="font-weight:bold">38.4</span></a><span style="font-weight:bold">: How to handle warnings</span>
<br>
<a href="#faq-handling-warnings">38.4.1</a>: What should I do if a checker issues a warning about my code?
<br>
<a href="#faq-warning-after-check">38.4.2</a>: Why does a checker issue a warning even though the code checks a property?
<br>
<a href="#faq-interpreting-warnings">38.4.3</a>: What does a certain Checker Framework warning message mean?
<br>
<a href="#faq-warnings-square-brackets">38.4.4</a>: What do square brackets mean in a Checker Framework warning message?
<br>
<a href="#faq-no-absolute-guarantee">38.4.5</a>: Can a pluggable type-checker guarantee that my code is correct?
<br>
<a href="#faq-concurrency">38.4.6</a>: What guarantee does the Checker Framework give for concurrent code?
<br>
<a href="#faq-awarns">38.4.7</a>: How do I make compilation succeed even if a checker issues errors?
<br>
<a href="#faq-100-warnings">38.4.8</a>: Why does the checker always say there are 100 errors or warnings?
<br>
<a href="#faq-type-i-did-not-write">38.4.9</a>: Why does the Checker Framework report an error regarding a type I have not written in my program?
<br>
<a href="#faq-same-code-different-behavior">38.4.10</a>: Why does the Checker Framework accept code on one line but reject it on the next?
<br>
<a href="#faq-run-time-checking">38.4.11</a>: How can I do run-time monitoring of properties that were not statically checked?</p><p><a href="#faq-false-positives-section"><span style="font-weight:bold">38.5</span></a><span style="font-weight:bold">: False positive warnings</span>
<br>
<a href="#faq-false-positive">38.5.1</a>: What is a “false positive” warning?
<br>
<a href="#faq-false-positive-extend-checker-framework">38.5.2</a>: How can I improve the Checker Framework to eliminate a false positive warning?
<br>
<a href="#faq-infer-fields">38.5.3</a>: Why doesn’t the Checker Framework infer types for fields and method return types?
<br>
<a href="#faq-relationships-between-variables">38.5.4</a>: Why doesn’t the Checker Framework track relationships between variables?
<br>
<a href="#faq-path-sensitive">38.5.5</a>: Why isn’t the Checker Framework path-sensitive?</p><p><a href="#faq-syntax-section"><span style="font-weight:bold">38.6</span></a><span style="font-weight:bold">: Syntax of type annotations</span>
<br>
<a href="#faq-receiver">38.6.1</a>: What is a “receiver”?
<br>
<a href="#faq-annotation-after-type">38.6.2</a>: What is the meaning of an annotation after a type, such as <span style="font-family:monospace">@NonNull Object @Nullable</span>?
<br>
<a href="#faq-array-syntax-meaning">38.6.3</a>: What is the meaning of array annotations such as <span style="font-family:monospace">@NonNull Object @Nullable []</span>?
<br>
<a href="#faq-varargs-syntax-meaning">38.6.4</a>: What is the meaning of varargs annotations such as <span style="font-family:monospace">@English String @NonEmpty ‍...</span>?
<br>
<a href="#faq-type-qualifier-on-class-declaration">38.6.5</a>: What is the meaning of a type qualifier at a class declaration?
<br>
<a href="#faq-type-qualifier-on-bounds">38.6.6</a>: How are type qualifiers written on upper and lower bounds?
<br>
<a href="#faq-no-annotation-on-types-and-declarations">38.6.7</a>: Why shouldn’t a qualifier apply to both types and declarations?
<br>
<a href="#faq-annotate-fully-qualified-name">38.6.8</a>: How do I annotate a
fully-qualified type name?
<br>
<a href="#faq-declaration-annotations-moved">38.6.9</a>: How does the Checker Framework handle obsolete declaration annotations?
<br>
<a href="#faq-type-vs-declaration-annotations">38.6.10</a>: What is the difference between type annotations and declaration annotations?
<br>
<a href="#faq-type-annotation-formatting">38.6.11</a>: How should type annotations be formatted in source code? Where should I write type annotations?</p><p><a href="#faq-semantics-section"><span style="font-weight:bold">38.7</span></a><span style="font-weight:bold">: Semantics of type annotations</span>
<br>
<a href="#faq-typestate">38.7.1</a>: How can I handle typestate, or phases of my program with different data properties?
<br>
<a href="#faq-implicit-bounds">38.7.2</a>: Why are explicit and implicit bounds defaulted differently?
<br>
<a href="#faq-writing-generics">38.7.3</a>: How should I annotate code that uses generics?
<br>
<a href="#faq-runtime-retention">38.7.4</a>: Why are type annotations declared with <span style="font-family:monospace">@Retention(RetentionPolicy.RUNTIME)</span>?</p><p><a href="#faq-create-a-checker-section"><span style="font-weight:bold">38.8</span></a><span style="font-weight:bold">: Creating a new checker</span>
<br>
<a href="#faq-create-a-checker">38.8.1</a>: How do I create a new checker?
<br>
<a href="#faq-type-properties">38.8.2</a>: What properties can and cannot be handled by type-checking?
<br>
<a href="#faq-declarative-syntax-for-type-rules">38.8.3</a>: Why is there no declarative syntax for writing type rules?</p><p><a href="#faq-tool-section"><span style="font-weight:bold">38.9</span></a><span style="font-weight:bold">: Tool questions</span>
<br>
<a href="#faq-pluggable-type-checking">38.9.1</a>: How does pluggable type-checking work?
<br>
<a href="#faq-classpath-to-use-annotated-library">38.9.2</a>: What classpath is needed to use an annotated library?
<br>
<a href="#faq-classfile-annotations">38.9.3</a>: Why do <span style="font-family:monospace">.class</span> files contain more annotations than the source code?
<br>
<a href="#faq-checked-exceptions">38.9.4</a>: Is there a type-checker for managing checked and unchecked exceptions?
<br>
<a href="#faq-cf-is-slow">38.9.5</a>: The Checker Framework runs too slowly
<br>
<a href="#faq-version-number">38.9.6</a>: What does the Checker Framework version number mean?</p><p><a href="#faq-other-tools-section"><span style="font-weight:bold">38.10</span></a><span style="font-weight:bold">: Relationship to other tools</span>
<br>
<a href="#faq-type-checking-vs-bug-detectors">38.10.1</a>: Why not just use a bug detector (like SpotBugs or Error Prone)?
<br>
<a href="#faq-eclipse">38.10.2</a>: How does the Checker Framework compare with Eclipse’s Null Analysis?
<br>
<a href="#faq-nullaway">38.10.3</a>: How does the Checker Framework compare with NullAway?
<br>
<a href="#faq-optional">38.10.4</a>: How does the Checker Framework compare with the JDK’s <span style="font-family:monospace">Optional</span> type?
<br>
<a href="#faq-jml">38.10.5</a>: How does pluggable type-checking compare with JML?
<br>
<a href="#faq-checker-framework-part-of-java">38.10.6</a>: Is the Checker Framework an official part of Java?
<br>
<a href="#faq-jsr-305">38.10.7</a>: What is the relationship between the Checker Framework and JSR 305?
<br>
<a href="#faq-jsr-308">38.10.8</a>: What is the relationship between the Checker Framework and JSR 308?</p>
<!--TOC section id="faq-motivation-section" Motivation for pluggable type-checking-->
<h2 id="faq-motivation-section" class="section">38.1 Motivation for pluggable type-checking <a href="#faq-motivation-section"><img src="chainlink.svg" width="10" height="10"></a></h2><!--SEC END -->
<!--TOC subsection id="faq-never-make-type-errors" I don’t make type errors, so would pluggable type-checking help me?-->
<h3 id="faq-never-make-type-errors" class="subsection">38.1.1 I don’t make type errors, so would pluggable type-checking help me? <a href="#faq-never-make-type-errors"><img src="chainlink.svg" width="10" height="10"></a></h3><!--SEC END --><p>Occasionally, a developer says that he makes no errors that type-checking
could catch, or that any such errors are unimportant because they have low
impact and are easy to fix. When I investigate the claim, I invariably
find that the developer is mistaken.</p><p>Very frequently, the developer has underestimated what type-checking can
discover. Not every type error leads to an exception being thrown; and
even if an exception is thrown, it may not seem related to classical types.
Remember that a type system can discover
null pointer dereferences,
incorrect side effects,
security errors such as information leakage or SQL injection,
partially-initialized data,
wrong units of measurement,
and many other errors.
Every programmer makes errors sometimes and works with other people
who do.
Even where type-checking does not discover a
problem directly, it can indicate code with bad smells, thus revealing
problems, improving documentation, and making future maintenance easier.</p><p>There are other ways to discover errors, including extensive testing and
debugging. You should continue to use these.
But type-checking is a good complement to these. Type-checking is more
effective for some problems, and less effective for other problems. It can
reduce (but not eliminate) the time and effort that you spend on other
approaches. There are many important errors that type-checking and other
automated approaches cannot find; pluggable type-checking gives you more
time to focus on those.</p>
<!--TOC subsection id="faq-typequals-vs-subtypes" Should I use pluggable types (type qualifiers), or should I use Java subtypes?-->
<h3 id="faq-typequals-vs-subtypes" class="subsection">38.1.2 Should I use pluggable types (type qualifiers), or should I use Java subtypes? <a href="#faq-typequals-vs-subtypes"><img src="chainlink.svg" width="10" height="10"></a></h3><!--SEC END --><p><a id="when-to-use-type-qualifiers"></a>
<a id="faq-qualifiers-vs-subclasses"></a></p><p>In brief, use subtypes when you can, and use type qualifiers when you cannot
use subtypes.</p><p>For some programming tasks, you can use either a Java subtype (interfaces
or subclasses) or a type
qualifier. As an example, suppose that your code currently uses <span style="font-family:monospace">String</span> to
represent an address. You could use Java subclasses by creating a new
<span style="font-family:monospace">Address</span> class and refactor your code to use it, or you could use
type qualifiers by creating an <span style="font-family:monospace">@Address</span> annotation and applying it
to some uses of <span style="font-family:monospace">String</span> in your code. As another example, suppose
that your code currently uses <span style="font-family:monospace">MyClass</span> in two different ways that
should not interact with one another. You could use Java subclasses by
changing MyClass into an interface or abstract class, defining two
subclasses, and ensuring that neither subclass ever refers to the other
subclass nor to the parent class.</p><p>If Java subclasses solve your problem, then that is probably better.
We do not encourage you to use type qualifiers as a poor substitute for
classes. An advantage of using classes is that the Java type-checker
runs every time you compile your code;
by contrast, it is possible to forget to run the pluggable
type-checker. However, sometimes type qualifiers are a
better choice; here are some reasons:</p><dl class="description"><dt class="dt-description"><span style="font-weight:bold">Backward compatibility</span></dt><dd class="dd-description">
Using a new class may make your code incompatible with existing libraries or
clients. You may need to write a conversion at every call to and return
from a library call; these conversions add clutter, reduce performance, and
(by creating new objects) break object equality properties.
Brian Goetz also notes some problems in an article on the
pseudo-typedef antipattern ‍[<a href="#Goetz2006%3Atypedef">Goe06</a>].<p>It is possible to add annotations to code you do not maintain or cannot
change; for example, you
can write library annotations (see Chapter ‍<a href="#annotating-libraries">34</a>).</p></dd><dt class="dt-description"><span style="font-weight:bold">Composability</span></dt><dd class="dd-description">
A Java object has just one class at run time. You care about multiple
correctness properties, then using the Java type system requires a
combinatorial number of classes (all possible combinations). By contrast,
arbitrary type qualifiers can be used at the same time.</dd><dt class="dt-description"><span style="font-weight:bold">No new bugs</span></dt><dd class="dd-description">
A code change may introduce bugs, whereas adding
annotations does not change the run-time behavior.</dd><dt class="dt-description"><span style="font-weight:bold">Broader applicability</span></dt><dd class="dd-description">
Type annotations can be applied to primitives and to final classes such as
<span style="font-family:monospace">String</span>, which cannot be subclassed.</dd><dt class="dt-description"><span style="font-weight:bold">Richer semantics and new supertypes</span></dt><dd class="dd-description">
Type qualifiers permit you to remove operations, with a compile-time
guarantee. More
generally, type qualifiers permit creating a new supertype, not just a
subtype, of an existing Java type.</dd><dt class="dt-description"><span style="font-weight:bold">More precise type-checking</span></dt><dd class="dd-description">
The Checker Framework is able to verify the correctness of code that the
Java type-checker would reject. Here are a few examples.
<ul class="itemize"><li class="li-itemize">
It uses a dataflow analysis to determine a more precise type for
variables after conditional tests or assignments.
</li><li class="li-itemize">It treats certain Java constructs more precisely, such as
reflection (see Chapter ‍<a href="#reflection-resolution">24</a>).
</li><li class="li-itemize">It includes special-case logic for type-checking specific methods, such
as the Nullness Checker’s treatment of <span style="font-family:monospace">Map.get</span>.
</li></ul></dd><dt class="dt-description"><span style="font-weight:bold">Partial annotation</span></dt><dd class="dd-description">
You can add type annotations to just part of your code, and suppress
warnings at entry points to the annotated portion. By contrast, using a
new Java type requires using it everywhere or writing conversion routines
at every entry point.</dd><dt class="dt-description"><span style="font-weight:bold">Efficiency</span></dt><dd class="dd-description">
Type qualifiers have no run-time representation. Therefore, there is no
space overhead for separate classes or for wrapper classes for
primitives. There is no run-time overhead for due to extra dereferences
or dynamic dispatch for methods that could otherwise be statically
dispatched.</dd><dt class="dt-description"><span style="font-weight:bold">Less code clutter</span></dt><dd class="dd-description">
The programmer does not have to convert primitive types to wrappers,
which would make the code both uglier and slower. Thanks to defaults and
type refinement (Section ‍<a href="#defaults">31.5</a>),
you may be able to write and think in terms of the
original Java type, rather than having to explicitly write one of the
subtypes in all locations.</dd></dl><p>For more details, see Section ‍<a href="#faq-typequals-vs-subtypes">38.1.2</a>.</p>
<!--TOC section id="faq-getting-started-section" Getting started-->
<h2 id="faq-getting-started-section" class="section">38.2 Getting started <a href="#faq-getting-started-section"><img src="chainlink.svg" width="10" height="10"></a></h2><!--SEC END -->
<!--TOC subsection id="faq-annotate-existing-program" How do I get started annotating an existing program?-->
<h3 id="faq-annotate-existing-program" class="subsection">38.2.1 How do I get started annotating an existing program? <a href="#faq-annotate-existing-program"><img src="chainlink.svg" width="10" height="10"></a></h3><!--SEC END --><p>See Section ‍<a href="#get-started-with-legacy-code">2.4.2</a>.</p>
<!--TOC subsection id="faq-first-checker" Which checker should I start with?-->
<h3 id="faq-first-checker" class="subsection">38.2.2 Which checker should I start with? <a href="#faq-first-checker"><img src="chainlink.svg" width="10" height="10"></a></h3><!--SEC END --><p>You should start with a property that matters to you. Think about what
aspects of your code cause the most errors, or cost the most time during
maintenance, or are the most common to be incorrectly-documented. Focusing
on what you care about will give you the best benefits.</p><p>When you first start out with the Checker Framework, it’s usually best to
get experience with an existing type-checker before you write your own new
checker.</p><p>Many users are tempted to start with the
<a href="#nullness-checker">Nullness Checker</a> (see
Chapter ‍<a href="#nullness-checker">3</a>), since null pointer errors are common
and familiar. The Nullness Checker works very well, but be warned of three
facts that make the absence of null pointer exceptions challenging to
verify.</p><ol class="enumerate" type=1><li class="li-enumerate">
Dereferences happen throughout your codebase, so there are a lot of
potential problems. By contrast, fewer lines of code are related to
locking, regular expressions, etc., so those properties are easier to
check.
</li><li class="li-enumerate">Programmers use <span style="font-family:monospace">null</span> for many different purposes. More seriously,
programmers write run-time tests against <span style="font-family:monospace">null</span>, and those are difficult
for any static analysis to capture.
</li><li class="li-enumerate">The Nullness Checker interacts with initialization and map keys.
</li></ol><p>If null pointer exceptions are most important to you, then by all means use
the Nullness Checker. But if you just want to try <em>some</em>
type-checker, there are others that are easier to use.</p><p>We do not recommend indiscriminately running all the checkers on your code.
The reason is that each one has a cost — not just at compile time, but
also in terms of code clutter and human time to maintain the annotations.
If the property is important to you, is difficult for people to reason
about, or has caused problems in the past, then you should run that
checker. For other properties, the benefits may not repay the effort to
use it. You will be the best judge of this for your own code, of course.</p><p>Some of the third-party checkers (see
Chapter ‍<a href="#third-party-checkers">29</a>)
have known bugs that limit their
usability. (Report the ones that affect you, so the developers
will prioritize fixing them.)</p>
<!--TOC subsection id="faq-checker-framework-dev" How can I join the checker-framework-dev mailing list?-->
<h3 id="faq-checker-framework-dev" class="subsection">38.2.3 How can I join the checker-framework-dev mailing list? <a href="#faq-checker-framework-dev"><img src="chainlink.svg" width="10" height="10"></a></h3><!--SEC END --><p>The <span style="font-family:monospace">checker-framework-dev@googlegroups.com</span> mailing list is for
Checker Framework developers. Anyone is welcome to
<a href="https://groups.google.com/forum/#!forum/checker-framework-dev">join
<span style="font-family:monospace">checker-framework-dev</span></a>, after they have had several pull requests
accepted.</p><p>Anyone is welcome to send mail to the
<span style="font-family:monospace">checker-framework-dev@googlegroups.com</span> mailing list — for
implementation details it is generally a better place for discussions than
the general <span style="font-family:monospace">checker-framework-discuss@googlegroups.com</span> mailing list,
which is for user-focused discussions.</p><p>Anyone is welcome to
<a href="https://groups.google.com/forum/#!forum/checker-framework-discuss">join
<span style="font-family:monospace">checker-framework-discuss@googlegroups.com</span></a> and send mail to it.</p>
<!--TOC section id="faq-usability-section" Usability of pluggable type-checking-->
<h2 id="faq-usability-section" class="section">38.3 Usability of pluggable type-checking <a href="#faq-usability-section"><img src="chainlink.svg" width="10" height="10"></a></h2><!--SEC END -->
<!--TOC subsection id="faq-ease-of-use" Are type annotations easy to read and write?-->
<h3 id="faq-ease-of-use" class="subsection">38.3.1 Are type annotations easy to read and write? <a href="#faq-ease-of-use"><img src="chainlink.svg" width="10" height="10"></a></h3><!--SEC END --><p>The papers
<a href="https://homes.cs.washington.edu/~mernst/pubs/pluggable-checkers-issta2008-abstract.html">“Practical
pluggable types for Java”</a> ‍[<a href="#PapiACPE2008">PAC+08</a>]
and
<a href="https://homes.cs.washington.edu/~mernst/pubs/pluggable-checkers-icse2011-abstract.html">“Building
and using pluggable type-checkers”</a> ‍[<a href="#DietlDEMS2011">DDE+11</a>]
discuss case studies in
which programmers
found type annotations to be natural to read and write. The code
continued to feel like Java, and the type-checking errors were easy to
comprehend and often led to real bugs.</p><p>You don’t have to take our word for it, though. You can try the
Checker Framework for yourself.</p><p>The difficulty of adding and verifying annotations depends on your program.
If your program is well-designed and -documented, then skimming the
existing documentation and writing type annotations is extremely easy.
Otherwise, you may find yourself spending a lot of time trying to
understand, reverse-engineer, or fix bugs in your program, and then just a
moment writing a type annotation that describes what you discovered. This
process inevitably improves your code. You must decide whether it is a
good use of your time. For code that is not causing trouble now and is
unlikely to do so in the future (the code is bug-free, and you do not
anticipate changing it or using it in new contexts), then the
effort of writing type annotations for it may not be justified.</p>
<!--TOC subsection id="faq-code-clutter" Will my code become cluttered with type annotations?-->
<h3 id="faq-code-clutter" class="subsection">38.3.2 Will my code become cluttered with type annotations? <a href="#faq-code-clutter"><img src="chainlink.svg" width="10" height="10"></a></h3><!--SEC END --><p>In summary: annotations do not clutter code; they are used much
less frequently than generic types, which Java programmers find acceptable;
and they reduce the overall volume of documentation that a codebase needs.</p><p>As with any language feature, it is possible to write ugly code that
over-uses annotations. However, in normal use, very few annotations need
to be written. Figure 1 of the paper
<a href="https://homes.cs.washington.edu/~mernst/pubs/pluggable-checkers-issta2008-abstract.html">Practical
pluggable types for Java</a> ‍[<a href="#PapiACPE2008">PAC+08</a>] reports data for over
350,000 lines of type-annotated code:</p><ul class="itemize"><li class="li-itemize">
1 annotation per 62 lines for nullness annotations (<span style="font-family:monospace">@NonNull</span>, <span style="font-family:monospace">@Nullable</span>, etc.)
</li><li class="li-itemize">1 annotation per 1736 lines for interning annotations (<span style="font-family:monospace">@Interned</span>)
</li></ul><p>These numbers are for annotating existing code. New code that
is written with the type annotation system in mind is cleaner and more
correct, so it requires even fewer annotations.</p><p>Each annotation that a programmer writes replaces a sentence or phrase of
English descriptive text that would otherwise have been written in the
Javadoc. So, use of annotations actually reduces the overall size of the
documentation, at the same time as making it machine-processable
and less ambiguous.</p>
<!--TOC subsection id="faq-slowdown" Will using the Checker Framework slow down my program? Will it slow down the compiler?-->
<h3 id="faq-slowdown" class="subsection">38.3.3 Will using the Checker Framework slow down my program? Will it slow down the compiler? <a href="#faq-slowdown"><img src="chainlink.svg" width="10" height="10"></a></h3><!--SEC END --><p>Using the Checker Framework has no impact on the execution of your program:
the compiler emits the identical bytecodes as the javac
compiler and so there is no run-time effect. Because there is no run-time
representation of type qualifiers, there is no way to use reflection to
query the qualifier on a given object, though you can use reflection to
examine a class/method/field declaration.</p><p>Using the Checker Framework does increase compilation time.
It can increase the compilation time by 2–10 times — or more, if you run
many pluggable type-checkers at once. For workarounds, see
Section ‍<a href="#faq-cf-is-slow">38.9.5</a>.</p>
<!--TOC subsection id="faq-shorten-command-line" How do I shorten the command line when invoking a checker?-->
<h3 id="faq-shorten-command-line" class="subsection">38.3.4 How do I shorten the command line when invoking a checker? <a href="#faq-shorten-command-line"><img src="chainlink.svg" width="10" height="10"></a></h3><!--SEC END --><p>
The compile options to javac can be long to type; for example,
<span style="font-family:monospace">javac -processor org.checkerframework.checker.nullness.NullnessChecker ...</span>.
You can use shorthand for built-in checkers, such as <span style="font-family:monospace">javac -processor
nullness ...</span> (see Section ‍<a href="#shorthand-for-checkers">2.2.4</a>), or you can use
auto-discovery to eliminate the need for the <span style="font-family:monospace">-processor</span> command-line
option (see Section ‍<a href="#checker-auto-discovery">2.2.3</a>).
</p>
<!--TOC subsection id="faq-pre-conditions" Method pre-condition contracts, including formal parameter annotations, make no sense for public methods-->
<h3 id="faq-pre-conditions" class="subsection">38.3.5 Method pre-condition contracts, including formal parameter annotations, make no sense for public methods <a href="#faq-pre-conditions"><img src="chainlink.svg" width="10" height="10"></a></h3><!--SEC END --><p>Some people go further and say that pre-condition contracts make no sense
for any method. This objection is sometimes stated as, "A method parameter
should never be annotated as <span style="font-family:monospace">@NonNull</span>. A client could pass any value at
all, so the method implementation cannot depend on the value being
non-null. Furthermore, if a client passes an illegal value, it is the
method’s responsibility to immediately tell the client about the illegal
value."</p><p>Here is an example that invalidates this general argument. Consider a
binary search routine. Its specification requires that clients pass in a
sorted array.</p><pre class="verbatim">  /** Return index of the search key, if it is contained it the sorted array a; otherwise ... */
  int binarySearch(Object @Sorted [] a, Object key)
</pre><p>The <span style="font-family:monospace">binarySearch</span> routine is fast — it runs in O(log n) time where n is
the length of the array. If the routine had to validate that its input
array is sorted, then it would run in O(n) time, negating all benefit of
binary search. In other words, <span style="font-family:monospace">binarySearch</span> should <em>not</em> validate
its input!</p><p>The nature of a contract is that if the <em>caller</em> violates its
responsibilities by passing bad values, then the <em>callee</em> is absolved
of its responsibilities. It is polite for the callee to try to provide a
useful diagnostic to the misbehaving caller (for example, by raising a
particular exception quickly), but it is <em>not</em> required. In such a
situation, the callee has the flexibility to do anything that is
convenient.</p><p>In some cases a routine has a <em>complete</em> specification: the contract
permits the caller to pass any value, and the callee is required to throw
particular exceptions for particular inputs. This approach is common for
public methods, but it is not required and is not always the right thing.
As explained in section ‍<a href="#annotate-normal-behavior">2.4.3</a>, even when a method
has a complete specification, the annotations should indicate normal
behavior: behavior that will avoid exceptions.</p>
<!--TOC section id="faq-warnings-section" How to handle warnings and errors-->
<h2 id="faq-warnings-section" class="section">38.4 How to handle warnings and errors <a href="#faq-warnings-section"><img src="chainlink.svg" width="10" height="10"></a></h2><!--SEC END -->
<!--TOC subsection id="faq-handling-warnings" What should I do if a checker issues a warning about my code?-->
<h3 id="faq-handling-warnings" class="subsection">38.4.1 What should I do if a checker issues a warning about my code? <a href="#faq-handling-warnings"><img src="chainlink.svg" width="10" height="10"></a></h3><!--SEC END --><p>For a discussion of this issue, see Section ‍<a href="#handling-warnings">2.4.5</a>.</p>
<!--TOC subsection id="faq-warning-after-check" Why does a checker issue a warning even though the code checks a property?-->
<h3 id="faq-warning-after-check" class="subsection">38.4.2 Why does a checker issue a warning even though the code checks a property? <a href="#faq-warning-after-check"><img src="chainlink.svg" width="10" height="10"></a></h3><!--SEC END --><p>Suppose a checker issues a warning about a line of code. One way to
eliminate a warning is to perform a run-time test
(Section ‍<a href="#type-refinement-runtime-tests">31.7.4</a>), such as adding <span style="font-family:monospace">if (x !=
null)</span> before a dereference of <span style="font-family:monospace">x</span> to avoid a warning about a potential
null pointer dereference. However, sometimes the checker issues a warning
even though the code contains a run-time test. Two common reasons are
non-determinism in the expression being tested and or side effects to the
expression after the run-time test. For details and examples, see
Section ‍<a href="#type-refinement-side-effects">31.7.5</a>.</p>
<!--TOC subsection id="faq-interpreting-warnings" What does a certain Checker Framework warning message mean?-->
<h3 id="faq-interpreting-warnings" class="subsection">38.4.3 What does a certain Checker Framework warning message mean? <a href="#faq-interpreting-warnings"><img src="chainlink.svg" width="10" height="10"></a></h3><!--SEC END --><p>Read the error message first; sometimes that is enough to clarify it.</p><p>Search through this manual for the text of the warning message or for words
that appear in it.</p><p>If nothing else explains it, then
open an issue (Section ‍<a href="#reporting-bugs">39.2</a>) or ask on the
<a href="https://groups.google.com/forum/#!forum/checker-framework-discuss">mailing
list</a>. Be sure to say what you think it means or what specific part does
not make sense to you, and what you have already done to try to understand it.</p>
<!--TOC subsection id="faq-warnings-square-brackets" What do square brackets mean in a Checker Framework warning message?-->
<h3 id="faq-warnings-square-brackets" class="subsection">38.4.4 What do square brackets mean in a Checker Framework warning message? <a href="#faq-warnings-square-brackets"><img src="chainlink.svg" width="10" height="10"></a></h3><!--SEC END --><p>In a message like this:</p><pre class="verbatim">  found   : ? extends T extends @UnknownKeyFor Object
  required: [extends @UnknownKeyFor Object super @UnknownKeyFor null]
</pre><p>the square brackets enclose the upper and lower bounds that the type parameter needs to be within.</p>
<!--TOC subsection id="faq-no-absolute-guarantee" Can a pluggable type-checker guarantee that my code is correct?-->
<h3 id="faq-no-absolute-guarantee" class="subsection">38.4.5 Can a pluggable type-checker guarantee that my code is correct? <a href="#faq-no-absolute-guarantee"><img src="chainlink.svg" width="10" height="10"></a></h3><!--SEC END --><p>Each checker looks for certain errors. You can use multiple checkers to
detect more errors in your code, but you will never have a guarantee that
your code is completely bug-free.</p><p>If the type-checker issues no warning, then you have a guarantee that your
code is free of some particular error. There are some limitations to the
guarantee.</p><p>Most importantly, if you run a pluggable checker on only part of a program, then
you only get a guarantee that those parts of the program are error-free.
For example, if your code uses a library that has not been type-checked,
then the library might be incorrect, or your code might misuse the library.
As another example, suppose you have type-checked a framework that clients
are intended to extend. You should recommend that clients
run the pluggable checker. There is no way to force users to do so, so you
may want to retain dynamic checks or use other mechanisms to detect errors.</p><p>Section ‍<a href="#checker-guarantees">2.3</a> states other limitations to a checker’s
guarantee, such as regarding concurrency. Java’s type system is also
unsound in certain situations, such as for arrays and casts (however, the
Checker Framework is sound for arrays and casts). Java uses dynamic checks
is some places it is unsound, so that errors are thrown at run time. The
pluggable type-checkers do not currently have built-in dynamic checkers to
check for the places they are unsound.
Writing dynamic checkers would be an interesting and valuable project.</p><p>Other types of dynamism in a Java application do not jeopardize the
guarantee, because the type-checker is conservative. For example, at a
method call, dynamic dispatch chooses some implementation of the method,
but it is impossible to know at compile time which one it will be. The
type-checker gives a guarantee no matter what implementation of the method
is invoked.</p><p>Even if a pluggable checker cannot give an ironclad
guarantee of correctness, it is still useful. It can find errors,
exclude certain types of possible problems (e.g., restricting the
possible class of problems), improve documentation, and increase confidence
in your software.</p>
<!--TOC subsection id="faq-concurrency" What guarantee does the Checker Framework give for concurrent code?-->
<h3 id="faq-concurrency" class="subsection">38.4.6 What guarantee does the Checker Framework give for concurrent code? <a href="#faq-concurrency"><img src="chainlink.svg" width="10" height="10"></a></h3><!--SEC END --><p>The Lock Checker (see Chapter ‍<a href="#lock-checker">11</a>) offers a way to detect
and prevent certain concurrency errors.</p><p>By default, the Checker Framework assumes that the code that it is checking
is sequential: that is, there are no concurrent accesses from another
thread. This means that the Checker Framework is unsound for concurrent
code, in the sense that it may fail to issue a warning about errors that
occur only when the code is running in a concurrent setting.
For example, the Nullness Checker issues no warning for this
code:</p><pre class="verbatim">  if (myobject.myfield != null) {
    myobject.myfield.toString();
  }
</pre><p>This code is safe when run on its own.
However, in the presence of multithreading, the call to <span style="font-family:monospace">toString</span> may
fail because another thread may set <span style="font-family:monospace">myobject.myfield</span> to <span style="font-family:monospace">null</span> after
the nullness check in the <span style="font-family:monospace">if</span> condition, but before the <span style="font-family:monospace">if</span> body is
executed.</p><p>If you supply the <span style="font-family:monospace">-AconcurrentSemantics</span> command-line option, then the
Checker Framework assumes that any field can be changed at any time. This
limits the amount of type refinement
(Section ‍<a href="#type-refinement">31.7</a>) that the Checker Framework can do.</p>
<!--TOC subsection id="faq-awarns" How do I make compilation succeed even if a checker issues errors?-->
<h3 id="faq-awarns" class="subsection">38.4.7 How do I make compilation succeed even if a checker issues errors? <a href="#faq-awarns"><img src="chainlink.svg" width="10" height="10"></a></h3><!--SEC END --><p>Section ‍<a href="#running">2.2</a> describes the <span style="font-family:monospace">-Awarns</span> command-line
option that turns checker errors into warnings, so type-checking errors
will not cause <span style="font-family:monospace">javac</span> to exit with a failure status.</p>
<!--TOC subsection id="faq-100-warnings" Why does the checker always say there are 100 errors or warnings?-->
<h3 id="faq-100-warnings" class="subsection">38.4.8 Why does the checker always say there are 100 errors or warnings? <a href="#faq-100-warnings"><img src="chainlink.svg" width="10" height="10"></a></h3><!--SEC END --><p>By default, javac only reports the first 100 errors or warnings.
Furthermore, once javac encounters an error, it doesn’t try compiling any
more files (but does complete compilation of all the ones that it has
started so far).</p><p>To see more than 100 errors or warnings, use the javac options <span style="font-family:monospace">-Xmaxerrs</span>
and <span style="font-family:monospace">-Xmaxwarns</span>. To convert Checker Framework errors into warnings so
that javac will process all your source files, use the option <span style="font-family:monospace">-Awarns</span>.
See Section ‍<a href="#running">2.2</a> for more details.</p>
<!--TOC subsection id="faq-type-i-did-not-write" Why does the Checker Framework report an error regarding a type I have not written in my program?-->
<h3 id="faq-type-i-did-not-write" class="subsection">38.4.9 Why does the Checker Framework report an error regarding a type I have not written in my program? <a href="#faq-type-i-did-not-write"><img src="chainlink.svg" width="10" height="10"></a></h3><!--SEC END --><p>Sometimes, a Checker Framework warning message will mention a type you have
not written in your program. This is typically because a default has been
applied where you did not write a type; see Section ‍<a href="#defaults">31.5</a>. In
other cases, this is because type refinement has given an
expression a more specific type than you wrote or than was defaulted; see
Section ‍<a href="#type-refinement">31.7</a>.
Note that an invocation of an impure method may cause the loss of all
information that was determined via type refinement; see
Section ‍<a href="#type-refinement-purity">31.7.5</a>.</p>
<!--TOC subsection id="faq-same-code-different-behavior" Why does the Checker Framework accept code on one line but reject it on the next?-->
<h3 id="faq-same-code-different-behavior" class="subsection">38.4.10 Why does the Checker Framework accept code on one line but reject it on the next? <a href="#faq-same-code-different-behavior"><img src="chainlink.svg" width="10" height="10"></a></h3><!--SEC END --><p>Sometimes, the Checker Framework permits code on one line, but rejects the
same code a few lines later:</p><pre class="verbatim">  if (myField != null) {
    myField.hashCode();   // no warning
    someMethod();
    myField.hashCode();   // warning about potential NullPointerException
  }
</pre><p>The reason is explained in the section on type refinement
(Section ‍<a href="#type-refinement">31.7</a>), which also tells how to specify the side
effects of <span style="font-family:monospace">someMethod</span> (Section ‍<a href="#type-refinement-purity">31.7.5</a>).</p>
<!--TOC subsection id="faq-run-time-checking" How can I do run-time monitoring of properties that were not statically checked?-->
<h3 id="faq-run-time-checking" class="subsection">38.4.11 How can I do run-time monitoring of properties that were not statically checked? <a href="#faq-run-time-checking"><img src="chainlink.svg" width="10" height="10"></a></h3><!--SEC END --><p>Some properties are not checked statically (see
Chapter ‍<a href="#suppressing-warnings">32</a> for reasons that code might not be
statically checked). In such cases, it would be desirable to check the
property dynamically, at run time.
Currently, the Checker Framework has no support for adding code to perform
run-time checking.</p><p>Adding such support would be an interesting and valuable project.
An example would be an option that causes the Checker Framework to
automatically insert a run-time check anywhere that static checking is
suppressed.
If you
are able to add run-time verification functionality, we would gladly
welcome it as a contribution to the Checker Framework.</p><p>Some checkers have library methods that you can explicitly insert in your
source code.
Examples include the Nullness Checker’s
<a href="../api/org/checkerframework/checker/nullness/util/NullnessUtil.html#castNonNull(T)"><span style="font-family:monospace">NullnessUtil.castNonNull</span></a> method (see
Section ‍<a href="#suppressing-warnings-with-assertions">3.4.1</a>) and the Regex Checker’s
<span style="font-family:monospace">RegexUtil</span> class (see Section ‍<a href="#regexutil-methods">13.2.4</a>).
But, it would be better to have more general support that does not require
the user to explicitly insert method calls.</p>
<!--TOC section id="faq-false-positives-section" False positive warnings-->
<h2 id="faq-false-positives-section" class="section">38.5 False positive warnings <a href="#faq-false-positives-section"><img src="chainlink.svg" width="10" height="10"></a></h2><!--SEC END -->
<!--TOC subsection id="faq-false-positive" What is a “false positive” warning?-->
<h3 id="faq-false-positive" class="subsection">38.5.1 What is a “false positive” warning? <a href="#faq-false-positive"><img src="chainlink.svg" width="10" height="10"></a></h3><!--SEC END --><p>A “false positive” is when the tool reports a potential problem, but the
code is actually correct and will never violate the given property at run
time.</p><p>The Checker Framework aims to be sound; that is, if the Checker Framework
does not report any possible errors, then your code is correct.</p><p>Every sound tool suffers false positive errors.
Wherever the Checker Framework issues an error, you can think of it as
saying, “I can’t prove this code is safe,” but the code might be safe for
some complex, tricky reason that is beyond the capabilities of its
analysis.</p><p>If you are sure that the warning is a false positive, you have several
options.
Perhaps you just need to write annotations, especially on method signatures
but perhaps within method bodies as well.
Sometimes you can rewrite the code in a clearer way that the Checker
Framework can verify, and that might be easier for people to understand, too.
If these don’t work, then you can suppress the warning
(Section ‍<a href="#handling-warnings">2.4.5</a>).
You also might want to report
the false positive in the Checker Framework issue tracker
(Section ‍<a href="#reporting-bugs">39.2</a>), if it appears in real-world, well-written code.
Finally, you could improve the Checker Framework to make it more
precise, so that it does not suffer that false positive (see
Section ‍<a href="#faq-false-positive-extend-checker-framework">38.5.2</a>).</p>
<!--TOC subsection id="faq-false-positive-extend-checker-framework" How can I improve the Checker Framework to eliminate a false positive warning?-->
<h3 id="faq-false-positive-extend-checker-framework" class="subsection">38.5.2 How can I improve the Checker Framework to eliminate a false positive warning? <a href="#faq-false-positive-extend-checker-framework"><img src="chainlink.svg" width="10" height="10"></a></h3><!--SEC END --><p>As noted in Section ‍<a href="#faq-false-positive">38.5.1</a>, <em>every</em> sound analysis
tool suffers false positives.</p><p>For any given false positive warning, it is theoretically possible to
improve the Checker Framework to eliminate it. (But, it’s theoretically
impossible to eliminate all false positives. That is, there
will always exist some programs that don’t go wrong at run time but for
which the Checker Framework issues a warning.)</p><p>Some improvements affect the implementation of the type system; they do not
add any new types. Such an improvement is invisible to users, except that
the users suffer fewer false positive warnings. This type of improvement
to the type checker’s implementation is often worthwhile.</p><p>Other improvements change the type system or add a new type system.
Defining new types is a powerful way to improve precision, but it is costly
too. A simpler type system is easier for users to understand, less likely
to contain bugs, and more efficient.</p><p>By design, each type system in the Checker Framework has limited
expressiveness. Our goal is to implement enough functionality to handle
common, well-written real-world code, not to cover every possible
situation.</p><p>When reporting bugs, please focus on realistic scenarios. We are sure that
you can make up artificial code that stymies the type-checker! Those bugs
aren’t a good use of your time to report nor the maintainers’ time to
evaluate and fix. When reporting a bug, it’s very helpful to minimize it
to give a tiny example that is easy to evaluate and fix, but please also
indicate how it arises in real-world, well-written code.</p>
<!--TOC subsection id="faq-infer-fields" Why doesn’t the Checker Framework infer types for fields and method return types?-->
<h3 id="faq-infer-fields" class="subsection">38.5.3 Why doesn’t the Checker Framework infer types for fields and method return types? <a href="#faq-infer-fields"><img src="chainlink.svg" width="10" height="10"></a></h3><!--SEC END --><p>Consider the following code. A programmer can tell that all three
invocations of <span style="font-family:monospace">format</span> are safe — they never suffer an
<span style="font-family:monospace">IllegalFormatException</span> exception at run time:</p><pre class="verbatim">class MyClass {

  final String field = "%d";

  String method() {
    return "%d";
  }

  void method m() {
    String local = "%d";
    String.format(local, 5);    // Format String Checker verifies the call is safe
    String.format(field, 5);    // Format String Checker warns the call might not be safe
    String.format(method(), 5); // Format String Checker warns the call might not be safe
  }
}
</pre><p>However, the Format String Checker can only verify the first call. It issues a
false positive warning about the second and third calls.</p><p>The Checker Framework can verify all three calls, with no false positive
warnings, if you annotate the type of <span style="font-family:monospace">field</span> and the return type of
<span style="font-family:monospace">method</span> as <span style="font-family:monospace">@Format(INT)</span>.</p><p>By default, the Checker Framework infers types for local variables
(Section ‍<a href="#type-refinement">31.7</a>), but not for fields and method return
types. (The Checker Framework includes a whole-program type inference tool
that infers field and method return types; see
Section ‍<a href="#whole-program-inference">33.2</a>.)
There are several reasons for this design choice.</p><dl class="description"><dt class="dt-description">
<span style="font-weight:bold">Separation of specification from implementation</span></dt><dd class="dd-description">
The designer of an API makes certain promises to clients; these are
codified in the API’s specification or contract. The implementation
might return a more specific type today, but the designer does not want
clients to depend on that. For example, a string might happen to be a
regular expression because it contains no characters with special meaning
in regexes, but that is not guaranteed to always be true. It’s better
for the programmer to explicitly write the intended specification.</dd><dt class="dt-description"><span style="font-weight:bold">Separate compilation</span></dt><dd class="dd-description">
To infer types for a non-final method, it is necessary to examine every
overriding implementation, so that the method’s return type annotation is
compatible with all values that are returned by any overriding
implementation. In general, examining all implementations is impossible,
because clients may override the method. When possible, it is
inconvenient to provide all that source code, and it would slow down the
type-checker.<p>A related issue is that determining which values can be returned by a
method <span style="font-style:italic">m</span> requires analyzing <span style="font-style:italic">m</span>’s body, which requires analyzing
all the methods called by <span style="font-style:italic">m</span>, and so forth. This quickly devolves to
analyzing the whole program.
Determining all possible values assigned to a field is equally hard.</p><p>Type-checking is modular — it works on one procedure at a time,
examining that procedure and the specifications (not implementations) of
methods that it calls. Therefore, type-checking is fast and can work on
partial programs. The Checker Framework performs modular type-checking,
not a whole-program analysis.</p></dd><dt class="dt-description"><span style="font-weight:bold">Order of compilation</span></dt><dd class="dd-description">
When the compiler is called on class <span style="font-family:monospace">Client</span> and class <span style="font-family:monospace">Library</span>, the
programmer has no control over which class is analyzed first. When the
first class is compiled, it has access only to the signature of the other
class. Therefore, a programmer would see inconsistent results depending
on whether <span style="font-family:monospace">Client</span> was compiled first and had access only to the
declared types of <span style="font-family:monospace">Library</span>, or the <span style="font-family:monospace">Library</span> was compiled first and
the compiler refined the types of its methods and fields before <span style="font-family:monospace">Client</span>
looked them up.</dd><dt class="dt-description"><span style="font-weight:bold">Consistent behavior with or without pluggable type-checking</span></dt><dd class="dd-description">
The <span style="font-family:monospace">.class</span> files produced with or without pluggable type-checking
should specify the same types for all public fields and methods. If
pluggable type-checking changed the those types, then users would be
confused. Depending on how a library was compiled, pluggable
type-checking of a client program would give different results.</dd></dl>
<!--TOC subsection id="faq-relationships-between-variables" Why doesn’t the Checker Framework track relationships between variables?-->
<h3 id="faq-relationships-between-variables" class="subsection">38.5.4 Why doesn’t the Checker Framework track relationships between variables? <a href="#faq-relationships-between-variables"><img src="chainlink.svg" width="10" height="10"></a></h3><!--SEC END --><p>The Checker Framework estimates the possible run-time value of each
variable, as expressed in a type system. In general, the Checker Framework
does estimate relationships between two variables, except for specific
relationships listed in Section ‍<a href="#java-expressions-as-arguments">31.8</a>.</p><p>For example, the Checker Framework does not track which variables are equal
to one another. The Nullness Checker issues a warning, “dereference of
possibly-null reference y”, for expression <span style="font-family:monospace">y.toString()</span>:</p><pre class="verbatim">void nullnessExample1(@Nullable Object x) {
    Object y = x;
    if (x != null) {
      System.out.println(y.toString());
    }
  }
</pre><p>Code that checks one variable and then uses a different variable is
confusing and is often considered poor style.</p><p>The Nullness Checker is able to verify the correctness of a small variant
of the program, thanks to type refinement
(Section ‍<a href="#type-refinement">31.7</a>):</p><pre class="verbatim">  void nullnessExample12(@Nullable Object x) {
    if (x != null) {
      Object y = x;
      System.out.println(y.toString());
    }
  }
</pre><p>The difference is that in the first example, nothing was known about <span style="font-family:monospace">x</span> at
the time <span style="font-family:monospace">y</span> was set to it, and so the Nullness Checker recorded no facts
about <span style="font-family:monospace">y</span>. In the second example, the Nullness Checker knew that <span style="font-family:monospace">x</span>
was non-null when <span style="font-family:monospace">y</span> was assigned to it.</p><p>In the future, the Checker Framework could be enriched by tracking which
variables are equal to one another, a technique called “copy
propagation”.</p><p>This would handle the above examples, but wouldn’t handle other examples.
For example, the following code is safe:</p><pre class="verbatim">  void requiresPositive(@Positive int arg) {}

  void intExample1(int x) {
    int y = x*x;
    if (x &gt; 0) {
      requiresPositive(y);
    }
  }

  void intExample2(int x) {
    int y = x*x;
    if (y &gt; 0) {
      requiresPositive(x);
    }
  }
</pre><p>However, the Index Checker (Chapter ‍<a href="#index-checker">12</a>), which defines the
<a href="../api/org/checkerframework/checker/index/qual/Positive.html"><span style="font-family:monospace">@Positive</span></a> type qualifier, issues warnings
saying that it cannot prove that the arguments are <span style="font-family:monospace">@Positive</span>.</p><p>A slight variant of <span style="font-family:monospace">intExample1</span> can be verified:</p><pre class="verbatim">  void intExample1a(int x) {
    if (x &gt; 0) {
      int y = x*x;
      requiresPositive(y);
    }
  }
</pre><p>No variant of <span style="font-family:monospace">intExample2</span> can be verified. It is not worthwhile to make
the Checker Framework more complex and slow by tracking rich properties
such as arbitrary arithmetic.</p><p>As another example of a false positive warning due to arbitrary arithmetic
properties, consider the following code:</p><pre class="verbatim">  void falsePositive2(int arg) {
    Object o;
    if (arg * arg &gt;= arg) { // always true!
      o = new Object();
    }
    o.toString();  // Nullness Checker issues a false positive warning
  }
</pre>
<!--TOC subsection id="faq-path-sensitive" Why isn’t the Checker Framework path-sensitive?-->
<h3 id="faq-path-sensitive" class="subsection">38.5.5 Why isn’t the Checker Framework path-sensitive? <a href="#faq-path-sensitive"><img src="chainlink.svg" width="10" height="10"></a></h3><!--SEC END --><p>The Checker Framework is not path-sensitive. That is, it maintains one
estimate for each variable, and it assumes at every branch (such as <span style="font-family:monospace">if</span>
statement) that every choice could be taken.</p><p>In the following code, there are two <span style="font-family:monospace">if</span> statements.</p><pre class="verbatim">  void falsePositive1(boolean b) {
    Object o;
    if (b) {
      o = new Object();
    }
    if (b) {
      o.toString();  // Nullness Checker issues a false positive warning
    }
  }
</pre><p>In general, if code has two <span style="font-family:monospace">if</span> statements in succession, then there are
4 possible paths through the code: [true, true], [true, false], [false,
true], and [false, false]. However, for this code only two of those
paths are feasible: namely, [true, true] and [false, false].</p><p>The Checker Framework is not path-sensitive, so it issues a warning.</p><p>The lack of path-sensitivity can be viewed as special case of the fact that
the Checker Framework maintains a single estimate for each variable value,
rather than tracking relationships between multiple variables
(Section ‍<a href="#faq-relationships-between-variables">38.5.4</a>).</p><p>Making the Checker Framework path-sensitive would make it more powerful,
but also much more complex and much slower. We have not yet found this
necessary.</p>
<!--TOC section id="faq-syntax-section" Syntax of type annotations-->
<h2 id="faq-syntax-section" class="section">38.6 Syntax of type annotations <a href="#faq-syntax-section"><img src="chainlink.svg" width="10" height="10"></a></h2><!--SEC END --><p>There is also a separate FAQ for the type annotations syntax
(<a href="https://checkerframework.org/jsr308/jsr308-faq.html"><span style="font-family:monospace">https://checkerframework.org/jsr308/jsr308-faq.html</span></a>).</p>
<!--TOC subsection id="faq-receiver" What is a “receiver”?-->
<h3 id="faq-receiver" class="subsection">38.6.1 What is a “receiver”? <a href="#faq-receiver"><img src="chainlink.svg" width="10" height="10"></a></h3><!--SEC END --><p>The <em>receiver</em> of a method is the <span style="font-family:monospace">this</span> formal parameter, sometimes
also called the “current object”. Within the method declaration, <span style="font-family:monospace">this</span>
is used to refer to the receiver formal parameter. At a method call, the
receiver actual argument is written before a period and the method name.</p><p>The method <span style="font-family:monospace">compareTo</span> takes <em>two</em> formal parameters. At a call site
like <span style="font-family:monospace">x.compareTo(y)</span>, the two arguments are <span style="font-family:monospace">x</span> and <span style="font-family:monospace">y</span>. It is
desirable to be able to annotate the types of both of the formal
parameters, and doing so is supported by both Java’s type annotations
syntax and by the Checker Framework.</p><p>A type annotation on the receiver is treated exactly like a type annotation
on any other formal parameter. At each call site, the type of the argument
must be a consistent with (a subtype of or equal to) the declaration of the
corresponding formal parameter. If not, the type-checker issues a warning.</p><p>Here is an example. Suppose that <span style="font-family:monospace">@A Object</span> is a supertype of <span style="font-family:monospace">@B
Object</span> in the following declaration:</p><pre class="verbatim">  class MyClass {
    void requiresA(@A MyClass this) { ... }
    void requiresB(@B MyClass this) { ... }
  }
</pre><p>Then the behavior of four different invocations is as follows:</p><pre class="verbatim">  @A MyClass myA = ...;
  @B MyClass myB = ...;

  myA.requiresA()    // OK
  myA.requiresB()    // compile-time error
  myB.requiresA()    // OK
  myB.requiresB()    // OK
</pre><p>The invocation <span style="font-family:monospace">myA.requiresB()</span> does not type-check because the actual
argument’s type is not a subtype of the formal parameter’s type.</p><p>A top-level constructor does not have a receiver. An inner class
constructor does have a receiver, whose type is the same as the containing
outer class. The receiver is distinct from the object being constructed.
In a method of a top-level class, the receiver is named <span style="font-family:monospace">this</span>. In a
constructor of an inner class, the receiver is named <span style="font-family:monospace">Outer.this</span> and the
result is named <span style="font-family:monospace">this</span>.</p><p>A method in an anonymous class has a receiver, but it is not possible to
write the receiver in the formal parameter list because there is no name
for the type of <span style="font-family:monospace">this</span>.</p>
<!--TOC subsection id="faq-annotation-after-type" What is the meaning of an annotation after a type, such as <span style="font-family:monospace">@NonNull Object @Nullable</span>?-->
<h3 id="faq-annotation-after-type" class="subsection">38.6.2 What is the meaning of an annotation after a type, such as <span style="font-family:monospace">@NonNull Object @Nullable</span>? <a href="#faq-annotation-after-type"><img src="chainlink.svg" width="10" height="10"></a></h3><!--SEC END --><p>In a type such as <span style="font-family:monospace">@NonNull Object @Nullable []</span>, it may appear that the
<span style="font-family:monospace">@Nullable</span> annotation is written <em>after</em> the type <span style="font-family:monospace">Object</span>. In
fact, <span style="font-family:monospace">@Nullable</span> modifies <span style="font-family:monospace">[]</span>. See the next FAQ, about array
annotations (Section ‍<a href="#faq-array-syntax-meaning">38.6.3</a>).</p>
<!--TOC subsection id="faq-array-syntax-meaning" What is the meaning of array annotations such as <span style="font-family:monospace">@NonNull Object @Nullable []</span>?-->
<h3 id="faq-array-syntax-meaning" class="subsection">38.6.3 What is the meaning of array annotations such as <span style="font-family:monospace">@NonNull Object @Nullable []</span>? <a href="#faq-array-syntax-meaning"><img src="chainlink.svg" width="10" height="10"></a></h3><!--SEC END --><p>You should parse this as:
(<span style="font-weight:bold"><span style="font-family:monospace">@NonNull Object</span></span>) (<span style="font-weight:bold"><span style="font-family:monospace">@Nullable []</span></span>).
Each annotation precedes the component of the type that it qualifies.</p><p>Thus,
<span style="font-family:monospace">@NonNull Object @Nullable []</span> is a possibly-null array of non-null
objects. Note that the first token in the type,
“<span style="font-family:monospace">@NonNull</span>”, applies to the element
type <span style="font-family:monospace">Object</span>, not to the array type as a whole. The annotation <span style="font-family:monospace">@Nullable</span> applies to the
array (<span style="font-family:monospace">[]</span>).</p><p>Similarly,
<span style="font-family:monospace">@Nullable Object @NonNull []</span> is a non-null array of possibly-null
objects.</p><p>Some older tools have inconsistent semantics for annotations on array and
varargs elements. Their semantics is unfortunate and confusing; developers
should convert their code to use type annotations instead.
Section ‍<a href="#declaration-annotations-moved">38.6.8</a> explains how the Checker
Framework handles declaration annotations in the meanwhile.</p>
<!--TOC subsection id="faq-varargs-syntax-meaning" What is the meaning of varargs annotations such as <span style="font-family:monospace">@English String @NonEmpty ‍...</span>?-->
<h3 id="faq-varargs-syntax-meaning" class="subsection">38.6.4 What is the meaning of varargs annotations such as <span style="font-family:monospace">@English String @NonEmpty ‍...</span>? <a href="#faq-varargs-syntax-meaning"><img src="chainlink.svg" width="10" height="10"></a></h3><!--SEC END --><p>Varargs annotations are treated similarly to array annotations.
(A way to remember this is that
when you write a varargs formal parameter such as
<span style="font-family:monospace">void method(String... x) </span><span style="font-family:monospace">{</span><span style="font-family:monospace">}</span>, the Java compiler generates a
method that takes an array of strings; whenever your source code calls the
method with multiple arguments, the Java compiler packages them up into an
array before calling the method.)</p><p>Either of these annotations</p><pre class="verbatim">  void method(String @NonEmpty [] x) {}
  void method(String @NonEmpty ... x) {}
</pre><p>applies to the array: the method takes a non-empty array of strings, or
the varargs list must not be empty.</p><p>Either of these annotations</p><pre class="verbatim">  void method(@English String [] x) {}
  void method(@English String ... x) {}
</pre><p>.
applies to the element type. The annotation documents that the method takes an array of English strings.</p>
<!--TOC subsection id="faq-type-qualifier-on-class-declaration" What is the meaning of a type qualifier at a class declaration?-->
<h3 id="faq-type-qualifier-on-class-declaration" class="subsection">38.6.5 What is the meaning of a type qualifier at a class declaration? <a href="#faq-type-qualifier-on-class-declaration"><img src="chainlink.svg" width="10" height="10"></a></h3><!--SEC END --><p>See Section ‍<a href="#upper-bound-for-use">31.3</a>.</p>
<!--TOC subsection id="faq-type-qualifier-on-bounds" How are type qualifiers written on upper and lower bounds?-->
<h3 id="faq-type-qualifier-on-bounds" class="subsection">38.6.6 How are type qualifiers written on upper and lower bounds? <a href="#faq-type-qualifier-on-bounds"><img src="chainlink.svg" width="10" height="10"></a></h3><!--SEC END --><p>See Section ‍<a href="#generics-instantiation">30.1.2</a>.</p>
<!--TOC subsection id="faq-no-annotation-on-types-and-declarations" Why shouldn’t a qualifier apply to both types and declarations?-->
<h3 id="faq-no-annotation-on-types-and-declarations" class="subsection">38.6.7 Why shouldn’t a qualifier apply to both types and declarations? <a href="#faq-no-annotation-on-types-and-declarations"><img src="chainlink.svg" width="10" height="10"></a></h3><!--SEC END --><p>It is bad style for an annotation to apply to both types and declarations.
In other words, every annotation should have a <span style="font-family:monospace">@Target</span> meta-annotation,
and the <span style="font-family:monospace">@Target</span> meta-annotation should list either only declaration
locations or only type annotations. (It’s OK for an annotation to target
both <span style="font-family:monospace">ElementType.TYPE_PARAMETER</span> and <span style="font-family:monospace">ElementType.TYPE_USE</span>, but no
other declaration location along with <span style="font-family:monospace">ElementType.TYPE_USE</span>.)</p><p>Sometimes, it may seem tempting for an annotation to apply to both type
uses and (say) method declarations. Here is a hypothetical example:</p><blockquote class="quote">
“Each <span style="font-family:monospace">Widget</span> type may have a <span style="font-family:monospace">@Version</span> annotation.
I wish to prove that versions of widgets don’t get assigned to
incompatible variables, and that older code does not call newer code (to
avoid problems when backporting).<p>A <span style="font-family:monospace">@Version</span> annotation could be written like so:</p><pre class="verbatim">  @Version("2.0") Widget createWidget(String value) { ... }
</pre><p><span style="font-family:monospace">@Version("2.0")</span> on the method could mean that the <span style="font-family:monospace">createWidget</span> method
only appears in the 2.0 version. <span style="font-family:monospace">@Version("2.0")</span> on the return type
could mean that the returned <span style="font-family:monospace">Widget</span> should only be used by code that
uses the 2.0 API of <span style="font-family:monospace">Widget</span>. It should be possible to specify these
independently, such as a 2.0 method that returns a value that allows the
1.0 API method invocations.”
</p></blockquote><p>Both of these are type properties and should be specified with type
annotations. No method annotation is necessary or desirable. The best way
to require that the receiver has a certain property is to use a type
annotation on the receiver of the method. (Slightly more formally, the
property being checked is compatibility between the annotation on the type
of the formal parameter receiver and the annotation on the type of the
actual receiver.) If you do not know what “receiver” means, see
Section ‍<a href="#faq-receiver">38.6.1</a>.</p><p>Another example of a type-and-declaration annotation that represents poor
design is JCIP’s <span style="font-family:monospace">@GuardedBy</span> annotation ‍[<a href="#Goetz2006">GPB+06</a>]. As discussed
in Section ‍<a href="#lock-jcip-annotations">11.6.1</a>, it means two different things when
applied to a field or a method. To reduce confusion and increase
expressiveness, the Lock Checker (see Chapter ‍<a href="#lock-checker">11</a>) uses the
<span style="font-family:monospace">@Holding</span> annotation for one of these meanings, rather than overloading
<span style="font-family:monospace">@GuardedBy</span> with two distinct meanings.</p><p>A final example of a type-and-declaration annotation is some <span style="font-family:monospace">@Nullable</span>
or <span style="font-family:monospace">@NonNull</span> annotations that are intended to work both with modern tools
that process type annotations and with old tools that were written before
Java had type annotations. Such type-and-declaration annotations were a
temporary measure, intended to be used until the tool supported Java 8
(which was released in March 2014), and
should not be necessary any longer.</p>
<!--TOC subsection id="faq-annotate-fully-qualified-name" How do I annotate a fully-qualified type name?-->
<h3 id="faq-annotate-fully-qualified-name" class="subsection">38.6.8 How do I annotate a fully-qualified type name? <a href="#faq-annotate-fully-qualified-name"><img src="chainlink.svg" width="10" height="10"></a></h3><!--SEC END --><p>If you write a fully-qualified type name in your program, then the Java
language requires you to write a type annotation on the simple name part,
such as
</p><pre class="verbatim">  entity.hibernate. @Nullable User x;
</pre><p>If you try to write the type annotation before the entire fully-qualified
name, such as
</p><pre class="verbatim">  @Nullable entity.hibernate.User x;  // illegal Java syntax
</pre><p>
then you will get an error like one of the following:
</p><pre class="verbatim">error: scoping construct for static nested type cannot be annotated
error: scoping construct cannot be annotated with type-use annotation
</pre><p><a id="declaration-annotations-moved"></a> </p>
<!--TOC subsection id="faq-declaration-annotations-moved" How does the Checker Framework handle obsolete declaration annotations?-->
<h3 id="faq-declaration-annotations-moved" class="subsection">38.6.9 How does the Checker Framework handle obsolete declaration annotations? <a href="#faq-declaration-annotations-moved"><img src="chainlink.svg" width="10" height="10"></a></h3><!--SEC END --><p>When a declaration annotation is an alias for a type annotation, the
Checker Framework may move the annotation before replacing it by the
canonical version. (If the declaration annotation is in an <span style="font-family:monospace">org.checkerframework</span>
package, it is not moved.)</p><p>For example,</p><pre class="verbatim">  import android.support.annotation.NonNull;
  ...
  @NonNull Object [] returnsArray();
</pre><p>is treated as if the programmer had written</p><pre class="verbatim">  import org.checkerframework.checker.nullness.qual.NonNull;
  ...
  Object @NonNull [] returnsArray();
</pre><p>because Android’s <span style="font-family:monospace">@NonNull</span> annotation is a declaration annotation, which
is understood to apply to the top-level return type of the annotated method.</p><p>When possible, you should use type annotations rather than declaration
annotations.</p><p>Users who are using old Java 5–7 declaration annotations (for instance,
from the FindBugs tool, which has not been maintained since 2015, and from
its successor SpotBugs, which has not yet adopted type annotations, even
though type annotations were added to Java in 2014) can use annotations in
package <span style="font-family:monospace">org.checkerframework.checker.nullness.compatqual</span> to avoid name
conflicts. These are available in package
<a href="https://search.maven.org/search?q=a:checker-compat-qual"><span style="font-family:monospace">checker-compat-qual</span></a>
on Maven Central. Once the users are ready to upgrade to Java 8+ type
annotations, those compatibility annotations are no longer necessary.</p>
<!--TOC subsection id="faq-type-vs-declaration-annotations" What is the difference between type annotations and declaration annotations?-->
<h3 id="faq-type-vs-declaration-annotations" class="subsection">38.6.10 What is the difference between type annotations and declaration annotations? <a href="#faq-type-vs-declaration-annotations"><img src="chainlink.svg" width="10" height="10"></a></h3><!--SEC END --><p>Java has two distinct varieties of annotation: type annotations and
declaration annotations.</p><p>A <span style="font-weight:bold">type annotation</span> can be written on any use of a <span style="font-weight:bold">type</span>.
It conceptually creates a new, more specific type.
That is, it describes what values the type represents.</p><p>As an example, the <span style="font-family:monospace">int</span> type contains these values: ..., -2, -1, 0, 1, 2, ... <br>
The <span style="font-family:monospace">@Positive int</span> type contains these values: 1, 2, ... <br>
Therefore, <span style="font-family:monospace">@Positive int</span> is a subtype of <span style="font-family:monospace">int</span>.</p><p>A <span style="font-weight:bold">declaration annotation</span> can be written on any <span style="font-weight:bold">declaration</span> (a class, method, or variable). It describes the thing being declared, but does not describe run-time values. Here are examples of declaration annotations:</p><pre class="verbatim">    @Deprecated    // programmers should not use this class
    class MyClass { ... }

    @Override      // this method overrides a method in a supertype
    void myMethod() { ... }

    @SuppressWarnings(...) // compiler should not warn about the initialization expr
    int myField = INITIALIZATION-EXPRESSION;
</pre><p>Here are examples that use both a declaration annotation and a type annotation:</p><pre class="verbatim">    @Override
    @Regex String getPattern() { ... }

    @GuardedBy("myLock")
    @NonNull String myField;
</pre><p>Note that the type annotation describes the value, and the declaration annotation says something about the method or use of the field.</p><p>As a matter of style, declaration annotations are written on their own line, and type annotations are written directly before the type, on the same line.</p>
<!--TOC subsection id="faq-type-annotation-formatting" How should type annotations be formatted in source code? Where should I write type annotations?-->
<h3 id="faq-type-annotation-formatting" class="subsection">38.6.11 How should type annotations be formatted in source code? Where should I write type annotations? <a href="#faq-type-annotation-formatting"><img src="chainlink.svg" width="10" height="10"></a></h3><!--SEC END --><p>The
<a href="https://docs.oracle.com/javase/specs/jls/se8/html/jls-9.html#jls-9.7.4">Java
Language Specification, section 9.7.4</a> says: “It is customary, though
not required, to write declaration annotations before all other modifiers,
and type annotations immediately before the type to which they apply.”</p><p>A type annotation should be written immediately before the type it
qualifies, on the same line. There should not be any modifiers (such as
<span style="font-family:monospace">public</span>) between them. This emphasizes that the type qualifier plus the
Java basetype is a logical unit, which aids people reading the code.</p><pre class="verbatim">  // Wrong formatting
  @Positive
  public int numItems;

  // Right
  public @Positive int numItems;

  // Wrong formatting
  @Nullable
  public Object getThing() {
    ...
  }

  // Right
  public @Nullable Object getThing() {
    ...
  }
</pre><p>By contrast, declaration annotations are conventionally written on their own line.</p><pre class="verbatim">  // Wrong formatting
  @Deprecated URL toURL() {
    ...
  }

  // Right
  @Deprecated
  URL toURL() {
    ...
  }
</pre><p>The preferred order of modifiers is
</p><ol class="enumerate" type=1><li class="li-enumerate">
declaration annotations
</li><li class="li-enumerate">keyword modifiers such as <span style="font-family:monospace">public</span> and <span style="font-family:monospace">strictfp</span>
</li><li class="li-enumerate">type annotations
</li><li class="li-enumerate">type
</li></ol><p>Here is an example of a declaration annotation and a type annotation on a class declaration:</p><pre class="verbatim">  @Deprecated
  public @Interned class Level {
    ...
  }
</pre><p>The popular
<a href="https://github.com/google/google-java-format">google-java-format</a>
tool formats type annotations incorrectly, with type annotations on their
own line instead of on the same line with the type they modify. (Actually,
you can see from method <a href="https://github.com/google/google-java-format/blob/master/core/src/main/java/com/google/googlejavaformat/java/JavaInputAstVisitor.java"><span style="font-family:monospace">JavaInputAstVisitor</span></a><span style="font-family:monospace">.typeAnnotations()</span> that
it handles two <span style="font-family:monospace">@Nullable</span> annotations correctly, but all other type
annotations incorrectly! This would be fixed by merging
<a href="https://github.com/google/google-java-format/pull/802">pull request
#802</a>.)
Until this bug in google-java-format is fixed, you have these options:
</p><ul class="itemize"><li class="li-itemize">
Run google-java-format via
<a href="https://github.com/diffplug/spotless">Spotless</a> and use the
<a href="https://github.com/diffplug/spotless/tree/main/plugin-gradle#formatannotations"><span style="font-family:monospace">formatAnnotations</span></a>
step to correct the formatting of type annotations.
</li><li class="li-itemize">Run google-java-format via <a href="https://github.com/plume-lib/run-google-java-format">run-google-java-format</a>
</li></ul>
<!--TOC section id="faq-semantics-section" Semantics of type annotations-->
<h2 id="faq-semantics-section" class="section">38.7 Semantics of type annotations <a href="#faq-semantics-section"><img src="chainlink.svg" width="10" height="10"></a></h2><!--SEC END -->
<!--TOC subsection id="faq-typestate" How can I handle typestate, or phases of my program with different data properties?-->
<h3 id="faq-typestate" class="subsection">38.7.1 How can I handle typestate, or phases of my program with different data properties? <a href="#faq-typestate"><img src="chainlink.svg" width="10" height="10"></a></h3><!--SEC END --><p>Sometimes, your program works in phases that have different behavior. For
example, you might have a field that starts out null and becomes non-null
at some point during execution, such as after a method is called. You can
express this property as follows:</p><ol class="enumerate" type=1><li class="li-enumerate">
Annotate the field type as <a href="../api/org/checkerframework/checker/nullness/qual/MonotonicNonNull.html"><span style="font-family:monospace">@MonotonicNonNull</span></a>.
</li><li class="li-enumerate">Annotate the method that sets the field as <a href="../api/org/checkerframework/checker/nullness/qual/EnsuresNonNull.html"><span style="font-family:monospace">@EnsuresNonNull</span></a><span style="font-family:monospace">("</span><em><span style="font-family:monospace">myFieldName</span></em><span style="font-family:monospace">")</span>.
(If method <span style="font-family:monospace">m1</span> calls method <span style="font-family:monospace">m2</span>, which actually sets the field, then
you would probably write this annotation on both <span style="font-family:monospace">m1</span> and <span style="font-family:monospace">m2</span>.)
</li><li class="li-enumerate">Annotate any method that depends on the field being non-null as
<a href="../api/org/checkerframework/checker/nullness/qual/RequiresNonNull.html"><span style="font-family:monospace">@RequiresNonNull</span></a><span style="font-family:monospace">("</span><em><span style="font-family:monospace">myFieldName</span></em><span style="font-family:monospace">")</span>.
The type-checker will verify that such a method is only called when the
field isn’t null — that is, the method is only called after the setting
method.
</li></ol><p>You can also use a typestate checker (see
Chapter ‍<a href="#typestate-checker">29.30</a>), but they have not been as extensively
tested.</p>
<!--TOC subsection id="faq-implicit-bounds" Why are explicit and implicit bounds defaulted differently?-->
<h3 id="faq-implicit-bounds" class="subsection">38.7.2 Why are explicit and implicit bounds defaulted differently? <a href="#faq-implicit-bounds"><img src="chainlink.svg" width="10" height="10"></a></h3><!--SEC END --><p>The following two bits of code have the same semantics under Java, but are
treated differently by the Checker Framework’s CLIMB-to-top defaulting
rules (Section ‍<a href="#climb-to-top">31.5.3</a>):</p><pre class="verbatim">class MyClass&lt;T&gt; { ... }
class MyClass&lt;T extends Object&gt; { ... }
</pre><p>The difference is the annotation on the upper bound of the type argument
<span style="font-family:monospace">T</span>. They are treated in the following way.</p><pre class="verbatim">class MyClass&lt;T&gt;                 ==  class MyClass&lt;T extends @TOPTYPEANNO Object&gt;
class MyClass&lt;T extends Object&gt;  ==  class MyClass&lt;T extends @DEFAULTANNO Object&gt;
</pre><p><span style="font-family:monospace">@TOPTYPEANNO</span> is the top annotation in the type qualifier hierarchy. For
example, for the nullness type system, the top type annotation is
<span style="font-family:monospace">@Nullable</span>, as shown in Figure ‍<a href="#fig-nullness-hierarchy">3.1</a>.
<span style="font-family:monospace">@DEFAULTANNO</span> is the default annotation for the type system. For
example, for the nullness type system, the default type annotation is
<span style="font-family:monospace">@NonNull</span>.</p><p>In some type systems, the top qualifier and the default are the same. For
such type systems, the two code snippets shown above are treated the same.
An example is the regular expression type system; see
Figure ‍<a href="#fig-regex-hierarchy">13.1</a>.</p><p>The CLIMB-to-top rule reduces the code edits required to annotate an
existing program, and it treats types written in the program consistently.</p><p>When a user writes no upper bound, as in
<span style="font-family:monospace">class C&lt;T&gt; </span><span style="font-family:monospace">{</span><span style="font-family:monospace"> ... </span><span style="font-family:monospace">}</span>,
then Java permits the class to be instantiated with any type parameter.
The Checker Framework behaves exactly the same, no matter what the default
is for a particular type system — and no matter whether the user has
changed the default locally.</p><p>When a user writes an upper bound, as in
<span style="font-family:monospace">class C&lt;T extends OtherClass&gt; </span><span style="font-family:monospace">{</span><span style="font-family:monospace"> ... </span><span style="font-family:monospace">}</span>,
then the Checker Framework treats this occurrence of <span style="font-family:monospace">OtherClass</span> exactly
like any other occurrence, and applies the usual defaulting rules. Use of
<span style="font-family:monospace">Object</span> is treated consistently with all other types in this location and
all other occurrences of <span style="font-family:monospace">Object</span> in the program.</p><p>Here are some style guidelines:
</p><ul class="itemize"><li class="li-itemize">
Omit the <span style="font-family:monospace">extends</span> clause when possible. To indicate no constraints on
type qualifiers, write <span style="font-family:monospace">class MyClass&lt;T&gt;</span> rather than <span style="font-family:monospace">class
MyClass&lt;T extends @TOPTYPEANNO Object&gt;</span>.
</li><li class="li-itemize">When you write an <span style="font-family:monospace">Object</span> upper bound, give an explicit type annotation.
That is, write <span style="font-family:monospace">class C&lt;T extends @DEFAULTANNO Object&gt;
</span><span style="font-family:monospace">{</span><span style="font-family:monospace"> ... </span><span style="font-family:monospace">}</span> even though it is equivalent to writing
<span style="font-family:monospace">class C&lt;T extends Object&gt; </span><span style="font-family:monospace">{</span><span style="font-family:monospace"> ... </span><span style="font-family:monospace">}</span>.<p>If you write just <span style="font-family:monospace">extends Object</span>, then someone who is reading the code
might think that it is irrelevant (which it is in plain Java). Also,
some IDEs will suggest removing it.
</p></li></ul>
<!--TOC subsection id="faq-writing-generics" How should I annotate code that uses generics?-->
<h3 id="faq-writing-generics" class="subsection">38.7.3 How should I annotate code that uses generics? <a href="#faq-writing-generics"><img src="chainlink.svg" width="10" height="10"></a></h3><!--SEC END --><p>Suppose unannotated code contains a type parameter <span style="font-family:monospace">&lt;T&gt;</span>. How should
you annotate that?</p><p>This is really a question about Java’s generic types, so if you understand
Java generics, this question is moot. However, Java generics can be hard
to understand, so here is a brief explanation of some concrete annotations,
using nullness annotations for concreteness.</p><dl class="description"><dt class="dt-description">
<span style="font-weight:bold"><span style="font-family:monospace">&lt;T&gt;</span></span></dt><dd class="dd-description">
Any type argument may be supplied for <span style="font-family:monospace">T</span>.<p>It is equivalent to <span style="font-family:monospace">&lt;T extends @Nullable Object&gt;</span>, because
<span style="font-family:monospace">@Nullable Object</span> is the top type in the type hierarchy.</p></dd><dt class="dt-description"><span style="font-weight:bold"><span style="font-family:monospace">&lt;T extends @Nullable Object&gt;</span></span></dt><dd class="dd-description">
Any type argument may be supplied for <span style="font-family:monospace">T</span>.<p>It is equivalent to <span style="font-family:monospace">&lt;T&gt;</span>, as noted above.</p></dd><dt class="dt-description"><span style="font-weight:bold"><span style="font-family:monospace">&lt;T extends Object&gt;</span></span></dt><dd class="dd-description">
<span style="font-family:monospace">T</span> can be instantiated by any type whose qualifier is <span style="font-family:monospace">@NonNull</span>.<p>The default annotation is <span style="font-family:monospace">@NonNull</span>, and annotation defaults apply
to type uses such as <span style="font-family:monospace">Object</span> but not to type variables such as
<span style="font-family:monospace">T</span>. Therefore, <span style="font-family:monospace">&lt;T extends Object&gt;</span> is equivalent to
<span style="font-family:monospace">&lt;T extends @NonNull Object&gt;</span>. It permits any type argument that is
a subtype of <span style="font-family:monospace">@NonNull Object</span>, which is any type argument whose
qualifier is <span style="font-family:monospace">@NonNull</span> since <span style="font-family:monospace">@NonNull</span> is the bottom type
qualifier in the type qualifier hierarchy.</p></dd><dt class="dt-description"><span style="font-weight:bold"><span style="font-family:monospace">&lt;T extends @NonNull Object&gt;</span></span></dt><dd class="dd-description">
<span style="font-family:monospace">T</span> can be instantiated by any type whose qualifier is <span style="font-family:monospace">@NonNull</span>.<p>It is equivalent to <span style="font-family:monospace">&lt;T extends Object&gt;</span>, as noted above.</p></dd><dt class="dt-description"><span style="font-weight:bold"><span style="font-family:monospace">&lt;@Nullable T&gt;</span></span></dt><dd class="dd-description">
<span style="font-family:monospace">T</span> can be instantiated by any type whose qualifier is <span style="font-family:monospace">@Nullable</span>.<p>The annotation <span style="font-family:monospace">@Nullable</span> before <span style="font-family:monospace">T</span> applies to <span style="font-family:monospace">T</span>’s
implicit lower bound. There is no explicit upper bound (that is, no
<span style="font-family:monospace">extends</span>), so the upper bound is the top type, <span style="font-family:monospace">@Nullable
Object</span>, just as for <span style="font-family:monospace">&lt;T&gt;</span>, which was discussed above. Therefore,
<span style="font-family:monospace">&lt;@Nullable T&gt;</span> is the same as <span style="font-family:monospace">&lt;T super @Nullable void extends
@Nullable Object&gt;</span>, except that the latter is not legal Java.</p></dd><dt class="dt-description"><span style="font-weight:bold"><span style="font-family:monospace">&lt;T super @Nullable String&gt;</span></span></dt><dd class="dd-description">
<span style="font-family:monospace">T</span> can be instantiated by any supertype of <span style="font-family:monospace">@Nullable String</span>,
which is any supertype of <span style="font-family:monospace">String</span> (<span style="font-family:monospace">Object</span>,
<span style="font-family:monospace">Serializable</span>, <span style="font-family:monospace">CharSequence</span>, etc.) so long as its type
qualifier is <span style="font-family:monospace">@Nullable</span>.</dd><dt class="dt-description"><span style="font-weight:bold"><span style="font-family:monospace">&lt;T super @NonNull String&gt;</span></span></dt><dd class="dd-description">
<span style="font-family:monospace">T</span> can be instantiated by any supertype of <span style="font-family:monospace">@NonNull String</span>.
Since <span style="font-family:monospace">@NonNull</span> is the bottom type qualifier, the instantiating type
can have any type qualifier.</dd></dl><p>For more details about how the Checker Framework supports generics and
polymorphism, see Chapter ‍<a href="#polymorphism">30</a>.</p>
<!--TOC subsection id="faq-runtime-retention" Why are type annotations declared with <span style="font-family:monospace">@Retention(RetentionPolicy.RUNTIME)</span>?-->
<h3 id="faq-runtime-retention" class="subsection">38.7.4 Why are type annotations declared with <span style="font-family:monospace">@Retention(RetentionPolicy.RUNTIME)</span>? <a href="#faq-runtime-retention"><img src="chainlink.svg" width="10" height="10"></a></h3><!--SEC END --><p>Annotations such as <a href="../api/org/checkerframework/checker/nullness/qual/NonNull.html"><span style="font-family:monospace">@NonNull</span></a> are
declared with
<a href="https://docs.oracle.com/en/java/javase/17/docs/api/java.base/java/lang/annotation/Retention.html"><span style="font-family:monospace">@Retention</span></a><span style="font-family:monospace">(RetentionPolicy.</span><a href="https://docs.oracle.com/en/java/javase/17/docs/api/java.base/java/lang/annotation/RetentionPolicy.html#RUNTIME"><span style="font-family:monospace">RUNTIME</span></a><span style="font-family:monospace">)</span>. In other words,
these type annotations are available to tools at run time. Such run-time
tools could check the annotations (like an <span style="font-family:monospace">assert</span> statement), type-check
dynamically-loaded code, check casts and <span style="font-family:monospace">instanceof</span> operations, resolve
reflection more precisely, or other tasks that we have not yet thought of.
Not many such tools exist today, but the annotation designers wanted to
accommodate them in the future.</p><p><span style="font-family:monospace">RUNTIME</span> retention has negligible costs (no run-time dependency, minimal
increase in heap size). To avoid these costs, a project can use the
<span style="font-family:monospace">checker-qual-android</span> dependency; as explained in Section ‍<a href="#android">37.1</a>,
it is identical to <span style="font-family:monospace">checker-qual</span>, except that in <span style="font-family:monospace">checker-qual-android</span>
annotations have
<a href="https://docs.oracle.com/en/java/javase/17/docs/api/java.base/java/lang/annotation/RetentionPolicy.html#CLASS"><span style="font-family:monospace">CLASS</span></a>
retention.</p><p>For the purpose of static checking at compile time,
<a href="https://docs.oracle.com/en/java/javase/17/docs/api/java.base/java/lang/annotation/RetentionPolicy.html#CLASS"><span style="font-family:monospace">CLASS</span></a>
retention is sufficient. Note that
<a href="https://docs.oracle.com/en/java/javase/17/docs/api/java.base/java/lang/annotation/RetentionPolicy.html#SOURCE"><span style="font-family:monospace">SOURCE</span></a>
retention would not be sufficient, because of separate compilation: when
type-checking a class, the compiler needs to read the annotations on
libraries that it uses, and separately-compiled libraries are available to
the compiler only as class files.</p>
<!--TOC section id="faq-create-a-checker-section" Creating a new checker-->
<h2 id="faq-create-a-checker-section" class="section">38.8 Creating a new checker <a href="#faq-create-a-checker-section"><img src="chainlink.svg" width="10" height="10"></a></h2><!--SEC END -->
<!--TOC subsection id="faq-create-a-checker" How do I create a new checker?-->
<h3 id="faq-create-a-checker" class="subsection">38.8.1 How do I create a new checker? <a href="#faq-create-a-checker"><img src="chainlink.svg" width="10" height="10"></a></h3><!--SEC END --><p>In addition to using the checkers that are distributed with the Checker
Framework, you can write your own checker to check specific properties that
you care about. Thus, you can find and prevent the bugs that are most
important to you.</p><p>Chapter ‍<a href="#creating-a-checker">35</a> gives
complete details regarding how to write a checker. It also suggests places
to look for more help, such as the <a href="../api/">Checker Framework
API documentation (Javadoc)</a> and the source code of the distributed
checkers.</p><p>To whet your interest and demonstrate how easy it is to get started, here
is an example of a complete, useful type-checker.</p><pre class="verbatim">  @SubtypeOf(Unqualified.class)
  @Target({ElementType.TYPE_USE, ElementType.TYPE_PARAMETER})
  public @interface Encrypted {}
</pre><p>Section ‍<a href="#subtyping-example">28.2</a> explains this checker and tells
you how to run it.</p>
<!--TOC subsection id="faq-type-properties" What properties can and cannot be handled by type-checking?-->
<h3 id="faq-type-properties" class="subsection">38.8.2 What properties can and cannot be handled by type-checking? <a href="#faq-type-properties"><img src="chainlink.svg" width="10" height="10"></a></h3><!--SEC END --><p>In theory, any property about a program can be expressed and checked within
a type system. In practice, types are a good choice for some properties
and a bad choice for others.</p><p>A type expresses the set of possible values for an expression. Therefore,
types are a good choice for any property that is about variable values or
provenance.</p><p>Types are a poor choice for expressing properties about timing, such as
that action B will happen within 10 milliseconds of action A. Types are
not good for verifying the results of calculations; for example, they could
ensure that code always call an <span style="font-family:monospace">encrypt</span> routine in the appropriate
places, but not that the <span style="font-family:monospace">encrypt</span> routine is correctly implemented.
Types are not a good solution for preventing infinite loops, except perhaps
in special cases.</p>
<!--TOC subsection id="faq-declarative-syntax-for-type-rules" Why is there no declarative syntax for writing type rules?-->
<h3 id="faq-declarative-syntax-for-type-rules" class="subsection">38.8.3 Why is there no declarative syntax for writing type rules? <a href="#faq-declarative-syntax-for-type-rules"><img src="chainlink.svg" width="10" height="10"></a></h3><!--SEC END --><p>A type system implementer can declaratively specify the type qualifier
hierarchy (Section ‍<a href="#creating-declarative-hierarchy">35.5.2</a>) and the type introduction rules
(Section ‍<a href="#creating-type-introduction">35.8</a>). However, the Checker
Framework uses a procedural syntax for specifying type-checking
rules (Section ‍<a href="#creating-extending-visitor">35.7</a>).
A declarative syntax might be more concise, more readable, and more
verifiable than a procedural syntax.</p><p>We have not found the procedural syntax to be the most important impediment
to writing a checker.</p><p>Previous attempts to devise a declarative syntax
for realistic type systems have failed; see a technical
paper ‍[<a href="#PapiACPE2008">PAC+08</a>] for a discussion. When an
adequate syntax exists, then the Checker Framework can be extended to
support it.</p>
<!--TOC section id="faq-tool-section" Tool questions-->
<h2 id="faq-tool-section" class="section">38.9 Tool questions <a href="#faq-tool-section"><img src="chainlink.svg" width="10" height="10"></a></h2><!--SEC END -->
<!--TOC subsection id="faq-pluggable-type-checking" How does pluggable type-checking work?-->
<h3 id="faq-pluggable-type-checking" class="subsection">38.9.1 How does pluggable type-checking work? <a href="#faq-pluggable-type-checking"><img src="chainlink.svg" width="10" height="10"></a></h3><!--SEC END --><p>The Checker Framework enables you to define a new type system. It finds
errors, or guarantees their absence, by performing type-checking that is
similar to that already performed by the Java compiler.</p><p>Type-checking examines each statement of your program in turn, one at a time.
</p><ul class="itemize"><li class="li-itemize">
Expressions are processed bottom-up. Given types for each sub-expression,
the type-checker determines whether the types are legal for the
expression’s operator and determines the type of the expression.
</li><li class="li-itemize">An assignment is legal if the type of the right-hand side is a subtype of
the declared type of the left-hand side.</li><li class="li-itemize">At a method call, the arguments are legal if they can be assigned to the
formal parameters (this is called a “pseudo-assignment” and it follows
the normal rules for assignment). The type of the method call is the
declared type of the return type, where the method is declared. If
the method declaration is not annotated, then a default annotation is
used.</li><li class="li-itemize">Suppose that method <span style="font-family:monospace">Sub.m</span> overrides method <span style="font-family:monospace">Super.m</span>.
The return type of <span style="font-family:monospace">Sub.m</span> must be equal to or a subtype of the return
type of <span style="font-family:monospace">Super.m</span> (this is called “covariance”).
The type of formal parameter <span style="font-style:italic">i</span> of <span style="font-family:monospace">Sub.m</span> must be equal to or a
<em>super</em>type of the type of formal parameter <span style="font-style:italic">i</span> in <span style="font-family:monospace">Super.m</span> (this
is called “contravariance”).</li></ul>
<!--TOC subsection id="faq-classpath-to-use-annotated-library" What classpath is needed to use an annotated library?-->
<h3 id="faq-classpath-to-use-annotated-library" class="subsection">38.9.2 What classpath is needed to use an annotated library? <a href="#faq-classpath-to-use-annotated-library"><img src="chainlink.svg" width="10" height="10"></a></h3><!--SEC END --><p>Suppose that you distribute a library, which contains Checker Framework
annotations such as <span style="font-family:monospace">@Nullable</span>. This enables clients of the library to
use the Checker Framework to type-check their programs. To do so, they
must have the Checker Framework annotations on their classpath, for
instance by using the Checker Framework Compiler.</p><p>Clients who do not wish to perform pluggable type-checking do not need to
have the Checker Framework annotations
(<span style="font-family:monospace">checker-qual.jar</span>) in their classpath, either when compiling or running
their programs.</p><p>The JVM does not issue a link error if an annotation is not found when a
class is loaded. (By contrast, the JVM does issue a link error if a
superclass, or a parameter/return/field type, is not found.)
Likewise, there is no problem compiling against a library even if the
library’s annotations are not on the classpath.
These are properties of Java, and are not specific to the Checker
Framework’s annotations.</p>
<!--TOC subsection id="faq-classfile-annotations" Why do <span style="font-family:monospace">.class</span> files contain more annotations than the source code?-->
<h3 id="faq-classfile-annotations" class="subsection">38.9.3 Why do <span style="font-family:monospace">.class</span> files contain more annotations than the source code? <a href="#faq-classfile-annotations"><img src="chainlink.svg" width="10" height="10"></a></h3><!--SEC END --><p>A <span style="font-family:monospace">.class</span> file contains an annotation on every type, as computed by
defaulting rules; see Section ‍<a href="#effective-qualifier">31.4</a>.</p><p>When an overridden method has a side effect annotation, the overriding
method must have one too. However, if the side effect annotation is
declared with the <a href="../api/org/checkerframework/framework/qual/InheritedAnnotation.html"><span style="font-family:monospace">@InheritedAnnotation</span></a>
meta-annotation, the Checker Framework automatically adds the missing
annotation. This is the case for most side effect annotations — these
annotations are propagated from annotated libraries, such as the JDK, to
your code.</p>
<!--TOC subsection id="faq-checked-exceptions" Is there a type-checker for managing checked and unchecked exceptions?-->
<h3 id="faq-checked-exceptions" class="subsection">38.9.4 Is there a type-checker for managing checked and unchecked exceptions? <a href="#faq-checked-exceptions"><img src="chainlink.svg" width="10" height="10"></a></h3><!--SEC END --><p>It is possible to annotate exception types, and any type-checker built on the
Checker Framework enforces that type annotations are consistent between
<span style="font-family:monospace">throw</span> statements and <span style="font-family:monospace">catch</span> clauses that might catch them.</p><p>The Java compiler already enforces that all checked exceptions are caught
or are declared to be passed through, so you would use annotations to
express other properties about exceptions.</p><p>Checked exceptions are an example of a “type and effect” system, which is
like a type system but also accounts for actions/behaviors such as side
effects. The GUI Effect Checker (Chapter ‍<a href="#guieffect-checker">18</a>) is a
type-and-effect system that is distributed with the Checker Framework.</p>
<!--TOC subsection id="faq-cf-is-slow" The Checker Framework runs too slowly-->
<h3 id="faq-cf-is-slow" class="subsection">38.9.5 The Checker Framework runs too slowly <a href="#faq-cf-is-slow"><img src="chainlink.svg" width="10" height="10"></a></h3><!--SEC END --><p>Using a pluggable type-checker increases compile times by a factor of 2–10.
Slow compilation speed is probably the worst thing about the Checker
Framework.</p><p>To improve performance:
</p><ul class="itemize"><li class="li-itemize">
Ensure that the Checker Framework has enough memory. The Checker
Framework uses more memory than <span style="font-family:monospace">javac</span> does, and Java’s default heap
limit is so small that the Checker Framework might spend most of its time
in garbage collection. (If this is the case, the Checker Framework will
issue a warning “Garbage collection consumed over 25% of CPU during the
past minute.") For example, you might pass an argument like
<span style="font-family:monospace">-Xmx3g</span>, or set an environment variable like <span style="font-family:monospace">export
_JAVA_OPTIONS=-Xmx3g</span>, to permit the Checker Framework to use up to 3GB
of memory. If you use Java 8, consider upgrading to Java 11 or Java 17, which have
better memory management.
</li><li class="li-itemize">Set your build system to perform <em>incremental compilation</em>. When
compiling just a few source files (the size of a typical edit or commit),
you won’t notice the slowdown even if the Checker Framework is very slow.
If you compile all files in a large project, you will definitely notice a
slowdown. You should structure your build system to make compiling all
files rare, by declaring dependencies and using caching.
(Note: Maven lacks dependency-driven build and caching. If your project
uses Maven, consider switching to a more capable build system such as Gradle.)
</li></ul><p>If the Checker Framework is still too slow for you to run on every compilation,
you can run it periodically, such as in a Git commit hook or in continuous
integration.</p><p>The Checker Framework team does not currently have the resources to fix
performance problems, but we welcome community contributions.</p><p>Here are some reasons that the Checker Framework is slow.
</p><ul class="itemize"><li class="li-itemize">
It has to do all the same work as the compiler does, such as resolving
overloading and overriding, inferring generics, and type-checking.
</li><li class="li-itemize">Its analysis is general; it interprets user-defined type systems whereas
<span style="font-family:monospace">javac</span> hard-codes one type system and integrates it with other processing.
</li><li class="li-itemize">Its analysis are much richer. <span style="font-family:monospace">javac</span> can take certain shortcuts that
are not correct for all possible type systems.
</li><li class="li-itemize">It builds a control flow graph and performs a fixpoint analysis on it,
which <span style="font-family:monospace">javac</span> does not do.
</li><li class="li-itemize">It manipulates multiple representations of data, including <span style="font-family:monospace">javac</span>’s
internal representation, source code, control flow graph, and its own
internal representation. These transformations and lookups take time.
</li><li class="li-itemize">It switches between dataflow analysis and type analysis, and this
sometimes causes it to redo work.
</li><li class="li-itemize">When running a compound or aggregate checker, it computes the control
flow graph multiple times, and it makes multiple passes over the program
rather than just one.
</li></ul>
<!--TOC subsection id="faq-version-number" What does the Checker Framework version number mean?-->
<h3 id="faq-version-number" class="subsection">38.9.6 What does the Checker Framework version number mean? <a href="#faq-version-number"><img src="chainlink.svg" width="10" height="10"></a></h3><!--SEC END --><p>As explained in Section ‍<a href="#version-number">1.3</a>, a change in the middle number
of the Checker Framework version string indicates a possible
incompatibility.</p><p>Another policy is “semantic versioning” as defined at
<a href="https://semver.org/"><span style="font-family:monospace">https://semver.org/</span></a>. This version number policy, unfortunately,
does not define key terms, such as “backwards compatible bug fixes”. It
includes an
escape hatch, “Semantic Versioning is all about conveying meaning by how
the version number changes.” It has not been updated in over a decade
(since January 2013), has only ever been updated once (from
1.0.0 to 2.0.0), and has
about 100 open issues.
It is a proposal, not a standard nor an official definition.
Projects that claim to follow it often do so loosely.</p><p>If the Checker Framework strictly used semver.org’s definition, every
release would be a new major version, and the current version string would
be
past version 200.0.0.
Always incrementing the major version number would not convey meaning to
its users — for example, it would not indicate major new functionality or
important behavior differences.</p>
<!--TOC section id="faq-other-tools-section" Relationship to other tools-->
<h2 id="faq-other-tools-section" class="section">38.10 Relationship to other tools <a href="#faq-other-tools-section"><img src="chainlink.svg" width="10" height="10"></a></h2><!--SEC END -->
<!--TOC subsection id="faq-type-checking-vs-bug-detectors" Why not just use a bug detector (like SpotBugs or Error Prone)?-->
<h3 id="faq-type-checking-vs-bug-detectors" class="subsection">38.10.1 Why not just use a bug detector (like SpotBugs or Error Prone)? <a href="#faq-type-checking-vs-bug-detectors"><img src="chainlink.svg" width="10" height="10"></a></h3><!--SEC END --><p>A pluggable type-checker
is a verification tool that prevents or detects all errors of a given
variety. If it issues no warnings, your code has no errors of a given
variety (for details about the guarantee, see
Section ‍<a href="#checker-guarantees">2.3</a>).</p><p>An alternate approach is to use a bug detector such as
<a href="https://errorprone.info/">Error Prone</a>,
<a href="https://findbugs.sourceforge.net/">FindBugs</a> ‍[<a href="#HovemeyerP2004">HP04</a>, <a href="#HovemeyerSP2005">HSP05</a>],
<a href="https://github.com/spotbugs/spotbugs">SpotBugs</a>,
<a href="https://jlint.sourceforge.net/">Jlint</a> ‍[<a href="#Artho2001">Art01</a>],
<a href="https://pmd.github.io/">PMD</a> ‍[<a href="#Copeland2005">Cop05</a>],
or the
tools built into Eclipse (see Section ‍<a href="#faq-eclipse">38.10.2</a>) and IntelliJ.
The <a href="https://github.com/uber/NullAway">NullAway</a> and
<a href="https://fbinfer.com/docs/next/checker-eradicate/">Eradicate</a> tools are more
like sound type-checking than bug detection, but all of those tools accept
unsoundness — that is, false negatives or missed warnings — in exchange
for analysis speed.</p><p>A pluggable type-checker or verifier
differs from a bug detector in several ways:
</p><ul class="itemize"><li class="li-itemize">
A type-checker reports <em>all</em> errors in your code. If a type-checker
reports no warnings, then you have a guarantee (a proof) of correctness
(Section ‍<a href="#faq-no-absolute-guarantee">38.4.5</a>).<p>A bug detector aims to find <em>some</em> of the most obvious errors. Even
if a bug detector reports no warnings, there may still be errors in your
code.</p></li><li class="li-itemize">A type-checker requires you to annotate your code with type qualifiers,
or to run an inference tool that does so for you. That is, it requires
you to write a specification, then it verifies that your code meets its
specification.<p>Some bug detectors do not require annotations. This means that it may be
easier to get started running a bug detector. The tool makes guesses
about the intended behavior of your code, leading to false alarms or
missed alarms.</p></li><li class="li-itemize">A verification tool may issue more warnings for a programmer to
investigate. Some bug detectors internally generate many warnings, then
use heuristics to discard some of them. The cost is missed alarms, when
the tool’s heuristics classified the warnings as likely false positives
and discarded them.</li><li class="li-itemize">A type-checker uses a more sophisticated and precise analysis. For
example, it can take advantage of method annotations and annotations on
generic type parameters, such as <span style="font-family:monospace">List&lt;@NonNull String&gt;</span>. An
example specific to the Nullness Checker (Section ‍<a href="#nullness-checker">3</a>,
no other tool correctly handles map keys or initialization.<p>A bug detector does a more lightweight analysis. This means that a bug
detector usually runs faster, giving feedback to the programmer more
rapidly and avoiding slowdowns. Its analysis is often narrow, avoiding
properties that are tricky to reason about or that might lead to false
alarms. The cost is missed alarms, when analysis is too weak to find the
errors.</p></li><li class="li-itemize">Neither type checking nor bug detection subsumes the other. A
type-checker finds problems that a bug detector cannot. A bug detector
finds problems that a type-checker does not: there is no need for the
type-checker to address style rules, when a bug detector is adequate.<p>If your code is important to you, it is advantageous to run both types of
tools.</p></li></ul><p>For a case study that compared the nullness analysis of FindBugs
(equivalent to SpotBugs), Jlint,
PMD, and the Checker Framework, see section 6 of the paper
<a href="https://homes.cs.washington.edu/~mernst/pubs/pluggable-checkers-issta2008.pdf">“Practical pluggable types for Java”</a> ‍[<a href="#PapiACPE2008">PAC+08</a>].
The case study was on a well-tested program in daily use. The Checker
Framework tool found 8 nullness errors (that is, null pointer
dereferences). None of the other tools found any errors. A follow-up 10
years later found that Eclipse’s nullness analysis found 0 of the errors,
and IntelliJ’s nullness analyses found 3 of the errors, that the Nullness
Checker found.</p><p>The
<a href="https://checkerframework.org/jsr308/">JSR 308</a> ‍[<a href="#JSR308-2008-09-12">Ern08b</a>]
documentation also contains a discussion of related work.</p>
<!--TOC subsection id="faq-eclipse" How does the Checker Framework compare with Eclipse’s null analysis?-->
<h3 id="faq-eclipse" class="subsection">38.10.2 How does the Checker Framework compare with Eclipse’s null analysis? <a href="#faq-eclipse"><img src="chainlink.svg" width="10" height="10"></a></h3><!--SEC END --><p>Eclipse comes with a
<a href="https://help.eclipse.org/luna/index.jsp?topic=%2Forg.eclipse.jdt.doc.user%2Ftasks%2Ftask-using_null_annotations.htm">null analysis</a> that
can detect potential null pointer errors in your code. Eclipse’s built-in
analysis differs from the Checker Framework in several respects.</p><p>The Checker Framework’s Nullness Checker
(see ‍Chapter ‍<a href="#nullness-checker">3</a>) is more precise: it does a deeper
semantic analysis, so it issues fewer false positives than Eclipse.
Eclipse’s nullness analysis is missing many features that the Checker
Framework supports, such as handling of map keys, partially-initialized
objects, method pre- and post-conditions, polymorphism, and a powerful
dataflow analysis. These are essential for practical verification of
real-world code without poor precision.
Furthermore, Eclipse by default ignores unannotated code (even unannotated
parameters within a method that contains other annotations).
As a result, Eclipse is more useful for bug-finding than for verification,
and that is what the Eclipse documentation recommends.
</p><p>Eclipse assumes by default that all code is multi-threaded, which cripples its local
type inference. (This default can be turned off, however.)
The Checker Framework allows the user to
specify whether code will be run concurrently or not via the
<span style="font-family:monospace">-AconcurrentSemantics</span> command-line option (see
Section ‍<a href="#faq-concurrency">38.4.6</a>).</p><p>The Checker Framework builds on javac, so it is easier to run in
integration scripts or in
environments where not all developers have installed Eclipse.
</p><p>Eclipse handles only nullness properties and is not extensible, whereas the
Checker Framework comes with over 20 type-checkers (for a list,
see ‍Chapter ‍<a href="#introduction">1</a>) and is extensible to more properties.</p><p>There are also some benefits to Eclipse’s null analysis.
It is faster than the Checker Framework, in part because it is less featureful.
It is built into Eclipse, so you do not have to add it to your build scripts.
Its IDE integration is tighter and slicker.</p><p>In a case study, the Nullness Checker found 9 errors in a program, and
Eclipse’s analysis found 0.</p>
<!--TOC subsection id="faq-nullaway" How does the Checker Framework compare with NullAway?-->
<h3 id="faq-nullaway" class="subsection">38.10.3 How does the Checker Framework compare with NullAway? <a href="#faq-nullaway"><img src="chainlink.svg" width="10" height="10"></a></h3><!--SEC END --><p><a href="https://github.com/uber/NullAway">NullAway</a> is a lightweight, unsound
type-checker whose aim is similar to that of the Nullness Checker
(Chapter ‍<a href="#nullness-checker">3</a>). For both tools, the user writes
nullness annotations, and then the tool checks them.</p><p>NullAway is faster than the Nullness Checker and requires fewer annotations.</p><p>NullAway is unsound: even if NullAway issues no warnings, your code might
crash with a null pointer exception. Two differences are that NullAway
makes unchecked assumptions about getter methods and NullAway assumes all
objects are always fully initialized. NullAway forces all generic
arguments to be non-null, which is not an unsoundness but is less flexible
than the Nullness Checker.</p>
<!--TOC subsection id="faq-optional" How does the Checker Framework compare with the JDK’s <span style="font-family:monospace">Optional</span> type?-->
<h3 id="faq-optional" class="subsection">38.10.4 How does the Checker Framework compare with the JDK’s <span style="font-family:monospace">Optional</span> type? <a href="#faq-optional"><img src="chainlink.svg" width="10" height="10"></a></h3><!--SEC END --><p>JDK 8 introduced the <a href="https://docs.oracle.com/en/java/javase/17/docs/api/java.base/java/util/Optional.html"><span style="font-family:monospace">Optional</span></a>
class, a container that is either empty or contains a non-null value.
The Optional Checker (see Chapter ‍<a href="#optional-checker">5</a>) guarantees that
programmers use <span style="font-family:monospace">Optional</span> correctly.</p><p>Section ‍<a href="#nullness-vs-optional">3.7.3</a> explains the relationship between
nullness and <span style="font-family:monospace">Optional</span> and the benefits of each.</p>
<!--TOC subsection id="faq-jml" How does pluggable type-checking compare with JML?-->
<h3 id="faq-jml" class="subsection">38.10.5 How does pluggable type-checking compare with JML? <a href="#faq-jml"><img src="chainlink.svg" width="10" height="10"></a></h3><!--SEC END --><p><a href="http://www.eecs.ucf.edu/~leavens/JML/index.shtml">JML</a>, the Java Modeling
Language ‍[<a href="#LeavensBR2006%3AJML">LBR06</a>], is a language for writing formal
specifications.</p><p><span style="font-weight:bold">JML aims to be more expressive than pluggable type-checking.</span>
A programmer can write a JML specification that
describes arbitrary facts about program behavior. Then, the programmer can
use formal reasoning or a theorem-proving tool to verify that the code
meets the specification. Run-time checking is also possible.
By contrast, pluggable type-checking can express a more limited set of
properties about your program. Pluggable type-checking annotations are
more concise and easier to understand.</p><p><span style="font-weight:bold">JML is not as practical as pluggable type-checking.</span>
The JML toolset is less mature. For instance, if your code uses
generics or other features of Java 5, then you cannot use JML.
However, JML has a run-time checker, which the Checker Framework currently
lacks.</p>
<!--TOC subsection id="faq-checker-framework-part-of-java" Is the Checker Framework an official part of Java?-->
<h3 id="faq-checker-framework-part-of-java" class="subsection">38.10.6 Is the Checker Framework an official part of Java? <a href="#faq-checker-framework-part-of-java"><img src="chainlink.svg" width="10" height="10"></a></h3><!--SEC END --><p>The Checker Framework is not an official part of Java.
The Checker Framework relies on type annotations, which became part of Java
with Java 8 (released in March 2014). For more about type annotations, see the
<a href="https://checkerframework.org/jsr308/jsr308-faq.html#pluggable-type-checking-in-java">Type
Annotations (JSR 308) FAQ</a> for more details.</p>
<!--TOC subsection id="faq-jsr-305" What is the relationship between the Checker Framework and JSR 305?-->
<h3 id="faq-jsr-305" class="subsection">38.10.7 What is the relationship between the Checker Framework and JSR 305? <a href="#faq-jsr-305"><img src="chainlink.svg" width="10" height="10"></a></h3><!--SEC END --><p>JSR 305 aimed to define official Java names for some annotations, such as
<span style="font-family:monospace">@NonNull</span> and <span style="font-family:monospace">@Nullable</span>. However, it did not aim to precisely define
the semantics of those annotations nor to provide a reference
implementation of an annotation processor that validated their use;
as a result, JSR 305 was of limited utility as a specification.
JSR 305 has been abandoned; there has been
no activity by its expert group since
2009.</p><p>By contrast, the Checker Framework precisely defines the meaning of a set
of annotations and provides powerful type-checkers that validate them.
However, the Checker Framework is not an official part of the Java
language; it chooses one set of names, but another tool might choose other
names.</p><p>In the future, the Java Community Process might revitalize JSR 305 or
create a replacement JSR to standardize the names and
meanings of specific annotations, after there is more experience with their
use in practice.</p><p>The Checker Framework defines annotations <span style="font-family:monospace">@NonNull</span> and <span style="font-family:monospace">@Nullable</span> that
are compatible with annotations defined by JSR 305, SpotBugs, IntelliJ, and
other tools; see Section ‍<a href="#nullness-related-work">3.7</a>.</p>
<!--TOC subsection id="faq-jsr-308" What is the relationship between the Checker Framework and JSR 308?-->
<h3 id="faq-jsr-308" class="subsection">38.10.8 What is the relationship between the Checker Framework and JSR 308? <a href="#faq-jsr-308"><img src="chainlink.svg" width="10" height="10"></a></h3><!--SEC END --><p>JSR 308, also known as the Type Annotations specification, dictates the
syntax of type annotations in Java SE 8: how they are expressed in the
Java language.</p><p>JSR 308 does not define any type annotations such as <span style="font-family:monospace">@NonNull</span>, and it does
not specify the semantics of any annotations. Those tasks are left to
third-party tools. The Checker Framework is one such tool.</p><hr>
<!--TOC chapter id="troubleshooting" Troubleshooting, getting help, and contributing-->
<h1 id="troubleshooting" class="chapter">Chapter ‍39 Troubleshooting, getting help, and contributing <a href="#troubleshooting"><img src="chainlink.svg" width="10" height="10"></a></h1><!--SEC END --><p>
The manual might already answer your question, so first please look for
your answer in the manual,
including this chapter and the FAQ (Chapter ‍<a href="#faq">38</a>).
If not, you can use the mailing list,
<span style="font-family:monospace">checker-framework-discuss@googlegroups.com</span>, to ask other users for
help. For archives and to subscribe, see <a href="https://groups.google.com/forum/#!forum/checker-framework-discuss"><span style="font-family:monospace">https://groups.google.com/forum/#!forum/checker-framework-discuss</span></a>.
To report bugs, please see Section ‍<a href="#reporting-bugs">39.2</a>.
If you want to help out, you can give feedback (including on the
documentation), choose a bug and fix it, or select a
project from the ideas list at
<a href="https://htmlpreview.github.io/?https://github.com/eisop/checker-framework/master/docs/developer/gsoc-ideas.html"><span style="font-family:monospace">https://htmlpreview.github.io/?https://github.com/eisop/checker-framework/master/docs/developer/gsoc-ideas.html</span></a>.
</p>
<!--TOC section id="common-problems" Common problems and solutions-->
<h2 id="common-problems" class="section">39.1 Common problems and solutions <a href="#common-problems"><img src="chainlink.svg" width="10" height="10"></a></h2><!--SEC END --><ul class="itemize"><li class="li-itemize">
To verify that you are using the compiler you think you are, you can add
<span style="font-family:monospace">-version</span> to the command line. For instance, instead of running
<span style="font-family:monospace">javac -g MyFile.java</span>, you can run <span style="font-family:monospace">javac </span><span style="font-family:monospace"><U>-version</U></span><span style="font-family:monospace"> -g
MyFile.java</span>. Then, javac will print out its version number in addition
to doing its normal processing. Note that if you are running under Java 8,
<span style="font-family:monospace">$CHECKERFRAMEWORK/bin/javac -version</span> prints “javac (version info
not available)” because it uses the Error Prone compiler which does not
provide version information.</li></ul>
<!--TOC subsection id="common-problems-compiling" Unable to compile the Checker Framework-->
<h3 id="common-problems-compiling" class="subsection">39.1.1 Unable to compile the Checker Framework <a href="#common-problems-compiling"><img src="chainlink.svg" width="10" height="10"></a></h3><!--SEC END --><p>If you get the following error while compiling the Checker Framework itself:</p><pre class="verbatim">checker-framework/stubparser/dist/stubparser.jar(org/checkerframework/stubparser/ast/CompilationUnit.class):
warning: [classfile] Signature attribute introduced in version 49.0 class files is ignored in version 46.0 class files
</pre><p>and you have used Eclipse to compile the Checker Framework, then probably
you are using a very old version of Eclipse. (If you
install Eclipse from the Ubuntu 16.04 repository, you get Eclipse version
3.8. Ubuntu 16.04 was released in April 2016, and Eclipse 3.8 was released
in June 2012, with subsequent major releases in June 2013, June 2014, and
June 2015.)
Install the latest version of Eclipse and use it instead.</p>
<!--TOC subsection id="common-problems-running" Unable to run the checker, or checker crashes-->
<h3 id="common-problems-running" class="subsection">39.1.2 Unable to run the checker, or checker crashes <a href="#common-problems-running"><img src="chainlink.svg" width="10" height="10"></a></h3><!--SEC END --><p>If you are unable to run the checker, or if the checker or the compiler
terminates with an error, then the problem may be a problem with your environment.
(If the checker or the compiler crashes, that is a bug in the Checker
Framework; please report it. See Section ‍<a href="#reporting-bugs">39.2</a>.)
This section describes some possible problems and solutions.</p><ul class="itemize"><li class="li-itemize">
<a id="no-such-field-error-release"></a>
An error that includes <span style="font-family:monospace">java.lang.NoSuchFieldError: RELEASE"</span> means that
you are not using the correct compiler (you are not using a Java 9+ compiler).</li><li class="li-itemize">If you get the error<pre class="verbatim">com.sun.tools.javac.code.Symbol$CompletionFailure: class file for com.sun.source.tree.Tree not found
</pre><p>then you are using the source installation and file <span style="font-family:monospace">tools.jar</span> is not
on your classpath. See the installation instructions
(Section ‍<a href="#installation">1.3</a>).</p></li><li class="li-itemize">If you get an error like one of the following,<pre class="verbatim">...\build.xml:59: Error running ${env.CHECKERFRAMEWORK}\checker\bin\javac.bat compiler
</pre><pre class="verbatim">.../bin/javac: Command not found
</pre><pre class="verbatim">error: Annotation processor 'org.checkerframework.checker.signedness.SignednessChecker' not found
</pre><p>then the problem may be that you have not set the <span style="font-family:monospace">CHECKERFRAMEWORK</span> environment
variable, as described in Section ‍<a href="#javac-wrapper">37.5</a>. Or, maybe
you made it a user variable instead of a system variable.</p></li><li class="li-itemize">If you get one of these errors:<pre>
The hierarchy of the type <em>ClassName</em> is inconsistent

The type com.sun.source.util.AbstractTypeProcessor cannot be resolved.
  It is indirectly referenced from required .class files
</pre><p>
then you are likely <span style="font-weight:bold">not</span> using the Checker Framework compiler. Use
either <span style="font-family:monospace">$CHECKERFRAMEWORK/checker/bin/javac</span> or one of the alternatives
described in Section ‍<a href="#javac-wrapper">37.5</a>.
</p></li><li class="li-itemize">If you get the error<pre class="verbatim">  java.lang.ArrayStoreException: sun.reflect.annotation.TypeNotPresentExceptionProxy
</pre><p>then an annotation is not present at run time that was present at compile
time. For example, maybe when you compiled the code, the <span style="font-family:monospace">@Nullable</span>
annotation was available, but it was not available at run time.</p></li><li class="li-itemize">If you get an error that contains lines like these:<pre class="verbatim">Caused by: java.util.zip.ZipException: error in opening zip file
    at java.util.zip.ZipFile.open(Native Method)
    at java.util.zip.ZipFile.&lt;init&gt;(ZipFile.java:131)
</pre><p>then one possibility is that you have installed the Checker Framework in a
directory that contains special characters that Java’s ZipFile
implementation cannot handle. For instance, if the directory name contains
“<span style="font-family:monospace">+</span>”, then Java 1.6 throws a ZipException, and Java 1.7 throws a
FileNotFoundException and prints out the directory name with “<span style="font-family:monospace">+</span>”
replaced by blanks.</p></li><li class="li-itemize">The Checker Framework sometimes runs out of memory when processing very
large Java files, or files with very large methods.<p>If you get an error such as
</p><pre class="verbatim">error: SourceChecker.typeProcess: unexpected Throwable (OutOfMemoryError) while processing ...
  ; message: GC overhead limit exceeded
</pre><p>(all on one line),
then either give the JVM more memory when running the Checker Framework, or
split your files and methods into smaller ones, or both.</p></li><li class="li-itemize">Versions of <a href="https://errorprone.info/">Error Prone</a> before 2.4.0 are
incompatible with the Checker Framework. (More precisely, each version of
Error Prone before 2.4.0 is compatible with only one specific version of
the Checker Framework.) Those versions of Error Prone
use outdated versions of the Checker Framework’s dataflow analysis
library, each of which is compatible with only one version of the Checker Framework.<p>If you wish to use both Error Prone and the Checker Framework, then use
Error Prone version 2.4.0 or later.
If you cannot upgrade to Error Prone 2.4.0 or later, there is a way to
still use both tools. The
<a href="https://github.com/kelloggm/checkerframework-gradle-plugin#incompatibility-with-error-prone">Gradle
plugin documentation</a> shows how to do so if you use the Gradle build
system.</p></li><li class="li-itemize">Versions 0.9.0 and 0.9.1 of
<a href="https://github.com/uber/NullAway">NullAway</a> are compatible
only with Checker Framework version 3.6.0 through 3.8.0. Those versions of
NullAway use version 3.6.0 of the Checker Framework’s dataflow analysis
library without shading it. As of version 0.9.2, NullAway uses a shaded version of
the library, so this conflict no longer exists.
If you want to use a version of the Checker Framework newer than 3.8.0 with
NullAway in the same build, then use NullAway 0.9.2 or later.</li></ul>
<!--TOC subsection id="common-problems-non-typechecking" Unexpected warnings not related to type-checking-->
<h3 id="common-problems-non-typechecking" class="subsection">39.1.3 Unexpected warnings not related to type-checking <a href="#common-problems-non-typechecking"><img src="chainlink.svg" width="10" height="10"></a></h3><!--SEC END --><p>This section gives solutions for some warning messages that are not related
to type errors in your code.</p><ul class="itemize"><li class="li-itemize">If you get an error like the following<pre class="verbatim">error: scoping construct for static nested type cannot be annotated
error: scoping construct cannot be annotated with type-use annotation
</pre><p>then you have probably written something like one of the following:
</p><dl class="description"><dt class="dt-description">
<span style="font-weight:bold"><span style="font-family:monospace">@Nullable java.util.List</span></span></dt><dd class="dd-description">
The correct Java syntax to write an annotation on a fully-qualified type
name is to put the annotation on the simple name part, as in
<span style="font-family:monospace">java.util.@Nullable List</span>. But, it’s usually
better to add <span style="font-family:monospace">import java.util.List</span> to your source file, so that you can
just write <span style="font-family:monospace">@Nullable List</span>.
</dd><dt class="dt-description"><span style="font-weight:bold"><span style="font-family:monospace">@Nullable Map.Entry</span></span></dt><dd class="dd-description"> You must write <span style="font-family:monospace">Outer.@Nullable
StaticNestedClass</span> rather than <span style="font-family:monospace">@Nullable Outer.StaticNestedClass</span>.
Since a static nested class does not depend on its outer class, the
annotation on the outer class would have no effect and is forbidden.
</dd></dl><p>Java 8 requires that a type qualifier be written directly on the type that
it qualifies, rather than on a scoping mechanism that assists in resolving
the name. Examples of scoping mechanisms are package names and outer
classes of static nested classes.</p><p>The reason for the Java 8 syntax is to avoid syntactic irregularity. When
writing a member nested class (also known as an inner class), it is
possible to write annotations on both the outer and the inner class: <span style="font-family:monospace">@A1
Outer. @A2 Inner</span>. Therefore, when writing a static nested class, the
annotations should go on the same place: <span style="font-family:monospace">Outer. @A3 StaticNested</span> (rather
than <span style="font-family:monospace">@ConfusingAnnotation Outer. Nested</span> where
<span style="font-family:monospace">@ConfusingAnnotation</span> applies to <span style="font-family:monospace">Outer</span> if <span style="font-family:monospace">Nested</span> is a member class
and applies to <span style="font-family:monospace">Nested</span> if <span style="font-family:monospace">Nested</span> is a static class). It’s not legal
to write an annotation on the outer class of a static nested class, because
neither annotations nor instantiations of the outer class affect the static
nested class.</p><p>Similar arguments apply when annotating <span style="font-family:monospace">pakkage.Outer.Nested</span>.</p></li><li class="li-itemize">An “error: package ... does not exist” or “error: cannot find symbol”
about classes in your own project or its dependencies means that you have
left your own project or its dependencies off the classpath when you
invoked the compiler.</li></ul>
<!--TOC subsection id="common-problems-typechecking" Unexpected type-checking results-->
<h3 id="common-problems-typechecking" class="subsection">39.1.4 Unexpected type-checking results <a href="#common-problems-typechecking"><img src="chainlink.svg" width="10" height="10"></a></h3><!--SEC END --><p>This section describes possible problems that can lead the type-checker to
give unexpected results.</p><ul class="itemize"><li class="li-itemize">
If the Checker Framework is unable to verify a property that you know is
true, then you should formulate a proof about why the property is true.
Your proof depends on some set of facts about the program and its
operation. State them completely; for example, don’t write “the field
<span style="font-family:monospace">f</span> cannot be null when execution reaches line 22”, but justify
<em>why</em> the field cannot be null.<p>Once you have written down your proof, translate each fact into a Java
annotation.</p><p>If you are unable to express some aspect of your proof as an annotation,
then the type system is not capable of reproducing your proof. You might
need to find a different proof, or extend the type system to be more
expressive, or suppress the warning.</p><p>If you are able to express your entire proof as annotations, then look at
the Checker Framework error messages.
</p><ul class="itemize"><li class="li-itemize">
Perhaps your proof was incomplete or incorrect. Your proof might
depend on some fact you didn’t write down, such as “method
<span style="font-family:monospace">m</span> has no side effects.” In this case, you should revise your proof
and add more annotations to your Java code.
</li><li class="li-itemize">Perhaps your proof is incorrect, and the errors indicate where.
</li><li class="li-itemize">Perhaps there is a bug in the type-checker. In this case,
you should report it to the maintainers, giving your proof and explaining
why the type-checker should be able to make the same inferences that you did.
</li></ul><p>Recall that the Checker Framework does modular verification,
one procedure at a time; it observes the specifications, but not the
implementations, of other methods.</p><p>Also see Section ‍<a href="#handling-warnings">2.4.5</a>, which explains this same
methodology in different words.</p></li><li class="li-itemize">If a checker seems to be ignoring the annotation on a method, then it is
possible that the checker is reading the method’s signature from its
<span style="font-family:monospace">.class</span> file, but the <span style="font-family:monospace">.class</span> file was not created by a Java 8
or later compiler.
You can check whether the annotations actually appear in the
<span style="font-family:monospace">.class</span> file by using the <span style="font-family:monospace">javap</span> tool.<p>If the annotations do not appear in the <span style="font-family:monospace">.class</span> file, here are two
ways to solve the problem:
</p><ul class="itemize"><li class="li-itemize">
Re-compile the method’s class with the Checker Framework compiler. This will
ensure that the type annotations are written to the class file, even if
no type-checking happens during that execution.
</li><li class="li-itemize">Pass the method’s file explicitly on the command line when type-checking,
so that the compiler reads its source code instead of its <span style="font-family:monospace">.class</span>
file.
</li></ul></li><li class="li-itemize">If a checker issues a warning about a property that it accepted (or that
was checked) on a previous line, then probably there was a side-effecting
method call in between that could invalidate the property. For example, in
this code:<pre class="verbatim">if (currentOutgoing != null &amp;&amp; !message.isCompleted()) {
    currentOutgoing.continueBuffering(message);
}
</pre><p>the Nullness Checker will issue a warning on the second line:
</p><pre class="verbatim">warning: [dereference.of.nullable] dereference of possibly-null reference currentOutgoing
    currentOutgoing.continueBuffering(message);
    ^
</pre><p>If <span style="font-family:monospace">currentOutgoing</span> is a field rather than a local variable, and
<span style="font-family:monospace">isCompleted()</span> is not a pure method, then a null pointer
dereference can occur at the given location, because <span style="font-family:monospace">isCompleted()</span> might set
the field <span style="font-family:monospace">currentOutgoing</span> to <span style="font-family:monospace">null</span>.</p><p>If you want to communicate that
<span style="font-family:monospace">isCompleted()</span> does not set the field <span style="font-family:monospace">currentOutgoing</span> to <span style="font-family:monospace">null</span>, you can use
<a href="../api/org/checkerframework/dataflow/qual/Pure.html"><span style="font-family:monospace">@Pure</span></a>,
<a href="../api/org/checkerframework/dataflow/qual/SideEffectFree.html"><span style="font-family:monospace">@SideEffectFree</span></a>,
or <a href="../api/org/checkerframework/checker/nullness/qual/EnsuresNonNull.html"><span style="font-family:monospace">@EnsuresNonNull</span></a> on the
declaration of <span style="font-family:monospace">isCompleted()</span>; see Sections ‍<a href="#type-refinement-purity">31.7.5</a>
and ‍<a href="#nullness-method-annotations">3.2.2</a>.</p></li><li class="li-itemize">If a checker issues a type-checking error for a call that the library’s
documentation states is correct, then maybe that library method has not yet
been annotated, so default annotations are being used.<p>To solve the problem, add the missing annotations to the library (see
Chapter ‍<a href="#annotating-libraries">34</a>). The
annotations might appear in stub files (which appear
in an <span style="font-family:monospace">.astub</span> file together with the checker’s source code)
or in the form of annotated libraries (which appear
in <a href="https://github.com/eisop/"><span style="font-family:monospace">https://github.com/eisop/</span></a>).</p></li><li class="li-itemize">If the compiler reports that it cannot find a method from the JDK or
another external library, then maybe the stub file for that class
is incomplete.<p>To solve the problem, add the missing annotations to the library, as
described in the previous item.</p><p>The error might take one of these forms:</p><pre class="verbatim">method sleep in class Thread cannot be applied to given types
cannot find symbol: constructor StringBuffer(StringBuffer)
</pre></li><li class="li-itemize">If you get an error related to a bounded type parameter and a literal such
as <span style="font-family:monospace">null</span>, the problem may be missing defaulting. Here is an example:<pre class="verbatim">mypackage/MyClass.java:2044: warning: incompatible types in assignment.
      T retval = null;
                 ^
  found   : null
  required: T extends @MyQualifier Object
</pre><p>A value that can be assigned to a variable of type <span style="font-family:monospace">T extends @MyQualifier
Object</span> only if that value is of the bottom type, since the bottom type is
the only one that is a subtype of every subtype of <span style="font-family:monospace">T extends @MyQualifier
Object</span>. The value <span style="font-family:monospace">null</span> satisfies this for the Java type system, and it
must be made to satisfy it for the pluggable type system as well. The
typical way to address this is to call <span style="font-family:monospace">addStandardLiteralQualifiers</span> on the <span style="font-family:monospace">LiteralTreeAnnotator</span>.</p></li><li class="li-itemize">An error such as<pre class="verbatim">MyFile.java:123: error: incompatible types in argument.
                        myModel.addElement("Scanning directories...");
                                           ^
  found   : String
  required: ? extends Object
</pre><p>may stem from use of raw types. (“<span style="font-family:monospace">String</span>” might be a different type
and might have type annotations.) If your declaration was</p><pre class="verbatim">  DefaultListModel myModel;
</pre><p>then it should be
</p><pre class="verbatim">  DefaultListModel&lt;String&gt; myModel;
</pre><p>Running the regular Java compiler with the <span style="font-family:monospace">-Xlint:unchecked</span> command-line
option will help you to find and fix problems such as raw types.</p></li><li class="li-itemize">The error<pre class="verbatim">error: annotation type not applicable to this kind of declaration
    ... List&lt;@NonNull String&gt; ...
</pre><p>indicates that you are using a definition of <span style="font-family:monospace">@NonNull</span> that is a
declaration annotation, which cannot be used in that syntactic location.
For example, many legacy annotations such as those listed in
Figures ‍<a href="#fig-nullness-refactoring-nonnull">3.2</a> and <a href="#fig-nullness-refactoring-nullable">3.3</a>
are declaration annotations. You can
fix the problem by instead using a definition of <span style="font-family:monospace">@NonNull</span> that is a type
annotation, such as the Checker Framework’s annotations; often this only
requires changing an <span style="font-family:monospace">import</span> statement.</p></li><li class="li-itemize">If Eclipse gives the warning<pre class="verbatim">The annotation @NonNull is disallowed for this location
</pre><p>then you have the wrong version of the <span style="font-family:monospace">org.eclipse.jdt.annotation</span>
classes. Eclipse includes two incompatible versions of these annotations.
You want the one with a name like
<span style="font-family:monospace">org.eclipse.jdt.annotation_2.0.0.....jar</span>, which you can find in the
<span style="font-family:monospace">plugins</span> subdirectory under the Eclipse installation directory.
Add this .jar file to your build path.</p></li><li class="li-itemize">When one formal parameter’s annotation references another formal
parameter’s name, as in this constructor:<pre class="verbatim">public String(char value[], @IndexFor("value") int offset, @IndexOrHigh("value") int count) { ... }
</pre><p>you will get an error such as</p><pre class="verbatim">[expression.unparsable.type.invalid] Expression in dependent type annotation invalid:
Use "#1" rather than "value"
</pre><p>Section ‍<a href="#java-expressions-as-arguments">31.8</a> explains that you need to use
a different syntax to refer to a formal parameter:</p><pre class="verbatim">public String(char value[], @IndexFor("#1") int offset, @IndexOrHigh("#1") int count) { ... }
</pre></li><li class="li-itemize"><a id="false-positive-in-dead-code"></a>
The Checker Framework can issue false positive warnings in dead code. An
example is<pre class="verbatim">  void m() {
    String t = "";
    t.toString();
    try {
    } catch (Throwable e) {
        t.toString(); // Nullness Checker issues spurious (dereference.of.nullable)
    }
</pre></li><li class="li-itemize">If the Checker Framework issues an error or warning that you cannot
reproduce using a smaller test case, then try running the Checker
Framework with the <span style="font-family:monospace">-AatfDoNotCache</span> command-line argument. If the
Checker Framework behaves differently with and without that command-line
argument, then there is a bug related to its internal caches. Please
report that bug at
<a href="https://github.com/eisop/checker-framework/issues"><span style="font-family:monospace">https://github.com/eisop/checker-framework/issues</span></a>.</li></ul>
<!--TOC subsection id="common-problems-running-javac" Unexpected compilation output when running javac without a pluggable type-checker-->
<h3 id="common-problems-running-javac" class="subsection">39.1.5 Unexpected compilation output when running javac without a pluggable type-checker <a href="#common-problems-running-javac"><img src="chainlink.svg" width="10" height="10"></a></h3><!--SEC END --><p>A message of the form</p><pre class="verbatim">  error: annotation values must be of the form 'name=value'
        @LTLengthOf("firstName", "lastName") int index;
                    ^
</pre><p>is caused by incorrect Java syntax. When you supply a set of multiple
values as an annotation argument, you need to put curly braces around them:</p><pre class="verbatim">        @LTLengthOf({"firstName", "lastName"}) int index;
</pre>
<!--TOC section id="reporting-bugs" How to report problems (bug reporting)-->
<h2 id="reporting-bugs" class="section">39.2 How to report problems (bug reporting) <a href="#reporting-bugs"><img src="chainlink.svg" width="10" height="10"></a></h2><!--SEC END --><p>If you have a problem with any checker, or with the Checker Framework,
please file a bug at
<a href="https://github.com/eisop/checker-framework/issues"><span style="font-family:monospace">https://github.com/eisop/checker-framework/issues</span></a>.
(First, check whether there is an existing bug report for that issue.)
If the problem is with an incorrect or missing annotation on a library,
including the JDK, see Section ‍<a href="#reporting-bugs-annotated-libraries">39.2.1</a>.
You can also use the issue tracker to make suggestions and feature
requests. We also welcome pull requests with annotated libraries, bug
fixes, new features, new checkers, and other improvements.</p><p>Please ensure that your bug report is clear and that it is complete.
Otherwise, we may be unable to understand it or to reproduce it, either of
which would prevent us from helping you. Your bug report should include at
least the following 4 parts: commands, inputs, outputs, and expectation.</p><dl class="description"><dt class="dt-description">
<span style="font-weight:bold">Commands</span></dt><dd class="dd-description">
Provide one or more commands that can be pasted into a command shell to
reproduce the problem.<p>In the simplest case, you will provide one command of
the form <span style="font-family:monospace">javac -processor ... MyFile.java</span>. In more complex cases, it
might be a set of commands clone a repository, check out a branch, and
run a build command. Include commands to install software and set
environment variables if necessary.</p><p>If you encountered the problem in an IDE, reproduce it from the command
line; if you cannot, report the bug to the IDE integration.
If you encountered the problem when using a build system, it is most
useful to the Checker Framework developers if you provide a single
<span style="font-family:monospace">javac</span> command rather than a build file.</p><p>It can be helpful to add <br>
 <span style="font-family:monospace">-version -Aversion -AprintGitProperties -verbose -AprintVerboseGenerics</span> <br>
 to the javac options. This causes the
compiler to output debugging information, including its version number.</p></dd><dt class="dt-description"><span style="font-weight:bold">Inputs</span></dt><dd class="dd-description">
Include all files that are necessary to reproduce the problem. This
includes every file that is used by any of the commands you reported, and
possibly other files as well. This is not necessary if the commands you
provided obtain the code that is type-checked.<p>If you cannot share your code, create a new, small test case. (A small
test case is helpful even if your code is not secret!) If the Checker
Framework crashed, the progress tracing options
(Section ‍<a href="#creating-debugging-options-progress">35.12.4</a>) can be helpful in
determining which file the Checker Framework was processing when it
crashed.</p><p><em>Minimization:</em>
If your command invokes a build system such as Gradle or Maven, it can be
helpful to the maintainers if you are able to reduce it to a single
<span style="font-family:monospace">javac</span> invocation on a single file.
This also rules out the possibility that the problem is with the build system
integration rather than the checker itself.
If you use an invasive
annotation processor such as Lombok, then try to reproduce the problem
without it — this will indicate whether the problem is in the Checker
Framework proper or in its interaction with Lombok.</p></dd><dt class="dt-description"><span style="font-weight:bold">Output</span></dt><dd class="dd-description">
Indicate exactly what the result was by attaching a file or using
cut-and-paste from your command shell. Don’t merely describe it in
words, don’t use a screenshot, and don’t provide just part of the output.</dd><dt class="dt-description"><span style="font-weight:bold">Expectation</span></dt><dd class="dd-description">
If the problem is not a crash, then
indicate what you expected the result to be, since a bug is a difference
between desired and actual outcomes. Also, please indicate <span style="font-weight:bold">why</span>
you expected that result — explaining your reasoning can reveal
how your reasoning is different than the checker’s and which
one is wrong. Remember that the checker reasons modularly and
intraprocedurally: it examines one method at a time, using only the
method signatures of other methods.<p>It can also be helpful to indicate what you have already done to try to
understand the problem. Did you do any additional experiments? What
parts of the manual did you read, and what else did you search for in the
manual? Without this information, the maintainers may give you redundant
suggestions or may waste time re-doing work you have already done.
</p></dd></dl><p>When reporting bugs, please focus on realistic scenarios and well-written
code. We are sure that you can make up artificial code that stymies the
type-checker! Those aren’t a good use of your time to report nor the
maintainers’ time to evaluate and fix.</p>
<!--TOC subsection id="reporting-bugs-annotated-libraries" Problems with annotated libraries-->
<h3 id="reporting-bugs-annotated-libraries" class="subsection">39.2.1 Problems with annotated libraries <a href="#reporting-bugs-annotated-libraries"><img src="chainlink.svg" width="10" height="10"></a></h3><!--SEC END --><p>If a checker reports a warning because a library contains <em>incorrect</em> annotations,
then please open a pull request that adds the annotations. If the
library’s maintainers have added annotations, make a pull request to them.
If the Checker Framework maintainers have added annotations,
you can find the annotated source in <a href="https://github.com/eisop/"><span style="font-family:monospace">https://github.com/eisop/</span></a>.</p><p>If a checker reports a warning because a library is <em>not
annotated</em>, please do not open a GitHub issue.
Instead, we appreciate pull requests to help us improve the annotations.
Alternatively or in the interim, you can use stub files as described in
Section ‍<a href="#stub">34.5</a>.</p><p>For either approach, please see Chapter ‍<a href="#annotating-libraries">34</a> for
tips about writing library annotations.</p><p>Thanks for your contribution to the annotated libraries!</p>
<!--TOC section id="build-source" Building from source-->
<h2 id="build-source" class="section">39.3 Building from source <a href="#build-source"><img src="chainlink.svg" width="10" height="10"></a></h2><!--SEC END --><p>The Checker Framework release (Section ‍<a href="#installation">1.3</a>) contains
everything that most users need, both to use the distributed checkers and
to write your own checkers. This section describes how to compile its
binaries from source. You will be using the latest development version of
the Checker Framework, rather than an official release.</p><p>The Checker Framework can be built and runs under any JDK version 8 or later.</p>
<!--TOC subsection id="building-prerequisites" Install prerequisites-->
<h3 id="building-prerequisites" class="subsection">39.3.1 Install prerequisites <a href="#building-prerequisites"><img src="chainlink.svg" width="10" height="10"></a></h3><!--SEC END --><p>You need to install several packages in order to build the Checker
Framework.
Follow the instructions for your operating system.
If your OS is not listed, adapt the instructions for an existing OS;
for example, other Linux distributions will be similar to Ubuntu.</p><p>Put the setting of the <span style="font-family:monospace">JAVA_HOME</span> environment variable in a startup file
such as <span style="font-family:monospace">.bash_profile</span> or <span style="font-family:monospace">.bashrc</span>, if <span style="font-family:monospace">JAVA_HOME</span> is not already
set appropriately. It must be the location of your JDK
installation (not the JRE installation).
You may need to log out and log back in for the setting to take effect.</p><dl class="description"><dt class="dt-description">
<span style="font-weight:bold">Ubuntu</span></dt><dd class="dd-description">
Run the following commands, which should be the same as those in
<span style="font-family:monospace">checker/bin-devel/Dockerfile-ubuntu-jdk</span><span style="font-family:monospace"><em>XX</em></span><span style="font-family:monospace">-plus</span>, where <em>XX</em>
is a JDK version such as 8, 11, 17, etc.:<p>(This list should be the same as in
<span style="font-family:monospace">checker/bin-devel/Dockerfile-ubuntu-jdk17-plus</span>; if your build fails
because it is missing a package, try the commands there and report a bug
in this manual.)</p><pre class="verbatim">sudo apt-get -qqy update
sudo apt-get -qqy install \
 openjdk-17-jdk \
 ant cpp git gradle jq libcurl3-gnutls \
 make maven mercurial python3-pip python3-requests unzip wget \
 autoconf devscripts dia hevea imagemagick junit latexmk \
 librsvg2-bin libasound2-dev libcups2-dev libfontconfig1-dev \
 libx11-dev libxext-dev libxrender-dev libxrandr-dev libxtst-dev libxt-dev \
 pdf2svg rsync shellcheck \
 texlive-font-utils texlive-fonts-recommended \
 texlive-latex-base texlive-latex-extra texlive-latex-recommended
pip3 install black flake8 html5validator
</pre><p>You may have to answer questions about which time zone your computer is in.</p><p>In a startup file, write:
</p><pre class="verbatim">  export JAVA_HOME=${JAVA_HOME:-$(dirname "$(dirname "$(readlink -f "$(which javac)")")")}
</pre></dd><dt class="dt-description"><span style="font-weight:bold">Mac OS</span></dt><dd class="dd-description">
If you employ <a href="https://brew.sh">homebrew</a> to install packages, run
the following commands:<pre class="verbatim">brew update
brew install git ant hevea maven mercurial librsvg unzip make
brew tap AdoptOpenJDK/openjdk
brew install --cask adoptopenjdk17
brew install --cask mactex
</pre><p>Make a <span style="font-family:monospace">latex</span> directory and copy <span style="font-family:monospace">hevea.sty</span> file into it.
(<a href="https://hevea.inria.fr/"><span style="font-family:monospace">https://hevea.inria.fr/</span></a> gives the current version number.)</p><pre class="verbatim">mkdir -p $HOME/Library/texmf/tex/latex
cp -p /usr/local/Cellar/hevea/2.36/lib/hevea/hevea.sty $HOME/Library/texmf/tex/latex/
</pre><p>Note: If copy permission is denied, try <span style="font-family:monospace">sudo</span>.</p><p>In a startup file, write:</p><pre class="verbatim">export JAVA_HOME=$(/usr/libexec/java_home -v 17)
</pre><p>
or
</p><pre class="verbatim">export JAVA_HOME=/Library/Java/JavaVirtualMachines/adoptopenjdk-17.jdk/Contents/Home/
</pre></dd><dt class="dt-description"><span style="font-weight:bold">Windows</span></dt><dd class="dd-description">
To build on Windows 10,
run <span style="font-family:monospace">bash</span> to obtain a version of
Ubuntu (provided by the Windows Subsystem for Linux) and follow the Ubuntu
instructions.</dd></dl>
<!--TOC subsection id="building-obtain-source" Obtain the source-->
<h3 id="building-obtain-source" class="subsection">39.3.2 Obtain the source <a href="#building-obtain-source"><img src="chainlink.svg" width="10" height="10"></a></h3><!--SEC END --><p>Obtain the latest source code from the version control repository:</p><pre class="verbatim">git clone https://github.com/eisop/checker-framework.git checker-framework
export CHECKERFRAMEWORK=`pwd`/checker-framework
</pre><p>You might want to add an <span style="font-family:monospace">export CHECKERFRAMEWORK=...</span> line to your
<span style="font-family:monospace">.bashrc</span> file.</p>
<!--TOC subsection id="building" Build the Checker Framework-->
<h3 id="building" class="subsection">39.3.3 Build the Checker Framework <a href="#building"><img src="chainlink.svg" width="10" height="10"></a></h3><!--SEC END --><ol class="enumerate" type=1><li class="li-enumerate">Run <span style="font-family:monospace">./gradlew assembleForJavac</span> to build the Checker Framework for <span style="font-family:monospace">javac</span>:<pre class="verbatim">  cd $CHECKERFRAMEWORK
  ./gradlew assembleForJavac
</pre><p>Your antivirus program (e.g., Windows Security Virus &amp; threat protection)
might make the build run very slowly, or might make it seem to stall. Just
give it time.</p><p>If compilation fails, but you have not made any changes, then perhaps one
of the supporting repositories is in an inconsistent state; see
Section ‍<a href="#building-related-repositories">39.3.7</a>.</p></li><li class="li-enumerate">Once it is built, you may wish to put the Checker Framework’s <span style="font-family:monospace">javac</span>
even earlier in your <span style="font-family:monospace">PATH</span>:<pre class="verbatim">export PATH=$CHECKERFRAMEWORK/checker/bin:${PATH}
</pre><p>The Checker Framework’s <span style="font-family:monospace">javac</span> ensures that all required
libraries are on your classpath and boot classpath, but is otherwise
identical to the javac Java compiler.</p><p>Putting the Checker Framework’s <span style="font-family:monospace">javac</span> earlier in your <span style="font-family:monospace">PATH</span> will
ensure that the Checker Framework’s version is used.</p></li><li class="li-enumerate">If you wish to use Maven or Gradle, publish the Checker Framework artifacts to a local Maven repository, run
<span style="font-family:monospace">./gradlew publishToMavenLocal</span>
<pre class="verbatim">  cd $CHECKERFRAMEWORK
  ./gradlew publishToMavenLocal
</pre>
Then use the Maven or Gradle instructions, but modify the version number for the Checker Framework artifacts.
Use the version number that is output when you run <span style="font-family:monospace">./gradlew version</span>.</li><li class="li-enumerate">Test that everything works:<ul class="itemize"><li class="li-itemize">Run <span style="font-family:monospace">./gradlew allTests</span>:
<pre class="verbatim">  cd $CHECKERFRAMEWORK
  ./gradlew allTests
</pre>
</li><li class="li-itemize">Run the Nullness Checker examples (see
Section ‍<a href="#nullness-example">3.5</a>).</li></ul></li><li class="li-enumerate">To quickly rebuild the Checker Framework for local development,
run <span style="font-family:monospace">./gradlew assembleForJavac</span>. This command will assemble the jar
files without generating any Javadoc or sources.jar files, thus it is
faster than <span style="font-family:monospace">./gradlew assemble</span>.</li></ol>
<!--TOC subsection id="building-manual" Build the Checker Framework Manual (this document)-->
<h3 id="building-manual" class="subsection">39.3.4 Build the Checker Framework Manual (this document) <a href="#building-manual"><img src="chainlink.svg" width="10" height="10"></a></h3><!--SEC END --><ol class="enumerate" type=1><li class="li-enumerate">
Install needed packages; see Section ‍<a href="#building-prerequisites">39.3.1</a> for
instructions.</li><li class="li-enumerate">Run <span style="font-family:monospace">make</span> in the <span style="font-family:monospace">docs/manual</span> directory to build both the PDF and HTML versions of the manual.
</li></ol>
<!--TOC subsection id="building-developer-manual" Code style, IDE configuration, pull requests, etc.-->
<h3 id="building-developer-manual" class="subsection">39.3.5 Code style, IDE configuration, pull requests, etc. <a href="#building-developer-manual"><img src="chainlink.svg" width="10" height="10"></a></h3><!--SEC END --><p>Please see the
<a href="https://htmlpreview.github.io/?https://github.com/eisop/checker-framework/master/docs/developer/developer-manual.html">Checker Framework Developer Manual</a>.</p>
<!--TOC subsection id="building-ci" Enable continuous integration builds-->
<h3 id="building-ci" class="subsection">39.3.6 Enable continuous integration builds <a href="#building-ci"><img src="chainlink.svg" width="10" height="10"></a></h3><!--SEC END --><p>We strongly recommend that you enable continuous integration (CI) builds on
your fork of the projects, so that you learn quickly about errors. See the
<a href="https://htmlpreview.github.io/?https://github.com/eisop/checker-framework/master/docs/developer/developer-manual.html#ci">CI
instructions</a> in the Checker Framework Developer Manual.</p>
<!--TOC subsubsection id="building-ci-debug" Debugging continuous integration builds-->
<h4 id="building-ci-debug" class="subsubsection">Debugging continuous integration builds <a href="#building-ci-debug"><img src="chainlink.svg" width="10" height="10"></a></h4><!--SEC END --><p>If a continuous integration job is failing, you can reproduce the problem locally.
The CI jobs all run within Docker containers.
Install Docker on your local computer, then perform commands like the
following to get a shell within Docker:</p><pre class="verbatim">docker pull mdernst/cf-ubuntu-jdk17
docker run -it mdernst/cf-ubuntu-jdk17 /bin/bash
</pre><p>Then, you can run arbitrary commands, including those that appear in the
CI configuration files.</p>
<!--TOC subsection id="building-related-repositories" Related repositories-->
<h3 id="building-related-repositories" class="subsection">39.3.7 Related repositories <a href="#building-related-repositories"><img src="chainlink.svg" width="10" height="10"></a></h3><!--SEC END --><p>Building the Checker Framework depends on other repositories, such as
<a href="https://github.com/eisop/annotation-tools/">Annotation Tools</a> and
<a href="https://github.com/eisop/stubparser/">Stub Parser</a>.
You need to have compatible versions of each.</p><p>After you <span style="font-family:monospace">git pull</span> in one of the repositories, you should do so in the
others as well. The script <span style="font-family:monospace">checker/bin-devel/build.sh</span> pulls all the
related repositories, so to build the latest development version of the
Checker Framework you can do</p><pre class="verbatim">cd $CHECKERFRAMEWORK
git pull
checker/bin-devel/build.sh
</pre>
<!--TOC section id="contributing" Contributing-->
<h2 id="contributing" class="section">39.4 Contributing <a href="#contributing"><img src="chainlink.svg" width="10" height="10"></a></h2><!--SEC END --><p>We welcome contributions and pull requests. Section ‍<a href="#build-source">39.3</a>
tells you how to set up your development environment to compile the Checker
Framework, and the
<a href="https://htmlpreview.github.io/?https://github.com/eisop/checker-framework/master/docs/developer/developer-manual.html">Checker
Framework Developer Manual</a> gives more information.</p><p>One good way to contribute is to give feedback about your use of the tool.
There is a list
of potential projects for new contributors at <a href="https://htmlpreview.github.io/?https://github.com/eisop/checker-framework/master/docs/developer/gsoc-ideas.html"><span style="font-family:monospace">https://htmlpreview.github.io/?https://github.com/eisop/checker-framework/master/docs/developer/gsoc-ideas.html</span></a>.
Or, you can fix a bug that
you have encountered during your use of the Checker Framework.</p>
<!--TOC subsection id="pull-request" Contributing fixes (creating a pull request)-->
<h3 id="pull-request" class="subsection">39.4.1 Contributing fixes (creating a pull request) <a href="#pull-request"><img src="chainlink.svg" width="10" height="10"></a></h3><!--SEC END --><p>Please see the
<a href="https://htmlpreview.github.io/?https://github.com/eisop/checker-framework/master/docs/developer/developer-manual.html#pull-requests">pull
requests</a> section of the Checker Framework Developer Manual.
Thanks in advance for your contributions!</p><p>The easiest bugs to fix for a newcomer are
<a href="https://github.com/eisop/checker-framework/issues?q=isas ``good first issue''">.</a></p><p>Please do not spam the issue tracker with requests to assign an issue to
you. If you want to contribute by fixing an issue, just open a pull
request that fixes it. You can do that even if the issue is already
assigned to someone.</p><p>Please do not spam the issue tracker asking how to get started fixing a
bug. If you have concrete questions, please ask them and we will be happy
to assist you. If you don’t know how to get started fixing a particular
bug, then you should contribute to the project in other ways. Thanks!</p>
<!--TOC section id="credits" Credits and changelog-->
<h2 id="credits" class="section">39.5 Credits and changelog <a href="#credits"><img src="chainlink.svg" width="10" height="10"></a></h2><!--SEC END --><p>Differences from previous versions of the checkers and framework can be found
in the <span style="font-family:monospace">docs/CHANGELOG.md</span> file. This file is included in the
Checker Framework distribution and is also available on the web at
<a href="https://eisop.github.io/cf/CHANGELOG.md"><span style="font-family:monospace">https://eisop.github.io/cf/CHANGELOG.md</span></a>.</p><p>Developers who have contributed code to the Checker Framework include
Abraham Lin,
Adian Qian,
Aditya Singh,
Akash Srivastava,
Alex Liu,
Alvin Abdagic,
Anant Jain,
Anatoly Kupriyanov,
Andy Turner,
Arie van Deursen,
Artem Pyanykh,
Arthur Baars,
Ashish Rana,
Asumu Takikawa,
Atul Dada,
Ayush Agarwal,
Baorui Zhou,
Basil Peace,
Benno Stein,
Bohdan Sharipov,
Brian Corcoran,
Calvin Loncaric,
Charles Chen,
Charlie Garrett,
Chris Povirk,
Chris Toxiadis,
Christopher Mackie,
Colin S. Gordon,
Craig Day,
Dan Brotherston,
Dan Brown,
Daniel Zhu,
David Lazar,
David McArthur,
Di Wang,
Dilraj Singh,
Dmitriy Shepelev,
Eric Spishak,
Ethan Koenig,
Farzan Mirshekari,
Felipe R. Monteiro,
Florian Lanzinger,
Gautam Korlam,
Google Inc. (via @wmdietlGC),
Haaris Ahmed,
Haifeng Shi,
Heath Borders,
Jakub Vrána,
Jason Waataja,
Javier Rodriguez,
Javier Thaine,
Jeff Luo,
Jenny Xiang,
Jeroen Meijer,
Jianchu Li,
Jiangqi Zhang,
Jiasen (Jason) Xu,
Joe Schafer,
John Vandenberg,
Jonathan Burke,
Jonathan Nieder,
Joshua Peterson,
Jugal Mistry,
Junhao Hu,
Kanak Das,
Kartikeya Goswami,
Kenneth Knowles,
Kivanc Muslu,
Konstantin Weitz,
Lazaro Clapp,
Leo Liu,
Liam Miller-Cushon,
Lian Sun,
Luc Edes,
Luqman Aden,
Mahmood Ali,
Manu Sridharan,
Mark Roberts,
Martin Kellogg,
Matt Mullen,
Maximilian Gama,
Michael Bayne,
Michael Coblenz,
Michael Ernst,
Michael Hixson,
Michael Sloan,
Michal Stehlik,
Mier Ta,
Mrigank Arora,
Muyeed Ahmed,
Narges Shadab,
Neil Brown,
Nhat Dinh,
Nhat Nguyen,
Nikhil Shinde,
Nima Karimipour,
Nitin Kumar Das,
Oleg Shchelykalnov,
Olek Wojnar,
Pascal Wittmann,
Patrick Meiring,
Paul Vines,
Paulo Barros,
Philip Lai,
Piyush Jha,
Prionti Nasir,
Priti Chattopadhyay,
Rashmi Mudduluru,
Ravi Roshan,
Renato Athaydes,
René Just,
René Kraneis,
Rob Bygrave,
Ruturaj Mohanty,
Ryan Oblak,
Sadaf Tajik,
Sagar Tewari,
Sean C. Sullivan,
Sean McLaughlin,
Sebastian Schuberth,
Shinya Yoshida,
Shubham Raj,
Sidney Monteiro,
Stefan Heule,
Steph Dietzel,
Stephan Schroevers,
Stuart Pernsteiner,
Suzanne Millstein,
Thomas Schweizer,
Thomas Weißschuh,
Tony Wang,
Trask Stalnaker,
Travis Haagen,
Utsav Oza,
Vatsal Sura,
Vladimir Sitnikov,
Vlastimil Dort,
Weitian Xing,
Werner Dietl,
Zhiping Cai.
</p><p>In addition, too many users to list have provided valuable feedback, which
has improved the toolset’s design and implementation.
Thanks for your help!</p>
<!--TOC section id="license" License-->
<h2 id="license" class="section">39.6 License <a href="#license"><img src="chainlink.svg" width="10" height="10"></a></h2><!--SEC END --><p>Two different licenses apply to different parts of the Checker Framework.
</p><ul class="itemize"><li class="li-itemize">
The Checker Framework itself is licensed under the GNU General Public License
(GPL), version 2, with the classpath exception.
This is the same license that OpenJDK is licensed
under. Just as compiling your code with javac does not infect your code
with the GPL, type-checking your code with the Checker Framework does not
infect your code with the GPL. Running the Checker Framework during
development has no effect on your intellectual property or licensing.<p>If you want to ship the Checker Framework as part of your product, then
your product may need to be licensed under the GPL. Because of the
classpath exception, you can include parts of the Checker Framework in your
product, even if your product uses a different license. For example,
Google’s <a href="https://github.com/google/error-prone">Error Prone</a> and
Uber’s <a href="https://github.com/uber/NullAway">NullAway</a> both use the
Checker Framework internally, but neither one is licensed under the GPL.</p></li><li class="li-itemize">The more permissive MIT License applies
to code that you might want to include in your own
program, such as the annotations and run-time utility classes.
</li></ul><p>For details, see file
<a href="https://raw.githubusercontent.com/eisop/checker-framework/master/LICENSE.txt"><span style="font-family:monospace">LICENSE.txt</span></a>.</p>
<!--TOC section id="publications" Publications-->
<h2 id="publications" class="section">39.7 Publications <a href="#publications"><img src="chainlink.svg" width="10" height="10"></a></h2><!--SEC END --><p>Here are some papers that use the Checker Framework;
for instance, they build a type-checker on top of the Checker Framework, or
their methodology depends on using the Checker Framework.
(It is not papers that merely cite the Checker Framework.)
This list is <em>incomplete</em>; if you know of a paper that
is missing, please let us know so that we can add it.
Most educational use of the Checker Framework is never published, and most
commercial use of the Checker Framework is never discussed publicly.
Most of the papers are available for free online; do a web search on the
title.</p><ul class="itemize"><li class="li-itemize">
Practical pluggable types for Java (ISSTA 2008) ‍[<a href="#PapiACPE2008">PAC+08</a>]
</li><li class="li-itemize">Building and using pluggable type systems with the Checker Framework
(ECOOP 2008) ‍[<a href="#Ernst2008">Ern08a</a>]</li><li class="li-itemize">Type-Based Object Immutability with Flexible Initialization (ECOOP
2009) ‍[<a href="#HaackP2009">HP09</a>]</li><li class="li-itemize">The nullness analyser of Julia (LPAR 2010) ‍[<a href="#Spoto10%3ALPAR">Spo10</a>]
</li><li class="li-itemize">Static checking of safety critical Java annotations (JTRES 2010) ‍[<a href="#TangPJ2010">TPV10</a>]
</li><li class="li-itemize">Ownership and immutability in generic Java (OOPSLA 2010) ‍[<a href="#ZibinPLAE2010">ZPL+10</a>]
</li><li class="li-itemize">Rethinking the economics of software engineering (FOSER 2010) ‍[<a href="#SchillerE2010">SE10</a>]
</li><li class="li-itemize">Applying uniqueness to the Java language (Master’s Thesis, 2010) ‍[<a href="#Harper2010">Har10</a>]
</li><li class="li-itemize">TIFI+: A Type Checker for Object Immutability with Flexible
Initialization (Diploma thesis, 2010) ‍[<a href="#Noack2010">Noa10</a>]</li><li class="li-itemize">Building and using pluggable type-checkers (ICSE 2011) ‍[<a href="#DietlDEMS2011">DDE+11</a>]
</li><li class="li-itemize">Inference of field initialization (ICSE 2011) ‍[<a href="#SpotoE2011">SE11</a>]
</li><li class="li-itemize">EnerJ: approximate data types for safe and general low-power computation
(PLDI 2011) ‍[<a href="#SampsonDFGCG2011">SDF+11</a>]
</li><li class="li-itemize">Tunable static inference for generic universe types (ECOOP 2011) ‍[<a href="#DietlEM2011">DEM11</a>]
</li><li class="li-itemize">Separating ownership topology and encapsulation with generic universe
types (TOPLAS 2011) ‍[<a href="#DietlDM2011">DDM11</a>]
</li><li class="li-itemize">The design, implementation and evaluation of a pluggable type checker for
thread-locality in Java (Master’s Thesis, 2011) ‍[<a href="#Sherwany2011">She11</a>]
</li><li class="li-itemize">Towards Effective Inference and Checking of Ownership Types (IWACO 2011) ‍[<a href="#HuangM2011">HM11</a>]
</li><li class="li-itemize">Static Dominance Inference (TOOLS 2011) ‍[<a href="#MilanovaV2011">MV11</a>]
</li><li class="li-itemize">A Static Memory Safety Annotation System for Safety Critical Java (RTSS 2011) ‍[<a href="#TangPNV2011">TPNV11</a>]</li><li class="li-itemize">Inference and checking of object ownership (ECOOP 2012) ‍[<a href="#HuangDME2012">HDME12</a>]
</li><li class="li-itemize">A type system for regular expressions (FTfJP 2012) ‍[<a href="#SpishakDE2012">SDE12</a>]
</li><li class="li-itemize">Verification games: making verification fun (FTfJF 2012) ‍[<a href="#DietlDEMWCPP2012">DDE+12</a>]
</li><li class="li-itemize">Reim &amp; ReImInfer: checking and inference of reference immutability and
method purity (OOPSLA 2012) ‍[<a href="#HuangMDE2012">HMDE12</a>]
</li><li class="li-itemize">ReImInfer: method purity inference for Java (FSE 2012) ‍[<a href="#HuangM2012">HM12</a>]
</li><li class="li-itemize">Inference and checking of context-sensitive pluggable types (FSE 2012) ‍[<a href="#MilanovaH2012">MH12</a>]
</li><li class="li-itemize">Documenting Java database access with type annotations (WorldComp 2012) ‍[<a href="#Bergstein2012">Ber12</a>]</li><li class="li-itemize">Immutability (book chapter, 2013) ‍[<a href="#PotaninOZE2013">PÖZE13</a>]
</li><li class="li-itemize">JavaUI: Effects for controlling UI object access (ECOOP 2013) ‍[<a href="#GordonDEG2013">GDEG13</a>]
</li><li class="li-itemize">Reified type parameters using Java annotations (GPCE 2013) ‍[<a href="#GerakiosBS2013">GBS13</a>]
</li><li class="li-itemize">Evaluating the Accuracy of Annotations in the Loci 3.0 Pluggable Type
Checker (Master’s Thesis, 2013) ‍[<a href="#Zaza2013">Zaz13</a>]
</li><li class="li-itemize">Composing polymorphic information flow systems with reference
immutability (FTfJP 2013) ‍[<a href="#MilanovaH2013">MH13</a>]</li><li class="li-itemize">Type-based taint analysis for Java web applications (FASE 2014) ‍[<a href="#HuangDM2014">HDM14</a>]
</li><li class="li-itemize">A type system for format strings (ISSTA 2014) ‍[<a href="#WeitzKSE2014">WKSE14</a>]
</li><li class="li-itemize">Collaborative verification of information flow for a high-assurance app
store (CCS 2014) ‍[<a href="#ErnstJMDPRKBBHVW2014">EJM+14</a>]
</li><li class="li-itemize">Cascade: A universal type qualifier inference tool (ICSE 2015) ‍[<a href="#VakilianPEJ2015">VPEJ15</a>]
</li><li class="li-itemize">An inference and checking framework for context-sensitive pluggable types
(PhD thesis, 2014) ‍[<a href="#Huang2014">Hua14</a>]
</li><li class="li-itemize">CFL-reachability and context-sensitive integrity types (PPPJ 2014) ‍[<a href="#MilanovaHD2014">MHD14</a>]</li><li class="li-itemize">Static analysis of implicit control flow: resolving Java reflection and
Android intents (ASE 2015) ‍[<a href="#BarrosJMVDdAE2015">BJM+15</a>]
</li><li class="li-itemize">Scalable and Precise Taint Analysis for Android (ISSTA 2015) ‍[<a href="#HuangDMD2015">HDMD15</a>]
</li><li class="li-itemize">A context-sensitive security type system for Java (Master’s thesis, 2015) ‍[<a href="#Kaiser2015">Kai15</a>]</li><li class="li-itemize">Locking discipline inference and checking (ICSE 2016) ‍[<a href="#ErnstLMST2016">ELM+16</a>]
</li><li class="li-itemize">Semantics for locking specifications (NFM 2016) ‍[<a href="#ErnstMMS2016">EMMS16</a>]
</li><li class="li-itemize">JCrypt: Towards computation over encrypted data (PPPJ 2016) ‍[<a href="#DongMD2016%3AJCrypt">DMD16a</a>]
</li><li class="li-itemize">Preventing signedness errors in numerical computations in Java (FSE
2016) ‍[<a href="#Mackie2016">Mac16</a>]
</li><li class="li-itemize">Enforcing correct array indexes with a type system (FSE 2016) ‍[<a href="#Santino2016">San16</a>]
</li><li class="li-itemize">Gradual Pluggable Typing in Java (Master’s Thesis, 2016) ‍[<a href="#Brotherston2016">Bro16</a>]
</li><li class="li-itemize">Security analysis of the IRMA app using SPARTA and fuzzing (Bachelor
Thesis, 2016) ‍[<a href="#Brinker2016">Bri16</a>]
</li><li class="li-itemize">Static Analysis and Program Transformation for Secure Computation on the
Cloud (ISSTA 2016 Doctoral Symposium) ‍[<a href="#DongMD2016%3Asecure-cloud">DMD16b</a>]
</li><li class="li-itemize">Towards using concurrent Java API correctly (ICECCS 2016) ‍[<a href="#LiuBSD2016">LBSD16</a>]
</li><li class="li-itemize">Reflection-aware static analysis of Android apps (ASE 2016) ‍[<a href="#LiBOK2016">LBOK16</a>]
</li><li class="li-itemize">A crowdsourcing game for formal software verification (Bachelor’s thesis) ‍[<a href="#Irini2016">Iri16</a>]
</li><li class="li-itemize">Exploring Language Support for Immutability (ICSE 2016) ‍[<a href="#CoblenzSAMWS2016">CSA+16</a>]</li><li class="li-itemize">Granullar: Gradual nullable types for Java (CC 2017) ‍[<a href="#BrotherstonDL2017">BDL17</a>]
</li><li class="li-itemize">Type checking for reliable APIs (WAPI 2017) ‍[<a href="#KechagiaS2017">KS17</a>]
</li><li class="li-itemize">Glacier: transitive class immutability for Java (ICSE 2017) ‍[<a href="#CoblenzNAMS2017">CNA+17</a>]
</li><li class="li-itemize">A General Pluggable Type Inference Framework and its use for Data-flow
Analysis (Master’s Thesis, 2017) ‍[<a href="#Li2017">Li17</a>]
</li><li class="li-itemize">Null safety benchmarks for object initialization (ISP RAS, 2017) ‍[<a href="#Kogtenkov2017">Kog17</a>]
</li><li class="li-itemize">Static analysis and program transformation for secure computation on the
cloud (PhD Thesis, 2017) ‍[<a href="#Dong2017">Don17</a>]
</li><li class="li-itemize">Spartan Jester: end-to-end information flow control for hybrid Android
applications (SPW 2017) ‍[<a href="#SextonCN2017">SCN17</a>]</li><li class="li-itemize">Lightweight verification of array indexing (ISSTA 2018) ‍[<a href="#KelloggDME2018">KDME18</a>]
</li><li class="li-itemize">Safe Stream-based Programming with Refinement Types (ASE 2018) ‍[<a href="#SteinCSC2018">SCSC18</a>]
</li><li class="li-itemize">Don’t miss the end: Preventing unsafe end-of-file comparisons (NFM 2018) ‍[<a href="#ChenD2018">CD18</a>]
</li><li class="li-itemize">Context sensitive typechecking and inference: ownership and immutability
(Master’s Thesis, 2018) ‍[<a href="#Ta2018">Ta18</a>]
</li><li class="li-itemize">Usable and Sound Static Analysis through its Integration into Automated
and Interactive Workflows (Master’s Thesis, 2018) ‍[<a href="#Valgma2018">Val18</a>]
</li><li class="li-itemize">Pluggable properties for program understanding: Ontic type checking and
inference (Master’s Thesis, 2018) ‍[<a href="#Chen2018">Che18</a>]
</li><li class="li-itemize">Definite reference mutability (ECOOP 2018) ‍[<a href="#Milanova2018">Mil18</a>]
</li><li class="li-itemize">Googletest to CUTE converter (Technical report, 2018) ‍[<a href="#GschwindV2018">GV18</a>]</li><li class="li-itemize">NullAway: Practical type-based null safety for Java (ESEC/FSE 2019) ‍[<a href="#BanerjeeCS2019">BCS19</a>]
</li><li class="li-itemize">Compile-time detection of machine image sniping (ASE 2019) ‍[<a href="#Kellogg2019">Kel19</a>]
</li><li class="li-itemize">Type-Directed Bounding of Collections in Reactive Programs (VMCAI 2019) ‍[<a href="#LuCCT2019">LČCT19</a>]
</li><li class="li-itemize">Scala with Explicit Nulls (Master’s Thesis, 2019) ‍[<a href="#NietoRodriguez2019">NR19</a>]
</li><li class="li-itemize">A machine-checked proof of security for AWS Key Management Service (CCS, 2019) ‍[<a href="#AlmeidaBBCCGPPST2019">ABB+19</a>]</li><li class="li-itemize">Synthesis of assurance cases for software certification (ICSE NIER 2020) ‍[<a href="#BagheriKM2020">BKM20</a>]
</li><li class="li-itemize">Verifying object construction (ICSE 2020) ‍[<a href="#KelloggRSSE2020">KRS+20</a>]
</li><li class="li-itemize">Precise inference of expressive units of measurement types (OOPSLA 2020) ‍[<a href="#XiangLD2020">XLD20</a>]
</li><li class="li-itemize">Rethinking safe consistency in distributed object-oriented programming
(OOPSLA 2020) ‍[<a href="#KohlerEWMS2020">KEW+20</a>]
</li><li class="li-itemize">Continuous compliance (ASE 2020) ‍[<a href="#KelloggSTE2020">KSTE20</a>]
</li><li class="li-itemize">Light-weight verification of cryptographic API usage (Master’s Thesis, 2020) ‍[<a href="#Xing2020">Xin20</a>]
</li><li class="li-itemize">Type checking and whole-program inference for value range analysis (Master’s Thesis, 2020) ‍[<a href="#Xiang2020">Xia20</a>]
</li><li class="li-itemize">User-Centered Design of Principled Programming Languages (PhD thesis, 2020) ‍[<a href="#Coblenz2020">Cob20</a>]
</li><li class="li-itemize">Behavioural types for memory and method safety in a core object-oriented
language (APLAS 2020) ‍[<a href="#BravettiFGHJKR2020">BFG+20</a>]
</li><li class="li-itemize">Scala with Explicit Nulls (ECOOP 2020) ‍[<a href="#NietoZLCP2020">NZL+20</a>]</li><li class="li-itemize">Property Types in Java: Combining Type Systems and Deductive Verification
(Master’s Thesis, 2021) ‍[<a href="#Lanzinger2021">Lan21</a>]
</li><li class="li-itemize">Interval Type Inference: Improvements and Evaluations
(Master’s Thesis, 2021) ‍[<a href="#Wang2021">Wan21</a>]
</li><li class="li-itemize">Coping with the reality: adding crucial features to a
typestate-oriented language (Master’s Thesis, 2021) ‍[<a href="#daLuzMotaM2021">dLM21</a>]
</li><li class="li-itemize">Java Typestate Checker (Coordination 2021) ‍[<a href="#MotaGR2021">MGR21</a>]
</li><li class="li-itemize">Ensuring correct cryptographic algorithm and provider usage at compile time
(FTFjP 2021) ‍[<a href="#XingCD2021">XCD21</a>]
</li><li class="li-itemize">Scalability and Precision by Combining Expressive Type Systems and
Deductive Verification (OOPSLA 2021) ‍[<a href="#LanzingerWUD2021">LWUD21</a>]
</li><li class="li-itemize">Automatic Annotation of Confidential Data in Java Code (FPS 2021) ‍[<a href="#BastysBRS2021">BBRS21</a>]</li><li class="li-itemize">Accumulation Analysis (ECOOP 2022) ‍[<a href="#KelloggSSE2022">KSSE22</a>]
</li><li class="li-itemize">Lightweight Verification via Specialized Typecheckers (PhD thesis, 2022) ‍[<a href="#Kellogg2022">Kel22</a>]</li></ul><hr><!--TOC chapter id="sec637" References-->
<h1 id="sec637" class="chapter">References</h1><!--SEC END --><dl class="thebibliography"><dt class="dt-thebibliography">
<a id="AlmeidaBBCCGPPST2019">[ABB<sup>+</sup>19]</a></dt><dd class="dd-thebibliography">
José ‍Bacelar Almeida, Manuel Barbosa, Gilles Barthe, Matthew Campagna,
Ernie Cohen, Benjamin Gregoire, Vitor Pereira, Bernardo Portela, Pierre-Yves
Strub, and Serdar Tasiran.
A machine-checked proof of security for AWS Key Management
Service.
In <em>CCS 2019: Proceedings of the 21st ACM Conference on Computer
and Communications Security</em>, page 63–78, London, UK, November 2019.</dd><dt class="dt-thebibliography"><a id="ArtziQKE2009">[AQKE09]</a></dt><dd class="dd-thebibliography">
Shay Artzi, Jaime Quinonez, Adam Kieżun, and Michael ‍D. Ernst.
Parameter reference immutability: Formal definition, inference tool,
and comparison.
<em>Automated Software Engineering</em>, 16(1):145–192, March 2009.</dd><dt class="dt-thebibliography"><a id="Artho2001">[Art01]</a></dt><dd class="dd-thebibliography">
Cyrille Artho.
Finding faults in multi-threaded programs.
Master’s thesis, Swiss Federal Institute of Technology, March ‍15,
2001.</dd><dt class="dt-thebibliography"><a id="BastysBRS2021">[BBRS21]</a></dt><dd class="dd-thebibliography">
Iulia Bastys, Pauline Bolignano, Franco Raimondi, and Daniel Schoepe.
Automatic annotation of confidential data in Java code.
In <em>FPS 2021: 14th International Symposium on Foundations &amp;
Practice of Security</em>, Paris, France, December 2021.</dd><dt class="dt-thebibliography"><a id="BanerjeeCS2019">[BCS19]</a></dt><dd class="dd-thebibliography">
Subarno Banerjee, Lazaro Clapp, and Manu Sridharan.
NullAway: Practical type-based null safety for Java.
In <em>ESEC/FSE 2019: The ACM 27th joint European Software
Engineering Conference and Symposium on the Foundations of Software
Engineering (ESEC/FSE)</em>, pages 740–750, Tallinn, Estonia, August 2019.</dd><dt class="dt-thebibliography"><a id="BrotherstonDL2017">[BDL17]</a></dt><dd class="dd-thebibliography">
Dan Brotherston, Werner Dietl, and Ondřej Lhoták.
Granullar: Gradual nullable types for Java.
In <em>CC 2017: 26th International Conference on Compiler
Construction</em>, pages 87–97, Austin, TX, USA, February 2017.</dd><dt class="dt-thebibliography"><a id="Bergstein2012">[Ber12]</a></dt><dd class="dd-thebibliography">
Paul ‍L. Bergstein.
Documenting Java database access with type annotations.
In <em>WorldComp 2012: Proceedings of The 2012 World Congress in
Computer Science, Computer Engineering, and Applied Computing</em>, 2012.</dd><dt class="dt-thebibliography"><a id="BravettiFGHJKR2020">[BFG<sup>+</sup>20]</a></dt><dd class="dd-thebibliography">
Mario Bravetti, Adrian Francalanza, Iaroslav Golovanov, Hans Hüttel,
Mathias ‍S. Jakobsen, Mikkel ‍K. Kettunen, and António Ravara.
Behavioural types for memory and method safety in a core
object-oriented language.
In <em>APLAS 2020: 18th Asian Symposium on Programming Languages and
Systems</em>, page 105–124, Fukuoka, Japan, November 2020.</dd><dt class="dt-thebibliography"><a id="BarrosJMVDdAE2015">[BJM<sup>+</sup>15]</a></dt><dd class="dd-thebibliography">
Paulo Barros, René Just, Suzanne Millstein, Paul Vines, Werner Dietl, Marcelo
d’Amorim, and Michael ‍D. Ernst.
Static analysis of implicit control flow: Resolving Java reflection
and Android intents.
In <em>ASE 2015: Proceedings of the 30th Annual International
Conference on Automated Software Engineering</em>, pages 669–679, Lincoln, NE,
USA, November 2015.</dd><dt class="dt-thebibliography"><a id="BagheriKM2020">[BKM20]</a></dt><dd class="dd-thebibliography">
Hamid Bagheri, Eunsuk Kang, and Niloofar Mansoor.
Synthesis of assurance cases for software certification.
In <em>ICSE NIER, Proceedings of the 42nd International Conference
on Software Engineering, New Ideas and Emerging Results Track</em>, pages 61–64,
Seoul, Korea, May 2020.</dd><dt class="dt-thebibliography"><a id="Brinker2016">[Bri16]</a></dt><dd class="dd-thebibliography">
Laurens Brinker.
Security analysis of the IRMA app using SPARTA and fuzzing.
Bachelor thesis, Radboud University, Nijmegen, Netherlands, 2016.</dd><dt class="dt-thebibliography"><a id="Brotherston2016">[Bro16]</a></dt><dd class="dd-thebibliography">
Daniel Brotherston.
Gradual pluggable typing in Java.
Master’s thesis, U. of Waterloo, Waterloo, Ontario, Canada, 2016.</dd><dt class="dt-thebibliography"><a id="ChenD2018">[CD18]</a></dt><dd class="dd-thebibliography">
Charles ‍Zhuo Chen and Werner Dietl.
Don’t miss the end: Preventing unsafe end-of-file comparisons.
In <em>NFM 2018: 10th NASA Formal Methods Symposium</em>, pages 87–94,
Newport News, VA, USA, April 2018.</dd><dt class="dt-thebibliography"><a id="Chen2018">[Che18]</a></dt><dd class="dd-thebibliography">
Zhuo Chen.
Pluggable properties for program understanding: Ontic type checking
and inference.
Master’s thesis, U. of Waterloo, Waterloo, Ontario, Canada, 2018.</dd><dt class="dt-thebibliography"><a id="CoblenzNAMS2017">[CNA<sup>+</sup>17]</a></dt><dd class="dd-thebibliography">
Michael Coblenz, Whitney Nelson, Jonathan Aldrich, Brad Myers, and Joshua
Sunshine.
Glacier: Transitive class immutability for Java.
In <em>ICSE 2017, Proceedings of the 39th International Conference
on Software Engineering</em>, pages 496–506, Buenos Aires, Argentina, May 2017.</dd><dt class="dt-thebibliography"><a id="Coblenz2020">[Cob20]</a></dt><dd class="dd-thebibliography">
Michael Coblenz.
<em>User-Centered Design of Principled Programming Languages</em>.
PhD thesis, Carnegie Mellon University, aug 2020.
TR CMU-CS-20-127.</dd><dt class="dt-thebibliography"><a id="Copeland2005">[Cop05]</a></dt><dd class="dd-thebibliography">
Tom Copeland.
<em>PMD Applied</em>.
Centennial Books, November 2005.</dd><dt class="dt-thebibliography"><a id="JSR198">[Cro06]</a></dt><dd class="dd-thebibliography">
Jose Cronembold.
JSR 198: A standard extension API for Integrated Development
Environments.
<a href="https://jcp.org/en/jsr/detail?id=198"><span style="font-family:monospace">https://jcp.org/en/jsr/detail?id=198</span></a>, May ‍8, 2006.</dd><dt class="dt-thebibliography"><a id="CoblenzSAMWS2016">[CSA<sup>+</sup>16]</a></dt><dd class="dd-thebibliography">
Michael Coblenz, Joshua Sunshine, Jonathan Aldrich, Brad Myers, Sam Weber, and
Forrest Shull.
Exploring language support for immutability.
In <em>ICSE 2016, Proceedings of the 38th International Conference
on Software Engineering</em>, pages 736–747, Austin, TX, USA, May 2016.</dd><dt class="dt-thebibliography"><a id="JSR269">[Dar06]</a></dt><dd class="dd-thebibliography">
Joe Darcy.
JSR 269: Pluggable annotation processing API.
<a href="https://jcp.org/en/jsr/detail?id=269"><span style="font-family:monospace">https://jcp.org/en/jsr/detail?id=269</span></a>, May ‍17, 2006.
Public review version.</dd><dt class="dt-thebibliography"><a id="DietlDEMS2011">[DDE<sup>+</sup>11]</a></dt><dd class="dd-thebibliography">
Werner Dietl, Stephanie Dietzel, Michael ‍D. Ernst, Kıvanç Muşlu,
and Todd Schiller.
Building and using pluggable type-checkers.
In <em>ICSE 2011, Proceedings of the 33rd International Conference
on Software Engineering</em>, pages 681–690, Waikiki, Hawaii, USA, May 2011.</dd><dt class="dt-thebibliography"><a id="DietlDEMWCPP2012">[DDE<sup>+</sup>12]</a></dt><dd class="dd-thebibliography">
Werner Dietl, Stephanie Dietzel, Michael ‍D. Ernst, Nathaniel Mote, Brian
Walker, Seth Cooper, Timothy Pavlik, and Zoran Popović.
Verification games: Making verification fun.
In <em>FTfJP: 14th Workshop on Formal Techniques for Java-like
Programs</em>, pages 42–49, Beijing, China, June 2012.</dd><dt class="dt-thebibliography"><a id="DietlDM2011">[DDM11]</a></dt><dd class="dd-thebibliography">
Werner Dietl, Sophia Drossopoulou, and Peter Müller.
Separating ownership topology and encapsulation with Generic
Universe Types.
<em>ACM Transactions on Pro&#173;gramming Languages and Systems</em>,
33(6):20:1–62, December 2011.</dd><dt class="dt-thebibliography"><a id="DietlEM2011">[DEM11]</a></dt><dd class="dd-thebibliography">
Werner Dietl, Michael ‍D. Ernst, and Peter Müller.
Tunable static inference for Generic Universe Types.
In <em>ECOOP 2011 — Object-Oriented Programming, 25th European
Conference</em>, pages 333–357, Lancaster, UK, July 2011.</dd><dt class="dt-thebibliography"><a id="daLuzMotaM2021">[dLM21]</a></dt><dd class="dd-thebibliography">
João ‍Daniel da ‍Luz ‍Mota.
Coping with the reality: adding crucial features to a
typestate-oriented language.
Master’s thesis, Universidade Nova de Lisboa, Faculdade de
Ciências e Tocnologia, February 2021.</dd><dt class="dt-thebibliography"><a id="DongMD2016:JCrypt">[DMD16a]</a></dt><dd class="dd-thebibliography">
Yao Dong, Ana Milanova, and Julian Dolby.
JCrypt: Towards computation over encrypted data.
In <em>PPPJ 2016: Proceedings of the 13th International Conference
on Principles and Practice of Programming in Java: Virtual Machines,
Languages, and Tools</em>, Lugano, Switzerland, July 2016.</dd><dt class="dt-thebibliography"><a id="DongMD2016:secure-cloud">[DMD16b]</a></dt><dd class="dd-thebibliography">
Yao Dong, Ana Milanova, and Julian Dolby.
Static analysis and program transformation for secure computation on
the cloud.
In <em>ISSTA 2016 Doctoral Symposium</em>, Saarbrücken, Genmany,
July 2016.</dd><dt class="dt-thebibliography"><a id="Dong2017">[Don17]</a></dt><dd class="dd-thebibliography">
Yao Dong.
<em>Static analysis and program transformation for secure
computation on the cloud</em>.
PhD thesis, Rensselaer Polytechnic Institute, December 2017.</dd><dt class="dt-thebibliography"><a id="ErnstJMDPRKBBHVW2014">[EJM<sup>+</sup>14]</a></dt><dd class="dd-thebibliography">
Michael ‍D. Ernst, René Just, Suzanne Millstein, Werner Dietl, Stuart
Pernsteiner, Franziska Roesner, Karl Koscher, Paulo Barros, Ravi Bhoraskar,
Seungyeop Han, Paul Vines, and Edward ‍X. Wu.
Collaborative verification of information flow for a high-assurance
app store.
In <em>CCS 2014: Proceedings of the 21st ACM Conference on Computer
and Communications Security</em>, pages 1092–1104, Scottsdale, AZ, USA, November
2014.</dd><dt class="dt-thebibliography"><a id="ErnstLMST2016">[ELM<sup>+</sup>16]</a></dt><dd class="dd-thebibliography">
Michael ‍D. Ernst, Alberto Lovato, Damiano Macedonio, Fausto Spoto, and Javier
Thaine.
Locking discipline inference and checking.
In <em>ICSE 2016, Proceedings of the 38th International Conference
on Software Engineering</em>, pages 1133–1144, Austin, TX, USA, May 2016.</dd><dt class="dt-thebibliography"><a id="ErnstMMS2016">[EMMS16]</a></dt><dd class="dd-thebibliography">
Michael ‍D. Ernst, Damiano Macedonio, Massimo Merro, and Fausto Spoto.
Semantics for locking specifications.
In <em>NFM 2016: 8th NASA Formal Methods Symposium</em>, pages 355–372,
Minneapolis, MN, USA, June 2016.</dd><dt class="dt-thebibliography"><a id="Ernst2008">[Ern08a]</a></dt><dd class="dd-thebibliography">
Michael ‍D. Ernst.
Building and using pluggable type systems with the Checker
Framework.
In <em>ECOOP 2008 — Object-Oriented Programming, 22nd European
Conference</em>, Paphos, Cyprus, July 2008.
Tool demo.</dd><dt class="dt-thebibliography"><a id="JSR308-2008-09-12">[Ern08b]</a></dt><dd class="dd-thebibliography">
Michael ‍D. Ernst.
Type Annotations specification (JSR 308).
<a href="https://checkerframework.org/jsr308/"><span style="font-family:monospace">https://checkerframework.org/jsr308/</span></a>, September ‍12, 2008.</dd><dt class="dt-thebibliography"><a id="GerakiosBS2013">[GBS13]</a></dt><dd class="dd-thebibliography">
Prodromos Gerakios, Aggelos Biboudis, and Yannis Smaragdakis.
Reified type parameters using java annotations.
In <em>GPCE 2013: Proceedings of the 12th International Conference
on Generative Programming and Component Engineering</em>, pages 61–64,
Indianapolis, IN, USA, October 2013.</dd><dt class="dt-thebibliography"><a id="GordonDEG2013">[GDEG13]</a></dt><dd class="dd-thebibliography">
Colin ‍S. Gordon, Werner Dietl, Michael ‍D. Ernst, and Dan Grossman.
JavaUI: Effects for controlling UI object access.
In <em>ECOOP 2013 — Object-Oriented Programming, 27th European
Conference</em>, pages 179–204, Montpellier, France, July 2013.</dd><dt class="dt-thebibliography"><a id="Goetz2006:typedef">[Goe06]</a></dt><dd class="dd-thebibliography">
Brian Goetz.
The pseudo-typedef antipattern: Extension is not type definition.
<a href="https://web.archive.org/web/20171025205847/https://www.ibm.com/developerworks/java/library/j-jtp02216/"><span style="font-family:monospace">https://web.archive.org/web/20171025205847/https://www.ibm.com/developerworks/java/library/j-jtp02216/</span></a>,
February ‍21, 2006.</dd><dt class="dt-thebibliography"><a id="Goetz2006">[GPB<sup>+</sup>06]</a></dt><dd class="dd-thebibliography">
Brian Goetz, Tim Peierls, Joshua Bloch, Joseph Bowbeer, David Holmes, and Doug
Lea.
<em>Java Concurrency in Practice</em>.
Addison-Wesley, 2006.</dd><dt class="dt-thebibliography"><a id="GschwindV2018">[GV18]</a></dt><dd class="dd-thebibliography">
Sascha Gschwind and Renato Venzin.
Googletest to CUTE converter.
Technical report, University of Applied Sciences Rapperswil,
Rapperswil, Switzerland, 2018.</dd><dt class="dt-thebibliography"><a id="Harper2010">[Har10]</a></dt><dd class="dd-thebibliography">
Artemus Harper.
Applying uniqueness to the Java language.
Master’s thesis, Washington State University, 2010.</dd><dt class="dt-thebibliography"><a id="HuangDM2014">[HDM14]</a></dt><dd class="dd-thebibliography">
Wei Huang, Yao Dong, and Ana Milanova.
Type-based taint analysis for Java web applications.
In <em>FASE 2014: Fundamental Approaches to Software Engineering</em>,
pages 140–154, Grenoble, France, April 2014.</dd><dt class="dt-thebibliography"><a id="HuangDMD2015">[HDMD15]</a></dt><dd class="dd-thebibliography">
Wei Huang, Yao Dong, Ana Milanova, and Julian Dolby.
Scalable and precise taint analysis for Android.
In <em>ISSTA 2015, Proceedings of the 2015 International Symposium
on Software Testing and Analysis</em>, pages 106–117, Baltimore, MD, USA, July
2015.</dd><dt class="dt-thebibliography"><a id="HuangDME2012">[HDME12]</a></dt><dd class="dd-thebibliography">
Wei Huang, Werner Dietl, Ana Milanova, and Michael ‍D. Ernst.
Inference and checking of object ownership.
In <em>ECOOP 2012 — Object-Oriented Programming, 26th European
Conference</em>, pages 181–206, Beijing, China, June 2012.</dd><dt class="dt-thebibliography"><a id="HuangM2011">[HM11]</a></dt><dd class="dd-thebibliography">
Wei Huang and Ana Milanova.
Towards effective inference and checking of ownership types.
In <em>IWACO 2011: International Workshop on Aliasing, Confinement
and Ownership in object-oriented programming</em>, Lancaster, UK, July 2011.</dd><dt class="dt-thebibliography"><a id="HuangM2012">[HM12]</a></dt><dd class="dd-thebibliography">
Wei Huang and Ana Milanova.
ReImInfer: Method purity inference for Java.
In <em>FSE 2012: Proceedings of the </em><em>ACM</em><em> </em><em>SIGSOFT</em><em> 20th Symposium
on the Foundations of Software Engineering</em>, pages 1–4, Cary, NC, USA,
November 2012.</dd><dt class="dt-thebibliography"><a id="HuangMDE2012">[HMDE12]</a></dt><dd class="dd-thebibliography">
Wei Huang, Ana Milanova, Werner Dietl, and Michael ‍D. Ernst.
ReIm &amp; ReImInfer: Checking and inference of reference
immutability and method purity.
In <em>OOPSLA 2012, Object-Oriented Programming Systems, Languages,
and Applications</em>, pages 879–896, Tucson, AZ, USA, October 2012.</dd><dt class="dt-thebibliography"><a id="HovemeyerP2004">[HP04]</a></dt><dd class="dd-thebibliography">
David Hovemeyer and William Pugh.
Finding bugs is easy.
In <em>OOPSLA Companion: Companion to Object-Oriented Programming
Systems, Languages, and Applications</em>, pages 132–136, Vancouver, BC, Canada,
October 2004.</dd><dt class="dt-thebibliography"><a id="HaackP2009">[HP09]</a></dt><dd class="dd-thebibliography">
Christian Haack and Erik Poll.
Type-based object immutability with flexible initialization.
In <em>ECOOP 2009 — Object-Oriented Programming, 23rd European
Conference</em>, pages 520–545, Genova, Italy, July 2009.</dd><dt class="dt-thebibliography"><a id="HovemeyerSP2005">[HSP05]</a></dt><dd class="dd-thebibliography">
David Hovemeyer, Jaime Spacco, and William Pugh.
Evaluating and tuning a static analysis to find null pointer bugs.
In <em>PASTE 2005: ACM SIGPLAN/SIGSOFT Workshop on Program Analysis
for Software Tools and Engineering (PASTE 2005)</em>, pages 13–19, Lisbon,
Portugal, September 2005.</dd><dt class="dt-thebibliography"><a id="Huang2014">[Hua14]</a></dt><dd class="dd-thebibliography">
Wei Huang.
<em>An inference and checking framework for context-sensitive
pluggable types</em>.
PhD thesis, Rennselaer Polytechnic Institute, 2014.</dd><dt class="dt-thebibliography"><a id="Irini2016">[Iri16]</a></dt><dd class="dd-thebibliography">
Karamitrou Irini.
A crowdsourcing game for formal software verification.
Bachelor’s thesis, University of Thessaly Polytechnic School
Department of Electrical and Computer Engineering, Thessaly, Greece, 2016.</dd><dt class="dt-thebibliography"><a id="Kaiser2015">[Kai15]</a></dt><dd class="dd-thebibliography">
Benjamin Kaiser.
A context-sensitive security type system for Java.
Master’s thesis, Rennselaer Polytechnic Institute, Troy, NY, USA,
April 2015.</dd><dt class="dt-thebibliography"><a id="KelloggDME2018">[KDME18]</a></dt><dd class="dd-thebibliography">
Martin Kellogg, Vlastimil Dort, Suzanne Millstein, and Michael ‍D. Ernst.
Lightweight verification of array indexing.
In <em>ISSTA 2018, Proceedings of the 2018 International Symposium
on Software Testing and Analysis</em>, pages 3–14, Amsterdam, Netherlands, July
2018.</dd><dt class="dt-thebibliography"><a id="Kellogg2019">[Kel19]</a></dt><dd class="dd-thebibliography">
Martin Kellogg.
Compile-time detection of machine image sniping.
In <em>ASE 2019: Proceedings of the 34th Annual International
Conference on Automated Software Engineering</em>, pages 1256–1258, San Diego,
CA, USA, September 2019.</dd><dt class="dt-thebibliography"><a id="Kellogg2022">[Kel22]</a></dt><dd class="dd-thebibliography">
Martin Kellogg.
<em>Lightweight Verification via Specialized Typecheckers</em>.
PhD thesis, University of Washington Paul G. Allen School of Computer
Science and Engineering, Seattle, WA, USA, June 2022.</dd><dt class="dt-thebibliography"><a id="KohlerEWMS2020">[KEW<sup>+</sup>20]</a></dt><dd class="dd-thebibliography">
Mirko Köhler, Nafise Eskandani, Pascal Weisenburger, Alessandro Margara,
and Guido Salvaneschi.
Rethinking safe consistency in distributed object-oriented
programming.
In <em>OOPSLA 2020, Object-Oriented Programming Systems, Languages,
and Applications</em>, Chicago, IL, USA, November 2020.</dd><dt class="dt-thebibliography"><a id="Kogtenkov2017">[Kog17]</a></dt><dd class="dd-thebibliography">
Alexander ‍V. Kogtenkov.
Null safety benchmarks for object initialization.
<em>Proceedings of the Institute for System Programming of RAS</em>,
29(6):135–150, 2017.</dd><dt class="dt-thebibliography"><a id="KelloggRSSE2020">[KRS<sup>+</sup>20]</a></dt><dd class="dd-thebibliography">
Martin Kellogg, Manli Ran, Manu Sridharan, Martin Schäf, and Michael ‍D.
Ernst.
Verifying object construction.
In <em>ICSE 2020, Proceedings of the 42nd International Conference
on Software Engineering</em>, pages 1447–1458, Seoul, Korea, May 2020.</dd><dt class="dt-thebibliography"><a id="KechagiaS2017">[KS17]</a></dt><dd class="dd-thebibliography">
Maria Kechagia and Diomidis Spinellis.
Type checking for reliable APIs.
In <em>WAPI ’17: Proceedings of the 1st International Workshop on
API Usage and Evolution</em>, pages 15–18, Buenos Aires, Argentina, May 2017.</dd><dt class="dt-thebibliography"><a id="KelloggSSE2021">[KSSE21]</a></dt><dd class="dd-thebibliography">
Martin Kellogg, Narges Shadab, Manu Sridharan, and Michael ‍D. Ernst.
Lightweight and modular resource leak verification.
In <em>ESEC/FSE 2021: The ACM 29th joint European Software
Engineering Conference and Symposium on the Foundations of Software
Engineering (ESEC/FSE)</em>, pages 181–192, Athens, Greece, August 2021.</dd><dt class="dt-thebibliography"><a id="KelloggSSE2022">[KSSE22]</a></dt><dd class="dd-thebibliography">
Martin Kellogg, Narges Shadab, Manu Sridharan, and Michael ‍D. Ernst.
Accumulation analysis.
In <em>ECOOP 2022 — Object-Oriented Programming, 33rd European
Conference</em>, pages 10:1–10:31, Berlin, Germany, June 2022.</dd><dt class="dt-thebibliography"><a id="KelloggSTE2020">[KSTE20]</a></dt><dd class="dd-thebibliography">
Martin Kellogg, Martin Schäf, Serdar Tasiran, and Michael ‍D. Ernst.
Continuous compliance.
In <em>ASE 2020: Proceedings of the 35th Annual International
Conference on Automated Software Engineering</em>, pages 511–523, Melbourne,
Australia, September 2020.</dd><dt class="dt-thebibliography"><a id="Lanzinger2021">[Lan21]</a></dt><dd class="dd-thebibliography">
Florian Lanzinger.
Property types in Java: Combining type systems and deductive
verification.
Master’s thesis, Karlsruher Institut für Technologie, feb 2021.</dd><dt class="dt-thebibliography"><a id="LiBOK2016">[LBOK16]</a></dt><dd class="dd-thebibliography">
Li ‍Li, Tegawendé ‍F. Bissyandé, Damien Octeau, and Jacques Klein.
Reflection-aware static analysis of Android apps.
In <em>ASE 2016: Proceedings of the 31st Annual International
Conference on Automated Software Engineering</em>, pages 756–761, Singapore,
Singapore, September 2016.</dd><dt class="dt-thebibliography"><a id="LeavensBR2006:JML">[LBR06]</a></dt><dd class="dd-thebibliography">
Gary ‍T. Leavens, Albert ‍L. Baker, and Clyde Ruby.
Preliminary design of JML: A behavioral interface specification
language for Java.
<em>ACM SIGSOFT Software Engineering Notes</em>, 31(3), March 2006.</dd><dt class="dt-thebibliography"><a id="LiuBSD2016">[LBSD16]</a></dt><dd class="dd-thebibliography">
Shuang Liu, Guangdong Bai, Jun Sun, and J. ‍Dong.
Towards using concurrent Java API correctly.
In <em>ICECCS 2016: 21st International Conference on Engineering of
Complex Computer Systems</em>, pages 219–222, Dubai, UAE, June 2016.</dd><dt class="dt-thebibliography"><a id="LuCCT2019">[LČCT19]</a></dt><dd class="dd-thebibliography">
Tianhan Lu, Pavol Černý, Bor-Yuh ‍Evan Chang, and Ashutosh Trivedi.
Type-directed bounding of collections in reactive programs.
In <em>VMCAI 2019: 20th International Conference on Verification,
Model Checking and Abstract Interpretation</em>, pages 275–296, Cascais,
Portugal, January 2019.</dd><dt class="dt-thebibliography"><a id="Li2017">[Li17]</a></dt><dd class="dd-thebibliography">
Jianchu Li.
A general pluggable type inference framework and its use for
data-flow analysis.
Master’s thesis, U. of Waterloo, Waterloo, Ontario, Canada, 2017.</dd><dt class="dt-thebibliography"><a id="LanzingerWUD2021">[LWUD21]</a></dt><dd class="dd-thebibliography">
Florian Lanzinger, Alexander Weigl, Mattias Ulbrich, and Werner Dietl.
Scalability and precision by combining expressive type systems and
deductive verification.
<em>Proceedings of the ACM on Programming Languages</em>, 5(OOPSLA),
October 2021.</dd><dt class="dt-thebibliography"><a id="Mackie2016">[Mac16]</a></dt><dd class="dd-thebibliography">
Christopher ‍A. Mackie.
Preventing signedness errors in numerical computations in java.
In <em>FSE 2016: Proceedings of the </em><em>ACM</em><em> </em><em>SIGSOFT</em><em> 24th Symposium
on the Foundations of Software Engineering</em>, pages 1148–1150, Seattle, WA,
USA, November 2016.</dd><dt class="dt-thebibliography"><a id="MotaGR2021">[MGR21]</a></dt><dd class="dd-thebibliography">
João Mota, Marco Giunti, and António Ravara.
Java typestate checker.
In <em>Coordination 2021: 23rd IFIP WG 6.1 International Conference
on Coordination Models and Languages</em>, page 121–133, Valletta, Malta, June
2021.</dd><dt class="dt-thebibliography"><a id="MilanovaH2012">[MH12]</a></dt><dd class="dd-thebibliography">
Ana Milanova and Wei Huang.
Inference and checking of context-sensitive pluggable types.
In <em>FSE 2012: Proceedings of the </em><em>ACM</em><em> </em><em>SIGSOFT</em><em> 20th Symposium
on the Foundations of Software Engineering</em>, pages 1–4, Cary, NC, USA,
November 2012.</dd><dt class="dt-thebibliography"><a id="MilanovaH2013">[MH13]</a></dt><dd class="dd-thebibliography">
Ana Milanova and Wei Huang.
Composing polymorphic information flow systems with reference
immutability.
In <em>FTfJP: 14th Workshop on Formal Techniques for Java-like
Programs</em>, pages 5:1–5:7, Montpellier, France, July 2013.</dd><dt class="dt-thebibliography"><a id="MilanovaHD2014">[MHD14]</a></dt><dd class="dd-thebibliography">
Ana Milanova, Wei Huang, and Yao Dong.
CFL-reachability and context-sensitive integrity types.
In <em>PPPJ 2014: Proceedings of the 2014 International Conference
on Principles and Practice of Programming in Java: Virtual Machines,
Languages, and Tools</em>, page 99–109, Cracow, Poland, September 2014.</dd><dt class="dt-thebibliography"><a id="Milanova2018">[Mil18]</a></dt><dd class="dd-thebibliography">
Ana Milanova.
Definite reference mutability.
In <em>ECOOP 2018 — Object-Oriented Programming, 32nd European
Conference</em>, pages 25:1–25:30, Amsterdam, Netherlands, July 2018.</dd><dt class="dt-thebibliography"><a id="MilanovaV2011">[MV11]</a></dt><dd class="dd-thebibliography">
Ana Milanova and Jan Vitek.
Static dominance inference.
In <em>TOOLS 2011: Objects, Models, Components, Patterns, 49th
International Conference</em>, pages 211–227, Zurich, Switzerland, June 2011.</dd><dt class="dt-thebibliography"><a id="MudduluruWME2021">[MWME21]</a></dt><dd class="dd-thebibliography">
Rashmi Mudduluru, Jason Waataja, Suzanne Millstein, and Michael ‍D. Ernst.
Verifying determinism in sequential programs.
In <em>ICSE 2021, Proceedings of the 43rd International Conference
on Software Engineering</em>, pages 37–49, Madrid, Spain, May 2021.</dd><dt class="dt-thebibliography"><a id="Noack2010">[Noa10]</a></dt><dd class="dd-thebibliography">
Gunther Noack.
TIFI+: A type checker for object immutability with flexible
initialization.
Diploma thesis, University of Kaiserslautern, March 2010.</dd><dt class="dt-thebibliography"><a id="NietoRodriguez2019">[NR19]</a></dt><dd class="dd-thebibliography">
Abel Nieto ‍Rodriguez.
Scala with explicit nulls.
Master’s thesis, University of Waterloo Department of Computer
Science, Waterloo, Ontario, Canada, December 2019.</dd><dt class="dt-thebibliography"><a id="NietoZLCP2020">[NZL<sup>+</sup>20]</a></dt><dd class="dd-thebibliography">
Abel Nieto, Yaoyu Zhao, Ondřej Lhoták, Angela Chang, and Justin Pu.
Scala with explicit nulls.
In <em>ECOOP 2020 — Object-Oriented Programming, 33rd European
Conference</em>, pages 25:1–25:26, online, November 2020.</dd><dt class="dt-thebibliography"><a id="PapiACPE2008">[PAC<sup>+</sup>08]</a></dt><dd class="dd-thebibliography">
Matthew ‍M. Papi, Mahmood Ali, Telmo ‍Luis Correa ‍Jr., Jeff ‍H. Perkins, and
Michael ‍D. Ernst.
Practical pluggable types for Java.
In <em>ISSTA 2008, Proceedings of the 2008 International Symposium
on Software Testing and Analysis</em>, pages 201–212, Seattle, WA, USA, July
2008.</dd><dt class="dt-thebibliography"><a id="PotaninOZE2013">[PÖZE13]</a></dt><dd class="dd-thebibliography">
Alex Potanin, Johan Östlund, Yoav Zibin, and Michael ‍D. Ernst.
Immutability.
In <em>Aliasing in Object-Oriented Programming</em>, volume 7850 of <em>LNCS</em>, pages 233–269. Springer-Verlag, April 2013.</dd><dt class="dt-thebibliography"><a id="QuinonezTE2008">[QTE08]</a></dt><dd class="dd-thebibliography">
Jaime Quinonez, Matthew ‍S. Tschantz, and Michael ‍D. Ernst.
Inference of reference immutability.
In <em>ECOOP 2008 — Object-Oriented Programming, 22nd European
Conference</em>, pages 616–641, Paphos, Cyprus, July 2008.</dd><dt class="dt-thebibliography"><a id="Santino2016">[San16]</a></dt><dd class="dd-thebibliography">
Joseph Santino.
Enforcing correct array indexes with a type system.
In <em>FSE 2016: Proceedings of the </em><em>ACM</em><em> </em><em>SIGSOFT</em><em> 24th Symposium
on the Foundations of Software Engineering</em>, pages 1142–1144, Seattle, WA,
USA, November 2016.</dd><dt class="dt-thebibliography"><a id="SextonCN2017">[SCN17]</a></dt><dd class="dd-thebibliography">
Julian Sexton, Andrey Chudnov, and David ‍A. Naumann.
Spartan Jester: end-to-end information flow control for hybrid
Android applications.
In <em>SPW 2017: Symposium Security and Privacy Workshops</em>, pages
157–162, San Jose, CA, USA, May 2017.</dd><dt class="dt-thebibliography"><a id="SteinCSC2018">[SCSC18]</a></dt><dd class="dd-thebibliography">
Benno Stein, Lazaro Clapp, Manu Sridharan, and Bor-Yuh ‍Evan Chang.
Safe stream-based programming with refinement types.
In <em>ASE 2018: Proceedings of the 33rd Annual International
Conference on Automated Software Engineering</em>, pages 565–576, Montpellier,
France, September 2018.</dd><dt class="dt-thebibliography"><a id="SpishakDE2012">[SDE12]</a></dt><dd class="dd-thebibliography">
Eric Spishak, Werner Dietl, and Michael ‍D. Ernst.
A type system for regular expressions.
In <em>FTfJP: 14th Workshop on Formal Techniques for Java-like
Programs</em>, pages 20–26, Beijing, China, June 2012.</dd><dt class="dt-thebibliography"><a id="SampsonDFGCG2011">[SDF<sup>+</sup>11]</a></dt><dd class="dd-thebibliography">
Adrian Sampson, Werner Dietl, Emily Fortuna, Danushen Gnanapragasam, Luis Ceze,
and Dan Grossman.
EnerJ: Approximate data types for safe and general low-power
computation.
In <em>PLDI 2011: Proceedings of the </em><em>ACM</em><em> </em><em>SIGPLAN</em><em> 2011 Conference
on Programming Language Design and Implementation</em>, pages 164–174, San Jose,
CA, USA, June 2011.</dd><dt class="dt-thebibliography"><a id="SchillerE2010">[SE10]</a></dt><dd class="dd-thebibliography">
Todd ‍W. Schiller and Michael ‍D. Ernst.
Rethinking the economics of software engineering.
In <em>FoSER: Workshop on the Future of Software Engineering
Research</em>, pages 325–330, Santa Fe, NM, USA, November 2010.</dd><dt class="dt-thebibliography"><a id="SpotoE2011">[SE11]</a></dt><dd class="dd-thebibliography">
Fausto Spoto and Michael ‍D. Ernst.
Inference of field initialization.
In <em>ICSE 2011, Proceedings of the 33rd International Conference
on Software Engineering</em>, pages 231–240, Waikiki, Hawaii, USA, May 2011.</dd><dt class="dt-thebibliography"><a id="Sherwany2011">[She11]</a></dt><dd class="dd-thebibliography">
Amanj Sherwany.
The design, implementation and evaluation of a pluggable type checker
for thread-locality in Java.
Master’s thesis, Uppsala University, Department of Information
Technology, Uppsala, Sweden, 2011.</dd><dt class="dt-thebibliography"><a id="SummersM2011">[SM11]</a></dt><dd class="dd-thebibliography">
Alexander ‍J. Summers and Peter Müller.
Freedom before commitment: A lightweight type system for object
initialisation.
In <em>OOPSLA 2011, Object-Oriented Programming Systems, Languages,
and Applications</em>, pages 1013–1032, Portland, OR, USA, October 2011.</dd><dt class="dt-thebibliography"><a id="Spoto10:LPAR">[Spo10]</a></dt><dd class="dd-thebibliography">
F. ‍Spoto.
The nullness analyser of Julia.
In <em>LPAR 2010: Proceedings of the 16th International Conference
on Logic for Programming, Artificial Intelligence, and Reasoning</em>, pages
405–424, Dakar, Senegal, April 2010.</dd><dt class="dt-thebibliography"><a id="Sun2021">[Sun21]</a></dt><dd class="dd-thebibliography">
Lian Sun.
An immutability type system for classes and objects: Improvements,
experiments, and comparisons.
Master’s thesis, University of Waterloo Department of Electrical and
Computer Engineering, Waterloo, Ontario, Canada, April 2021.</dd><dt class="dt-thebibliography"><a id="Ta2018">[Ta18]</a></dt><dd class="dd-thebibliography">
Mier Ta.
Context sensitive typechecking and inference: Ownership and
immutability.
Master’s thesis, University of Waterloo Department of Electrical and
Computer Engineering, Waterloo, Ontario, Canada, 2018.</dd><dt class="dt-thebibliography"><a id="TschantzE2005">[TE05]</a></dt><dd class="dd-thebibliography">
Matthew ‍S. Tschantz and Michael ‍D. Ernst.
Javari: Adding reference immutability to Java.
In <em>OOPSLA 2005, Object-Oriented Programming Systems, Languages,
and Applications</em>, pages 211–230, San Diego, CA, USA, October 2005.</dd><dt class="dt-thebibliography"><a id="TangPNV2011">[TPNV11]</a></dt><dd class="dd-thebibliography">
Daniel Tang, Ales Plsek, Kelvin Nilsen, and Jan Vitek.
A static memory safety annotation system for Safety Critical
Java.
In <em>RTSS 2011: The 32nd IEEE Real-Time Systems Symposium</em>,
Vienna, Austria, November 2011.</dd><dt class="dt-thebibliography"><a id="TangPJ2010">[TPV10]</a></dt><dd class="dd-thebibliography">
Daniel Tang, Ales Plsek, and Jan Vitek.
Static checking of safety critical Java annotations.
In <em>JTRES 2010: 8th International Workshop on Java Technologies
for Real-time and Embedded Systems</em>, pages 148–154, Prague, Czech Republic,
August 2010.</dd><dt class="dt-thebibliography"><a id="Valgma2018">[Val18]</a></dt><dd class="dd-thebibliography">
Lembit Valgma.
Usable and sound static analysis through its integration into
automated and interactive workflows.
Master’s thesis, U. of Tartu, Tartu, Estonia, 2018.</dd><dt class="dt-thebibliography"><a id="VakilianPEJ2015">[VPEJ15]</a></dt><dd class="dd-thebibliography">
Mohsen Vakilian, Amarin Phaosawasdi, Michael ‍D. Ernst, and Ralph ‍E. Johnson.
Cascade: A universal programmer-assisted type qualifier inference
tool.
In <em>ICSE 2015, Proceedings of the 37th International Conference
on Software Engineering</em>, pages 234–245, Florence, Italy, May 2015.</dd><dt class="dt-thebibliography"><a id="Wang2021">[Wan21]</a></dt><dd class="dd-thebibliography">
Di ‍Wang.
Interval type inference: Improvements and evaluations.
Master’s thesis, University of Waterloo Department of Electrical and
Computer Engineering, Waterloo, Ontario, Canada, December 2021.</dd><dt class="dt-thebibliography"><a id="WeitzKSE2014">[WKSE14]</a></dt><dd class="dd-thebibliography">
Konstantin Weitz, Gene Kim, Siwakorn Srisakaokul, and Michael ‍D. Ernst.
A type system for format strings.
In <em>ISSTA 2014, Proceedings of the 2014 International Symposium
on Software Testing and Analysis</em>, pages 127–137, San Jose, CA, USA, July
2014.</dd><dt class="dt-thebibliography"><a id="WrigstadPMZV2009">[WPM<sup>+</sup>09]</a></dt><dd class="dd-thebibliography">
Tobias Wrigstad, Filip Pizlo, Fadi Meawad, Lei Zhao, and Jan Vitek.
Loci: Simple thread-locality for Java.
In <em>ECOOP 2009 — Object-Oriented Programming, 23rd European
Conference</em>, pages 445–469, Genova, Italy, July 2009.</dd><dt class="dt-thebibliography"><a id="XingCD2021">[XCD21]</a></dt><dd class="dd-thebibliography">
Weitian Xing, Yuanhui Cheng, and Werner Dietl.
Ensuring correct cryptographic algorithm and provider usage at
compile time.
In <em>FTfJP: 239d Workshop on Formal Techniques for Java-like
Programs</em>, page 43–50, Online, July 2021.</dd><dt class="dt-thebibliography"><a id="Xiang2020">[Xia20]</a></dt><dd class="dd-thebibliography">
Tongtong Xiang.
Type checking and whole-program inference for value range analysis.
Master’s thesis, University of Waterloo Department of Electrical and
Computer Engineering, Waterloo, Ontario, Canada, October 2020.</dd><dt class="dt-thebibliography"><a id="Xing2020">[Xin20]</a></dt><dd class="dd-thebibliography">
Weitian Xing.
Light-weight verification of cryptographic API usage.
Master’s thesis, U. of Waterloo, Waterloo, Ontario, Canada, 2020.</dd><dt class="dt-thebibliography"><a id="XiangLD2020">[XLD20]</a></dt><dd class="dd-thebibliography">
Tongtong Xiang, Jeff ‍Y. Luo, and Werner Dietl.
Precise inference of expressive units of measurement types.
In <em>OOPSLA 2020, Object-Oriented Programming Systems, Languages,
and Applications</em>, Chicago, IL, USA, November 2020.</dd><dt class="dt-thebibliography"><a id="Zaza2013">[Zaz13]</a></dt><dd class="dd-thebibliography">
Nosheen Zaza.
Evaluating the accuracy of annotations in the Loci 3.0 pluggable
type checker.
Master’s thesis, Uppsala University, Uppsala, Sweden, 2013.</dd><dt class="dt-thebibliography"><a id="ZibinPAAKE2007">[ZPA<sup>+</sup>07]</a></dt><dd class="dd-thebibliography">
Yoav Zibin, Alex Potanin, Mahmood Ali, Shay Artzi, Adam Kieżun, and
Michael ‍D. Ernst.
Object and reference immutability using Java generics.
In <em>ESEC/FSE 2007: Proceedings of the 11th European Software
Engineering Conference and the 15th </em><em>ACM</em><em> </em><em>SIGSOFT</em><em> Symposium on the
Foundations of Software Engineering</em>, pages 75–84, Dubrovnik, Croatia,
September 2007.</dd><dt class="dt-thebibliography"><a id="ZibinPLAE2010">[ZPL<sup>+</sup>10]</a></dt><dd class="dd-thebibliography">
Yoav Zibin, Alex Potanin, Paley Li, Mahmood Ali, and Michael ‍D. Ernst.
Ownership and immutability in generic Java.
In <em>OOPSLA 2010, Object-Oriented Programming Systems, Languages,
and Applications</em>, pages 598–617, Revo, NV, USA, October 2010.</dd></dl><!--CUT END -->
<!--HTMLFOOT-->
<!--ENDHTML-->
</body>
</html>
